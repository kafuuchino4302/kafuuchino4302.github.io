<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ftp.lua</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
</head>
<body>
    <h1>ftp.lua</h1>
    <a href="index.html">返回主页</a>
    <pre><code class="language-lua">slot0 = _G
slot1 = require(&quot;table&quot;)
slot2 = require(&quot;string&quot;)
slot3 = require(&quot;math&quot;)
slot4 = require(&quot;socket&quot;)
slot5 = require(&quot;socket.url&quot;)
slot6 = require(&quot;socket.tp&quot;)
slot7 = require(&quot;ltn12&quot;)
slot4.ftp = {}
slot8 = slot4.ftp
slot8.TIMEOUT = 60
slot9 = 21
slot8.USER = &quot;ftp&quot;
slot8.PASSWORD = &quot;anonymous@anonymous.org&quot;
slot10 = {
	__index = {}
}

slot8.open = function(slot0, slot1, slot2)
	slot4 = uv4.setmetatable({
		tp = uv0.try(uv1.connect(slot0, slot1 or uv2, uv3.TIMEOUT, slot2))
	}, uv5)
	slot4.try = uv0.newtry(function ()
		uv0:close()
	end)

	return slot4
end

slot10.__index.portconnect = function(slot0)
	slot0.try(slot0.server:settimeout(uv0.TIMEOUT))

	slot0.data = slot0.try(slot0.server:accept())

	slot0.try(slot0.data:settimeout(uv0.TIMEOUT))
end

slot10.__index.pasvconnect = function(slot0)
	slot0.data = slot0.try(uv0.tcp())

	slot0.try(slot0.data:settimeout(uv1.TIMEOUT))
	slot0.try(slot0.data:connect(slot0.pasvt.address, slot0.pasvt.port))
end

slot10.__index.login = function(slot0, slot1, slot2)
	slot0.try(slot0.tp:command(&quot;user&quot;, slot1 or uv0.USER))

	slot3, slot4 = slot0.try(slot0.tp:check({
		&quot;2..&quot;,
		331
	}))

	if slot3 == 331 then
		slot0.try(slot0.tp:command(&quot;pass&quot;, slot2 or uv0.PASSWORD))
		slot0.try(slot0.tp:check(&quot;2..&quot;))
	end

	return 1
end

slot10.__index.pasv = function(slot0)
	slot0.try(slot0.tp:command(&quot;pasv&quot;))

	slot1, slot2 = slot0.try(slot0.tp:check(&quot;2..&quot;))
	slot4, slot5, slot6, slot7, slot8, slot9 = uv0.skip(2, uv1.find(slot2, &quot;(%d+)%D(%d+)%D(%d+)%D(%d+)%D(%d+)%D(%d+)&quot;))

	slot0.try(slot4 and slot5 and slot6 and slot7 and slot8 and slot9, slot2)

	slot0.pasvt = {
		address = uv1.format(&quot;%d.%d.%d.%d&quot;, slot4, slot5, slot6, slot7),
		port = slot8 * 256 + slot9
	}

	if slot0.server then
		slot0.server:close()

		slot0.server = nil
	end

	return slot0.pasvt.address, slot0.pasvt.port
end

slot10.__index.epsv = function(slot0)
	slot0.try(slot0.tp:command(&quot;epsv&quot;))

	slot1, slot2 = slot0.try(slot0.tp:check(&quot;229&quot;))
	slot4, slot5, slot6, slot7 = uv0.match(slot2, &quot;%((.)(.-)%1(.-)%1(.-)%1%)&quot;)

	slot0.try(slot7, &quot;invalid epsv response&quot;)

	slot0.pasvt = {
		address = slot0.tp:getpeername(),
		port = slot7
	}

	if slot0.server then
		slot0.server:close()

		slot0.server = nil
	end

	return slot0.pasvt.address, slot0.pasvt.port
end

slot10.__index.port = function(slot0, slot1, slot2)
	slot0.pasvt = nil

	if not slot1 then
		slot3, slot2 = slot0.try(slot0.tp:getsockname())
		slot0.server = slot0.try(uv0.bind(slot3, 0))
		slot1, slot2 = slot0.try(slot0.server:getsockname())

		slot0.try(slot0.server:settimeout(uv1.TIMEOUT))
	end

	slot3 = slot2 % 256

	slot0.try(slot0.tp:command(&quot;port&quot;, uv2.gsub(uv2.format(&quot;%s,%d,%d&quot;, slot1, (slot2 - slot3) / 256, slot3), &quot;%.&quot;, &quot;,&quot;)))
	slot0.try(slot0.tp:check(&quot;2..&quot;))

	return 1
end

slot10.__index.eprt = function(slot0, slot1, slot2, slot3)
	slot0.pasvt = nil

	if not slot2 then
		slot4, slot3 = slot0.try(slot0.tp:getsockname())
		slot0.server = slot0.try(uv0.bind(slot4, 0))
		slot2, slot3 = slot0.try(slot0.server:getsockname())

		slot0.try(slot0.server:settimeout(uv1.TIMEOUT))
	end

	slot0.try(slot0.tp:command(&quot;eprt&quot;, uv2.format(&quot;|%s|%s|%d|&quot;, slot1, slot2, slot3)))
	slot0.try(slot0.tp:check(&quot;2..&quot;))

	return 1
end

slot10.__index.send = function(slot0, slot1)
	slot0.try(slot0.pasvt or slot0.server, &quot;need port or pasv first&quot;)

	if slot0.pasvt then
		slot0:pasvconnect()
	end

	if (slot1.argument or uv0.unescape(uv1.gsub(slot1.path or &quot;&quot;, &quot;^[/\\]&quot;, &quot;&quot;))) == &quot;&quot; then
		slot2 = nil
	end

	slot0.try(slot0.tp:command(slot1.command or &quot;stor&quot;, slot2))

	slot4, slot5 = slot0.try(slot0.tp:check({
		&quot;2..&quot;,
		&quot;1..&quot;
	}))

	if not slot0.pasvt then
		slot0:portconnect()
	end

	slot6 = slot1.step or uv2.pump.step
	slot7 = {
		slot0.tp
	}

	slot0.try(uv2.pump.all(slot1.source, uv3.sink(&quot;close-when-done&quot;, slot0.data), function (slot0, slot1)
		if uv0.select(uv1, nil, 0)[uv2] then
			uv3 = uv4.try(uv4.tp:check(&quot;2..&quot;))
		end

		return uv5(slot0, slot1)
	end))

	if uv1.find(slot4, &quot;1..&quot;) then
		slot0.try(slot0.tp:check(&quot;2..&quot;))
	end

	slot0.data:close()

	slot0.data = nil

	return uv3.skip(1, slot0.data:getstats())
end

slot10.__index.receive = function(slot0, slot1)
	slot0.try(slot0.pasvt or slot0.server, &quot;need port or pasv first&quot;)

	if slot0.pasvt then
		slot0:pasvconnect()
	end

	if (slot1.argument or uv0.unescape(uv1.gsub(slot1.path or &quot;&quot;, &quot;^[/\\]&quot;, &quot;&quot;))) == &quot;&quot; then
		slot2 = nil
	end

	slot0.try(slot0.tp:command(slot1.command or &quot;retr&quot;, slot2))

	slot4, slot5 = slot0.try(slot0.tp:check({
		&quot;1..&quot;,
		&quot;2..&quot;
	}))

	if slot4 &gt;= 200 and slot4 &lt;= 299 then
		slot1.sink(slot5)

		return 1
	end

	if not slot0.pasvt then
		slot0:portconnect()
	end

	slot0.try(uv3.pump.all(uv2.source(&quot;until-closed&quot;, slot0.data), slot1.sink, slot1.step or uv3.pump.step))

	if uv1.find(slot4, &quot;1..&quot;) then
		slot0.try(slot0.tp:check(&quot;2..&quot;))
	end

	slot0.data:close()

	slot0.data = nil

	return 1
end

slot10.__index.cwd = function(slot0, slot1)
	slot0.try(slot0.tp:command(&quot;cwd&quot;, slot1))
	slot0.try(slot0.tp:check(250))

	return 1
end

slot10.__index.type = function(slot0, slot1)
	slot0.try(slot0.tp:command(&quot;type&quot;, slot1))
	slot0.try(slot0.tp:check(200))

	return 1
end

slot10.__index.greet = function(slot0)
	if uv0.find(slot0.try(slot0.tp:check({
		&quot;1..&quot;,
		&quot;2..&quot;
	})), &quot;1..&quot;) then
		slot0.try(slot0.tp:check(&quot;2..&quot;))
	end

	return 1
end

slot10.__index.quit = function(slot0)
	slot0.try(slot0.tp:command(&quot;quit&quot;))
	slot0.try(slot0.tp:check(&quot;2..&quot;))

	return 1
end

slot10.__index.close = function(slot0)
	if slot0.data then
		slot0.data:close()
	end

	if slot0.server then
		slot0.server:close()
	end

	return slot0.tp:close()
end

slot11 = function(slot0)
	if slot0.url then
		slot1 = uv0.parse(slot0.url)

		for slot5, slot6 in uv1.pairs(slot0) do
			slot1[slot5] = slot6
		end

		return slot1
	else
		return slot0
	end
end

slot12 = function(slot0)
	slot0 = uv0(slot0)

	uv1.try(slot0.host, &quot;missing hostname&quot;)

	slot1 = uv2.open(slot0.host, slot0.port, slot0.create)

	slot1:greet()
	slot1:login(slot0.user, slot0.password)

	if slot0.type then
		slot1:type(slot0.type)
	end

	slot1:epsv()
	slot1:quit()
	slot1:close()

	return slot1:send(slot0)
end

slot13 = {
	scheme = &quot;ftp&quot;,
	path = &quot;/&quot;
}

slot8.genericform = function(slot0)
	uv0.try(uv0.try(uv1.parse(slot0, uv2)).scheme == &quot;ftp&quot;, &quot;wrong scheme &#x27;&quot; .. slot1.scheme .. &quot;&#x27;&quot;)
	uv0.try(slot1.host, &quot;missing hostname&quot;)

	slot2 = &quot;^type=(.)$&quot;

	if slot1.params then
		slot1.type = uv0.skip(2, uv3.find(slot1.params, slot2))

		uv0.try(slot1.type == &quot;a&quot; or slot1.type == &quot;i&quot;, &quot;invalid type &#x27;&quot; .. slot1.type .. &quot;&#x27;&quot;)
	end

	return slot1
end

slot15 = function(slot0, slot1)
	slot2 = uv0(slot0)
	slot2.source = uv1.source.string(slot1)

	return uv2(slot2)
end

slot8.put = slot4.protect(function (slot0, slot1)
	if uv0.type(slot0) == &quot;string&quot; then
		return uv1(slot0, slot1)
	else
		return uv2(slot0)
	end
end)

slot16 = function(slot0)
	slot0 = uv0(slot0)

	uv1.try(slot0.host, &quot;missing hostname&quot;)

	slot1 = uv2.open(slot0.host, slot0.port, slot0.create)

	slot1:greet()
	slot1:login(slot0.user, slot0.password)

	if slot0.type then
		slot1:type(slot0.type)
	end

	slot1:epsv()
	slot1:receive(slot0)
	slot1:quit()

	return slot1:close()
end

slot17 = function(slot0)
	slot1 = uv0(slot0)
	slot2 = {}
	slot1.sink = uv1.sink.table(slot2)

	uv2(slot1)

	return uv3.concat(slot2)
end

slot8.command = slot4.protect(function (slot0)
	slot0 = uv0(slot0)

	uv1.try(slot0.host, &quot;missing hostname&quot;)
	uv1.try(slot0.command, &quot;missing command&quot;)

	slot1 = uv2.open(slot0.host, slot0.port, slot0.create)

	slot1:greet()
	slot1:login(slot0.user, slot0.password)

	if type(slot0.command) == &quot;table&quot; then
		slot2 = slot0.argument or {}
		slot3 = slot0.check or {}

		for slot7, slot8 in ipairs(slot0.command) do
			slot1.try(slot1.tp:command(slot8, slot2[slot7]))

			if slot3[slot7] then
				slot1.try(slot1.tp:check(slot3[slot7]))
			end
		end
	else
		slot1.try(slot1.tp:command(slot0.command, slot0.argument))

		if slot0.check then
			slot1.try(slot1.tp:check(slot0.check))
		end
	end

	slot1:quit()

	return slot1:close()
end)
slot8.get = slot4.protect(function (slot0)
	if uv0.type(slot0) == &quot;string&quot; then
		return uv1(slot0)
	else
		return uv2(slot0)
	end
end)

return slot8
</code></pre>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-lua.min.js"></script>
</body>
</html>