<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>metacharacterenergylayer.lua</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
</head>
<body>
    <h1>metacharacterenergylayer.lua</h1>
    <a href="index.html">返回主页</a>
    <pre><code class="language-lua">slot0 = class(&quot;MetaCharacterEnergyLayer&quot;, import(&quot;...base.BaseUI&quot;))
slot1 = pg.ship_meta_breakout

slot0.getUIName = function(slot0)
	return &quot;MetaCharacterEnergyUI&quot;
end

slot0.init = function(slot0)
	slot0:initUITipText()
	slot0:initData()
	slot0:initUI()
	slot0:addListener()
end

slot0.didEnter = function(slot0)
	slot0:updateShipImg()
	slot0:updateNamePanel()
	slot0:updateChar()
	slot0:updateAttrPanel()
	slot0:updateMaterialPanel()
	slot0:initPreviewPanel()
	slot0:enablePartialBlur()

	if slot0.contextData.isMainOpen then
		slot0.contextData.isMainOpen = nil

		slot0:moveShipImg(true)
	end

	slot0:moveRightPanel()
	slot0:TryPlayGuide()
end

slot0.willExit = function(slot0)
	slot0:moveShipImg(false)
	slot0:recycleChar()

	if slot0.previewer then
		slot0.previewer:clear()

		slot0.previewer = nil
	end

	slot0:disablePartialBlur()
end

slot0.onBackPressed = function(slot0)
	if isActive(slot0.previewTF) then
		slot0:closePreviewPanel()

		return
	else
		slot0:emit(uv0.ON_BACK_PRESSED)
	end
end

slot0.initUITipText = function(slot0)
	setText(slot0:findTF(&quot;Preview/FinalAttrPanel/TitleText&quot;), i18n(&quot;meta_energy_preview_title&quot;))
	setText(slot0:findTF(&quot;Preview/FinalAttrPanel/TipText&quot;), i18n(&quot;meta_energy_preview_tip&quot;))
	setText(slot0:findTF(&quot;RightPanel/MaterialPanel/StarMax/Text&quot;), i18n(&quot;word_level_upperLimit&quot;))
	setText(slot0:findTF(&quot;RightPanel/MaterialPanel/TipText&quot;), i18n(&quot;meta_break&quot;))
end

slot0.initData = function(slot0)
	slot0.shipPrefab = nil
	slot0.shipModel = nil
	slot0.metaCharacterProxy = getProxy(MetaCharacterProxy)
	slot0.bayProxy = getProxy(BayProxy)
	slot0.curMetaShipID = slot0.contextData.shipID
	slot0.curShipVO = nil
	slot0.curMetaCharacterVO = nil

	slot0:updateData()
end

slot0.initUI = function(slot0)
	slot0.shipImg = slot0:findTF(&quot;ShipImg&quot;)
	slot0.nameTF = slot0:findTF(&quot;NamePanel&quot;)
	slot0.nameScrollText = slot0:findTF(&quot;NameMask/NameText&quot;, slot0.nameTF)
	slot0.shipTypeImg = slot0:findTF(&quot;TypeImg&quot;, slot0.nameTF)
	slot0.enNameText = slot0:findTF(&quot;NameENText&quot;, slot0.nameTF)
	slot0.nameTFStarUIList = UIItemList.New(slot0:findTF(&quot;StarContainer&quot;, slot0.nameTF), slot0:findTF(&quot;StarTpl&quot;, slot0.nameTF))
	slot0.previewBtn = slot0:findTF(&quot;PreviewBtn&quot;)
	slot0.rightPanel = slot0:findTF(&quot;RightPanel&quot;)
	slot0.qCharContain = slot0:findTF(&quot;DetailPanel/QChar&quot;, slot0.rightPanel)
	slot0.starTpl = slot0:findTF(&quot;DetailPanel/RarePanel/StarTpl&quot;, slot0.rightPanel)

	setActive(slot0.starTpl, false)

	slot0.starsFrom = slot0:findTF(&quot;DetailPanel/RarePanel/StarsFrom&quot;, slot0.rightPanel)
	slot0.starsTo = slot0:findTF(&quot;DetailPanel/RarePanel/StarsTo&quot;, slot0.rightPanel)
	slot0.starOpera = slot0:findTF(&quot;DetailPanel/RarePanel/OpImg&quot;, slot0.rightPanel)
	slot0.starFromList = UIItemList.New(slot0.starsFrom, slot0.starTpl)
	slot0.starToList = UIItemList.New(slot0.starsTo, slot0.starTpl)
	slot0.attrTpl = slot0:findTF(&quot;DetailPanel/AttrTpl&quot;, slot0.rightPanel)

	setActive(slot0.attrTpl, false)

	slot0.attrsContainer = slot0:findTF(&quot;DetailPanel/AttrsContainer&quot;, slot0.rightPanel)
	slot0.attrsList = UIItemList.New(slot0.attrsContainer, slot0.attrTpl)
	slot0.materialPanel = slot0:findTF(&quot;MaterialPanel&quot;, slot0.rightPanel)
	slot0.levelNumText = slot0:findTF(&quot;Info/LevelTipText&quot;, slot0.materialPanel)
	slot0.infoTF = slot0:findTF(&quot;Info&quot;, slot0.materialPanel)
	slot0.repairRateText = slot0:findTF(&quot;Info/ProgressTipText&quot;, slot0.materialPanel)
	slot0.materialTF = slot0:findTF(&quot;Info/Material&quot;, slot0.materialPanel)
	slot0.breakOutTipImg = slot0:findTF(&quot;TipText&quot;, slot0.materialPanel)
	slot0.goldTF = slot0:findTF(&quot;Gold&quot;, slot0.materialPanel)
	slot0.goldNumText = slot0:findTF(&quot;NumText&quot;, slot0.goldTF)
	slot0.starMaxTF = slot0:findTF(&quot;StarMax&quot;, slot0.materialPanel)
	slot0.activeBtn = slot0:findTF(&quot;ActiveBtn&quot;, slot0.materialPanel)
	slot0.activeBtnDisable = slot0:findTF(&quot;ActiveBtnDisable&quot;, slot0.materialPanel)
	slot0.previewTF = slot0:findTF(&quot;Preview&quot;)
	slot0.previewBG = slot0:findTF(&quot;BG&quot;, slot0.previewTF)
	slot0.previewPanel = slot0:findTF(&quot;PreviewPanel&quot;, slot0.previewTF)
	slot0.stages = slot0:findTF(&quot;StageScrollRect/Stages&quot;, slot0.previewPanel)
	slot0.stagesSnap = slot0:findTF(&quot;StageScrollRect&quot;, slot0.previewPanel):GetComponent(&quot;HorizontalScrollSnap&quot;)
	slot0.breakView = slot0:findTF(&quot;Content/Text&quot;, slot0.previewPanel)
	slot0.sea = slot0:findTF(&quot;Sea&quot;, slot0.previewPanel)
	slot0.rawImage = slot0.sea:GetComponent(&quot;RawImage&quot;)

	setActive(slot0.rawImage, false)

	slot0.healTF = slot0:findTF(&quot;Resources/Heal&quot;)
	slot0.healTF.transform.localPosition = Vector3(-360, 50, 40)

	setActive(slot0.healTF, false)

	slot0.seaLoading = slot0:findTF(&quot;BG/Loading&quot;, slot0.previewPanel)
	slot0.previewAttrTpl = slot0:findTF(&quot;FinalAttrPanel/AttrTpl&quot;, slot0.previewTF)
	slot0.previewAttrContainer = slot0:findTF(&quot;FinalAttrPanel/AttrsContainer&quot;, slot0.previewTF)
	slot0.previewAttrUIItemList = UIItemList.New(slot0.previewAttrContainer, slot0.previewAttrTpl)
end

slot0.addListener = function(slot0)
	onButton(slot0, slot0.previewBtn, function ()
		uv0:openPreviewPanel()
	end, SFX_PANEL)
	onButton(slot0, slot0.previewBG, function ()
		uv0:closePreviewPanel()
	end, SFX_CANCEL)
	onButton(slot0, slot0.activeBtn, function ()
		pg.MsgboxMgr.GetInstance():ShowMsgBox({
			content = i18n(&quot;meta_energy_active_box_tip&quot;),
			onYes = function ()
				pg.m02:sendNotification(GAME.ENERGY_META_ACTIVATION, {
					shipId = uv0.curMetaShipID
				})
			end,
			weight = LayerWeightConst.TOP_LAYER
		})
	end, SFX_PANEL)
end

slot0.updateData = function(slot0)
	slot0.curShipVO = slot0.bayProxy:getShipById(slot0.curMetaShipID)
	slot0.curMetaCharacterVO = slot0.curShipVO:getMetaCharacter()
end

slot0.TryPlayGuide = function(slot0)
	pg.SystemGuideMgr.GetInstance():PlayByGuideId(&quot;NG0026&quot;)
end

slot0.updateShipImg = function(slot0)
	slot1, slot2 = MetaCharacterConst.GetMetaCharacterPaintPath(slot0.curMetaCharacterVO.id, true)

	setImageSprite(slot0.shipImg, LoadSprite(slot1, slot2), true)

	slot4 = MetaCharacterConst.UIConfig[slot0.curMetaCharacterVO.id]

	setLocalPosition(slot0.shipImg, {
		x = slot4[5],
		y = slot4[6]
	})
	setLocalScale(slot0.shipImg, {
		x = slot4[3],
		y = slot4[4]
	})
end

slot0.updateNamePanel = function(slot0)
	slot1 = slot0.curShipVO
	slot2 = slot0.curMetaCharacterVO

	setScrollText(slot0.nameScrollText, slot1:getName())
	setImageSprite(slot0.shipTypeImg, LoadSprite(&quot;shiptype&quot;, slot1:getShipType()))
	setText(slot0.enNameText, slot1:getConfig(&quot;english_name&quot;))

	slot7 = slot1:getStar()

	slot0.nameTFStarUIList:make(function (slot0, slot1, slot2)
		if slot0 == UIItemList.EventUpdate then
			slot3 = uv0:findTF(&quot;empty&quot;, slot2)

			setActive(uv0:findTF(&quot;on&quot;, slot2), slot1 + 1 &lt;= uv1)
		end
	end)
	slot0.nameTFStarUIList:align(slot1:getMaxStar())
end

slot0.updateChar = function(slot0)
end

slot0.recycleChar = function(slot0)
	if slot0.shipPrefab and slot0.shipModel then
		PoolMgr.GetInstance():ReturnSpineChar(slot0.shipPrefab, slot0.shipModel)

		slot0.shipPrefab = nil
		slot0.shipModel = nil
	end
end

slot0.updateAttrPanel = function(slot0)
	slot1 = slot0.curShipVO
	slot3 = slot0.curMetaCharacterVO:getBreakOutInfo()

	slot4 = function(slot0, slot1)
		Clone(uv1).configId = uv0:getNextInfo().id
		slot5 = 0
		slot6 = 0

		if AttributeType.Expend ~= MetaCharacterConst.ENERGY_ATTRS[slot0 + 1] then
			slot5 = math.floor(uv1:getShipProperties()[slot4])
			slot6 = math.floor(slot3:getShipProperties()[slot4])
		else
			slot5 = math.floor(uv1:getBattleTotalExpend())
			slot6 = math.floor(slot3:getBattleTotalExpend())
		end

		setText(slot1:Find(&quot;NameText&quot;), AttributeType.Type2Name(slot4))
		setText(slot1:Find(&quot;CurValueText&quot;), slot5)
		setActive(slot1:Find(&quot;AddValueText&quot;), true)
		setText(slot1:Find(&quot;AddValueText&quot;), &quot;+&quot; .. slot6 - slot5)
		setText(slot1:Find(&quot;NextValueText&quot;), slot6)
		uv2.starFromList:align(uv1:getStar())
		uv2.starToList:align(slot3:getStar())
	end

	slot5 = function(slot0, slot1)
		slot2 = uv0:getShipProperties()
		slot4 = 0
		slot4 = (AttributeType.Expend == MetaCharacterConst.ENERGY_ATTRS[slot0 + 1] or math.floor(uv0:getShipProperties()[slot3])) and math.floor(uv0:getBattleTotalExpend())

		setText(slot1:Find(&quot;NameText&quot;), AttributeType.Type2Name(slot3))
		setText(slot1:Find(&quot;CurValueText&quot;), slot4)
		setText(slot1:Find(&quot;NextValueText&quot;), setColorStr(slot4, COLOR_GREEN))
		setText(slot1:Find(&quot;AddValueText&quot;), &quot;+0&quot;)
		setActive(slot1:Find(&quot;AddValueText&quot;), false)
		uv1.starFromList:align(uv0:getStar())
		uv1.starToList:align(0)
	end

	slot0.attrsList:make(function (slot0, slot1, slot2)
		if slot0 == UIItemList.EventUpdate then
			if uv0:hasNextInfo() then
				uv1(slot1, slot2)
				setActive(uv2.starOpera, true)
			else
				uv3(slot1, slot2)
				setActive(uv2.starOpera, false)
			end
		end
	end)
	slot0.attrsList:align(#MetaCharacterConst.ENERGY_ATTRS)
end

slot0.updateMaterialPanel = function(slot0, slot1)
	slot2 = slot0.curShipVO
	slot5 = getProxy(BagProxy)

	if not slot0.curMetaCharacterVO:getBreakOutInfo():hasNextInfo() then
		setActive(slot0.infoTF, false)
		setActive(slot0.breakOutTipImg, false)
		setActive(slot0.goldTF, false)
		setActive(slot0.starMaxTF, true)
		setActive(slot0.activeBtn, false)
		setActive(slot0.activeBtnDisable, true)

		return
	else
		setActive(slot0.infoTF, true)
		setActive(slot0.breakOutTipImg, true)
		setActive(slot0.goldTF, true)
		setActive(slot0.starMaxTF, false)
		setActive(slot0.activeBtn, true)
		setActive(slot0.activeBtnDisable, false)
	end

	slot6 = true
	slot7, slot8 = nil
	slot7, slot8 = slot4:getConsume()
	slot9, slot10, slot11 = nil
	slot9 = slot8[1].itemId
	slot10 = slot5:getItemCountById(slot9)
	slot12 = slot0:findTF(&quot;Item&quot;, slot0.materialTF)

	updateDrop(slot12, {
		type = DROP_TYPE_ITEM,
		id = slot9,
		count = slot10
	}, {
		hideName = true
	})
	onButton(slot0, slot12, function ()
		uv0:emit(BaseUI.ON_DROP, uv1)
	end, SFX_PANEL)
	setText(slot0:findTF(&quot;icon_bg/count&quot;, slot12), setColorStr(slot10, slot10 &lt; slot8[1].count and COLOR_RED or COLOR_GREEN) .. &quot;/&quot; .. slot11)

	if slot10 &lt; slot11 then
		slot6 = false
	end

	setText(slot0.goldNumText, getProxy(PlayerProxy):getData().gold &lt; slot7 and setColorStr(slot7, COLOR_RED) or slot7)

	if slot15 &lt; slot7 then
		slot6 = false

		onButton(slot0, slot0.activeBtnDisable, function ()
			pg.MsgboxMgr.GetInstance():ShowMsgBox({
				content = i18n(&quot;switch_to_shop_tip_2&quot;, i18n(&quot;word_gold&quot;)) .. &quot;\n&quot; .. i18n(&quot;text_noRes_tip&quot;, i18n(&quot;text_noRes_info_tip&quot;, Item.getConfigData(59001).name, uv0 - uv1)),
				weight = LayerWeightConst.SECOND_LAYER,
				onYes = function ()
					if getProxy(ContextProxy):getCurrentContext():getContextByMediator(MetaCharacterMediator) then
						slot2.data.autoOpenShipConfigID = uv0.curShipVO.configId
						slot2.data.autoOpenEnergy = true
					end

					uv0:closeView()
					gotoChargeScene(ChargeScene.TYPE_ITEM)
				end
			})
		end, SFX_PANEL)
	end

	slot18, slot19 = nil
	slot20, slot19 = slot4:getLimited()
	slot20 = slot2.level

	setText(slot0.levelNumText, i18n(&quot;meta_energy_ship_level_need&quot;, slot2.level &lt; slot20 and setColorStr(slot20, COLOR_RED) or setColorStr(slot20, COLOR_GREEN), slot18))

	slot21 = slot3:getRepairRate() * 100 .. &quot;%%&quot;

	setText(slot0.repairRateText, i18n(&quot;meta_energy_ship_repairrate_need&quot;, slot3:getRepairRate() &lt; slot19 / 100 and setColorStr(slot21, COLOR_RED) or setColorStr(slot21, COLOR_GREEN), slot19 .. &quot;%%&quot;))

	if slot2.level &lt; slot18 then
		slot6 = false
	end

	if slot3:getRepairRate() &lt; slot19 / 100 then
		slot6 = false
	end

	setActive(slot0.activeBtn, slot6)
	setActive(slot0.activeBtnDisable, not slot6)
end

slot0.moveShipImg = function(slot0, slot1)
	slot3 = MetaCharacterConst.UIConfig[slot0.curMetaCharacterVO.id]

	slot0:managedTween(LeanTween.moveX, nil, rtf(slot0.shipImg), slot1 and slot3[5] or -2000, 0.2):setFrom(slot1 and -2000 or slot3[5])
end

slot0.moveRightPanel = function(slot0)
	slot0:managedTween(LeanTween.moveX, nil, rtf(slot0.rightPanel), 577.64, 0.2):setFrom(2000)
end

slot0.updatePreviewAttrListPanel = function(slot0)
	slot2 = slot0.curMetaCharacterVO
	slot4 = Clone(slot0.curShipVO)
	slot4.level = 125
	slot6 = intProperties(slot4:getMetaCharacter():getFinalAddition(slot4))

	slot0.previewAttrUIItemList:make(function (slot0, slot1, slot2)
		if slot0 == UIItemList.EventUpdate then
			slot5 = uv0:findTF(&quot;AddValueText&quot;, slot2)
			slot6 = uv1[slot1 + 1]

			setImageSprite(uv0:findTF(&quot;AttrIcon&quot;, slot2), LoadSprite(&quot;attricon&quot;, slot6))
			setText(uv0:findTF(&quot;NameText&quot;, slot2), AttributeType.Type2Name(slot6))

			if slot6 == AttributeType.ArmorType then
				setText(slot5, uv2:getShipArmorName())
			else
				setText(slot5, uv3[slot6] or 0)
			end
		end
	end)
	slot0.previewAttrUIItemList:align(#{
		AttributeType.Durability,
		AttributeType.Cannon,
		AttributeType.Torpedo,
		AttributeType.AntiAircraft,
		AttributeType.Air,
		AttributeType.Reload,
		AttributeType.ArmorType,
		AttributeType.Dodge
	})
end

slot0.initPreviewPanel = function(slot0, slot1)
	slot2 = slot0.curShipVO
	slot0.breakIds = slot0:getAllBreakIDs(slot0.curMetaCharacterVO.id)

	for slot7 = 1, 3 do
		slot9 = uv0[slot0.breakIds[slot7]]

		onToggle(slot0, slot0:findTF(&quot;Stage&quot; .. slot7, slot0.stages), function (slot0)
			if slot0 then
				slot1 = uv0.breakout_view
				slot2 = checkExist(pg.ship_data_template[uv0.breakout_id], {
					&quot;specific_type&quot;
				}) or {}

				for slot6, slot7 in ipairs(slot2) do
					slot1 = slot1 .. &quot;/&quot; .. i18n(ShipType.SpecificTableTips[slot7])
				end

				changeToScrollText(uv1.breakView, slot1)
				uv1:switchStage(uv2)
			end
		end, SFX_PANEL)

		if slot7 == 1 then
			triggerToggle(slot10, true)
		end
	end

	onButton(slot0, slot0.seaLoading, function ()
		if not uv0.previewer then
			uv0:showBarrage()
		end
	end)
	slot0:updatePreviewAttrListPanel()
end

slot0.closePreviewPanel = function(slot0)
	if slot0.previewer then
		slot0.previewer:clear()

		slot0.previewer = nil
	end

	setActive(slot0.previewTF, false)
	setActive(slot0.rawImage, false)
	pg.UIMgr.GetInstance():UnblurPanel(slot0.previewTF, slot0._tf)
end

slot0.openPreviewPanel = function(slot0)
	setActive(slot0.previewTF, true)
	pg.UIMgr.GetInstance():BlurPanel(slot0.previewTF, false, {
		weight = LayerWeightConst.TOP_LAYER
	})
	slot0:playLoadingAni()
end

slot0.playLoadingAni = function(slot0)
	setActive(slot0.seaLoading, true)
end

slot0.stopLoadingAni = function(slot0)
	setActive(slot0.seaLoading, false)
end

slot0.getAllBreakIDs = function(slot0, slot1)
	slot2 = {}

	for slot6, slot7 in ipairs(uv0.all) do
		if math.floor(slot7 / 10) == slot1 then
			table.insert(slot2, slot7)
		end
	end

	return slot2
end

slot0.getWaponIdsById = function(slot0, slot1)
	return uv0[slot1].weapon_ids
end

slot0.getAllWeaponIds = function(slot0)
	slot1 = {}

	for slot5, slot6 in ipairs(slot0.breakIds) do
		setmetatable(slot1, {
			__add = function (slot0, slot1)
				for slot5, slot6 in ipairs(slot0) do
					if not table.contains(slot1, slot6) then
						table.insert(slot1, slot6)
					end
				end

				return slot1
			end
		})

		slot1 = slot1 + Clone(uv0[slot6].weapon_ids)
	end

	return slot1
end

slot0.showBarrage = function(slot0)
	slot1 = slot0.bayProxy
	slot1 = slot1:getShipById(slot0.curMetaShipID)
	slot2 = slot1:getMetaCharacter()
	slot0.previewer = WeaponPreviewer.New(slot0.rawImage)
	slot3 = slot0.previewer

	slot3:configUI(slot0.healTF)

	slot3 = slot0.previewer

	slot3:setDisplayWeapon(slot0:getWaponIdsById(slot0.breakOutId))

	slot3 = slot0.previewer

	slot3:load(40000, slot1, slot0:getAllWeaponIds(), function ()
		uv0:stopLoadingAni()
	end)
end

slot0.switchStage = function(slot0, slot1)
	if slot0.breakOutId == slot1 then
		return
	end

	slot0.breakOutId = slot1

	if slot0.previewer then
		slot0.previewer:setDisplayWeapon(slot0:getWaponIdsById(slot0.breakOutId))
	end
end

slot0.enablePartialBlur = function(slot0)
	if slot0._tf then
		slot1 = {}

		table.insert(slot1, slot0.previewBtn)
		table.insert(slot1, slot0.rightPanel)
		pg.UIMgr.GetInstance():OverlayPanelPB(slot0._tf, {
			pbList = slot1,
			groupName = LayerWeightConst.GROUP_META,
			weight = LayerWeightConst.BASE_LAYER - 1
		})
	end
end

slot0.disablePartialBlur = function(slot0)
	if slot0._tf then
		pg.UIMgr.GetInstance():UnOverlayPanel(slot0._tf)
	end
end

return slot0
</code></pre>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-lua.min.js"></script>
</body>
</html>