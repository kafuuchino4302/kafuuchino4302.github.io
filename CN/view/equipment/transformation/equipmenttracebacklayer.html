<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>equipmenttracebacklayer.lua</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
</head>
<body>
    <h1>equipmenttracebacklayer.lua</h1>
    <a href="index.html">返回主页</a>
    <pre><code class="language-lua">slot0 = class(&quot;EquipmentTraceBackLayer&quot;, import(&quot;view.base.BaseUI&quot;))

slot0.getUIName = function(slot0)
	return &quot;EquipmentTraceBackUI&quot;
end

slot0.init = function(slot0)
	slot1 = slot0._tf:Find(&quot;Adapt/Left/Operation&quot;)
	slot0.sortOrderBtn = slot1:Find(&quot;Bar1&quot;)
	slot0.orderText = slot1:Find(&quot;OrderText&quot;)
	slot0.sortBarBtn = slot1:Find(&quot;Bar2&quot;)
	slot0.sortImg = slot1:Find(&quot;SortImg&quot;)
	slot0.sortBar = slot0._tf:Find(&quot;Adapt/Left/SortBar&quot;)

	setActive(slot0.sortBar, false)

	slot0.equipLayout = slot0._tf:Find(&quot;Adapt/Left/Scroll View&quot;)
	slot0.equipLayoutScroll = slot0.equipLayout:GetComponent(&quot;LScrollRect&quot;)
	slot0.equipLayoutContent = slot0.equipLayout:Find(&quot;Viewport/Content&quot;)
	slot0.equipLayoutContent:GetComponent(typeof(GridLayoutGroup)).constraintCount = 6
	slot3 = slot0._tf:Find(&quot;Adapt/Right&quot;)
	slot0.sourceEquip = slot3:Find(&quot;Source&quot;)
	slot0.sourceEquipStatus = slot3:Find(&quot;Status&quot;)
	slot0.formulaWire = slot3:Find(&quot;Wire&quot;)
	slot0.targetEquip = slot3:Find(&quot;Target&quot;)
	slot0.confirmBtn = slot3:Find(&quot;ConfirmBtn&quot;)
	slot0.cancelBtn = slot3:Find(&quot;CancelBtn&quot;)
	slot0.materialLayout = slot3:Find(&quot;Scroll View&quot;)
	slot0.materialLayoutContent = slot0.materialLayout:Find(&quot;Viewport/Content&quot;)
	slot0.goldText = slot3:Find(&quot;GoldText&quot;)

	setText(slot1:Find(&quot;Field/Text&quot;), i18n(&quot;equipment_upgrade_quick_interface_source_chosen&quot;))
	setText(slot3:Find(&quot;Text&quot;), i18n(&quot;equipment_upgrade_quick_interface_materials_consume&quot;))

	slot0.loader = AutoLoader.New()
end

slot0.SortType = {
	Rarity = &quot;rarity&quot;,
	Strengthen = &quot;level&quot;,
	Type = &quot;type&quot;
}
slot1 = {
	slot0.SortType.Rarity,
	slot0.SortType.Type,
	slot0.SortType.Strengthen
}
slot2 = {
	[slot0.SortType.Rarity] = &quot;rarity&quot;,
	[slot0.SortType.Type] = &quot;type&quot;,
	[slot0.SortType.Strengthen] = &quot;strengthen&quot;
}
slot0.SortOrder = {
	Descend = 0,
	Ascend = 1
}
slot3 = {
	[slot0.SortOrder.Descend] = &quot;word_desc&quot;,
	[slot0.SortOrder.Ascend] = &quot;word_asc&quot;
}

slot0.SetEnv = function(slot0, slot1)
	slot0.env = slot1
end

slot0.GetAllPaths = function(slot0, slot1)
	slot2 = {}
	slot3 = {
		{
			slot1
		}
	}

	while #slot3 &gt; 0 do
		for slot9, slot10 in ipairs(EquipmentProxy.GetTransformSources(table.remove(slot3, 1)[1])) do
			slot11 = pg.equip_upgrade_data[slot10].upgrade_from
			slot12 = slot4[2] and Clone(slot4[2]) or {}

			table.insert(slot12, 1, slot10)
			table.insert(slot3, {
				slot11,
				slot12
			})

			if #slot0.env.tracebackHelper:GetEquipmentTransformCandicates(slot11) &gt; 0 then
				table.insertto(slot2, _.map(slot13, function (slot0)
					return {
						source = slot0,
						formulas = uv0
					}
				end))
			end
		end
	end

	return slot2
end

slot0.UpdateSourceEquipmentPaths = function(slot0)
	slot0.totalPaths = slot0:GetAllPaths(slot0.contextData.TargetEquipmentId)

	if slot0.contextData.sourceEquipmentInstance then
		slot0.contextData.sourceEquipmentInstance = _.detect(slot0.totalPaths, function (slot0)
			return EquipmentTransformUtil.SameDrop(slot0.source, uv0.contextData.sourceEquipmentInstance)
		end) and slot1.source or nil
	end
end

slot0.UpdateSort = function(slot0)
	for slot4, slot5 in ipairs(slot0.totalPaths) do
		slot5.isSourceEnough = slot5.source.type ~= DROP_TYPE_ITEM or slot5.source.composeCfg.material_num &lt;= slot5.source.template.count
		slot5.isMaterialEnough = slot5.isSourceEnough and EquipmentTransformUtil.CheckTransformFormulasSucceed(slot5.formulas, slot5.source)
	end

	table.sort(slot0.totalPaths, function (slot0, slot1)
		if slot0.isSourceEnough ~= slot1.isSourceEnough then
			return slot0.isSourceEnough
		end

		if slot0.isMaterialEnough ~= slot1.isMaterialEnough then
			return slot0.isMaterialEnough
		end

		if slot0.source.type ~= slot1.source.type then
			return slot0.source.type &lt; slot1.source.type
		end

		slot2 = uv0.contextData.sortType
		slot3 = uv0.contextData.sortOrder == uv1.SortOrder.Descend and 1 or -1

		if slot0.source.type == DROP_TYPE_ITEM then
			return (slot0.source.template.id - slot1.source.template.id) * slot3 &gt; 0
		end

		if (slot0.source.template.shipId or -1) ~= (slot1.source.template.shipId or -1) then
			return slot4 &lt; slot5
		end

		return (slot0.source.template:getConfigTable()[slot2] - slot1.source.template:getConfigTable()[slot2] ~= 0 and slot8 or slot0.source.template.id - slot1.source.template.id) * slot3 &gt; 0
	end)
	setText(slot0.orderText, i18n(uv1[slot0.contextData.sortOrder]))
	slot0.loader:GetSprite(&quot;ui/equipmenttracebackui_atlas&quot;, uv2[slot0.contextData.sortType], slot0.sortImg)
end

slot0.didEnter = function(slot0)
	slot0.equipLayoutScroll.onUpdateItem = function(slot0, slot1)
		uv0:UpdateSourceListItem(slot0, tf(slot1))
		TweenItemAlphaAndWhite(slot1)
	end

	slot0.equipLayoutScroll.onReturnItem = function(slot0, slot1)
		ClearTweenItemAlphaAndWhite(slot1)
	end

	slot4 = function()
		setActive(uv0.sortBar, not isActive(uv0.sortBar))
	end

	onButton(slot0, slot0.sortBarBtn, slot4, SFX_PANEL)

	for slot4 = 1, slot0.sortBar.childCount do
		slot5 = slot0.sortBar

		onButton(slot0, slot5:GetChild(slot4 - 1), function ()
			uv0.contextData.sortType = uv1[uv2]

			uv0:UpdateSort()
			uv0:UpdateSourceList()
			setActive(uv0.sortBar, false)
		end, SFX_PANEL)
	end

	onButton(slot0, slot0.sortOrderBtn, function ()
		uv0.contextData.sortOrder = uv1.SortOrder.Ascend - uv0.contextData.sortOrder

		uv0:UpdateSort()
		uv0:UpdateSourceList()
	end, SFX_PANEL)
	onButton(slot0, slot0.cancelBtn, function ()
		uv0:closeView()
	end, SFX_CANCEL)
	onButton(slot0, slot0.confirmBtn, function ()
		if not uv0.contextData.sourceEquipmentInstance then
			pg.TipsMgr.GetInstance():ShowTips(i18n(&quot;equipment_upgrade_quick_interface_feedback_source_chosen&quot;))

			return
		end

		if not EquipmentTransformUtil.CheckTransformFormulasSucceed(uv0.contextData.sourceEquipmentFormulaList, slot0) then
			pg.TipsMgr.GetInstance():ShowTips(i18n(&quot;equipment_upgrade_feedback_lack_of_materials&quot;))

			return
		end

		uv0:emit(EquipmentTraceBackMediator.TRANSFORM_EQUIP, slot0, uv0.contextData.sourceEquipmentFormulaList)
	end, SFX_PANEL)

	slot0.contextData.sortOrder = slot0.contextData.sortOrder or uv1.SortOrder.Descend
	slot0.contextData.sortType = slot0.contextData.sortType or uv1.SortType.Rarity

	slot0:UpdateSourceEquipmentPaths()
	slot0:UpdateSort()
	slot0:UpdateSourceList()
	slot0:UpdateFormula()
	updateDrop(slot0.targetEquip, {
		type = DROP_TYPE_EQUIP,
		id = slot0.contextData.TargetEquipmentId
	})
	pg.UIMgr.GetInstance():BlurPanel(slot0._tf, true)
end

slot0.UpdateSourceList = function(slot0)
	slot0.lastSourceItem = nil

	slot0.equipLayoutScroll:SetTotalCount(#slot0.totalPaths)
end

slot0.UpdateSourceListItem = function(slot0, slot1, slot2)
	slot3 = slot0.totalPaths[slot1 + 1].source
	slot4 = slot3.template

	updateDrop(slot2:Find(&quot;Item&quot;), slot3)
	setText(slot2:Find(&quot;Item/icon_bg/count&quot;), slot4.count)
	setActive(slot2:Find(&quot;EquipShip&quot;), slot4.shipId)
	setActive(slot2:Find(&quot;Selected&quot;), false)

	if slot3 == slot0.contextData.sourceEquipmentInstance then
		slot0.lastSourceItem = slot2

		setActive(slot2:Find(&quot;Selected&quot;), true)
	end

	setActive(slot2:Find(&quot;Item/mask&quot;), false)

	if slot3.type == DROP_TYPE_ITEM then
		slot8 = slot3.composeCfg.material_num &lt;= slot4.count

		setText(slot2:Find(&quot;Item/icon_bg/count&quot;), setColorStr(slot6 .. &quot;/&quot; .. slot7, slot8 and COLOR_WHITE or COLOR_RED))
		setActive(slot2:Find(&quot;Item/mask&quot;), not slot8)
	end

	if slot4.shipId then
		slot0.loader:GetSprite(&quot;qicon/&quot; .. getProxy(BayProxy):getShipById(slot4.shipId):getPainting(), &quot;&quot;, slot2:Find(&quot;EquipShip/Image&quot;))
	end

	slot5 = slot2:Find(&quot;Mask/NameText&quot;)
	slot5 = slot5:GetComponent(typeof(ScrollText))

	slot5:SetText(slot4:getConfig(&quot;name&quot;))
	onButton(slot0, slot2:Find(&quot;Item&quot;), function ()
		if uv0.type == DROP_TYPE_ITEM and not (uv0.composeCfg.material_num &lt;= uv0.template.count) then
			pg.TipsMgr.GetInstance():ShowTips(i18n(&quot;equipment_upgrade_feedback_lack_of_fragment&quot;, uv0.template:getConfig(&quot;name&quot;)))

			return
		end

		if uv1.lastSourceItem then
			setActive(uv1.lastSourceItem:Find(&quot;Selected&quot;), false)
		end

		uv1.lastSourceItem = uv2

		setActive(uv2:Find(&quot;Selected&quot;), true)

		uv1.contextData.sourceEquipmentInstance = uv0
		uv1.contextData.sourceEquipmentFormulaList = uv1.totalPaths[uv3 + 1].formulas

		uv1:UpdateFormula()
	end, SFX_PANEL)
end

slot0.UpdatePlayer = function(slot0, slot1)
	slot0.player = slot1

	slot0:UpdateConsumeComparer()
end

slot0.UpdateConsumeComparer = function(slot0)
	slot1 = 0
	slot2 = 0
	slot3 = true

	if slot0.contextData.sourceEquipmentInstance then
		slot3, slot1, slot2 = EquipmentTransformUtil.CheckTransformEnoughGold(slot0.contextData.sourceEquipmentFormulaList, slot0.contextData.sourceEquipmentInstance)
	end

	slot4 = setColorStr(slot1, slot3 and COLOR_WHITE or COLOR_RED)

	if slot2 &gt; 0 then
		slot4 = slot4 .. setColorStr(&quot; + &quot; .. slot2, slot3 and COLOR_GREEN or COLOR_RED)
	end

	slot0.goldText:GetComponent(typeof(Text)).text = slot4
end

slot0.UpdateFormula = function(slot0)
	slot1 = slot0.contextData.sourceEquipmentInstance

	setActive(slot0.sourceEquipStatus, not slot1)
	setActive(slot0.sourceEquip, slot1)
	setActive(slot0.materialLayout, slot1)

	if slot1 then
		updateDrop(slot0.sourceEquip, slot1)

		slot2 = slot0.sourceEquip:Find(&quot;icon_bg/count&quot;)
		slot3 = &quot;&quot;

		if slot1 and slot1.type == DROP_TYPE_ITEM then
			slot3 = slot1.composeCfg.material_num
		end

		setText(slot2, slot3)
		slot0.loader:GetSprite(&quot;ui/equipmenttracebackui_atlas&quot;, (not slot0.contextData.sourceEquipmentFormulaList or #slot4 &lt;= 1) and &quot;wire&quot; or &quot;wire2&quot;, slot0.formulaWire)
		slot0:UpdateFormulaMaterials()
	else
		slot0:UpdateConsumeComparer()
	end
end

slot0.UpdateFormulaMaterials = function(slot0)
	if not slot0.contextData.sourceEquipmentFormulaList then
		return
	end

	slot1 = {}
	slot2 = 0

	for slot6, slot7 in ipairs(slot0.contextData.sourceEquipmentFormulaList) do
		for slot12, slot13 in ipairs(pg.equip_upgrade_data[slot7].material_consume) do
			slot1[slot13[1]] = (slot1[slot13[1]] or 0) + slot13[2]
		end

		slot2 = slot2 + slot8.coin_consume
	end

	slot3 = {}

	for slot7, slot8 in pairs(slot1) do
		table.insert(slot3, {
			id = slot7,
			count = slot8
		})
	end

	table.sort(slot3, function (slot0, slot1)
		return slot1.id &lt; slot0.id
	end)

	slot0.consumeMaterials = slot3

	UIItemList.StaticAlign(slot0.materialLayoutContent, slot0.materialLayoutContent:GetChild(0), #slot0.consumeMaterials, function (slot0, slot1, slot2)
		if slot0 == UIItemList.EventUpdate then
			uv0:UpdateFormulaMaterialItem(slot1, slot2)
		end
	end)
	Canvas.ForceUpdateCanvases()

	slot4 = slot0.materialLayoutContent.rect.height &lt; slot0.materialLayout.rect.height
	slot0.materialLayout:GetComponent(typeof(ScrollRect)).enabled = not slot4

	setActive(slot0.materialLayout:Find(&quot;Scrollbar&quot;), not slot4)

	if slot4 then
		slot0.materialLayoutContent.anchoredPosition = Vector2.zero
	end

	slot0:UpdateConsumeComparer()
end

slot0.UpdateFormulaMaterialItem = function(slot0, slot1, slot2)
	slot3 = slot0.consumeMaterials[slot1 + 1]

	updateDrop(slot2:Find(&quot;Item&quot;), {
		type = DROP_TYPE_ITEM,
		id = slot3.id
	})
	setText(slot2:Find(&quot;Count&quot;), setColorStr(slot3.count, slot3.count &lt;= getProxy(BagProxy):getItemCountById(slot3.id) and COLOR_GREEN or COLOR_RED) .. &quot;/&quot; .. slot5)
	onButton(slot0, slot2:Find(&quot;Item&quot;), function ()
		uv0:emit(uv1.ON_DROP, uv2)
	end)
end

slot0.willExit = function(slot0)
	slot0.loader:Clear()
	pg.UIMgr.GetInstance():UnblurPanel(slot0._tf)
end

return slot0
</code></pre>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-lua.min.js"></script>
</body>
</html>