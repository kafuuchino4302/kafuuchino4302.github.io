<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>educateshoplayer.lua</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
</head>
<body>
    <h1>educateshoplayer.lua</h1>
    <a href="index.html">返回主页</a>
    <pre><code class="language-lua">slot0 = class(&quot;EducateShopLayer&quot;, import(&quot;..base.EducateBaseUI&quot;))

slot0.getUIName = function(slot0)
	return &quot;EducateShopUI&quot;
end

slot0.init = function(slot0)
	slot0:initData()
	slot0:findUI()
	slot0:addListener()
end

slot0.initData = function(slot0)
	assert(slot0.contextData.shopId, &quot;打开商店layer需要传入shopId&quot;)

	slot0.shopId = slot0.contextData.shopId
end

slot0.findUI = function(slot0)
	slot0.anim = slot0:findTF(&quot;anim_root&quot;):GetComponent(typeof(Animation))
	slot0.animEvent = slot0:findTF(&quot;anim_root&quot;):GetComponent(typeof(DftAniEvent))

	slot0.animEvent:SetEndEvent(function ()
		uv0:emit(uv1.ON_CLOSE)
	end)

	slot0.windowTF = slot0:findTF(&quot;anim_root/window&quot;)
	slot0.titleTF = slot0:findTF(&quot;title&quot;, slot0.windowTF)

	setText(slot0:findTF(&quot;Text&quot;, slot0.titleTF), i18n(&quot;word_shop&quot;))

	slot0.closeBtn = slot0:findTF(&quot;close_btn&quot;, slot0.titleTF)
	slot0.discountTF = slot0:findTF(&quot;Text/discount&quot;, slot0.titleTF)
	slot0.discountValueTF = slot0:findTF(&quot;Text&quot;, slot0.discountTF)
	slot0.goodContent = slot0:findTF(&quot;view/content&quot;, slot0.windowTF)
	slot0.goodUIList = UIItemList.New(slot0.goodContent, slot0:findTF(&quot;tpl&quot;, slot0.goodContent))

	setText(slot0:findTF(&quot;tpl/sellout/Text&quot;, slot0.goodContent), i18n(&quot;word_sell_out&quot;))

	slot0.tipTF = slot0:findTF(&quot;tip&quot;, slot0.windowTF)
	slot0.detailPanelTF = slot0:findTF(&quot;detail/content&quot;, slot0.windowTF)
	slot0.detailEmptyTF = slot0:findTF(&quot;detail/empty&quot;, slot0.windowTF)

	setText(slot0:findTF(&quot;Text&quot;, slot0.detailEmptyTF), i18n(&quot;child_shop_empty_tip&quot;))

	slot0.detailName = slot0:findTF(&quot;title/Text&quot;, slot0.detailPanelTF)
	slot0.detailDesc = slot0:findTF(&quot;desc&quot;, slot0.detailPanelTF)
	slot0.detailIcon = slot0:findTF(&quot;icon&quot;, slot0.detailPanelTF)
	slot0.detailAttrsTF = slot0:findTF(&quot;attrs&quot;, slot0.detailPanelTF)

	setActive(slot0:findTF(&quot;count&quot;, slot0.detailPanelTF), false)

	slot0.countValueTF = slot0:findTF(&quot;count/bg/Text&quot;, slot0.detailPanelTF)
	slot0.addCountBtn = slot0:findTF(&quot;count/add&quot;, slot0.detailPanelTF)
	slot0.reduceCountBtn = slot0:findTF(&quot;count/reduce&quot;, slot0.detailPanelTF)
	slot0.maxCountBtn = slot0:findTF(&quot;count/max&quot;, slot0.detailPanelTF)
	slot0.priceValue = slot0:findTF(&quot;price/value/Text&quot;, slot0.detailPanelTF)

	setText(slot0:findTF(&quot;price/title&quot;, slot0.detailPanelTF), i18n(&quot;child_shop_price_title&quot;))

	slot0.purchaseBtn = slot0:findTF(&quot;purchase_btn&quot;, slot0.detailPanelTF)

	setText(slot0:findTF(&quot;Text&quot;, slot0.purchaseBtn), i18n(&quot;word_buy&quot;))
end

slot0.addListener = function(slot0)
	onButton(slot0, slot0:findTF(&quot;anim_root/bg&quot;), function ()
		uv0:_close()
	end, SFX_PANEL)
	onButton(slot0, slot0.closeBtn, function ()
		uv0:_close()
	end, SFX_PANEL)
	onButton(slot0, slot0.addCountBtn, function ()
		if uv0:GetMaxCount() &lt;= uv0.countValue then
			return
		end

		uv0.countValue = uv0.countValue + 1

		uv0:updateDetailPrice()
	end, SFX_PANEL)
	onButton(slot0, slot0.reduceCountBtn, function ()
		if uv0.countValue &lt;= 1 then
			return
		end

		uv0.countValue = uv0.countValue - 1

		uv0:updateDetailPrice()
	end, SFX_PANEL)
	onButton(slot0, slot0.maxCountBtn, function ()
		if uv0.countValue == uv0:GetMaxCount() then
			return
		end

		uv0.countValue = slot0

		uv0:updateDetailPrice()
	end, SFX_PANEL)
	onButton(slot0, slot0.purchaseBtn, function ()
		if uv0:GetMaxCount() == 0 then
			pg.TipsMgr.GetInstance():ShowTips(i18n(&quot;common_no_resource&quot;))

			return
		end

		uv0:emit(EducateShopMediator.ON_SHOPPING, {
			shopId = uv0.shopId,
			goods = {
				{
					id = uv0.goods[uv0.selectedIndex].id,
					num = uv0.countValue
				}
			}
		})
	end, SFX_PANEL)

	slot1 = slot0.goodUIList

	slot1:make(function (slot0, slot1, slot2)
		if slot0 == UIItemList.EventUpdate then
			uv0:updateGoodItem(slot1, slot2)
		end
	end)
end

slot0.didEnter = function(slot0)
	pg.UIMgr.GetInstance():OverlayPanel(slot0._tf, {
		groupName = slot0:getGroupNameFromData(),
		weight = slot0:getWeightFromData() + 2
	})

	slot0.selectedIndex = 1
	slot0.countValue = 1

	slot0:refreshShops()
end

slot0.updateGoodItem = function(slot0, slot1, slot2)
	setActive(slot0:findTF(&quot;discount&quot;, slot2), slot0.isDiscount)
	setText(slot0:findTF(&quot;discount/Text&quot;, slot2), &quot;-&quot; .. slot0.discountValue)

	slot5 = slot0.goods[slot1 + 1]:GetPrice()

	setActive(slot0:findTF(&quot;bottom/price/price_original&quot;, slot2), slot0.isDiscount)
	setText(slot0:findTF(&quot;bottom/price/price_original&quot;, slot2), slot5)
	setText(slot0:findTF(&quot;bottom/price/price_final&quot;, slot2), slot0.isDiscount and slot4:GetPrice(slot0.discountRatio) or slot5)
	EducateHelper.UpdateDropShow(slot0:findTF(&quot;item&quot;, slot2), slot4:GetShowInfo())
	setActive(slot0:findTF(&quot;sellout&quot;, slot2), not slot4:CanBuy())
	setActive(slot0:findTF(&quot;selected&quot;, slot2), slot3 == slot0.selectedIndex)
	onButton(slot0, slot2, function ()
		if uv0 == uv1.selectedIndex then
			return
		end

		uv1.selectedIndex = uv0

		for slot3 = 0, uv1.goodContent.childCount - 1 do
			setActive(uv1:findTF(&quot;selected&quot;, uv1.goodContent:GetChild(slot3)), slot3 + 1 == uv1.selectedIndex)
		end

		uv1:updateDetail()
	end, SFX_PANEL)
end

slot0.refreshShops = function(slot0)
	slot0.shopProxy = getProxy(EducateProxy):GetShopProxy()
	slot0.shop = slot0.shopProxy:GetShopWithId(slot0.shopId)
	slot0.goods = slot0.shop:GetGoods(getProxy(EducateProxy):GetCurTime())
	slot0.char = getProxy(EducateProxy):GetCharData()
	slot0.isDiscount = slot0.shopProxy:IsDiscountById(slot0.shopId)
	slot0.discountRatio = slot0.shopProxy:GetDiscountById(slot0.shopId)
	slot0.discountValue = slot0.isDiscount and slot0.discountRatio / 100 .. &quot;%&quot; or &quot;&quot;

	setActive(slot0.discountTF, slot0.isDiscount)
	setText(slot0.discountValueTF, slot0.discountValue)
	setText(slot0.tipTF, slot0.shop:GetShopTip())
	slot0.goodUIList:align(#slot0.goods)

	slot2 = underscore.detect(slot0.goods, function (slot0)
		return slot0:GetRemainCnt() &gt; 0
	end)

	setActive(slot0.detailEmptyTF, not slot2)
	setActive(slot0.detailPanelTF, slot2)

	if slot2 then
		slot0:updateDetail()
	end
end

slot0.updateDetail = function(slot0)
	slot0.countValue = 1
	slot2 = slot0.goods[slot0.selectedIndex]:GetShowInfo()
	slot3 = pg.child_item[slot2.id]

	setText(slot0.detailName, slot3.name)
	setText(slot0.detailDesc, slot3.desc)
	setText(slot0.countValueTF, slot0.countValue)
	LoadImageSpriteAsync(&quot;educateprops/&quot; .. slot3.icon, slot0.detailIcon)
	slot0:updateDetailAttrs(EducateHelper.GetItemAddDrops(slot2))
	slot0:updateDetailPrice()
end

slot0.updateDetailAttrs = function(slot0, slot1)
	slot2 = #slot1 &gt; 2 and 2 or #slot1

	for slot6 = 1, slot0.detailAttrsTF.childCount do
		slot8 = slot0.detailAttrsTF:GetChild(slot6 - 1)

		if slot1[slot6] then
			setActive(slot8, true)
			EducateHelper.UpdateDropShowForAttr(slot8, slot7)
		else
			setActive(slot8, false)
		end
	end
end

slot0.updateDetailPrice = function(slot0)
	setText(slot0.countValueTF, slot0.countValue)
	setText(slot0.priceValue, slot0.goods[slot0.selectedIndex]:GetCost(slot0.discountRatio).num * slot0.countValue)
	setGray(slot0.purchaseBtn, slot0:GetMaxCount() == 0, true)
end

slot0.GetMaxCount = function(slot0)
	slot1 = slot0.goods[slot0.selectedIndex]
	slot3 = slot1:GetCost(slot0.discountRatio)

	return math.min(slot1:GetRemainCnt(), math.floor(slot0.char:GetResById(slot3.id) / slot3.num))
end

slot0._close = function(slot0)
	slot0.anim:Play(&quot;anim_educate_shop_out&quot;)
end

slot0.onBackPressed = function(slot0)
	slot0:_close()
end

slot0.willExit = function(slot0)
	slot0.animEvent:SetEndEvent(nil)
	pg.UIMgr.GetInstance():UnOverlayPanel(slot0._tf)
end

return slot0
</code></pre>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-lua.min.js"></script>
</body>
</html>