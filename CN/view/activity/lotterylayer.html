<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>lotterylayer.lua</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
</head>
<body>
    <h1>lotterylayer.lua</h1>
    <a href="index.html">返回主页</a>
    <pre><code class="language-lua">slot0 = class(&quot;LotteryLayer&quot;, import(&quot;..base.BaseUI&quot;))
slot1 = pg.activity_random_award_template
slot2 = true

slot0.getUIName = function(slot0)
	if uv0 then
		return &quot;LotteryForCHTUI&quot;
	else
		return &quot;LotteryUI&quot;
	end
end

slot0.setPlayerVO = function(slot0, slot1)
	slot0.playerVO = slot1

	slot0:updateResource()
end

slot0.updateResource = function(slot0)
	slot0.resCount = slot0.playerVO[id2res(slot0.resId)]

	setText(slot0.resource:Find(&quot;Text&quot;), slot0.resCount)
end

slot0.setActivity = function(slot0, slot1)
	slot0.activityVO = slot1
	slot0.resId = slot0.activityVO:getConfig(&quot;config_client&quot;).resId
	slot0.awardInfos = slot1:getAwardInfos()

	slot0:initActivityPools()
end

slot0.initActivityPools = function(slot0)
	slot0.activityPools = {}
	slot1 = slot0.activityVO
	slot1 = slot1:getConfig(&quot;config_data&quot;)
	slot3 = nil

	for slot7, slot8 in ipairs(_.select(uv0.all, function (slot0)
		return table.contains(uv0, slot0)
	end)) do
		slot9 = ActivityItemPool.New({
			id = slot8,
			awards = slot0.awardInfos[slot8],
			prevId = slot3,
			index = slot7
		})
		slot3 = slot8
		slot0.activityPools[slot9.id] = slot9
	end

	slot0.activityPool = slot0.activityPools[slot0.activityVO.data1 or slot1[1]]
end

slot0.init = function(slot0)
	slot0.lotteryPoolContainer = slot0:findTF(&quot;left_panel/pool_list/content&quot;)
	slot0.attrs = slot0:findTF(&quot;left_panel/pool_list/arrs&quot;)
	slot0.mainItenContainer = slot0:findTF(&quot;right_panel/main_item_list/content&quot;)
	slot0.mainItenTpl = slot0:findTF(&quot;equipmenttpl&quot;, slot0.mainItenContainer)
	slot0.resource = slot0:findTF(&quot;left_panel/resource&quot;)
	slot0.launchOneBtn = slot0:findTF(&quot;left_panel/launch_one_btn&quot;)
	slot0.launchOneBtnTxt = slot0:findTF(&quot;res/Text&quot;, slot0.launchOneBtn):GetComponent(typeof(Text))
	slot0.launchTenBtn = slot0:findTF(&quot;left_panel/launch_ten_btn&quot;)
	slot0.launchTenBtnTxt = slot0:findTF(&quot;res/Text&quot;, slot0.launchTenBtn):GetComponent(typeof(Text))
	slot0.launchMaxBtn = slot0:findTF(&quot;left_panel/launch_max_btn&quot;)
	slot0.launchMaxBtnTxt = slot0:findTF(&quot;res/Text&quot;, slot0.launchMaxBtn):GetComponent(typeof(Text))
	slot0.awardsCounttxt = slot0:findTF(&quot;right_panel/count_container/Text&quot;):GetComponent(typeof(Text))
	slot0.bgTF = slot0:findTF(&quot;right_panel&quot;):GetComponent(typeof(Image))
	slot0.descBtn = slot0:findTF(&quot;right_panel/desc_btn&quot;)
	slot0.bonusWindow = slot0:findTF(&quot;Msgbox&quot;)

	setActive(slot0.bonusWindow, false)

	slot0.topPanel = slot0:findTF(&quot;top&quot;)
end

slot0.didEnter = function(slot0)
	onButton(slot0, slot0:findTF(&quot;top/back_btn&quot;), function ()
		uv0:emit(uv1.ON_CLOSE)
	end, SOUND_BACK)

	slot2 = {
		1,
		10,
		&quot;max&quot;
	}

	for slot6, slot7 in ipairs({
		slot0.launchOneBtn,
		slot0.launchTenBtn,
		slot0.launchMaxBtn
	}) do
		slot9 = Drop.New({
			type = DROP_TYPE_RESOURCE,
			id = slot0.resId
		})

		GetImageSpriteFromAtlasAsync(slot9:getIcon(), &quot;&quot;, slot7:Find(&quot;res/icon&quot;), true)
		onButton(slot0, slot7, function ()
			if not uv0.activityPool then
				return
			end

			if uv0.activityPool ~= uv0.showActivityPool then
				pg.TipsMgr.GetInstance():ShowTips(i18n(&quot;amercian_notice_5&quot;))

				return
			end

			if uv0.activityPool:getleftItemCount() == 0 then
				pg.TipsMgr.GetInstance():ShowTips(i18n(&quot;activity_pool_awards_empty&quot;))

				return
			end

			if not uv0.activityPool:enoughResForUsage((uv1[uv2] ~= &quot;max&quot; or math.min(slot0, math.max(math.floor(uv0.resCount / uv0.activityPool:getComsume().count), 1))) and math.min(slot0, uv1[uv2])) then
				pg.TipsMgr.GetInstance():ShowTips(i18n(&quot;common_no_resource&quot;))

				return
			end

			slot2 = function()
				pg.MsgboxMgr.GetInstance():ShowMsgBox({
					content = i18n(&quot;amercian_notice_1&quot;, uv0 * uv1.count, uv0),
					onYes = function ()
						uv0:emit(LotteryMediator.ON_LAUNCH, uv0.activityVO.id, uv0.activityPool.id, uv1, uv2[uv3] == &quot;max&quot;)
					end
				})
			end

			if uv0.playerVO:OilMax(1) or uv0.playerVO:GoldMax(1) then
				pg.MsgboxMgr.GetInstance():ShowMsgBox({
					content = i18n(&quot;amercian_notice_6&quot;),
					onYes = function ()
						uv0()
					end
				})
			else
				slot2()
			end
		end, SFX_PANEL)
	end

	onButton(slot0, slot0.descBtn, function ()
		if not uv0.showActivityPool then
			return
		end

		slot0, slot1 = uv0.showActivityPool:getItems()

		uv0:showBonus(slot0, slot1)
	end, SFX_PANEL)
	onButton(slot0, slot0:findTF(&quot;window/top/btnBack&quot;, slot0.bonusWindow), function ()
		setActive(uv0.bonusWindow, false)
	end)
	onButton(slot0, slot0:findTF(&quot;window/button&quot;, slot0.bonusWindow), function ()
		setActive(uv0.bonusWindow, false)
	end)

	slot6 = function()
		setActive(uv0.bonusWindow, false)
	end

	onButton(slot0, slot0.bonusWindow, slot6)

	slot0.bgs = {}
	slot0.attrTFs = {}

	for slot6 = 1, table.getCount(slot0.activityPools) do
		if not IsNil(slot0.attrs:Find(&quot;arr_&quot; .. slot6)) then
			table.insert(slot0.attrTFs, slot7)
		end
	end

	slot0:updateResource()
	slot0:initPoolTFs()
	slot0:updateActivityPoolState()
	triggerToggle(slot0.activityPoolTFs[slot0.activityPool.id], true)
end

slot0.onActivityUpdated = function(slot0, slot1)
	slot0:setActivity(slot1)
	slot0:updateActivityPoolState()
	slot0:switchToPool(slot1.data1)
end

slot0.initPoolTFs = function(slot0)
	slot0.activityPoolTFs = {}

	for slot4, slot5 in pairs(slot0.activityPools) do
		slot6 = slot0.lotteryPoolContainer
		slot6 = slot6:GetChild(slot5.index - 1)
		slot0.activityPoolTFs[slot5.id] = slot6

		onToggle(slot0, slot6, function (slot0)
			if slot0 then
				if not uv0.prevId or uv1.activityPools[uv0.prevId]:canOpenNext() then
					uv1:emit(LotteryMediator.ON_SWITCH, uv1.activityVO.id, uv0.id)
				else
					uv1:switchToPool(uv0.id)
				end
			end
		end)
	end
end

slot0.updateActivityPoolState = function(slot0)
	for slot4, slot5 in pairs(slot0.activityPools) do
		slot6 = slot0.activityPoolTFs[slot4]
		slot7 = not slot5.prevId or slot0.activityPools[slot5.prevId]:canOpenNext()

		setActive(slot6:Find(&quot;bg/unlock&quot;), slot7)
		setActive(slot6:Find(&quot;bg/lock&quot;), not slot7)
		setActive(slot6:Find(&quot;selected/unlock&quot;), slot7)
		setActive(slot6:Find(&quot;selected/lock&quot;), not slot7)

		if uv0 then
			setActive(slot6:Find(&quot;icon&quot;), slot7)
			setActive(slot6:Find(&quot;icon_g&quot;), not slot7)
		end

		setActive(slot6:Find(&quot;finish&quot;), slot5:getleftItemCount() == 0)

		if slot0.attrTFs[slot5.index - 1] then
			triggerToggle(slot0.attrTFs[slot5.index - 1], slot7)
		end
	end
end

slot0.switchToPool = function(slot0, slot1)
	slot2 = slot0.activityPools[slot1]
	slot3 = slot0.activityPoolTFs[slot1]

	slot0:updateMainItems(slot2)
	slot0:updateAwardsFetchedCount(slot2)

	if not slot0.bgs[slot1] then
		slot0.bgs[slot1] = (not uv0 or LoadSprite(&quot;lotterybg/cht_&quot; .. slot2.index)) and LoadSprite(&quot;lotterybg/kr_re_&quot; .. slot2.index)
	end

	slot0.bgTF.sprite = slot4
	slot5 = slot2:getComsume()
	slot0.launchOneBtnTxt.text = slot5.count
	slot0.launchTenBtnTxt.text = slot5.count * math.min(slot2:getleftItemCount(), 10)
	slot0.launchMaxBtnTxt.text = slot5.count * math.min(slot2:getleftItemCount(), math.max(math.floor(slot0.resCount / slot5.count), 1))
	slot0.showActivityPool = slot0.activityPools[slot2.id]
end

slot0.updateAwardsFetchedCount = function(slot0, slot1)
	if slot0.awardsCounttxt then
		slot2 = slot1:getFetchCount()
		slot3 = slot1:getItemCount()
		slot0.awardsCounttxt.text = setColorStr(slot3 - slot2, slot2 &lt; slot3 and COLOR_GREEN or COLOR_RED) .. &quot;/&quot; .. slot3
	end
end

slot0.updateMainItems = function(slot0, slot1)
	for slot7 = slot0.mainItenContainer.childCount, #slot1:getMainItems() do
		cloneTplTo(slot0.mainItenTpl, slot0.mainItenContainer)
	end

	for slot7 = 1, slot0.mainItenContainer.childCount do
		slot9 = slot7 &lt;= #slot2

		setActive(slot0.mainItenContainer:GetChild(slot7 - 1), slot9)

		if slot9 then
			slot10 = slot2[slot7]

			updateDrop(slot8, slot10)
			setActive(slot8:Find(&quot;mask&quot;), slot10.surplus &lt;= 0)
			setText(slot8:Find(&quot;icon_bg/surplus&quot;), &quot;X&quot; .. (slot10.surplus or &quot;&quot;))
			onButton(slot0, slot8, function ()
				uv0:emit(uv1.ON_DROP, uv2)
			end, SFX_PANEL)
		end
	end
end

slot0.showBonus = function(slot0, slot1, slot2)
	setActive(slot0.bonusWindow, true)

	slot0.awardMain = slot1
	slot0.awardNormal = slot2
	slot0.trDropTpl = slot0:findTF(&quot;Msgbox/window/items/scrollview/item&quot;)
	slot0.trDrops = slot0:findTF(&quot;Msgbox/window/items/scrollview/list/list_main&quot;)
	slot0.dropList = UIItemList.New(slot0.trDrops, slot0.trDropTpl)

	slot0.dropList:make(function (slot0, slot1, slot2)
		uv0:updateDrop(slot0, slot1, slot2, uv0.awardMain)
	end)
	slot0.dropList:align(#slot0.awardMain)

	slot0.trDropsN = slot0:findTF(&quot;Msgbox/window/items/scrollview/list/list_normal&quot;)
	slot0.dropListN = UIItemList.New(slot0.trDropsN, slot0.trDropTpl)

	slot0.dropListN:make(function (slot0, slot1, slot2)
		uv0:updateDrop(slot0, slot1, slot2, uv0.awardNormal)
	end)
	slot0.dropListN:align(#slot0.awardNormal)
end

slot0.updateDrop = function(slot0, slot1, slot2, slot3, slot4)
	if slot1 == UIItemList.EventUpdate then
		slot5 = slot4[slot2 + 1]

		updateDrop(slot3, slot5)
		setText(slot3:Find(&quot;count&quot;), slot5.surplus .. &quot;/&quot; .. slot5.total)
		setActive(slot3:Find(&quot;mask&quot;), slot5.surplus &lt;= 0)
		setScrollText(findTF(slot3, &quot;name_mask/name&quot;), slot5.name or slot5:getConfig(&quot;name&quot;))
	end
end

slot0.willExit = function(slot0)
	slot0.bgs = nil
end

return slot0
</code></pre>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-lua.min.js"></script>
</body>
</html>