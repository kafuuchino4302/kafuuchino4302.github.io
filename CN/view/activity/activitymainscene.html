<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>activitymainscene.lua</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
</head>
<body>
    <h1>activitymainscene.lua</h1>
    <a href="index.html">返回主页</a>
    <pre><code class="language-lua">slot0 = class(&quot;ActivityMainScene&quot;, import(&quot;..base.BaseUI&quot;))
slot0.LOCK_ACT_MAIN = &quot;ActivityMainScene:LOCK_ACT_MAIN&quot;
slot0.UPDATE_ACTIVITY = &quot;ActivityMainScene:UPDATE_ACTIVITY&quot;
slot0.GET_PAGE_BGM = &quot;ActivityMainScene.GET_PAGE_BGM&quot;
slot0.FLUSH_TABS = &quot;ActivityMainScene.FLUSH_TABS&quot;

slot0.preload = function(slot0, slot1)
	slot1()
end

slot0.getUIName = function(slot0)
	return &quot;ActivityMainUI&quot;
end

slot0.PlayBGM = function(slot0)
end

slot0.onBackPressed = function(slot0)
	if slot0.locked then
		return
	end

	for slot4, slot5 in pairs(slot0.windowList) do
		if isActive(slot5._tf) then
			slot0:HideWindow(slot5.class)

			return
		end
	end

	if slot0.awardWindow and slot0.awardWindow:GetLoaded() and slot0.awardWindow:isShowing() then
		slot0.awardWindow:Hide()

		return
	end

	slot0:emit(uv0.ON_BACK_PRESSED)
end

slot1 = nil

slot0.init = function(slot0)
	slot1 = slot0._tf:GetComponent(typeof(ItemList)).prefabItem:ToTable()

	for slot5, slot6 in ipairs({
		&quot;btnBack&quot;,
		&quot;pageContainer&quot;,
		&quot;permanentFinshMask&quot;,
		&quot;tabs&quot;,
		&quot;tab&quot;,
		&quot;entranceContent&quot;,
		&quot;entranceTpl&quot;,
		&quot;lockAll&quot;
	}) do
		slot0[slot6] = slot1[slot5].transform
	end

	slot0.entranceList = UIItemList.New(slot0.entranceContent, slot0.entranceTpl)
	slot0.windowList = {}
	slot0.awardWindow = AwardWindow.New(slot0._tf, slot0.event)
	slot0.chargeTipWindow = ChargeTipWindow.New(slot0._tf, slot0.event)

	setActive(slot0.tab, false)
	setActive(slot0.lockAll, false)
	setActive(slot0.permanentFinshMask, false)

	slot3 = slot0.permanentFinshMask

	setText(slot3:Find(&quot;piece/Text&quot;), i18n(&quot;activity_permanent_tips2&quot;))

	slot4 = slot0.permanentFinshMask

	onButton(slot0, slot4:Find(&quot;piece/arrow/Image&quot;), function ()
		uv0:emit(ActivityMediator.FINISH_ACTIVITY_PERMANENT)
	end, SFX_PANEL)

	slot0.tabsList = UIItemList.New(slot0.tabs, slot0.tab)
	slot2 = slot0.tabsList

	slot2:make(function (slot0, slot1, slot2)
		if slot0 == UIItemList.EventUpdate then
			if uv0.pageDic[uv0.activities[slot1 + 1].id] ~= nil then
				if slot3:getConfig(&quot;title_res_tag&quot;) then
					setImageSprite(uv0:findTF(&quot;off/text&quot;, slot2), GetSpriteFromAtlas(&quot;activityuitable/&quot; .. slot5 .. &quot;_text&quot;, &quot;&quot;) or GetSpriteFromAtlas(&quot;activityuitable/activity_text&quot;, &quot;&quot;), true)
					setImageSprite(uv0:findTF(&quot;on/text&quot;, slot2), GetSpriteFromAtlas(&quot;activityuitable/&quot; .. slot5 .. &quot;_text_selected&quot;, &quot;&quot;) or GetSpriteFromAtlas(&quot;activityuitable/activity_text_selected&quot;, &quot;&quot;), true)
					setActive(uv0:findTF(&quot;red&quot;, slot2), slot3:readyToAchieve())
					onToggle(uv0, slot2, function (slot0)
						if slot0 then
							uv0:selectActivity(uv1)
						end
					end, SFX_PANEL)
				else
					onToggle(uv0, slot2, function (slot0)
						uv0:loadActivityPanel(slot0, uv1)
					end, SFX_PANEL)
				end
			end
		end
	end)
end

slot0.didEnter = function(slot0)
	slot0:bind(uv0.LOCK_ACT_MAIN, function (slot0, slot1)
		uv0.locked = slot1

		setActive(uv0.lockAll, slot1)
	end)
	slot0:bind(uv0.UPDATE_ACTIVITY, function (slot0, slot1)
		uv0:updateActivity(slot1)
	end)
	slot0:bind(uv0.GET_PAGE_BGM, function (slot0, slot1, slot2)
		slot2.bgm = uv0:getBGM(slot1) or uv0:getBGM()
	end)
	slot0:bind(uv0.FLUSH_TABS, function ()
		uv0:flushTabs()
	end)
	getProxy(CommanderManualProxy):TaskProgressAdd(2020, 1)
	onButton(slot0, slot0.btnBack, function ()
		uv0:emit(uv1.ON_BACK)
	end, SOUND_BACK)
	slot0:updateEntrances()
	slot0:emit(ActivityMediator.SHOW_NEXT_ACTIVITY)
	pg.CameraFixMgr.GetInstance():Adapt()
end

slot0.setPlayer = function(slot0, slot1)
	slot0.shareData:SetPlayer(slot1)
end

slot0.setFlagShip = function(slot0, slot1)
	slot0.shareData:SetFlagShip(slot1)
end

slot0.updateTaskLayers = function(slot0)
	if not slot0.activity then
		return
	end

	slot0:updateActivity(slot0.activity)
end

slot0.getActClass = function(slot0, slot1)
	return import(&quot;view.activity.subPages.&quot; .. slot1)
end

slot0.instanceActivityPage = function(slot0, slot1)
	if slot1:getConfig(&quot;page_info&quot;).class_name and not slot0.pageDic[slot1.id] and not slot1:isEnd() then
		if slot0:getActClass(slot2.class_name).New(slot0.pageContainer, slot0.event, slot0.contextData):UseSecondPage(slot1) then
			slot4:SetUIName(slot2.ui_name2)
		else
			slot4:SetUIName(slot2.ui_name)
		end

		slot4:SetShareData(slot0.shareData)

		slot0.pageDic[slot1.id] = slot4
	end
end

slot0.setActivities = function(slot0, slot1)
	slot0.activities = slot1 or {}
	slot0.shareData = slot0.shareData or ActivityShareData.New()
	slot0.pageDic = slot0.pageDic or {}

	for slot5, slot6 in ipairs(slot1) do
		slot0:instanceActivityPage(slot6)
	end

	slot0.activity = nil

	table.sort(slot0.activities, CompareFuncs({
		function (slot0)
			return -slot0:getShowPriority()
		end,
		function (slot0)
			return -slot0.id
		end
	}))
	slot0:flushTabs()
end

slot0.getActivityIndex = function(slot0, slot1)
	for slot5, slot6 in ipairs(slot0.activities) do
		if slot6.id == slot1 then
			return slot5
		end
	end

	return nil
end

slot0.updateActivity = function(slot0, slot1)
	if ActivityConst.PageIdLink[slot1.id] then
		slot1 = getProxy(ActivityProxy):getActivityById(ActivityConst.PageIdLink[slot1.id])
	end

	if slot1:isShow() and slot1:isCorePage(slot0.contextData.coreName or &quot;&quot;) and not slot1:isEnd() then
		slot0.activities[slot0:getActivityIndex(slot1.id) or #slot0.activities + 1] = slot1

		table.sort(slot0.activities, CompareFuncs({
			function (slot0)
				return -slot0:getShowPriority()
			end,
			function (slot0)
				return -slot0.id
			end
		}))

		if not slot0.pageDic[slot1.id] then
			slot0:instanceActivityPage(slot1)
		end

		slot0:flushTabs()

		if slot0.activity and slot0.activity.id == slot1.id then
			slot0.activity = slot1

			slot0.pageDic[slot1.id]:ActionInvoke(&quot;Flush&quot;, slot1)
			setActive(slot0.permanentFinshMask, pg.activity_task_permanent[slot1.id] and slot1:canPermanentFinish())
		end
	end
end

slot0.removeActivity = function(slot0, slot1)
	if slot0:getActivityIndex(slot1) then
		table.remove(slot0.activities, slot2)
		slot0.pageDic[slot1]:Destroy()

		slot0.pageDic[slot1] = nil

		slot0:flushTabs()

		if slot0.activity and slot0.activity.id == slot1 then
			slot0.activity = nil

			slot0:verifyTabs()
		end
	end
end

slot0.loadLayers = function(slot0)
	if slot0.pageDic[slot0.activity.id] and slot1.OnLoadLayers then
		slot1:OnLoadLayers()
	end
end

slot0.removeLayers = function(slot0)
	if slot0.pageDic[slot0.activity.id] and slot1.OnRemoveLayers then
		slot1:OnRemoveLayers()
	end
end

slot0.GetOnShowEntranceData = function()
	uv0 = uv0 or require(&quot;GameCfg.activity.EntranceData&quot;)

	assert(uv0, &quot;Missing EntranceData.lua!&quot;)

	uv0 = uv0 or {}

	return _.select(uv0, function (slot0)
		return slot0.isShow and slot0.isShow()
	end)
end

slot0.updateEntrances = function(slot0)
	slot0.entranceList:make(function (slot0, slot1, slot2)
		if slot0 == UIItemList.EventUpdate then
			slot4 = &quot;empty&quot;

			removeOnButton(slot2)

			slot5 = false

			if uv0[slot1 + 1] and table.getCount(slot3) ~= 0 and slot3.isShow() then
				onButton(uv1, slot2, function ()
					uv0:emit(uv1.event, uv1.data[1], uv1.data[2])
				end, SFX_PANEL)

				slot4 = slot3.banner

				if slot3.isTip then
					slot5 = slot3.isTip()
				end
			end

			setActive(slot2:Find(&quot;tip&quot;), slot5)
			LoadImageSpriteAsync(&quot;activitybanner/&quot; .. slot4, slot2)
		end
	end)
	slot0.entranceList:align(math.max(#uv0.GetOnShowEntranceData(), 5))
end

slot0.flushTabs = function(slot0)
	slot0.tabsList:align(#slot0.activities)
end

slot0.selectActivity = function(slot0, slot1)
	if slot1 and (not slot0.activity or slot0.activity.id ~= slot1.id) then
		slot2 = slot0.pageDic[slot1.id]

		assert(slot2, &quot;找不到id:&quot; .. slot1.id .. &quot;的活动页，请检查&quot;)
		slot2:Load()
		slot2:ActionInvoke(&quot;Flush&quot;, slot1)
		slot2:ActionInvoke(&quot;ShowOrHide&quot;, true)

		if slot0.activity and slot0.activity.id ~= slot1.id then
			slot0.pageDic[slot0.activity.id]:ActionInvoke(&quot;ShowOrHide&quot;, false)
		end

		slot0.activity = slot1
		slot0.contextData.id = slot1.id

		setActive(slot0.permanentFinshMask, pg.activity_task_permanent[slot1.id] and slot1:canPermanentFinish())
	end
end

slot0.checkAutoHideActivity = function(slot0)
	if slot0.activity and not slot0.activity:isShow() then
		slot0:removeActivity(slot0.activity.id)
	end
end

slot0.verifyTabs = function(slot0, slot1)
	triggerToggle(slot0.tabs:GetChild((slot0:getActivityIndex(slot1) or 1) - 1), true)
end

slot0.loadActivityPanel = function(slot0, slot1, slot2)
	slot3 = slot2:getConfig(&quot;type&quot;)

	if nil and slot1 then
		slot0:emit(ActivityMediator.OPEN_LAYER, slot4)
	elseif slot4 and not slot1 then
		slot0:emit(ActivityMediator.CLOSE_LAYER, slot4.mediator)
	else
		originalPrint(&quot;------活动id为&quot; .. slot2.id .. &quot;类型为&quot; .. slot2:getConfig(&quot;type&quot;) .. &quot;的页面不存在&quot;)
	end
end

slot0.getBonusWindow = function(slot0, slot1, slot2)
	if not slot0:findTF(slot1) then
		slot4 = PoolMgr.GetInstance()

		slot4:GetUI(&quot;ActivitybonusWindow&quot;, true, function (slot0)
			SetParent(slot0, uv0._tf, false)

			slot0.name = uv1

			uv2(slot0)
		end)
	else
		slot2(slot3)
	end
end

slot0.ShowWindow = function(slot0, slot1, slot2)
	if not slot0.windowList[slot1.__cname] then
		slot0:getBonusWindow(slot3, function (slot0)
			uv0.windowList[uv1] = uv2.New(tf(slot0), uv0)

			uv0.windowList[uv1]:Show(uv3)
		end)
	else
		slot0.windowList[slot3]:Show(slot2)
	end
end

slot0.HideWindow = function(slot0, slot1)
	if not slot0.windowList[slot1.__cname] then
		return
	end

	slot0.windowList[slot2]:Hide()
end

slot0.ShowAwardWindow = function(slot0, slot1, slot2, slot3)
	slot0.awardWindow:ExecuteAction(&quot;Flush&quot;, slot1, slot2, slot3)
end

slot0.OnChargeSuccess = function(slot0, slot1)
	slot0.chargeTipWindow:ExecuteAction(&quot;Show&quot;, slot1)
end

slot0.willExit = function(slot0)
	slot0.shareData = nil

	for slot4, slot5 in pairs(slot0.pageDic) do
		slot5:Destroy()
	end

	for slot4, slot5 in pairs(slot0.windowList) do
		slot5:Dispose()
	end

	if slot0.awardWindow then
		slot0.awardWindow:Destroy()

		slot0.awardWindow = nil
	end

	if slot0.chargeTipWindow then
		slot0.chargeTipWindow:Destroy()

		slot0.chargeTipWindow = nil
	end
end

return slot0
</code></pre>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-lua.min.js"></script>
</body>
</html>