<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>castlemainscene.lua</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
</head>
<body>
    <h1>castlemainscene.lua</h1>
    <a href="index.html">返回主页</a>
    <pre><code class="language-lua">slot0 = class(&quot;CastleMainScene&quot;, import(&quot;..base.BaseUI&quot;))
slot0.optionsPath = {
	&quot;main/top/btn_home&quot;
}
slot1 = &quot;name&quot;
slot2 = &quot;default_value&quot;
slot3 = &quot;random_value&quot;
slot0.ACT_ID = ActivityConst.CASTLE_ACT_ID
slot0.AWARD_ACT_ID = ActivityConst.CASTLE_AWARD_ID
slot0.SKILL_COLOR = {
	&quot;#546190&quot;,
	&quot;#835490&quot;,
	&quot;#A57D55&quot;,
	&quot;#C15348&quot;
}
slot0.BAD_FILL_COLOR = Color(0.6588235294117647, 0.5019607843137255, 0.4823529411764706, 0.5)
slot0.NORMAL_FILL_COLOR = Color(1, 1, 1, 0.5)
slot0.TRANSPARENT_COLOR = Color(1, 1, 1, 0)
slot0.MARK_CURRENT = &quot;1&quot;
slot0.MARK_UNEXPLORED = &quot;2&quot;
slot0.MARK_BAD = &quot;3&quot;
slot0.MARK_EXPLORABLE = &quot;4&quot;
slot0.MAP_POS = {
	1,
	2,
	3,
	3,
	4,
	5,
	5,
	6,
	7,
	7,
	8,
	9,
	9,
	10,
	11,
	11,
	12,
	13,
	13,
	14,
	15,
	15,
	17,
	16
}
slot0.ROOM_NUM = 17
slot0.WALK_SE = &quot;event:/ui/castle_walk&quot;
slot0.ROLL_SE = &quot;event:/ui/caslte_roll&quot;
slot0.CARD_SE = &quot;event:/ui/huihua1&quot;

slot0.getUIName = function(slot0)
	return &quot;CastleMainUI&quot;
end

slot0.init = function(slot0)
	slot0:InitData()
	slot0:InitTF()
	slot0:InitAward()
	slot0:InitCharacter()
	slot0:InitDice()
	slot0:InitVX()
end

slot0.InitTF = function(slot0)
	slot0.main = slot0:findTF(&quot;main&quot;)
	slot0.map = slot0:findTF(&quot;map&quot;, slot0.main)
	slot0.floors = {
		slot0:findTF(&quot;floor1&quot;, slot0.map),
		slot0:findTF(&quot;floor2&quot;, slot0.map)
	}
	slot0.rooms = {
		slot0:findTF(&quot;rooms&quot;, slot0.floors[1]),
		slot0:findTF(&quot;rooms&quot;, slot0.floors[2])
	}
	slot0.top = slot0:findTF(&quot;top&quot;, slot0.main)
	slot0.buttonBack = slot0:findTF(&quot;btn_back&quot;, slot0.top)
	slot0.buttonHelp = slot0:findTF(&quot;btn_help&quot;, slot0.top)
	slot0.buttonAward = slot0:findTF(&quot;btn_award&quot;, slot0.top)
	slot0.buttonCharacter = slot0:findTF(&quot;btn_character&quot;, slot0.top)
	slot0.buttonDice = slot0:findTF(&quot;btn_dice&quot;, slot0.top)
	slot0.diceRes = slot0:findTF(&quot;dice_res&quot;, slot0.buttonDice)
	slot0.button1F = slot0:findTF(&quot;btn_1F&quot;, slot0.top)
	slot0.button2F = slot0:findTF(&quot;btn_2F&quot;, slot0.top)
	slot0.window = slot0:findTF(&quot;window&quot;)
end

slot0.InitData = function(slot0)
	slot0.storyMgr = pg.NewStoryMgr.GetInstance()
	slot0.activity = getProxy(ActivityProxy):getActivityById(uv0.ACT_ID)
	slot0.story2Map = {}
	slot0.map2Story = {}
	slot0.storyGroup = {}
	slot4 = &quot;config_data&quot;

	for slot4, slot5 in ipairs(slot0.activity:getConfig(slot4)[3]) do
		table.insert(slot0.storyGroup, slot5[1][1])
		table.insert(slot0.storyGroup, slot5[2][2])
		table.insert(slot0.storyGroup, slot5[2][1])
	end

	for slot4 = 1, uv0.ROOM_NUM do
		table.insert(slot0.map2Story, {})
	end

	for slot4 = 1, #slot0.storyGroup do
		table.insert(slot0.story2Map, slot0.storyGroup[slot4], uv0.MAP_POS[slot4])
		table.insert(slot0.map2Story[uv0.MAP_POS[slot4]], slot0.storyGroup[slot4])
	end

	slot0.explorableStories = {}
	slot0.exploredStories = {}

	if slot0.activity.data1 ~= nil and slot0.activity.data1 ~= 0 then
		for slot4 = 1, #slot0.storyGroup do
			table.insert(slot0:IsPlayed(slot0.storyGroup[slot4]) and slot0.exploredStories or slot0.explorableStories, slot0.storyGroup[slot4])

			if slot0.storyGroup[slot4] == slot0.activity.data1 then
				break
			end
		end
	end

	slot0.explorablePos = slot0.activity.data1
	slot0.currentPos = #slot0.exploredStories == 0 and 0 or slot0.exploredStories[#slot0.exploredStories]
end

slot0.InitAward = function(slot0)
	slot0.awardWindow = slot0:findTF(&quot;award_window&quot;, slot0.window)
	slot0.buttonAwardGet = slot0:findTF(&quot;award_bg/btn_get&quot;, slot0.awardWindow)
	slot0.awardWindowBg = slot0:findTF(&quot;bg&quot;, slot0.awardWindow)
	slot0.awardItem = slot0:findTF(&quot;award_bg/mask/item&quot;, slot0.awardWindow)
	slot4 = slot0.awardWindow
	slot0.awardItems = slot0:findTF(&quot;award_bg/mask/content&quot;, slot4)
	slot0.awardActivity = getProxy(ActivityProxy):getActivityById(uv0.AWARD_ACT_ID)
	slot0.taskProxy = getProxy(TaskProxy)
	slot0.taskGroup = slot0.awardActivity:getConfig(&quot;config_data&quot;)
	slot0.taskList = UIItemList.New(slot0.awardItems, slot0.awardItem)
	slot0.taskMap = {}

	for slot4 = 1, #slot0.taskGroup do
		table.insert(slot0.taskMap, slot4)
	end
end

slot0.InitDice = function(slot0)
	slot0.diceWindow = slot0:findTF(&quot;dice_window&quot;, slot0.window)
	slot0.buttonDiceContinue = slot0:findTF(&quot;btn_continue&quot;, slot0.diceWindow)
	slot0.dice = slot0:findTF(&quot;dice&quot;, slot0.diceWindow)
	slot0.dices = {
		slot0:findTF(&quot;dice1&quot;, slot0.dice),
		slot0:findTF(&quot;dice2&quot;, slot0.dice)
	}
	slot0.result = slot0:findTF(&quot;result&quot;, slot0.diceWindow)
	slot0.success = slot0:findTF(&quot;success&quot;, slot0.result)
	slot0.criticalSuccess = slot0:findTF(&quot;critical_success&quot;, slot0.result)
	slot0.failure = slot0:findTF(&quot;failure&quot;, slot0.result)
	slot0.criticalFailure = slot0:findTF(&quot;critical_failure&quot;, slot0.result)
end

slot0.InitCharacter = function(slot0)
	slot0.characterWindow = slot0:findTF(&quot;character_window&quot;, slot0.window)
	slot0.characterWindowBg = slot0:findTF(&quot;bg&quot;, slot0.characterWindow)
	slot0.characterCard = slot0:findTF(&quot;character_card&quot;, slot0.characterWindowBg)
	slot0.characterName = slot0:findTF(&quot;title_base/name&quot;, slot0.characterCard)
	slot0.profession = slot0:findTF(&quot;title_base/profession&quot;, slot0.characterCard)
	slot0.nameInput = slot0:findTF(&quot;InputField&quot;, slot0.characterName)
	slot0.attrGroup = slot0:findTF(&quot;title_attr/attrGroup&quot;, slot0.characterCard)
	slot0.skillGroup = slot0:findTF(&quot;title_skill/skillGroup&quot;, slot0.characterCard)
	slot0.characterTip = slot0:findTF(&quot;tip&quot;, slot0.characterCard)

	setText(slot0.characterTip, i18n(&quot;roll_unlock&quot;))

	slot0.buttonRandom = slot0:findTF(&quot;random&quot;, slot0.characterCard)
	slot0.randomLock = slot0:findTF(&quot;lock&quot;, slot0.buttonRandom)
	slot0.randomText = slot0:findTF(&quot;Image&quot;, slot0.buttonRandom)

	setText(slot0:findTF(&quot;title_base&quot;, slot0.characterCard), i18n(&quot;roll_card_info&quot;))
	setText(slot0:findTF(&quot;title_attr&quot;, slot0.characterCard), i18n(&quot;roll_card_attr&quot;))

	slot5 = slot0.characterCard

	setText(slot0:findTF(&quot;title_skill&quot;, slot5), i18n(&quot;roll_card_skill&quot;))

	slot0.story2Attr = {}

	for slot5, slot6 in ipairs(slot0.activity:getConfig(&quot;config_client&quot;)[2]) do
		table.insert(slot0.story2Attr, slot6[1], slot6[2])
	end

	slot0.attrLock = {}
end

slot0.InitVX = function(slot0)
	for slot4, slot5 in ipairs({
		&quot;success&quot;,
		&quot;Csuccess&quot;,
		&quot;failure&quot;,
		&quot;Cfailure&quot;
	}) do
		slot6 = slot0.result:GetChild(slot4 - 1)
		slot7 = findTF(slot6, slot5)

		setLocalScale(findTF(slot6, &quot;VX/glow&quot;), {
			x = slot7.rect.width,
			y = slot7.rect.height
		})
	end
end

slot0.didEnter = function(slot0)
	for slot4 = 1, uv0.ROOM_NUM do
		slot5 = slot0:GetRoomTF(slot4)

		setText(findTF(slot5, &quot;name&quot;), i18n(&quot;roll_room_unexplored&quot;))

		slot7 = findTF(slot5, &quot;explorable&quot;)

		setImageRaycastTarget(findTF(slot5, &quot;fill&quot;), true)
		onButton(slot0, slot5, function ()
			for slot3, slot4 in ipairs(uv0.map2Story[uv1]) do
				if table.contains(uv0.explorableStories, slot4) then
					uv0:PlayStory(slot4)

					break
				end
			end
		end, SFX_PANEL)
	end

	if table.contains(slot0.explorableStories, slot0.storyGroup[15]) or table.contains(slot0.exploredStories, slot0.storyGroup[15]) then
		slot2 = nil

		for slot6 = #slot0.exploredStories, 1, -1 do
			if not slot0:IsBadEnd(slot0.exploredStories[slot6]) then
				slot2 = slot0.exploredStories[slot6]

				break
			end
		end

		slot3 = slot2 and slot0.story2Map[slot2] or 0
		slot4 = slot3 &gt; 10 and slot3 &lt; 17

		setActive(slot0.floors[1], not slot4)
		setActive(slot0.floors[2], slot4)
		setActive(slot0.button1F, not slot4)
		setActive(slot0.button2F, slot4)
	else
		setActive(slot0.button1F, false)
		setActive(slot0.button2F, false)
	end

	slot0.taskList:make(function (slot0, slot1, slot2)
		if slot0 == UIItemList.EventUpdate then
			uv0:UpdateTask(slot1, slot2)
		end
	end)
	slot0.nameInput:GetComponent(typeof(InputField)).onValueChanged:AddListener(function ()
		if not nameValidityCheck(getInputText(uv0.nameInput), 0, 40, {
			&quot;spece_illegal_tip&quot;,
			&quot;login_newPlayerScene_name_tooShort&quot;,
			&quot;ship_renameShip_error_2011&quot;,
			&quot;playerinfo_mask_word&quot;
		}) then
			setInputText(uv0.nameInput, getProxy(PlayerProxy):getData().name)
		end
	end)
	slot0:InitButton()
	slot0:UpdateFlush()

	if slot0.activity:getConfig(&quot;config_data&quot;)[1] and not slot0:IsPlayed(slot2) then
		slot0:emit(CastleMainMediator.CASTLE_ACT_OP, {
			cmd = 3,
			id = uv0.ACT_ID,
			arg1 = slot2
		})
	else
		slot0:CheckGuide()
	end
end

slot0.InitButton = function(slot0)
	onButton(slot0, slot0.button1F, function ()
		setActive(uv0.button1F, false)
		setActive(uv0.button2F, true)
		setActive(uv0.floors[2], true)
		setActive(uv0.floors[1], false)
	end, uv0.WALK_SE)
	onButton(slot0, slot0.button2F, function ()
		setActive(uv0.button2F, false)
		setActive(uv0.button1F, true)
		setActive(uv0.floors[1], true)
		setActive(uv0.floors[2], false)
	end, uv0.WALK_SE)
	onButton(slot0, slot0.buttonBack, function ()
		uv0:closeView()
	end, SFX_CANCEL)
	onButton(slot0, slot0.buttonHelp, function ()
		pg.MsgboxMgr.GetInstance():ShowMsgBox({
			type = MSGBOX_TYPE_HELP,
			helps = i18n(&quot;roll_gametip&quot;)
		})
	end, SFX_PANEL)
	onButton(slot0, slot0.buttonAward, function ()
		setActive(uv0.awardWindow, true)
		uv0:CheckAwardGet()
		uv0:ExplorableEffect(false)
	end, SFX_PANEL)
	onButton(slot0, slot0.buttonAwardGet, function ()
		if #underscore(uv0.taskGroup):chain():map(function (slot0)
			return uv0.taskProxy:getTaskVO(slot0)
		end):filter(function (slot0)
			return slot0:getTaskStatus() == 1
		end):value() &gt; 0 then
			uv0:emit(CastleMainMediator.ON_TASK_SUBMIT, slot0)
		end
	end, SFX_PANEL)
	onButton(slot0, slot0.awardWindowBg, function ()
		setActive(uv0.awardWindow, false)
		uv0:ExplorableEffect(true)
	end, SFX_CANCEL)
	onButton(slot0, slot0.buttonCharacter, function ()
		uv0:UpdateCard()
		setActive(uv0.characterWindow, true)
		pg.UIMgr.GetInstance():BlurPanel(uv0.characterCard)
	end, SFX_PANEL)
	onButton(slot0, slot0.characterWindowBg, function ()
		setActive(uv0.characterWindow, false)
		pg.UIMgr.GetInstance():UnblurPanel(uv0.characterCard, uv0.characterWindowBg)
		uv0:UpdateFlush()
		uv0:CheckGuide()
	end, SFX_CANCEL)
	onButton(slot0, slot0.buttonRandom, function ()
		if uv0:IsFinish() then
			if #getInputText(uv0.nameInput) == 0 then
				pg.TipsMgr.GetInstance():ShowTips(i18n(&quot;roll_noname&quot;))
			else
				uv0:RollCharacterCard()
			end
		end
	end, SFX_CANCEL)
	onButton(slot0, slot0.buttonDice, function ()
		if uv0.diceCount &lt; 1 then
			if table.contains(uv0.explorableStories, uv0.storyGroup[23]) or table.contains(uv0.explorableStories, uv0.storyGroup[24]) then
				pg.TipsMgr.GetInstance():ShowTips(i18n(&quot;roll_ending_tip1&quot;))
			elseif table.contains(uv0.exploredStories, uv0.storyGroup[23]) and table.contains(uv0.exploredStories, uv0.storyGroup[24]) then
				pg.TipsMgr.GetInstance():ShowTips(i18n(&quot;roll_ending_tip2&quot;))
			else
				pg.TipsMgr.GetInstance():ShowTips(i18n(&quot;roll_notimes&quot;))
			end

			return
		end

		if uv0:IndexofStory(uv0.currentPos) &lt; uv0:IndexofStory(uv0.explorablePos) then
			pg.TipsMgr.GetInstance():ShowTips(i18n(&quot;roll_tip2&quot;))

			return
		end

		uv0:emit(CastleMainMediator.CASTLE_ACT_OP, {
			cmd = 1,
			id = uv1.ACT_ID
		})
	end, SFX_PANEL)
	onButton(slot0, slot0.buttonDiceContinue, function ()
		setActive(uv0.diceWindow, false)
		uv0:UpdateFlush()
		uv0:CheckGuide()
		uv0:ExplorableEffect(true)
	end, SFX_PANEL)
end

slot0.UpdateFlush = function(slot0)
	slot0.activity = getProxy(ActivityProxy):getActivityById(uv0.ACT_ID)
	slot0.awardActivity = getProxy(ActivityProxy):getActivityById(uv0.AWARD_ACT_ID)
	slot0.taskGroup = slot0.awardActivity:getConfig(&quot;config_data&quot;)

	slot0:UpdateDice()
	slot0:UpdateMap()
	slot0:UpdateAward()
	slot0:UpdateCharacter()

	if slot0:IndexofStory(slot0.explorablePos) == 15 and slot0:IndexofStory(slot0.currentPos) &lt; slot0:IndexofStory(slot0.explorablePos) then
		setActive(slot0.button1F, true)
	end

	setActive(slot0.buttonDice, not slot0:IsFinish())
end

slot0.UpdateDice = function(slot0)
	slot0.diceCount = slot0.activity.data2

	if table.contains(slot0.explorableStories, slot0.explorablePos) and slot0:IsBadEnd(slot0.explorablePos) then
		slot0.diceCount = slot0.diceCount - 1
	end

	setText(slot0.diceRes, i18n(&quot;roll_times_left&quot;, slot0.diceCount))

	if slot0.explorablePos == slot0.currentPos and slot0.diceCount &gt; 0 then
		slot0.buttonDice:GetComponent(typeof(Animation)):Play(&quot;anim_castle_dice_tiploop&quot;)
	else
		slot0.buttonDice:GetComponent(typeof(Animation)):Stop()
	end
end

slot0.UpdateMap = function(slot0)
	for slot4 = 1, uv0.ROOM_NUM do
		slot0:ChangeRoomColor(slot4, uv0.TRANSPARENT_COLOR)
		slot0:ChangeRoomMark(slot4, nil)
	end

	for slot4, slot5 in ipairs(slot0.exploredStories) do
		slot6 = slot0.story2Map[slot5]

		setText(findTF(slot0:GetRoomTF(slot6), &quot;name&quot;), i18n(&quot;roll_room&quot; .. slot6))
	end

	setActive(findTF(slot0.main, &quot;finish_mask&quot;), false)

	if slot0:IsFinish() then
		setActive(findTF(slot0.main, &quot;finish_mask&quot;), true)

		return
	end

	for slot4, slot5 in ipairs(slot0.exploredStories) do
		slot6 = slot0.story2Map[slot5]

		if slot0:IsBadEnd(slot5) then
			if slot6 ~= 17 then
				if slot6 ~= 4 then
					slot0:ChangeRoomColor(slot6, uv0.BAD_FILL_COLOR)
				end

				slot0:ChangeRoomMark(slot6, uv0.MARK_BAD)
			end
		else
			slot0:ChangeRoomColor(slot6, uv0.NORMAL_FILL_COLOR)
		end
	end

	for slot4, slot5 in ipairs(slot0.explorableStories) do
		slot6 = slot0.story2Map[slot5]

		slot0:ChangeRoomMark(slot6, uv0.MARK_EXPLORABLE)
		slot0:ChangeRoomMark(slot6, uv0.MARK_UNEXPLORED, true)
	end

	if #slot0.exploredStories &gt; 0 then
		slot1 = nil

		for slot5, slot6 in ipairs(slot0.storyGroup) do
			if not slot0:IsBadEnd(slot6) and table.contains(slot0.exploredStories, slot6) then
				slot1 = slot6
			end
		end

		slot0:ChangeRoomMark(slot0.story2Map[slot1], uv0.MARK_CURRENT, true)
	end

	setActive(slot0.button1F:Find(&quot;Image&quot;), table.contains(slot0.explorableStories, slot0.storyGroup[24]))
	setActive(slot0.button2F:Find(&quot;Image&quot;), table.contains(slot0.explorableStories, slot0.storyGroup[23]))
end

slot0.UpdateAward = function(slot0)
	slot0:CheckAwardGet()
	table.sort(slot0.taskMap, function (slot0, slot1)
		if (uv0.taskProxy:getTaskVO(uv0.taskGroup[slot0]):getTaskStatus() == 2 and 1 or 0) == (uv0.taskProxy:getTaskVO(uv0.taskGroup[slot1]):getTaskStatus() == 2 and 1 or 0) then
			return slot0 &lt; slot1
		end

		return slot2 &lt; slot3
	end)
	slot0.taskList:align(#slot0.taskGroup)

	if not slot0:IsPlayed(slot0.storyMgr:StoryId2StoryName(slot0.activity:getConfig(&quot;config_client&quot;)[1][3])) and getProxy(TaskProxy):isReceiveTasks(slot0.taskGroup) then
		playStory(slot1)
	end
end

slot0.UpdateCharacter = function(slot0)
	setActive(slot0.randomLock, not slot0:IsFinish())
	setActive(slot0.randomText, slot0:IsFinish())

	slot0.nameInput:GetComponent(typeof(InputField)).interactable = slot0:IsFinish()

	setActive(slot0:findTF(&quot;edit&quot;, slot0.characterName), slot0:IsFinish())
end

slot0.UpdateTask = function(slot0, slot1, slot2)
	slot3 = slot0.taskMap[slot1 + 1]
	slot4 = slot0:findTF(&quot;IconTpl&quot;, slot2)
	slot5 = slot0.taskGroup[slot3]
	slot6 = slot0.taskProxy:getTaskVO(slot5)

	assert(slot6, &quot;without this task by id: &quot; .. slot5)
	setText(slot0:findTF(&quot;title&quot;, slot2), i18n(&quot;roll_reward_word&quot; .. slot3))

	slot7 = slot6:getConfig(&quot;award_display&quot;)[1]

	updateDrop(slot4, {
		type = slot7[1],
		id = slot7[2],
		count = slot7[3]
	})
	onButton(slot0, slot4, function ()
		uv0:emit(BaseUI.ON_DROP, uv1)
	end, SFX_PANEL)
	setText(slot0:findTF(&quot;progress&quot;, slot2), i18n(&quot;roll_reward_tip&quot;, slot6:getProgress(), slot6:getConfig(&quot;target_num&quot;)))
	setText(slot0:findTF(&quot;mask/Text&quot;, slot2), i18n(&quot;roll_reward_got&quot;))
	setActive(slot0:findTF(&quot;mask&quot;, slot2), slot6:isReceive())
end

slot0.UpdateAttrLock = function(slot0)
	slot0.attrLock = {}

	for slot4, slot5 in ipairs(slot0.exploredStories) do
		if slot0.story2Attr[slot5] ~= nil then
			for slot9, slot10 in ipairs(slot0.story2Attr[slot5]) do
				table.insert(slot0.attrLock, slot10)
			end
		end
	end
end

slot0.UpdateCard = function(slot0)
	slot0:UpdateAttrLock()
	setText(slot0.characterName, uv0.GetRollData(1, uv1) .. &quot;:&quot;)
	setInputText(slot0.nameInput, getProxy(PlayerProxy):getData().name)
	setText(slot0.profession, uv0.GetRollData(2, uv1) .. &quot;:&quot;)

	slot4 = 2

	setText(findTF(slot0.profession, &quot;Text&quot;), uv0.GetRollData(slot4, uv2))

	for slot4 = 1, slot0.attrGroup.childCount do
		for slot9 = 1, slot0.attrGroup:GetChild(slot4 - 1).childCount do
			slot10 = slot5:GetChild(slot9 - 1)
			slot11 = (slot9 - 1) * slot0.attrGroup.childCount + slot4 + 2

			setText(findTF(slot10, &quot;name&quot;), uv0.GetRollData(slot11, uv1))
			setText(findTF(slot10, &quot;Text&quot;), table.contains(slot0.attrLock, slot11) and uv0.GetRollData(slot11, uv2) or &quot;---&quot;)
			setActive(findTF(slot10, &quot;Text/Image&quot;), not table.contains(slot0.attrLock, slot11))
		end
	end

	for slot4 = 1, slot0.skillGroup.childCount do
		for slot9 = 1, slot0.skillGroup:GetChild(slot4 - 1).childCount do
			setText(findTF(slot5:GetChild(slot9 - 1), &quot;group/skill_name&quot;), table.contains(slot0.attrLock, (slot9 - 1) * slot0.attrGroup.childCount + slot4 + 10) and uv0.GetRollData(slot11, uv1) or &quot;&quot;)
			setText(findTF(slot10, &quot;group/Text&quot;), table.contains(slot0.attrLock, slot11) and uv0.GetColorValue(slot11, uv0.GetRollData(slot11, uv2)) or &quot;&quot;)
			setActive(findTF(slot10, &quot;Image&quot;), not table.contains(slot0.attrLock, slot11))
		end
	end
end

slot0.RollCharacterCard = function(slot0)
	for slot4 = 1, slot0.attrGroup.childCount do
		for slot9 = 1, slot0.attrGroup:GetChild(slot4 - 1).childCount do
			slot12 = uv0.GetRollData((slot9 - 1) * slot0.attrGroup.childCount + slot4 + 2, uv1)

			setText(findTF(slot5:GetChild(slot9 - 1), &quot;Text&quot;), math.random(slot12[1], slot12[2]))
		end
	end

	slot1 = uv0.GetRandomValue(i18n(&quot;roll_attr_list&quot;), 8)
	slot2 = 1

	for slot6 = 1, slot0.skillGroup.childCount do
		for slot11 = 1, slot0.skillGroup:GetChild(slot6 - 1).childCount do
			slot12 = slot7:GetChild(slot11 - 1)
			slot13 = (slot11 - 1) * slot0.attrGroup.childCount + slot6 + 10

			setText(findTF(slot12, &quot;group/skill_name&quot;), slot1[slot2])

			slot2 = slot2 + 1

			setText(findTF(slot12, &quot;group/Text&quot;), uv0.GetColorValue(slot13, uv0.GetRandomValue(uv0.GetRollData(slot13, uv1), 1)[1]))
		end
	end
end

slot0.IsFinish = function(slot0)
	return #slot0.exploredStories == 24
end

slot0.GetRandomValue = function(slot0, slot1)
	slot2 = {}

	for slot6 = 1, #slot0 do
		table.insert(slot2, slot6)
	end

	shuffle(slot2)

	slot3 = {}

	for slot7 = 1, slot1 do
		table.insert(slot3, slot0[slot2[slot7]])
	end

	return slot3
end

slot0.GetColorValue = function(slot0, slot1)
	return setColorStr(slot1, uv0.SKILL_COLOR[table.indexof(uv0.GetRollData(slot0, uv1), slot1)])
end

slot0.CheckAwardGet = function(slot0)
	slot1 = false

	for slot5, slot6 in ipairs(slot0.taskGroup) do
		if slot0.taskProxy:getTaskVO(slot6):getTaskStatus() == 1 then
			slot1 = true
		end
	end

	setActive(slot0.buttonAwardGet, slot1)
	setActive(findTF(slot0.buttonAward, &quot;red&quot;), slot1)
end

slot0.PlayStory = function(slot0, slot1)
	if slot0:IsPlayed(slot1) then
		return
	end

	slot0.waitPlayStory = slot1

	slot0:emit(CastleMainMediator.CASTLE_ACT_OP, {
		cmd = 2,
		id = uv0.ACT_ID,
		arg1 = slot1
	})
end

slot0.StoryActEnd = function(slot0, slot1)
	if not slot0.waitPlayStory then
		return
	end

	slot2 = slot0.storyMgr
	slot2, slot3 = slot2:StoryId2StoryName(slot0.waitPlayStory)

	slot4 = function()
		if uv0.story2Attr[uv0.waitPlayStory] == nil then
			return false
		end

		slot0 = 0

		for slot4, slot5 in ipairs(uv0.story2Attr[uv0.waitPlayStory]) do
			if not table.contains(uv0.attrLock, slot5) then
				slot0 = slot0 + 1
			end
		end

		return slot0 &gt; 0
	end

	playStory(slot2, function ()
		if uv0() then
			uv1:UpdateCard()
			setActive(uv1.characterWindow, true)
			pg.UIMgr.GetInstance():BlurPanel(uv1.characterCard)
			pg.CriMgr.GetInstance():PlaySoundEffect_V3(uv2.CARD_SE)

			for slot3, slot4 in ipairs(uv1.story2Attr[uv1.waitPlayStory]) do
				if slot4 &lt; 11 then
					slot5 = slot4 - 3
					slot8 = uv1.attrGroup:GetChild(slot5 % uv1.attrGroup.childCount):GetChild(math.floor(slot5 / uv1.attrGroup.childCount))

					setText(findTF(slot8, &quot;Text&quot;), uv2.GetRollData(slot4, uv3))
					findTF(slot8, &quot;Text/Image&quot;):GetComponent(typeof(Animation)):Play(&quot;anim_castle_skill&quot;)
				else
					slot5 = slot4 - 11
					slot8 = uv1.skillGroup:GetChild(slot5 % uv1.skillGroup.childCount):GetChild(math.floor(slot5 / uv1.skillGroup.childCount))

					setText(findTF(slot8, &quot;group/skill_name&quot;), uv2.GetRollData(slot4, uv4))
					setText(findTF(slot8, &quot;group/Text&quot;), uv2.GetColorValue(slot4, uv2.GetRollData(slot4, uv3)))
					findTF(slot8, &quot;Image&quot;):GetComponent(typeof(Animation)):Play(&quot;anim_castle_skill&quot;)
				end
			end

			uv1:ExploreStory(uv1.waitPlayStory)
			uv1:UnlockStory(uv5)
			uv1:UpdateAttrLock()
		else
			uv1:ExploreStory(uv1.waitPlayStory)
			uv1:UnlockStory(uv5)
			uv1:UpdateAttrLock()
			uv1:UpdateFlush()
			uv1:CheckGuide()
		end
	end)
end

slot0.FirstStory = function(slot0)
	slot1 = slot0.activity
	slot2 = slot0.storyMgr
	slot2, slot3 = slot2:StoryId2StoryName(slot1:getConfig(&quot;config_data&quot;)[1])

	playStory(slot2, function ()
		slot0 = {
			8,
			59496,
			1
		}

		uv0:UpdateFlush()
		uv0:emit(BaseUI.ON_AWARD, {
			items = {
				{
					type = slot0[1],
					id = slot0[2],
					count = slot0[3]
				}
			},
			title = AwardInfoLayer.TITLE.ITEM,
			removeFunc = function ()
				uv0:CheckGuide()
			end
		})
	end)
end

slot0.RollDice = function(slot0, slot1, slot2)
	for slot6, slot7 in ipairs({
		slot0.success,
		slot0.criticalSuccess,
		slot0.failure,
		slot0.criticalFailure
	}) do
		setActive(slot7, false)
	end

	setActive(slot0.diceWindow, true)
	setActive(slot0.buttonDiceContinue, false)
	slot0:ExplorableEffect(false)
	setImageAlpha(slot0.buttonDiceContinue, 0)

	slot0.diceNumber = slot1

	if slot1 == 100 then
		slot1 = 0
	end

	pg.CriMgr.GetInstance():PlaySoundEffect_V3(uv0.ROLL_SE)
	slot0:SetAnim(slot0.dices[1], math.floor(slot1 / 10), nil)

	slot8 = slot1 % 10

	slot9 = function()
		LeanTween.delayedCall(go(uv0._tf), 0.12, System.Action(function ()
			if uv0.diceNumber &lt;= 5 then
				setActive(uv0.criticalSuccess, true)
			elseif uv0.diceNumber &lt;= 50 then
				setActive(uv0.success, true)
			elseif uv0.diceNumber &lt;= 94 then
				setActive(uv0.failure, true)
			else
				setActive(uv0.criticalFailure, true)
			end

			setActive(uv0.buttonDiceContinue, true)
			LeanTween.delayedCall(go(uv0._tf), 0.495, System.Action(function ()
				LeanTween.alpha(uv0.buttonDiceContinue, 1, 0.26)
			end))
		end))
	end

	slot0:SetAnim(slot0.dices[2], slot8, slot9)

	slot0.explorablePos = slot2

	for slot8, slot9 in ipairs(slot0.storyGroup) do
		slot0:UnlockStory(slot9)

		if slot9 == slot2 then
			break
		end
	end
end

slot0.SetAnim = function(slot0, slot1, slot2, slot3)
	slot4 = slot1:GetComponent(typeof(SpineAnimUI))

	slot4:SetActionCallBack(nil)
	slot4:SetAction(&quot;roll&quot; .. slot2, 0)
	slot4:SetActionCallBack(function (slot0)
		if slot0 == &quot;finish&quot; then
			uv0:SetActionCallBack(nil)
			uv0:SetAction(&quot;normal&quot; .. uv1, 0)

			if uv2 then
				uv2()
			end
		end
	end)
end

slot0.UnlockStory = function(slot0, slot1)
	if table.contains(slot0.explorableStories, slot1) or table.contains(slot0.exploredStories, slot1) then
		return
	end

	table.insert(slot0.explorableStories, slot1)

	if slot0:IndexofStory(slot0.explorablePos) &lt; slot0:IndexofStory(slot1) then
		slot0.explorablePos = slot1
	end
end

slot0.ExploreStory = function(slot0, slot1)
	if table.contains(slot0.exploredStories, slot1) then
		return
	end

	if not table.contains(slot0.explorableStories, slot1) then
		return
	end

	table.removebyvalue(slot0.explorableStories, slot1)
	table.insert(slot0.exploredStories, slot1)

	if slot0:IndexofStory(slot0.currentPos) &lt; slot0:IndexofStory(slot1) then
		slot0.currentPos = slot1
	end
end

slot0.IndexofStory = function(slot0, slot1)
	if table.indexof(slot0.storyGroup, slot1) == false then
		return -1
	end

	return slot2
end

slot0.IsPlayed = function(slot0, slot1)
	slot2, slot3 = slot0.storyMgr:StoryId2StoryName(slot1)

	return slot0.storyMgr:IsPlayed(slot2, slot3)
end

slot0.IsBadEnd = function(slot0, slot1)
	return (table.indexof(slot0.storyGroup, slot1) + 1) % 3 == 0
end

slot0.ExplorableEffect = function(slot0, slot1)
	for slot5 = 1, uv0.ROOM_NUM do
		slot6 = slot0:GetRoomTF(slot5)

		setActive(findTF(slot6, &quot;explorable/glow&quot;), slot1)
		setActive(findTF(slot6, &quot;explorable/glow1&quot;), slot1)
	end
end

slot0.ChangeRoomColor = function(slot0, slot1, slot2)
	slot4 = findTF(slot0:GetRoomTF(slot1), &quot;fill&quot;)

	if slot2 then
		setImageColor(slot4, slot2)
	end
end

slot0.ChangeRoomMark = function(slot0, slot1, slot2, slot3)
	cover = cover or false
	slot4 = slot0:GetRoomTF(slot1)
	slot5 = findTF(slot4, &quot;current&quot;)
	slot6 = findTF(slot4, &quot;unexplored&quot;)
	slot7 = findTF(slot4, &quot;bad&quot;)
	slot8 = findTF(slot4, &quot;explorable&quot;)

	if not slot3 then
		for slot12, slot13 in ipairs({
			slot5,
			slot6,
			slot7,
			slot8
		}) do
			setActive(slot13, false)
		end
	end

	if slot2 then
		if slot2 == uv0.MARK_CURRENT then
			setActive(slot5, true)
		elseif slot2 == uv0.MARK_UNEXPLORED then
			setActive(slot6, true)
		elseif slot2 == uv0.MARK_BAD then
			setActive(slot7, true)
		elseif slot2 == uv0.MARK_EXPLORABLE then
			setActive(slot8, true)
		end
	end
end

slot0.GetRoomTF = function(slot0, slot1)
	if slot1 == uv0.ROOM_NUM then
		return slot0.rooms[1]:GetChild(slot0.rooms[1].childCount - 1)
	elseif slot1 &lt; slot0.rooms[1].childCount then
		return slot0.rooms[1]:GetChild(slot1 - 1)
	end

	return slot0.rooms[2]:GetChild(slot1 - slot0.rooms[1].childCount)
end

slot0.CheckGuide = function(slot0)
	slot4 = slot0.storyMgr
	slot6 = slot0.activity
	slot4 = slot0.storyMgr
	slot6 = slot0.activity
	slot4 = slot0.storyMgr
	slot5 = slot4
	slot6 = slot0.activity

	slot4 = function(slot0)
		return getProxy(TaskProxy):isReceiveTasks(slot0.taskGroup)
	end

	for slot4, slot5 in pairs({
		{
			&quot;guide&quot;,
			&quot;Castle000&quot;,
			function (slot0)
				return #slot0.exploredStories == 0
			end
		},
		{
			&quot;guide&quot;,
			&quot;Castle001&quot;,
			function (slot0)
				return #slot0.exploredStories == 1 and slot0:IndexofStory(slot0.explorablePos) &lt;= slot0:IndexofStory(slot0.currentPos)
			end
		},
		{
			&quot;story&quot;,
			slot4:StoryId2StoryName(slot6:getConfig(&quot;config_client&quot;)[1][1]),
			function (slot0)
				return #slot0.exploredStories == 1 and slot0:IndexofStory(slot0.currentPos) &lt; slot0:IndexofStory(slot0.explorablePos)
			end
		},
		{
			&quot;story&quot;,
			slot4:StoryId2StoryName(slot6:getConfig(&quot;config_client&quot;)[1][2]),
			function (slot0)
				return #slot0.exploredStories == 2 and slot0:IndexofStory(slot0.explorablePos) &lt;= slot0:IndexofStory(slot0.currentPos)
			end
		},
		{
			&quot;guide&quot;,
			&quot;Castle002&quot;,
			function (slot0)
				return slot0:IndexofStory(slot0.explorablePos) == 15 and slot0:IndexofStory(slot0.currentPos) &lt; slot0:IndexofStory(slot0.explorablePos)
			end
		},
		{
			&quot;story&quot;,
			slot4.StoryId2StoryName(slot5, slot6:getConfig(&quot;config_client&quot;)[1][3]),
			slot4
		}
	}) do
		slot6, slot7, slot8 = unpack(slot5)

		if not slot0:IsPlayed(slot7) and slot8(slot0) then
			if slot6 == &quot;guide&quot; then
				slot9 = pg.NewGuideMgr.GetInstance()

				slot9:Play(slot7, nil, function ()
					uv0:emit(CastleMainMediator.UPDATE_GUIDE, uv1)
				end)
			elseif slot6 == &quot;story&quot; then
				playStory(slot7)
			else
				assert(false)
			end

			break
		end
	end
end

slot0.PlaySE = function(slot0)
	pg.CriMgr.GetInstance():PlaySoundEffect_V3(slot0)
end

slot0.GetRollData = function(slot0, slot1)
	return pg.roll_attr[slot0][slot1]
end

slot0.willExit = function(slot0)
	if isActive(slot0.characterWindow) then
		setActive(slot0.characterWindow, false)
		pg.UIMgr.GetInstance():UnblurPanel(slot0.characterCard, slot0.characterWindowBg)
	end

	LeanTween.cancel(go(slot0._tf))
end

slot0.onBackPressed = function(slot0)
	if isActive(slot0.diceWindow) then
		return
	end

	slot0:emit(uv0.ON_BACK_PRESSED)
end

return slot0
</code></pre>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-lua.min.js"></script>
</body>
</html>