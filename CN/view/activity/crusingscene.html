<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>crusingscene.lua</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
</head>
<body>
    <h1>crusingscene.lua</h1>
    <a href="index.html">返回主页</a>
    <pre><code class="language-lua">slot0 = class(&quot;CrusingScene&quot;, import(&quot;view.base.BaseUI&quot;))
slot0.optionsPath = {
	&quot;top/home&quot;
}
slot0.FrameSpeed = 10
slot0.PlaySpeed = 1.5

slot0.getUIName = function(slot0)
	return &quot;CrusingUI&quot;
end

slot0.preload = function(slot0, slot1)
	slot2 = getProxy(ActivityProxy)
	slot2 = slot2:getAliveActivityByType(ActivityConst.ACTIVITY_TYPE_PT_CRUSING)
	slot3 = PoolMgr.GetInstance()
	slot4 = {}

	table.insert(slot4, function (slot0)
		slot2 = uv1

		slot2:GetPrefab(&quot;crusingmap/&quot; .. pg.battlepass_event_pt[uv0.id].crusing_map, &quot;&quot;, true, function (slot0)
			uv0.rtMap = tf(slot0)
			uv0.PhaseFrame, uv0.AllFrameCount = CrusingMapInfo.GetPhaseFrame(uv1)

			uv2()
		end)
	end)
	table.insert(slot4, function (slot0)
		slot1 = uv0

		slot1:GetSpineChar(pg.battlepass_event_pt[uv1.id].spine_name, true, function (slot0)
			uv0.rtModel = tf(slot0)

			uv1()
		end)
	end)
	parallelAsync(slot4, function ()
		setParent(uv0.rtModel, uv0.rtMap:Find(&quot;icon/model&quot;))

		uv0.rtModel.localScale = Vector3.one

		uv1()
	end)
end

slot0.init = function(slot0)
	slot0.rtBg = slot0._tf:Find(&quot;bg&quot;)
	slot0.scrollMap = slot0.rtBg:Find(&quot;map_scroll&quot;)
	slot0.btnTask = slot0.rtBg:Find(&quot;task_btn&quot;)
	slot0.textTip = slot0.rtBg:Find(&quot;tip&quot;)
	slot0.rtAward = slot0._tf:Find(&quot;award_panel&quot;)
	slot0.textPhase = slot0.rtAward:Find(&quot;phase/Text&quot;)
	slot0.sliderPt = slot0.rtAward:Find(&quot;Slider&quot;)
	slot0.comScroll = GetComponent(slot0.rtAward:Find(&quot;view/content&quot;), &quot;LScrollRect&quot;)

	slot0.comScroll.onUpdateItem = function(slot0, slot1)
		uv0:updateAwardInfo(tf(slot1), uv0.awardList[slot0 + 1])
	end

	slot0.rtNextAward = slot0.rtAward:Find(&quot;next&quot;)
	slot0.btnAll = slot0.rtAward:Find(&quot;btn_all&quot;)
	slot0.btnPay = slot0.rtAward:Find(&quot;btn_pay&quot;)
	slot0.btnAfter = slot0.rtAward:Find(&quot;btn_after&quot;)
	slot0.btnFinish = slot0.rtAward:Find(&quot;btn_finish&quot;)
	slot0.rtTop = slot0._tf:Find(&quot;top&quot;)
	slot0.btnBack = slot0.rtTop:Find(&quot;back&quot;)
	slot0.btnHelp = slot0.rtTop:Find(&quot;help&quot;)
	slot0.textDay = slot0.rtTop:Find(&quot;day/Text&quot;)
	slot0.chargeTipWindow = ChargeTipWindow.New(slot0._tf, slot0.event)
	slot0.LTDic = {}
end

slot0.didEnter = function(slot0)
	onButton(slot0, slot0.btnBack, function ()
		uv0:closeView()
	end, SFX_CANCEL)
	onButton(slot0, slot0.btnTask, function ()
		if uv0.phase &lt; #uv0.awardList then
			uv0:emit(CrusingMediator.EVENT_OPEN_TASK)
		else
			pg.TipsMgr.GetInstance():ShowTips(i18n(&quot;battlepass_complete&quot;))
		end
	end, SFX_PANEL)
	onButton(slot0, slot0.btnAll, function ()
		if #uv0.activity:GetCrusingUnreceiveAward() &gt; 0 then
			slot1 = {}

			if uv0:checkLimitMax(slot0) then
				table.insert(slot1, function (slot0)
					pg.MsgboxMgr.GetInstance():ShowMsgBox({
						content = i18n(&quot;player_expResource_mail_fullBag&quot;),
						onYes = slot0
					})
				end)
			end

			seriesAsync(slot1, function ()
				uv0:emit(CrusingMediator.EVENT_GET_AWARD_ALL)
			end)
		end
	end, SFX_CONFIRM)
	onButton(slot0, slot0.btnPay, function ()
		uv0:openBuyPanel()
	end, SFX_CONFIRM)
	onButton(slot0, slot0.btnAfter, function ()
		if #uv0.activity:GetCrusingUnreceiveAward() &gt; 0 then
			slot1 = {}

			if uv0:checkLimitMax(slot0) then
				table.insert(slot1, function (slot0)
					pg.MsgboxMgr.GetInstance():ShowMsgBox({
						content = i18n(&quot;player_expResource_mail_fullBag&quot;),
						onYes = slot0
					})
				end)
			end

			seriesAsync(slot1, function ()
				uv0:emit(CrusingMediator.EVENT_GET_AWARD_ALL)
			end)
		end
	end, SFX_CONFIRM)
	onButton(slot0, slot0.btnHelp, function ()
		pg.MsgboxMgr.GetInstance():ShowMsgBox({
			type = MSGBOX_TYPE_HELP,
			helps = i18n(&quot;battlepass_main_help_&quot; .. pg.battlepass_event_pt[uv0.activity.id].map_name)
		})
	end, SFX_PANEL)

	slot0.maps = {
		(function (slot0)
			slot1 = {
				_tf = slot0,
				rtLine = slot0:Find(&quot;line&quot;),
				rtIcon = slot0:Find(&quot;icon&quot;),
				rtSimple = slot0:Find(&quot;simple&quot;)
			}

			setParent(slot0, uv0.scrollMap)
			SetCompomentEnabled(slot0, typeof(Image), false)

			slot0.name = &quot;map_tpl&quot;

			SetAction(slot1.rtIcon:Find(&quot;model&quot;):GetChild(0), &quot;normal&quot;)

			return slot1
		end)(slot0.rtMap)
	}

	while #slot0.maps &lt; 3 do
		table.insert(slot0.maps, slot1(tf(Instantiate(slot0.rtMap))))
	end

	Canvas.ForceUpdateCanvases()

	for slot5, slot6 in ipairs(slot0.maps) do
		setParent(slot6.rtLine, slot0.scrollMap:Find(&quot;bg&quot;), true)
	end

	GetComponent(slot0.textTip, &quot;RichText&quot;):AddSprite(&quot;pt&quot;, GetSpriteFromAtlas(Drop.New({
		type = DROP_TYPE_VITEM,
		id = slot0.ptId
	}):getIcon(), &quot;&quot;))
	setText(slot0.textTip, i18n(&quot;battlepass_main_tip_&quot; .. pg.battlepass_event_pt[slot0.activity.id].map_name))

	slot2 = slot0.activity.stopTime - pg.TimeMgr.GetInstance():GetServerTime()

	setText(slot0.textDay, i18n(&quot;battlepass_main_time&quot;, math.floor(slot2 / 86400), math.floor(slot2 % 86400 / 3600)))

	slot3 = GetComponent(slot0.scrollMap, typeof(ScrollRect))
	slot4 = slot3.content.rect.width
	slot7 = slot4 / 3 / (slot4 - slot3.viewport.rect.width)

	onScroll(slot0, slot0.scrollMap, function (slot0)
		if slot0.x &lt; 0.1 then
			slot2 = uv0.normalizedPosition
			slot2.x = slot0.x + uv1
			uv0.normalizedPosition = slot2
			uv0.velocity = uv0.velocity
		elseif slot0.x &gt; 0.9 then
			slot2 = uv0.normalizedPosition
			slot2.x = slot0.x - uv1
			uv0.normalizedPosition = slot2
			uv0.velocity = uv0.velocity
		end
	end)
	slot0:onScroll(slot0.comScroll, function (slot0)
		uv0:updateNextAward(slot0.y)
	end)
	slot0:updateAwardPanel()
	slot0:buildPhaseAwardScrollPos()

	if slot0.phase == 0 then
		slot0.comScroll:ScrollTo(0)
	elseif slot0.phase == #slot0.awardList then
		slot0.comScroll:ScrollTo(1)
	else
		slot0.comScroll:ScrollTo(math.clamp(slot0.phasePos[slot0.phase], 0, 1))
	end

	slot0:updateMapStatus()
	LoadImageSpriteAtlasAsync(Drop.New({
		type = DROP_TYPE_VITEM,
		id = slot0.ptId
	}):getIcon(), &quot;&quot;, slot0.sliderPt:Find(&quot;Text/icon&quot;), true)
	slot0:updateMapWay()
end

slot0.willExit = function(slot0)
	for slot4, slot5 in pairs(slot0.LTDic) do
		if slot5 then
			LeanTween.cancel(slot4)
		end
	end

	slot1 = PoolMgr.GetInstance()
	slot2 = pg.battlepass_event_pt[slot0.activity.id].crusing_map
	slot3 = pg.battlepass_event_pt[slot0.activity.id].spine_name

	for slot7, slot8 in ipairs(slot0.maps) do
		setParent(slot8.rtLine, slot8._tf, true)
		slot1:ReturnSpineChar(slot3, go(slot8.rtIcon:Find(&quot;model&quot;):GetChild(0)))
		slot1:ReturnPrefab(&quot;crusingmap/&quot; .. slot2, &quot;&quot;, go(slot8._tf))
	end

	if slot0.chargeTipWindow then
		slot0.chargeTipWindow:Destroy()

		slot0.chargeTipWindow = nil
	end
end

slot0.setActivity = function(slot0, slot1)
	slot0.activity = slot1

	for slot5, slot6 in pairs(slot1:GetCrusingInfo()) do
		slot0[slot5] = slot6
	end
end

slot0.setPlayer = function(slot0, slot1)
	slot0.player = slot1
end

slot0.updateAwardInfo = function(slot0, slot1, slot2)
	slot3 = slot2.pt &lt;= slot0.pt

	if slot1:Find(&quot;mask&quot;) then
		setActive(slot1:Find(&quot;mask&quot;), not slot3)
	end

	setText(slot1:Find(&quot;Text&quot;), slot2.id)
	updateDrop(slot1:Find(&quot;award&quot;), Drop.Create(slot2.award))
	setActive(slot1:Find(&quot;award/get&quot;), slot3 and not slot0.awardDic[slot2.pt])
	setActive(slot1:Find(&quot;award/got&quot;), slot0.awardDic[slot2.pt])
	setActive(slot1:Find(&quot;award/mask&quot;), slot0.awardDic[slot2.pt])
	onButton(slot0, slot1:Find(&quot;award&quot;), function ()
		uv0:emit(uv1.ON_DROP, uv2)
	end, SFX_CONFIRM)
	updateDrop(slot1:Find(&quot;award_pay&quot;), Drop.Create(slot2.award_pay))
	setActive(slot1:Find(&quot;award_pay/lock&quot;), not slot0.isPay)
	setActive(slot1:Find(&quot;award_pay/get&quot;), slot0.isPay and slot3 and not slot0.awardPayDic[slot2.pt])
	setActive(slot1:Find(&quot;award_pay/got&quot;), slot0.awardPayDic[slot2.pt])
	setActive(slot1:Find(&quot;award_pay/mask&quot;), not slot0.isPay or slot0.awardPayDic[slot2.pt])
	onButton(slot0, slot1:Find(&quot;award_pay&quot;), function ()
		uv0:emit(uv1.ON_DROP, uv2)
	end, SFX_CONFIRM)
end

slot0.updateAwardPanel = function(slot0)
	setText(slot0.textPhase, slot0.phase)

	if slot0.phase &lt; #slot0.awardList then
		slot1 = slot0.phase == 0 and 0 or slot0.awardList[slot0.phase].pt
		slot2 = slot0.pt - slot1
		slot3 = slot0.awardList[slot0.phase + 1].pt - slot1

		setSlider(slot0.sliderPt, 0, slot3, slot2)
		setText(slot0.sliderPt:Find(&quot;Text&quot;), slot2 .. &quot;/&quot; .. slot3)
	else
		setSlider(slot0.sliderPt, 0, 1, 1)
		setText(slot0.sliderPt:Find(&quot;Text&quot;), &quot;MAX&quot;)
	end

	slot0.nextAward = nil

	slot0.comScroll:SetTotalCount(#slot0.awardList - 1)
	slot0:updateNextAward(slot0.comScroll.value)

	slot1 = #slot0.activity:GetCrusingUnreceiveAward() &gt; 0

	setActive(slot0.btnAll, not slot0.isPay and slot1)
	setActive(slot0.btnPay, not slot0.isPay)
	setActive(slot0.rtAward:Find(&quot;text_image_3&quot;), not slot0.isPay)
	setActive(slot0.btnFinish, slot0.isPay and slot0.phase == #slot0.awardList and not slot1)
	setActive(slot0.btnAfter, slot0.isPay and not isActive(slot0.btnFinish))
	setButtonEnabled(slot0.btnAfter, slot1)
end

slot0.updateMapStatus = function(slot0)
	for slot4, slot5 in ipairs(slot0.maps) do
		slot6 = nil
		slot7 = {}

		eachChild(slot5.rtLine, function (slot0)
			if uv0.phase &lt; tonumber(slot0.name) then
				if not uv1 then
					uv1 = slot1

					table.insert(uv2, slot0)
					setActive(slot0, true)
				elseif slot1 &lt; uv1 then
					while #uv2 &gt; 0 do
						setActive(table.remove(uv2), false)
					end

					uv1 = slot1

					table.insert(uv2, slot0)
					setActive(slot0, true)
				elseif uv1 == slot1 then
					table.insert(uv2, slot0)
					setActive(slot0, true)
				else
					setActive(slot0, false)
				end
			else
				setActive(slot0, true)
			end

			slot2 = uv0.phase &lt; slot1

			setGray(slot0, not slot2, false)
			setImageAlpha(slot0, slot2 and 1 or 0.9)

			if isActive(slot0) then
				slot3 = nil

				slot3 = function(slot0, slot1)
					if getImageSprite(slot0) then
						setImageSprite(slot1, slot2)
					end

					eachChild(slot0, function (slot0)
						uv0(slot0, uv1:Find(slot0.name))
					end)
				end

				slot4 = uv3.rtSimple
				slot4 = slot4:Find(slot2 and &quot;active&quot; or &quot;gray&quot;)

				eachChild(slot0, function (slot0)
					uv0(uv1:Find(slot0.name), slot0)
				end)
			end
		end)
	end
end

slot0.updateMapWay = function(slot0)
	if slot0.exited or slot0.contextData.frozenMapUpdate then
		return
	end

	slot1 = PlayerPrefs.GetInt(string.format(&quot;crusing_%d_phase_display&quot;, slot0.activity.id), 0)
	slot5 = slot0.activity.id

	PlayerPrefs.SetInt(string.format(&quot;crusing_%d_phase_display&quot;, slot5), slot0.phase)

	for slot5, slot6 in ipairs(slot0.maps) do
		slot7 = GetComponent(slot6.rtIcon, typeof(Animator))

		if slot1 &lt; slot0.phase then
			slot9 = slot0.PhaseFrame[slot0.phase]
			slot7.speed = uv0.PlaySpeed

			slot7:Play(&quot;empty&quot;)
			slot7:Play(&quot;mix&quot;, 0, slot0.PhaseFrame[slot1] / slot0.AllFrameCount)

			if slot6.rtIcon:Find(&quot;model&quot;).childCount &gt; 0 then
				SetAction(slot6.rtIcon:Find(&quot;model&quot;):GetChild(0), &quot;move&quot;)
			end

			slot10 = nil
			slot0.LTDic[LeanTween.delayedCall((slot9 - slot8) / uv0.FrameSpeed / uv0.PlaySpeed, System.Action(function ()
				uv0.speed = 0

				uv0:Play(&quot;empty&quot;)
				uv0:Play(&quot;mix&quot;, 0, uv1 / uv2.AllFrameCount)

				uv2.LTDic[uv3] = false

				if uv4.rtIcon:Find(&quot;model&quot;).childCount &gt; 0 then
					SetAction(uv4.rtIcon:Find(&quot;model&quot;):GetChild(0), &quot;normal&quot;)
				end
			end)).uniqueId] = true
		else
			slot7.speed = 0

			slot7:Play(&quot;empty&quot;)
			slot7:Play(&quot;mix&quot;, 0, slot0.PhaseFrame[slot0.phase] / slot0.AllFrameCount)
		end
	end
end

slot0.buildPhaseAwardScrollPos = function(slot0)
	slot0.phasePos = {}

	for slot4 = 1, #slot0.awardList - 1 do
		table.insert(slot0.phasePos, slot0.comScroll:HeadIndexToValue(slot4 - 1))
	end
end

slot0.onScroll = function(slot0, slot1, slot2)
	slot3 = slot1.onValueChanged

	assert(slot2, &quot;callback should exist&quot;)
	slot3:RemoveAllListeners()
	pg.DelegateInfo.Add(slot0, slot3)
	slot3:AddListener(slot2)
end

slot0.updateNextAward = function(slot0, slot1)
	if not slot0.phasePos then
		return
	end

	slot2 = slot0.phasePos[#slot0.phasePos] - 1

	for slot7 = #slot0.awardList - 1, 1, -1 do
		slot8 = slot0.awardList[slot7]

		if slot0.phasePos[slot7] &lt; slot1 + slot2 or slot8.pt &lt;= slot0.pt then
			break
		elseif slot8.isImportent then
			slot3 = slot7
		end
	end

	if slot0.nextAward ~= slot3 then
		slot0.nextAward = slot3

		slot0:updateAwardInfo(slot0.rtNextAward, slot0.awardList[slot3])
	end
end

slot0.checkLimitMax = function(slot0, slot1)
	slot2 = slot0.player

	for slot6, slot7 in ipairs(slot1) do
		if slot7.type == DROP_TYPE_RESOURCE then
			if slot7.id == 1 then
				if slot2:GoldMax(slot7.count) then
					pg.TipsMgr.GetInstance():ShowTips(i18n(&quot;gold_max_tip_title&quot;))

					return true
				end
			elseif slot7.id == 2 and slot2:OilMax(slot7.count) then
				pg.TipsMgr.GetInstance():ShowTips(i18n(&quot;oil_max_tip_title&quot;))

				return true
			end
		elseif slot7.type == DROP_TYPE_ITEM and Item.getConfigData(slot7.id).type == Item.EXP_BOOK_TYPE and slot8.max_num &lt; getProxy(BagProxy):getItemCountById(slot7.id) + slot7.count then
			return true
		end
	end

	return false
end

slot0.openBuyPanel = function(slot0)
	slot2 = Goods.Create({
		shop_id = slot0:getPassID()
	}, Goods.TYPE_CHARGE)

	slot0:emit(CrusingMediator.EVENT_GO_CHARGE, {
		isChargeType = true,
		infoTip = slot2:GetInfoTip(),
		icon = &quot;chargeicon/&quot; .. slot2:getConfig(&quot;picture&quot;),
		name = slot2:getConfig(&quot;name_display&quot;),
		tipExtra = i18n(&quot;battlepass_pay_tip&quot;),
		extraItems = slot2:GetExtraServiceItem(),
		price = slot2:getConfig(&quot;money&quot;),
		isLocalPrice = slot2:IsLocalPrice(),
		tagType = slot2:getConfig(&quot;tag&quot;),
		isMonthCard = slot2:isMonthCard(),
		tipBonus = nil,
		bonusItem = nil,
		extraDrop = slot2:GetExtraDrop(),
		descExtra = slot2:getConfig(&quot;descrip_extra&quot;),
		onYes = function ()
			if ChargeConst.isNeedSetBirth() then
				uv0:emit(CrusingMediator.EVENT_OPEN_BIRTHDAY)
			else
				pg.m02:sendNotification(GAME.CHARGE_OPERATION, {
					shopId = uv1.id
				})
			end
		end
	})
end

slot0.getPassID = function(slot0)
	if getProxy(ActivityProxy):getActivityByType(ActivityConst.ACTIVITY_TYPE_PT_CRUSING) and not slot2:isEnd() then
		for slot6, slot7 in ipairs(pg.pay_data_display.all) do
			if pg.pay_data_display[slot7].sub_display and type(slot8.sub_display) == &quot;table&quot; and slot8.sub_display[1] == slot2.id then
				return slot7
			end
		end
	end
end

slot0.OnChargeSuccess = function(slot0, slot1)
	slot0.chargeTipWindow:ExecuteAction(&quot;Show&quot;, slot1)
end

return slot0
</code></pre>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-lua.min.js"></script>
</body>
</html>