<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>musicfestivalscene.lua</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
</head>
<body>
    <h1>musicfestivalscene.lua</h1>
    <a href="index.html">返回主页</a>
    <pre><code class="language-lua">slot0 = class(&quot;MusicFestivalScene&quot;, import(&quot;view.base.BaseUI&quot;))

slot0.getUIName = function(slot0)
	return &quot;MusicFestivalUI&quot;
end

slot0.HUB_ID = 2

slot0.init = function(slot0)
	slot0.top = slot0:findTF(&quot;top&quot;)
	slot0._closeBtn = slot0:findTF(&quot;top/back&quot;)
	slot0._helpBtn = slot0:findTF(&quot;top/help&quot;)
	slot0.btn_actskin = slot0.top:Find(&quot;idol_jump&quot;)
	slot0.btn_ins = slot0.top:Find(&quot;ins_jump&quot;)
	slot0._map = slot0:findTF(&quot;scrollRect/map&quot;)
	slot0.stage = slot0._map:Find(&quot;stage&quot;)
	slot0.screen = slot0._map:Find(&quot;screen&quot;)
	slot0.shop = slot0._map:Find(&quot;shop&quot;)
	slot0.painting = slot0._map:Find(&quot;painting&quot;)
	slot0.cube = slot0._map:Find(&quot;cube&quot;)
	slot0.foutain = slot0._map:Find(&quot;foutain&quot;)
	slot0.door = slot0._map:Find(&quot;door&quot;)
	slot0.bottom = slot0._map:Find(&quot;bottom&quot;)
	slot0.front = slot0._map:Find(&quot;front&quot;)
	slot0._shipTpl = slot0._map:Find(&quot;ship&quot;)
	slot0._xiefei = slot0._map:Find(&quot;model/xiefei&quot;)
	slot0._modeltip = slot0._xiefei:Find(&quot;tip&quot;)
	slot0._stageShip = slot0._map:Find(&quot;stageship&quot;)

	setActive(slot0._modeltip, false)

	slot0.graphPath = GraphPath.New(import(&quot;GameCfg/BackHillGraphs/MusicFestivalGraph&quot;))
	slot0._loadingRequest = {}
	slot0._ReturnRequest = {}
	slot1 = &quot;ouxiangxiaoditu&quot;

	table.insert(slot0._loadingRequest, LoadPrefabRequestPackage.New(&quot;ui/&quot; .. slot1, slot1, function (slot0)
		setParent(slot0, uv0._map)

		slot2 = GameObject.Find(&quot;UICamera/Canvas&quot;):GetComponent(typeof(Canvas)).sortingOrder

		for slot7, slot8 in ipairs(slot0:GetComponentsInChildren(typeof(Renderer)):ToTable()) do
			slot8.sortingOrder = slot2 + 1
		end
	end):Start())
end

slot0.didEnter = function(slot0)
	onButton(slot0, slot0._closeBtn, function ()
		uv0:emit(uv1.ON_BACK)
	end)
	onButton(slot0, slot0._helpBtn, function ()
		pg.MsgboxMgr.GetInstance():ShowMsgBox({
			type = MSGBOX_TYPE_HELP,
			helps = pg.gametip.music_main.tip
		})
	end)
	onButton(slot0, slot0.btn_actskin, function ()
		uv0:emit(MusicFestivalMediator.GO_SCENE, SCENE.ACTIVITY, {
			id = ActivityConst.MUSIC_CHUIXUE7DAY_ID
		})
	end)
	onButton(slot0, slot0.btn_ins, function ()
		uv0:emit(MusicFestivalMediator.GO_SUBLAYER, Context.New({
			viewComponent = InstagramLayer,
			mediator = InstagramMediator,
			data = {
				id = ActivityConst.IDOL_INS_ID
			}
		}))
	end)
	onButton(slot0, slot0._xiefei, function ()
		uv0:emit(MusicFestivalMediator.GO_SCENE, SCENE.ACTIVITY, {
			id = ActivityConst.MUSIC_FESTIVAL_ID
		})
	end)
	slot0:InitFacility(slot0.stage, function ()
		pg.m02:sendNotification(GAME.GO_MINI_GAME, 6)
	end)
	slot0:InitFacility(slot0.screen, function ()
		uv0:emit(MusicFestivalMediator.GO_SCENE, SCENE.ACTIVITY, {
			id = ActivityConst.IDOL_PT_ID
		})
	end)
	slot0:InitFacility(slot0.shop, function ()
		uv0:emit(MusicFestivalMediator.GO_SCENE, SCENE.SHOP, {
			warp = NewShopsScene.TYPE_ACTIVITY
		})
	end)
	slot0:InitFacility(slot0.painting, function ()
		uv0:emit(MusicFestivalMediator.GO_SCENE, SCENE.SKINSHOP)
	end)
	slot0:InitFacility(slot0.cube, function ()
		uv0:emit(MusicFestivalMediator.GO_SCENE, SCENE.GETBOAT, {
			projectName = &quot;new&quot;,
			page = 1
		})
	end)
	slot0:InitFacility(slot0.foutain, function ()
		uv0:emit(MusicFestivalMediator.GO_SUBLAYER, Context.New({
			mediator = IdolMedalCollectionMediator,
			viewComponent = IdolMedalCollectionView,
			data = {},
			onRemoved = function ()
				setActive(uv0._tf, true)
			end
		}), function ()
			setActive(uv0._tf, false)
		end)
	end)
	slot0:InitFacility(slot0.door, function ()
		slot1, slot2 = getProxy(ChapterProxy):getLastMapForActivity()

		if not slot1 or not slot0:getMapById(slot1):isUnlock() then
			pg.TipsMgr.GetInstance():ShowTips(i18n(&quot;common_activity_end&quot;))
		else
			uv0:emit(MusicFestivalMediator.GO_SCENE, SCENE.LEVEL, {
				chapterId = slot2,
				mapIdx = slot1
			})
		end
	end)

	slot0.academyStudents = {}

	slot0:InitAreaTransFunc()
	slot0:updateStudents()
	slot0:updateStageShip()
	slot0:UpdateView()
end

slot0.UpdateView = function(slot0)
	slot3 = nil

	if getProxy(ActivityProxy):getActivityById(ActivityConst.MUSIC_FESTIVAL_ID) and not slot2:isEnd() then
		slot3 = slot2:readyToAchieve()
	end

	setActive(slot0._modeltip, slot3)
	setActive(slot0.btn_actskin:Find(&quot;tip&quot;), slot1:getActivityById(ActivityConst.MUSIC_CHUIXUE7DAY_ID) and not slot5:isEnd() and slot5:readyToAchieve())
	setActive(slot0.btn_ins:Find(&quot;tip&quot;), getProxy(InstagramProxy):ShouldShowTip())
	setActive(slot0.screen:Find(&quot;tip&quot;), IdolPTPage.NeedTip())
	setActive(slot0.foutain:Find(&quot;tip&quot;), uv0.MedalTip())
	setActive(slot0.stage:Find(&quot;tip&quot;), getProxy(MiniGameProxy):GetHubByHubId(slot0.HUB_ID).count &gt; 0)
end

slot0.InitFacility = function(slot0, slot1, slot2)
	onButton(slot0, slot1, slot2)
	onButton(slot0, slot1:Find(&quot;button&quot;), slot2)
end

slot0.getStudents = function(slot0)
	slot1 = {}

	if not getProxy(ActivityProxy):getActivityById(ActivityConst.MUSIC_FESTIVAL_ID) then
		return slot1
	end

	if slot3:getConfig(&quot;config_client&quot;) and slot4.stage_off_ship then
		slot5 = 0
		slot6 = #Clone(slot4)

		while slot5 &lt; 3 and slot6 &gt; 0 do
			slot7 = math.random(1, slot6)

			table.insert(slot1, slot4[slot7])

			slot4[slot7] = slot4[slot6]
			slot6 = slot6 - 1
			slot5 = slot5 + 1
		end
	end

	return slot1
end

slot0.InitAreaTransFunc = function(slot0)
	slot0.edge2area = {
		[&quot;1_2&quot;] = slot0.bottom,
		[&quot;2_3&quot;] = slot0.bottom,
		[&quot;3_4&quot;] = slot0.bottom
	}
end

slot0.updateStudents = function(slot0)
	for slot5, slot6 in pairs(slot0:getStudents()) do
		if not slot0.academyStudents[slot5] then
			slot7 = cloneTplTo(slot0._shipTpl, slot0._map)
			slot7.gameObject.name = slot5
			slot8 = SummerFeastNavigationAgent.New(slot7.gameObject)

			slot8:attach()
			slot8:setPathFinder(slot0.graphPath)
			slot8:SetOnTransEdge(function (slot0, slot1, slot2)
				slot0._tf:SetParent(uv0.edge2area[math.min(slot1, slot2) .. &quot;_&quot; .. math.max(slot1, slot2)] or uv0.front)
			end)
			slot8:updateStudent(slot6)

			slot0.academyStudents[slot5] = slot8
		end
	end

	if #slot1 &gt; 0 then
		slot0.sortTimer = Timer.New(function ()
			uv0:sortStudents()
		end, 0.2, -1)

		slot0.sortTimer:Start()
		slot0.sortTimer.func()
	end
end

slot0.getStageShip = function(slot0)
	if not getProxy(ActivityProxy):getActivityById(ActivityConst.MUSIC_FESTIVAL_ID) then
		return
	end

	if slot2:getConfig(&quot;config_client&quot;) and slot3.stage_on_ship then
		return slot4[math.random(1, #slot4)], slot4.action[1]
	end
end

slot0.updateStageShip = function(slot0)
	slot1, slot2 = slot0:getStageShip()

	if slot1 then
		slot0._loadingRequest[slot1] = GetSpineRequestPackage.New(slot1, function (slot0)
			slot0.transform.localScale = Vector3(0.5, 0.5, 1)
			slot0.transform.localPosition = Vector3.zero

			slot0.transform:SetParent(uv0._stageShip, false)
			slot0.transform:SetSiblingIndex(1)
			setActive(uv0._stageShip, true)
			slot0:GetComponent(typeof(SpineAnimUI)):SetAction(uv1, 0)

			uv0._loadingRequest[uv2] = nil
			uv0._ReturnRequest[uv2] = ReturnSpineRequestPackage.New(uv2, slot0)
		end):Start()
	end
end

slot0.sortStudents = function(slot0)
	for slot5, slot6 in pairs({
		slot0.front,
		slot0.middle,
		slot0.bottom
	}) do
		if slot6.childCount &gt; 1 then
			slot7 = {}

			for slot11 = 1, slot6.childCount do
				table.insert(slot7, {
					tf = slot6:GetChild(slot11 - 1),
					index = slot11
				})
			end

			table.sort(slot7, function (slot0, slot1)
				if math.abs(slot0.tf.anchoredPosition.y - slot1.tf.anchoredPosition.y) &lt; 1 then
					return slot0.index &lt; slot1.index
				else
					return slot2 &gt; 0
				end
			end)

			for slot11, slot12 in ipairs(slot7) do
				slot12.tf:SetSiblingIndex(slot11 - 1)
			end
		end
	end
end

slot0.clearStudents = function(slot0)
	if slot0.sortTimer then
		slot0.sortTimer:Stop()

		slot0.sortTimer = nil
	end

	for slot4, slot5 in pairs(slot0.academyStudents) do
		slot5:detach()
		Destroy(slot5._go)
	end

	slot0.academyStudents = {}
end

slot0.TryPlayStory = function(slot0)
	if &quot;TIANHOUYUYI2&quot; then
		pg.NewStoryMgr.GetInstance():Play(slot1)
	end
end

slot0.MedalTip = function()
	return Activity.IsActivityReady(getProxy(ActivityProxy):getActivityByType(ActivityConst.ACTIVITY_TYPE_PUZZLA))
end

slot0.willExit = function(slot0)
	slot0:clearStudents()

	for slot4, slot5 in pairs(slot0._loadingRequest) do
		slot5:Stop()
	end

	table.clear(slot0._loadingRequest)

	for slot4, slot5 in pairs(slot0._ReturnRequest) do
		slot5()
	end

	table.clear(slot0._ReturnRequest)
end

return slot0
</code></pre>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-lua.min.js"></script>
</body>
</html>