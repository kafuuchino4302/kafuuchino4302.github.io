<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>anniversaryislandcomposite2023scene.lua</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
</head>
<body>
    <h1>anniversaryislandcomposite2023scene.lua</h1>
    <a href="index.html">返回主页</a>
    <pre><code class="language-lua">slot0 = class(&quot;AnniversaryIslandComposite2023Scene&quot;, import(&quot;view.base.BaseUI&quot;))
slot0.FilterAll = bit.bor(1, 2)

slot0.Ctor = function(slot0)
	uv0.super.Ctor(slot0)

	slot0.loader = AutoLoader.New()
end

slot0.getUIName = function(slot0)
	return &quot;AnniversaryIslandComposite2023UI&quot;
end

slot1 = &quot;ui/AnniversaryIslandComposite2023UI_atlas&quot;
slot2 = &quot;ui/AtelierCommonUI_atlas&quot;

slot0.preload = function(slot0, slot1)
	table.ParallelIpairsAsync({
		uv0,
		uv1
	}, function (slot0, slot1, slot2)
		uv0.loader:LoadBundle(slot1, slot2)
	end, slot1)
end

slot0.init = function(slot0)
	slot0.layerFormulaList = slot0._tf:Find(&quot;Panel/FormulaList&quot;)
	slot0.layerFormulaDetail = slot0._tf:Find(&quot;Panel/FormulaDetail&quot;)
	slot0.top = slot0._tf:Find(&quot;Top&quot;)
	slot0.formulaRect = slot0.layerFormulaList:Find(&quot;ScrollView&quot;):GetComponent(&quot;LScrollRect&quot;)

	setActive(slot0.layerFormulaList:Find(&quot;Item&quot;), false)

	slot0.formulaRect.onUpdateItem = function(slot0, slot1)
		uv0:UpdateFormulaListItem(slot0 + 1, slot1)
	end

	slot0.formulaFilterButtons = _.map({
		1,
		2
	}, function (slot0)
		return uv0.layerFormulaList:Find(&quot;Tabs&quot;):GetChild(slot0 - 1)
	end)
	slot0.lastEnv = nil
	slot0.env = {}
	slot0.listeners = {}

	setText(slot0.layerFormulaList:Find(&quot;Empty&quot;), i18n(&quot;workbench_tips5&quot;))
	setText(slot0.layerFormulaList:Find(&quot;Tabs/Furniture/UnSelected/Text&quot;), i18n(&quot;word_furniture&quot;))
	setText(slot0.layerFormulaList:Find(&quot;Tabs/Furniture/Selected/Text&quot;), i18n(&quot;word_furniture&quot;))
	setText(slot0.layerFormulaList:Find(&quot;Tabs/Item/UnSelected/Text&quot;), i18n(&quot;workbench_tips7&quot;))
	setText(slot0.layerFormulaList:Find(&quot;Tabs/Item/Selected/Text&quot;), i18n(&quot;workbench_tips7&quot;))
	setText(slot0.layerFormulaList:Find(&quot;Filter/Text&quot;), i18n(&quot;workbench_tips10&quot;))
	setText(slot0.layerFormulaDetail:Find(&quot;Counters/Text&quot;), i18n(&quot;workbench_tips8&quot;))
	setText(slot0.layerFormulaDetail:Find(&quot;MaterialsBG/MaterialsTitle&quot;), i18n(&quot;workbench_tips9&quot;))
end

slot0.didEnter = function(slot0)
	slot0.contextData.filterType = slot0.contextData.filterType or uv0.FilterAll

	table.Foreach(slot0.formulaFilterButtons, function (slot0, slot1)
		onButton(uv0, slot1, function ()
			slot0 = bit.lshift(1, uv0 - 1)

			if uv1.contextData.filterType == uv2.FilterAll then
				uv1.contextData.filterType = slot0
			elseif uv1.contextData.filterType == slot0 then
				uv1.contextData.filterType = uv2.FilterAll
			else
				uv1.contextData.filterType = slot0
			end

			uv1:UpdateFilterButtons()
			uv1:FilterFormulas()
			uv1:UpdateView()
		end, SFX_PANEL)
	end)

	slot0.showOnlyComposite = PlayerPrefs.GetInt(&quot;workbench_show_composite_avaliable&quot;, 0) == 1

	triggerToggle(slot0.layerFormulaList:Find(&quot;Filter/Toggle&quot;), slot0.showOnlyComposite)
	onToggle(slot0, slot0.layerFormulaList:Find(&quot;Filter/Toggle&quot;), function (slot0)
		uv0.showOnlyComposite = slot0

		PlayerPrefs.SetInt(&quot;workbench_show_composite_avaliable&quot;, slot0 and 1 or 0)
		PlayerPrefs.Save()
		uv0:FilterFormulas()
		uv0:UpdateView()
	end)
	onButton(slot0, slot0._tf:Find(&quot;BG&quot;), function ()
		uv0:onBackPressed()
	end)
	onButton(slot0, slot0._tf:Find(&quot;Top/Back&quot;), function ()
		uv0:onBackPressed()
	end, SFX_CANCEL)
	onButton(slot0, slot0._tf:Find(&quot;Top/Home&quot;), function ()
		uv0:quickExitFunc()
	end, SFX_CANCEL)
	onButton(slot0, slot0._tf:Find(&quot;Top/Help&quot;), function ()
		pg.MsgboxMgr.GetInstance():ShowMsgBox({
			type = MSGBOX_TYPE_HELP,
			helps = i18n(&quot;workbench_help&quot;)
		})
	end, SFX_PANEL)
	onButton(slot0, slot0._tf:Find(&quot;Top/Upgrade&quot;), function ()
		uv0:emit(AnniversaryIslandComposite2023Mediator.OPEN_UPGRADE_PANEL)
	end, SFX_PANEL)
	onButton(slot0, slot0._tf:Find(&quot;Top/StoreHouse&quot;), function ()
		uv0:emit(AnniversaryIslandComposite2023Mediator.OPEN_STOREHOUSE)
	end, SFX_PANEL)
	slot0:BindEnv({
		&quot;filterFormulas&quot;,
		&quot;formulas&quot;,
		&quot;bagAct&quot;,
		&quot;formulaId&quot;
	}, function ()
		uv0:UpdateFormulaList()
	end)
	slot0:BindEnv({
		&quot;formulaId&quot;,
		&quot;formulas&quot;,
		&quot;bagAct&quot;
	}, function (slot0, slot1)
		uv0:UpdateFormulaDetail(slot0[1])
	end)
	slot0:BindEnv({
		&quot;BuildingLv&quot;
	}, function (slot0)
		uv0.loader:GetSpriteQuiet(&quot;ui/AnniversaryIslandComposite2023UI_atlas&quot;, &quot;title_&quot; .. slot0[1], uv0.top:Find(&quot;Title/Number&quot;))
	end)
	slot0:BindEnv({
		&quot;tip&quot;
	}, function (slot0)
		setActive(uv0._tf:Find(&quot;Top/Upgrade/Tip&quot;), slot0[1])
	end)

	slot0.env.formulaId = slot0.contextData.formulaId

	slot0:UpdateFilterButtons()
	slot0:BuildActivityEnv()
	slot0:UpdateView()
end

slot0.InitCounter = function(slot0, slot1, slot2, slot3, slot4)
	slot2[2] = math.max(slot2[1], slot2[2])
	slot5 = slot1
	slot6 = slot0.layerFormulaDetail
	slot6 = slot6:Find(&quot;Counters&quot;)

	assert(slot6)
	(function ()
		slot0 = uv0

		if uv0 == 0 then
			slot0 = setColorStr(slot0, &quot;#f9c461&quot;)
		end

		setText(uv1:Find(&quot;Number&quot;), slot0)
		uv2(uv0)
	end)()
	pressPersistTrigger(slot6:Find(&quot;Plus&quot;), 0.5, function (slot0)
		uv0 = uv0 + 1
		uv0 = math.clamp(uv0, uv1[1], uv1[2])

		if uv0 == uv0 then
			pg.TipsMgr.GetInstance():ShowTips(i18n(&quot;workbench_tips3&quot;))
			slot0()

			return
		end

		uv2()
	end, nil, true, true, 0.1, SFX_PANEL)
	pressPersistTrigger(slot6:Find(&quot;Minus&quot;), 0.5, function (slot0)
		uv0 = uv0 - 1
		uv0 = math.clamp(uv0, uv1[1], uv1[2])

		if uv0 == uv0 then
			slot0()

			return
		end

		uv2()
	end, nil, true, true, 0.1, SFX_PANEL)
	onButton(slot0, slot6:Find(&quot;Plus10&quot;), function ()
		uv0 = uv0 + 10
		uv0 = math.clamp(uv0, uv1[1], uv1[2])

		if uv0 == uv0 then
			pg.TipsMgr.GetInstance():ShowTips(i18n(&quot;workbench_tips3&quot;))

			return
		end

		uv2()
	end)
	onButton(slot0, slot6:Find(&quot;Minus10&quot;), function ()
		uv0 = uv0 - 10
		uv0 = math.clamp(uv0, uv1[1], uv1[2])

		uv2()
	end)

	slot10 = slot0.layerFormulaDetail

	onButton(slot0, slot10:Find(&quot;Composite&quot;), function ()
		existCall(uv0, uv1)
	end, SFX_PANEL)
end

slot3 = {
	[DROP_TYPE_FURNITURE] = &quot;word_furniture&quot;,
	[DROP_TYPE_WORKBENCH_DROP] = &quot;workbench_tips7&quot;
}

slot0.UpdateFormulaListItem = function(slot0, slot1, slot2)
	slot3 = tf(slot2)
	slot4 = slot0.env.filterFormulas[slot1]
	slot5 = slot4:GetProduction()
	slot6 = slot3:Find(&quot;BG/Icon&quot;)

	assert(slot6)
	slot0:UpdateActivityDrop(slot6, {
		type = slot5[1],
		id = slot5[2]
	}, true)

	slot7 = uv0[slot5[1]]
	slot8 = not slot4:IsUnlock()

	setActive(slot3:Find(&quot;Lock&quot;), slot8)
	setActive(slot3:Find(&quot;BG&quot;), not slot8)

	if slot8 then
		setText(slot3:Find(&quot;Lock/Text&quot;), slot4:GetLockDesc())
	end

	setText(slot3:Find(&quot;BG/Type&quot;), i18n(slot7))
	setScrollText(slot3:Find(&quot;BG/Name/Text&quot;), slot4:GetName())
	setActive(slot3:Find(&quot;Selected&quot;), slot4:GetConfigID() == slot0.env.formulaId)
	setActive(slot3:Find(&quot;Completed&quot;), not slot4:IsAvaliable())

	slot10 = nil

	setText(slot3:Find(&quot;BG/Count&quot;), slot4:GetMaxLimit() &gt; 0 and (slot4:GetMaxLimit() - slot4:GetUsedCount() &lt;= 0 and setColorStr(slot11, &quot;#bb6754&quot;) or slot11) .. &quot;/&quot; .. slot4:GetMaxLimit() or &quot;∞&quot;)
	onButton(slot0, slot3, function ()
		if not uv0 then
			pg.TipsMgr.GetInstance():ShowTips(i18n(&quot;workbench_tips1&quot;))

			return
		end

		if uv1 then
			pg.TipsMgr.GetInstance():ShowTips(i18n(&quot;workbench_tips4&quot;, uv2:GetLockLimit() and slot0[3]))

			return
		end

		uv3.env.formulaId = uv2:GetConfigID()

		uv3:UpdateView()
	end, SFX_PANEL)
end

slot0.UpdateFilterButtons = function(slot0)
	table.Foreach(slot0.formulaFilterButtons, function (slot0, slot1)
		slot2 = uv0.contextData.filterType ~= uv1.FilterAll and bit.band(uv0.contextData.filterType, bit.lshift(1, slot0 - 1)) &gt; 0

		setActive(slot1:Find(&quot;Selected&quot;), slot2)
		setActive(slot1:Find(&quot;UnSelected&quot;), not slot2)
	end)
end

slot0.BuildActivityEnv = function(slot0)
	slot0.env.formulas = _.map(pg.activity_workbench_recipe.all, function (slot0)
		slot1 = WorkBenchFormula.New({
			configId = slot0
		})

		slot1:BuildFromActivity()

		return slot1
	end)

	if slot0.env.formulaId and (not _.detect(slot0.env.formulas, function (slot0)
		return slot0:GetConfigID() == uv0.env.formulaId
	end) or not slot1:IsAvaliable()) then
		slot0.env.formulaId = nil
	end

	slot0.env.bagAct = getProxy(ActivityProxy):getActivityByType(ActivityConst.ACTIVITY_TYPE_VIRTUAL_BAG)
	slot2 = getProxy(ActivityProxy):getActivityByType(ActivityConst.ACTIVITY_TYPE_BUILDING_BUFF_2)
	slot0.env.BuildingLv = slot2:GetBuildingLevel(table.keyof(AnniversaryIsland2023Scene.Buildings, &quot;craft&quot;))
	slot0.env.tip = AnniversaryIsland2023Scene.UpdateBuildingTip(nil, slot2, table.keyof(AnniversaryIsland2023Scene.Buildings, &quot;craft&quot;))

	slot0:FilterFormulas()
end

slot0.FilterFormulas = function(slot0)
	slot1 = {}
	slot2 = slot0.contextData.filterType

	slot3 = function(slot0)
		if uv0 == uv1.FilterAll then
			return true
		end

		return switch(slot0:GetProduction()[1], {
			[DROP_TYPE_WORKBENCH_DROP] = function ()
				return bit.band(uv0, 1) &gt; 0
			end
		}, function ()
			return bit.band(uv0, 2) &gt; 0
		end)
	end

	for slot7, slot8 in ipairs(_.values(slot0.env.formulas)) do
		if slot3(slot8) and (not slot0.showOnlyComposite or slot8:IsUnlock() and slot8:IsAvaliable() and _.all(slot8:GetMaterials(), function (slot0)
			slot1 = slot0[1]

			return slot0[3] &lt;= uv0.env.bagAct:getVitemNumber(slot0[2])
		end)) then
			table.insert(slot1, slot8)
		end
	end

	table.sort(slot1, CompareFuncs({
		function (slot0)
			return slot0:IsAvaliable() and 0 or 1
		end,
		function (slot0)
			return slot0:IsUnlock() and 0 or 1
		end,
		function (slot0)
			return slot0:GetConfigID()
		end
	}))

	slot0.env.filterFormulas = slot1
end

slot0.UpdateFormulaList = function(slot0)
	slot1 = #slot0.env.filterFormulas == 0

	setActive(slot0.layerFormulaList:Find(&quot;Empty&quot;), slot1)
	setActive(slot0.layerFormulaList:Find(&quot;ScrollView&quot;), not slot1)
	slot0.formulaRect:SetTotalCount(#slot0.env.filterFormulas)
end

slot0.UpdateFormulaDetail = function(slot0, slot1)
	slot0.contextData.formulaId = slot1

	setActive(slot0.layerFormulaDetail, slot1)

	if not slot1 then
		return
	end

	slot2 = _.detect(slot0.env.formulas, function (slot0)
		return slot0:GetConfigID() == uv0
	end)

	assert(slot2)

	slot3 = slot2:GetProduction()

	(function ()
		slot0 = {
			type = uv0[1],
			id = uv0[2],
			count = uv0[3]
		}
		slot1 = getProxy(ActivityProxy):getActivityByType(ActivityConst.ACTIVITY_TYPE_WORKBENCH)

		if uv1:GetMaxLimit() &gt; 0 then
			uv3 = slot2 - slot1:GetFormulaUseCount(uv2)
		end

		slot3 = uv4.layerFormulaDetail:Find(&quot;Icon&quot;)

		assert(slot3)
		uv4:UpdateActivityDrop(slot3, slot0)
		onButton(uv4, slot3, function ()
			if uv0.type == DROP_TYPE_WORKBENCH_DROP then
				uv1:emit(WorkBenchItemDetailMediator.SHOW_DETAIL, WorkBenchItem.New({
					configId = uv0.id,
					count = uv0.count
				}))
			else
				uv1:emit(BaseUI.ON_DROP, uv0)
			end
		end)
		setText(uv4.layerFormulaDetail:Find(&quot;Name&quot;), slot0:getConfig(&quot;name&quot;))
	end)()

	slot7 = 100
	slot8 = slot0.env.bagAct
	slot10 = slot0.layerFormulaDetail
	slot11 = slot0.layerFormulaDetail

	UIItemList.StaticAlign(slot10:Find(&quot;Materials&quot;), slot11:Find(&quot;Materials/Item&quot;), #slot2:GetMaterials(), function (slot0, slot1, slot2)
		if slot0 ~= UIItemList.EventUpdate then
			return
		end

		slot3 = uv0[slot1 + 1]

		uv1:UpdateActivityDrop(slot2:Find(&quot;Icon&quot;), {
			type = slot3[1],
			id = slot3[2],
			count = slot3[3]
		})
		onButton(uv1, slot2:Find(&quot;Icon&quot;), function ()
			if uv0.type == DROP_TYPE_WORKBENCH_DROP then
				uv1:emit(WorkBenchItemDetailMediator.SHOW_DETAIL, WorkBenchItem.New({
					configId = uv0.id,
					count = uv0.count
				}))
			else
				uv1:emit(BaseUI.ON_DROP, uv0)
			end
		end)

		slot7 = uv2:getVitemNumber(slot3[2])

		if slot3[3] &gt; 0 then
			uv3 = math.min(uv3, math.floor(slot7 / slot6))
		end
	end)

	slot9 = function(slot0)
		slot2 = uv0.layerFormulaDetail
		slot3 = uv0.layerFormulaDetail

		UIItemList.StaticAlign(slot2:Find(&quot;Materials&quot;), slot3:Find(&quot;Materials/Item&quot;), #uv1, function (slot0, slot1, slot2)
			if slot0 ~= UIItemList.EventUpdate then
				return
			end

			slot3 = uv0[slot1 + 1]
			slot6 = uv1:getVitemNumber(slot3[2])
			uv2 = math.max(uv2, 1)

			setText(slot2:Find(&quot;Text&quot;), setColorStr(slot6, slot6 &lt; slot3[3] * uv2 and &quot;#bb6754&quot; or &quot;#6b5a48&quot;) .. &quot;/&quot; .. slot7)
		end)
	end

	slot10 = math.min(1, slot7)

	slot0:InitCounter(slot10, {
		0,
		slot7
	}, slot9, function (slot0)
		uv0:emit(GAME.WORKBENCH_COMPOSITE, uv1, slot0)
	end)
	slot9(slot10)
end

slot0.BindEnv = function(slot0, slot1, slot2)
	table.insert(slot0.listeners, {
		keys = slot1,
		func = slot2
	})
end

slot0.RefreshData = function(slot0)
	slot0.lastEnv = slot0.lastEnv or {}
	slot1 = {}
	slot2 = nil

	slot3 = function(slot0, slot1)
		if uv0[slot0] then
			return
		end

		uv0[slot0] = slot1
		uv1 = uv1 or {}

		_.each(_.select(uv2.listeners, function (slot0)
			return table.contains(slot0.keys, uv0)
		end), function (slot0)
			uv0[slot0] = true
		end)
	end

	for slot7, slot8 in pairs(slot0.env) do
		if slot8 ~= slot0.lastEnv[slot7] then
			slot3(slot7, slot8)
		end
	end

	for slot7, slot8 in pairs(slot0.lastEnv) do
		if slot8 ~= slot0.env[slot7] then
			slot3(slot7, slot9)
		end
	end

	if slot2 then
		table.Foreach(slot2, function (slot0)
			slot0.func(table.map(slot0.keys, function (slot0)
				return uv0.env[slot0]
			end), table.map(slot0.keys, function (slot0)
				return uv0.lastEnv[slot0]
			end))
		end)
	end

	slot0.lastEnv = table.shallowCopy(slot0.env)
end

slot0.UpdateView = function(slot0)
	slot0:RefreshData()
	AnniversaryIsland2023Scene.PlayStory()
end

slot0.OnReceiveFormualRequest = function(slot0, slot1)
	slot0.env.formulaId = slot1

	slot0:UpdateView()
end

slot0.UpdateActivityDrop = function(slot0, slot1, slot2, slot3)
	updateDrop(slot1, slot2)
	SetCompomentEnabled(slot1:Find(&quot;icon_bg&quot;), typeof(Image), false)
	setActive(slot1:Find(&quot;bg&quot;), false)
	setActive(slot1:Find(&quot;icon_bg/frame&quot;), false)
	setActive(slot1:Find(&quot;icon_bg/stars&quot;), false)

	slot4 = slot2:getConfig(&quot;rarity&quot;)

	if slot2.type == DROP_TYPE_EQUIP or slot2.type == DROP_TYPE_EQUIPMENT_SKIN then
		slot4 = slot4 - 1
	end

	slot5 = &quot;icon_frame_&quot; .. slot4

	if slot3 then
		slot5 = slot5 .. &quot;_small&quot;
	end

	slot0.loader:GetSpriteQuiet(uv0, slot5, slot1)
end

slot0.willExit = function(slot0)
	slot0.loader:Clear()
end

return slot0
</code></pre>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-lua.min.js"></script>
</body>
</html>