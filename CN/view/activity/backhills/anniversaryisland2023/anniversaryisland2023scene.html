<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>anniversaryisland2023scene.lua</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
</head>
<body>
    <h1>anniversaryisland2023scene.lua</h1>
    <a href="index.html">返回主页</a>
    <pre><code class="language-lua">slot0 = class(&quot;AnniversaryIsland2023Scene&quot;, import(&quot;view.activity.BackHills.TemplateMV.BackHillTemplate&quot;))

slot0.getUIName = function(slot0)
	return &quot;AnniversaryIsland2023UI&quot;
end

slot0.edge2area = {
	default = &quot;_SDPlace&quot;
}
slot0.Buildings = {
	[24.0] = &quot;craft&quot;,
	[25.0] = &quot;adventure&quot;,
	[26.0] = &quot;dining&quot;,
	[23.0] = &quot;living&quot;
}

slot0.Ctor = function(slot0)
	uv0.super.Ctor(slot0)

	slot0.loader = AutoLoader.New()
end

slot0.preload = function(slot0, slot1)
	slot0.loader:LoadBundle(&quot;ui/&quot; .. slot0:getUIName() .. &quot;_level&quot; .. slot0:CalculateSceneLevel(), slot1)
end

slot0.init = function(slot0)
	slot0.top = slot0:findTF(&quot;top&quot;)
	slot0._bg = slot0:findTF(&quot;BG&quot;)
	slot0._map = slot0:findTF(&quot;map&quot;)

	for slot4 = 0, slot0._map.childCount - 1 do
		slot5 = slot0._map:GetChild(slot4)
		slot0[&quot;map_&quot; .. go(slot5).name] = slot5
	end

	slot0._upper = slot0:findTF(&quot;upper&quot;)

	for slot4 = 0, slot0._upper.childCount - 1 do
		slot5 = slot0._upper:GetChild(slot4)
		slot0[&quot;upper_&quot; .. go(slot5).name] = slot5
	end

	slot1 = slot0._tf
	slot0._SDPlace = slot1:Find(&quot;SDPlace&quot;)
	slot0.containers = {
		slot0._SDPlace
	}
	slot0._shipTpl = slot0._map:Find(&quot;ship&quot;)
	slot0.graphPath = GraphPath.New(import(&quot;GameCfg.BackHillGraphs.AnniversaryIsland2023Graph&quot;))
end

slot0.didEnter = function(slot0)
	onButton(slot0, slot0:findTF(&quot;top/Back&quot;), function ()
		uv0:onBackPressed()
	end, SFX_CANCEL)
	onButton(slot0, slot0:findTF(&quot;top/Home&quot;), function ()
		uv0:emit(uv1.ON_HOME)
	end, SFX_PANEL)
	onButton(slot0, slot0:findTF(&quot;top/Help&quot;), function ()
		pg.MsgboxMgr.GetInstance():ShowMsgBox({
			type = MSGBOX_TYPE_HELP,
			helps = pg.gametip.haidaojudian_help.tip
		})
	end, SFX_PANEL)
	slot0:InitStudents(getProxy(ActivityProxy):getActivityByType(ActivityConst.ACTIVITY_TYPE_BUILDING_BUFF_2) and slot1.id, 3, 4)

	for slot5, slot6 in pairs(slot0.Buildings) do
		slot0:InitFacilityCross(slot0._map, slot0._upper, slot6, function ()
			uv0:emit(BackHillMediatorTemplate.GO_SUBLAYER, Context.New({
				mediator = AnniversaryIslandBuildingUpgrade2023WindowMediator,
				viewComponent = AnniversaryIslandBuildingUpgrade2023Window,
				data = {
					buildingID = uv1
				}
			}))
		end)

		slot8 = slot0._map

		eachChild(slot8:Find(slot6), function (slot0)
			GetComponent(slot0, typeof(Image)).alphaHitTestMinimumThreshold = 0.5

			setActive(slot0, false)
		end)
	end

	eachChild(slot0._map:Find(&quot;xianshijianzao&quot;), function (slot0)
		GetComponent(slot0, typeof(Image)).alphaHitTestMinimumThreshold = 0.5
	end)
	eachChild(slot0._map:Find(&quot;huanzhuangshangdian&quot;), function (slot0)
		GetComponent(slot0, typeof(Image)).alphaHitTestMinimumThreshold = 0.5
	end)
	eachChild(slot0._map:Find(&quot;taskboard&quot;), function (slot0)
		GetComponent(slot0, typeof(Image)).alphaHitTestMinimumThreshold = 0.5
	end)

	GetComponent(slot0._map:Find(&quot;bigmap&quot;), typeof(Image)).alphaHitTestMinimumThreshold = 0.5

	slot0:InitFacilityCross(slot0._map, slot0._upper, &quot;craft&quot;, function ()
		uv0:emit(BackHillMediatorTemplate.GO_SCENE, SCENE.ANNIVERSARY_ISLAND_WORKBENCH)
	end)
	slot0:InitFacilityCross(slot0._map, slot0._upper, &quot;taskboard&quot;, function ()
		slot0 = Context.New()

		SCENE.SetSceneInfo(slot0, SCENE.ISLAND_TASK)
		uv0:emit(BackHillMediatorTemplate.GO_SUBLAYER, slot0)
	end)
	slot0:InitFacilityCross(slot0._map, slot0._upper, &quot;bigmap&quot;, function ()
		uv0:emit(BackHillMediatorTemplate.GO_SCENE, SCENE.ANNIVERSARY_ISLAND_SEA, {
			checkMain = true
		})
	end)
	slot0:InitFacilityCross(slot0._map, slot0._upper, &quot;giftmake&quot;, function ()
		uv0:emit(BackHillMediatorTemplate.GO_SCENE, SCENE.SCULPTURE)
	end)
	slot0:BindItemSkinShop()
	slot0:BindItemBuildShip()
	slot0:RegisterDataResponse()
	slot0:UpdateView()
end

slot0.UpdateActivity = function(slot0, slot1)
	slot0:UpdateView()
end

slot0.RegisterDataResponse = function(slot0)
	slot0.Respones = ResponsableTree.CreateShell({})

	slot0.Respones:SetRawData(&quot;view&quot;, slot0)

	for slot5, slot6 in ipairs(_.values(slot0.Buildings)) do
		slot7 = slot0.Respones

		slot7:AddRawListener({
			&quot;view&quot;,
			slot6
		}, function (slot0, slot1)
			if not slot1 then
				return
			end

			setActive(slot0[&quot;map_&quot; .. uv0]:Find(tostring(slot1)), true)

			if slot1 - 1 &gt; 0 then
				setActive(slot0[&quot;map_&quot; .. uv0]:Find(tostring(slot1 - 1)), false)
			end

			slot2 = slot0[&quot;map_&quot; .. uv0]:Find(tostring(slot1))

			slot0.loader:GetSpriteQuiet(&quot;ui/&quot; .. uv1:getUIName() .. &quot;_atlas&quot;, uv0 .. &quot;_&quot; .. slot1, slot2, true)

			GetComponent(slot0[&quot;map_&quot; .. uv0], typeof(Button)).targetGraphic = GetComponent(slot2, typeof(Image))

			if not slot0[&quot;upper_&quot; .. uv0] or IsNil(slot3:Find(&quot;Level&quot;)) then
				return
			end

			slot0.loader:GetSpriteQuiet(&quot;ui/&quot; .. uv1:getUIName() .. &quot;_atlas&quot;, tostring(slot1), slot3:Find(&quot;Level&quot;), true)
		end)
	end

	slot2 = slot0.Respones

	slot2:AddRawListener(_.values(slot0.Buildings), function (...)
		slot0 = 0
		slot1 = {
			...
		}

		for slot5 = 1, table.getCount(uv0.Buildings) do
			slot0 = slot0 + (slot1[slot5] or 1)
		end

		uv0.Respones.sceneLevel = math.floor(slot0 / 4)
	end)

	slot2 = slot0.Respones
	slot6 = {
		useOldRef = true
	}

	slot2:AddRawListener({
		&quot;sceneLevel&quot;,
		&quot;view&quot;
	}, function (slot0, slot1, slot2, slot3)
		slot4 = slot1[1]
		slot5 = slot1[2]

		slot6 = function(slot0)
			setActive(uv0[&quot;map_&quot; .. slot0]:Find(tostring(uv1)), true)

			if uv2[1] then
				setActive(uv0[&quot;map_&quot; .. slot0]:Find(tostring(uv2[1])), false)
			end

			slot2 = uv0[&quot;map_&quot; .. slot0]:Find(tostring(uv1))

			uv0.loader:GetSpriteQuiet(&quot;ui/&quot; .. uv3:getUIName() .. &quot;_level&quot; .. uv1, ({
				xianshijianzao = &quot;buildship&quot;,
				huanzhuangshangdian = &quot;skinshop&quot;,
				taskboard = &quot;taskboard&quot;
			})[slot0], slot2, true)

			GetComponent(uv0[&quot;map_&quot; .. slot0], typeof(Button)).targetGraphic = GetComponent(slot2, typeof(Image))
		end

		slot6(&quot;xianshijianzao&quot;)
		slot6(&quot;huanzhuangshangdian&quot;)
		slot6(&quot;taskboard&quot;)
		slot5.loader:GetSpriteQuiet(&quot;ui/&quot; .. uv0:getUIName() .. &quot;_atlas&quot;, &quot;title_&quot; .. slot4, slot5:findTF(&quot;top/Title/Number&quot;), true)
		slot5.loader:GetSpriteQuiet(&quot;ui/&quot; .. uv0:getUIName() .. &quot;_level&quot; .. slot4, &quot;bg&quot;, slot5:findTF(&quot;map&quot;))
	end, slot6)

	slot2 = {
		&quot;taskboard&quot;,
		&quot;bigmap&quot;,
		&quot;giftmake&quot;
	}

	table.insertto(slot2, slot1)

	for slot6, slot7 in ipairs(slot2) do
		slot8 = slot0.Respones

		slot8:AddRawListener({
			&quot;view&quot;,
			slot7 .. &quot;Tip&quot;
		}, function (slot0, slot1)
			if not slot0[&quot;upper_&quot; .. uv0] or IsNil(slot2:Find(&quot;Tip&quot;)) then
				return
			end

			setActive(slot2:Find(&quot;Tip&quot;), slot1)
		end)
	end

	slot0.Respones.hubData = {}
	slot3 = slot0.Respones

	slot3:AddRawListener({
		&quot;view&quot;,
		&quot;hubData&quot;
	}, function (slot0, slot1)
		slot0.gameCountTxt.text = &quot;X &quot; .. slot1.count
	end, {
		strict = true
	})

	slot3 = slot0.Respones

	slot3:AddRawListener({
		&quot;view&quot;,
		&quot;materialCount&quot;
	}, function (slot0, slot1)
		slot0.materialTxt.text = slot1
	end)
end

slot0.PlayStory = function()
	slot0 = getProxy(ActivityProxy)
	slot0 = slot0:getActivityByType(ActivityConst.ACTIVITY_TYPE_BUILDING_BUFF_2)
	slot1 = slot0:GetTotalBuildingLevel()

	table.SerialIpairsAsync({
		false,
		slot0:getConfig(&quot;config_client&quot;).lv2Story,
		slot0:getConfig(&quot;config_client&quot;).lv3Story,
		slot0:getConfig(&quot;config_client&quot;).lv4Story
	}, function (slot0, slot1, slot2)
		if slot0 &lt;= uv0 and slot1 then
			pg.NewStoryMgr.GetInstance():Play(slot1, slot2)
		else
			slot2()
		end
	end)
end

slot0.UpdateView = function(slot0)
	AnniversaryIsland2023Scene.PlayStory()

	slot1 = getProxy(ActivityProxy):getActivityByType(ActivityConst.ACTIVITY_TYPE_BUILDING_BUFF_2)

	for slot5, slot6 in pairs(slot0.Buildings) do
		slot0.Respones[slot6] = slot1.data1KeyValueList[2][slot5] or 1
		slot0.Respones[slot6 .. &quot;Tip&quot;] = slot0:UpdateBuildingTip(slot1, slot5)
	end

	slot0.Respones.craftTip = slot0.Respones.craftTip or getProxy(ActivityProxy):getActivityByType(ActivityConst.ACTIVITY_TYPE_WORKBENCH):HasAvaliableFormula() and getProxy(SettingsProxy):IsTipWorkbenchDaily()
	slot0.Respones.bigmapTip = tobool((function ()
		return Activity.IsActivityReady(getProxy(ActivityProxy):getActivityByType(ActivityConst.ACTIVITY_TYPE_ISLAND))
	end)())
	slot0.Respones.taskboardTip = tobool((function ()
		return getProxy(ActivityTaskProxy):getActTaskTip(ActivityConst.ISLAND_TASK_ID)
	end)())
	slot0.Respones.giftmakeTip = tobool((function ()
		return Activity.IsActivityReady(getProxy(ActivityProxy):getActivityByType(ActivityConst.ACTIVITY_TYPE_SCULPTURE))
	end)())
end

slot0.CalculateSceneLevel = function(slot0)
	return getProxy(ActivityProxy):getActivityByType(ActivityConst.ACTIVITY_TYPE_BUILDING_BUFF_2):GetTotalBuildingLevel()
end

slot0.UpdateBuildingTip = function(slot0, slot1, slot2)
	return uv0.super.UpdateBuildingTip(slot0, slot1, slot2) and slot3 and slot4 &lt;= slot1:GetTotalBuildingLevel()
end

slot0.willExit = function(slot0)
	slot0:clearStudents()
	uv0.super.willExit(slot0)
end

slot0.IsShowMainTip = function(slot0)
	if slot0 and not slot0:isEnd() then
		return (function ()
			return Activity.IsActivityReady(getProxy(ActivityProxy):getActivityByType(ActivityConst.ACTIVITY_TYPE_ISLAND))
		end)() or (function ()
			for slot4, slot5 in ipairs(getProxy(ActivityProxy):getActivityByType(ActivityConst.ACTIVITY_TYPE_BUILDING_BUFF_2):GetBuildingIds()) do
				if AnniversaryIsland2023Scene.UpdateBuildingTip(nil, slot0, slot5) then
					return true
				end
			end

			if getProxy(ActivityProxy):getActivityByType(ActivityConst.ACTIVITY_TYPE_WORKBENCH):HasAvaliableFormula() and getProxy(SettingsProxy):IsTipWorkbenchDaily() then
				return true
			end
		end)() or (function ()
			return getProxy(ActivityTaskProxy):getActTaskTip(ActivityConst.ISLAND_TASK_ID)
		end)() or (function ()
			return Activity.IsActivityReady(getProxy(ActivityProxy):getActivityByType(ActivityConst.ACTIVITY_TYPE_SCULPTURE))
		end)()
	end
end

return slot0
</code></pre>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-lua.min.js"></script>
</body>
</html>