<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>aprilfooldiscoverypage.lua</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
</head>
<body>
    <h1>aprilfooldiscoverypage.lua</h1>
    <a href="index.html">返回主页</a>
    <pre><code class="language-lua">slot0 = class(&quot;AprilFoolDiscoveryPage&quot;, import(&quot;view.base.BaseActivityPage&quot;))

slot0.OnInit = function(slot0)
	slot0.bg = slot0:findTF(&quot;AD&quot;)
	slot0.bgName = nil
	slot0.itemList = slot0:findTF(&quot;AD/list&quot;)
	slot0.items = CustomIndexLayer.Clone2Full(slot0.itemList, 9)
	slot0.selectIndex = 0
	slot0.btnHelp = slot0.bg:Find(&quot;help_btn&quot;)
	slot0.btnBattle = slot0.bg:Find(&quot;battle_btn&quot;)
	slot0.btnIncomplete = slot0.bg:Find(&quot;incomplete_btn&quot;)
	slot0.tip = slot0.bg:Find(&quot;tip&quot;)
	slot0.slider = slot0.bg:Find(&quot;slider&quot;)
	slot0.leftTime = slot0.slider:Find(&quot;time&quot;)
	slot0.loader = AutoLoader.New()
end

slot0.OnDataSetting = function(slot0)
	if slot0.activity.data1 == 0 and slot0.activity.data3 == 1 then
		slot0.activity.data3 = 0

		pg.m02:sendNotification(GAME.PUZZLE_PIECE_OP, {
			cmd = 1,
			actId = slot0.activity.id
		})

		return true
	end

	for slot4, slot5 in ipairs(slot0.activity.data1_list) do
		if not table.contains(slot0.activity.data2_list, slot5) then
			pg.m02:sendNotification(GAME.MEMORYBOOK_UNLOCK, {
				id = slot5,
				actId = slot0.activity.id
			})

			return true
		end
	end
end

slot0.OnFirstFlush = function(slot0)
	slot1 = pg.activity_event_picturepuzzle[slot0.activity.id]

	assert(slot1, &quot;Can&#x27;t Find activity_event_picturepuzzle &#x27;s ID : &quot; .. slot0.activity.id)

	slot0.puzzleConfig = slot1
	slot0.keyList = Clone(slot1.pickup_picturepuzzle)

	table.insertto(slot0.keyList, slot1.drop_picturepuzzle)
	assert(#slot0.keyList == #slot0.items, string.format(&quot;keyList has {0}, but items has 9&quot;, #slot0.keyList))
	table.sort(slot0.keyList)
	onButton(slot0, slot0.btnHelp, function ()
		pg.MsgboxMgr.GetInstance():ShowMsgBox({
			type = MSGBOX_TYPE_HELP,
			helps = pg.gametip.bulin_help.tip
		})
	end, SFX_PANEL)

	slot2 = slot0.activity.id

	onButton(slot0, slot0.btnBattle, function ()
		if #uv0.activity.data2_list &lt; #uv0.keyList then
			pg.TipsMgr.GetInstance():ShowTips(i18n(&quot;common_activity_not_start&quot;))

			return
		end

		uv0:emit(ActivityMediator.ON_SIMULATION_COMBAT, {
			warnMsg = &quot;bulin_tip_other3&quot;,
			stageId = uv0.puzzleConfig.chapter
		}, function ()
			if getProxy(ActivityProxy):getActivityById(uv0).data1 == 1 then
				return
			end

			slot1.data3 = 1

			slot0:updateActivity(slot1)
		end)
	end, SFX_PANEL)
	pg.SystemGuideMgr.GetInstance():PlayByGuideId(slot0.activity:getConfig(&quot;config_client&quot;).guideName)
end

slot1 = {
	&quot;lock&quot;,
	&quot;hint&quot;,
	&quot;unlock&quot;
}

slot0.OnUpdateFlush = function(slot0)
	uv0.super.OnUpdateFlush(slot0)

	slot2 = #slot0.activity.data2_list == #slot0.keyList

	if (slot0.activity.data1 &gt; 0 and &quot;activity_bg_aprilfool_final&quot; or &quot;activity_bg_aprilfool_discovery&quot;) ~= slot0.bgName then
		setImageSprite(slot0.bg, LoadSprite(&quot;ui/activityuipage/AprilFoolDiscoveryPage_atlas&quot;, slot3))

		slot0.bg:GetComponent(typeof(Image)).enabled = true
		slot0.bgName = slot3
	end

	slot4 = slot0.activity.data2_list
	slot5 = slot0.activity.data3_list

	for slot9, slot10 in ipairs(slot0.items) do
		slot12 = table.contains(slot4, slot0.keyList[slot9]) and 3 or table.contains(slot5, slot11) and 2 or 1

		onButton(slot0, slot10, function ()
			if uv0 &gt;= 3 then
				return
			end

			if uv0 == 2 then
				uv1.selectIndex = uv2

				uv1:UpdateSelection()

				return
			elseif uv0 == 1 then
				if pg.TimeMgr.GetInstance():GetServerTime() &lt; uv1.activity.data2 then
					pg.TipsMgr.GetInstance():ShowTips(i18n(&quot;bulin_tip_other2&quot;))

					return
				end

				pg.MsgboxMgr.GetInstance():ShowMsgBox({
					content = i18n(&quot;bulin_tip_other1&quot;),
					onYes = function ()
						pg.m02:sendNotification(GAME.PUZZLE_PIECE_OP, {
							cmd = 3,
							actId = uv0.activity.id,
							id = uv1
						})

						uv0.selectIndex = uv2
					end
				})
			end
		end)
		slot0.loader:GetSprite(&quot;UI/ActivityUIPage/AprilFoolDiscoveryPage_atlas&quot;, uv1[slot12], slot10:Find(&quot;state&quot;))
		setActive(slot10:Find(&quot;character&quot;), slot12 == 3)
	end

	setActive(slot0.btnBattle, slot2)
	setActive(slot0.btnIncomplete, not slot2)
	slot0:UpdateSelection()
end

slot0.UpdateSelection = function(slot0)
	setText(slot0.tip, table.contains(slot0.activity.data3_list, slot0.keyList[slot0.selectIndex]) and i18n(&quot;bulin_tip&quot; .. slot0.selectIndex) or &quot;&quot;)
	slot0:CreateCDTimer()
end

slot0.CreateCDTimer = function(slot0)
	if slot0.CDTimer then
		return
	end

	if #slot0.activity.data2_list == #slot0.keyList or slot0.activity.data2 &lt;= pg.TimeMgr.GetInstance():GetServerTime() then
		setActive(slot0.slider, false)
		slot0:RemoveCDTimer()

		return
	end

	setActive(slot0.slider, true)

	slot0.CDTimer = Timer.New(function ()
		if uv0.activity.data2 &lt;= pg.TimeMgr.GetInstance():GetServerTime() then
			setActive(uv0.slider, false)
			uv0:RemoveCDTimer()

			return
		end

		slot2 = slot0 - slot1

		setText(uv0.leftTime, string.format(&quot;%d:%02d&quot;, math.floor(slot2 / 60), slot2 % 60))
		setSlider(uv0.slider, 0, 1, slot2 / uv0.puzzleConfig.cd)
	end, 1, -1)

	slot0.CDTimer:Start()
	slot0.CDTimer.func()
end

slot0.RemoveCDTimer = function(slot0)
	if slot0.CDTimer then
		slot0.CDTimer:Stop()

		slot0.CDTimer = nil
	end
end

slot0.OnDestroy = function(slot0)
	slot0.loader:Clear()
	slot0:RemoveCDTimer()
	uv0.super.OnDestroy(slot0)
end

return slot0
</code></pre>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-lua.min.js"></script>
</body>
</html>