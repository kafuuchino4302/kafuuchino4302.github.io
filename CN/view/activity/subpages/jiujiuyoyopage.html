<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>jiujiuyoyopage.lua</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
</head>
<body>
    <h1>jiujiuyoyopage.lua</h1>
    <a href="index.html">返回主页</a>
    <pre><code class="language-lua">slot0 = class(&quot;JiujiuYoyoPage&quot;, import(&quot;...base.BaseActivityPage&quot;))
slot1 = PLATFORM_CODE == PLATFORM_JP or PLATFORM_CODE == PLATFORM_CHT

slot0.OnInit = function(slot0)
	slot0.bg = slot0:findTF(&quot;AD&quot;)
	slot0.helpBtn = slot0:findTF(&quot;help_btn&quot;, slot0.bg)
	slot0.taskBtn = slot0:findTF(&quot;task_btn&quot;, slot0.bg)
	slot0.taskRedDot = slot0:findTF(&quot;red_dot&quot;, slot0.taskBtn)
	slot0.ticketNumTF = slot0:findTF(&quot;ticket_num&quot;, slot0.bg)
	slot0.rollingCountTF = slot0:findTF(&quot;rolling_count&quot;, slot0.bg)
	slot0.rollingBlink = slot0:findTF(&quot;blink&quot;, slot0.bg)

	if uv0 then
		slot0.awardTpl = slot0:findTF(&quot;item_jp&quot;, slot0.bg)
		slot0.awardContainter = slot0:findTF(&quot;award_list_jp&quot;, slot0.bg)
	else
		slot0.awardTpl = slot0:findTF(&quot;item&quot;, slot0.bg)
		slot0.awardContainter = slot0:findTF(&quot;award_list&quot;, slot0.bg)
	end

	slot0.awardUIList = UIItemList.New(slot0.awardContainter, slot0.awardTpl)
	slot0.finalGot = slot0:findTF(&quot;final_got_jp&quot;, slot0.bg)
	slot0.rollingAni = slot0:findTF(&quot;rolling_mask&quot;, slot0.bg)
	slot0.rollingSpine = slot0:findTF(&quot;rolling&quot;, slot0.rollingAni):GetComponent(&quot;SpineAnimUI&quot;)
	slot0.rollingGraphic = slot0:findTF(&quot;rolling&quot;, slot0.rollingAni):GetComponent(&quot;SkeletonGraphic&quot;)
	slot0.forbidMask = slot0:findTF(&quot;forbid_mask&quot;, slot0.bg)
	slot0.taskWindow = slot0:findTF(&quot;TaskWindow&quot;)
	slot0.closeBtn = slot0:findTF(&quot;panel/close_btn&quot;, slot0.taskWindow)
	slot0.taskTpl = slot0:findTF(&quot;panel/scrollview/item&quot;, slot0.taskWindow)
	slot0.taskContainter = slot0:findTF(&quot;panel/scrollview/items&quot;, slot0.taskWindow)
	slot0.taskUIList = UIItemList.New(slot0.taskContainter, slot0.taskTpl)

	slot0:register()
end

slot0.register = function(slot0)
	slot0:bind(ActivityMediator.ON_SHAKE_BEADS_RESULT, function (slot0, slot1)
		uv0:displayResult(slot1.awards, slot1.number, function ()
			uv0.callback()
		end)
	end)
end

slot0.OnDataSetting = function(slot0)
	slot0.taskProxy = getProxy(TaskProxy)
	slot0.taskList = pg.activity_template[slot0.activity:getConfig(&quot;config_client&quot;).taskActID].config_data
	slot0.startTime = slot0.activity:getStartTime()
	slot0.totalNumList = {}
	slot0.remainNumList = {}
	slot0.remainTotalNum = 0
	slot0.awardList = {}
	slot0.finalAward = slot0.activity:getConfig(&quot;config_client&quot;).finalAward
	slot0.awardConifg = slot0.activity:getConfig(&quot;config_client&quot;).award
	slot0.beadsConfig = slot0.activity:getConfig(&quot;config_data&quot;)[1]

	for slot5, slot6 in ipairs(slot0.beadsConfig) do
		slot7 = slot6[1]
		slot0.awardList[slot7] = slot0.awardConifg[slot7]
		slot0.totalNumList[slot7] = slot6[2]
	end
end

slot0.OnFirstFlush = function(slot0)
	onButton(slot0, slot0.helpBtn, function ()
		pg.MsgboxMgr.GetInstance():ShowMsgBox({
			type = MSGBOX_TYPE_HELP,
			helps = i18n(&quot;tips_shakebeads&quot;)
		})
	end, SFX_PANEL)
	onButton(slot0, slot0.taskBtn, function ()
		uv0:openTask()
	end, SFX_PANEL)
	onButton(slot0, slot0.closeBtn, function ()
		uv0:closeTask()
	end, SFX_PANEL)
	onButton(slot0, slot0:findTF(&quot;mask&quot;, slot0.taskWindow), function ()
		uv0:closeTask()
	end, SFX_PANEL)
	onButton(slot0, slot0.rollingBlink, function ()
		if uv0.ticketNum &lt;= 0 then
			return
		end

		uv0:emit(ActivityMediator.EVENT_OPERATION, {
			cmd = 1,
			activity_id = uv0.activity.id
		})
	end, SFX_PANEL)
	setActive(slot0.taskRedDot, false)

	if LeanTween.isTweening(slot0.rollingBlink) then
		LeanTween.cancel(slot0.rollingBlink)
	end

	setImageAlpha(slot0.rollingBlink, 1)
	blinkAni(slot0.rollingBlink, 0.5)
end

slot0.OnUpdateFlush = function(slot0)
	slot4 = pg.TimeMgr.GetInstance()
	slot5 = slot4
	slot4 = slot4.GetServerTime
	slot0.curDay = pg.TimeMgr.GetInstance():DiffDay(slot0.startTime, slot4(slot5)) + 1
	slot0.ticketNum = slot0.activity.data1
	slot0.hasNumList = slot0.activity.data1KeyValueList[1]
	slot0.remainTotalNum = 0

	for slot4, slot5 in ipairs(slot0.beadsConfig) do
		if not slot0.hasNumList[slot5[1]] then
			slot0.hasNumList[slot6] = 0
		end

		slot0.remainNumList[slot6] = slot0.totalNumList[slot6] - slot0.hasNumList[slot6]
		slot0.remainTotalNum = slot0.remainTotalNum + slot0.remainNumList[slot6]
	end

	setText(slot0.ticketNumTF, slot0.ticketNum)
	setText(slot0.rollingCountTF, slot0.remainTotalNum)
	setActive(slot0.rollingBlink, slot0.ticketNum &gt; 0)
	slot0:initAwardList()
	slot0:initTaskWindow()

	slot0.isFirst = PlayerPrefs.GetInt(&quot;jiujiuyoyo_first_&quot; .. getProxy(PlayerProxy):getData().id)

	if slot0.isFirst == 0 then
		setActive(slot0.taskRedDot, true)
	end

	if #slot0.finishItemList &gt; 0 then
		slot0:openTask()
	end

	setActive(slot0.finalGot, uv0 and slot0.activity.data2 == 1)
	slot0:CheckFinalAward()
end

slot0.initAwardList = function(slot0)
	slot0.awardUIList:make(function (slot0, slot1, slot2)
		if slot0 == UIItemList.EventUpdate then
			slot3 = slot1 + 1
			slot4 = uv0.totalNumList[slot3]

			if uv0.remainNumList[slot3] == 0 then
				setTextColor(uv0:findTF(&quot;num&quot;, slot2), Color.New(0.55, 0.55, 0.55, 1))
				setOutlineColor(uv0:findTF(&quot;num&quot;, slot2), Color.New(0.26, 0.26, 0.26, 1))
			end

			setText(uv0:findTF(&quot;num&quot;, slot2), slot5 .. &quot;/&quot; .. slot4)
			setActive(uv0:findTF(&quot;got&quot;, slot2), slot5 == 0)

			slot6 = uv0:findTF(&quot;award_mask/award&quot;, slot2)
			slot7 = uv0.awardList[slot3]

			updateDrop(slot6, {
				type = slot7[1],
				id = slot7[2],
				count = slot7[3] * slot5
			})
			onButton(uv0, slot6, function ()
				uv0:emit(BaseUI.ON_DROP, uv1)
			end, SFX_PANEL)
		end
	end)
	slot0.awardUIList:align(#slot0.awardList)
end

slot0.initTaskWindow = function(slot0)
	slot0.finishItemList = {}
	slot0.finishTaskVOList = {}

	slot0.taskUIList:make(function (slot0, slot1, slot2)
		if slot0 == UIItemList.EventUpdate then
			slot6 = uv0.taskProxy:getTaskById(uv0.taskList[slot1 + 1]) or uv0.taskProxy:getFinishTaskById(slot5)

			assert(slot6, &quot;without this task by id: &quot; .. slot5)

			slot7 = slot6:getProgress()
			slot8 = slot6:getConfig(&quot;target_num&quot;)
			slot9 = slot6:getTaskStatus()
			slot11 = slot6:getConfig(&quot;award_display&quot;)[1]
			slot12 = uv0.curDay &lt; slot3

			setText(uv0:findTF(&quot;description&quot;, slot2), slot6:getConfig(&quot;desc&quot;))
			setText(uv0:findTF(&quot;progress/progressText&quot;, slot2), slot7 .. &quot;/&quot; .. slot8)
			setSlider(uv0:findTF(&quot;progress&quot;, slot2), 0, slot8, slot7)
			updateDrop(uv0:findTF(&quot;award/award&quot;, slot2), {
				type = slot11[1],
				id = slot11[2],
				count = slot11[3]
			})
			onButton(uv0, uv0:findTF(&quot;award/Image&quot;, slot2), function ()
				uv0:emit(BaseUI.ON_DROP, uv1)
			end, SFX_PANEL)

			slot15 = uv0:findTF(&quot;get_btn&quot;, slot2)

			setActive(uv0:findTF(&quot;go_btn&quot;, slot2), slot9 == 0)
			setActive(slot15, slot9 == 1)
			onButton(uv0, slot14, function ()
				uv0:emit(ActivityMediator.ON_TASK_GO, uv1)
			end, SFX_PANEL)
			onButton(uv0, slot15, function ()
				uv0:emit(ActivityMediator.ON_TASK_SUBMIT, uv1)
			end, SFX_PANEL)
			setActive(uv0:findTF(&quot;finnal&quot;, slot2), slot9 == 2 and not slot12)
			setText(uv0:findTF(&quot;lock/tip&quot;, slot2), i18n(&quot;unlock_tips&quot;, slot3))
			setActive(uv0:findTF(&quot;lock&quot;, slot2), slot12)

			if slot9 == 1 and not slot12 then
				table.insert(uv0.finishItemList, slot2)
				table.insert(uv0.finishTaskVOList, slot6)
			end
		end
	end)
	slot0.taskUIList:align(#slot0.taskList)
end

slot0.closeTask = function(slot0)
	setActive(slot0.taskWindow, false)
end

slot0.openTask = function(slot0)
	setActive(slot0.taskWindow, true)

	if slot0.isFirst == 0 then
		PlayerPrefs.SetInt(&quot;jiujiuyoyo_first_&quot; .. getProxy(PlayerProxy):getData().id, 1)
		setActive(slot0.taskRedDot, false)
	end

	slot0.hasClickTask = true

	eachChild(slot0.taskContainter, function (slot0)
		if isActive(uv0:findTF(&quot;finnal&quot;, slot0)) then
			slot0:SetAsLastSibling()
		end
	end)

	if #slot0.finishItemList &gt; 0 then
		slot0:autoFinishTask()
	end
end

slot0.autoFinishTask = function(slot0)
	slot1 = 0.01
	slot2 = 0.5

	for slot6, slot7 in ipairs(slot0.finishItemList) do
		slot8 = GetOrAddComponent(slot7, typeof(CanvasGroup))

		slot0:managedTween(LeanTween.delayedCall, function ()
			uv0:SetAsFirstSibling()
			LeanTween.value(go(uv0), 1, 0, uv1):setOnUpdate(System.Action_float(function (slot0)
				uv0.alpha = slot0
			end)):setOnComplete(System.Action(function ()
				uv0.alpha = 1

				setActive(uv1:findTF(&quot;finnal&quot;, uv2), true)
				uv2:SetAsLastSibling()
			end))
		end, slot1, nil)

		slot1 = slot1 + slot2 + 0.1
	end

	slot0:managedTween(LeanTween.delayedCall, function ()
		pg.m02:sendNotification(GAME.SUBMIT_TASK_ONESTEP, {
			resultList = uv0.finishTaskVOList
		})
	end, slot1, nil)
end

slot0.CheckFinalAward = function(slot0)
	if uv0 and slot0.activity.data2 == 0 and slot0.remainTotalNum == 0 then
		slot0:emit(ActivityMediator.EVENT_OPERATION, {
			cmd = 2,
			activity_id = slot0.activity.id
		})
	end
end

slot0.displayResult = function(slot0, slot1, slot2, slot3)
	slot0:setForbidMaskStatus(true)
	setActive(slot0.rollingAni, true)

	slot0.aniCallback = function()
		uv0()
	end

	slot0.rollingSpine:SetActionCallBack(function (slot0)
		if slot0 == &quot;finish&quot; then
			setActive(uv0.rollingAni, false)
			uv1()

			uv0.aniCallback = nil

			uv0:setForbidMaskStatus(false)
		end
	end)
	slot0.rollingSpine:SetAction(tostring(slot2), 0)
	pg.CriMgr.GetInstance():PlaySoundEffect_V3(&quot;event:/ui/zhuanzhu&quot;)
	slot0:managedTween(LeanTween.delayedCall, function ()
		pg.CriMgr.GetInstance():PlaySoundEffect_V3(&quot;event:/ui/zhengque&quot;)
	end, 4, nil)
end

slot0.setForbidMaskStatus = function(slot0, slot1)
	if slot1 then
		setActive(slot0.forbidMask, true)
		pg.UIMgr.GetInstance():OverlayPanel(slot0.forbidMask)
	else
		setActive(slot0.forbidMask, false)
		pg.UIMgr.GetInstance():UnOverlayPanel(slot0.forbidMask, slot0.bg)
	end
end

slot0.canFinishTask = function()
	slot0 = pg.activity_template[ActivityConst.JIUJIU_YOYO_ID]
	slot4 = pg.TimeMgr.GetInstance():DiffDay(pg.TimeMgr.GetInstance():parseTimeFromConfig(slot0.time[2]), pg.TimeMgr.GetInstance():GetServerTime()) + 1
	slot5 = false
	slot6 = getProxy(TaskProxy)

	for slot10, slot11 in pairs(pg.activity_template[slot0.config_client.taskActID].config_data) do
		slot12 = slot4 &lt; slot10
		slot13 = slot6:getTaskById(slot11) or slot6:getFinishTaskById(slot11)

		assert(slot13, &quot;without this task by id: &quot; .. slot11)

		if slot13:getTaskStatus() == 1 and not slot12 then
			slot5 = true

			break
		end
	end

	return slot5
end

slot0.IsShowRed = function()
	return getProxy(ActivityProxy):getActivityById(ActivityConst.JIUJIU_YOYO_ID).data1 &gt; 0 or uv0.canFinishTask()
end

return slot0
</code></pre>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-lua.min.js"></script>
</body>
</html>