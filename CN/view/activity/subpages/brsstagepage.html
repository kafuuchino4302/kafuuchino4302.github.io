<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>brsstagepage.lua</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
</head>
<body>
    <h1>brsstagepage.lua</h1>
    <a href="index.html">返回主页</a>
    <pre><code class="language-lua">slot0 = class(&quot;BRSStagePage&quot;, import(&quot;...base.BaseActivityPage&quot;))

slot0.OnInit = function(slot0)
	slot0.bg = slot0:findTF(&quot;panel&quot;)

	setText(slot0.bg:Find(&quot;hint&quot;), i18n(&quot;brs_expedition_tip&quot;))

	slot0.chainTFList = {}
	slot0.stageTFList = {}
	slot1 = slot0.bg:Find(&quot;stages&quot;)
	slot2 = slot0.bg:Find(&quot;progress_chain&quot;)

	for slot6 = 1, 3 do
		table.insert(slot0.stageTFList, slot1:Find(&quot;stage_&quot; .. slot6))
		table.insert(slot0.chainTFList, slot2:Find(&quot;chain_mark_&quot; .. slot6))
	end
end

slot0.OnDataSetting = function(slot0)
end

slot0.flushTaskData = function(slot0)
	slot0._taskList = {}

	for slot5, slot6 in ipairs(slot0.activity:getConfig(&quot;config_client&quot;).task) do
		table.insert(slot0._taskList, getProxy(TaskProxy):getTaskById(slot6) or getProxy(TaskProxy):getFinishTaskById(slot6))
	end
end

slot0.OnFirstFlush = function(slot0)
	slot1 = slot0.activity:getConfig(&quot;config_data&quot;)
	slot2 = {}

	for slot6, slot7 in ipairs(slot0.activity.data2_list) do
		table.insert(slot2, slot0.activity:GetEnemyDataByStageId(slot7).id)
	end

	slot0:flushTaskData()

	slot3 = 1

	for slot7, slot8 in ipairs(slot0.stageTFList) do
		slot9 = slot0.activity:GetEnemyDataById(slot1[slot7])

		setText(slot8:Find(&quot;name/text&quot;), slot9:getConfig(&quot;name&quot;))
		setText(slot8:Find(&quot;level&quot;), slot9:getConfig(&quot;level&quot;))

		slot10 = slot8:Find(&quot;award&quot;)
		slot11 = slot0._taskList[slot7]
		slot12 = slot11:getConfig(&quot;award_display&quot;)[1]

		updateDrop(findTF(slot10, &quot;mask&quot;), {
			type = slot12[1],
			id = slot12[2],
			count = slot12[3]
		})

		slot14 = slot11:getTaskStatus()

		setActive(slot10:Find(&quot;claimed&quot;), slot11:getTaskStatus() == 2)
		onButton(slot0, slot10, function ()
			uv0:emit(BaseUI.ON_DROP, uv1)
		end)

		if slot9:GetPreChapterId() == 0 or table.contains(slot2, slot9:GetPreChapterId()) then
			setActive(slot8:Find(&quot;lock&quot;), false)
			onButton(slot0, slot8, function ()
				uv0.fleetEditPanel = uv0:GetFleetEditPanel()

				uv0.fleetEditPanel.buffer:SetFleets(getProxy(FleetProxy):GetRegularFleets())
				uv0.fleetEditPanel.buffer:SetSettings(1, 0, uv1:GetExpeditionId(), SYSTEM_REWARD_PERFORM, uv0.activity.configId)
				uv0.fleetEditPanel.buffer:UpdateView()
				uv0.fleetEditPanel.buffer:Show()
			end)
			setActive(slot0.chainTFList[slot7]:Find(&quot;finish&quot;), true)
			setActive(slot0.chainTFList[slot7]:Find(&quot;unfinish&quot;), false)

			slot8:Find(&quot;name/text&quot;):GetComponent(typeof(Text)).color = Color.white
			slot3 = slot7
		else
			setActive(slot0.chainTFList[slot7]:Find(&quot;finish&quot;), false)
			setActive(slot0.chainTFList[slot7]:Find(&quot;unfinish&quot;), true)
			setActive(slot8:Find(&quot;lock&quot;), true)
		end
	end

	triggerToggle(slot0.stageTFList[slot3]:Find(&quot;bg&quot;), true)

	slot4 = pg.NewStoryMgr.GetInstance()

	if #slot0.activity.data2_list == 0 then
		slot4:Play(slot0.activity:getConfig(&quot;config_client&quot;).story[1][1])
	end
end

slot0.GetFleetEditPanel = function(slot0)
	if not slot0.fleetEditPanel then
		slot0.fleetEditPanel = BossSingleBattleFleetSelectSubPanelLite.New(slot0)

		slot0.fleetEditPanel:Load()
	end

	return slot0.fleetEditPanel
end

slot0.OnUpdateFlush = function(slot0)
	slot0:flushTaskData()

	for slot4, slot5 in ipairs(slot0._taskList) do
		setActive(slot0.stageTFList[slot4]:Find(&quot;award/claimed&quot;), slot5:getTaskStatus() == 2)

		if slot4 == 3 then
			if slot6 == 1 then
				slot7 = pg.NewStoryMgr.GetInstance()
				slot8 = slot0.activity:getConfig(&quot;config_client&quot;).story[2][1]
				slot10 = slot7:StoryName2StoryId(slot8)
				slot11 = slot7:StoryName2StoryId(slot0.activity:getConfig(&quot;config_client&quot;).story[3][1])

				if not slot7:IsPlayed(slot8) then
					slot0:emit(ActivityMediator.GO_PERFORM_COMBAT, {
						stageId = slot10
					})
				elseif not slot7:IsPlayed(slot9) then
					slot0:emit(ActivityMediator.GO_PERFORM_COMBAT, {
						stageId = slot11
					})
				else
					slot0:emit(ActivityMediator.ON_TASK_SUBMIT, slot5)
				end
			end
		elseif slot6 == 1 then
			slot0:emit(ActivityMediator.ON_TASK_SUBMIT, slot5)
		end
	end
end

slot0.OnDestroy = function(slot0)
	if slot0.fleetEditPanel then
		slot0.fleetEditPanel:OnHide()
	end
end

return slot0
</code></pre>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-lua.min.js"></script>
</body>
</html>