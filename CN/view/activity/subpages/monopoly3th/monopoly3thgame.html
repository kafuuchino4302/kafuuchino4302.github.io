<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>monopoly3thgame.lua</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
</head>
<body>
    <h1>monopoly3thgame.lua</h1>
    <a href="index.html">返回主页</a>
    <pre><code class="language-lua">slot0 = class(&quot;Monopoly3thGame&quot;)
slot1 = 502041
slot2 = 502041
slot3, slot4 = nil
slot5 = 0.6
slot6 = 100
slot7 = &quot;dafuweng_gold&quot;
slot8 = &quot;dafuweng_oil&quot;
slot9 = &quot;dafuweng_event&quot;
slot10 = &quot;dafuweng_walk&quot;
slot11 = &quot;stand&quot;
slot12 = &quot;dafuweng_stand&quot;
slot13 = &quot;dafuweng_jump&quot;
slot14 = &quot;dafuweng_run&quot;
slot15 = &quot;dafuweng_touch&quot;

slot0.Ctor = function(slot0, slot1, slot2, slot3, slot4)
	slot0._binder = slot1
	slot0._tf = slot2
	slot0._event = slot3
	slot0._configId = slot4

	slot0:initData()
	slot0:initUI()
	slot0:initEvent()
end

slot0.initData = function(slot0)
	slot0.leftCount = 0
	slot0.inAnimatedFlag = false
	slot0.mapIds = pg.activity_event_monopoly[slot0._configId].map
	slot0.lastBonusTimes = pg.activity_event_monopoly[slot0._configId].drop_times[1]
	slot0.randomMoveTiemr = Timer.New(function ()
		uv0:checkPlayerRandomMove()
	end, 15, -1)
end

slot0.initUI = function(slot0)
	slot0.char = findTF(slot0._tf, &quot;map/char&quot;)

	setActive(slot0.char, false)

	slot0.btnStart = findTF(slot0._tf, &quot;btnStart&quot;)
	slot0.btnHelp = findTF(slot0._tf, &quot;btnHelp&quot;)
	slot0.btnRp = findTF(slot0._tf, &quot;btnRp&quot;)
	slot4 = Animator
	slot0.commonAnim = findTF(slot0.btnRp, &quot;rpAni&quot;):GetComponent(typeof(slot4))
	slot0.labelLeftCountTip = findTF(slot0._tf, &quot;countTip/labelLeftCountTip&quot;)
	slot0.labelLeftCount = findTF(slot0._tf, &quot;countTip/labelLeftCount&quot;)
	slot0.labelDropShip = findTF(slot0._tf, &quot;labelDropShip&quot;)
	slot0.labelLeftRpCount = findTF(slot0._tf, &quot;labelLeftRpCount&quot;)
	slot0.cellPos = findTF(slot0._tf, &quot;map/mask/posCell&quot;)
	slot0.tplCell = findTF(slot0._tf, &quot;map/mask/posCell/tplCell&quot;)
	slot0.mapCells = {}
	slot0.curCellIndex = nil
	slot0.groundChildsList = {}
	slot0.groundMoveRate = {
		0.1,
		0.3,
		1
	}

	for slot4 = 1, 3 do
		slot6 = {}

		for slot10 = 1, findTF(slot0._tf, &quot;map/mask/ground&quot; .. slot4).childCount do
			table.insert(slot6, slot5:GetChild(slot10 - 1))
		end

		table.insert(slot0.groundChildsList, slot6)
	end

	PoolMgr.GetInstance():GetSpineChar(Ship.New({
		configId = uv0,
		skin_id = uv1
	}):getPrefab(), true, function (slot0)
		uv0.model = slot0
		uv0.model.transform.localScale = Vector3.one
		uv0.model.transform.localPosition = Vector3.zero

		uv0.model.transform:SetParent(uv0.char, false)

		uv0.anim = uv0.model:GetComponent(typeof(SpineAnimUI))

		uv0:changeCharAction(uv1, 0, nil)
		uv0:checkCharActive()
	end)
	slot0.randomMoveTiemr:Start()
end

slot0.initEvent = function(slot0)
	onButton(slot0._binder, slot0.btnStart, function ()
		if uv0.inAnimatedFlag then
			return
		end

		if uv0.leftCount and uv0.leftCount &lt;= 0 then
			pg.TipsMgr.GetInstance():ShowTips(i18n(&quot;common_count_noenough&quot;))

			return
		end

		slot0 = uv0

		slot0:changeAnimeState(true)

		slot0 = uv0._event

		slot0:emit(Monopoly3thPage.ON_START, uv0.activity.id, function (slot0)
			if slot0 and slot0 &gt; 0 then
				uv0.step = slot0

				uv0:updataUI()
				uv0:checkCharActive()
			end
		end)
	end, SFX_PANEL)
	onButton(slot0._binder, slot0.btnHelp, function ()
		pg.MsgboxMgr.GetInstance():ShowMsgBox({
			type = MSGBOX_TYPE_HELP,
			helps = pg.gametip.help_monopoly_3th.tip
		})
	end, SFX_PANEL)
	onButton(slot0._binder, slot0.char, function ()
		if not uv0.model or uv0.inAnimatedFlag then
			return
		end

		if LeanTween.isTweening(go(uv0.cellPos)) then
			LeanTween.cancel(go(uv0.cellPos))
		end

		slot0 = uv0

		slot0:changeCharAction(uv1, 1, function ()
			uv0:changeCharAction(uv1)
		end)
	end, SFX_PANEL)
	onButton(slot0._binder, slot0.btnRp, function ()
		if uv0.leftAwardCnt &gt; 0 then
			uv0._event:emit(Monopoly3thPage.ON_AWARD)
		end
	end, SFX_PANEL)
end

slot0.checkPlayerRandomMove = function(slot0)
	if not slot0.model or slot0.inAnimatedFlag then
		return
	end

	if math.random() &gt; 0.5 then
		slot1 = math.random(2, 4)
		slot4 = 0

		slot0:changeCharAction(uv0, 0, nil)

		slot5 = LeanTween.value(go(slot0.cellPos), 0, 300 * slot1, slot1 * 2)
		slot5 = slot5:setEase(LeanTweenType.linear)
		slot5 = slot5:setOnUpdate(System.Action_float(function (slot0)
			uv0:updateMap(slot0 - uv1)

			uv1 = slot0
		end))

		slot5:setOnComplete(System.Action(function ()
			uv0:changeCharAction(uv1, 0, nil)
		end))

		return
	end

	slot0:changeCharAction(uv2, 1, function ()
		uv0:changeCharAction(uv1)
	end)
end

slot0.checkCountStory = function(slot0, slot1)
	slot2 = slot0.useCount

	if _.detect(slot0.activity:getDataConfig(&quot;story&quot;) or {}, function (slot0)
		return slot0[1] == uv0
	end) then
		pg.NewStoryMgr.GetInstance():Play(slot5[2], slot1)
	else
		slot1()
	end
end

slot0.changeAnimeState = function(slot0, slot1)
	if slot1 then
		slot0.btnStart:GetComponent(typeof(Image)).raycastTarget = false
		slot0.inAnimatedFlag = true

		slot0._event:emit(ActivityMainScene.LOCK_ACT_MAIN, true)
	else
		slot0.inAnimatedFlag = false
		slot0.btnStart:GetComponent(typeof(Image)).raycastTarget = true

		slot0._event:emit(ActivityMainScene.LOCK_ACT_MAIN, false)
	end

	setActive(slot0.btnStart, not slot1)
end

slot0.checkCharActive = function(slot0)
	if slot0.anim then
		if slot0.effectId and slot0.effectId &gt; 0 then
			slot0:changeAnimeState(true)
			slot0:checkEffect(function ()
				uv0:changeAnimeState(false)
				uv0:checkCharActive()
			end)
		elseif slot0.step and slot0.step &gt; 0 then
			slot0:changeAnimeState(true)
			slot0:checkStep(function ()
				uv0:changeAnimeState(false)
				uv0:checkCharActive()
			end)
		else
			slot0:checkLastBonus()
		end
	end
end

slot0.firstUpdata = function(slot0, slot1)
	slot0:activityDataUpdata(slot1)
	slot0:updataUI()
	slot0:updataChar()
	slot0:checkCharActive()
	slot0:checkLastBonus()

	if slot0.pos and slot0.pos &gt; 0 then
		slot0:updateMap(slot0.pos * 1100 % 2500)
	end
end

slot0.updataActivity = function(slot0, slot1)
	slot0:activityDataUpdata(slot1)
	slot0:updataUI()
end

slot0.checkLastBonus = function(slot0)
	if (not slot0.lastBonusFlag or slot0.lastBonusFlag == 0) and slot0.useCount and slot0.lastBonusTimes &lt;= slot0.useCount then
		slot1 = slot0._event

		slot1:emit(Monopoly3thPage.MONOPOLY_OP_LAST, slot0.activity.id, function (slot0)
			uv0.lastBonusFlag = 1

			setActive(findTF(uv0.labelDropShip, &quot;get&quot;), false)
			setActive(findTF(uv0.labelDropShip, &quot;got&quot;), true)
			setActive(findTF(uv0.labelDropShip, &quot;text&quot;), false)
		end)
	end

	if slot0.lastBonusFlag == 1 then
		setActive(findTF(slot0.labelDropShip, &quot;get&quot;), false)
		setActive(findTF(slot0.labelDropShip, &quot;got&quot;), true)
		setActive(findTF(slot0.labelDropShip, &quot;text&quot;), false)
	end
end

slot0.activityDataUpdata = function(slot0, slot1)
	slot0.activity = slot1
	slot0.totalCnt = math.ceil((pg.TimeMgr.GetInstance():GetServerTime() - slot0.activity.data1) / 86400) * slot0.activity:getDataConfig(&quot;daily_time&quot;) + slot0.activity.data1_list[1]
	slot0.useCount = slot0.activity.data1_list[2]
	slot0.leftCount = slot0.totalCnt - slot0.useCount
	slot0.turnCnt = slot0.activity.data1_list[3] - 1
	slot0.leftDropShipCnt = 8 - slot0.turnCnt
	slot0.advanceTotalCnt = #slot1:getDataConfig(&quot;reward&quot;)
	slot0.isAdvanceRp = slot0.advanceTotalCnt - slot0.activity.data2_list[2] &gt; 0
	slot9 = slot0.activity.data2_list[1]
	slot0.leftAwardCnt = slot9 - slot8
	slot0.advanceRpCount = math.max(0, math.min(slot9, slot0.advanceTotalCnt) - slot8)
	slot0.commonRpCount = math.max(0, slot9 - slot0.advanceTotalCnt) - math.max(0, slot8 - slot0.advanceTotalCnt)
	slot10 = slot1:getDataConfig(&quot;reward_time&quot;)
	slot0.nextredPacketStep = slot10 - slot0.useCount % slot10
	slot0.pos = slot0.activity.data2
	slot0.step = slot0.activity.data3 or 0
	slot0.effectId = slot0.activity.data4 or 0
	slot0.lastBonusFlag = slot0.activity.data2_list[3]
end

slot0.checkStep = function(slot0, slot1)
	if slot0.step &gt; 0 then
		slot2 = slot0._event

		slot2:emit(Monopoly3thPage.ON_MOVE, slot0.activity.id, function (slot0, slot1, slot2)
			uv0.step = slot0
			uv0.pos = slot1[#slot1]
			uv0.effectId = slot2

			seriesAsync({
				function (slot0)
					uv1:moveCharWithPaths(uv2, uv0, slot0)
				end,
				function (slot0)
					uv0:checkEffect(slot0)
				end
			}, function ()
				if uv0 then
					uv0()
				end
			end)
		end)
	elseif slot1 then
		slot1()
	end
end

slot0.updataUI = function(slot0)
	setText(slot0.labelLeftRpCount, &quot;&quot; .. slot0.leftAwardCnt)
	LeanTween.delayedCall(go(slot0.btnRp), 1, System.Action(function ()
		if uv0.commonAnim.isActiveAndEnabled then
			uv0.commonAnim:SetInteger(&quot;count&quot;, uv0.leftAwardCnt)
		end
	end))

	if slot0.lastBonusTimes - slot0.useCount &gt; 0 then
		setText(findTF(slot0.labelDropShip, &quot;text&quot;), &quot;&quot; .. slot1)
	end

	setText(slot0.labelLeftCountTip, slot0.nextredPacketStep)
	setText(slot0.labelLeftCount, slot0.leftCount)
end

slot0.updataChar = function(slot0)
	if not isActive(slot0.char) then
		SetActive(slot0.char, true)
		slot0.char:SetAsLastSibling()
	end
end

slot0.checkEffect = function(slot0, slot1)
	if slot0.effectId &gt; 0 then
		slot2 = pg.activity_event_monopoly_event[slot0.effectId].story
		slot3 = slot0:getActionName(slot0.pos)

		seriesAsync({
			function (slot0)
				if uv0 then
					slot1 = uv1

					slot1:changeCharAction(uv0, 1, function ()
						uv0:changeCharAction(uv1, 0, nil)
						uv2()
					end)
				else
					slot0()
				end
			end,
			function (slot0)
				if uv0 and tonumber(uv0) ~= 0 then
					pg.NewStoryMgr.GetInstance():Play(uv0, slot0, true, true)
				else
					slot0()
				end
			end,
			function (slot0)
				uv0:triggerEfect(slot0)
			end,
			function (slot0)
				uv0:checkCountStory(slot0)
			end
		}, slot1)

		return
	end

	if slot1 then
		slot1()
	end
end

slot0.triggerEfect = function(slot0, slot1)
	slot2 = slot0._event

	slot2:emit(Monopoly3thPage.ON_TRIGGER, slot0.activity.id, function (slot0, slot1)
		if slot0 and #slot0 &gt;= 0 then
			uv0.effectId = slot1
			uv0.pos = slot0[#slot0]

			seriesAsync({
				function (slot0)
					uv0:moveCharWithPaths(uv1, uv2, slot0)
				end
			}, function ()
				uv0()
			end)
		end
	end)
end

slot0.moveCharWithPaths = function(slot0, slot1, slot2, slot3)
	if not slot1 or #slot1 &lt;= 0 then
		if slot3 then
			slot3()
		end

		return
	end

	slot4 = {}

	table.insert(slot4, function (slot0)
		slot2 = 1100
		slot3 = 0

		uv2:createCell(slot2)
		uv2:changeCharAction(uv0, 0, nil)

		slot4 = slot2 / ((uv0 ~= uv1 and 4 or 2) / 0.6)
		slot5 = 0

		if LeanTween.isTweening(go(uv2.cellPos)) then
			LeanTween.cancel(go(uv2.cellPos))
		end

		slot6 = LeanTween.value(go(uv2.cellPos), 0, slot2, slot1)
		slot6 = slot6:setEase(LeanTweenType.linear)
		slot6 = slot6:setOnUpdate(System.Action_float(function (slot0)
			uv0:updateMap(slot0 - uv1)

			uv1 = slot0
		end))

		slot6:setOnComplete(System.Action(function ()
			uv0()
		end))
	end)
	table.insert(slot4, function (slot0)
		uv0:changeCharAction(uv1, 0, nil)
		slot0()
	end)
	seriesAsync(slot4, slot3)
end

slot0.createCell = function(slot0, slot1)
	slot4 = tf(instantiate(go(slot0.tplCell)))
	slot4.localPosition = Vector3(slot1, 0, 0)
	findTF(slot4, &quot;icon&quot;):GetComponent(typeof(Image)).sprite = GetSpriteFromAtlas(&quot;ui/activityuipage/monopoly3th_atlas&quot;, pg.activity_event_monopoly_map[slot0.mapIds[slot0.pos]].icon)

	findTF(slot4, &quot;icon&quot;):GetComponent(typeof(Image)):SetNativeSize()
	setActive(slot4, true)
	setParent(slot4, slot0.cellPos)
	table.insert(slot0.mapCells, slot4)
end

slot0.updateMap = function(slot0, slot1)
	for slot5 = 1, #slot0.mapCells do
		slot6 = slot0.mapCells[slot5].anchoredPosition
		slot6.x = slot6.x - slot1
		slot0.mapCells[slot5].anchoredPosition = slot6
	end

	if #slot0.mapCells &gt; 0 and slot0.mapCells[1].anchoredPosition.x &lt; -1000 then
		Destroy(table.remove(slot0.mapCells, 1))
	end

	for slot5 = 1, #slot0.groundChildsList do
		slot6 = slot0.groundMoveRate[slot5]

		for slot11 = #slot0.groundChildsList[slot5], 1, -1 do
			slot12 = slot7[slot11]
			slot12.anchoredPosition = Vector3(slot12.anchoredPosition.x - slot1 * slot6, slot12.anchoredPosition.y, slot12.anchoredPosition.z)
		end
	end

	for slot5 = 1, #slot0.groundChildsList do
		for slot10 = #slot0.groundChildsList[slot5], 1, -1 do
			slot11 = slot6[slot10]

			if slot11.anchoredPosition.x &lt;= -slot11.sizeDelta.x and #slot6 &gt; 1 then
				slot12 = table.remove(slot6, slot10)
				slot12.anchoredPosition = Vector3(slot6[#slot6].anchoredPosition.x + slot6[#slot6].sizeDelta.x, slot11.anchoredPosition.y, slot11.anchoredPosition.z)

				table.insert(slot6, slot12)
			end
		end
	end
end

slot0.changeCharAction = function(slot0, slot1, slot2, slot3)
	if slot0.actionName == slot1 and slot0.actionName ~= uv0 then
		return
	end

	slot0.actionName = slot1
	slot4 = slot0.anim

	slot4:SetActionCallBack(nil)

	slot4 = slot0.anim

	slot4:SetAction(slot1, 0)

	slot4 = slot0.anim

	slot4:SetActionCallBack(function (slot0)
		if slot0 == &quot;finish&quot; then
			if uv0 == 1 then
				uv1.anim:SetActionCallBack(nil)
				uv1.anim:SetAction(uv2, 0)
			end

			if uv3 then
				uv3()
			end
		end
	end)

	if slot2 ~= 1 and slot3 then
		slot3()
	end
end

slot0.getActionName = function(slot0, slot1)
	if pg.activity_event_monopoly_map[slot0.mapIds[slot1]].icon == &quot;icon_1&quot; then
		return uv0
	elseif slot3 == &quot;icon_2&quot; then
		return uv1
	elseif slot3 == &quot;icon_3&quot; then
		return nil
	elseif slot3 == &quot;icon_4&quot; then
		return uv0
	elseif slot3 == &quot;icon_5&quot; then
		return uv2
	elseif slot3 == &quot;icon_6&quot; then
		return uv0
	end

	return uv0
end

slot0.dispose = function(slot0)
	if slot0.model then
		PoolMgr.GetInstance():ReturnSpineChar(uv0, slot0.model)
	end

	if slot0.randomMoveTiemr then
		if slot0.randomMoveTiemr.running then
			slot0.randomMoveTiemr:Stop()
		end

		slot0.randomMoveTiemr = nil
	end

	if LeanTween.isTweening(go(slot0.btnRp)) then
		LeanTween.cancel(go(slot0.btnRp))
	end

	if LeanTween.isTweening(go(slot0.cellPos)) then
		LeanTween.cancel(go(slot0.cellPos))
	end
end

return slot0
</code></pre>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-lua.min.js"></script>
</body>
</html>