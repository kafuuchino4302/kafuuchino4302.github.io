<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>towninfopage.lua</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
</head>
<body>
    <h1>towninfopage.lua</h1>
    <a href="index.html">返回主页</a>
    <pre><code class="language-lua">slot0 = class(&quot;TownInfoPage&quot;, import(&quot;view.base.BaseSubView&quot;))
slot0.SLOT_CNT = 9

slot0.getUIName = function(slot0)
	return &quot;TownInfoPage&quot;
end

slot0.OnLoaded = function(slot0)
	slot0.togglesTF = slot0:findTF(&quot;frame/toggles&quot;)

	eachChild(slot0.togglesTF, function (slot0)
		onToggle(uv0, slot0, function (slot0)
			setImageColor(uv0:findTF(&quot;name&quot;, uv1), Color.NewHex(slot0 and &quot;F5ECDD&quot; or &quot;796464&quot;))
		end, SFX_PANEL)
	end)

	slot0.townTip = slot0:findTF(&quot;town/tip&quot;, slot0.togglesTF)
	slot0.placeTip = slot0:findTF(&quot;place/tip&quot;, slot0.togglesTF)
	slot0.shipTip = slot0:findTF(&quot;ship/tip&quot;, slot0.togglesTF)
	slot0.townPanel = slot0:findTF(&quot;frame/panels/town_panel&quot;)
	slot0.townLevelNow = slot0:findTF(&quot;lvmask/level_now&quot;, slot0.townPanel)
	slot0.townLevelNext = slot0:findTF(&quot;lvmask/level_next&quot;, slot0.townPanel)
	slot0.curExp = slot0:findTF(&quot;infos/exp/value/cur&quot;, slot0.townPanel)
	slot0.needExp = slot0:findTF(&quot;infos/exp/value/need&quot;, slot0.townPanel)
	slot0.goldOutput = slot0:findTF(&quot;infos/output/value&quot;, slot0.townPanel)
	slot0.goldLimit = slot0:findTF(&quot;infos/limit/value&quot;, slot0.townPanel)
	slot0.townUpgradeTF = slot0:findTF(&quot;upgrade_status&quot;, slot0.townPanel)
	slot0.shipPanel = slot0:findTF(&quot;frame/panels/ship_panel&quot;)
	slot0.shipUIList = UIItemList.New(slot0:findTF(&quot;content&quot;, slot0.shipPanel), slot0:findTF(&quot;content/tpl&quot;, slot0.shipPanel))
	slot1 = slot0.shipUIList

	slot1:make(function (slot0, slot1, slot2)
		if slot0 == UIItemList.EventUpdate then
			uv0:UpdateShip(slot1, slot2)
		end
	end)

	slot0.placePanel = slot0:findTF(&quot;frame/panels/place_panel&quot;)

	setText(slot0:findTF(&quot;view/content/tpl/next/title&quot;, slot0.placePanel), i18n(&quot;town_place_next_title&quot;))

	slot0.placeUIList = UIItemList.New(slot0:findTF(&quot;view/content&quot;, slot0.placePanel), slot0:findTF(&quot;view/content/tpl&quot;, slot0.placePanel))
	slot1 = slot0.placeUIList

	slot1:make(function (slot0, slot1, slot2)
		if slot0 == UIItemList.EventUpdate then
			uv0:UpdatePlace(slot1, slot2)
		end
	end)

	slot0.specialWorkGroup = pg.gameset.activity_town_special_work.key_value
end

slot0.SetActivity = function(slot0, slot1)
	slot0.activity = slot1 or getProxy(ActivityProxy):getActivityByType(ActivityConst.ACTIVITY_TYPE_TOWN)

	assert(slot0.activity and not slot0.activity:isEnd(), &quot;not exist town act, type: &quot; .. ActivityConst.ACTIVITY_TYPE_TOWN)
end

slot0.OnInit = function(slot0)
	slot0:SetActivity()

	slot0.slotUnlockLv = {}

	(function ()
		for slot3, slot4 in ipairs(pg.activity_town_level.all) do
			for slot9 = 1, pg.activity_town_level[slot4].unlock_chara do
				if not uv0.slotUnlockLv[slot9] then
					uv0.slotUnlockLv[slot9] = slot4
				end

				if uv0.slotUnlockLv[uv1.SLOT_CNT] then
					return
				end
			end
		end
	end)()
	triggerToggle(slot0:findTF(&quot;town&quot;, slot0.togglesTF), true)
end

slot0.Flush = function(slot0)
	slot0:FlushTownPanel()
	slot0:FlushShipPanel()
	slot0:FlushPlacePanel()
	slot0:Show()
end

slot0.OnExpUpdate = function(slot0)
	slot2 = pg.activity_town_level[slot0.townLv].exp

	setText(slot0.curExp, slot0.activity:GetExp())
	setTextColor(slot0.curExp, Color.NewHex(not isMaxLv and slot1 &lt; slot2 and &quot;CC3A33&quot; or &quot;63423E&quot;))
	setText(slot0.needExp, &quot;/&quot; .. (isMaxLv and 0 or slot2))
end

slot0.OnTownUpgrade = function(slot0, slot1)
	slot2 = slot0.townPanel
	slot2 = slot2:GetComponent(typeof(DftAniEvent))

	slot2:SetEndEvent(function ()
		if uv0 then
			uv0()
		end

		uv1.inTownAnim = false

		uv2:SetEndEvent(nil)
	end)
	slot2:SetTriggerEvent(function ()
		uv0:Flush()
		uv1:SetTriggerEvent(nil)
	end)

	slot3 = slot0.townPanel
	slot3 = slot3:GetComponent(typeof(Animation))

	slot3:Play(&quot;anim_cowboy_info_town_lvup&quot;)

	slot0.inTownAnim = true

	slot0:managedTween(LeanTween.delayedCall, function ()
		uv0:FlushTownWithoutLv()
	end, 0.265, nil)
end

slot0.OnPlaceUpgrade = function(slot0, slot1)
	slot0.townUpgradeCb = slot1

	slot0:Flush()
end

slot0.UpdateTownStatus = function(slot0)
	slot1 = slot0.activity
	slot1, slot2, slot3 = slot1:CanUpgradeTown()

	setActive(slot0.townTip, slot1)
	eachChild(slot0.townUpgradeTF, function (slot0)
		setActive(slot0, slot0.name == uv0)
	end)
	onButton(slot0, slot0:findTF(&quot;normal&quot;, slot0.townUpgradeTF), function ()
		if not uv0 or uv1.inTownAnim then
			return
		end

		uv1:emit(TownMediator.UPGRADE_TOWN)
	end, SFX_PANEL)

	if slot2 == &quot;no_story&quot; then
		setText(slot0:findTF(&quot;no_story/content/value/cur&quot;, slot0.townUpgradeTF), slot3[1])
		setText(slot0:findTF(&quot;no_story/content/value/need&quot;, slot0.townUpgradeTF), &quot;/&quot; .. slot3[2])
	elseif slot2 == &quot;no_exp_or_gold&quot; then
		setTextColor(slot0:findTF(&quot;no_exp_or_gold/cost/Text&quot;, slot0.townUpgradeTF), Color.NewHex(slot3 == &quot;no_gold&quot; and &quot;FF756E&quot; or &quot;FFEBC9&quot;))
	end
end

slot0.FlushTownWithoutLv = function(slot0)
	slot0:OnExpUpdate()
	setText(slot0.goldOutput, string.format(&quot;+%s/H&quot;, TownActivity.GoldToShow(slot0.activity:GetGoldOutput())))
	setText(slot0.goldLimit, TownActivity.GoldToShow(slot0.activity:GetLimitGold()))

	slot3 = TownActivity.GoldToShow(pg.activity_town_level[slot0.townLv].gold)

	setText(slot0:findTF(&quot;normal/cost/Text&quot;, slot0.townUpgradeTF), slot3)
	setText(slot0:findTF(&quot;no_exp_or_gold/cost/Text&quot;, slot0.townUpgradeTF), slot3)
	slot0:UpdateTownStatus()
end

slot0.FlushTownPanel = function(slot0)
	slot0.townLv = slot0.activity:GetTownLevel()

	setText(slot0.townLevelNow, &quot;LV.&quot; .. (slot0.activity:IsMaxTownLevel() and &quot;MAX&quot; or slot0.townLv))
	setText(slot0.townLevelNext, &quot;LV.&quot; .. (slot1 and &quot;MAX&quot; or slot0.townLv + 1))
	slot0:FlushTownWithoutLv()
end

slot0.FlushShipPanel = function(slot0)
	slot0.shipIds = slot0.activity:GetShipIds()
	slot0.unlockCnt = slot0.activity:GetUnlockSlotCnt()

	slot0.shipUIList:align(uv0.SLOT_CNT)
	setActive(slot0.shipTip, slot0.activity:HasEmptySlot())
end

slot0.UpdateShip = function(slot0, slot1, slot2)
	slot4 = slot0.unlockCnt &lt; slot1 + 1

	setActive(slot0:findTF(&quot;lock&quot;, slot2), slot4)

	if slot4 then
		setText(slot0:findTF(&quot;lock/Text&quot;, slot2), i18n(&quot;town_lock_level&quot;, &quot;LV&quot; .. slot0.slotUnlockLv[slot3]))
	end

	slot6 = not slot0.shipIds[slot3] or slot5 == 0

	setActive(slot0:findTF(&quot;empty&quot;, slot2), slot6)
	setActive(slot0:findTF(&quot;mask&quot;, slot2), not slot6)

	slot7 = nil

	if not slot6 then
		if getProxy(BayProxy):RawGetShipById(slot5) then
			setImageSprite(slot0:findTF(&quot;mask/icon&quot;, slot2), LoadSprite(&quot;qicon/&quot; .. slot8:getPainting()), true)
		else
			setActive(slot0:findTF(&quot;empty&quot;, slot2), true)
			setActive(slot0:findTF(&quot;mask&quot;, slot2), false)
		end
	end

	onButton(slot0, slot2, function ()
		if uv0 then
			return
		end

		uv1:emit(TownMediator.OPEN_CHUANWU, uv2, uv3)
	end, SFX_PANEL)
end

slot0.FlushPlacePanel = function(slot0)
	slot0.placeList = slot0.activity:GetPlaceList()

	table.sort(slot0.placeList, CompareFuncs({
		function (slot0)
			return slot0:GetNextId() and 0 or 1
		end,
		function (slot0)
			return slot0.id
		end
	}))
	slot0.placeUIList:align(#slot0.placeList)
end

slot0.UpdatePlaceStatus = function(slot0, slot1, slot2)
	slot3 = slot0:findTF(&quot;upgrade_status&quot;, slot2)
	slot4 = TownActivity.GoldToShow(slot1:GetCostGold())

	setText(slot0:findTF(&quot;normal/cost/Text&quot;, slot3), slot4)
	setText(slot0:findTF(&quot;no_gold/cost/Text&quot;, slot3), slot4)

	slot5, slot6 = slot0.activity:CanUpgradePlace(slot1.id)

	if slot5 then
		slot0.isShowPlaceTip = true
	end

	eachChild(slot3, function (slot0)
		setActive(slot0, slot0.name == uv0)
	end)
	onButton(slot0, slot0:findTF(&quot;normal&quot;, slot3), function ()
		if not uv0 or uv1.inPlaceAnim then
			return
		end

		uv1.upgradePlaceName = uv2.name

		uv1:emit(TownMediator.UPGRADE_WORKPLACE, uv3.id)
	end, SFX_PANEL)

	if slot6 == &quot;no_level&quot; then
		setText(slot0:findTF(&quot;no_level/Text&quot;, slot3), i18n(&quot;town_lock_level&quot;, &quot;LV&quot; .. slot1:GetNeedTownLv()))
	end
end

slot0.UpdatePlace = function(slot0, slot1, slot2)
	slot3 = slot0.placeList[slot1 + 1]
	slot2.name = slot1 + 1

	setImageSprite(slot0:findTF(&quot;info/icon&quot;, slot2), GetSpriteFromAtlas(&quot;ui/townui_atlas&quot;, slot3:GetIcon()), true)
	setText(slot0:findTF(&quot;info/name&quot;, slot2), slot3:GetName())
	setText(slot0:findTF(&quot;info/gold/Text&quot;, slot2), slot3:GetEffectStr())
	seriesAsync({
		function (slot0)
			if uv0.upgradePlaceName and uv1.name == uv0.upgradePlaceName then
				uv1:GetComponent(typeof(DftAniEvent)):SetEndEvent(function ()
					if uv0.townUpgradeCb then
						uv0.townUpgradeCb()

						uv0.townUpgradeCb = nil
					end

					uv0.inPlaceAnim = false

					uv1:SetEndEvent(nil)
				end)
				uv1:GetComponent(typeof(Animation)):Play(&quot;anim_cowboy_info_place_lvup&quot;)

				uv0.inPlaceAnim = true

				uv0:managedTween(LeanTween.delayedCall, function ()
					uv0()
				end, 0.2, nil)

				uv0.upgradePlaceName = nil

				return
			end

			slot0()
		end,
		function (slot0)
			slot2 = not uv0:GetNextId()

			setActive(uv1:findTF(&quot;next&quot;, uv2), not slot2)

			if not slot2 then
				setText(uv1:findTF(&quot;next/infos/exp/value&quot;, uv2), &quot;+&quot; .. uv0:GetAddExp())
				setText(uv1:findTF(&quot;next/infos/gold/value&quot;, uv2), TownWorkplace.New(slot1):GetEffectStr())
			end
		end
	}, function ()
	end)
	setActive(slot0:findTF(&quot;info/gold&quot;, slot2), slot3:GetGroup() ~= slot0.specialWorkGroup)
	setActive(slot0:findTF(&quot;next/infos/gold&quot;, slot2), slot3:GetGroup() ~= slot0.specialWorkGroup)
	slot0:UpdatePlaceStatus(slot3, slot2)
end

slot0.OnUpdateTime = function(slot0)
	slot0:UpdateTownStatus()

	slot0.isShowPlaceTip = false

	for slot4, slot5 in ipairs(slot0.placeList) do
		slot0:UpdatePlaceStatus(slot5, slot0:findTF(slot4, slot0.placeUIList.container))
	end

	setActive(slot0.placeTip, slot0.isShowPlaceTip)
end

slot0.OnDestroy = function(slot0)
end

return slot0
</code></pre>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-lua.min.js"></script>
</body>
</html>