<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>bosssingleprecombatmediator.lua</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
</head>
<body>
    <h1>bosssingleprecombatmediator.lua</h1>
    <a href="index.html">返回主页</a>
    <pre><code class="language-lua">slot0 = class(&quot;BossSinglePreCombatMediator&quot;, import(&quot;view.base.ContextMediator&quot;))
slot0.ON_START = &quot;PreCombatMediator:ON_START&quot;
slot0.ON_COMMIT_EDIT = &quot;PreCombatMediator:ON_COMMIT_EDIT&quot;
slot0.ON_ABORT_EDIT = &quot;PreCombatMediator:ON_ABORT_EDIT&quot;
slot0.OPEN_SHIP_INFO = &quot;PreCombatMediator:OPEN_SHIP_INFO&quot;
slot0.CHANGE_FLEET_SHIPS_ORDER = &quot;PreCombatMediator:CHANGE_FLEET_SHIPS_ORDER&quot;
slot0.BEGIN_STAGE_PROXY = &quot;PreCombatMediator:BEGIN_STAGE_PROXY&quot;
slot0.SHOW_CONTINUOUS_OPERATION_WINDOW = &quot;PreCombatMediator:SHOW_CONTINUOUS_OPERATION_WINDOW&quot;
slot0.CONTINUOUS_OPERATION = &quot;PreCombatMediator:CONTINUOUS_OPERATION&quot;
slot0.ON_AUTO = &quot;BossSinglePreCombatMediator:ON_AUTO&quot;
slot0.ON_SUB_AUTO = &quot;BossSinglePreCombatMediator:ON_SUB_AUTO&quot;

slot0.register = function(slot0)
	slot0:bindEvent()

	slot0.ships = getProxy(BayProxy):getRawData()

	slot0.viewComponent:SetShips(slot0.ships)

	slot2 = slot0.contextData.fleets
	slot0.fleets = slot2

	slot0.viewComponent:SetFleets(slot2)
	slot0.viewComponent:SetPlayerInfo(getProxy(PlayerProxy):getData())
	slot0.viewComponent:SetCurrentFleet(slot2[1].id)

	for slot9, slot10 in ipairs(slot2) do
		if slot10:isSubmarineFleet() and slot10:isLegalToFight() == true then
			slot0.viewComponent:SetSubFlag(true)

			break
		end
	end
end

slot0.bindEvent = function(slot0)
	slot1 = slot0.contextData.system

	slot2 = function()
		slot0 = 0

		for slot4, slot5 in ipairs(uv0.contextData.fleets) do
			slot6 = slot5:GetCostSum().oil

			if uv0.contextData.costLimit[slot4 == 1 and 1 or 2] &gt; 0 then
				slot6 = math.min(slot6, slot8)
			end

			slot0 = slot0 + slot6
		end

		return slot0
	end

	slot0:bind(uv0.ON_ABORT_EDIT, function (slot0)
	end)
	slot0:bind(uv0.ON_AUTO, function (slot0, slot1)
		uv0:onAutoBtn(slot1)
	end)
	slot0:bind(uv0.ON_SUB_AUTO, function (slot0, slot1)
		uv0:onAutoSubBtn(slot1)
	end)
	slot0:bind(uv0.CHANGE_FLEET_SHIPS_ORDER, function (slot0, slot1)
		uv0:refreshEdit(slot1)
	end)
	slot0:bind(uv0.OPEN_SHIP_INFO, function (slot0, slot1, slot2)
		uv0.contextData.form = PreCombatLayer.FORM_EDIT
		slot3 = {}

		for slot7, slot8 in ipairs(slot2:getShipIds()) do
			table.insert(slot3, uv0.ships[slot8])
		end

		uv0:sendNotification(GAME.GO_SCENE, SCENE.SHIPINFO, {
			shipId = slot1,
			shipVOs = slot3
		})
	end)
	slot0:bind(uv0.ON_COMMIT_EDIT, function (slot0, slot1)
		uv0:commitEdit(slot1)
	end)
	slot0:bind(uv0.ON_START, function (slot0, slot1, slot2)
		if getProxy(PlayerProxy):getRawData().oil &lt; uv0() then
			pg.TipsMgr.GetInstance():ShowTips(i18n(&quot;stage_beginStage_error_noResource&quot;))

			return
		end

		seriesAsync({
			function (slot0)
				if pg.battle_cost_template[uv0].enter_energy_cost == 0 then
					slot0()

					return
				end

				slot2, slot3 = nil
				slot3 = &quot;ship_energy_low_warn_no_exp&quot;
				slot4 = {}

				for slot8, slot9 in ipairs(uv1.fleets[1].ships) do
					table.insert(slot4, getProxy(BayProxy):getShipById(slot9))
				end

				Fleet.EnergyCheck(slot4, slot2:GetName(), function (slot0)
					if slot0 then
						uv0()
					end
				end, nil, slot3)
			end,
			function (slot0)
				if uv0.contextData.OnConfirm then
					uv0.contextData.OnConfirm(slot0)
				else
					slot0()
				end
			end,
			function ()
				uv0.viewComponent:emit(uv1.BEGIN_STAGE_PROXY, {
					curFleetId = uv2,
					continuousBattleTimes = uv3
				})
			end
		})
	end)
	slot0:bind(uv0.SHOW_CONTINUOUS_OPERATION_WINDOW, function (slot0, slot1)
		uv0:addSubLayers(Context.New({
			mediator = BossSingleContinuousOperationWindowMediator,
			viewComponent = BossSingleContinuousOperationWindow,
			data = {
				mainFleetId = slot1,
				stageId = uv0.contextData.stageId,
				system = uv0.contextData.system,
				oilCost = uv1()
			}
		}))
	end)
	slot0:bind(uv0.BEGIN_STAGE_PROXY, function (slot0, slot1)
		uv0:sendNotification(GAME.BEGIN_STAGE, {
			stageId = uv0.contextData.stageId,
			mainFleetId = slot1.curFleetId,
			system = uv0.contextData.system,
			actId = uv0.contextData.actId,
			variableBuffList = uv0.contextData.buffList,
			continuousBattleTimes = slot1.continuousBattleTimes,
			totalBattleTimes = slot1.continuousBattleTimes,
			useVariableTicket = uv0.contextData.useTicket and 1 or 0
		})
	end)
end

slot0.refreshEdit = function(slot0, slot1)
	slot2 = getProxy(FleetProxy)
	slot3 = slot0.contextData.actId

	slot2:updateActivityFleet(slot3, slot1.id, slot1)
	slot0.viewComponent:SetFleets(slot2:getActivityFleets()[slot3])
	slot0.viewComponent:UpdateFleetView(false)
end

slot0.commitEdit = function(slot0, slot1)
	getProxy(FleetProxy):commitActivityFleet(slot0.contextData.actId)
	slot1()
end

slot0.onAutoBtn = function(slot0, slot1)
	slot0:sendNotification(GAME.AUTO_BOT, {
		isActiveBot = slot1.isOn,
		toggle = slot1.toggle
	})
end

slot0.onAutoSubBtn = function(slot0, slot1)
	slot0:sendNotification(GAME.AUTO_SUB, {
		isActiveSub = slot1.isOn,
		toggle = slot1.toggle
	})
end

slot0.removeShipFromFleet = function(slot0, slot1, slot2)
	slot1:removeShip(slot2)

	return true
end

slot0.listNotificationInterests = function(slot0)
	return {
		GAME.BEGIN_STAGE_DONE,
		GAME.BEGIN_STAGE_ERRO,
		PreCombatMediator.BEGIN_STAGE_PROXY,
		uv0.CONTINUOUS_OPERATION
	}
end

slot0.handleNotification = function(slot0, slot1)
	slot3 = slot1:getBody()

	if slot1:getName() == GAME.BEGIN_STAGE_DONE then
		slot0:sendNotification(GAME.GO_SCENE, SCENE.COMBATLOAD, slot3)
	elseif slot2 == GAME.BEGIN_STAGE_ERRO then
		if slot3 == 3 then
			pg.MsgboxMgr.GetInstance():ShowMsgBox({
				hideNo = true,
				content = i18n(&quot;battle_preCombatMediator_timeout&quot;),
				onYes = function ()
					uv0.viewComponent:closeView()
				end
			})
		end
	elseif slot2 == PreCombatMediator.BEGIN_STAGE_PROXY then
		slot0.viewComponent:emit(PreCombatMediator.BEGIN_STAGE_PROXY, slot3)
	elseif slot2 == uv0.CONTINUOUS_OPERATION then
		slot0.viewComponent:emit(PreCombatMediator.ON_START, slot3.mainFleetId, slot3.battleTimes)
	end
end

return slot0
</code></pre>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-lua.min.js"></script>
</body>
</html>