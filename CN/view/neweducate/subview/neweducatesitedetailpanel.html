<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>neweducatesitedetailpanel.lua</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
</head>
<body>
    <h1>neweducatesitedetailpanel.lua</h1>
    <a href="index.html">返回主页</a>
    <pre><code class="language-lua">slot0 = class(&quot;NewEducateSiteDetailPanel&quot;, import(&quot;...base.BaseSubView&quot;))

slot0.getUIName = function(slot0)
	return &quot;NewEducateSiteDetailPanel&quot;
end

slot0.OnLoaded = function(slot0)
	slot0.rootTF = slot0._tf:Find(&quot;root&quot;)
	slot0.shopTF = slot0.rootTF:Find(&quot;shop&quot;)
	slot1 = slot0.shopTF:Find(&quot;goods/content&quot;)
	slot0.goodsUIList = UIItemList.New(slot1, slot1:Find(&quot;tpl&quot;))
	slot0.normalTF = slot0.rootTF:Find(&quot;normal&quot;)
	slot0.titleTF = slot0.normalTF:Find(&quot;title/Text&quot;)
	slot0.picTF = slot0.normalTF:Find(&quot;content/icon_bg/icon_mask/icon&quot;)
	slot0.nameTF = slot0.normalTF:Find(&quot;content/name&quot;)
	slot0.descTF = slot0.normalTF:Find(&quot;content/desc_view/mask/desc&quot;)
	slot2 = slot0.normalTF
	slot0.enterTF = slot2:Find(&quot;options/enter&quot;)

	setScrollText(slot0.normalTF:Find(&quot;options/exit/mask/Text&quot;), i18n(&quot;child2_site_exit&quot;))

	slot0.imageColorTFs = {
		slot0.normalTF:Find(&quot;title&quot;),
		slot0.normalTF:Find(&quot;line&quot;),
		slot0.normalTF:Find(&quot;content/azurlane&quot;),
		slot0.normalTF:Find(&quot;content/name/Image&quot;)
	}
end

slot0.OnInit = function(slot0)
	slot3 = slot0.rootTF

	onButton(slot0, slot3:Find(&quot;bg&quot;), function ()
		uv0:Hide()
	end, SFX_PANEL)

	slot3 = slot0.shopTF

	onButton(slot0, slot3:Find(&quot;close_btn&quot;), function ()
		uv0:Hide()
	end, SFX_PANEL)

	slot3 = slot0.normalTF

	onButton(slot0, slot3:Find(&quot;close_btn&quot;), function ()
		uv0:Hide()
	end, SFX_PANEL)

	slot3 = slot0.normalTF

	onButton(slot0, slot3:Find(&quot;options/exit&quot;), function ()
		uv0:Hide()
	end, SFX_PANEL)

	slot1 = slot0.goodsUIList

	slot1:make(function (slot0, slot1, slot2)
		if slot0 == UIItemList.EventUpdate then
			uv0:UpdateGoodsItem(slot1, slot2)
		end
	end)
end

slot0.Show = function(slot0, slot1)
	uv0.super.Show(slot0)

	slot0.siteId = slot1

	slot0:Flush()
end

slot0.Flush = function(slot0)
	if pg.child2_site_display[slot0.siteId].type == NewEducateConst.SITE_TYPE.SHOP then
		setText(slot0.shopTF:Find(&quot;title&quot;), slot1.title)
		slot0:ShowShop()
	else
		slot0:ShowNormal(slot1)
	end
end

slot0.UpdateCost = function(slot0, slot1, slot2)
	LoadImageSpriteAsync(&quot;neweducateicon/&quot; .. NewEducateHelper.GetDropConfig(slot2).icon, slot1:Find(&quot;Image&quot;))
	setText(slot1:Find(&quot;Text&quot;), &quot;-&quot; .. slot2.number)
end

slot0.ShowNormal = function(slot0, slot1)
	setActive(slot0.shopTF, false)
	setActive(slot0.normalTF, true)
	setText(slot0.titleTF, slot1.title)
	LoadImageSpriteAsync(&quot;neweducateicon/&quot; .. slot1.banner, slot0.picTF, true)
	setText(slot0.nameTF, slot1.title)
	setText(slot0.descTF, slot1.desc)

	slot2, slot3 = NewEducateHelper.GetSiteColors(slot1.id)

	setTextColor(slot0.nameTF, slot3)
	underscore.each(slot0.imageColorTFs, function (slot0)
		setImageColor(slot0, uv0)
	end)

	slot4 = {}

	slot6 = function()
	end

	switch(slot1.type, {
		[NewEducateConst.SITE_TYPE.WORK] = function ()
			slot1 = pg.child2_site_normal[uv0.contextData.char:GetNormalIdByType(NewEducateConst.SITE_NORMAL_TYPE.WORK)]
			uv1 = slot1.title
			uv2 = NewEducateHelper.Config2Drop(slot1.cost)

			uv3 = function()
				uv0:emit(NewEducateMapMediator.ON_SITE_NORMAL, uv1.id)
			end
		end,
		[NewEducateConst.SITE_TYPE.TRAVEL] = function ()
			slot1 = pg.child2_site_normal[uv0.contextData.char:GetNormalIdByType(NewEducateConst.SITE_NORMAL_TYPE.TRAVEL)]
			uv1 = slot1.title
			uv2 = NewEducateHelper.Config2Drop(slot1.cost)

			uv3 = function()
				uv0:emit(NewEducateMapMediator.ON_SITE_NORMAL, uv1.id)
			end
		end,
		[NewEducateConst.SITE_TYPE.SHIP] = function ()
			slot0 = pg.child2_site_character[uv0.param]
			uv1 = slot0.option_name
			uv2 = NewEducateHelper.Config2Drop(slot0.cost)

			uv3 = function()
				uv0:emit(NewEducateMapMediator.ON_SITE_SHIP, uv1.id)
			end
		end,
		[NewEducateConst.SITE_TYPE.EVENT] = function ()
			slot0 = pg.child2_site_event_group[uv0.param]
			uv1 = slot0.option_word
			uv2 = NewEducateHelper.Config2Drop(slot0.event_cost)

			uv3 = function()
				uv0:emit(NewEducateMapMediator.ON_SITE_EVENT, uv1.id)
			end
		end
	})
	setScrollText(slot0.enterTF:Find(&quot;mask/Text&quot;), &quot;&quot;)
	slot0:UpdateCost(slot0.enterTF:Find(&quot;cost&quot;), slot4)

	slot4.operator = &quot;&gt;=&quot;

	setImageColor(slot0.enterTF, Color.NewHex(not slot0.contextData.char:IsMatch(slot4) and &quot;C8CAD5&quot; or &quot;FFFFFF&quot;))
	setTextColor(slot0.enterTF:Find(&quot;mask/Text&quot;), Color.NewHex(slot7 and &quot;717171&quot; or &quot;393A3C&quot;))

	if not slot7 then
		onButton(slot0, slot0.enterTF, function ()
			uv0()
			uv1:Hide(true)
		end, SFX_PANEL)
	else
		removeOnButton(slot0.enterTF)
	end
end

slot0.ShowShop = function(slot0)
	slot0.discountInfos = slot0.contextData.char:GetGoodsDiscountInfos()
	slot0.goods = slot0.contextData.char:GetFSM():GetState(NewEducateFSM.STYSTEM.MAP):GetGoodList()

	table.sort(slot0.goods, CompareFuncs({
		function (slot0)
			slot1 = pg.child2_shop[slot0.id].limit_num

			return slot0:GetRemainCnt() &gt; 0 and 0 or 1
		end,
		function (slot0)
			return slot0:IsLimitCnt() and 0 or 1
		end,
		function (slot0)
			return slot0.id
		end
	}))
	setActive(slot0.shopTF, true)
	setActive(slot0.normalTF, false)
	slot0.goodsUIList:align(#slot0.goods)
end

slot0.UpdateGoodsItem = function(slot0, slot1, slot2)
	slot3 = slot0.goods[slot1 + 1]
	slot2.name = slot3.id

	LoadImageSpriteAsync(&quot;neweducateicon/&quot; .. slot3:getConfig(&quot;icon&quot;), slot2:Find(&quot;frame/icon&quot;))
	setText(slot2:Find(&quot;name&quot;), slot3:getConfig(&quot;name&quot;))
	setText(slot2:Find(&quot;frame/count_bg/count&quot;), &quot;x&quot; .. slot3:getConfig(&quot;goods_num&quot;))
	setText(slot2:Find(&quot;desc&quot;), slot3:getConfig(&quot;desc&quot;))
	setActive(slot2:Find(&quot;limit_time&quot;), slot3:IsLimitTime())
	setActive(slot2:Find(&quot;limit_cnt&quot;), slot3:IsLimitCnt())

	if slot3:IsLimitCnt() then
		setText(slot2:Find(&quot;limit_cnt&quot;), i18n(&quot;child2_shop_limit_cnt&quot;) .. slot3:GetRemainCnt() .. &quot;/&quot; .. slot3:GetLimitCnt())
	end

	slot4 = slot3:GetRemainCnt() &lt;= 0

	setActive(slot2:Find(&quot;sold_out&quot;), slot4)
	setText(slot2:Find(&quot;price&quot;), slot5.number .. (slot3:GetCostWithBenefit(slot0.discountInfos).number ~= slot3:GetCostCondition().number and &quot;(&quot; .. slot6.number .. &quot;)&quot; or &quot;&quot;))

	if slot4 then
		removeOnButton(slot2)
	else
		slot8 = slot0.contextData.char
		slot8 = slot8:IsMatch(slot6)

		onButton(slot0, slot2, function ()
			if uv0 then
				uv1:emit(NewEducateBaseUI.ON_SHOP, {
					shopId = uv2.id,
					price = uv3.number,
					onBuy = function ()
						uv0:OnClickBuy(uv1)
					end
				})
			else
				pg.TipsMgr.GetInstance():ShowTips(i18n(&quot;common_no_resource&quot;))
			end
		end, SFX_PANEL)
	end
end

slot0.OnClickBuy = function(slot0, slot1)
	seriesAsync({
		function (slot0)
			slot1, slot2, slot3 = uv0:CheckBenefit(uv1)

			if slot1 then
				uv0:emit(NewEducateBaseUI.ON_BOX, {
					content = i18n(slot3, slot2),
					onYes = slot0
				})
			else
				slot0()
			end
		end,
		function (slot0)
			if uv0:CheckPoint(uv1) then
				uv0:emit(NewEducateBaseUI.ON_BOX, {
					content = i18n(&quot;child2_shop_point_sure&quot;),
					onYes = slot0
				})
			else
				slot0()
			end
		end
	}, function ()
		uv0:emit(NewEducateMapMediator.ON_SHOPPING, uv1.id)
	end)
end

slot0.CheckBenefit = function(slot0, slot1)
	if slot1:IsBenefitType() then
		if slot0.contextData.char:GetStatus(slot1:getConfig(&quot;goods_id&quot;)) and slot2:getConfig(&quot;is_tip&quot;) == 0 then
			return true, slot2:GetEndRound() - slot0.contextData.char:GetRoundData().round, slot2:getConfig(&quot;during_time&quot;) == -1 and &quot;child2_shop_benefit_sure2&quot; or &quot;child2_shop_benefit_sure&quot;
		else
			return false
		end
	end

	return false
end

slot0.CheckPoint = function(slot0, slot1)
	if slot1:IsResType() then
		if slot1:getConfig(&quot;goods_id&quot;) == slot0.contextData.char:GetResIdByType(NewEducateChar.RES_TYPE.ACTION) then
			if pg.child2_resource[slot2].max_value &lt; slot0.contextData.char:GetPoint(slot2) + slot1:getConfig(&quot;goods_num&quot;) then
				return true
			else
				return false
			end
		else
			return false
		end
	end

	return false
end

slot0.FlushShop = function(slot0)
	slot0:ShowShop()
end

slot0.Hide = function(slot0, slot1)
	if not slot1 then
		existCall(slot0.contextData.onHide)
	end

	slot0.super.Hide(slot0)
end

slot0.OnDestroy = function(slot0)
end

return slot0
</code></pre>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-lua.min.js"></script>
</body>
</html>