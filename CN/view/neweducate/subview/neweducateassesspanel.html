<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>neweducateassesspanel.lua</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
</head>
<body>
    <h1>neweducateassesspanel.lua</h1>
    <a href="index.html">返回主页</a>
    <pre><code class="language-lua">slot0 = class(&quot;NewEducateAssessPanel&quot;, import(&quot;view.base.BaseSubView&quot;))
slot0.CRIT_PERCENT = 200
slot0.SPEED = 3

slot0.getUIName = function(slot0)
	return &quot;NewEducateAssessPanel&quot;
end

slot0.OnLoaded = function(slot0)
	slot0.rootTF = slot0._tf:Find(&quot;root&quot;)
	slot0.assessTF = slot0.rootTF:Find(&quot;assess&quot;)
	slot0.bgTF = slot0.assessTF:Find(&quot;bg&quot;)
	slot0.damageBlood = slot0.assessTF:Find(&quot;content/blood/red&quot;)
	slot0.bossTF = slot0.assessTF:Find(&quot;content/boss&quot;)
	slot0.roleTF = slot0.assessTF:Find(&quot;content/role&quot;)
	slot0.damageTF = slot0.assessTF:Find(&quot;content/damage&quot;)
	slot0.damageCritTF = slot0.assessTF:Find(&quot;content/damage_crit&quot;)
	slot1 = slot0.assessTF:Find(&quot;content/attrs&quot;)
	slot0.attrUIList = UIItemList.New(slot1, slot1:Find(&quot;tpl&quot;))
	slot0.resultTF = slot0.assessTF:Find(&quot;content/result&quot;)
	slot0.rankTF = slot0.resultTF:Find(&quot;rank&quot;)
	slot0.tipTF = slot0.rootTF:Find(&quot;tip&quot;)
	slot0.assessTextTF = slot0.tipTF:Find(&quot;content/assess/Text&quot;)
	slot0.targetTextTF = slot0.tipTF:Find(&quot;content/target/Text&quot;)
end

slot0.OnInit = function(slot0)
	onButton(slot0, slot0._tf, function ()
		uv0:AdjustSpeed()
	end, SFX_PANEL)

	slot1 = slot0.attrUIList

	slot1:make(function (slot0, slot1, slot2)
		if slot0 == UIItemList.EventInit then
			slot3 = uv0.attrIds[slot1 + 1]
			slot2.name = slot3
			slot4 = pg.child2_attr[slot3].icon

			LoadImageSpriteAtlasAsync(&quot;ui/neweducateassesspanel_atlas&quot;, slot4, slot2)
			LoadImageSpriteAtlasAsync(&quot;ui/neweducateassesspanel_atlas&quot;, slot4 .. &quot;_l&quot;, slot2:Find(&quot;selected&quot;))
		elseif slot0 == UIItemList.EventUpdate then
			setActive(slot2:Find(&quot;selected&quot;), uv0.curAttrIdx == slot1 + 1)
			setText(slot2:Find(&quot;value&quot;), uv0.contextData.char:GetAttr(uv0.attrIds[slot1 + 1]))
			setTextColor(slot2:Find(&quot;value&quot;), Color.NewHex(uv0.curAttrIdx == slot1 + 1 and &quot;47b9f4&quot; or &quot;6f6f82&quot;))
		end
	end)
end

slot0.Show = function(slot0, slot1)
	uv0.super.Show(slot0)

	slot0.callback = slot1

	pg.UIMgr.GetInstance():OverlayPanel(slot0._tf, {
		groupName = LayerWeightConst.GROUP_EDUCATE,
		weight = LayerWeightConst.BASE_LAYER + 1
	})
	slot0:InitData()
	slot0:InitStaticUI()
	slot0:PlayAnim()
end

slot0.InitData = function(slot0)
	slot0.speed = 1
	slot1 = slot0.contextData.char:GetRoundData()
	slot2 = pg.child2_target[slot1:getConfig(&quot;target_id&quot;)]
	slot0.rank = slot2.display[slot0.contextData.char:GetAssessRankIdx()]
	slot0.totolHP = slot2.attr_sum
	slot0.damageHP = 0
	slot0.attrIds = slot0.contextData.char:GetAttrIds()
	slot0.curAttrIdx = 1
	slot0.tag = slot0.contextData.char:GetPersonalityTag()
	slot0.charConfig = slot0.contextData.char:getConfig(&quot;spine_char&quot;)
	slot0.standardValue = slot0.totolHP / #slot0.attrIds
	slot0.actionConfig = {}

	underscore.each(slot0.contextData.char:getConfig(&quot;exam_action&quot;)[slot0.tag], function (slot0)
		table.insert(uv0.actionConfig, {
			value = uv0.standardValue * slot0[1] / 100,
			name = slot0[2]
		})
	end)
	table.sort(slot0.actionConfig, CompareFuncs({
		function (slot0)
			return -slot0.value
		end
	}))

	slot4, slot5, slot6 = slot1:GetProgressInfo()

	setText(slot0.assessTextTF, i18n(&quot;child2_assess_start_tip&quot;))
	setText(slot0.targetTextTF, i18n(&quot;child2_assess_tip_target&quot;, slot6))
end

slot0.GetAtkActionName = function(slot0, slot1)
	for slot5, slot6 in ipairs(slot0.actionConfig) do
		if slot6.value &lt; slot1 then
			return slot6.name
		end
	end

	return slot0.actionConfig[#slot0.actionConfig].name
end

slot0.InitStaticUI = function(slot0)
	LoadImageSpriteAtlasAsync(&quot;ui/neweducateassesspanel_atlas&quot;, &quot;bg_&quot; .. slot0.tag, slot0.bgTF)
	removeAllChildren(slot0.bossTF)
	removeAllChildren(slot0.roleTF)
	setActive(slot0.resultTF, false)
	setActive(slot0.damageTF, false)
	setActive(slot0.damageCritTF, false)
	setActive(slot0.resultTF:Find(&quot;title_gold&quot;), slot0.rank == &quot;S&quot;)
	setActive(slot0.resultTF:Find(&quot;title_red&quot;), slot0.rank ~= &quot;S&quot;)
	LoadImageSpriteAtlasAsync(&quot;ui/neweducateassesspanel_atlas&quot;, slot0.rank, slot0.rankTF)
	setFillAmount(slot0.damageBlood, 0)
	table.sort(slot0.attrIds)
	slot0.attrUIList:align(#slot0.attrIds)
end

slot0.ShowResult = function(slot0)
	setActive(slot0.resultTF, true)

	slot1 = slot0.contextData.char

	slot0:emit(NewEducateMainMediator.ON_SET_ASSESS_RANK, slot1:GetAssessRankIdx(), function ()
		existCall(uv0.callback)
	end)
end

slot0.PlayAnim = function(slot0)
	seriesAsync({
		function (slot0)
			uv0:ShowTip(slot0)
		end,
		function (slot0)
			uv0:LoadChar(slot0)
		end,
		function (slot0)
			uv0:CheckGuide(slot0)
		end,
		function (slot0)
			uv0:PlayOneATK(slot0)
		end
	}, function ()
		uv0:ShowResult()
	end)
end

slot0.ShowTip = function(slot0, slot1)
	setActive(slot0.assessTF, false)
	setActive(slot0.tipTF, true)
	onDelayTick(function ()
		setActive(uv0.tipTF, false)
		setActive(uv0.assessTF, true)
		uv1()
	end, 1)
end

slot0.CheckGuide = function(slot0, slot1)
	if pg.NewStoryMgr.GetInstance():IsPlayed(&quot;tb2_12&quot;) then
		slot1(slot1)
	else
		pg.m02:sendNotification(GAME.STORY_UPDATE, {
			storyId = &quot;tb2_12&quot;
		})
		pg.NewGuideMgr.GetInstance():Play(&quot;tb2_12&quot;, {}, slot1, slot1)
	end
end

slot0.LoadChar = function(slot0, slot1)
	slot2 = pg.UIMgr.GetInstance()

	slot2:LoadingOn()
	seriesAsync({
		function (slot0)
			slot1 = PoolMgr.GetInstance()

			slot1:GetSpineChar(uv0.charConfig.boss, true, function (slot0)
				uv0.bossName = uv0.charConfig.boss
				uv0.bossModel = slot0
				tf(slot0).localScale = Vector3(1, 1, 1)

				slot0:GetComponent(&quot;SpineAnimUI&quot;):SetAction(&quot;child2_boss_normal&quot;, 0)
				setParent(slot0, uv0.bossTF)
				uv1()
			end)
		end,
		function (slot0)
			slot1 = PoolMgr.GetInstance()

			slot1:GetSpineChar(uv0.charConfig[uv0.tag], true, function (slot0)
				uv0.roleName = uv0.charConfig[uv0.tag]
				uv0.roleModel = slot0
				tf(slot0).localScale = Vector3(1, 1, 1)

				slot0:GetComponent(&quot;SpineAnimUI&quot;):SetAction(uv0.roleName .. &quot;_normal&quot;, 0)
				setParent(slot0, uv0.roleTF)
				uv1()
			end)
		end
	}, function ()
		pg.UIMgr.GetInstance():LoadingOff()
		existCall(uv0)
	end)
end

slot0.PlayOneATK = function(slot0, slot1)
	slot3 = slot0.contextData.char:GetAttr(slot0.attrIds[slot0.curAttrIdx])
	slot0.damageHP = slot0.damageHP + slot3
	slot4 = slot0:GetAtkActionName(slot3)

	setText(slot3 &gt;= slot0.standardValue * uv0.CRIT_PERCENT / 100 and slot0.damageCritTF or slot0.damageTF, &quot;-&quot; .. slot3)

	slot7 = slot0.bossModel:GetComponent(typeof(SpineAnimUI))

	slot7:Resume()
	slot7:SetAction(&quot;child2_boss_normal&quot;, 0)
	slot0.roleModel:GetComponent(typeof(SpineAnimUI)):SetAction(slot0.roleName .. &quot;_normal&quot;, 0)
	seriesAsync({
		function (slot0)
			uv0.attrUIList:align(#uv0.attrIds)
			blinkAni(uv0.attrUIList.container:Find(tostring(uv1)), 0.2 / uv0.speed, 3)
			uv0:managedTween(LeanTween.delayedCall, function ()
				uv0()
			end, 1 / uv0.speed, nil)
		end,
		function (slot0)
			uv0:SetActionCallBack(function (slot0)
				if slot0 == &quot;finish&quot; then
					uv0()
					uv1:SetActionCallBack(nil)
					uv1:SetAction(uv2.roleName .. &quot;_normal&quot;, 0)
				end
			end)
			uv0:SetAction(uv2, 0)
		end,
		function (slot0)
			setActive(uv0, true)
			setFillAmount(uv1.damageBlood, math.min(uv1.damageHP / uv1.totolHP, 1))

			if uv1.damageHP &lt; uv1.totolHP then
				uv2:SetActionCallBack(function (slot0)
					if slot0 == &quot;finish&quot; then
						setActive(uv0, false)
						uv1()
						uv2:SetActionCallBack(nil)
						uv2:SetAction(&quot;child2_boss_normal&quot;, 0)
					end
				end)
				uv2:SetAction(&quot;child2_boss_shouji&quot;, 0)
			else
				uv2:SetActionCallBack(function (slot0)
					if slot0 == &quot;finish&quot; then
						setActive(uv0, false)
						uv1()
						uv2:SetActionCallBack(nil)
						uv2:Pause()
					end
				end)
				uv2:SetAction(&quot;child2_boss_jidao&quot;, 0)
			end
		end
	}, function ()
		if uv0.totolHP &lt;= uv0.damageHP or uv0.curAttrIdx == #uv0.attrIds then
			uv1()
		else
			uv0.curAttrIdx = uv0.curAttrIdx + 1

			uv0:managedTween(LeanTween.delayedCall, function ()
				uv0:PlayOneATK(uv1)
			end, 0.5 / uv0.speed, nil)
		end
	end)
end

slot0.AdjustSpeed = function(slot0)
	slot0.speed = uv0.SPEED

	if slot0.bossModel then
		slot0:GetAnimationState(slot0.bossModel).TimeScale = slot0.speed
	end

	if slot0.roleModel then
		slot0:GetAnimationState(slot0.roleModel).TimeScale = slot0.speed
	end
end

slot0.GetAnimationState = function(slot0, slot1)
	return slot1:GetComponent(&quot;Spine.Unity.SkeletonGraphic&quot;).AnimationState
end

slot0.Hide = function(slot0)
	pg.UIMgr.GetInstance():UnOverlayPanel(slot0._tf)

	if slot0.bossName and slot0.bossModel then
		slot0:GetAnimationState(slot0.bossModel).TimeScale = 1

		PoolMgr.GetInstance():ReturnSpineChar(slot0.bossName, slot0.bossModel)

		slot0.bossName = nil
		slot0.bossModel = nil
	end

	if slot0.roleName and slot0.roleModel then
		slot0:GetAnimationState(slot0.roleModel).TimeScale = 1

		PoolMgr.GetInstance():ReturnSpineChar(slot0.roleName, slot0.roleModel)

		slot0.roleName = nil
		slot0.roleModel = nil
	end

	uv0.super.Hide(slot0)
end

slot0.OnDestroy = function(slot0)
end

return slot0
</code></pre>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-lua.min.js"></script>
</body>
</html>