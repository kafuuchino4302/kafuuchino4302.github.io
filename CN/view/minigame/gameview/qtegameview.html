<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>qtegameview.lua</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
</head>
<body>
    <h1>qtegameview.lua</h1>
    <a href="index.html">返回主页</a>
    <pre><code class="language-lua">slot0 = class(&quot;QTEGameView&quot;, import(&quot;..BaseMiniGameView&quot;))

slot0.getUIName = function(slot0)
	return &quot;QTEGameUI&quot;
end

slot0.init = function(slot0)
	slot0.STATE_BEGIN = 1
	slot0.STATE_COUNT = 2
	slot0.STATE_CLICK = 3
	slot0.STATE_SHOW = 4
	slot0.STATE_END = 5
	slot0.gameState = -1
	slot0.typeNum = 3
	slot0.idNum = 3
	slot0.limitNum = 5
	slot0.TYPE_A = 1
	slot0.TYPE_B = 2
	slot0.TYPE_C = 3
	slot0.ITEM_ID_1 = 1
	slot0.ITEM_ID_2 = 2
	slot0.ITEM_ID_3 = 3
	slot0.startUI = slot0:findTF(&quot;start_ui&quot;)
	slot0.startBtn = slot0:findTF(&quot;start_btn&quot;, slot0.startUI)
	slot0.ruleBtn = slot0:findTF(&quot;rule_btn&quot;, slot0.startUI)
	slot0.qBtn = slot0:findTF(&quot;q_btn&quot;, slot0.startUI)
	slot0.countUI = slot0:findTF(&quot;count_ui&quot;)
	slot0.countNumTxt = slot0:findTF(&quot;num&quot;, slot0.countUI)
	slot0.endUI = slot0:findTF(&quot;end_ui&quot;)
	slot0.endExitBtn = slot0:findTF(&quot;exit_btn&quot;, slot0.endUI)
	slot0.endBestTxt = slot0:findTF(&quot;rope/paper/best_txt&quot;, slot0.endUI)
	slot0.endScoreTxt = slot0:findTF(&quot;rope/paper/score_txt&quot;, slot0.endUI)
	slot0.endComboTxt = slot0:findTF(&quot;rope/paper/combo_txt&quot;, slot0.endUI)
	slot0.endMissTxt = slot0:findTF(&quot;rope/paper/miss_txt&quot;, slot0.endUI)
	slot0.endHitTxt = slot0:findTF(&quot;rope/paper/hit_txt&quot;, slot0.endUI)
	slot0.endUIEvent = slot0:findTF(&quot;rope&quot;, slot0.endUI):GetComponent(&quot;DftAniEvent&quot;)
	slot0.content = slot0:findTF(&quot;content&quot;)
	slot0.res = slot0:findTF(&quot;res&quot;)
	slot0.gameBg = slot0:findTF(&quot;game_bg&quot;, slot0.content)
	slot0.xgmPos = slot0:findTF(&quot;xiongguimao_pos&quot;, slot0.content)
	slot0.guinuPos = slot0:findTF(&quot;guinu_pos&quot;, slot0.content)
	slot0.bucketA = slot0:findTF(&quot;content/bucket_A&quot;)
	slot0.bucketASpine = slot0.bucketA:GetComponent(&quot;SpineAnimUI&quot;)
	slot0.bucketAGraphic = slot0.bucketA:GetComponent(&quot;SkeletonGraphic&quot;)
	slot0.bucketB = slot0:findTF(&quot;content/bucket_B&quot;)
	slot0.bucketBSpine = slot0.bucketB:GetComponent(&quot;SpineAnimUI&quot;)
	slot0.bucketBGraphic = slot0.bucketB:GetComponent(&quot;SkeletonGraphic&quot;)
	slot0.bucketC = slot0:findTF(&quot;content/bucket_C&quot;)
	slot0.msHand = slot0:findTF(&quot;ani&quot;, slot0.bucketC)
	slot0.msHandAnimator = slot0.msHand:GetComponent(&quot;Animator&quot;)
	slot0.msHandSlot = slot0:findTF(&quot;slot&quot;, slot0.msHand)
	slot0.msHandEvent = slot0.msHand:GetComponent(&quot;DftAniEvent&quot;)
	slot0.msBlockList = {}

	slot0.msHandEvent:SetEndEvent(function ()
		uv0:msClearHold()
		setActive(uv0.msHand, false)
	end)

	slot0.xgmAnimLength = {
		idle = 1,
		attack = 1
	}
	slot0.xgmAnimTargetLength = {
		idle = 1,
		attack = 0.5
	}
	slot0.guinuAnimLength = {
		action = 1.333,
		normal = 4.667
	}
	slot0.guinuAnimTargetLength = {
		action = 0.5,
		normal = 4.667
	}
	slot0.bucketAAnimLength = {
		idle = 0.167,
		attack = 0.8
	}
	slot0.bucketAAnimTargetLength = {
		idle = 1,
		attack = 0.6
	}
	slot0.bucketBAnimLength = {
		idle = 0.167,
		attack = 0.8
	}
	slot0.bucketBAnimTargetLength = {
		idle = 1,
		attack = 0.6
	}
	slot0.cut1 = slot0:findTF(&quot;cut_1&quot;, slot0.bucketB)
	slot0.cut2 = slot0:findTF(&quot;cut_2&quot;, slot0.bucketB)
	slot0.cut3 = slot0:findTF(&quot;cut_3&quot;, slot0.bucketB)
	slot0.cut1Animator = slot0.cut1:GetComponent(&quot;Animator&quot;)
	slot0.cut2Animator = slot0.cut2:GetComponent(&quot;Animator&quot;)
	slot0.cut3Animator = slot0.cut3:GetComponent(&quot;Animator&quot;)
	slot0.cut1Event = slot0.cut1:GetComponent(&quot;DftAniEvent&quot;)
	slot0.cut2Event = slot0.cut2:GetComponent(&quot;DftAniEvent&quot;)
	slot0.cut3Event = slot0.cut3:GetComponent(&quot;DftAniEvent&quot;)

	slot0.cut1Event:SetEndEvent(function ()
		setActive(uv0.cut1, false)
	end)
	slot0.cut2Event:SetEndEvent(function ()
		setActive(uv0.cut2, false)
	end)
	slot0.cut3Event:SetEndEvent(function ()
		setActive(uv0.cut3, false)
	end)

	slot0.keyUI = slot0:findTF(&quot;key_ui&quot;, slot0.content)
	slot0.keyBar = slot0:findTF(&quot;key_bar&quot;, slot0.keyUI)
	slot0.aBtn = slot0:findTF(&quot;A_btn&quot;, slot0.keyUI)
	slot0.bBtn = slot0:findTF(&quot;B_btn&quot;, slot0.keyUI)
	slot0.cBtn = slot0:findTF(&quot;C_btn&quot;, slot0.keyUI)
	slot0.comboAni = slot0:findTF(&quot;combo_bar/center&quot;, slot0.content):GetComponent(&quot;Animator&quot;)
	slot0.comboTxt = slot0:findTF(&quot;combo_bar/center/combo_txt&quot;, slot0.content)
	slot0.comboAni.enabled = false
	slot0.scoreTxt = slot0:findTF(&quot;score_bar/txt&quot;, slot0.content)
	slot0.remainTxt = slot0:findTF(&quot;remain_time_bar/txt&quot;, slot0.content)

	pg.UIMgr.GetInstance():OverlayPanelPB(slot0.keyBar, {
		pbList = {
			slot0.keyBar
		}
	})

	slot0.roundTxt = slot0:findTF(&quot;round_time_bar/txt&quot;, slot0.keyUI)
	slot0.firePos = slot0:findTF(&quot;content/pos/fire_pos&quot;).anchoredPosition
	slot0.hitPos = slot0:findTF(&quot;content/pos/hit_pos&quot;).anchoredPosition
	slot0.aPos = slot0:findTF(&quot;content/pos/a_pos&quot;).anchoredPosition
	slot0.bPos = slot0:findTF(&quot;content/pos/b_pos&quot;).anchoredPosition
	slot0.cPos = slot0:findTF(&quot;content/pos/c_pos&quot;).anchoredPosition
	slot0.missPos = slot0:findTF(&quot;content/pos/miss_pos&quot;).anchoredPosition
	slot0.backBtn = slot0:findTF(&quot;back_btn&quot;, slot0.content)
	slot0.autoLoader = AutoLoader.New()

	slot0.autoLoader:LoadSprite(&quot;ui/minigameui/qtegameuiasync_atlas&quot;, &quot;background&quot;, slot0.gameBg, false)
end

slot0.didEnter = function(slot0)
	slot0:initGame()
	onButton(slot0, slot0.backBtn, function ()
		uv0:setGameState(uv0.STATE_BEGIN)
	end, SFX_PANEL)
	onButton(slot0, slot0.qBtn, function ()
		uv0:emit(uv1.ON_BACK)
	end, SFX_PANEL)
	onButton(slot0, slot0.ruleBtn, function ()
		pg.MsgboxMgr.GetInstance():ShowMsgBox({
			type = MSGBOX_TYPE_HELP,
			helps = pg.gametip.qte_game_help.tip,
			weight = LayerWeightConst.THIRD_LAYER
		})
	end)
	onButton(slot0, slot0.startBtn, function ()
		setButtonEnabled(uv0.startBtn, false)
		parallelAsync({
			function (slot0)
				uv0:loadXGM(slot0)
			end,
			function (slot0)
				uv0:loadGuinu(slot0)
			end
		}, function ()
			uv0:setGameState(uv0.STATE_COUNT)
		end)
	end, SFX_PANEL)

	if QTEGAME_DEBUG then
		onButton(slot0, slot0.xgm, function ()
			uv0:setGameState(uv0.STATE_SHOW)
		end)
	end

	onButton(slot0, slot0.endExitBtn, function ()
		uv0:emit(uv1.ON_BACK)
	end, SFX_PANEL)
	slot0.endUIEvent:SetEndEvent(function ()
		if uv0:GetMGHubData().count &gt; 0 then
			uv0:SendSuccess(0)
		end

		setActive(uv0.endExitBtn, true)
	end)

	slot1 = function(slot0)
		if uv0.gameState == uv0.STATE_CLICK and uv0.curShowBlock then
			uv0.curShowBlock:select(slot0)

			uv0.curShowBlock = uv0.curShowBlock.nextBlock

			if uv0.curShowBlock == nil then
				uv0:managedTween(LeanTween.delayedCall, function ()
					uv0:setGameState(uv0.STATE_SHOW)
				end, 0.2, nil)
			end
		end
	end

	onButton(slot0, slot0.aBtn, function ()
		uv0(uv1.TYPE_A)
	end, SFX_PANEL)
	onButton(slot0, slot0.bBtn, function ()
		uv0(uv1.TYPE_B)
	end, SFX_PANEL)
	onButton(slot0, slot0.cBtn, function ()
		uv0(uv1.TYPE_C)
	end, SFX_PANEL)
	slot0:setGameState(slot0.STATE_BEGIN)
	slot0:checkHelp()
end

slot0.initGame = function(slot0)
	slot0.curShowBlock = nil
	slot0.randomBlockList = nil
	slot1 = slot0:GetMGData()
	slot0.scorePerHit = slot1:GetSimpleValue(&quot;scorePerHit&quot;)
	slot1 = slot0:GetMGData()
	slot0.comboRange = slot1:GetSimpleValue(&quot;comboRange&quot;)
	slot1 = slot0:GetMGData()
	slot0.comboAddScore = slot1:GetSimpleValue(&quot;comboAddScore&quot;)
	slot1 = slot0:GetMGData()
	slot0.targetCombo = slot1:GetSimpleValue(&quot;targetCombo&quot;)
	slot1 = slot0:GetMGData()
	slot0.targetComboScore = slot1:GetSimpleValue(&quot;targetComboScore&quot;)
	slot0.usingBlockList = {}
	slot0.blockUniId = 0

	slot0:resetGame()

	slot1 = slot0.bucketASpine

	slot1:SetActionCallBack(function (slot0)
		if slot0 == &quot;FINISH&quot; then
			uv0:setBucketAAction(&quot;idle&quot;)
		end
	end)

	slot1 = slot0.bucketBSpine

	slot1:SetActionCallBack(function (slot0)
		if slot0 == &quot;FINISH&quot; then
			uv0:setBucketBAction(&quot;idle&quot;)
		end
	end)
end

slot0.resetGame = function(slot0)
	slot0:setXgmAction(&quot;idle&quot;)
	slot0:setGuinuAction(&quot;normal&quot;)
	slot0:setBucketAAction(&quot;idle&quot;)
	slot0:setBucketBAction(&quot;idle&quot;)
	setActive(slot0.msHand, false)

	slot0.score = 0
	slot0.bestComboNum = 0
	slot0.comboNum = 0
	slot0.missNum = 0
	slot0.hitNum = 0
	slot0.remainTime = slot0:GetMGData():GetSimpleValue(&quot;gameTime&quot;)
	slot0.roundTime = slot0:GetMGData():GetSimpleValue(&quot;roundTime&quot;)

	setText(slot0.comboTxt, 0)
	setText(slot0.scoreTxt, 0)
	setText(slot0.remainTxt, slot0.remainTime .. &quot;S&quot;)
	setText(slot0.roundTxt, slot0.roundTime)
	slot0:clearTimer()
	slot0:hideRandomList()
	slot0:clearUsingBlock()
	slot0:cleanManagedTween()
end

slot0.setGameState = function(slot0, slot1)
	if slot1 == slot0.gameState then
		return
	end

	slot0.gameState = slot1

	slot2 = function(slot0)
		for slot5, slot6 in pairs({
			uv0.startUI,
			uv0.content,
			uv0.endUI,
			uv0.countUI,
			uv0.keyUI,
			uv0.keyBar
		}) do
			setActive(slot6, table.indexof(slot0, slot6) and true)
		end

		if isActive(uv0.endUI) then
			pg.UIMgr.GetInstance():BlurPanel(uv0.endUI)
		else
			pg.UIMgr.GetInstance():UnblurPanel(uv0.endUI, uv0._tf)
		end
	end

	if slot0.gameState == slot0.STATE_BEGIN then
		setButtonEnabled(slot0.startBtn, true)
		slot2({
			slot0.startUI
		})
		slot0:resetGame()
	else
		if slot0.gameState == slot0.STATE_COUNT then
			slot2({
				slot0.countUI,
				slot0.content
			})

			slot3 = Time.realtimeSinceStartup
			slot4 = slot0:managedTween(LeanTween.delayedCall, function ()
				uv0:startGameTimer()
				uv0:setGameState(uv0.STATE_CLICK)
			end, 3, nil)

			slot4:setOnUpdate(System.Action_float(function (slot0)
				setText(uv0.countNumTxt, math.ceil(3 - (Time.realtimeSinceStartup - uv1)))
			end))

			return
		end

		if slot0.gameState == slot0.STATE_CLICK then
			slot2({
				slot0.content,
				slot0.keyUI,
				slot0.keyBar
			})

			slot0.randomBlockList, slot0.curShowBlock, slot0.firstShowBlock = slot0:getRandomList()

			slot0:startRoundTimer()
		elseif slot0.gameState == slot0.STATE_SHOW then
			slot2({
				slot0.content
			})
			slot0:hideRandomList()
			slot0:playArchiveAnim(slot0.randomBlockList, slot0:getUserResult())
		elseif slot0.gameState == slot0.STATE_END then
			slot2({
				slot0.content,
				slot0.endUI
			})
			setActive(slot0.endExitBtn, false)

			slot3 = 0

			if slot0:GetMGData():GetRuntimeData(&quot;elements&quot;) and #slot4 &gt; 0 then
				slot3 = slot4[1]
			end

			if slot3 &lt; slot0.score then
				slot0:StoreDataToServer({
					slot0.score
				})
			end

			setText(slot0.endBestTxt, slot3)
			setText(slot0.endScoreTxt, slot0.score)
			setText(slot0.endComboTxt, slot0.bestComboNum)
			setText(slot0.endMissTxt, slot0.missNum)
			setText(slot0.endHitTxt, slot0.hitNum)
			slot0:clearTimer()
		end
	end
end

slot0.fireBlocks = function(slot0)
	slot1 = slot0.opIndex
	slot5 = slot0:getBlock(slot0.arBlockList[slot1].type, slot0.arBlockList[slot1].id)
	slot6 = slot5.tf

	slot0:addUsingBlock(slot5)

	slot7 = nil

	if slot0.opList[slot1] then
		if slot2 == slot0.TYPE_A then
			slot7 = slot0.aPos
		elseif slot2 == slot0.TYPE_B then
			slot7 = slot0.bPos
		elseif slot2 == slot0.TYPE_C then
			slot7 = slot0.cPos
		end
	else
		slot7 = slot0.missPos
	end

	slot6.anchoredPosition = slot0.firePos

	slot0:hitFly(slot6, 0.5, slot0.hitPos, function ()
		uv0.anchoredPosition = uv1.hitPos

		if uv2 then
			slot0 = 0.4
			slot1 = uv1.parabolaMove

			if uv3 == uv1.TYPE_A then
				slot0 = 0.3
				slot1 = uv1.parabolaMove_center

				uv1:setBucketAAction(&quot;attack&quot;)
			elseif uv3 == uv1.TYPE_B then
				slot2 = uv1

				slot2:managedTween(LeanTween.delayedCall, function ()
					uv0:setBucketBAction(&quot;attack&quot;)
				end, 0.2, nil)
			elseif uv3 == uv1.TYPE_C then
				slot0 = 0.3
				slot1 = uv1.parabolaMove_center

				setActive(uv1.msHand, true)
				uv1.msHandAnimator:Play(&quot;mingshi_hand&quot;, -1, 0)
			end

			slot1(uv1, uv0, slot0, uv4, function ()
				if uv0 == uv1.TYPE_A then
					uv1:removeUsingBlock(uv2)
					uv1:showBucketAEffect()
					pg.CriMgr.GetInstance():PlaySE_V3(&quot;ui-minigame_hitcake&quot;)
				elseif uv0 == uv1.TYPE_B then
					setActive(uv1[&quot;cut&quot; .. uv3], true)
					uv1[&quot;cut&quot; .. uv3 .. &quot;Animator&quot;]:Play(&quot;cut_fruit&quot;, -1, 0)
					uv1:removeUsingBlock(uv2)
					pg.CriMgr.GetInstance():PlaySE_V3(&quot;ui-minigame_sword&quot;)
				elseif uv0 == uv1.TYPE_C then
					uv1:msClearHold()
					uv1:msHoldBlock(uv2)
				end

				uv1:checkEnd(uv4)
			end)
		else
			slot0 = uv1

			slot0:hitFly(uv0, 0.6, uv4, function ()
				uv0:removeUsingBlock(uv1)
				uv0:checkEnd(uv2)
			end)
		end

		pg.CriMgr.GetInstance():PlaySE_V3(&quot;ui-minigame_hitwood&quot;)
		uv1:countScore(uv2)
	end)
	slot0:managedTween(LeanTween.delayedCall, function ()
		uv0:setGuinuAction(&quot;action&quot;)
	end, 0.2, nil)
end

slot0.getRandomList = function(slot0)
	if not slot0.allList then
		slot0.allList = {}

		for slot4 = 1, slot0.typeNum do
			for slot8 = 1, slot0.idNum do
				slot0.allList[#slot0.allList + 1] = {
					type = slot4,
					id = slot8
				}
			end
		end
	end

	slot1 = Clone(slot0.allList)
	slot2 = {}

	for slot6 = 1, slot0.limitNum do
		slot2[#slot2 + 1] = table.remove(slot1, math.random(1, #slot1))
	end

	slot3, slot4, slot5 = nil

	for slot9, slot10 in ipairs(slot2) do
		slot11 = slot0:getShowBlock(slot10.type, slot10.id)

		if slot3 then
			slot3.nextBlock = slot11
		end

		if slot0.limitNum &lt;= slot9 then
			slot11.nextBlock = nil
		end

		if slot9 == 1 then
			slot4 = slot11
			slot5 = slot11
		end

		slot11:showOrHide(true)

		slot3 = slot11
	end

	return slot2, slot4, slot5
end

slot0.hideRandomList = function(slot0)
	slot1 = slot0.firstShowBlock

	while slot1 do
		slot1:showOrHide(false)

		slot1 = slot1.nextBlock
	end
end

slot0.countScore = function(slot0, slot1)
	if slot1 then
		slot2 = nil

		for slot6, slot7 in ipairs(slot0.comboRange) do
			if slot0.comboNum &lt; slot7 then
				slot2 = slot6 - 1

				break
			elseif slot6 == #slot0.comboRange then
				slot2 = #slot0.comboRange
			end
		end

		slot0.comboNum = slot0.comboNum + 1
		slot0.score = slot0.score + slot0.scorePerHit + (slot0.comboAddScore[slot2] or 0) + (slot0.targetComboScore[table.indexof(slot0.targetCombo, slot0.comboNum)] or 0)
		slot0.hitNum = slot0.hitNum + 1
		slot0.comboAni.enabled = true

		slot0.comboAni:Play(&quot;combo_shake&quot;, -1, 0)
	else
		slot0.comboNum = 0
		slot0.missNum = slot0.missNum + 1
	end

	if slot0.bestComboNum &lt; slot0.comboNum then
		slot0.bestComboNum = slot0.comboNum
	end

	setText(slot0.comboTxt, slot0.comboNum &lt; 0 and 0 or slot0.comboNum)
	setText(slot0.scoreTxt, slot0.score)
end

slot0.getUserResult = function(slot0)
	slot1 = {}
	slot2 = slot0.firstShowBlock

	while slot2 do
		slot1[#slot1 + 1] = slot2:isRight()
		slot2 = slot2.nextBlock
	end

	return slot1
end

slot0.playArchiveAnim = function(slot0, slot1, slot2)
	slot0.arBlockList = slot1
	slot0.opList = slot2
	slot0.opIndex = 1

	slot0:setXgmAction(&quot;attack&quot;)
end

slot0.checkPlayFinished = function(slot0)
	if slot0.opIndex &gt;= #slot0.opList and slot0.remainTime &gt; 0 then
		slot0:setGameState(slot0.STATE_CLICK)
	end
end

slot0.checkEnd = function(slot0, slot1)
	if slot1 &gt;= #slot0.opList and slot0.remainTime &lt;= 0 then
		slot0:setGameState(slot0.STATE_END)
	end
end

slot0.parabolaMove = function(slot0, slot1, slot2, slot3, slot4)
	slot0:managedTween(LeanTween.rotate, nil, slot1, 135, slot2)
	slot0:managedTween(LeanTween.moveX, nil, slot1, slot3.x, slot2):setEase(LeanTweenType.linear)
	slot0:managedTween(LeanTween.moveY, function ()
		if uv0 then
			uv0()
		end
	end, slot1, slot3.y, slot2):setEase(LeanTweenType.easeInQuad)
end

slot0.parabolaMove_center = function(slot0, slot1, slot2, slot3, slot4)
	slot0:managedTween(LeanTween.rotate, nil, slot1, 135, slot2)
	slot0:managedTween(LeanTween.moveX, nil, slot1, slot3.x, slot2):setEase(LeanTweenType.easeOutQuad)
	slot0:managedTween(LeanTween.moveY, function ()
		if uv0 then
			uv0()
		end
	end, slot1, slot3.y, slot2):setEase(LeanTweenType.linear)
end

slot0.hitFly = function(slot0, slot1, slot2, slot3, slot4)
	slot0:managedTween(LeanTween.rotate, nil, slot1, 135, slot2)
	slot0:managedTween(LeanTween.moveX, nil, slot1, slot3.x, slot2):setEase(LeanTweenType.linear)
	slot0:managedTween(LeanTween.moveY, function ()
		if uv0 then
			uv0()
		end
	end, slot1, slot3.y, slot2):setEase(LeanTweenType.easeOutQuad)
end

slot0.loadXGM = function(slot0, slot1)
	if slot0.xgm then
		slot1()
	else
		slot2 = slot0.autoLoader

		slot2:LoadPrefab(&quot;ui/minigameui/qtegameuiasync_atlas&quot;, &quot;xiongguimao&quot;, function (slot0)
			uv0.xgm = tf(slot0)
			uv0.xgmSpine = uv0.xgm:GetComponent(&quot;SpineAnimUI&quot;)
			uv0.xgmSklGraphic = uv0.xgm:GetComponent(&quot;SkeletonGraphic&quot;)

			setParent(uv0.xgm, uv0.xgmPos, false)
			uv0:initXGM()
			uv1()
		end)
	end
end

slot0.initXGM = function(slot0)
	slot1 = slot0.xgmSpine

	slot1:SetActionCallBack(function (slot0)
		if slot0 == &quot;FIRE&quot; then
			uv0:fireBlocks()
		elseif slot0 == &quot;FINISH&quot; then
			if uv0.opIndex &lt; #uv0.opList then
				uv0.opIndex = uv0.opIndex + 1

				uv0:setXgmAction(&quot;attack&quot;)
			else
				uv0:setXgmAction(&quot;idle&quot;)
				uv0:checkPlayFinished()
			end
		end
	end)
end

slot0.loadGuinu = function(slot0, slot1)
	if slot0.guinu then
		slot1()
	else
		slot2 = slot0.autoLoader

		slot2:GetSpine(&quot;guinu_2&quot;, function (slot0)
			uv0.guinu = tf(slot0)
			uv0.guinuSpine = uv0.guinu:GetComponent(&quot;SpineAnimUI&quot;)
			uv0.guinuSklGraphic = uv0.guinu:GetComponent(&quot;SkeletonGraphic&quot;)

			setParent(uv0.guinu, uv0.guinuPos, false)
			uv0:initGuinu()
			uv1()
		end)
	end
end

slot0.initGuinu = function(slot0)
	slot0.guinu.localScale = Vector3.one

	slot0:setGuinuAction(&quot;normal&quot;)

	slot1 = slot0.guinuSpine

	slot1:SetActionCallBack(function (slot0)
		if slot0 == &quot;finish&quot; then
			uv0:setGuinuAction(&quot;normal&quot;)
		end
	end)
end

slot0.setXgmAction = function(slot0, slot1)
	if not slot0.xgm then
		return
	end

	slot0.xgmSklGraphic.timeScale = slot0.xgmAnimLength[slot1] / slot0.xgmAnimTargetLength[slot1]

	slot0.xgmSpine:SetAction(slot1, 0)
end

slot0.setGuinuAction = function(slot0, slot1)
	if not slot0.guinu then
		return
	end

	slot0.guinuSklGraphic.timeScale = slot0.guinuAnimLength[slot1] / slot0.guinuAnimTargetLength[slot1]

	slot0.guinuSpine:SetAction(slot1, 0)
end

slot0.setBucketAAction = function(slot0, slot1)
	slot0.bucketAGraphic.timeScale = slot0.bucketAAnimLength[slot1] / slot0.bucketAAnimTargetLength[slot1]

	slot0.bucketASpine:SetAction(slot1, 0)
end

slot0.setBucketBAction = function(slot0, slot1)
	slot0.bucketBGraphic.timeScale = slot0.bucketBAnimLength[slot1] / slot0.bucketBAnimTargetLength[slot1]

	slot0.bucketBSpine:SetAction(slot1, 0)
end

slot0.showBucketAEffect = function(slot0)
	slot0.aEffectList = slot0.aEffectList or {}
	slot0.aEffectUsingList = slot0.aEffectUsingList or {}

	slot1 = function()
		slot0 = table.remove(uv0.aEffectList, #uv0.aEffectList)
		uv0.aEffectUsingList[#uv0.aEffectUsingList + 1] = slot0

		setParent(slot0, uv0.bucketA, false)

		slot0.localScale = Vector3.one

		setActive(slot0, true)
		uv0:managedTween(LeanTween.delayedCall, function ()
			uv0:recycleBucketAEffect(uv1)
		end, 2, nil)
	end

	if #slot0.aEffectList == 0 then
		slot2 = slot0.autoLoader

		slot2:LoadPrefab(&quot;effect/xinnianyouxi_baozha&quot;, nil, function (slot0)
			uv0.aEffectList[#uv0.aEffectList + 1] = tf(slot0)

			uv1()
		end)
	else
		slot1()
	end
end

slot0.recycleBucketAEffect = function(slot0, slot1)
	for slot5 = #slot0.aEffectUsingList, 1, -1 do
		if slot0.aEffectUsingList[slot5] == slot1 then
			setActive(slot1, false)

			slot0.aEffectList[#slot0.aEffectList + 1] = table.remove(slot0.aEffectUsingList, slot5)
		end
	end
end

slot0.getBlock = function(slot0, slot1, slot2)
	slot3 = slot1 .. &quot;-&quot; .. slot2

	if not slot0.blockPool then
		slot0.blockPool = {}
		slot0.blockSource = {}

		for slot7 = 1, 3 do
			for slot11 = 1, 3 do
				slot12 = slot7 .. &quot;-&quot; .. slot11
				slot13 = slot0:findTF(&quot;res/item&quot; .. slot12)
				slot0.blockPool[slot12] = {
					[#slot0.blockPool[slot12] + 1] = slot13
				}
				slot0.blockSource[slot12] = slot13
			end
		end
	end

	slot4 = nil

	if #slot0.blockPool[slot3] &gt; 0 then
		table.remove(slot0.blockPool[slot3], #slot0.blockPool[slot3]):SetParent(slot0.content, false)
	else
		slot4 = cloneTplTo(slot0.blockSource[slot3], slot0.content)
	end

	setActive(slot4, true)

	slot0.blockUniId = slot0.blockUniId + 1

	return {
		uid = slot0.blockUniId,
		key = slot3,
		tf = slot4
	}
end

slot0.recycleBlock = function(slot0, slot1)
	slot2 = slot1.tf
	slot3 = slot0.blockPool[slot1.key]
	slot3[#slot3 + 1] = slot2

	slot2:SetParent(slot0.res, false)
	setActive(slot2, false)
end

slot0.msHoldBlock = function(slot0, slot1)
	setParent(slot1.tf, slot0.msHandSlot, false)

	slot1.tf.localPosition = Vector2.zero
	slot0.msBlockList[#slot0.msBlockList + 1] = slot1
end

slot0.msClearHold = function(slot0)
	for slot4 = #slot0.msBlockList, 1, -1 do
		slot0:removeUsingBlock(table.remove(slot0.msBlockList, slot4))
	end
end

slot0.addUsingBlock = function(slot0, slot1)
	slot0.usingBlockList[#slot0.usingBlockList + 1] = slot1
end

slot0.removeUsingBlock = function(slot0, slot1)
	for slot5 = #slot0.usingBlockList, 1, -1 do
		if slot0.usingBlockList[slot5].uid == slot1.uid then
			slot0:recycleBlock(slot0.usingBlockList[slot5])
			table.remove(slot0.usingBlockList, slot5)
		end
	end
end

slot0.clearUsingBlock = function(slot0)
	for slot4 = #slot0.usingBlockList, 1, -1 do
		slot0:recycleBlock(slot0.usingBlockList[slot4])
		table.remove(slot0.usingBlockList, slot4)
	end
end

slot0.getShowBlock = function(slot0, slot1, slot2)
	slot4 = &quot;item&quot; .. (slot1 .. &quot;-&quot; .. slot2)
	slot0.showBlockDic = slot0.showBlockDic or {}
	slot5 = nil

	if slot0.showBlockDic[slot3] then
		slot5 = slot0.showBlockDic[slot3]
	else
		slot5 = {
			type = slot1,
			id = slot2,
			goName = slot4,
			tf = slot0:findTF(slot4, slot0.keyBar)
		}
		slot5.wrongTag = slot0:findTF(&quot;wrong&quot;, slot5.tf)
		slot5.rightTag = slot0:findTF(&quot;right&quot;, slot5.tf)
		slot5.nextBlock = nil
		slot5.userChoose = nil

		slot5.init = function(slot0)
			setActive(slot0.wrongTag, false)
			setActive(slot0.rightTag, false)

			slot0.userChoose = nil

			slot0.tf:SetAsLastSibling()
		end

		slot5.select = function(slot0, slot1)
			slot0.userChoose = slot1

			setActive(slot0.wrongTag, not slot0:isRight())
			setActive(slot0.rightTag, slot0:isRight())
		end

		slot5.showOrHide = function(slot0, slot1)
			setActive(slot0.tf, slot1)
		end

		slot5.isRight = function(slot0)
			return slot0.userChoose == slot0.type
		end
	end

	slot5:init()

	return slot5
end

slot0.startGameTimer = function(slot0)
	slot1 = slot0:GetMGData()
	slot0.remainTime = slot1:GetSimpleValue(&quot;gameTime&quot;)

	setText(slot0.remainTxt, slot0.remainTime .. &quot;S&quot;)

	slot1 = function()
		uv0.remainTime = uv0.remainTime - 1

		setText(uv0.remainTxt, uv0.remainTime .. &quot;S&quot;)

		if uv0.remainTime &lt;= 0 then
			uv0.remainTimer:Stop()
		end
	end

	if slot0.remainTimer then
		slot0.remainTimer:Reset(slot1, 1, -1)
	else
		slot0.remainTimer = Timer.New(slot1, 1, -1)
	end

	slot0.remainTimer:Start()
end

slot0.startRoundTimer = function(slot0)
	slot1 = slot0:GetMGData()
	slot0.roundTime = slot1:GetSimpleValue(&quot;roundTime&quot;)

	setText(slot0.roundTxt, slot0.roundTime)

	slot1 = function()
		uv0.roundTime = uv0.roundTime - 1

		setText(uv0.roundTxt, uv0.roundTime)

		if uv0.roundTime &lt;= 0 then
			uv0.roundTimer:Stop()

			if not QTEGAME_DEBUG then
				uv0:setGameState(uv0.STATE_SHOW)
			end
		end
	end

	if slot0.roundTimer then
		slot0.roundTimer:Reset(slot1, 1, -1)
	else
		slot0.roundTimer = Timer.New(slot1, 1, -1)
	end

	slot0.roundTimer:Start()
end

slot0.clearTimer = function(slot0)
	if slot0.remainTimer then
		slot0.remainTimer:Stop()

		slot0.remainTimer = nil
	end

	if slot0.roundTimer then
		slot0.roundTimer:Stop()

		slot0.roundTimer = nil
	end
end

slot0.OnSendMiniGameOPDone = function(slot0, slot1)
	slot2 = slot1.argList

	if slot1.cmd == MiniGameOPCommand.CMD_COMPLETE and slot2[1] == 0 then
		slot0:SendOperator(MiniGameOPCommand.CMD_SPECIAL_GAME, {
			slot0:GetMGData():GetSimpleValue(&quot;shrineGameId&quot;),
			1
		})
	end
end

slot0.checkHelp = function(slot0)
	if PlayerPrefs.GetInt(&quot;QTEGameGuide&quot;, 0) == 0 then
		triggerButton(slot0.ruleBtn)
		PlayerPrefs.SetInt(&quot;QTEGameGuide&quot;, 1)
		PlayerPrefs.Save()
	end
end

slot0.willExit = function(slot0)
	slot0:clearTimer()
	pg.UIMgr.GetInstance():UnblurPanel(slot0.endUI, slot0._tf)
	pg.UIMgr.GetInstance():UnOverlayPanel(slot0.keyBar, slot0.content)

	slot0.xgm = nil
	slot0.xgmSpine = nil
	slot0.xgmSklGraphic = nil
	slot0.guinu = nil
	slot0.guinuSpine = nil
	slot0.guinuSklGraphic = nil

	slot0.autoLoader:Clear()
end

return slot0
</code></pre>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-lua.min.js"></script>
</body>
</html>