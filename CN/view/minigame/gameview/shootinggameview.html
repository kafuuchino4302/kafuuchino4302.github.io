<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>shootinggameview.lua</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
</head>
<body>
    <h1>shootinggameview.lua</h1>
    <a href="index.html">返回主页</a>
    <pre><code class="language-lua">slot0 = class(&quot;ShootingGameView&quot;, import(&quot;..BaseMiniGameView&quot;))
slot0.animTime = 0.3333333333333333
slot0.moveModulus = 120

slot0.getUIName = function(slot0)
	return &quot;ShootingGameUI&quot;
end

slot0.init = function(slot0)
	slot0.uiMGR = pg.UIMgr.GetInstance()
	slot0.blurPanel = slot0._tf:Find(&quot;noAdaptPanel/blur_panel&quot;)
	slot0.top = slot0.blurPanel:Find(&quot;top&quot;)
	slot0.backBtn = slot0.top:Find(&quot;back&quot;)
	slot0.scoreTF = slot0.top:Find(&quot;score/Text&quot;)

	setText(slot0.scoreTF, 0)

	slot0.bestScoreTF = slot0.top:Find(&quot;score_heightest/Text&quot;)
	slot0.ticketTF = slot0.top:Find(&quot;ticket/Text&quot;)
	slot0.helpBtn = slot0.top:Find(&quot;help_btn&quot;)
	slot0.sightTF = slot0.blurPanel:Find(&quot;MoveArea/Sight&quot;)

	setActive(slot0.sightTF, false)

	slot0.corners = slot0.blurPanel:Find(&quot;Corners&quot;)
	slot0.shootAreaTF = slot0._tf:Find(&quot;noAdaptPanel/ShootArea&quot;)
	slot0.targetPanel = slot0.shootAreaTF:Find(&quot;target_panel&quot;)
	slot0.targetTpl = {}

	for slot5 = 1, slot0.shootAreaTF:Find(&quot;tpl&quot;).childCount do
		slot0.targetTpl[slot5] = slot1:GetChild(slot5 - 1)
	end

	setActive(slot1, false)

	slot0.startMaskTF = slot0.shootAreaTF:Find(&quot;start_mask&quot;)
	slot0.countdownTF = slot0.startMaskTF:Find(&quot;count&quot;)
	slot0.lastTimeTF = slot0.shootAreaTF:Find(&quot;time_word&quot;)
	slot0.bottomTF = slot0._tf:Find(&quot;noAdaptPanel/bottom&quot;)
	slot0.joyStrickTF = slot0.bottomTF:Find(&quot;Stick&quot;)
	slot0.fireBtn = slot0.bottomTF:Find(&quot;fire/ActCtl&quot;)
	slot0.fireBtnDelegate = GetOrAddComponent(slot0.fireBtn, &quot;EventTriggerListener&quot;)

	setActive(slot0.fireBtn:Find(&quot;block&quot;), false)

	slot0.resultPanel = slot0._tf:Find(&quot;result_panel&quot;)

	setActive(slot0.resultPanel, false)
end

slot0.initData = function(slot0)
	slot0.tempConfig = slot0:GetMGData():getConfig(&quot;simple_config_data&quot;)
	slot0.tempConfig.waitCountdown = 3
	slot0.tempConfig.half = 56
end

slot0.addTimer = function(slot0, slot1, slot2, slot3)
	slot0.timerList = slot0.timerList or {}

	assert(slot0.timerList[slot1] == nil, &quot;error Timers&quot;)
	assert(slot2 &gt; 0, &quot;duration must &gt;0&quot;)

	slot0.timerList[slot1] = {
		timeMark = Time.realtimeSinceStartup + slot2,
		func = slot3
	}
end

slot0.updateTimers = function(slot0)
	slot1 = Time.realtimeSinceStartup

	for slot5, slot6 in pairs(slot0.timerList) do
		if slot6.timeMark &lt; slot1 then
			slot0.timerList[slot5] = nil

			slot6.func()
		end
	end
end

slot0.stopTimers = function(slot0)
	slot0.isStopped = true
	slot1 = Time.realtimeSinceStartup

	for slot5, slot6 in pairs(slot0.timerList) do
		slot6.timeMark = slot6.timeMark - slot1
	end
end

slot0.restartTimers = function(slot0)
	slot0.isStopped = false
	slot1 = Time.realtimeSinceStartup

	for slot5, slot6 in pairs(slot0.timerList) do
		slot6.timeMark = slot6.timeMark + slot1
	end
end

slot0.clearTimers = function(slot0)
	slot0.timerList = {}
end

slot0.didEnter = function(slot0)
	onButton(slot0, slot0.backBtn, function ()
		if uv0.isPlaying then
			uv0:stopTimers()
			pg.MsgboxMgr.GetInstance():ShowMsgBox({
				content = i18n(&quot;tips_summergame_exit&quot;),
				onYes = function ()
					uv0:gameFinish(true)
					uv0:closeView()
				end,
				onNo = function ()
					uv0:restartTimers()
				end
			})
		else
			uv0:closeView()
		end
	end)
	onButton(slot0, slot0.helpBtn, function ()
		pg.MsgboxMgr.GetInstance():ShowMsgBox({
			type = MSGBOX_TYPE_HELP,
			helps = pg.gametip.help_summer_shooting.tip
		})
	end, SFX_PANEL)
	onButton(slot0, slot0.startMaskTF, function ()
		if not uv0.isPlaying then
			uv0:gameStart()
		end
	end)
	slot0:initData()
	slot0:updateCount()
	slot0:resetTime()
	slot0:initFireFunc()
	slot0:setFireLink(false)
	setActive(slot0.startMaskTF, true)
end

slot0.onBackPressed = function(slot0)
	triggerButton(slot0.backBtn)
end

slot1 = function(slot0, slot1)
	return Vector2(math.clamp(slot0.x, -slot1.x, slot1.x), math.clamp(slot0.y, -slot1.y, slot1.y))
end

slot0.update = function(slot0)
	slot1 = Time.GetTimestamp()

	if not slot0.isStopped then
		if slot0.isAfterCount and slot0.sightTimeMark then
			if not slot0.moveRect then
				slot2 = tf(slot0.sightTF.parent)
				slot0.moveRect = Vector2(slot2.rect.width - slot0.sightTF.rect.width, slot2.rect.height - slot0.sightTF.rect.height) / 2
			end

			slot0.sightTF.anchoredPosition = uv1(slot0.sightTF.anchoredPosition + Vector2(slot0.uiMGR.hrz, slot0.uiMGR.vtc) * slot0.tempConfig.moveSpeed * (slot1 - slot0.sightTimeMark) * uv0.moveModulus * (slot0.isDown and 0.5 or 1), slot0.moveRect)
		end

		slot0:updateTimers()
	end

	slot0.sightTimeMark = slot1
end

slot0.resetTime = function(slot0)
	slot0.countdown = slot0.tempConfig.waitCountdown

	setText(slot0.countdownTF, slot0.countdown)

	slot0.lastTime = slot0.tempConfig.baseTime

	setText(slot0.lastTimeTF, slot0.lastTime)
end

slot0.gameStart = function(slot0)
	slot0.isPlaying = true
	slot1 = UpdateBeat

	slot1:Add(slot0.update, slot0)
	setActive(slot0.countdownTF, true)

	slot2 = slot0.startMaskTF

	setActive(slot2:Find(&quot;word&quot;), false)

	slot1 = function(slot0)
		slot1 = uv0

		slot1:addTimer(&quot;start countdown&quot;, 1, function ()
			uv0.countdown = uv0.countdown - 1

			setText(uv0.countdownTF, uv0.countdown)

			if uv0.countdown &gt; 0 then
				uv1(uv1)
			else
				uv0:afterCountDown()
			end
		end)
	end

	slot1(slot1)
end

slot0.afterCountDown = function(slot0)
	slot0.isAfterCount = true
	slot1 = slot0.uiMGR

	slot1:AttachStickOb(slot0.joyStrickTF)
	setActive(slot0.sightTF, true)
	setAnchoredPosition(slot0.sightTF, Vector2.zero)
	slot0:setFireLink(true)
	setActive(slot0.startMaskTF, false)

	slot0.score = 0

	slot0:flushTarget(true)

	slot1 = function(slot0)
		slot1 = uv0

		slot1:addTimer(&quot;gamefinish&quot;, 1, function ()
			uv0.lastTime = uv0.lastTime - 1

			setText(uv0.lastTimeTF, uv0.lastTime)

			if uv0.lastTime &gt; 0 then
				uv1(uv1)
			else
				uv0:gameFinish()
			end
		end)
	end

	slot1(slot1)
end

slot0.gameFinish = function(slot0, slot1)
	if slot0.isAfterCount then
		slot0:setFireLink(false)
		slot0.uiMGR:ClearStick()

		slot0.isAfterCount = false
	end

	slot0:clearTimers()
	UpdateBeat:Remove(slot0.update, slot0)
	setActive(slot0.sightTF, false)
	setActive(slot0.countdownTF, false)
	slot0:resetTime()

	slot0.isPlaying = false

	if not slot1 then
		for slot5 = 1, 3 do
			for slot9 = 1, 6 do
				if slot0.cell[slot5][slot9] then
					slot0.targetPanel:Find(&quot;line_&quot; .. slot5):GetChild(slot9 - 1):GetChild(0):GetComponent(typeof(Animator)):Play(&quot;targetDown&quot;)
				end
			end
		end

		Timer.New(function ()
			setActive(uv0.startMaskTF, true)
			setActive(uv0.startMaskTF:Find(&quot;word&quot;), true)
		end, uv0.animTime):Start()
		slot0:resultFinish()
	end
end

slot0.resultFinish = function(slot0)
	slot2 = nil

	for slot6 = 1, #slot0.tempConfig.score_level do
		if slot1[#slot1 - slot6 + 1] &lt;= slot0.score then
			slot2 = slot6

			break
		end
	end

	slot0.awardLevel = slot2

	if slot0:GetMGHubData().count &gt; 0 then
		slot0:SendSuccess(slot2)
	else
		slot0:showResultPanel({})
	end
end

slot0.showResultPanel = function(slot0, slot1, slot2)
	slot3 = function()
		setActive(uv0.resultPanel, false)

		if uv1 then
			uv1()
		else
			uv0:updateCount()
		end
	end

	onButton(slot0, slot0.resultPanel:Find(&quot;bg&quot;), slot3)
	onButton(slot0, slot0.resultPanel:Find(&quot;main/btn_confirm&quot;), slot3)

	slot4 = slot0.resultPanel:Find(&quot;main&quot;)

	if slot0.bestScore &lt; slot0.score then
		slot0:StoreDataToServer({
			slot0.score
		})
		GetImageSpriteFromAtlasAsync(&quot;ui/minigameui/shootinggameui_atlas&quot;, &quot;new_recode&quot;, slot4:Find(&quot;success&quot;), true)
	else
		GetImageSpriteFromAtlasAsync(&quot;ui/minigameui/shootinggameui_atlas&quot;, &quot;success&quot;, slot4:Find(&quot;success&quot;), true)
	end

	GetImageSpriteFromAtlasAsync(&quot;ui/minigameui/shootinggameui_atlas&quot;, &quot;level_&quot; .. #slot0.tempConfig.score_level - slot0.awardLevel + 1, slot4:Find(&quot;success/level&quot;), true)
	setText(slot4:Find(&quot;right/score/number&quot;), slot0.score)
	setActive(slot4:Find(&quot;right/awards/list&quot;), #slot1 &gt; 0)
	setActive(slot4:Find(&quot;right/awards/nothing&quot;), #slot1 == 0)

	slot0.itemList = slot0.itemList or UIItemList.New(slot4:Find(&quot;right/awards/list&quot;), slot4:Find(&quot;right/awards/list/item&quot;))

	slot0.itemList:make(function (slot0, slot1, slot2)
		if slot0 == UIItemList.EventUpdate then
			updateDrop(slot2, uv0[slot1 + 1])
			setText(slot2:Find(&quot;number&quot;), &quot;x&quot; .. uv0[slot1 + 1].count)
		end
	end)
	slot0.itemList:align(#slot1)
	setActive(slot0.resultPanel, true)
end

slot0.updateAfterFinish = function(slot0)
	pg.m02:sendNotification(GAME.MODIFY_MINI_GAME_DATA, {
		id = MiniGameDataCreator.ShrineGameID,
		map = {
			count = (getProxy(MiniGameProxy):GetMiniGameData(MiniGameDataCreator.ShrineGameID):GetRuntimeData(&quot;count&quot;) or 0) + 1
		}
	})
end

slot0.OnGetAwardDone = function(slot0, slot1)
	if slot1.cmd == MiniGameOPCommand.CMD_COMPLETE then
		if slot0:GetMGHubData().ultimate == 0 and slot2:getConfig(&quot;reward_need&quot;) &lt;= slot2.usedtime then
			pg.m02:sendNotification(GAME.SEND_MINI_GAME_OP, {
				hubid = slot2.id,
				cmd = MiniGameOPCommand.CMD_ULTIMATE,
				args1 = {}
			})
		end
	elseif slot1.cmd == MiniGameOPCommand.CMD_ULTIMATE then
		pg.NewStoryMgr.GetInstance():Play(&quot;TIANHOUYUYI2&quot;)
	end
end

slot0.OnSendMiniGameOPDone = function(slot0, slot1)
	slot0:updateCount()
end

slot0.updateCount = function(slot0)
	setText(slot0.ticketTF, slot0:GetMGHubData().count)

	slot0.bestScore = checkExist(slot0:GetMGData():GetRuntimeData(&quot;elements&quot;), {
		1
	}) or 0

	setText(slot0.bestScoreTF, slot0.bestScore)
end

slot0.initFireFunc = function(slot0)
	slot1 = pg.TipsMgr.GetInstance()
	slot2 = pg.TimeMgr.GetInstance()
	slot3 = slot0.sightTF
	slot4 = slot0.sightTF

	setImageAlpha(slot3:Find(&quot;sight_base&quot;), 1)
	setImageAlpha(slot4:Find(&quot;sight_ready&quot;), 0)

	slot5 = function()
		setActive(uv0.corners, true)

		slot0 = LeanTween.scale(uv1, Vector3(1.95, 1.95, 1), 0.1)

		slot0:setOnComplete(System.Action(function ()
			LeanTween.alpha(uv0, 0, 0.1)
			LeanTween.alpha(uv1, 1, 0.1)
		end))
	end

	slot6 = function()
		setActive(uv0.corners, false)
		LeanTween.alpha(uv1, 1, 0.1)

		slot0 = LeanTween.alpha(uv2, 0, 0.1)

		slot0:setOnComplete(System.Action(function ()
			LeanTween.scale(uv0, Vector3.one, 0.1)
		end))
	end

	slot0._downFunc = function()
		uv0()
	end

	slot0._upFunc = function()
		LeanTween.scale(uv0, Vector3(2, 2, 2), 0.03):setOnComplete(System.Action(function ()
			LeanTween.scale(uv0, Vector3.one, 0.07):setOnComplete(System.Action(function ()
				uv0()
			end))
		end))

		slot0, slot1, slot2 = uv2:checkHit()

		if slot0 then
			slot3 = uv2.cell[slot1][slot2]
			uv2.cell[slot1][slot2] = nil
			uv2.score = uv2.score + uv2.tempConfig.targetScore[slot3]
			uv2.targetCount[slot3] = uv2.targetCount[slot3] - 1
			uv2.lastTime = uv2.lastTime + uv2.tempConfig.bonusTime

			setText(uv2.lastTimeTF, uv2.lastTime)

			slot4 = uv2.targetPanel
			slot4 = slot4:Find(&quot;line_&quot; .. slot1)
			slot4 = slot4:GetChild(slot2 - 1)
			slot4 = slot4:GetChild(0)
			slot4 = slot4:GetComponent(typeof(Animator))

			slot4:Play(&quot;targetDown&quot;)

			slot5 = uv2

			slot5:addTimer(&quot;flush call&quot;, 0.2 + uv3.animTime, function ()
				uv0:flushTarget()
			end)

			if not _.any(uv2.targetCount, function (slot0)
				return slot0 &gt; 0
			end) then
				uv2:gameFinish()
			end
		end

		slot3 = uv2

		slot3:setFireLink(false)

		slot3 = uv2

		slot3:addTimer(&quot;fire cd&quot;, uv2.tempConfig.fireCD, function ()
			uv0:setFireLink(true)
		end)
	end

	slot0._cancelFunc = function()
		uv0()
	end

	slot0._emptyFunc = nil
end

slot0.setFireLink = function(slot0, slot1)
	if slot1 then
		setButtonEnabled(slot0.fireBtn, true)

		if slot0._downFunc ~= nil then
			slot2 = slot0.fireBtnDelegate

			slot2:AddPointDownFunc(function ()
				uv0.isDown = true

				if uv0._main_cannon_sound then
					uv0._main_cannon_sound:Stop(true)
				end

				uv0._main_cannon_sound = pg.CriMgr.GetInstance():PlaySE_V3(&quot;battle-cannon-main-prepared&quot;)

				uv0._downFunc()
			end)
		end

		if slot0._upFunc ~= nil then
			slot2 = slot0.fireBtnDelegate

			slot2:AddPointUpFunc(function ()
				if uv0.isDown then
					if uv0._main_cannon_sound then
						uv0._main_cannon_sound:Stop(true)
					end

					pg.CriMgr.GetInstance():PlaySoundEffect_V3(&quot;event:/battle/boom2&quot;)

					uv0.isDown = false

					uv0._upFunc()
				end
			end)
		end

		if slot0._cancelFunc ~= nil then
			slot2 = slot0.fireBtnDelegate

			slot2:AddPointExitFunc(function ()
				if uv0.isDown then
					if uv0._main_cannon_sound then
						uv0._main_cannon_sound:Stop(true)
					end

					uv0.isDown = false

					uv0._cancelFunc()
				end
			end)
		end
	else
		if slot0.isDown then
			slot0.isDown = false

			slot0._cancelFunc()
		end

		setButtonEnabled(slot0.fireBtn, false)
		slot0.fireBtnDelegate:RemovePointDownFunc()
		slot0.fireBtnDelegate:RemovePointUpFunc()
		slot0.fireBtnDelegate:RemovePointExitFunc()
	end
end

slot0.flushTarget = function(slot0, slot1)
	if slot1 then
		slot0.targetCount = {
			2,
			4,
			6
		}
	end

	for slot5 = 1, 3 do
		for slot9 = 1, 6 do
			removeAllChildren(slot0.targetPanel:Find(&quot;line_&quot; .. slot5):GetChild(slot9 - 1))
		end
	end

	slot2 = {
		0,
		0,
		0
	}
	slot0.cell = {
		{},
		{},
		{}
	}

	for slot6, slot7 in ipairs(slot0.targetCount) do
		for slot11 = 1, slot7 do
			slot12 = math.random(3)
			slot13 = math.random(6)

			while slot0.cell[slot12][slot13] or slot1 and slot2[slot12] &gt;= 4 do
				slot13 = math.random(6)
				slot12 = math.random(3)
			end

			slot2[slot12] = slot2[slot12] + 1
			slot0.cell[slot12][slot13] = slot6

			cloneTplTo(slot0.targetTpl[slot6], slot0.targetPanel:Find(&quot;line_&quot; .. slot12):GetChild(slot13 - 1))
		end
	end

	setText(slot0.scoreTF, slot0.score)
end

slot0.checkHit = function(slot0)
	for slot4 = 1, 3 do
		for slot8 = 1, 6 do
			if slot0.cell[slot4][slot8] then
				slot9 = slot0.targetPanel:Find(&quot;line_&quot; .. slot4):GetChild(slot8 - 1):GetChild(0):Find(&quot;icon/face&quot;)
				slot10 = slot0.sightTF:InverseTransformPoint(slot9:TransformPoint(slot9.position))

				if slot10.x * slot10.x + slot10.y * slot10.y &lt; slot0.tempConfig.half * slot0.tempConfig.half then
					return true, slot4, slot8
				end
			end
		end
	end
end

slot0.willExit = function(slot0)
end

return slot0
</code></pre>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-lua.min.js"></script>
</body>
</html>