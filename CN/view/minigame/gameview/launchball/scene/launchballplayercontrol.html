<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>launchballplayercontrol.lua</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
</head>
<body>
    <h1>launchballplayercontrol.lua</h1>
    <a href="index.html">返回主页</a>
    <pre><code class="language-lua">slot0 = class(&quot;LaunchBallPlayerControl&quot;)
slot1 = {
	{
		id = 1,
		name = &quot;Hatsuduki&quot;,
		tpl = &quot;Hatsuduki&quot;,
		skill = {
			1,
			2,
			3,
			4
		}
	},
	{
		id = 2,
		name = &quot;Shinano&quot;,
		tpl = &quot;Shinano&quot;,
		skill = {
			1,
			5,
			6
		}
	},
	{
		id = 3,
		name = &quot;Yura&quot;,
		tpl = &quot;Yura&quot;,
		skill = {
			1,
			7,
			8
		}
	},
	{
		id = 4,
		name = &quot;Shimakaze&quot;,
		tpl = &quot;Shimakaze&quot;,
		skill = {
			1,
			9,
			10
		}
	}
}
slot2 = 1
slot3 = &quot;skill trigger&quot;
slot4 = &quot;skill passive&quot;
slot6 = &quot;skill type press&quot;
slot7 = &quot;skill type passive&quot;
slot0.buff_amulet_back_time = 0.4
slot0.buff_panic_fire_speed = 1
slot0.buff_panic_enemy_rate = 5
slot0.buff_sleep_butterfly_time = 2
slot0.slash_split_time = 0.5
slot0.stop_enemy_time = 10
slot0.buff_amulet_back = 1
slot0.buff_panic = 2
slot0.buff_neglect = 3
slot0.buff_sleep = 4
slot0.buff_time_max = 5
slot0.buff_time_slash = 6
slot0.script_remove_all_enemys = &quot;remove all enemys&quot;
slot0.script_stop_enemy = &quot;script_stop_enemy&quot;
slot0.script_slash = &quot;script_slash&quot;
slot0.player_skill = {
	{
		cd_time = 0.5,
		play_time = 0.25,
		name = &quot;atk&quot;,
		weight = 1,
		type = &quot;skill type fire&quot;,
		color = {
			1,
			2,
			3,
			4,
			5,
			6,
			7
		}
	},
	{
		cd_time = 20,
		play_time = 0.7,
		name = &quot;player1skillA&quot;,
		skill_direct = false,
		weight = 2,
		type = slot6,
		buff = {
			{
				time = 10,
				type = slot0.buff_amulet_back
			}
		}
	},
	{
		cd_time = 0,
		play_time = 0,
		name = &quot;panic&quot;,
		weight = 0,
		type = slot7,
		buff = {
			{
				time = 999999,
				type = slot0.buff_panic
			}
		}
	},
	{
		cd_time = 0,
		play_time = 1,
		name = &quot;neglect&quot;,
		weight = 0,
		type = slot7,
		buff = {
			{
				time = 999999,
				type = slot0.buff_neglect,
				active_rule = {
					weight = 10,
					play_time = 3.5,
					time = 10
				}
			}
		}
	},
	{
		cd_time = 0,
		play_time = 1,
		name = &quot;sleep&quot;,
		weight = 0,
		type = slot7,
		buff = {
			{
				time = 999999,
				type = slot0.buff_sleep,
				active_rule = {
					weight = 10,
					play_time = 3,
					time = 10
				}
			}
		}
	},
	{
		cd_time = 60,
		play_time = 1.3,
		name = &quot;player2SkillA&quot;,
		skill_direct = false,
		weight = 2,
		type = slot6,
		script = slot0.script_remove_all_enemys,
		buff = {}
	},
	{
		cd_time = 22,
		play_time = 1.3,
		name = &quot;player3SkillA&quot;,
		skill_direct = false,
		weight = 2,
		type = slot6,
		script = slot0.script_stop_enemy,
		buff = {}
	},
	{
		cd_time = 0,
		play_time = 0,
		name = &quot;player3Time&quot;,
		weight = 0,
		type = slot7,
		buff = {
			{
				time = 999999,
				type = slot0.buff_time_max
			}
		}
	},
	{
		name = &quot;player4SkillA&quot;,
		skill_direct = true,
		script_time = 0.5,
		cd_time = 20,
		play_time = 1,
		weight = 2,
		type = slot6,
		script = slot0.script_slash,
		effect = {
			time = 0.7,
			name = &quot;Slash&quot;,
			distance = 200,
			direct = true,
			remove_time = 0.5,
			anim = &quot;Slash&quot;
		}
	},
	{
		cd_time = 0,
		play_time = 0,
		name = &quot;player4SlashTime&quot;,
		weight = 0,
		type = slot7,
		buff = {
			{
				time = 999999,
				type = slot0.buff_time_slash
			}
		}
	}
}
slot8 = 270
slot9 = {
	{
		anim_name = &quot;E&quot;,
		range = {
			0,
			45
		},
		direct = {
			1,
			0
		}
	},
	{
		anim_name = &quot;N&quot;,
		range = {
			45,
			135
		},
		direct = {
			0,
			1
		}
	},
	{
		anim_name = &quot;W&quot;,
		range = {
			135,
			225
		},
		direct = {
			-1,
			0
		}
	},
	{
		anim_name = &quot;S&quot;,
		range = {
			225,
			315
		},
		direct = {
			0,
			-1
		}
	},
	{
		anim_name = &quot;E&quot;,
		range = {
			315,
			360
		},
		direct = {
			1,
			0
		}
	}
}
slot10 = &quot;Idle&quot;
slot11 = &quot;Buff&quot;
slot12 = &quot;Panic&quot;
slot13 = &quot;Attack&quot;
slot14 = &quot;Skill_A&quot;
slot15 = &quot;Skill_B&quot;
slot16 = {
	{
		anim_name = &quot;01_Yellow&quot;
	},
	{
		anim_name = &quot;02_Green&quot;
	},
	{
		anim_name = &quot;03_White&quot;
	},
	{
		anim_name = &quot;04_Red&quot;
	},
	{
		anim_name = &quot;05_Blue&quot;
	},
	{
		anim_name = &quot;06_Black&quot;
	},
	{
		anim_name = &quot;07_Purple&quot;
	}
}

slot17 = function(slot0, slot1, slot2)
	slot3 = {
		ctor = function (slot0)
			slot0.playerTf = uv0
			slot4 = Animator
			slot0.animator = GetComponent(findTF(slot0.playerTf, &quot;ad/anim&quot;), typeof(slot4))
			slot0.data = uv1
			slot0.eventCall = uv2
			slot0.panicFlag = false
			slot0.directRange = Clone(uv3)
			slot0.colors = Clone(uv4)
			slot0.skills = {}

			for slot4 = 1, #uv1.skill do
				slot5 = uv5.player_skill[uv1.skill[slot4]]

				table.insert(slot0.skills, {
					data = slot5,
					time = slot5.cd_time
				})
			end

			slot0.changeListener = GetOrAddComponent(findTF(slot0.playerTf, &quot;ad/change&quot;), typeof(EventTriggerListener))

			slot0.changeListener:AddPointDownFunc(function (slot0, slot1)
				uv0.eventCall(LaunchBallGameScene.CHANGE_AMULET)
				uv0:changePlayerStopTime(0)
			end)
		end,
		getId = function (slot0)
			return slot0.data.id
		end,
		start = function (slot0)
			slot0.useSkillTime = nil
			slot0.buffs = {}
			slot0.angle = uv0

			slot0:changePlaying(false)

			slot0.panicFlag = false
			slot0.idleAnimName = slot0:getIdleName()

			slot0:playAnim(slot0.idleAnimName)

			slot4 = uv1
			LaunchBallGameVo.pressSkill = slot0:getSkillByType(slot4)
			LaunchBallGameVo.buffs = slot0.buffs

			for slot4 = 1, #slot0.skills do
				slot0.skills[slot4].time = slot0.skills[slot4].data.cd_time

				if slot0.skills[slot4].data.type == uv2 then
					for slot9 = 1, #slot0.skills[slot4].data.buff do
						table.insert(slot0.buffs, {
							data = slot5[slot9],
							time = slot5[slot9].time
						})
					end
				end
			end

			slot0:changePlayerStopTime(0)
		end,
		step = function (slot0)
			if slot0.playTime and slot0.playTime &gt; 0 then
				slot0.playTime = slot0.playTime - LaunchBallGameVo.deltaTime

				if slot0.playTime &lt;= 0 then
					slot0:changePlaying(false)
				end
			end

			if slot0.randomFireTime and slot0.randomFireTime &gt; 0 then
				slot0.randomFireTime = slot0.randomFireTime - LaunchBallGameVo.deltaTime

				if slot0.randomFireTime &lt;= 0 then
					slot0.randomFireTime = nil

					slot0.eventCall(LaunchBallGameScene.RANDOM_FIRE, {
						num = 3,
						data = {
							[LaunchBallGameConst.amulet_buff_back] = true
						}
					})
				end
			end

			if slot0.sleepTimeTrigger and slot0.sleepTimeTrigger &gt; 0 then
				slot0.sleepTimeTrigger = slot0.sleepTimeTrigger - LaunchBallGameVo.deltaTime

				if slot0.sleepTimeTrigger &lt;= 0 then
					slot0.sleepTimeTrigger = nil

					slot0.eventCall(LaunchBallGameScene.SLEEP_TIME_TRIGGER)
				end
			end

			if not slot0.isPlaying and slot0.idleAnimName ~= slot0:getIdleName() then
				slot0:playAnim(slot1)

				slot0.idleAnimName = slot1
			end

			for slot4 = 1, #slot0.skills do
				if slot0.skills[slot4].time &gt; 0 then
					slot0.skills[slot4].time = slot0.skills[slot4].time - LaunchBallGameVo.deltaTime

					if slot0.skills[slot4].time &lt;= 0 then
						slot0.skills[slot4].time = 0
					end
				end
			end

			for slot4 = #slot0.buffs, 1, -1 do
				if slot0.buffs[slot4].time &gt; 0 then
					slot5.time = slot5.time - LaunchBallGameVo.deltaTime

					if slot5.time &lt;= 0 then
						table.remove(slot0.buffs, slot4)
					end
				end
			end

			for slot4 = #slot0.buffs, 1, -1 do
				if slot0.buffs[slot4].data.type == uv0.buff_panic then
					slot6 = false

					if LaunchBallGameVo.enemyToEndRate then
						for slot10 = 1, #LaunchBallGameVo.enemyToEndRate do
							if not slot6 and uv0.buff_panic_enemy_rate &lt; LaunchBallGameVo.enemyToEndRate[slot10] then
								slot6 = true
							end
						end
					end

					slot5.active = slot6

					if slot5.active and slot0:getSkillByType(uv1).time &gt; 0 then
						slot7.time = slot7.time - LaunchBallGameVo.deltaTime * uv0.buff_panic_fire_speed
					end
				elseif slot5.data.type == uv0.buff_neglect then
					slot0:updateBuffStopTime(slot5)
				elseif slot5.data.type == uv0.buff_sleep then
					slot0:updateBuffStopTime(slot5)
				else
					slot5.active = true
				end
			end

			slot0:changePlayerStopTime(slot0.playerStopTime + LaunchBallGameVo.deltaTime)
		end,
		setPlayTime = function (slot0, slot1)
			if slot1 and slot1 &gt; 0 then
				print(&quot;set play time &quot; .. slot1)

				slot0.isPlaying = true
			else
				print(&quot;clear play time&quot; .. slot1)

				slot0.isPlaying = false
			end

			slot0.playTime = slot1
		end,
		updateBuffStopTime = function (slot0, slot1)
			if not slot1.active and slot1.data.active_rule.time &lt; slot0.playerStopTime then
				slot1.active = true

				LaunchBallGameVo.AddGameResultData(LaunchBallGameVo.result_use_pass_skill, 1)
				slot0:setPlayTime(slot1.data.active_rule.play_time)

				slot0.weight = slot1.data.active_rule.weight

				if slot1.data.type == uv0.buff_neglect then
					slot0.randomFireTime = 1.5

					if slot0:getBuff(uv0.buff_panic).active then
						slot0:playAnim(&quot;Skill_B_Panic_Start&quot;)
					else
						slot0:playAnim(&quot;Skill_B_Start&quot;)
					end
				elseif slot1.data.type == uv0.buff_sleep then
					slot0:playAnim(&quot;Trans_Sleep_&quot; .. slot0:getDirectName(slot0.angle))
				end
			end

			if slot1.active and slot1.data.type == uv0.buff_sleep and not slot0.sleepTimeTrigger then
				slot0.sleepTimeTrigger = uv0.buff_sleep_butterfly_time
			end

			if slot1.active and slot0.playerStopTime &lt; slot1.data.active_rule.time then
				slot1.active = false
			end
		end,
		split = function (slot0, slot1)
			if slot1.split and slot0:getBuff(uv0.buff_time_slash) and slot0:getSkillByType(uv1) and slot3.time &gt; 0 then
				slot3.time = slot3.time - uv0.slash_split_time
			end
		end,
		changePlaying = function (slot0, slot1, slot2)
			if slot1 then
				slot0:setPlayTime(slot2.data.play_time)

				slot0.weight = slot2.data.weight
			else
				slot0:setPlayTime(0)

				slot0.weight = 0
			end

			if slot0.eventCall then
				slot0.eventCall(LaunchBallGameScene.PLAYING_CHANGE, slot1)
			end
		end,
		fire = function (slot0)
			if slot0:checkSkillAble(slot0:getSkillByType(uv0)) then
				slot0:changePlayerStopTime(0)

				if not LaunchBallGameVo.amulet then
					print(&quot;当前没有可以发射的符咒&quot;)

					return
				end

				slot0:appearSkill(slot1)
			end
		end,
		getSkillByType = function (slot0, slot1)
			for slot5 = 1, #slot0.skills do
				if slot0.skills[slot5].data.type == slot1 then
					return slot6
				end
			end

			return nil
		end,
		checkSkillAble = function (slot0, slot1)
			if slot1.time &gt; 0 then
				print(&quot;还在cd中 cd = &quot; .. slot1.time)

				return false
			end

			if slot0.isPlaying and slot1.data.weight &lt;= slot0.weight then
				print(&quot;权重不够无法覆盖当前的技能&quot;)

				return false
			end

			return true
		end,
		appearSkill = function (slot0, slot1)
			slot0:changePlayerStopTime(0)
			slot0:changePlaying(true, slot1)

			slot1.time = slot1.data.cd_time

			if slot1.data.type == uv0 then
				slot0:playAnim(slot0:getSkillAnimName(slot1, LaunchBallGameVo.amulet.color))
				slot0.eventCall(LaunchBallGameScene.FIRE_AMULET)
			elseif slot1.data.type == uv1 then
				print(&quot;使用了主动技能&quot;)
				slot0:playAnim(slot0:getSkillAnimName(slot1))

				slot0.idleAnimName = nil

				if slot0.useSkillTime then
					LaunchBallGameVo.UpdateGameResultData(LaunchBallGameVo.reuslt_double_skill_time, LaunchBallGameVo.gameStepTime - slot0.useSkillTime)
				else
					slot0.useSkillTime = LaunchBallGameVo.gameStepTime
				end

				pg.CriMgr.GetInstance():PlaySoundEffect_V3(LaunchBallGameVo.SFX_PRESS_SKILL)
				LaunchBallGameVo.AddGameResultData(LaunchBallGameVo.result_use_skill, 1)
			end

			if slot1.data.buff then
				for slot6 = 1, #slot2 do
					slot7 = slot2[slot6]

					table.insert(slot0.buffs, {
						data = slot7,
						time = slot7.time
					})
				end
			end

			if slot1.data.script then
				if slot1.data.script == uv2.script_remove_all_enemys then
					slot0.eventCall(LaunchBallGameScene.SPLIT_ALL_ENEMYS, {
						time = 1.3,
						effect = true
					})
				elseif slot1.data.script == uv2.script_stop_enemy then
					slot0.eventCall(LaunchBallGameScene.STOP_ENEMY_TIME, {
						time = uv2.stop_enemy_time
					})
				elseif slot1.data.script == uv2.script_slash then
					slot0.eventCall(LaunchBallGameScene.SLASH_ENEMY, {
						time = slot1.data.script_time,
						direct = slot0:getDirectName(slot0.angle)
					})
					slot0.eventCall(LaunchBallGameScene.PLAYER_EFFECT, slot1.data.effect)
				end
			end
		end,
		getSkillAnimName = function (slot0, slot1, slot2)
			slot3 = &quot;&quot;
			slot4, slot5, slot6, slot7 = nil

			if slot1.data.type == uv0 then
				slot4 = uv1

				if slot0:getBuff(uv2.buff_panic) and slot9.active then
					slot5 = uv3
				end

				slot6 = slot0:getDirectName(slot0.angle)

				if slot2 then
					slot7 = slot0:getColorName(slot2)
				end

				if slot5 then
					slot3 = slot4 .. &quot;_&quot; .. slot5 .. &quot;_&quot; .. slot6 .. &quot;_&quot; .. slot7
				else
					slot3 = slot4 .. &quot;_&quot; .. slot6 .. &quot;_&quot; .. slot7
				end
			elseif slot8.type == uv4 then
				slot3 = uv5

				if slot8.skill_direct then
					slot3 = slot3 .. &quot;_&quot; .. slot0:getDirectName(slot0.angle)
				end
			end

			return slot3
		end,
		getBuff = function (slot0, slot1)
			for slot5 = 1, #slot0.buffs do
				if slot0.buffs[slot5].data.type == slot1 then
					return slot0.buffs[slot5]
				end
			end

			return nil
		end,
		getColorName = function (slot0, slot1)
			return slot0.colors[slot1].anim_name
		end,
		useSkill = function (slot0)
			if not slot0:getSkillByType(uv0) then
				return
			end

			if slot0:checkSkillAble(slot1) then
				slot0:appearSkill(slot1)
			end
		end,
		clear = function (slot0)
		end,
		setAngle = function (slot0, slot1)
			slot0:changePlayerStopTime(0)

			slot0.angle = (LaunchBallGameVo.joyStickData.angle + 360) % 360
		end,
		changePlayerStopTime = function (slot0, slot1)
			if slot0:getBuff(uv0.buff_neglect) then
				if slot0:getBuff(uv0.buff_neglect).active and slot0.playTime &gt; 0 then
					return
				end
			elseif slot0:getBuff(uv0.buff_sleep) and slot0:getBuff(uv0.buff_sleep).active and slot0.playTime &gt; 0 then
				return
			end

			slot0.playerStopTime = slot1
		end,
		playAnim = function (slot0, slot1)
			print(&quot;play anim is &quot; .. slot1)
			slot0.animator:Play(slot1)
		end,
		getIdleName = function (slot0)
			slot1 = uv0
			slot2, slot3, slot4 = nil
			slot2 = slot0:getDirectName(slot0.angle)
			slot6 = slot0:getBuff(uv1.buff_panic)

			if slot0:getBuff(uv1.buff_amulet_back) and slot5.active then
				slot4 = uv2
			end

			if slot6 and slot6.active then
				slot3 = uv3
			end

			if slot4 then
				slot1 = slot1 .. &quot;_&quot; .. slot4
			elseif slot3 then
				slot1 = slot1 .. &quot;_&quot; .. slot3
			end

			if slot2 then
				slot1 = slot1 .. &quot;_&quot; .. slot2
			end

			return slot1
		end,
		getDirectName = function (slot0, slot1)
			slot2, slot3 = nil

			for slot7 = 1, #slot0.directRange do
				if slot0.directRange[slot7].range[1] &lt;= slot1 and slot1 &lt; slot8[2] then
					slot2 = slot0.directRange[slot7].anim_name
					slot3 = slot0.directRange[slot7].direct
				end
			end

			return slot2, slot3
		end,
		setContent = function (slot0, slot1, slot2)
			setParent(slot0.playerTf, slot1)
			setActive(slot0.playerTf, true)

			if slot2 then
				slot0.playerTf.anchoredPosition = slot2
			else
				slot0.playerTf.anchoredPosition = Vector2(0, 0)
			end
		end,
		dispose = function (slot0)
			if slot0.changeListener then
				ClearEventTrigger(slot0.changeListener)
			end

			if slot0.playerTf then
				Destroy(slot0.playerTf)

				slot0.playerTf = nil
			end
		end
	}

	slot3:ctor()

	return slot3
end

slot0.Ctor = function(slot0, slot1, slot2, slot3, slot4)
	slot0._topContent = slot1
	slot0._content = slot2
	slot0._tpl = slot3
	slot0._eventCall = slot4
end

slot0.setPlayerData = function(slot0, slot1)
	if slot0.player and slot0.player:getId() ~= slot1.id then
		slot0.player:dispose()

		slot0.player = nil
		slot0.player = slot0:createPlayer(slot1)
	elseif not slot0.player then
		slot0.player = slot0:createPlayer(slot1)
	end
end

slot0.createPlayer = function(slot0, slot1)
	slot3 = uv0(tf(instantiate(findTF(slot0._tpl, slot1.tpl))), slot1, slot0._eventCall)

	slot3:setContent(slot0._content)

	return slot3
end

slot0.start = function(slot0)
	slot0.playerId = LaunchBallGameVo.selectPlayer

	slot0:setPlayerData(uv0[slot0.playerId])
	slot0.player:start()

	slot0.effects = {}
end

slot0.step = function(slot0)
	if LaunchBallGameVo.joyStickData and LaunchBallGameVo.joyStickData.active and LaunchBallGameVo.joyStickData.angle then
		slot0.player:setAngle(LaunchBallGameVo.joyStickData.angle)
	end

	if slot0.effects and #slot0.effects &gt; 0 then
		for slot4 = #slot0.effects, 1, -1 do
			slot5 = slot0.effects[slot4].tf
			slot6 = slot0.effects[slot4].anim
			slot7 = slot0.effects[slot4].animName
			slot8 = slot0.effects[slot4].removeTime

			if slot0.effects[slot4].time and slot0.effects[slot4].time &gt; 0 then
				slot0.effects[slot4].time = slot0.effects[slot4].time - LaunchBallGameVo.deltaTime

				if slot0.effects[slot4].time &lt; 0 then
					slot0.effects[slot4].time = nil

					setActive(slot5, false)
					setActive(slot5, true)
					slot6:Play(slot7)
				end
			elseif slot0.effects[slot4].removeTime and slot0.effects[slot4].removeTime &gt; 0 then
				slot0.effects[slot4].removeTime = slot0.effects[slot4].removeTime - LaunchBallGameVo.deltaTime

				if slot0.effects[slot4].removeTime &lt; 0 then
					slot0.effects[slot4].removeTime = nil

					setActive(slot5, false)
					table.remove(slot0.effects, slot4)
				end
			end
		end
	end

	slot0.player:step()
end

slot0.eventCall = function(slot0, slot1, slot2)
	if slot1 == LaunchBallGameScene.CHANGE_AMULET then
		-- Nothing
	elseif slot1 == LaunchBallGameScene.PLAYER_EFFECT then
		if slot2 then
			slot4 = nil
			slot7 = GetComponent(findTF(findTF(slot0._topContent, &quot;effect/&quot; .. slot3.name), &quot;ad/anim&quot;), typeof(Animator))
			slot8 = slot3.anim
			slot9 = slot3.distance
			slot10 = Vector2(0, 0)

			if slot3.direct then
				slot11, slot12 = slot0.player:getDirectName(slot0.player.angle)
				slot8 = slot8 .. &quot;_&quot; .. slot11
				slot6.anchoredPosition = Vector2(slot12[1] * slot9, slot12[2] * slot9)
			end

			table.insert(slot0.effects, {
				tf = slot6,
				anim = slot7,
				time = slot3.time,
				removeTime = slot3.remove_time,
				animName = slot8
			})
		end
	elseif slot1 == LaunchBallGameScene.SPILT_ENEMY_SCORE then
		slot0.player:split(slot2)
	end
end

slot0.press = function(slot0, slot1)
	if slot1 == KeyCode.J and slot0.player then
		slot0.player:fire()
	end
end

slot0.joystickActive = function(slot0, slot1)
	if not slot1 and slot0.player then
		slot0.player:fire()
	end
end

slot0.useSkill = function(slot0)
	if slot0.player then
		slot0.player:useSkill()
	end
end

slot0.clear = function(slot0)
	slot0.player:clear()
end

return slot0
</code></pre>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-lua.min.js"></script>
</body>
</html>