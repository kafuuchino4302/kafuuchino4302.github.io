<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>castlegamescene.lua</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
</head>
<body>
    <h1>castlegamescene.lua</h1>
    <a href="index.html">返回主页</a>
    <pre><code class="language-lua">slot0 = class(&quot;CastleGameScene&quot;)
slot1 = 1
slot2 = 2
slot3 = 3
slot4 = 4

slot0.Ctor = function(slot0, slot1, slot2)
	slot0._tf = slot1
	slot0._event = slot2
	slot0.sceneMask = findTF(slot0._tf, &quot;sceneMask&quot;)
	slot0.tplContent = findTF(slot0._tf, &quot;sceneMask/sceneContainer/scene/tpl&quot;)
	slot0.floorTpl = findTF(slot0._tf, &quot;sceneMask/sceneContainer/scene/tpl/floorTpl&quot;)
	slot0.charTpl = findTF(slot0._tf, &quot;sceneMask/sceneContainer/scene/tpl/charTpl&quot;)
	slot0.carriageTpl = findTF(slot0._tf, &quot;sceneMask/sceneContainer/scene/tpl/carriageTpl&quot;)
	slot0.bubbleTpl = findTF(slot0._tf, &quot;sceneMask/sceneContainer/scene/tpl/bubbleTpl&quot;)
	slot0.scoreTpl = findTF(slot0._tf, &quot;sceneMask/sceneContainer/scene/tpl/scoreTpl&quot;)
	slot0.contentBack = findTF(slot0._tf, &quot;sceneMask/sceneContainer/scene_background/content&quot;)
	slot0.contentMid = findTF(slot0._tf, &quot;sceneMask/sceneContainer/scene/content&quot;)
	slot0.contentTop = findTF(slot0._tf, &quot;sceneMask/sceneContainer/scene_front/content&quot;)
	slot0.contentEF = findTF(slot0._tf, &quot;sceneMask/sceneContainer/scene/effect_front&quot;)
	slot3 = CastleGameVo.GetRotationPosByWH(0, -1)
	slot0.gameFloor = CastleGameFloor.New(slot0.floorTpl, slot0._event)
	slot0.gameChar = CastleGameChar.New(slot0.charTpl, slot0._event)
	slot0.gameItem = CastleGameItem.New(slot0.tplContent, slot0._event)
	slot0.gameRemind = CastleGameRemind.New(slot0.tplContent, slot0._event)
	slot0.gameScore = CastleGameScore.New(slot0.scoreTpl, slot0._event)

	slot0.gameFloor:setContent(slot0:getContent(uv0))
	slot0.gameChar:setContent(slot0:getContent(uv1))
	slot0.gameItem:setContent(slot0:getContent(uv1))
	slot0.gameRemind:setContent(slot0:getContent(uv2))
	slot0.gameScore:setContent(slot0:getContent(uv1))
	slot0.gameFloor:setFloorFallCallback(function (slot0)
		uv0:addRemindItems(slot0)
	end)
	slot0.gameChar:setOutLandPoint(slot0.gameFloor:getOutLandPoint())

	slot0.floorItems = {}

	slot0:insertFloorItem(slot0.gameFloor:getFloors())

	slot0.items = {}

	table.insert(slot0.items, slot0.gameChar:getChar())
	slot0.gameItem:setItemRemindCallback(function (slot0)
		uv0:addRemindItems(slot0)
	end)
	slot0.gameItem:setItemChange(function (slot0, slot1)
		uv0:itemChange(slot0, slot1)
	end)
	slot0.gameItem:setFloorBroken(function (slot0, slot1)
		for slot5, slot6 in ipairs(slot0) do
			uv0.gameFloor:setBroken(slot6, slot1)
		end
	end)
	slot0.gameScore:setItemChange(function (slot0, slot1)
		uv0:itemChange(slot0, slot1)
	end)
	slot0.gameItem:setBubbleBroken(function (slot0)
		if slot0 and slot0.char then
			uv0:returnPlayerBubble(slot0, slot0.char)
		end
	end)
	slot0:sortItems(slot0.floorItems)
end

slot0.addRemindItems = function(slot0, slot1)
	for slot5 = 1, #slot1 do
		slot6 = slot1[slot5]

		slot0.gameRemind:addRemind(slot6.w, slot6.h, slot6.type and slot6.type or CastleGameRemind.remind_type_1)
	end
end

slot0.itemChange = function(slot0, slot1, slot2)
	if slot2 then
		if table.contains(slot0.items, slot1) then
			return
		end

		table.insert(slot0.items, slot1)
	else
		for slot6 = 1, #slot0.items do
			if slot0.items[slot6] == slot1 then
				table.remove(slot0.items, slot6)

				return
			end
		end
	end
end

slot0.start = function(slot0)
	slot0:prepareScene()
	slot0.gameFloor:start()
	slot0.gameChar:start()
	slot0.gameItem:start()
	slot0.gameRemind:start()
	slot0.gameScore:start()
end

slot0.step = function(slot0)
	slot0.gameFloor:step()
	slot0.gameChar:step()
	slot0.gameItem:step()
	slot0.gameRemind:step()
	slot0.gameScore:step()
	slot0:sortItems(slot0.items)
	slot0:updateActiveFloor()
	slot0:checkPlayerInFloor()
	slot0:checkPlayerInBubble()
	slot0:checkPlayerCarriage()
	slot0:checkPlayerInScore()
end

slot0.clear = function(slot0)
	slot0.gameFloor:clear()
	slot0.gameChar:clear()
	slot0.gameItem:clear()
	slot0.gameRemind:clear()
end

slot0.stop = function(slot0)
end

slot0.resume = function(slot0)
end

slot0.dispose = function(slot0)
end

slot0.prepareScene = function(slot0)
	slot0:showContainer(true)
	slot0:sortItems(slot0.floorItems)
	slot0.gameChar:setContent(slot0:getContent(uv0))
	CastleGameVo.PointFootLine(Vector2(0, 0), Vector2(0, 100), Vector2(100, 0))
end

slot0.updateActiveFloor = function(slot0)
	slot0.gameItem:setFloorIndexs(slot0.gameFloor:getActiveIndexs())
	slot0.gameScore:setFloor(slot0.gameFloor:getFloors())
end

slot0.checkPlayerInScore = function(slot0)
	if slot0.gameChar:getActionAble() then
		slot2 = slot0.gameChar:getChar().tf.anchoredPosition

		for slot7 = 1, #slot0.gameScore:getScores() do
			if slot3[slot7].ready == 0 then
				slot9 = slot8.tf.anchoredPosition
				slot10 = slot8.bmin
				slot11 = slot8.bmax
				slot13 = Vector2(slot9.x + slot11.x, slot9.y + slot11.y)

				if Vector2(slot9.x + slot10.x, slot9.y + slot10.y).x &lt;= slot2.x and slot12.y &lt;= slot2.y and slot2.x &lt;= slot13.x and slot2.y &lt;= slot13.y then
					slot0:setPlayerScore(slot8, slot1)

					return
				end
			end
		end
	end
end

slot0.checkPlayerInBubble = function(slot0)
	if slot0.gameChar:getActionAble() then
		slot2 = slot0.gameChar:getChar().tf.anchoredPosition

		for slot7 = 1, #slot0.gameItem:getBubbles() do
			if slot3[slot7].ready == 0 and not slot8.broken and isActive(slot8.tf) and slot8.hit then
				slot9 = slot8.tf.anchoredPosition
				slot10 = slot8.bmin
				slot11 = slot8.bmax
				slot13 = Vector2(slot9.x + slot11.x, slot9.y + slot11.y)

				if Vector2(slot9.x + slot10.x, slot9.y + slot10.y).x &lt;= slot2.x and slot12.y &lt;= slot2.y and slot2.x &lt;= slot13.x and slot2.y &lt;= slot13.y then
					slot0:setPlayerBubble(slot8, slot1)

					return
				end
			end
		end
	end
end

slot0.checkPlayerBoom = function(slot0)
	if slot0.gameChar:getActionAble() then
		slot2 = slot0.gameChar:getChar().tf.anchoredPosition
		slot4 = false

		for slot8 = 1, #slot0.gameItem:getBooms() do
			if slot3[slot8].ready and slot9.ready == 0 and not slot9.broken and slot9.brokenTime &lt; 1 then
				slot10 = slot9.boundPoints

				if not slot4 then
					slot12 = CastleGameVo.PointInTriangle(slot2, slot10[3], slot10[4], slot10[1])

					if CastleGameVo.PointInTriangle(slot2, slot10[1], slot10[2], slot10[3]) then
						slot4 = true
					elseif slot12 then
						slot4 = true
					end
				end

				if slot4 then
					slot0.gameChar:setPlayerFail()

					return
				end
			end
		end
	end
end

slot0.checkPlayerCarriage = function(slot0)
	if slot0.gameChar:getActionAble() then
		slot2 = slot0.gameChar:getChar().tf.anchoredPosition

		for slot7 = 1, #slot0.gameItem:getCarriages() do
			slot8 = slot3[slot7]
			slot9 = slot8.bmin
			slot10 = slot8.bmax
			slot11 = slot8.tf.anchoredPosition
			slot13 = Vector2(slot11.x + slot10.x, slot11.y + slot10.y)

			if Vector2(slot11.x + slot9.x, slot11.y + slot9.y).x &lt;= slot2.x and slot12.y &lt;= slot2.y and slot2.x &lt;= slot13.x and slot2.y &lt;= slot13.y then
				slot0.gameChar:setPlayerFail()

				return
			end
		end
	end
end

slot0.setPlayerScore = function(slot0, slot1, slot2)
	slot0.gameChar:setScore(slot1)
	slot0.gameScore:hitScore(slot1)
	slot0._event:emit(CastleGameView.ADD_SCORE, {
		num = slot1.data.score,
		pos = slot0.gameChar:getChar().tf.position,
		id = slot1.id
	})
end

slot0.returnPlayerBubble = function(slot0, slot1, slot2)
	slot0.gameChar:setContent(slot0.contentTop)
	slot0.gameChar:setInBubble(false)

	slot1.char = nil
end

slot0.setPlayerBubble = function(slot0, slot1, slot2)
	slot0.gameChar:setInBubble(true)
	slot0.gameChar:setContent(slot1.pos, Vector3(0, 0, 0))

	slot1.char = slot2

	slot0.gameItem:playerInBubble(slot1, slot2)
end

slot0.checkPlayerInFloor = function(slot0)
	if slot0.gameChar:getActionAble() then
		slot2 = slot0.gameChar:getChar().tf.anchoredPosition
		slot4 = false

		for slot8 = 1, #slot0.gameFloor:getFloors() do
			slot10 = slot3[slot8].bound

			if not slot4 then
				slot12 = CastleGameVo.PointInTriangle(slot2, slot10[3], slot10[4], slot10[1])

				if CastleGameVo.PointInTriangle(slot2, slot10[1], slot10[2], slot10[3]) then
					slot4 = true
				elseif slot12 then
					slot4 = true
				end
			end

			if slot4 then
				slot1.floor = slot3[slot8]

				if slot9.fall == true then
					slot0:setCharFall()
				end

				return
			end
		end
	end
end

slot0.setCharFall = function(slot0)
	slot0.gameChar:setInGround(false)
end

slot0.insertFloorItem = function(slot0, slot1)
	for slot5 = 1, #slot1 do
		table.insert(slot0.floorItems, slot1[slot5])
	end
end

slot0.getContent = function(slot0, slot1)
	slot2 = nil

	if slot1 == uv0 then
		slot2 = slot0.contentBack
	elseif slot1 == uv1 then
		slot2 = slot0.contentMid
	elseif slot1 == uv2 then
		slot2 = slot0.contentTop
	elseif slot1 == uv3 then
		slot2 = slot0.contentEF
	end

	return slot2
end

slot0.sortItems = function(slot0, slot1)
	table.sort(slot1, function (slot0, slot1)
		if slot1.tf.anchoredPosition.y &lt; slot0.tf.anchoredPosition.y then
			return false
		elseif slot2.y &lt; slot3.y then
			return true
		end

		if slot3.x &lt; slot2.x then
			return false
		elseif slot2.x &lt; slot3.x then
			return true
		end

		return false
	end)

	for slot5 = 1, #slot1 do
		slot1[slot5].tf:SetSiblingIndex(0)
	end
end

slot0.compareByPosition = function(slot0, slot1, slot2)
end

slot0.compareWithPosBound = function(slot0, slot1, slot2)
	return CastleGameVo.PointLeftLine(slot1, slot2[1], slot2[4])
end

slot0.showContainer = function(slot0, slot1)
	setActive(slot0.sceneMask, slot1)
end

slot0.press = function(slot0, slot1)
	slot0.gameFloor:press(slot1)
	slot0:sortItems(slot0.floorItems)
end

return slot0
</code></pre>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-lua.min.js"></script>
</body>
</html>