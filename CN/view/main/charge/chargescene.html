<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>chargescene.lua</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
</head>
<body>
    <h1>chargescene.lua</h1>
    <a href="index.html">返回主页</a>
    <pre><code class="language-lua">slot0 = class(&quot;ChargeScene&quot;, import(&quot;...base.BaseUI&quot;))
slot0.TYPE_DIAMOND = 1
slot0.TYPE_GIFT = 2
slot0.TYPE_ITEM = 3
slot0.TYPE_PICK = 4

slot0.getUIName = function(slot0)
	return &quot;ChargeShopUI&quot;
end

slot0.onBackPressed = function(slot0)
	slot0:closeView()
end

slot0.preload = function(slot0, slot1)
	slot3 = function()
		slot1 = uv0:getChargedList()
		slot2 = uv0:GetNormalList()
		slot3 = uv0:GetNormalGroupList()

		if uv0:getFirstChargeList() then
			uv1:setFirstChargeIds(slot0)
		end

		if slot1 then
			uv1:setChargedList(slot1)
		end

		if slot2 then
			uv1:setNormalList(slot2)
		end

		if slot3 then
			uv1:setNormalGroupList(slot3)
		end

		uv2()
	end

	if getProxy(ShopsProxy):ShouldRefreshChargeList() then
		pg.m02:sendNotification(GAME.GET_CHARGE_LIST, {
			callback = slot3
		})
	else
		slot3()
	end
end

slot0.setPlayer = function(slot0, slot1)
	slot0.player = slot1
end

slot0.setFirstChargeIds = function(slot0, slot1)
	slot0.firstChargeIds = slot1
end

slot0.setChargedList = function(slot0, slot1)
	slot0.chargedList = slot1
end

slot0.setNormalList = function(slot0, slot1)
	slot0.normalList = slot1
end

slot0.setNormalGroupList = function(slot0, slot1)
	slot0.normalGroupList = slot1

	slot0:addRefreshTimer(GetZeroTime())
end

slot0.ResUISettings = function(slot0)
	return true
end

slot0.init = function(slot0)
	slot0.blurPanel = slot0:findTF(&quot;blur_panel&quot;)
	slot0.top = slot0:findTF(&quot;adapt/top&quot;, slot0.blurPanel)
	slot0.frame = slot0:findTF(&quot;frame&quot;)
	slot0.viewContainer = slot0:findTF(&quot;viewContainer&quot;)
	slot0.bg = slot0:findTF(&quot;viewContainer/bg&quot;)
	slot0.painting = slot0:findTF(&quot;frame/painting&quot;)
	slot0.chat = slot0:findTF(&quot;viewContainer/chat&quot;)
	slot0.chatText = slot0:findTF(&quot;Text&quot;, slot0.chat)
	slot0.switchBtn = slot0:findTF(&quot;blur_panel/adapt/switch_btn&quot;)
	slot0.skinShopBtn = slot0:findTF(&quot;blur_panel/adapt/skin_btn&quot;)

	setActive(slot0.skinShopBtn, not (LOCK_SKIN_SHOP_ENTER and getProxy(PlayerProxy):getData().level &lt; LOCK_SKIN_SHOP_ENTER_LEVEL))

	slot0.itemToggle = slot0:findTF(&quot;toggle_list/item_toggle&quot;, slot0.viewContainer)
	slot0.giftToggle = slot0:findTF(&quot;toggle_list/gift_toggle&quot;, slot0.viewContainer)
	slot0.diamondToggle = slot0:findTF(&quot;toggle_list/diamond_toggle&quot;, slot0.viewContainer)
	slot0.giftTip = slot0:findTF(&quot;tip&quot;, slot0.giftToggle)
	slot0.pickToggle = slot0:findTF(&quot;toggle_list/pick_toggle&quot;, slot0.viewContainer)
	slot0.pickTip = slot0:findTF(&quot;tip&quot;, slot0.pickToggle)
	slot0.chargeTipWindow = ChargeTipWindow.New(slot0._tf, slot0.event)

	setText(slot0:findTF(&quot;light/title&quot;, slot0.diamondToggle), i18n(&quot;shop_diamond_title&quot;))
	setText(slot0:findTF(&quot;dark/title&quot;, slot0.diamondToggle), i18n(&quot;shop_diamond_title&quot;))
	setText(slot0:findTF(&quot;light/title&quot;, slot0.giftToggle), i18n(&quot;shop_gift_title&quot;))
	setText(slot0:findTF(&quot;dark/title&quot;, slot0.giftToggle), i18n(&quot;shop_gift_title&quot;))
	setText(slot0:findTF(&quot;light/title&quot;, slot0.itemToggle), i18n(&quot;shop_item_title&quot;))
	setText(slot0:findTF(&quot;dark/title&quot;, slot0.itemToggle), i18n(&quot;shop_item_title&quot;))
	setText(slot0:findTF(&quot;light/title&quot;, slot0.pickToggle), i18n(&quot;shop_akashi_pick_title&quot;))
	setText(slot0:findTF(&quot;dark/title&quot;, slot0.pickToggle), i18n(&quot;shop_akashi_pick_title&quot;))

	slot0.linkTitle = {
		slot0:findTF(&quot;title/title_diamond&quot;, slot0.top),
		slot0:findTF(&quot;title/title_gift&quot;, slot0.top),
		slot0:findTF(&quot;title/title_item&quot;, slot0.top),
		slot0:findTF(&quot;title/title_pick&quot;, slot0.top)
	}
	slot0.toggleList = {
		slot0.diamondToggle,
		slot0.giftToggle,
		slot0.itemToggle,
		slot0.pickToggle
	}

	if Live2dConst.GetLive2DArm32MatchAble() then
		slot10 = Ship.New({
			configId = 312011
		})
		slot11 = slot10:getPainting()

		LoadPaintingPrefabAsync(slot0.painting, slot11, slot11, &quot;mainNormal&quot;, function ()
			uv0.loading = false
		end)
	else
		slot0:createLive2D()
	end

	slot0.live2dTimer = Timer.New(function ()
		slot0 = pg.ChargeShipTalkInfo.Actions

		if uv0:checkBuyDone(slot0[math.random(#slot0)].action) then
			uv0:displayShipWord(nil, false, slot1.dialog_index)
		end
	end, 20, -1)

	slot0.live2dTimer:Start()
	slot0:jpUIInit()
	slot0:blurView()
	slot0:initSubView()
end

slot0.didEnter = function(slot0)
	setActive(slot0.chat, false)
	onButton(slot0, slot0:findTF(&quot;back_button&quot;, slot0.top), function ()
		uv0:closeView()
	end, SFX_CANCEL)

	slot4 = function()
		uv0:displayShipWord()
		uv0:emit(ChargeMediator.CLICK_MING_SHI)
	end

	onButton(slot0, slot0.painting, slot4, SFX_PANEL)

	for slot4 = 1, #slot0.toggleList do
		onToggle(slot0, slot0.toggleList[slot4], function (slot0)
			setActive(uv0:findTF(&quot;dark&quot;, uv1), not slot0)

			if slot0 then
				uv0:switchSubView(uv2)
			end
		end, SFX_PANEL)
	end

	onButton(slot0, slot0.switchBtn, function ()
		uv0:emit(ChargeMediator.SWITCH_TO_SHOP, {
			warp = NewShopsScene.TYPE_SHOP_STREET
		})
		uv0:stopCV()
	end, SFX_PANEL)
	onButton(slot0, slot0.skinShopBtn, function ()
		uv0:emit(ChargeMediator.ON_SKIN_SHOP)
	end, SFX_PANEL)
	slot0:updateNoRes()

	if slot0.contextData.wrap ~= nil then
		slot0:switchSubViewByTogger(slot0.contextData.wrap)

		slot0.contextData.wrap = nil
	else
		slot0:switchSubViewByTogger(ChargeScene.TYPE_DIAMOND)
	end

	slot0:jpUIEnter()
end

slot0.OnChargeSuccess = function(slot0, slot1)
	slot0.chargeTipWindow:ExecuteAction(&quot;Show&quot;, slot1)
end

slot0.willExit = function(slot0)
	slot0:unBlurView()

	if slot0.chargeTipWindow then
		slot0.chargeTipWindow:Destroy()

		slot0.chargeTipWindow = nil
	end

	if slot0.heartsTimer then
		slot0.heartsTimer:Stop()

		slot0.heartsTimer = nil
	end

	if slot0.live2dChar then
		slot0.live2dChar:Dispose()
	end

	if slot0.live2dTimer then
		slot0.live2dTimer:Stop()

		slot0.live2dTimer = nil
	end

	if slot0.giftShopView then
		slot0.giftShopView:OnDestroy()
	end

	slot0:stopCV()
end

slot0.initSubView = function(slot0)
	slot0.subViewContainer = slot0:findTF(&quot;SubView&quot;, slot0.viewContainer)
	slot0.diamondShopView = ChargeDiamondShopView.New(slot0.subViewContainer, slot0.event, slot0.contextData)
	slot0.giftShopView = ChargeGiftShopView.New(slot0.subViewContainer, slot0.event, slot0.contextData)
	slot0.itemShopView = ChargeItemShopView.New(slot0.subViewContainer, slot0.event, slot0.contextData)
	slot0.pickShopView = ChargePickShopView.New(slot0.subViewContainer, slot0.event, slot0.contextData)
	slot0.curSubViewNum = 0
	slot0.subViewList = {
		[ChargeScene.TYPE_DIAMOND] = slot0.diamondShopView,
		[ChargeScene.TYPE_GIFT] = slot0.giftShopView,
		[ChargeScene.TYPE_ITEM] = slot0.itemShopView,
		[ChargeScene.TYPE_PICK] = slot0.pickShopView
	}
end

slot0.switchSubView = function(slot0, slot1)
	if slot1 == slot0.curSubViewNum then
		return
	end

	slot0.subViewList[slot1]:setGoodData(slot0.firstChargeIds, slot0.chargedList, slot0.normalList, slot0.normalGroupList)
	slot0.subViewList[slot1]:Reset()
	slot0.subViewList[slot1]:Load()

	if slot0.subViewList[slot0.curSubViewNum] then
		slot2:Destroy()
	end

	slot0.curSubViewNum = slot1

	if PLATFORM_CODE == PLATFORM_JP then
		setActive(slot0.userAgreeBtn3, slot1 == uv0.TYPE_DIAMOND)
		setActive(slot0.userAgreeBtn4, slot1 == uv0.TYPE_DIAMOND)
	end

	for slot6, slot7 in ipairs(slot0.linkTitle) do
		setActive(slot7, slot6 == slot1)
	end
end

slot0.switchSubViewByTogger = function(slot0, slot1)
	triggerToggle(slot0.toggleList[slot1], true)
end

slot0.updateCurSubView = function(slot0)
	slot1 = slot0.subViewList[slot0.curSubViewNum]

	slot1:setGoodData(slot0.firstChargeIds, slot0.chargedList, slot0.normalList, slot0.normalGroupList)
	slot1:reUpdateAll()
end

slot0.updateNoRes = function(slot0, slot1)
	if not slot1 then
		slot1 = slot0.contextData.noRes
	else
		slot0.contextData.noRes = slot1
	end

	if not slot1 or #slot1 &lt;= 0 then
		return
	end

	slot0.contextData.noRes = {}
	slot3 = getProxy(BagProxy):getData()
	slot4 = &quot;&quot;

	for slot8, slot9 in ipairs(slot1) do
		if slot9[2] &gt; 0 then
			if slot9[1] == 59001 then
				slot1[slot8][2] = slot9[3] - slot0.player.gold
			else
				slot1[slot8][2] = slot9[3] - (slot3[slot9[1]] and slot3[slot9[1]].count or 0)
			end
		end

		if slot1[slot8][2] &gt; 0 then
			table.insert(slot0.contextData.noRes, slot1[slot8])
		end
	end

	for slot8, slot9 in ipairs(slot0.contextData.noRes) do
		slot4 = slot4 .. i18n(slot9[1] == 59001 and &quot;text_noRes_info_tip&quot; or &quot;text_noRes_info_tip2&quot;, Item.getConfigData(slot9[1]).name, slot9[2])

		if slot8 &lt; #slot0.contextData.noRes then
			slot4 = slot4 .. i18n(&quot;text_noRes_info_tip_link&quot;)
		end
	end

	if slot4 == &quot;&quot; then
		slot0:displayShipWord(i18n(&quot;text_shop_enoughRes_tip&quot;), false)
	else
		slot0:displayShipWord(i18n(&quot;text_shop_noRes_tip&quot;, slot4), true)
	end
end

slot0.displayShipWord = function(slot0, slot1, slot2, slot3)
	if not slot0.chatFlag then
		if not slot1 and slot0.contextData.noRes and #slot0.contextData.noRes &gt; 0 then
			setActive(slot0.chat, false)

			slot0.chat.transform.localScale = Vector3(0, 0, 1)
		end

		slot0.chatFlag = true

		if not slot0.isInitChatPosition then
			slot0.isInitChatPosition = true

			slot0:InitChatPosition()
		end

		setActive(slot0.chat, true)

		slot5 = slot3 or math.random(1, slot0.player:getChargeLevel())
		slot6 = nil
		slot6 = (not slot3 or pg.pay_level_award[slot5].dialog) and (slot1 or pg.pay_level_award[slot5].dialog)

		if not slot1 then
			slot0:playCV(slot5)
		end

		setText(slot0.chatText, slot6)

		if CHAT_POP_STR_LEN_SHORT &lt; #slot0.chatText:GetComponent(typeof(Text)).text then
			slot7.alignment = TextAnchor.MiddleLeft
		else
			slot7.alignment = TextAnchor.MiddleCenter
		end

		(function ()
			slot0 = 3
			slot2 = LeanTween.scale(rtf(uv0.chat.gameObject), Vector3.New(1, 1, 1), 0.3)
			slot2 = slot2:setFrom(Vector3.New(0, 0, 0))
			slot2 = slot2:setEase(LeanTweenType.easeOutBack)

			slot2:setOnComplete(System.Action(function ()
				if not uv0 then
					slot0 = LeanTween.scale(rtf(uv1.chat.gameObject), Vector3.New(0, 0, 1), uv2)
					slot0 = slot0:setEase(LeanTweenType.easeInBack)
					slot0 = slot0:setDelay(uv2 + uv3)

					slot0:setOnComplete(System.Action(function ()
						uv0.chatFlag = nil

						setActive(uv0.chat, false)

						if uv0.contextData.noRes and #uv0.contextData.noRes &gt; 0 then
							uv0:updateNoRes()
						end
					end))
				else
					uv1.chatFlag = nil
				end
			end))
		end)()
	end
end

slot0.InitChatPosition = function(slot0)
	slot3 = slot0.chat.parent:InverseTransformPoint(slot0.painting.parent:TransformPoint(slot0.painting.localPosition + Vector3(-21, -176, 0)))
	slot0.chat.localPosition = Vector3(slot3.x, slot3.y, 0)
end

slot0.playHeartEffect = function(slot0)
	if slot0.heartsTimer then
		slot0.heartsTimer:Stop()
	end

	setActive(slot0.painting:Find(&quot;heartsfly&quot;), true)

	slot0.heartsTimer = Timer.New(function ()
		setActive(uv0, false)
	end, 1, 1)

	slot0.heartsTimer:Start()
end

slot0.createLive2D = function(slot0)
	slot0.live2dChar = Live2D.New(Live2D.GenerateData({
		ship = Ship.New({
			configId = 312011
		}),
		offset = {
			0,
			0,
			0,
			75
		},
		position = Vector3(0, 0, 0),
		parent = slot0:findTF(&quot;frame/painting/live2d&quot;)
	}), function (slot0)
		slot0:setSortingLayer(LayerWeightConst.L2D_DEFAULT_LAYER)
	end)
end

slot0.checkBuyDone = function(slot0, slot1)
	if not slot0.live2dChar or not slot0.live2dChar:IsLoaded() then
		return
	end

	slot2 = nil

	if type(slot1) == &quot;string&quot; then
		if slot1 == &quot;damonds&quot; then
			slot2 = &quot;diamond&quot;
		else
			slot2 = slot1
		end
	elseif pg.shop_template[slot1] and slot3.effect_args and type(slot3.effect_args) == &quot;table&quot; then
		for slot7, slot8 in ipairs(slot3.effect_args) do
			if slot8 == 1 then
				slot2 = &quot;gold&quot;
			end
		end
	end

	slot3 = slot0.preAniName == &quot;gold&quot; or slot0.preAniName == &quot;diamond&quot;
	slot5 = slot3 and (slot2 == &quot;gold&quot; or slot2 == &quot;diamond&quot;) or not slot3

	if slot2 then
		if slot0.preAniName == slot2 then
			slot5 = false
		end
	end

	if slot5 then
		slot0.preAniName = slot2

		slot0.live2dChar:TriggerAction(slot2, nil, true)
	end

	return slot5
end

slot0.playCV = function(slot0, slot1)
	slot3 = nil

	if pg.pay_level_award[slot1] and slot2.cv_key ~= &quot;&quot; then
		slot3 = &quot;event:/cv/chargeShop/&quot; .. slot2.cv_key
	end

	if slot3 then
		slot0:stopCV()

		slot0._currentVoice = slot3

		pg.CriMgr.GetInstance():PlaySoundEffect_V3(slot3)
	end
end

slot0.stopCV = function(slot0)
	if slot0._currentVoice then
		pg.CriMgr.GetInstance():UnloadSoundEffect_V3(slot0._currentVoice)
	end

	slot0._currentVoice = nil
end

slot0.blurView = function(slot0)
	pg.UIMgr.GetInstance():OverlayPanelPB(slot0.viewContainer, {
		pbList = {
			slot0:findTF(&quot;blurBg&quot;, slot0.viewContainer)
		}
	})
end

slot0.unBlurView = function(slot0)
	pg.UIMgr.GetInstance():UnOverlayPanel(slot0.viewContainer, slot0.frame)
end

slot0.jpUIInit = function(slot0)
	if PLATFORM_CODE ~= PLATFORM_JP then
		return
	end

	slot0.userAgreeBtn3 = slot0:findTF(&quot;frame/raw1Btn&quot;)
	slot0.userAgreeBtn4 = slot0:findTF(&quot;frame/raw2Btn&quot;)
end

slot0.jpUIEnter = function(slot0)
	if PLATFORM_CODE ~= PLATFORM_JP then
		return
	end

	onButton(slot0, slot0.userAgreeBtn3, function ()
		uv0:emit(ChargeMediator.OPEN_USER_AGREE, require(&quot;ShareCfg.UserAgreement3&quot;) or &quot;&quot;)
	end, SFX_PANEL)
	onButton(slot0, slot0.userAgreeBtn4, function ()
		uv0:emit(ChargeMediator.OPEN_USER_AGREE, require(&quot;ShareCfg.UserAgreement4&quot;) or &quot;&quot;)
	end, SFX_PANEL)
end

slot0.addRefreshTimer = function(slot0, slot1)
	(function ()
		if uv0.refreshTimer then
			uv0.refreshTimer:Stop()

			uv0.refreshTimer = nil
		end
	end)()

	slot0.refreshTimer = Timer.New(function ()
		if uv0 + 1 - pg.TimeMgr.GetInstance():GetServerTime() &lt;= 0 then
			uv1()
			uv2:emit(ChargeMediator.GET_CHARGE_LIST)
		else
			slot1 = pg.TimeMgr.GetInstance():DescCDTime(slot0)
		end
	end, 1, -1)

	slot0.refreshTimer:Start()
	slot0.refreshTimer.func()
end

slot0.checkFreeGiftTag = function(slot0)
	TagTipHelper.FreeGiftTag({
		slot0.giftTip
	})
end

return slot0
</code></pre>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-lua.min.js"></script>
</body>
</html>