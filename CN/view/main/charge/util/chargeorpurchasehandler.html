<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>chargeorpurchasehandler.lua</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
</head>
<body>
    <h1>chargeorpurchasehandler.lua</h1>
    <a href="index.html">返回主页</a>
    <pre><code class="language-lua">slot0 = class(&quot;ChargeOrPurchaseHandler&quot;, pm.Mediator)

slot0.Ctor = function(slot0)
	uv0.super.Ctor(slot0)
	pg.m02:registerMediator(slot0)
end

slot0.ChargeOrPurchaseAsyn = function(slot0, slot1, slot2)
	slot3 = nil

	seriesAsync({
		function (slot0)
			slot1 = uv0

			slot1:FetchFirstChargeIds(uv1, function (slot0)
				uv0 = slot0

				uv1()
			end)
		end,
		function (slot0)
			uv0:ChargeOrPurchase(uv1, uv2)
			slot0()
		end
	}, slot2)
end

slot0.FetchFirstChargeIds = function(slot0, slot1, slot2)
	if not slot1:isChargeType() then
		slot2()

		return
	end

	slot4 = function()
		uv1(uv0:getFirstChargeList())
	end

	if getProxy(ShopsProxy):ShouldRefreshChargeList() then
		pg.m02:sendNotification(GAME.GET_CHARGE_LIST, {
			callback = slot4
		})
	else
		slot4()
	end
end

slot0.ChargeOrPurchase = function(slot0, slot1, slot2)
	if slot2:isChargeType() then
		if slot2:isMonthCard() or slot2:isGiftBox() or slot2:isItemBox() or slot2:isPassItem() then
			return slot0:ChargeMonthCardAndGiftPack(slot1, slot2)
		elseif slot2:isGem() then
			return slot0:ChargeGem(slot1, slot2)
		end
	else
		slot0:PurchaseItem(slot2)
	end
end

slot0.PurchaseItem = function(slot0, slot1)
	assert(slot1:getDropInfo().type == DROP_TYPE_ITEM)

	slot3 = Item.getConfigData(slot2.id)

	slot0:ShowMsgBox({
		isChargeType = false,
		isLocalPrice = false,
		isMonthCard = false,
		icon = slot3.icon,
		name = slot3.name,
		tipExtra = i18n(&quot;charge_title_getitem&quot;),
		extraItems = slot1:GetDropList(),
		price = slot1:getConfig(&quot;resource_num&quot;),
		tagType = slot1:getConfig(&quot;tag&quot;),
		onYes = function ()
			uv0:Purchase(uv1.name, uv2)
		end
	})
end

slot0.ChargeMonthCardAndGiftPack = function(slot0, slot1, slot2)
	slot5 = slot2:GetGemCnt()
	slot7, slot8 = slot2:GetChargeTip()

	slot0:ShowMsgBox({
		isChargeType = true,
		infoTip = slot2:GetInfoTip(),
		icon = &quot;chargeicon/&quot; .. slot2:getConfig(&quot;picture&quot;),
		name = slot2:getConfig(&quot;name_display&quot;),
		tipExtra = slot7,
		extraItems = slot2:GetExtraServiceItem(),
		price = slot2:getConfig(&quot;money&quot;),
		isLocalPrice = slot2:IsLocalPrice(),
		tagType = (table.contains(slot1, slot2.id) or slot2:firstPayDouble()) and 4 or slot2:getConfig(&quot;tag&quot;),
		isMonthCard = slot2:isMonthCard(),
		tipBonus = slot8,
		bonusItem = slot2:GetBonusItem(),
		extraDrop = slot2:GetExtraDrop(),
		descExtra = slot2:getConfig(&quot;descrip_extra&quot;),
		onYes = function ()
			uv0:Charge(uv1)
		end
	})
end

slot0.ChargeGem = function(slot0, slot1, slot2)
	slot4 = slot2:getConfig(&quot;gem&quot;)
	slot6 = table.contains(slot1, slot2.id) or slot2:firstPayDouble()

	slot0:ShowMsgBox({
		isChargeType = true,
		infoTip = slot2:GetInfoTip(),
		icon = &quot;chargeicon/&quot; .. slot2:getConfig(&quot;picture&quot;),
		name = slot2:getConfig(&quot;name_display&quot;),
		price = slot2:getConfig(&quot;money&quot;),
		isLocalPrice = slot2:IsLocalPrice(),
		tagType = slot6 and 4 or slot2:getConfig(&quot;tag&quot;),
		normalTip = i18n(&quot;charge_start_tip&quot;, slot2:getConfig(&quot;money&quot;), slot6 and slot4 + slot2:getConfig(&quot;gem&quot;) or slot4 + slot2:getConfig(&quot;extra_gem&quot;)),
		onYes = function ()
			uv0:Charge(uv1)
		end
	})
end

slot0.ShowMsgBox = function(slot0, slot1)
	slot0:addSubLayers(Context.New({
		mediator = ChargeItemPanelMediator,
		viewComponent = ChargeItemPanelLayer,
		data = {
			panelConfig = slot1
		}
	}))
end

slot0.Purchase = function(slot0, slot1, slot2)
	pg.MsgboxMgr.GetInstance():ShowMsgBox({
		content = i18n(&quot;charge_scene_buy_confirm&quot;, slot2:getConfig(&quot;resource_num&quot;), slot1),
		onYes = function ()
			pg.m02:sendNotification(GAME.SHOPPING, {
				count = 1,
				id = uv0.id
			})
		end
	})
end

slot0.Charge = function(slot0, slot1)
	if ChargeConst.isNeedSetBirth() then
		slot0:addSubLayers(Context.New({
			mediator = ChargeBirthdayMediator,
			viewComponent = ChargeBirthdayLayer,
			data = {}
		}))
	else
		pg.m02:sendNotification(GAME.CHARGE_OPERATION, {
			shopId = slot1.id
		})
	end
end

slot0.addSubLayers = function(slot0, slot1, slot2, slot3)
	assert(isa(slot1, Context), &quot;should be an instance of Context&quot;)

	slot5 = getProxy(ContextProxy):getCurrentContext()

	if slot2 then
		while slot5.parent do
			slot5 = slot5.parent
		end
	end

	slot0:sendNotification(GAME.LOAD_LAYERS, {
		parentContext = slot5,
		context = slot1,
		callback = slot3
	})
end

slot0.Dispose = function(slot0)
	pg.m02:removeMediator(slot0.__cname)
end

return slot0
</code></pre>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-lua.min.js"></script>
</body>
</html>