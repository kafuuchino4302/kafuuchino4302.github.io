<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>chatbubble.lua</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
</head>
<body>
    <h1>chatbubble.lua</h1>
    <a href="index.html">返回主页</a>
    <pre><code class="language-lua">slot0 = class(&quot;ChatBubble&quot;)

slot0.Ctor = function(slot0, slot1)
	slot0.tf = tf(slot1)
	slot0.isLoadChatBg = false

	slot0:init()

	slot0.chatFrameTr = findTF(slot0.tf, &quot;chat_fram&quot;)

	if IsNil(slot0.chatFrameTr) then
		slot0.chatFrameTr = slot0.tf
	end
end

slot0.init = function(slot0)
	slot0.nameTF = findTF(slot0.tf, &quot;desc/name&quot;):GetComponent(&quot;Text&quot;)
	slot0.face = findTF(slot0.tf, &quot;face/content&quot;)
	slot0.circle = findTF(slot0.tf, &quot;shipicon/frame&quot;)
	slot0.timeTF = findTF(slot0.tf, &quot;time&quot;):GetComponent(&quot;Text&quot;)
	slot0.headTF = findTF(slot0.tf, &quot;shipicon/icon&quot;):GetComponent(&quot;Image&quot;)
	slot0.stars = findTF(slot0.tf, &quot;shipicon/stars&quot;)
	slot0.star = findTF(slot0.stars, &quot;star&quot;)
	slot0.dutyTF = findTF(slot0.tf, &quot;desc/duty&quot;)
	slot0.channel = findTF(slot0.tf, &quot;desc/channel&quot;)
	slot0.chatBgWidth = 665
end

slot0.update = function(slot0, slot1)
	if slot0.data == slot1 then
		return
	end

	slot0.data = slot1
	slot2 = slot1.isSelf

	if slot1.player.icon == 0 then
		slot3.icon = 101171
	end

	slot4 = pg.ship_data_statistics[slot3.icon]
	slot5 = false

	if not slot2 then
		slot5 = slot3.propose
	elseif slot3.character and getProxy(BayProxy):getShipById(slot6) then
		slot5 = slot7:ShowPropose()
	end

	slot0.nameTF.text = slot3.name
	slot0.timeTF.text = getOfflineTimeStamp(slot1.timestamp)

	if slot0.dutyTF then
		setActive(slot0.dutyTF, slot3.duty)

		if slot3.duty then
			setImageSprite(slot0.dutyTF, GetSpriteFromAtlas(&quot;dutyicon&quot;, slot3.duty), true)
		end
	end

	for slot14 = slot0.stars.childCount, Ship.New({
		configId = slot4.id
	}):getStar() - 1 do
		cloneTplTo(slot0.star, slot0.stars)
	end

	for slot14 = 0, slot0.stars.childCount - 1 do
		slot0.stars:GetChild(slot14).gameObject:SetActive(slot14 &lt; slot4.star)
	end

	if slot0.channel then
		setImageSprite(slot0.channel, GetSpriteFromAtlas(&quot;channel&quot;, ChatConst.GetChannelSprite(slot1.type) .. &quot;_1920&quot;), true)
	end

	slot0.headTF.color = Color.New(1, 1, 1, 0)

	LoadSpriteAsync(&quot;qicon/&quot; .. slot3:getPainting(), function (slot0)
		if not IsNil(uv0.headTF) then
			uv0.headTF.color = Color.white
			uv0.headTF.sprite = slot0 or LoadSprite(&quot;heroicon/unknown&quot;)
		end
	end)

	slot11 = AttireFrame.attireFrameRes(slot3, slot2, AttireConst.TYPE_ICON_FRAME, slot5)
	slot12 = PoolMgr.GetInstance()

	slot12:GetPrefab(&quot;IconFrame/&quot; .. slot11, slot11, true, function (slot0)
		if IsNil(uv0.tf) then
			return
		end

		if uv0.circle and uv0.data then
			slot0.name = uv1
			findTF(slot0.transform, &quot;icon&quot;):GetComponent(typeof(Image)).raycastTarget = false

			setParent(slot0, uv0.circle, false)
		else
			PoolMgr.GetInstance():ReturnPrefab(&quot;IconFrame/&quot; .. uv1, uv1, slot0)
		end
	end)

	if slot1.emojiId then
		slot12 = pg.emoji_template[slot1.emojiId]
		slot13 = PoolMgr.GetInstance()

		slot13:GetPrefab(&quot;emoji/&quot; .. slot12.pic, slot12.pic, true, function (slot0)
			if IsNil(uv0.tf) then
				return
			end

			if uv0.face and uv0.data then
				slot0.name = uv1.pic

				if slot0:GetComponent(&quot;Animator&quot;) then
					slot1.enabled = true
				end

				setParent(slot0, uv0.face, false)

				rtf(slot0).sizeDelta = Vector2.New(180, 180)
				rtf(slot0).localPosition = uv2 and Vector3(-50, 0, 0) or Vector3(50, 0, 0)
			else
				PoolMgr.GetInstance():ReturnPrefab(&quot;emoji/&quot; .. uv1.pic, uv1.pic, slot0)
			end
		end)
	else
		slot12 = AttireFrame.attireFrameRes(slot3, slot2, AttireConst.TYPE_CHAT_FRAME, slot5)
		slot13 = PoolMgr.GetInstance()

		slot13:GetPrefab(&quot;ChatFrame/&quot; .. slot12, slot12, true, function (slot0)
			if IsNil(uv0.tf) then
				return
			end

			if uv0.tf and uv0.data then
				slot1 = tf(slot0)
				slot1 = slot1:Find(&quot;Text&quot;)
				slot1:GetComponent(&quot;RichText&quot;).supportRichText = false
				slot3 = tf(slot0)

				eachChild(slot3:Find(&quot;Text&quot;), function (slot0)
					Destroy(slot0)
				end)

				slot3 = false

				for slot7 in string.gmatch(uv1.content, ChatConst.EmojiIconCodeMatch), nil,  do
					if table.contains(pg.emoji_small_template.all, tonumber(slot7)) then
						slot3 = true

						slot1:AddSprite(slot7, LoadSprite(&quot;emoji/&quot; .. pg.emoji_small_template[tonumber(slot7)].pic .. &quot;_small&quot;, nil))
					end
				end

				slot4 = GetComponent(slot0, &quot;VerticalLayoutGroup&quot;)

				if slot3 then
					onNextTick(function ()
						uv0.padding.bottom = 30

						Canvas.ForceUpdateCanvases()
					end)
				else
					slot4.padding.bottom = slot4.padding.top
				end

				slot5 = uv1.content

				if uv1.needBanRichText then
					slot5 = SwitchSpecialChar(uv1.content)
				end

				slot1.text = string.gsub(slot5, ChatConst.EmojiIconCodeMatch, function (slot0)
					if table.contains(pg.emoji_small_template.all, tonumber(slot0)) then
						return string.format(&quot;&lt;icon name=%s w=1 h=1/&gt;&quot;, slot0)
					end
				end)
				uv0.isLoadChatBg = true
				slot0:GetComponent(typeof(LayoutElement)).preferredWidth = uv0.chatBgWidth
				slot0.name = uv2

				setParent(slot0, uv0.chatFrameTr, false)
				tf(slot0):SetAsFirstSibling()
				Canvas.ForceUpdateCanvases()
				uv0:OnChatFrameLoaded(slot0)

				return
			end

			PoolMgr.GetInstance():ReturnPrefab(&quot;ChatFrame/&quot; .. uv2, uv2, slot0)
		end)
	end

	setActive(slot0.face.parent, slot1.emojiId)
end

slot0.dispose = function(slot0)
	if slot0.face.childCount &gt; 0 then
		slot1 = slot0.face:GetChild(0).gameObject

		PoolMgr.GetInstance():ReturnPrefab(&quot;emoji/&quot; .. slot1.name, slot1.name, slot1)
	end

	if slot0.circle.childCount &gt; 0 then
		slot1 = slot0.circle:GetChild(0).gameObject

		PoolMgr.GetInstance():ReturnPrefab(&quot;IconFrame/&quot; .. slot1.name, slot1.name, slot1)
	end

	if slot0.isLoadChatBg then
		slot1 = slot0.chatFrameTr:GetChild(0).gameObject

		PoolMgr.GetInstance():ReturnPrefab(&quot;ChatFrame/&quot; .. slot1.name, slot1.name, slot1)

		slot0.isLoadChatBg = false
	end

	slot0.data = nil
end

slot0.OnChatFrameLoaded = function(slot0, slot1)
end

return slot0
</code></pre>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-lua.min.js"></script>
</body>
</html>