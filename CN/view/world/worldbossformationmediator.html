<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>worldbossformationmediator.lua</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
</head>
<body>
    <h1>worldbossformationmediator.lua</h1>
    <a href="index.html">返回主页</a>
    <pre><code class="language-lua">slot0 = class(&quot;WorldBossFormationMediator&quot;, import(&quot;..base.ContextMediator&quot;))
slot0.ON_START = &quot;WorldBossFormationMediator:ON_START&quot;
slot0.ON_COMMIT_EDIT = &quot;WorldBossFormationMediator:ON_COMMIT_EDIT&quot;
slot0.OPEN_SHIP_INFO = &quot;WorldBossFormationMediator:OPEN_SHIP_INFO&quot;
slot0.REMOVE_SHIP = &quot;WorldBossFormationMediator:REMOVE_SHIP&quot;
slot0.CHANGE_FLEET_SHIP = &quot;WorldBossFormationMediator:CHANGE_FLEET_SHIPs&quot;
slot0.ON_AUTO = &quot;WorldBossFormationMediator:ON_AUTO&quot;
slot0.CHANGE_FLEET_SHIPS_ORDER = &quot;WorldBossFormationMediator:CHANGE_FLEET_SHIPS_ORDER&quot;

slot0.register = function(slot0)
	slot0.ships = getProxy(BayProxy):getRawData()

	slot0.viewComponent:SetShips(slot0.ships)

	slot3 = nowWorld():GetBossProxy()

	slot0.viewComponent:SetBossProxy(slot3, slot0.contextData.bossId)
	slot3:LockCacheBoss(slot0.contextData.bossId)
	slot0.viewComponent:SetCurrentFleet(slot0.contextData.editingFleetVO or Clone(slot3:GetFleet(slot0.contextData.bossId)))
	slot0.viewComponent:SetPlayerInfo(getProxy(PlayerProxy):getData())
	slot0:bind(uv0.REMOVE_SHIP, function (slot0, slot1, slot2)
		if not slot2:canRemove(slot1) then
			slot3, slot4 = slot2:getShipPos(slot1)

			pg.TipsMgr.GetInstance():ShowTips(i18n(&quot;ship_formationUI_removeError_onlyShip&quot;, slot1:getConfigTable().name, slot2.name, Fleet.C_TEAM_NAME[slot4]))

			return
		end

		slot2:removeShip(slot1)
		uv0.viewComponent:UpdateFleetView(true)
	end)
	slot0:bind(uv0.CHANGE_FLEET_SHIPS_ORDER, function (slot0, slot1)
		uv0.viewComponent:UpdateFleetView()
	end)
	slot0:bind(uv0.OPEN_SHIP_INFO, function (slot0, slot1, slot2)
		uv0.contextData.form = PreCombatLayer.FORM_EDIT
		slot3 = uv0.viewComponent._currentFleetVO
		slot4 = {}

		for slot8, slot9 in ipairs(slot2.ships) do
			table.insert(slot4, uv0.ships[slot9])
		end

		uv0:sendNotification(GAME.GO_SCENE, SCENE.SHIPINFO, {
			shipId = slot1,
			shipVOs = slot4
		})
	end)
	slot0:bind(uv0.ON_COMMIT_EDIT, function (slot0, slot1)
		slot2 = uv0.viewComponent._currentFleetVO

		uv1:UpdateFleet(uv0.contextData.bossId, slot2)
		uv1:SavaCacheShips(uv0.contextData.bossId, slot2)
		slot1()
	end)
	slot0:bind(uv0.ON_AUTO, function (slot0, slot1)
		uv0:onAutoBtn(slot1)
	end)
	slot0:bind(uv0.ON_START, function (slot0)
		slot1, slot2 = uv0:GetFleet(uv1.contextData.bossId):isLegalToFight()

		if slot1 ~= true then
			pg.TipsMgr:GetInstance():ShowTips(i18n(&quot;elite_disable_no_fleet&quot;))

			return
		end

		if not nowWorld():GetBossProxy():GetBossById(uv1.contextData.bossId) then
			pg.TipsMgr.GetInstance():ShowTips(i18n(&quot;world_joint_boss_not_found&quot;))

			return
		end

		if uv1.contextData.isOther and uv0:GetPt() &lt;= 0 and WorldBossConst._IsCurrBoss(slot4) then
			pg.TipsMgr:GetInstance():ShowTips(i18n(&quot;world_joint_count_no_enough&quot;))

			return
		end

		if uv1.contextData.isOther then
			WorldBossScene.inOtherBossBattle = uv1.contextData.bossId
		end

		uv1:sendNotification(GAME.BEGIN_STAGE, {
			actId = 0,
			bossId = uv1.contextData.bossId,
			system = SYSTEM_WORLD_BOSS,
			hpRate = uv1.contextData.hpRate
		})
	end)
	slot0:bind(uv0.CHANGE_FLEET_SHIP, function (slot0, slot1, slot2, slot3)
		uv0.contextData.form = WorldBossFormationLayer.FORM_EDIT
		CurrentWorldBossDetailPage.formDock = true
		slot5 = slot1 and slot1.id or nil

		uv0:sendNotification(GAME.GO_SCENE, SCENE.DOCKYARD, {
			selectedMin = 1,
			selectedMax = 1,
			ignoredIds = slot2.ships or {},
			leastLimitMsg = i18n(&quot;ship_formationMediator_leastLimit&quot;),
			quitTeam = tobool(slot1),
			teamFilter = slot3,
			leftTopInfo = i18n(&quot;word_formation&quot;),
			onShip = function (slot0)
				if _.any(uv0.ships, function (slot0)
					return uv0:isSameKind(uv1:getShipById(slot0))
				end) then
					return false, i18n(&quot;event_same_type_not_allowed&quot;)
				end

				return true
			end,
			onSelected = function (slot0)
				if getProxy(BayProxy):getShipById(slot0[1]) and uv0:containShip(slot2) then
					return
				end

				if uv1 == nil then
					uv2:insertShip(slot2, nil, uv3)
				else
					slot3 = uv0:getShipPos(uv4)

					uv2:removeShipById(uv1)

					if slot2 and slot3 then
						uv2:insertShip(slot2, slot3, uv3)
					end
				end
			end,
			preView = uv0.viewComponent.__cname,
			hideTagFlags = ShipStatus.TAG_HIDE_ALL
		})
	end)
end

slot0.onAutoBtn = function(slot0, slot1)
	slot0:sendNotification(GAME.AUTO_BOT, {
		isActiveBot = slot1.isOn,
		toggle = slot1.toggle,
		system = SYSTEM_WORLD
	})
end

slot0.listNotificationInterests = function(slot0)
	return {
		GAME.BEGIN_STAGE_DONE,
		GAME.WORLD_BOSS_START_BATTLE_FIALED,
		PlayerProxy.UPDATED,
		GAME.END_GUIDE
	}
end

slot0.handleNotification = function(slot0, slot1)
	slot3 = slot1:getBody()

	if slot1:getName() == GAME.BEGIN_STAGE_DONE then
		slot0:sendNotification(GAME.GO_SCENE, SCENE.COMBATLOAD, slot3)
	elseif slot2 == GAME.WORLD_BOSS_START_BATTLE_FIALED then
		slot0.viewComponent:emit(BaseUI.ON_CLOSE)
	elseif slot2 == PlayerProxy.UPDATED then
		slot0.viewComponent:SetPlayerInfo(getProxy(PlayerProxy):getData())
	elseif slot2 == GAME.END_GUIDE then
		slot0.viewComponent:TryPlayGuide()
	end
end

return slot0
</code></pre>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-lua.min.js"></script>
</body>
</html>