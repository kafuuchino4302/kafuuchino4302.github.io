<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>worldbossinfoandrankpanel.lua</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
</head>
<body>
    <h1>worldbossinfoandrankpanel.lua</h1>
    <a href="index.html">返回主页</a>
    <pre><code class="language-lua">slot0 = class(&quot;WorldBossInfoAndRankPanel&quot;, import(&quot;view.base.BaseSubView&quot;))

slot0.getUIName = function(slot0)
	return &quot;WorldBossInfoAndRankUI&quot;
end

slot0.OnLoaded = function(slot0)
	slot0.toggleRank = slot0:findTF(&quot;rank&quot;)
	slot0.toggleInfo = slot0:findTF(&quot;info&quot;)
	slot0.myRankTF = slot0:findTF(&quot;rank_panel/tpl&quot;)
	slot0.rankList = UIItemList.New(slot0:findTF(&quot;rank_panel/list&quot;), slot0.myRankTF)
	slot0.maxRankCnt = pg.gameset.joint_boss_fighter_max.key_value
	slot0.rankCnt1 = slot0:findTF(&quot;rank_panel/cnt/Text&quot;):GetComponent(typeof(Text))
	slot0.rankTF = slot0:findTF(&quot;rank_panel&quot;)
	slot0.maskTF = slot0:findTF(&quot;rank_panel/mask&quot;)
	slot0.maskTxt = slot0:findTF(&quot;rank_panel/mask/Text&quot;):GetComponent(typeof(Text))
	slot0.infoTitle = slot0:findTF(&quot;info_panel/title/Text&quot;):GetComponent(typeof(Text))
	slot0.infoSkillList = UIItemList.New(slot0:findTF(&quot;info_panel/scrollrect/content&quot;), slot0:findTF(&quot;info_panel/scrollrect/content/tpl&quot;))
end

slot0.SetCallback = function(slot0, slot1, slot2)
	slot0.callback = slot1
	slot0.flushRankCallback = slot2
end

slot0.OnInit = function(slot0)
	slot1 = slot0._tf

	slot1:SetSiblingIndex(2)
	onToggle(slot0, slot0.toggleInfo, function (slot0)
		if slot0 then
			uv0:ResetInfoLayout()
		end
	end)
end

slot0.Flush = function(slot0, slot1, slot2)
	slot0.boss = slot1
	slot0.proxy = slot2

	slot0:FlushRank()
	slot0:FlushInfo()

	if not slot0.boss:IsFullHp() then
		triggerToggle(slot0.toggleRank, true)
	else
		triggerToggle(slot0.toggleInfo, true)
		slot0:ResetInfoLayout()
	end
end

slot0.FlushInfo = function(slot0)
	slot0.infoTitle.text = slot0.boss.config.name

	slot0.infoSkillList:make(function (slot0, slot1, slot2)
		if slot0 == UIItemList.EventUpdate then
			slot3 = uv0[slot1 + 1]

			GetSpriteFromAtlasAsync(&quot;ui/WorldBossUI_atlas&quot;, &quot;color_&quot; .. slot3[2], function (slot0)
				uv0:Find(&quot;color&quot;):GetComponent(typeof(Image)).sprite = slot0
			end)
			setText(slot2:Find(&quot;color/Text&quot;), slot3[1])
		end
	end)
	slot0.infoSkillList:align(#slot0.boss.config.description)
end

slot0.ResetInfoLayout = function(slot0)
	slot1 = 28
	slot2 = slot0.boss.config.description

	onNextTick(function ()
		if uv0.exited then
			return
		end

		slot0 = uv0.infoSkillList

		slot0:each(function (slot0, slot1)
			slot3 = uv0[slot0 + 1][3]
			slot5 = &quot;　&quot;
			slot6, slot7 = math.modf(slot1:Find(&quot;color/Text&quot;).sizeDelta.x / uv1)
			slot8 = math.ceil(uv1 * slot7)

			for slot12 = 1, slot6 do
				slot5 = slot5 .. &quot;　&quot;
			end

			if slot7 &gt; 0 then
				slot5 = slot5 .. &quot;&lt;size=&quot; .. slot8 .. &quot;&gt;　&lt;/size&gt;&quot;
			end

			setText(slot1:Find(&quot;Text&quot;), slot5 .. slot3)
		end)
	end)
end

slot0.FlushRank = function(slot0)
	if not slot0.boss then
		return
	end

	slot4 = 0

	if not slot0.proxy:GetRank(slot1.id) then
		slot0:emit(WorldBossMediator.ON_RANK_LIST, slot1.id)
	else
		slot0.rankList:make(function (slot0, slot1, slot2)
			if slot0 == UIItemList.EventUpdate then
				uv1:UpdateRankTF(slot2, uv0[slot1 + 1], slot1 + 1)
			end
		end)
		slot0.rankList:align(math.min(#slot3, 3))
		slot0:UpdateSelfRank(slot3)

		slot4 = #slot3
	end

	slot0.rankCnt1.text = slot4 .. &quot;&lt;color=#A2A2A2&gt;/&quot; .. slot0.maxRankCnt .. &quot;&lt;/color&gt;&quot;

	if slot0.flushRankCallback then
		slot0.flushRankCallback(slot4, slot0.maxRankCnt)
	end

	slot0:AddWaitResultTimer()
end

slot0.AddWaitResultTimer = function(slot0)
	slot0:RemoveWaitTimer()

	slot2 = slot0.boss:ShouldWaitForResult()

	setActive(slot0.maskTF, slot2)

	if slot2 then
		slot3 = slot1:GetWaitForResultTime()
		slot0.waitTimer = Timer.New(function ()
			if uv0 - pg.TimeMgr.GetInstance():GetServerTime() &lt; 0 then
				uv1:AddWaitResultTimer()

				if uv1.callback then
					uv1.callback(false)
				end
			else
				uv1.maskTxt.text = pg.TimeMgr.GetInstance():DescCDTime(slot1)
			end
		end, 1, -1)

		slot0.waitTimer:Start()

		if slot0.callback then
			slot0.callback(true)
		end
	end
end

slot0.RemoveWaitTimer = function(slot0)
	if slot0.waitTimer then
		slot0.waitTimer:Stop()

		slot0.waitTimer = nil
	end
end

slot0.UpdateRankTF = function(slot0, slot1, slot2, slot3)
	setText(slot1:Find(&quot;name&quot;), slot2.name)
	setText(slot1:Find(&quot;value/Text&quot;), slot2.damage)
	setText(slot1:Find(&quot;number&quot;), slot2.number or slot3)
	setActive(slot1:Find(&quot;value/view&quot;), not slot2.isSelf)
	onButton(slot0, slot1:Find(&quot;value/view&quot;), function ()
		uv0:emit(WorldBossMediator.FETCH_RANK_FORMATION, uv1.id, uv0.boss.id)
	end, SFX_PANEL)
end

slot0.UpdateSelfRank = function(slot0, slot1)
	slot2 = nil

	for slot6, slot7 in ipairs(slot1) do
		if slot7.isSelf then
			slot7.number = slot6

			break
		end
	end

	if slot2 then
		slot0:UpdateRankTF(slot0.myRankTF, slot2)
	end
end

slot0.OnDestroy = function(slot0)
	slot0:RemoveWaitTimer()
end

return slot0
</code></pre>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-lua.min.js"></script>
</body>
</html>