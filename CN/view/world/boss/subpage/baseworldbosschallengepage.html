<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>baseworldbosschallengepage.lua</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
</head>
<body>
    <h1>baseworldbosschallengepage.lua</h1>
    <a href="index.html">返回主页</a>
    <pre><code class="language-lua">slot0 = class(&quot;BaseWorldBossChallengePage&quot;, import(&quot;view.base.BaseSubView&quot;))
slot0.Listeners = {
	onCacheBossUpdated = &quot;OnCacheBossUpdated&quot;,
	onRankListUpdated = &quot;OnRankListUpdated&quot;
}
slot1 = {
	[970701] = {
		411,
		777
	},
	[970702] = {
		411,
		574
	},
	[970201] = {
		296,
		610,
		0.95,
		0.95
	},
	[970703] = {
		1424,
		1267.9,
		1.7,
		1.7
	},
	[970401] = {
		480,
		635
	},
	[970402] = {
		480,
		635
	},
	[970403] = {
		510,
		611.2,
		0.95,
		0.95
	}
}

slot0.Setup = function(slot0, slot1)
	for slot5, slot6 in pairs(uv0.Listeners) do
		slot0[slot5] = function (...)
			uv0[uv1](uv2, ...)
		end
	end

	slot0.proxy = slot1
end

slot0.OnLoaded = function(slot0)
	slot0.rankPage = WorldBossRankPage.New(slot0._tf.parent.parent, slot0.event)

	slot0:AddListeners(slot0.proxy)
end

slot0.OnInit = function(slot0)
	slot0:UpdateEmptyCard()

	slot0.scrollRect = WorldBossItemList.New(slot0:findTF(&quot;list_panel/mask/bg/container&quot;), slot0:findTF(&quot;list_panel/mask/tpl&quot;))
	slot1 = slot0.scrollRect

	slot1:Make(function (slot0, slot1)
		uv0:OnInitCard(slot0, slot1)
	end, function (slot0, slot1)
		uv0:OnPreviewCard(slot0, slot1)
	end, function (slot0, slot1)
		uv0:OnSelectCard(slot0, slot1)
	end)

	slot1 = slot0:findTF(&quot;main/hp/slider&quot;)
	slot0.hpSlider = slot1:GetComponent(typeof(Slider))
	slot1 = slot0:findTF(&quot;main/hp/level/Text&quot;)
	slot0.levelTxt = slot1:GetComponent(typeof(Text))
	slot1 = slot0:findTF(&quot;main/hp/Text&quot;)
	slot0.hpTxt = slot1:GetComponent(typeof(Text))
	slot1 = slot0:findTF(&quot;main/time/Text&quot;)
	slot0.expiredTimeTxt = slot1:GetComponent(typeof(Text))
	slot0.mainPanel = slot0:findTF(&quot;main&quot;)
	slot0.painting = slot0:findTF(&quot;paint&quot;)

	setActive(slot0.painting, false)
	setActive(slot0.mainPanel, false)

	slot1 = slot0.mainPanel
	slot0.rankBtn = slot1:Find(&quot;rank_btn&quot;)
	slot1 = slot0.mainPanel
	slot0.startBtn = slot1:Find(&quot;start_btn&quot;)
	slot0.refreshBtn = slot0:findTF(&quot;list_panel/frame/filter/refresh_btn&quot;)
	slot0.refreshBtnGray = slot0:findTF(&quot;list_panel/frame/filter/refresh_btn_gray&quot;)
	slot0.cdTime = 0

	onButton(slot0, slot0.refreshBtn, function ()
		if uv0.cdTime &lt;= pg.TimeMgr.GetInstance():GetServerTime() then
			uv0.worldBossId = nil

			uv0:emit(WorldBossMediator.UPDATE_CACHE_BOSS_HP, function ()
				uv0:OnCacheBossUpdated()
			end)
			assert(pg.gameset.world_boss_resfresh, &quot;gameset &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;world_boss_resfresh&quot;)

			slot0 = pg.gameset.world_boss_resfresh.key_value
			uv0.cdTime = pg.TimeMgr.GetInstance():GetServerTime() + slot0

			uv0:RotateRefreshBtn(slot0)
		else
			pg.TipsMgr.GetInstance():ShowTips(i18n(&quot;world_joint_not_refresh_frequently&quot;))
		end
	end, SFX_PANEL)
	onButton(slot0, slot0.refreshBtnGray, function ()
		pg.TipsMgr.GetInstance():ShowTips(i18n(&quot;world_joint_not_refresh_frequently&quot;))
	end, SFX_PANEL)

	slot0.filterToggle = slot0:findTF(&quot;list_panel/frame/filter/toggles&quot;)
	slot0.filterFlags = {
		WorldBoss.BOSS_TYPE_WORLD,
		WorldBoss.BOSS_TYPE_FRIEND,
		WorldBoss.BOSS_TYPE_GUILD
	}

	onToggle(slot0, slot0:findTF(&quot;list_panel/frame/filter/toggles/friend&quot;), function (slot0)
		uv0.filterFlags[2] = slot0 and WorldBoss.BOSS_TYPE_FRIEND or -1

		uv0:CheckToggle()
		uv0:UpdateNonProcessList()
	end, SFX_PANEL)

	slot1 = GetComponent(slot0:findTF(&quot;list_panel/frame/filter/toggles/friend/unsel&quot;), typeof(Image))

	slot1:SetNativeSize()

	slot1 = GetComponent(slot0:findTF(&quot;list_panel/frame/filter/toggles/friend/sel&quot;), typeof(Image))

	slot1:SetNativeSize()

	slot1 = GetComponent(slot0:findTF(&quot;list_panel/frame/filter/toggles/guild/sel&quot;), typeof(Image))

	slot1:SetNativeSize()

	slot1 = GetComponent(slot0:findTF(&quot;list_panel/frame/filter/toggles/guild/unsel&quot;), typeof(Image))

	slot1:SetNativeSize()
	onToggle(slot0, slot0:findTF(&quot;list_panel/frame/filter/toggles/guild&quot;), function (slot0)
		uv0.filterFlags[3] = slot0 and WorldBoss.BOSS_TYPE_GUILD or -1

		uv0:CheckToggle()
		uv0:UpdateNonProcessList()
	end, SFX_PANEL)
end

slot0.UpdateEmptyCard = function(slot0)
	slot3 = slot0:findTF(&quot;list_panel/mask/tpl&quot;):Find(&quot;empty&quot;):GetComponent(typeof(Image))
	slot3.sprite = GetSpriteFromAtlas(&quot;MetaWorldboss/&quot; .. WorldBossConst.GetCurrBossGroup(), &quot;item_04&quot;)

	slot3:SetNativeSize()
end

slot0.CheckToggle = function(slot0)
	if _.all(slot0.filterFlags, function (slot0)
		return slot0 == -1
	end) then
		triggerToggle(slot0:findTF(&quot;list_panel/frame/filter/toggles/friend&quot;), true)
		triggerToggle(slot0:findTF(&quot;list_panel/frame/filter/toggles/guild&quot;), true)
	end
end

slot0.GetResSuffix = function(slot0)
	return &quot;&quot;
end

slot0.UpdatePainting = function(slot0, slot1)
	if slot0.groupId ~= slot1 then
		slot0.groupId = slot1
		slot2 = slot0:findTF(&quot;main/label&quot;):GetComponent(typeof(Image))
		slot2.sprite = GetSpriteFromAtlas(&quot;MetaWorldboss/&quot; .. slot1, &quot;title&quot; .. slot0:GetResSuffix())

		slot2:SetNativeSize()
		setMetaPaintingPrefabAsync(slot0.painting, slot0.groupId, &quot;lihuisha&quot;)

		if pg.world_joint_boss_template[WorldBossConst.MetaId2BossId(slot0.groupId)].p_offset_other or uv0[slot0.groupId] then
			setAnchoredPosition(slot0.painting, {
				x = slot4[1],
				y = slot4[2]
			})

			slot0.painting.localScale = Vector3(slot4[3] or 1, slot4[4] or 1, 1)
		end
	end
end

slot0.RotateRefreshBtn = function(slot0, slot1)
	slot2 = LeanTween.rotate(rtf(slot0.refreshBtn), -360, 0.5)

	slot2:setOnComplete(System.Action(function ()
		uv0.refreshBtn.localEulerAngles = Vector3(0, 0, 0)

		setActive(uv0.refreshBtnGray, false)
		setActive(uv0.refreshBtnGray, true)
	end))

	if slot0.refreshtimer then
		slot0.refreshtimer:Stop()

		slot0.refreshtimer = nil
	end

	slot0.refreshtimer = Timer.New(function ()
		setActive(uv0.refreshBtnGray, true)
		setActive(uv0.refreshBtnGray, false)
	end, slot1, 1)

	slot0.refreshtimer:Start()
end

slot0.AddListeners = function(slot0, slot1)
	slot1:AddListener(WorldBossProxy.EventRankListUpdated, slot0.onRankListUpdated)
	slot1:AddListener(WorldBossProxy.EventCacheBossListUpdated, slot0.onCacheBossUpdated)
end

slot0.RemoveListeners = function(slot0, slot1)
	slot1:RemoveListener(WorldBossProxy.EventRankListUpdated, slot0.onRankListUpdated)
	slot1:RemoveListener(WorldBossProxy.EventCacheBossListUpdated, slot0.onCacheBossUpdated)
end

slot0.OnCacheBossUpdated = function(slot0)
	slot0:UpdateNonProcessList()
end

slot0.OnRankListUpdated = function(slot0, slot1, slot2, slot3)
	if slot0.boss and slot0.boss.id == slot3 and slot0.rankPage:GetLoaded() and slot0.rankPage:isActive() then
		slot0.rankPage:ExecuteAction(&quot;Update&quot;, slot0.proxy, slot0.boss.id)
	end
end

slot0.Update = function(slot0)
	slot0:emit(WorldBossMediator.UPDATE_CACHE_BOSS_HP, function ()
		uv0:UpdateNonProcessList()
		uv0:Show()
	end)
end

slot0.UpdateNonProcessList = function(slot0)
	slot1 = slot0.proxy

	slot3 = function(slot0)
		return _.any(_.select(uv0.filterFlags, function (slot0)
			return slot0 &gt;= 0
		end), function (slot0)
			return uv0:GetType() == slot0
		end)
	end

	slot0.displays = {}

	for slot7, slot8 in ipairs(slot1:GetCacheBossList()) do
		if not slot8:isDeath() and not slot8:IsExpired() and slot3(slot8) and not slot8:IsFullPeople() and slot0:OnFilterBoss(slot8) then
			table.insert(slot0.displays, slot8)
		end
	end

	table.sort(slot0.displays, function (slot0, slot1)
		return slot1:GetJoinTime() &lt; slot0:GetJoinTime()
	end)

	slot4 = 1

	for slot8, slot9 in ipairs(slot0.displays) do
		if slot9.id == slot0.contextData.worldBossId or slot9.id == slot0.worldBossId then
			slot4 = slot8

			break
		end
	end

	slot0.contextData.worldBossId = nil
	WorldBossScene.inOtherBossBattle = nil

	slot0.scrollRect:Align(#slot0.displays, slot4)
	setActive(slot0.filterToggle, true)
	setActive(slot0.refreshBtn, true)
end

slot0.OnFilterBoss = function(slot0, slot1)
	return true
end

slot0.OnInitCard = function(slot0, slot1, slot2)
	slot4 = false
	slot5 = slot1:Find(&quot;tags&quot;)

	removeOnButton(slot1)
	setText(slot1:Find(&quot;tags/friend/Text&quot;), &quot;&quot;)
	setText(slot1:Find(&quot;tags/guild/Text&quot;), &quot;&quot;)

	if slot0.displays[slot2 + 1] then
		slot4 = slot3:isDeath()

		setActive(slot1:Find(&quot;tags/friend&quot;), slot3:GetType() == WorldBoss.BOSS_TYPE_FRIEND)
		setActive(slot1:Find(&quot;tags/guild&quot;), slot6 == WorldBoss.BOSS_TYPE_GUILD)
		setActive(slot1:Find(&quot;tags/world&quot;), slot6 == WorldBoss.BOSS_TYPE_WORLD)

		slot5.anchoredPosition = Vector3(0, 14, 0)

		setText(slot1:Find(&quot;tags/friend/Text&quot;), slot3:GetRoleName())
		setText(slot1:Find(&quot;tags/guild/Text&quot;), slot3:GetRoleName())
		onButton(slot0, slot1, function ()
			uv0.scrollRect:SliceTo(uv1)
		end, SFX_PANEL)
		slot0:UpdateCardStyle(slot1, slot3.config.meta_id)
	end

	setActive(slot1:Find(&quot;complete&quot;), slot3 and slot4)
	setActive(slot1:Find(&quot;raiding&quot;), slot3 and not slot4)
	setActive(slot1:Find(&quot;empty&quot;), not slot3)
	setActive(slot5, slot3)
	setActive(slot1:Find(&quot;tags/friend/Text&quot;), false)
	setActive(slot1:Find(&quot;tags/guild/Text&quot;), false)
end

slot0.UpdateCardStyle = function(slot0, slot1, slot2)
	slot1:Find(&quot;raiding&quot;):GetComponent(typeof(Image)).sprite = GetSpriteFromAtlas(&quot;MetaWorldboss/&quot; .. slot2, &quot;item_03&quot;)
	slot3 = slot1:Find(&quot;empty&quot;):GetComponent(typeof(Image))
	slot3.sprite = GetSpriteFromAtlas(&quot;MetaWorldboss/&quot; .. slot2, &quot;item_04&quot;)

	slot3:SetNativeSize()

	slot1:Find(&quot;selected/challenging&quot;):GetComponent(typeof(Image)).sprite = GetSpriteFromAtlas(&quot;MetaWorldboss/&quot; .. slot2, &quot;item_01&quot; .. slot0:GetResSuffix())
end

slot0.OnPreviewCard = function(slot0, slot1, slot2)
	if slot0.prevSelected and slot0.prevSelected.boss then
		slot0.prevSelected.childTF:Find(&quot;tags&quot;).anchoredPosition = Vector3(0, 14, 0)

		setActive(slot0.prevSelected.childTF:Find(&quot;tags/friend/Text&quot;), false)
		setActive(slot0.prevSelected.childTF:Find(&quot;tags/guild/Text&quot;), false)
		setActive(slot0.prevSelected.childTF:Find(&quot;selected&quot;), false)
	end

	if slot0.displays[slot2 + 1] then
		slot4 = slot3:isDeath()

		setActive(slot1:Find(&quot;selected/challenging&quot;), not slot4)
		setActive(slot1:Find(&quot;selected/finished&quot;), slot4)

		slot1:Find(&quot;tags&quot;).anchoredPosition = Vector3(-17, 41.69, 0)

		setActive(slot1:Find(&quot;tags/friend/Text&quot;), true)
		setActive(slot1:Find(&quot;tags/guild/Text&quot;), true)
		slot0:UpdateMainView(slot3)
	end

	setActive(slot1:Find(&quot;selected&quot;), slot3)

	slot0.prevSelected = {
		childTF = slot1,
		boss = slot3
	}
end

slot0.OnSelectCard = function(slot0, slot1, slot2)
	slot0.boss = slot0.displays[slot2 + 1]
	slot0.worldBossId = nil

	if slot0.boss then
		slot0.worldBossId = slot3.id

		slot0:UpdateMainView(slot3)
	else
		setActive(slot0.mainPanel, false)
		setActive(slot0.painting, false)
	end
end

slot0.UpdateMainView = function(slot0, slot1, slot2)
	setActive(slot0.mainPanel, true)
	setActive(slot0.painting, true)

	slot3 = slot0.proxy

	onButton(slot0, slot0.rankBtn, function ()
		uv0.rankPage:ExecuteAction(&quot;Update&quot;, uv0.proxy, uv1.id)
	end, SFX_PANEL)

	slot0.hpSlider.value = 1
	slot0.levelTxt.text = slot1:GetLevel()
	slot0.hpTxt.text = &quot;HP:&quot; .. slot1:GetMaxHp()

	onButton(slot0, slot0.startBtn, function ()
		uv0:emit(WorldBossMediator.ON_BATTLE, uv1.id, true)
	end, SFX_PANEL)
	setActive(slot0.startBtn, not slot1:isDeath() and slot1:GetLeftTime() &gt; 0)
	slot0:removeBattleTimer()

	if not slot4 and not slot2 then
		slot0:addBattleTimer(slot1)
	end

	slot0:UpdatePainting(slot1.config.meta_id)
end

slot0.addBattleTimer = function(slot0, slot1)
	if slot1:GetExpiredTime() - pg.TimeMgr.GetInstance():GetServerTime() &gt;= 0 then
		slot0.timer = Timer.New(function ()
			if uv0.exited then
				uv0:removeBattleTimer()

				return
			end

			if uv1 - pg.TimeMgr.GetInstance():GetServerTime() &lt;= 0 then
				uv0.expiredTimeTxt.text = i18n(&quot;world_word_expired&quot;)

				uv0:removeBattleTimer()
				uv0:UpdateMainView(uv2, true)
			else
				uv0.expiredTimeTxt.text = pg.TimeMgr.GetInstance():DescCDTime(slot0)
			end
		end, 1, -1)

		slot0.timer:Start()
		slot0.timer.func()
	else
		slot0.expiredTimeTxt.text = i18n(&quot;world_word_expired&quot;)

		slot0:UpdateMainView(slot1, true)
	end
end

slot0.removeBattleTimer = function(slot0)
	if slot0.timer then
		slot0.timer:Stop()

		slot0.timer = nil
	end
end

slot0.OnDestroy = function(slot0)
	retMetaPaintingPrefab(slot0.painting, slot0.groupId)
	slot0:RemoveListeners(slot0.proxy)
	slot0:removeBattleTimer()
	slot0.scrollRect:Dispose()
	slot0.rankPage:Destroy()

	if slot0.refreshtimer then
		slot0.refreshtimer:Stop()

		slot0.refreshtimer = nil
	end

	slot0.exited = true
end

return slot0
</code></pre>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-lua.min.js"></script>
</body>
</html>