<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>worldportlayer.lua</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
</head>
<body>
    <h1>worldportlayer.lua</h1>
    <a href="index.html">返回主页</a>
    <pre><code class="language-lua">slot0 = class(&quot;WorldPortLayer&quot;, import(&quot;..base.BaseUI&quot;))
slot0.Listeners = {
	onUpdateNGoods = &quot;OnUpdateNGoods&quot;,
	onUpdateMoneyCount = &quot;OnUpdateMoneyCount&quot;,
	onUpdateTasks = &quot;OnUpdateTasks&quot;,
	onUpdateGoods = &quot;OnUpdateGoods&quot;
}
slot0.TitleName = {
	&quot;text_gangkou&quot;,
	&quot;text_operation&quot;,
	&quot;text_supply&quot;
}
slot0.PageMain = 0
slot0.PageTask = 1
slot0.PageShop = 2
slot0.PageDockyard = 3
slot0.PageNShop = 4
slot0.BlurPages = {
	[slot0.PageTask] = true,
	[slot0.PageShop] = true,
	[slot0.PageNShop] = true
}
slot0.optionsPath = {
	&quot;blur_panel/adapt/top/title/option&quot;
}

slot0.getUIName = function(slot0)
	return &quot;WorldPortUI&quot;
end

slot0.init = function(slot0)
	for slot4, slot5 in pairs(uv0.Listeners) do
		slot0[slot4] = function (...)
			uv0[uv1](uv2, ...)
		end
	end

	slot0.rtBg = slot0:findTF(&quot;bg&quot;)
	slot0.rtEnterIcon = slot0.rtBg:Find(&quot;enter_icon&quot;)
	slot0.rtBgNShop = slot0._tf:Find(&quot;bg_2&quot;)
	slot0.rtBlurPanel = slot0:findTF(&quot;blur_panel&quot;)
	slot0.rtTasks = slot0.rtBlurPanel:Find(&quot;adapt/tasks&quot;)
	slot0.rtShop = slot0.rtBlurPanel:Find(&quot;adapt/shop&quot;)
	slot0.rtPainting = slot0.rtShop:Find(&quot;paint&quot;)
	slot0.btnPainting = slot0.rtShop:Find(&quot;paint_touch&quot;)

	setActive(slot0.btnPainting, false)

	slot0.rtChat = slot0.rtShop:Find(&quot;chat&quot;)

	setActive(slot0.rtChat, false)

	slot0.rtNShop = slot0.rtBlurPanel:Find(&quot;adapt/new_shop&quot;)
	slot0.containerPort = slot0.rtNShop:Find(&quot;frame/content/left&quot;)
	slot1 = slot0.containerPort
	slot0.tplPort = slot1:Find(&quot;port_tpl&quot;)
	slot0.poolTplPort = {
		slot0.tplPort
	}
	slot0.rtNGoodsContainer = slot0.rtNShop:Find(&quot;frame/content/right/page/view/content&quot;)
	slot0.rtNShopRes = slot0.rtNShop:Find(&quot;frame/content/right/page/title/res&quot;)
	slot1 = Drop.New({
		type = DROP_TYPE_WORLD_ITEM,
		id = WorldItem.PortMoneyId
	})

	GetImageSpriteFromAtlasAsync(slot1:getIcon(), &quot;&quot;, slot0.rtNShopRes:Find(&quot;icon/Image&quot;), false)
	setText(slot0.rtNShopRes:Find(&quot;icon/name&quot;), slot1:getName())

	slot0.rtTop = slot0.rtBlurPanel:Find(&quot;adapt/top&quot;)
	slot0.btnBack = slot0.rtTop:Find(&quot;title/back_button&quot;)
	slot0.rtTopTitle = slot0.rtTop:Find(&quot;title&quot;)
	slot0.rtImageTitle = slot0.rtTopTitle:Find(&quot;print/title&quot;)
	slot0.rtImageTitleTask = slot0.rtTopTitle:Find(&quot;print/title_task&quot;)
	slot0.rtImageTitleShop = slot0.rtTopTitle:Find(&quot;print/title_shop&quot;)
	slot0.rtTopLeft = slot0.rtTop:Find(&quot;left_stage&quot;)
	slot0.rtTopRight = slot0.rtTop:Find(&quot;right_stage&quot;)
	slot0.wsWorldInfo = WSWorldInfo.New()
	slot0.wsWorldInfo.transform = slot0.rtTopRight:Find(&quot;display_panel/world_info&quot;)

	slot0.wsWorldInfo:Setup()
	setText(slot0.rtTopRight:Find(&quot;display_panel/title/title&quot;), i18n(&quot;world_map_title_tips&quot;))
	setText(slot0.rtTopRight:Find(&quot;display_panel/title/title_en&quot;), i18n(&quot;world_map_title_tips_en&quot;))
	setText(slot0.wsWorldInfo.transform:Find(&quot;power/bg/Word&quot;), i18n(&quot;world_total_power&quot;))
	setText(slot0.wsWorldInfo.transform:Find(&quot;explore/mileage/Text&quot;), i18n(&quot;world_mileage&quot;))
	setText(slot0.wsWorldInfo.transform:Find(&quot;explore/pressing/Text&quot;), i18n(&quot;world_pressing&quot;))

	slot0.rtTopBottom = slot0.rtTop:Find(&quot;bottom_stage&quot;)
	slot0.btnOperation = slot0.rtTopBottom:Find(&quot;btn/operation&quot;)
	slot0.btnSupply = slot0.rtTopBottom:Find(&quot;btn/supply&quot;)
	slot0.btnDockyard = slot0.rtTopBottom:Find(&quot;btn/dockyard&quot;)
	slot0.resPanel = WorldResource.New()

	slot0.resPanel._tf:SetParent(slot0.rtTop:Find(&quot;title/resources&quot;), false)

	slot0.rtTaskWindow = slot0:findTF(&quot;task_window&quot;)
	slot0.wsTasks = {}
	slot0.wsGoods = {}
	slot0.page = -1
	slot0.dirtyFlags = {}
	slot0.cdTF = slot0.rtShop:Find(&quot;timer_bg&quot;)
	slot0.emptyTF = slot0.rtShop:Find(&quot;frame/scrollview/empty&quot;)
	slot0.refreshBtn = slot0.rtShop:Find(&quot;refresh_btn&quot;)

	setActive(slot0.refreshBtn, false)

	slot0.glitchArtMaterial = slot0:findTF(&quot;resource/material1&quot;):GetComponent(typeof(Image)).material
	slot0.singleWindow = OriginShopSingleWindow.New(slot0._tf, slot0.event)
	slot0.multiWindow = OriginShopMultiWindow.New(slot0._tf, slot0.event)
end

slot0.didEnter = function(slot0)
	pg.UIMgr.GetInstance():BlurPanel(slot0._tf, false, {
		groupName = slot0:getGroupNameFromData()
	})
	onButton(slot0, slot0.btnBack, function ()
		if uv0.isTweening then
			return
		end

		if uv0.port:IsTempPort() or uv0.page == uv1.PageMain then
			uv0:EaseOutUI(function ()
				uv0:closeView()
			end)
		else
			uv0:SetPage(uv1.PageMain)
		end
	end, SFX_CANCEL)
	onButton(slot0, slot0.btnOperation, function ()
		uv0:SetPage(uv1.PageTask)
	end, SFX_PANEL)
	onButton(slot0, slot0.btnSupply, function ()
		if nowWorld():UsePortNShop() then
			uv0:SetPage(uv1.PageNShop)
		else
			uv0:SetPage(uv1.PageShop)
		end
	end, SFX_PANEL)
	onButton(slot0, slot0.btnDockyard, function ()
		uv0:emit(WorldPortMediator.OnOpenBay)
	end, SFX_PANEL)
	slot0:UpdatePainting(slot0:GetPaintingInfo())
	slot0:UpdateTaskTip()
	slot0:UpdateCDTip()
	slot0:UpdateNShopTip()

	if slot0.port:IsTempPort() then
		slot0.contextData.page = WorldPortLayer.PageShop
	elseif slot0.contextData.page == WorldPortLayer.PageDockyard then
		slot0.contextData.page = nil
	end

	slot0:SetPage(slot0.contextData.page or WorldPortLayer.PageMain)
	slot0:EaseInUI()
end

slot0.onBackPressed = function(slot0)
	triggerButton(slot0.btnBack)
end

slot0.willExit = function(slot0)
	pg.UIMgr.GetInstance():UnblurPanel(slot0._tf)
	slot0:RecyclePainting(slot0.rtPainting)
	slot0.singleWindow:Destroy()
	slot0.multiWindow:Destroy()

	slot0.contextData.isEnter = true

	if uv0.BlurPages[slot0.page] then
		pg.UIMgr.GetInstance():UnblurPanel(slot0.rtBlurPanel, slot0._tf)
	end

	slot0:CancelUITween()
	slot0:DisposeTopUI()
	slot0:DisposeTasks()
	slot0:DisposeGoods()
	slot0.atlas:RemoveListener(WorldAtlas.EventUpdateNGoodsCount, slot0.onUpdateNGoods)

	slot0.atlas = nil

	slot0.port:RemoveListener(WorldMapPort.EventUpdateTaskIds, slot0.onUpdateTasks)
	slot0.port:RemoveListener(WorldMapPort.EventUpdateGoods, slot0.onUpdateGoods)

	slot0.port = nil

	slot0.resPanel:exit()

	slot0.resPanel = nil

	slot0.refreshTimer:Stop()

	slot0.refreshTimer = nil

	slot0.inventory:RemoveListener(WorldInventoryProxy.EventUpdateItem, slot0.onUpdateMoneyCount)

	slot0.inventory = nil

	slot0.taskProxy:RemoveListener(WorldTaskProxy.EventUpdateTask, slot0.onUpdateTasks)

	slot0.taskProxy = nil

	slot0.wsWorldInfo:Dispose()

	slot0.wsWorldInfo = nil
end

slot0.GetPaintingInfo = function(slot0)
	if slot0.port:IsTempPort() then
		return &quot;mingshi&quot;, false
	else
		return &quot;tbniang&quot;, true
	end
end

slot0.UpdatePainting = function(slot0, slot1, slot2)
	slot0.paintingName = slot1

	setPaintingPrefab(slot0.rtPainting, slot1, &quot;chuanwu&quot;)

	if slot2 then
		slot0:AddGlitchArtEffectForPating(slot0.rtPainting)
	end
end

slot0.AddGlitchArtEffectForPating = function(slot0, slot1)
	for slot6, slot7 in ipairs(slot1:GetComponentsInChildren(typeof(Image)):ToTable()) do
		slot7.material = slot0.glitchArtMaterial
	end
end

slot0.RecyclePainting = function(slot0, slot1)
	if slot1:Find(&quot;fitter&quot;).childCount &gt; 0 then
		for slot6, slot7 in ipairs(slot1:GetComponentsInChildren(typeof(Image)):ToTable()) do
			slot8 = Color.white

			if slot7.material ~= slot7.defaultGraphicMaterial then
				slot7.material = slot7.defaultGraphicMaterial

				slot7.material:SetColor(&quot;_Color&quot;, slot8)
			end
		end

		setGray(slot1, false, true)

		slot3 = slot1:Find(&quot;fitter&quot;):GetChild(0)

		retPaintingPrefab(slot1, slot3.name)

		if slot3:Find(&quot;temp_mask&quot;) then
			Destroy(slot4)
		end
	end
end

slot0.DisplayTopUI = function(slot0, slot1)
	setActive(slot0.rtImageTitle, slot1 == uv0.PageMain)
	setActive(slot0.rtImageTitleTask, slot1 == uv0.PageTask)
	setActive(slot0.rtImageTitleShop, slot1 == uv0.PageShop or slot1 == uv0.PageNShop)
	setActive(slot0.rtTopLeft, slot1 ~= uv0.PageNShop)
	setActive(slot0.rtTopRight, slot1 == uv0.PageMain)
	setActive(slot0.rtTopBottom, slot1 == uv0.PageMain)
	setActive(slot0.rtBg, slot1 ~= uv0.PageNShop)
	setActive(slot0.rtBgNShop, slot1 == uv0.PageNShop)
end

slot0.DisposeTopUI = function(slot0)
	slot0.wsPortLeft:Dispose()
end

slot0.NewPortLeft = function(slot0)
	slot1 = WSPortLeft.New()
	slot1.transform = slot0.rtTopLeft

	slot1:Setup()
	slot1:UpdateMap(nowWorld():GetActiveMap())

	return slot1
end

slot0.EnterPortAnim = function(slot0, slot1)
	if slot0.rtEnterIcon:GetComponent(typeof(DftAniEvent)) then
		slot2:SetTriggerEvent(function (slot0)
			uv0()
		end)
		slot2:SetEndEvent(function (slot0)
			setActive(uv0.rtEnterIcon, false)
		end)
	end

	setActive(slot0.rtEnterIcon, true)
end

slot0.EaseInUI = function(slot0, slot1)
	slot0.isTweening = true
	slot2 = {}

	slot0:CancelUITween()

	if #slot0.enterIcon &gt; 0 and not slot0.contextData.isEnter then
		table.insert(slot2, function (slot0)
			setActive(uv0.rtTop, false)

			slot1 = uv0

			slot1:EnterPortAnim(function ()
				setActive(uv0.rtTop, true)

				return uv1()
			end)
		end)
	else
		setActive(slot0.rtEnterIcon, false)
	end

	seriesAsync(slot2, function ()
		setAnchoredPosition(uv0.rtTopLeft, {
			x = -uv0.rtTopLeft.rect.width
		})
		setAnchoredPosition(uv0.rtTopRight, {
			x = uv0.rtTopRight.rect.width
		})
		setAnchoredPosition(uv0.rtTopTitle, {
			y = uv0.rtTopTitle.rect.height
		})
		setAnchoredPosition(uv0.rtTopBottom, {
			y = -uv0.rtTopRight.rect.height
		})

		slot0 = LeanTween.moveX(uv0.rtTopLeft, 0, WorldConst.UIEaseDuration)

		slot0:setEase(LeanTweenType.easeOutSine)

		slot0 = LeanTween.moveX(uv0.rtTopRight, 0, WorldConst.UIEaseDuration)

		slot0:setEase(LeanTweenType.easeOutSine)

		slot0 = LeanTween.moveY(uv0.rtTopTitle, 0, WorldConst.UIEaseDuration)

		slot0:setEase(LeanTweenType.easeOutSine)

		slot0 = LeanTween.moveY(uv0.rtTopBottom, 0, WorldConst.UIEaseDuration)
		slot0 = slot0:setEase(LeanTweenType.easeOutSine)

		slot0:setOnComplete(System.Action(function ()
			uv0.isTweening = false

			return existCall(uv1)
		end))
	end)
end

slot0.EaseOutUI = function(slot0, slot1)
	slot0:CancelUITween()

	slot2 = LeanTween.moveX(slot0.rtTopLeft, -slot0.rtTopLeft.rect.width, WorldConst.UIEaseDuration)

	slot2:setEase(LeanTweenType.easeOutSine)

	slot2 = LeanTween.moveX(slot0.rtTopRight, slot0.rtTopRight.rect.width, WorldConst.UIEaseDuration)

	slot2:setEase(LeanTweenType.easeOutSine)

	slot2 = LeanTween.moveY(slot0.rtTopTitle, slot0.rtTopTitle.rect.height, WorldConst.UIEaseDuration)

	slot2:setEase(LeanTweenType.easeOutSine)

	slot2 = LeanTween.moveY(slot0.rtTopBottom, -slot0.rtTopRight.rect.height, WorldConst.UIEaseDuration)
	slot2 = slot2:setEase(LeanTweenType.easeOutSine)

	slot2:setOnComplete(System.Action(function ()
		uv0.isTweening = false

		return existCall(uv1)
	end))
end

slot0.CancelUITween = function(slot0)
	LeanTween.cancel(go(slot0.rtTopTitle))
	LeanTween.cancel(go(slot0.rtTopLeft))
	LeanTween.cancel(go(slot0.rtTopRight))
	LeanTween.cancel(go(slot0.rtTopBottom))
end

slot0.SetPlayer = function(slot0, slot1)
	slot0.player = slot1

	slot0.resPanel:setPlayer(slot1)
end

slot0.SetAtlas = function(slot0, slot1)
	slot0.atlas = slot1
	slot5 = slot0.onUpdateNGoods

	slot0.atlas:AddListener(WorldAtlas.EventUpdateNGoodsCount, slot5)

	slot0.nGoodsDic = {}
	slot0.nGoodsPortDic = {}

	for slot5, slot6 in pairs(slot1.nShopGoodsDic) do
		slot0.nGoodsDic[slot5] = Goods.Create({
			id = slot5,
			count = slot6
		}, Goods.TYPE_WORLD_NSHOP)
		slot0.nGoodsPortDic[slot7] = slot0.nGoodsPortDic[slot0.nGoodsDic[slot5]:getConfig(&quot;port_id&quot;)] or {}

		table.insert(slot0.nGoodsPortDic[slot7], slot0.nGoodsDic[slot5])
	end

	for slot5, slot6 in pairs(slot0.nGoodsPortDic) do
		table.sort(slot6, CompareFuncs({
			function (slot0)
				return -slot0:getConfig(&quot;priority&quot;)
			end,
			function (slot0)
				return slot0.id
			end
		}))
	end
end

slot0.SetPort = function(slot0, slot1)
	slot0.port = slot1

	slot0.port:AddListener(WorldMapPort.EventUpdateTaskIds, slot0.onUpdateTasks)
	slot0.port:AddListener(WorldMapPort.EventUpdateGoods, slot0.onUpdateGoods)
	slot0:SetBg(slot0.port.id)

	slot0.refreshTimer = Timer.New(function ()
		if uv0.port:IsValid() then
			uv0:UpdateRefreshTime(uv0.port.expiredTime - pg.TimeMgr.GetInstance():GetServerTime())
		else
			uv0:emit(WorldPortMediator.OnReqPort, uv1:GetActiveMap().id)
		end
	end, 1, -1)

	slot0.refreshTimer:Start()
	slot0.refreshTimer.func()

	slot3 = nowWorld():GetActiveMap():GetFleet()
	slot0.wsPortLeft = slot0:NewPortLeft()

	setActive(slot0.btnOperation, slot0.port:GetRealm() == 0 or slot4 == slot2:GetRealm())
	setActive(slot0.btnDockyard, slot4 == 0 or slot4 == slot2:GetRealm())
	setActive(slot0.btnSupply, slot0.nGoodsPortDic[slot1.id])
	setActive(slot0.resPanel._tf, slot2:IsSystemOpen(WorldConst.SystemResource))

	slot0.inventory = slot2:GetInventoryProxy()

	slot0.inventory:AddListener(WorldInventoryProxy.EventUpdateItem, slot0.onUpdateMoneyCount)
	slot0:OnUpdateMoneyCount()

	slot0.taskProxy = slot2:GetTaskProxy()

	slot0.taskProxy:AddListener(WorldTaskProxy.EventUpdateTask, slot0.onUpdateTasks)
end

slot0.SetBg = function(slot0, slot1)
	slot0.portBg = pg.world_port_data[slot1].port_bg

	setImageAlpha(slot0.rtBg, #slot0.portBg &gt; 0 and 1 or 0)

	if #slot0.portBg &gt; 0 then
		GetImageSpriteFromAtlasAsync(&quot;world/port/&quot; .. slot0.portBg, &quot;&quot;, slot0.rtBg)
	end

	slot0.enterIcon = pg.world_port_data[slot1].port_entrance_icon

	setActive(slot0.rtEnterIcon, #slot0.enterIcon &gt; 0)

	if #slot0.enterIcon &gt; 0 then
		GetImageSpriteFromAtlasAsync(&quot;world/porttitle/&quot; .. slot0.enterIcon, &quot;&quot;, slot0.rtEnterIcon, false)
	end

	GetImageSpriteFromAtlasAsync(&quot;world/portword/&quot; .. slot0.portBg, &quot;&quot;, slot0.rtImageTitle, true)
	GetImageSpriteFromAtlasAsync(&quot;world/portword/&quot; .. slot0.portBg .. &quot;_en&quot;, &quot;&quot;, slot0.rtImageTitle:Find(&quot;Image&quot;), true)
end

slot0.OnUpdateTasks = function(slot0)
	slot0:UpdateTaskTip()
	slot0:SetPageDirty(uv0.PageTask)

	if slot0.page == uv0.PageTask then
		slot0:UpdateTasks()
	end
end

slot0.OnUpdateGoods = function(slot0)
	slot0:UpdateCDTip()
	slot0:SetPageDirty(uv0.PageShop)

	if slot0.page == uv0.PageShop then
		slot0:UpdateGoods()
	end
end

slot0.OnUpdateNGoods = function(slot0, slot1, slot2, slot3, slot4)
	if slot0.page == uv0.PageNShop then
		slot5 = slot0.nGoodsDic[slot3]
		slot5.buyCount = slot4
		slot6 = slot0.rtNGoodsDic[slot3]

		setText(slot6:Find(&quot;count_contain/count&quot;), slot5:GetPurchasableCnt() .. &quot;/&quot; .. slot5:GetLimitGoodCount())
		setActive(slot6:Find(&quot;mask&quot;), not slot5:canPurchase())
		setActive(slot6:Find(&quot;new&quot;), false)
	else
		slot0:SetPageDirty(uv0.PageNShop)
	end
end

slot0.SetPage = function(slot0, slot1)
	if slot0.page ~= slot1 then
		if uv0.BlurPages[slot0.page or 0] ~= uv0.BlurPages[slot1] then
			if uv0.BlurPages[slot1] then
				pg.UIMgr.GetInstance():BlurPanel(slot0.rtBlurPanel, false)
			else
				pg.UIMgr.GetInstance():UnblurPanel(slot0.rtBlurPanel, slot0._tf)
			end
		end

		if slot1 == uv0.PageShop and slot0.paintingName == &quot;buzhihuo_shop&quot; then
			slot0:showRandomShipWord(pg.navalacademy_shoppingstreet_template[1].words_enter, true, &quot;enter&quot;)
		end

		slot0.page = slot1

		slot0:UpdatePage()

		slot0.contextData.page = slot1
	end
end

slot0.SetPageDirty = function(slot0, slot1)
	slot0.dirtyFlags[slot1] = true
end

slot0.IsPageDirty = function(slot0, slot1)
	return slot0.dirtyFlags[slot1] == true or slot0.dirtyFlags[slot1] == nil
end

slot0.UpdatePage = function(slot0)
	slot1 = slot0.page

	slot0:DisplayTopUI(slot1)
	setActive(slot0.rtTasks, slot1 == uv0.PageTask)
	setActive(slot0.rtShop, slot1 == uv0.PageShop)
	setActive(slot0.rtNShop, slot1 == uv0.PageNShop)

	if slot0:IsPageDirty(slot1) then
		if slot1 == uv0.PageTask then
			slot0:UpdateTasks()
		elseif slot1 == uv0.PageShop then
			slot0:UpdateGoods()
		elseif slot1 == uv0.PageNShop then
			slot0:UpdateNShopPorts()
		end
	end
end

slot0.UpdateTasks = function(slot0)
	slot0.dirtyFlags[uv0.PageTask] = false
	slot1 = slot0.rtTasks:Find(&quot;frame/viewport/content&quot;)
	slot3 = _.map(slot0.port.taskIds, function (slot0)
		return WorldTask.New({
			id = slot0
		})
	end)

	table.sort(slot3, CompareFuncs(WorldTask.sortDic))
	UIItemList.StaticAlign(slot1, slot1:GetChild(0), #slot3, function (slot0, slot1, slot2)
		slot3 = slot1 + 1

		if slot0 == UIItemList.EventUpdate then
			uv1.wsTasks[slot3] = uv1.wsTasks[slot3] or WSPortTask.New(slot2)
			slot5 = uv1.wsTasks[slot3]

			slot5:Setup(uv0[slot3])
			onButton(uv1, slot5.btnInactive, function ()
				uv0:emit(WorldPortMediator.OnAccepetTask, uv1, uv0.port.id)
			end, SFX_PANEL)
			onButton(uv1, slot5.btnOnGoing, function ()
				uv0:showTaskWindow(uv1)
			end, SFX_PANEL)
			onButton(uv1, slot5.btnFinished, function ()
				uv0:emit(WorldPortMediator.OnSubmitTask, uv1)
			end, SFX_PANEL)

			slot5.onDrop = function(slot0)
				uv0:emit(uv1.ON_DROP, slot0)
			end
		end
	end)
	setActive(slot0.rtTasks:Find(&quot;frame/empty&quot;), #slot3 == 0)
end

slot0.DisposeTasks = function(slot0)
	_.each(slot0.wsTasks, function (slot0)
		slot0:Dispose()
	end)

	slot0.wsTasks = {}
end

slot0.UpdateGoods = function(slot0)
	slot0.dirtyFlags[uv0.PageShop] = false
	slot1 = slot0.rtShop
	slot1 = slot1:Find(&quot;frame/scrollview/view&quot;)
	slot3 = underscore.rest(slot0.port.goods, 1)

	table.sort(slot3, CompareFuncs({
		function (slot0)
			return -slot0.config.priority
		end,
		function (slot0)
			return slot0.id
		end
	}))
	UIItemList.StaticAlign(slot1, slot1:GetChild(0), #slot3, function (slot0, slot1, slot2)
		slot1 = slot1 + 1

		if slot0 == UIItemList.EventUpdate then
			uv1.wsGoods[slot1] = uv1.wsGoods[slot1] or WSPortGoods.New(slot2)
			slot4 = uv1.wsGoods[slot1]

			slot4:Setup(uv0[slot1])
			onButton(uv1, slot4.transform, function ()
				if uv0.count &gt; 0 then
					pg.MsgboxMgr.GetInstance():ShowMsgBox({
						yesText = &quot;text_buy&quot;,
						type = MSGBOX_TYPE_SINGLE_ITEM,
						drop = uv0.item,
						onYes = function ()
							uv0:emit(WorldPortMediator.OnBuyGoods, uv1)
						end
					})
				end
			end, SFX_PANEL)
		end
	end)
end

slot0.DisposeGoods = function(slot0)
	_.each(slot0.wsGoods, function (slot0)
		slot0:Dispose()
	end)

	slot0.wsGoods = {}
end

slot0.UpdateNShopPorts = function(slot0)
	slot0.dirtyFlags[uv0.PageNShop] = false
	slot1 = underscore.keys(slot0.nGoodsPortDic)

	table.sort(slot1)

	for slot5, slot6 in ipairs(slot1) do
		if not slot0.poolTplPort[slot5] then
			table.insert(slot0.poolTplPort, cloneTplTo(slot0.tplPort, slot0.containerPort))
		end

		slot7 = slot0.poolTplPort[slot5]

		setText(slot7:Find(&quot;Text&quot;), pg.world_port_data[slot6].name)
		setActive(slot7:Find(&quot;tip&quot;), slot0.atlas.markPortDic.newGoods[slot6])
		onToggle(slot0, slot7, function (slot0)
			if slot0 then
				if uv0.nShopPortId == uv1 then
					return
				end

				setActive(uv2:Find(&quot;tip&quot;), false)
				uv0.atlas:UpdatePortMarkNShop(uv1, false)
				uv0:UpdateNShopTip()
				uv0:UpdateNShopGoods(uv1)
			end
		end, SFX_PANEL)
		triggerToggle(slot7, slot6 == slot0.port.id)
	end
end

slot0.UpdateNShopGoods = function(slot0, slot1)
	slot0.nShopPortId = slot1
	slot2 = slot0.atlas:GetPressingUnlockCount()
	slot3 = slot0.atlas:GetPressingUnlockRecordCount(slot1)
	slot4 = {}

	for slot8, slot9 in ipairs(slot0.nGoodsPortDic[slot1]) do
		slot4[slot10] = slot4[slot9:getConfig(&quot;unlock_num&quot;)] or {}

		table.insert(slot4[slot10], slot9)
	end

	slot0.rtNGoodsDic = {}
	slot5 = underscore.keys(slot4)

	table.sort(slot5)
	UIItemList.StaticAlign(slot0.rtNGoodsContainer, slot0.rtNGoodsContainer:Find(&quot;group&quot;), #slot5, function (slot0, slot1, slot2)
		slot1 = slot1 + 1

		if slot0 == UIItemList.EventUpdate then
			slot3 = uv0[slot1]

			setActive(slot2:Find(&quot;title&quot;), slot1 &gt; 1)
			setText(slot2:Find(&quot;title/other/Text&quot;), i18n(&quot;world_instruction_port_goods_locked&quot;))
			setText(slot2:Find(&quot;title/other/progress&quot;), math.min(uv1, slot3) .. &quot;/&quot; .. slot3)

			slot4 = slot2:Find(&quot;container&quot;)

			UIItemList.StaticAlign(slot4, slot4:Find(&quot;item_tpl&quot;), #uv2[slot3], function (slot0, slot1, slot2)
				slot1 = slot1 + 1

				if slot0 == UIItemList.EventUpdate then
					slot3 = uv0[uv1][slot1]
					uv2.rtNGoodsDic[slot3.id] = slot2
					slot4 = slot3:GetDropInfo()

					updateDrop(slot2:Find(&quot;IconTpl&quot;), slot4)
					setText(slot2:Find(&quot;name_mask/name&quot;), shortenString(slot4:getConfig(&quot;name&quot;), 6))

					slot5 = slot3:GetPriceInfo()

					GetImageSpriteFromAtlasAsync(slot5:getIcon(), &quot;&quot;, slot2:Find(&quot;consume/contain/icon&quot;), false)
					setText(slot2:Find(&quot;consume/contain/Text&quot;), slot5.count)
					setText(slot2:Find(&quot;count_contain/count&quot;), slot3:GetPurchasableCnt() .. &quot;/&quot; .. slot3:GetLimitGoodCount())
					setText(slot2:Find(&quot;count_contain/label&quot;), i18n(&quot;activity_shop_exchange_count&quot;))
					setText(slot2:Find(&quot;mask/tag/sellout_tag&quot;), i18n(&quot;word_sell_out&quot;))
					setActive(slot2:Find(&quot;mask&quot;), not slot3:canPurchase())
					setText(slot2:Find(&quot;lock/Image/Text&quot;), i18n(&quot;word_sell_lock&quot;))
					setActive(slot2:Find(&quot;lock&quot;), uv3 &lt; uv1)
					setActive(slot2:Find(&quot;new&quot;), slot3.buyCount == 0 and uv4 &lt; uv1 and uv1 &lt;= uv3)
					onButton(uv2, slot2, function ()
						(uv0:GetLimitGoodCount() &gt; 1 and uv1.multiWindow or uv1.singleWindow):ExecuteAction(&quot;Open&quot;, uv0, function (slot0, slot1)
							uv0:emit(WorldPortMediator.OnBuyNShopGoods, slot0, slot1)
						end)
					end, SFX_PANEL)
				end
			end)
		end
	end)
	slot0.atlas:SetPressingUnlockRecordCount(slot1, slot2)
end

slot0.OnUpdateMoneyCount = function(slot0, slot1, slot2, slot3)
	if not slot1 or slot3.id == WorldItem.PortMoneyId then
		slot4 = slot0.inventory:GetItemCount(WorldItem.PortMoneyId)

		setText(slot0.rtShop:Find(&quot;quick_count/value&quot;), slot4)
		setText(slot0.rtNShopRes:Find(&quot;Text&quot;), slot4)
	end
end

slot0.UpdateRefreshTime = function(slot0, slot1)
	setText(slot0.cdTF:Find(&quot;Text&quot;), pg.TimeMgr.GetInstance():DescCDTime(slot1))
end

slot0.UpdateCDTip = function(slot0)
	setActive(slot0.cdTF, #slot0.port.goods &gt; 0 and not slot0.port:IsTempPort())
	setActive(slot0.emptyTF, #slot0.port.goods == 0)

	if not nowWorld():UsePortNShop() then
		setActive(slot0.btnSupply:Find(&quot;new&quot;), nowWorld():GetAtlas().markPortDic.goods[slot0.port.id])
	end
end

slot0.UpdateTaskTip = function(slot0)
	setActive(slot0.btnOperation:Find(&quot;new&quot;), false)
end

slot0.UpdateNShopTip = function(slot0)
	if nowWorld():UsePortNShop() then
		setActive(slot0.btnSupply:Find(&quot;new&quot;), slot0.atlas:GetAnyPortMarkNShop())
	end
end

slot0.showTaskWindow = function(slot0, slot1)
	setActive(slot0.rtTaskWindow:Find(&quot;main_window/left_panel&quot;):Find(&quot;bg&quot;), slot1:IsSpecialType())

	if #slot1.config.rare_task_icon &gt; 0 then
		GetImageSpriteFromAtlasAsync(&quot;shipyardicon/&quot; .. slot2, &quot;&quot;, slot3:Find(&quot;card&quot;), true)
	else
		GetImageSpriteFromAtlasAsync(&quot;ui/worldportui_atlas&quot;, &quot;nobody&quot;, slot3:Find(&quot;card&quot;), true)
	end

	slot4 = slot0.rtTaskWindow:Find(&quot;main_window/right_panel&quot;)

	setText(slot4:Find(&quot;title/Text&quot;), slot1.config.name)
	setText(slot4:Find(&quot;content/desc&quot;), slot1.config.rare_task_text)
	setText(slot4:Find(&quot;content/slider_progress/Text&quot;), slot1:getProgress() .. &quot;/&quot; .. slot1:getMaxProgress())
	setSlider(slot4:Find(&quot;content/slider&quot;), 0, slot1:getMaxProgress(), slot1:getProgress())

	slot5 = slot4:Find(&quot;content/item_tpl&quot;)

	removeAllChildren(slot4:Find(&quot;content/award_bg/panel/content&quot;))

	for slot11, slot12 in ipairs(slot1.config.show) do
		slot13 = cloneTplTo(slot5, slot6)

		updateDrop(slot13, {
			type = slot12[1],
			id = slot12[2],
			count = slot12[3]
		})
		onButton(slot0, slot13, function ()
			uv0:emit(uv1.ON_DROP, uv2)
		end, SFX_PANEL)
		setActive(slot13, true)
	end

	setActive(slot5, false)
	setActive(slot4:Find(&quot;content/award_bg/arror&quot;), #slot7 &gt; 3)
	onButton(slot0, slot4:Find(&quot;btn_close&quot;), function ()
		uv0:hideTaskWindow()
	end, SFX_CANCEL)
	onButton(slot0, slot0.rtTaskWindow:Find(&quot;bg&quot;), function ()
		uv0:hideTaskWindow()
	end, SFX_CANCEL)
	onButton(slot0, slot4:Find(&quot;btn_go&quot;), function ()
		uv0:hideTaskWindow()
		uv0:emit(WorldPortMediator.OnTaskGoto, uv1.id)
	end, SFX_PANEL)
	setButtonEnabled(slot4:Find(&quot;btn_go&quot;), slot1:GetFollowingAreaId() or slot1:GetFollowingEntrance())
	setActive(slot0.rtTaskWindow, true)
	pg.UIMgr.GetInstance():BlurPanel(slot0.rtTaskWindow, slot0._tf)
end

slot0.hideTaskWindow = function(slot0)
	setActive(slot0.rtTaskWindow, false)
	pg.UIMgr.GetInstance():UnblurPanel(slot0.rtTaskWindow, slot0._tf)
end

return slot0
</code></pre>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-lua.min.js"></script>
</body>
</html>