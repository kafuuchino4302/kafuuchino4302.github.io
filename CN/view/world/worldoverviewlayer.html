<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>worldoverviewlayer.lua</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
</head>
<body>
    <h1>worldoverviewlayer.lua</h1>
    <a href="index.html">返回主页</a>
    <pre><code class="language-lua">slot0 = class(&quot;WorldOverviewLayer&quot;, import(&quot;..base.BaseUI&quot;))

slot0.getUIName = function(slot0)
	return &quot;WorldOverviewUI&quot;
end

slot0.preload = function(slot0, slot1)
	slot0:LoadAtlasOverall(slot1)
end

slot0.init = function(slot0)
	slot1 = slot0._tf
	slot0.rtBg = slot1:Find(&quot;bg&quot;)

	onButton(slot0, slot0.rtBg, function ()
		uv0:closeView()
	end, SFX_CANCEL)
	setText(slot1:Find(&quot;tip/Text&quot;), i18n(&quot;click_back_tip&quot;))

	slot0.rtTaskPanel = slot1:Find(&quot;panel/middle/info_panel/task_panel&quot;)

	setActive(slot0.rtTaskPanel, false)
	setActive(slot0.rtTaskPanel:Find(&quot;btn_next&quot;), false)

	slot0.entranceItemList = UIItemList.New(slot0.rtTaskPanel:Find(&quot;entrance_list/target_list&quot;), slot0.rtTaskPanel:Find(&quot;entrance_list/target_tpl&quot;))

	slot0.entranceItemList:make(function (slot0, slot1, slot2)
		slot1 = slot1 + 1

		if slot0 == UIItemList.EventUpdate then
			if uv0.entranceIds[slot1] then
				setActive(slot2:Find(&quot;Image&quot;), true)
				setText(slot2:Find(&quot;Text&quot;), i18n(&quot;world_task_view1&quot;) .. nowWorld():GetEntrance(uv0.entranceIds[slot1]):GetBaseMap():GetName())
			else
				setActive(slot2:Find(&quot;Image&quot;), true)
				setText(slot2:Find(&quot;Text&quot;), i18n(&quot;world_task_view1&quot;) .. i18n(&quot;world_task_view2&quot;))
			end
		end
	end)

	slot0.areaItemList = UIItemList.New(slot0.rtTaskPanel:Find(&quot;entrance_list/target_list&quot;), slot0.rtTaskPanel:Find(&quot;entrance_list/target_tpl&quot;))

	slot0.areaItemList:make(function (slot0, slot1, slot2)
		slot1 = slot1 + 1

		if slot0 == UIItemList.EventUpdate then
			if uv0.areaIds[slot1] then
				setActive(slot2:Find(&quot;Image&quot;), true)
				setText(slot2:Find(&quot;Text&quot;), i18n(&quot;world_task_view1&quot;) .. pg.world_regions_data[uv0.areaIds[slot1]].name)
			else
				setActive(slot2:Find(&quot;Image&quot;), true)
				setText(slot2:Find(&quot;Text&quot;), i18n(&quot;world_task_view1&quot;) .. i18n(&quot;world_task_view2&quot;))
			end
		end
	end)

	slot0.rtAchievementPanel = slot1:Find(&quot;panel/middle/info_panel/achievement_panel&quot;)

	setActive(slot0.rtAchievementPanel, false)

	slot0.btnAchieve = slot0.rtAchievementPanel:Find(&quot;btn_all&quot;)

	onButton(slot0, slot0.btnAchieve, function ()
		slot0, slot1 = nowWorld():GetFinishAchievements()

		if #slot0 == 0 then
			pg.TipsMgr.GetInstance():ShowTips(&quot;without any award&quot;)
		else
			uv0:emit(WorldOverviewMediator.OnAchieveStar, slot0)
			uv0:closeView()
		end
	end, SFX_CONFIRM)
	pg.UIMgr.GetInstance():BlurPanel(slot0._tf, false, {
		blurLevelCamera = true,
		weight = LayerWeightConst.TOP_LAYER
	})
end

slot0.didEnter = function(slot0)
	slot0.mode = slot0.contextData.info.mode

	if slot0.mode == &quot;Task&quot; then
		slot0.taskId = slot1.taskId

		slot0:UpdateTaskPanel()
	elseif slot0.mode == &quot;Achievement&quot; then
		slot0:UpdateAchievementPanel()
	else
		slot0.entranceIds = slot1.ids
	end

	slot2 = slot0._tf
	slot2 = slot2:GetComponent(&quot;DftAniEvent&quot;)

	slot2:SetEndEvent(function (slot0)
		slot1 = {}

		_.each(uv0.entranceIds, function (slot0)
			uv0[slot0] = true
		end)

		if #uv0.entranceIds &gt; 0 then
			uv0.wsAtlasOverall:UpdateTargetEntrance(uv0.entranceIds[1])
		end

		uv0.wsAtlasOverall:UpdateStaticMark(slot1, uv0:GetOverviewMark())
		uv0:DisplayAtlasOverall()

		if uv0.mode then
			setActive(uv0[&quot;rt&quot; .. uv0.mode .. &quot;Panel&quot;], true)

			if uv0.mode == &quot;Task&quot; then
				eachChild(uv0.entranceItemList.container, function (slot0)
					slot1 = GetComponent(slot0:Find(&quot;Text&quot;), typeof(Typewriter))

					slot1:setSpeed(0.03)
					slot1:Play()
				end)

				slot3 = GetComponent(uv0.rtTaskPanel:Find(&quot;entrance_list/target_tpl&quot;):Find(&quot;Text&quot;), typeof(Typewriter))

				slot3:setSpeed(0.03)
				slot3:Play()
			end
		end
	end)
end

slot0.willExit = function(slot0)
	pg.UIMgr.GetInstance():UnblurPanel(slot0._tf, slot0._parentTf)

	if slot0.mode then
		setActive(slot0[&quot;rt&quot; .. slot0.mode .. &quot;Panel&quot;], false)
	end

	slot0:HideAtlasOverall()
	slot0:DisposeAtlasOverall()
end

slot0.GetOverviewMark = function(slot0)
	if slot0.mode == &quot;Task&quot; then
		if slot0.isTaskArea then
			return {
				&quot;overview_port&quot;
			}
		else
			return {
				&quot;overview_task_port&quot;,
				&quot;overview_task&quot;
			}
		end
	elseif slot0.mode == &quot;Achievement&quot; then
		return {
			&quot;overview_achievement&quot;,
			&quot;overview_achievement&quot;
		}
	else
		return {
			&quot;overview_task_port&quot;,
			&quot;overview_task&quot;
		}
	end
end

slot0.UpdateTaskPanel = function(slot0)
	slot2 = nowWorld():GetTaskProxy():getTaskById(slot0.taskId)

	assert(slot2, &quot;without this doing task: &quot; .. slot0.taskId)

	slot3 = slot0.rtTaskPanel:Find(&quot;task_info&quot;)

	GetImageSpriteFromAtlasAsync(&quot;ui/worldtaskfloatui_atlas&quot;, pg.WorldToastMgr.Type2PictrueName[slot2.config.type], slot3:Find(&quot;type&quot;), true)
	setText(slot3:Find(&quot;name/Text&quot;), slot2.config.name)

	if slot2:GetFollowingAreaId() then
		slot0.isTaskArea = true
		slot0.entranceIds = underscore.rest(slot1:GetAreaEntranceIds(slot4), 1)
		slot0.areaIds = {
			slot4
		}

		slot0.areaItemList:align(math.max(#slot0.areaIds, 1))
	else
		slot0.isTaskArea = false
		slot0.entranceIds = {
			slot2:GetFollowingEntrance()
		}

		slot0.entranceItemList:align(math.max(#slot0.entranceIds, 1))
	end

	slot5 = slot0.rtTaskPanel:Find(&quot;entrance_list/target_tpl&quot;)

	setActive(slot5:Find(&quot;Image&quot;), false)
	setText(slot5:Find(&quot;Text&quot;), i18n(&quot;world_task_view2&quot;) .. slot1:GetActiveEntrance():GetBaseMap():GetName())
end

slot0.UpdateAchievementPanel = function(slot0)
	slot1 = nowWorld()
	slot2, slot3, slot4 = slot1:CountAchievements()

	setText(slot0.rtAchievementPanel:Find(&quot;achievement_info/name/info/number&quot;), slot2 + slot3 .. &quot;/&quot; .. slot4)

	slot5, slot6 = slot1:GetFinishAchievements()
	slot7 = 0

	for slot11, slot12 in ipairs(slot5) do
		slot7 = slot7 + #slot12.star_list
	end

	slot8 = slot0.rtAchievementPanel:Find(&quot;word_list/target_tpl&quot;)

	setActive(slot8:Find(&quot;Image&quot;), true)
	setText(slot8:Find(&quot;Text&quot;), i18n(&quot;world_target_count&quot;, &quot;  &quot; .. setColorStr(tostring(slot7), COLOR_YELLOW) .. &quot;  &quot;))

	slot0.entranceIds = slot6

	setActive(slot0.btnAchieve, pg.gameset.world_target_obtain.key_value &lt;= #slot5)
end

slot0.DisplayAtlasOverall = function(slot0)
	if slot0.wsAtlasOverall then
		setActive(slot0.wsAtlasOverall.tfEntity:Find(&quot;Plane&quot;), false)
		slot0.wsAtlasOverall:ShowOrHide(true)
	end
end

slot0.HideAtlasOverall = function(slot0)
	if slot0.wsAtlasOverall then
		slot0.wsAtlasOverall:ShowOrHide(false)
	end
end

slot0.LoadAtlasOverall = function(slot0, slot1)
	slot2 = {}

	if not slot0.wsAtlasOverall then
		table.insert(slot2, function (slot0)
			uv0.wsAtlasOverall = WSAtlasOverall.New()
			slot1 = uv0.wsAtlasOverall

			slot1:Setup()

			slot1 = uv0.wsAtlasOverall

			slot1:LoadScene(function ()
				uv0.wsAtlasOverall:UpdateAtlas(nowWorld():GetAtlas())

				return uv1()
			end)
		end)
	end

	seriesAsync(slot2, function ()
		return existCall(uv0)
	end)
end

slot0.DisposeAtlasOverall = function(slot0)
	if slot0.wsAtlasOverall then
		slot0.wsAtlasOverall:Dispose()

		slot0.wsAtlasOverall = nil
	end
end

return slot0
</code></pre>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-lua.min.js"></script>
</body>
</html>