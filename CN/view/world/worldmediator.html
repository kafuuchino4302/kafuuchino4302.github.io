<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>worldmediator.lua</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
</head>
<body>
    <h1>worldmediator.lua</h1>
    <a href="index.html">返回主页</a>
    <pre><code class="language-lua">slot0 = class(&quot;WorldMediator&quot;, import(&quot;..base.ContextMediator&quot;))
slot0.OnMapOp = &quot;WorldMediator.OnMapOp&quot;
slot0.OnMapReq = &quot;WorldMediator.OnMapReq&quot;
slot0.OnOpenLayer = &quot;WorldMediator.OnOpenLayer&quot;
slot0.OnOpenScene = &quot;WorldMediator.OnOpenScene&quot;
slot0.OnChangeScene = &quot;WorldMediator.OnChangeScene&quot;
slot0.OnOpenMarkMap = &quot;WorldMediator.OnOpenMarkMap&quot;
slot0.OnTriggerTaskGo = &quot;WorldMediator.OnTriggerTaskGo&quot;
slot0.OnAutoSubmitTask = &quot;WorldMediator.OnAutoSubmitTask&quot;
slot0.OnNotificationOpenLayer = &quot;WorldMediator.OnNotificationOpenLayer&quot;
slot0.OnStart = &quot;WorldMediator.OnStart&quot;
slot0.OnStartPerform = &quot;WorldMediator.OnStartPerform&quot;
slot0.OnStartAutoSwitch = &quot;WorldMediator.OnStartAutoSwitch&quot;
slot0.OnMoveAndOpenLayer = &quot;WorldMediator.OnMoveAndOpenLayer&quot;

slot0.register = function(slot0)
	slot0:bind(uv0.OnMapOp, function (slot0, slot1)
		uv0:sendNotification(GAME.WORLD_MAP_OP, slot1)
	end)
	slot0:bind(uv0.OnMapReq, function (slot0, slot1, slot2)
		assert(uv0.fetchCallback == nil)

		uv0.fetchCallback = slot2

		uv0:sendNotification(GAME.WORLD_MAP_REQ, {
			mapId = slot1
		})
	end)
	slot0:bind(uv0.OnOpenLayer, function (slot0, slot1, slot2)
		uv0:addSubLayers(slot1, false, slot2)
	end)
	slot0:bind(uv0.OnOpenScene, function (slot0, slot1, ...)
		slot2 = {}

		if uv0.viewComponent:GetInMap() then
			table.insert(slot2, function (slot0)
				uv0.viewComponent:EaseOutMapUI(slot0)
			end)
		else
			table.insert(slot2, function (slot0)
				uv0.viewComponent:EaseOutAtlasUI(slot0)
			end)
		end

		slot3 = packEx(...)

		pg.UIMgr.GetInstance():LoadingOn()
		seriesAsync(slot2, function ()
			pg.UIMgr.GetInstance():LoadingOff()
			uv0:sendNotification(GAME.GO_SCENE, uv1, unpack(uv2, 1, uv2.len))
		end)
	end)
	slot0:bind(uv0.OnChangeScene, function (slot0, slot1, ...)
		slot2 = {}

		if uv0.viewComponent:GetInMap() then
			table.insert(slot2, function (slot0)
				uv0.viewComponent:EaseOutMapUI(slot0)
			end)
		else
			table.insert(slot2, function (slot0)
				uv0.viewComponent:EaseOutAtlasUI(slot0)
			end)
		end

		slot3 = packEx(...)

		pg.UIMgr.GetInstance():LoadingOn()
		seriesAsync(slot2, function ()
			pg.UIMgr.GetInstance():LoadingOff()
			uv0:sendNotification(GAME.CHANGE_SCENE, uv1, unpack(uv2, 1, uv2.len))
		end)
	end)
	slot0:bind(uv0.OnStart, function (slot0, slot1, slot2, slot3)
		if slot3:GetLimitDamageLevel() &lt; slot2.damageLevel then
			nowWorld():TriggerAutoFight(false)
			pg.MsgboxMgr.GetInstance():ShowMsgBox({
				hideYes = true,
				content = i18n(&quot;world_low_morale&quot;)
			})
		else
			uv0:sendNotification(GAME.BEGIN_STAGE, {
				system = SYSTEM_WORLD,
				stageId = slot1,
				hpRate = slot3:GetHP() and slot3:GetHP() / slot3:GetMaxHP() or nil
			})
		end
	end)
	slot0:bind(uv0.OnStartPerform, function (slot0, slot1, slot2)
		uv0:sendNotification(GAME.BEGIN_STAGE, {
			system = SYSTEM_PERFORM,
			stageId = slot1,
			exitCallback = slot2
		})
	end)
	slot0:bind(uv0.OnAutoSubmitTask, function (slot0, slot1)
		uv0:sendNotification(GAME.WORLD_AUTO_SUMBMIT_TASK, {
			taskId = slot1.id
		})
	end)
	slot0.viewComponent:SetPlayer(getProxy(PlayerProxy):getRawData())
end

slot0.listNotificationInterests = function(slot0)
	slot2 = WorldGuider.GetInstance()

	_.each(slot2:GetWorldGuiderNotifies(), function (slot0)
		uv0[#uv0 + 1] = slot0
	end)

	return {
		PlayerProxy.UPDATED,
		GAME.WORLD_MAP_OP_DONE,
		GAME.BEGIN_STAGE_DONE,
		GAME.WORLD_STAMINA_EXCHANGE_DONE,
		WorldInventoryMediator.OnMap,
		WorldCollectionMediator.ON_MAP,
		uv0.OnOpenMarkMap,
		GAME.WORLD_TRIGGER_TASK_DONE,
		GAME.WORLD_SUMBMIT_TASK_DONE,
		GAME.WORLD_AUTO_SUMBMIT_TASK_DONE,
		GAME.WORLD_ITEM_USE_DONE,
		GAME.WORLD_RETREAT_FLEET,
		uv0.OnTriggerTaskGo,
		GAME.WORLD_MAP_REQ_DONE,
		uv0.OnNotificationOpenLayer,
		GAME.WORLD_TRIGGER_AUTO_FIGHT,
		GAME.WORLD_TRIGGER_AUTO_SWITCH,
		uv0.OnStartAutoSwitch,
		uv0.OnMoveAndOpenLayer
	}
end

slot0.handleNotification = function(slot0, slot1)
	slot2 = slot1:getName()
	slot4 = WorldGuider.GetInstance()

	slot4:WorldGuiderNotifyHandler(slot2, slot1:getBody(), slot0.viewComponent)

	slot4 = nowWorld()

	switch(slot2, {
		[GAME.WORLD_MAP_OP_DONE] = function ()
			slot1 = uv1.viewComponent:GetCommand(uv0.mapOp.depth)

			if uv0.result ~= 0 then
				slot1:OpDone()

				if uv0.result == 130 then
					uv2.staminaMgr:Show()
				end

				return
			end

			slot2 = {}
			slot3 = nil

			uv1.viewComponent:RegistMapOp(slot0)

			if #slot0.drops &gt; 0 then
				if slot0.op == WorldConst.OpReqCatSalvage then
					slot4 = uv2:GetFleet(slot0.id):GetSalvageScoreRarity()

					if uv2.isAutoFight then
						uv2:AddAutoInfo(&quot;salvage&quot;, {
							drops = slot0.drops,
							rarity = slot4
						})
					else
						table.insert(slot2, function (slot0)
							uv0.viewComponent:DisplayAwards(uv1.drops, {
								title = &quot;commander&quot;,
								titleExtra = tostring(uv2)
							}, slot0)
						end)
					end
				elseif uv2.isAutoFight then
					uv2:AddAutoInfo(&quot;drops&quot;, slot0.drops)
				else
					table.insert(slot2, function (slot0)
						uv0.viewComponent:DisplayAwards(uv1.drops, {}, slot0)
					end)
				end
			end

			if slot0.routine then
				slot3 = function()
					uv0:routine()
				end
			else
				slot4 = slot0.op
				uv3 = WorldConst.ReqName[slot4]

				assert(uv3, &quot;invalid operation: &quot; .. slot4)

				if slot4 == WorldConst.OpReqTask then
					-- Nothing
				elseif slot4 == WorldConst.OpReqPressingMap or slot4 == WorldConst.OpReqCatSalvage then
					slot5 = slot2
					slot2 = {}

					slot3 = function()
						uv0:OpDone(uv1 .. &quot;Done&quot;, uv2, uv3)
					end
				else
					slot3 = function()
						uv0:OpDone(uv1 .. &quot;Done&quot;, uv2)
					end
				end
			end

			seriesAsync(slot2, slot3)
		end,
		[PlayerProxy.UPDATED] = function ()
			uv0.viewComponent:SetPlayer(getProxy(PlayerProxy):getRawData())
		end,
		[GAME.BEGIN_STAGE_DONE] = function ()
			uv0:sendNotification(GAME.GO_SCENE, SCENE.COMBATLOAD, uv1)
		end,
		[GAME.WORLD_STAMINA_EXCHANGE_DONE] = function ()
			if not uv0.viewComponent:GetInMap() and uv0.viewComponent.svFloatPanel:isShowing() then
				slot0:UpdateCost()
			end
		end,
		[WorldInventoryMediator.OnMap] = function ()
			uv0.viewComponent:Op(&quot;OpFocusTargetEntrance&quot;, uv1)
		end,
		[WorldCollectionMediator.ON_MAP] = function ()
			uv0.viewComponent:Op(&quot;OpFocusTargetEntrance&quot;, uv1)
		end,
		[uv0.OnOpenMarkMap] = function ()
			uv0.viewComponent:Op(&quot;OpShowMarkOverview&quot;, uv1)
		end,
		[GAME.WORLD_TRIGGER_TASK_DONE] = function ()
			pg.WorldToastMgr.GetInstance():ShowToast(uv0.task, false)
		end,
		[GAME.WORLD_SUMBMIT_TASK_DONE] = function ()
			slot0 = {}

			if #uv0.task.config.task_ed &gt; 0 then
				table.insert(slot0, function (slot0)
					pg.NewStoryMgr.GetInstance():Play(uv0.config.task_ed, slot0, true)
				end)
			end

			if uv0.drops and #uv0.drops &gt; 0 then
				if uv1.isAutoFight then
					uv1:AddAutoInfo(&quot;drops&quot;, uv0.drops)
				else
					table.insert(slot0, function (slot0)
						uv0.viewComponent:DisplayAwards(uv1.drops, {}, slot0)
					end)
				end
			end

			for slot5, slot6 in ipairs(uv0.expfleets) do
				table.insert(slot0, function (slot0)
					uv1.viewComponent:emit(BaseUI.ON_SHIP_EXP, {
						title = &quot;without word&quot;,
						oldShips = uv0.oldships,
						newShips = uv0.newships
					}, slot0)
				end)
			end

			seriesAsync(slot0, function ()
				pg.WorldToastMgr.GetInstance():ShowToast(uv0, true)
			end)
		end,
		[GAME.WORLD_AUTO_SUMBMIT_TASK_DONE] = function ()
			slot0 = {}

			if #uv0.task.config.task_ed &gt; 0 then
				table.insert(slot0, function (slot0)
					pg.NewStoryMgr.GetInstance():Play(uv0.config.task_ed, slot0, true)
				end)
			end

			if uv0.drops and #uv0.drops &gt; 0 then
				if uv1.isAutoFight then
					uv1:AddAutoInfo(&quot;drops&quot;, uv0.drops)
				else
					table.insert(slot0, function (slot0)
						uv0.viewComponent:DisplayAwards(uv1.drops, {}, slot0)
					end)
				end
			end

			for slot5, slot6 in ipairs(uv0.expfleets) do
				table.insert(slot0, function (slot0)
					uv1.viewComponent:emit(BaseUI.ON_SHIP_EXP, {
						title = &quot;without word&quot;,
						oldShips = uv0.oldships,
						newShips = uv0.newships
					}, slot0)
				end)
			end

			seriesAsync(slot0, function ()
				pg.WorldToastMgr.GetInstance():ShowToast(uv0, true)
				uv1.viewComponent:GetCommand():OpDone(&quot;OpAutoSubmitTaskDone&quot;, uv0)
			end)
		end,
		[GAME.WORLD_ITEM_USE_DONE] = function ()
			slot0 = uv0.item
			slot2 = {}

			switch(slot0:getWorldItemType(), {
				[WorldItem.UsageWorldClean] = function ()
					table.insert(uv0, function (slot0)
						pg.NewStoryMgr.GetInstance():Play(pg.gameset.world_story_recycle_item.description[1], slot0, true)
					end)
					table.insert(uv0, function (slot0)
						uv0.viewComponent:GetAllPessingAward(slot0)
					end)
				end,
				[WorldItem.UsageWorldFlag] = function ()
					table.insert(uv0, function (slot0)
						pg.NewStoryMgr.GetInstance():Play(pg.gameset.world_story_treasure_item.description[1], slot0, true)
					end)
				end,
				[WorldItem.UsageWorldBuff] = function ()
					slot0 = uv0
					slot0, slot1 = slot0:getItemWorldBuff()
					slot1 = slot1 * uv0.count

					table.insert(uv1, function (slot0)
						uv3.viewComponent:ShowSubView(&quot;GlobalBuff&quot;, {
							{
								id = uv0,
								floor = uv1,
								before = uv2:GetGlobalBuff(uv0):GetFloor()
							},
							slot0
						})
					end)
					table.insert(uv1, function (slot0)
						uv0:AddGlobalBuff(uv1, uv2)
						slot0()
					end)
				end,
				[WorldItem.UsageWorldFlag] = function ()
					slot1 = uv0

					switch(slot1:getItemFlagKey(), {
						function ()
							table.insert(uv0, function (slot0)
								if not uv0:GetActiveMap().visionFlag and uv0:IsMapVisioned(slot1.id) then
									slot1:UpdateVisionFlag(true)
								end

								slot0()
							end)
						end
					})
				end
			})

			if #uv0.drops &gt; 0 then
				if uv2.isAutoFight then
					uv2:AddAutoInfo(&quot;drops&quot;, slot1)
				else
					table.insert(slot2, function (slot0)
						uv0.viewComponent:DisplayAwards(uv1, {}, slot0)
					end)
				end
			end

			seriesAsync(slot2, function ()
			end)
		end,
		[GAME.WORLD_RETREAT_FLEET] = function ()
			uv1.viewComponent:Op(&quot;OpReqRetreat&quot;, uv0:GetFleet())
		end,
		[uv0.OnTriggerTaskGo] = function ()
			uv0.viewComponent:Op(&quot;OpTaskGoto&quot;, uv1.taskId)
		end,
		[GAME.WORLD_MAP_REQ_DONE] = function ()
			assert(uv0.fetchCallback)
			existCall(uv0.fetchCallback)

			uv0.fetchCallback = nil
		end,
		[uv0.OnNotificationOpenLayer] = function ()
			uv0:addSubLayers(uv1.context)
		end,
		[GAME.WORLD_TRIGGER_AUTO_FIGHT] = function ()
			uv0.viewComponent:UpdateAutoFightDisplay()
		end,
		[GAME.WORLD_TRIGGER_AUTO_SWITCH] = function ()
			uv0.viewComponent:UpdateAutoSwitchDisplay()
		end,
		[uv0.OnStartAutoSwitch] = function ()
			uv0.viewComponent:StartAutoSwitch()
		end,
		[uv0.OnMoveAndOpenLayer] = function ()
			uv0.viewComponent:MoveAndOpenLayer(uv1)
		end
	})
end

return slot0
</code></pre>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-lua.min.js"></script>
</body>
</html>