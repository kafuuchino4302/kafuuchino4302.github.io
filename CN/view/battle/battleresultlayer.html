<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>battleresultlayer.lua</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
</head>
<body>
    <h1>battleresultlayer.lua</h1>
    <a href="index.html">返回主页</a>
    <pre><code class="language-lua">slot0 = class(&quot;BattleResultLayer&quot;, import(&quot;..base.BaseUI&quot;))
slot0.DURATION_MOVE = 0.35
slot0.DURATION_WIN_SCALE = 0.4
slot0.CONDITIONS_FREQUENCE = 0.15
slot0.STATE_RANK_ANIMA = &quot;rankAnima&quot;
slot0.STATE_REPORT = &quot;report&quot;
slot0.STATE_REPORTED = &quot;reported&quot;
slot0.STATE_REWARD = &quot;reward&quot;
slot0.STATE_DISPLAY = &quot;display&quot;
slot0.STATE_DISPLAYED = &quot;displayed&quot;
slot0.STATE_SUB_DISPLAY = &quot;subDisplay&quot;
slot0.STATE_SUB_DISPLAYED = &quot;subDisplayed&quot;
slot0.ObjectiveList = {
	&quot;battle_result_victory&quot;,
	&quot;battle_result_undefeated&quot;,
	&quot;battle_result_sink_limit&quot;,
	&quot;battle_preCombatLayer_time_hold&quot;,
	&quot;battle_result_time_limit&quot;,
	&quot;battle_result_boss_destruct&quot;,
	&quot;battle_preCombatLayer_damage_before_end&quot;,
	&quot;battle_result_defeat_all_enemys&quot;
}

slot0.getUIName = function(slot0)
	return &quot;BattleResultUI&quot;
end

slot0.setRivalVO = function(slot0, slot1)
	slot0.rivalVO = slot1
end

slot0.setRank = function(slot0, slot1, slot2)
	slot0.player = slot1
	slot0.season = slot2

	setText(slot0._playerName, &quot;&lt;color=#FFFFFF&gt;&quot; .. slot0.player.name .. &quot;&lt;/color&gt;&lt;size=32&gt; / C O M M A N D E R&lt;/size&gt;&quot;)

	slot4, slot5 = SeasonInfo.getNextMilitaryRank(slot2.score, slot2.rank)

	setText(slot0._playerLv, SeasonInfo.getMilitaryRank(slot2.score, slot2.rank).name)
	setText(slot0._playerExpLabel, i18n(&quot;word_rankScore&quot;))

	slot0._playerExpProgress:GetComponent(typeof(Image)).fillAmount = slot2.score / slot5

	setText(slot0._playerBonusExp, &quot;+0&quot;)

	slot0.calcPlayerProgress = slot0.calcPlayerRank
end

slot0.setShips = function(slot0, slot1)
	slot0.shipVOs = slot1
end

slot0.setPlayer = function(slot0, slot1)
	slot0.player = slot1

	setText(slot0._playerName, &quot;&lt;color=#FFFFFF&gt;&quot; .. slot0.player.name .. &quot;&lt;/color&gt;&lt;size=32&gt; / C O M M A N D E R&lt;/size&gt;&quot;)
	setText(slot0._playerLv, &quot;Lv.&quot; .. slot0.player.level)

	slot0._playerExpProgress:GetComponent(typeof(Image)).fillAmount = slot0.player.exp / getConfigFromLevel1(pg.user_level, slot0.player.level).exp_interval

	if slot0.player.level == pg.user_level[#pg.user_level].level then
		slot0._playerExpProgress:GetComponent(typeof(Image)).fillAmount = 1
	end

	setText(slot0._playerBonusExp, &quot;+0&quot;)

	slot0.calcPlayerProgress = slot0.calcPlayerExp

	for slot7, slot8 in ipairs(slot0.contextData.extraBuffList) do
		if pg.benefit_buff_template[slot8].benefit_type == Chapter.OPERATION_BUFF_TYPE_EXP then
			setActive(slot0._playerExpExtra, true)
		end
	end
end

slot0.setExpBuff = function(slot0, slot1, slot2)
	slot0.expBuff = slot1
	slot0.shipBuff = slot2
end

slot0.init = function(slot0)
	slot0._grade = slot0:findTF(&quot;grade&quot;)
	slot0._levelText = slot0:findTF(&quot;chapterName/Text22&quot;, slot0._grade)
	slot0.clearFX = slot0:findTF(&quot;clear&quot;)
	slot0._main = slot0:findTF(&quot;main&quot;)
	slot0._blurConatiner = slot0:findTF(&quot;blur_container&quot;)
	slot0._bg = slot0:findTF(&quot;main/jiesuanbeijing&quot;)
	slot0._painting = slot0:findTF(&quot;painting&quot;, slot0._blurConatiner)
	slot0._failPainting = slot0:findTF(&quot;fail&quot;, slot0._painting)
	slot0._chat = slot0:findTF(&quot;chat&quot;, slot0._painting)
	slot0._leftPanel = slot0:findTF(&quot;leftPanel&quot;, slot0._main)
	slot0._expResult = slot0:findTF(&quot;expResult&quot;, slot0._leftPanel)
	slot0._expContainer = slot0:findTF(&quot;expContainer&quot;, slot0._expResult)
	slot0._extpl = slot0:getTpl(&quot;ShipCardTpl&quot;, slot0._expContainer)
	slot0._playerExp = slot0:findTF(&quot;playerExp&quot;, slot0._leftPanel)
	slot0._playerName = slot0:findTF(&quot;name_text&quot;, slot0._playerExp)
	slot0._playerLv = slot0:findTF(&quot;lv_text&quot;, slot0._playerExp)
	slot0._playerExpLabel = slot0:findTF(&quot;exp_label&quot;, slot0._playerExp)
	slot0._playerExpProgress = slot0:findTF(&quot;exp_progress&quot;, slot0._playerExp)
	slot0._playerBonusExp = slot0:findTF(&quot;exp_text&quot;, slot0._playerExp)
	slot0._playerExpExtra = slot0:findTF(&quot;operation_bonus&quot;, slot0._playerExp)
	slot0._atkBG = slot0:findTF(&quot;atkPanel&quot;, slot0._blurConatiner)
	slot0._atkPanel = slot0:findTF(&quot;atkResult&quot;, slot0._atkBG)
	slot0._atkResult = slot0:findTF(&quot;atkResult/result&quot;, slot0._atkBG)
	slot0._atkContainer = slot0:findTF(&quot;Grid&quot;, slot0._atkResult)
	slot0._atkContainerNext = slot0:findTF(&quot;Grid_next&quot;, slot0._atkResult)
	slot0._atkToggle = slot0:findTF(&quot;switchAtk&quot;, slot0._atkPanel)
	slot0._atkTpl = slot0:getTpl(&quot;resulttpl&quot;, slot0._atkResult)
	slot0._mvpFX = slot0:findTF(&quot;mvpFX&quot;, slot0._atkPanel)
	slot0._rightBottomPanel = slot0:findTF(&quot;rightBottomPanel&quot;, slot0._blurConatiner)
	slot0._confirmBtn = slot0:findTF(&quot;confirmBtn&quot;, slot0._rightBottomPanel)
	slot2 = slot0._confirmBtn

	setText(slot2:Find(&quot;Text&quot;), i18n(&quot;text_confirm&quot;))

	slot0._statisticsBtn = slot0:findTF(&quot;statisticsBtn&quot;, slot0._rightBottomPanel)
	slot0._subExpResult = slot0:findTF(&quot;subExpResult&quot;, slot0._leftPanel)
	slot0._subExpContainer = slot0:findTF(&quot;expContainer&quot;, slot0._subExpResult)
	slot0._subToggle = slot0:findTF(&quot;switchFleet&quot;, slot0._leftPanel)

	setActive(slot0._subToggle, false)

	slot0._skipBtn = slot0:findTF(&quot;skipLayer&quot;, slot0._tf)
	slot0.UIMain = pg.UIMgr.GetInstance().UIMain
	slot0.overlay = pg.UIMgr.GetInstance().OverlayMain
	slot0._conditions = slot0:findTF(&quot;main/conditions&quot;)
	slot0._conditionContainer = slot0:findTF(&quot;bg16/list&quot;, slot0._conditions)
	slot0._conditionTpl = slot0:findTF(&quot;bg16/conditionTpl&quot;, slot0._conditions)
	slot0._conditionSubTpl = slot0:findTF(&quot;bg16/conditionSubTpl&quot;, slot0._conditions)
	slot0._conditionContributeTpl = slot0:findTF(&quot;bg16/conditionContributeTpl&quot;, slot0._conditions)
	slot0._conditionBGNormal = slot0:findTF(&quot;bg16/bg_normal&quot;, slot0._conditions)
	slot0._conditionBGContribute = slot0:findTF(&quot;bg16/bg_contribute&quot;, slot0._conditions)
	slot0._cmdExp = slot0:findTF(&quot;commanderExp&quot;, slot0._leftPanel)
	slot0._cmdContainer = slot0:findTF(&quot;commander_container&quot;, slot0._cmdExp)
	slot0._cmdTpl = slot0:findTF(&quot;commander_tpl&quot;, slot0._cmdExp)

	slot0:setGradeLabel()
	SetActive(slot0._levelText, false)

	slot0._delayLeanList = {}
	slot0._ratioFitter = GetComponent(slot0._tf, typeof(AspectRatioFitter))
	slot0._ratioFitter.enabled = true
	slot0._ratioFitter.aspectRatio = pg.CameraFixMgr.GetInstance().targetRatio
	slot1 = pg.CameraFixMgr.GetInstance()
	slot0.camEventId = slot1:bind(pg.CameraFixMgr.ASPECT_RATIO_UPDATE, function (slot0, slot1)
		uv0._ratioFitter.aspectRatio = slot1
	end)
end

slot0.customsLang = function(slot0)
	setText(findTF(slot0._confirmBtn, &quot;Text&quot;), i18n(&quot;battle_result_confirm&quot;))
	setText(findTF(slot0._bg, &quot;jieuan01/tips/dianjijixu/bg20&quot;), i18n(&quot;battle_result_continue&quot;))
	setText(findTF(slot0._atkTpl, &quot;result/dmg_count_label&quot;), i18n(&quot;battle_result_dmg&quot;))
	setText(findTF(slot0._atkTpl, &quot;result/kill_count_label&quot;), i18n(&quot;battle_result_kill_count&quot;))
	setText(findTF(slot0._subToggle, &quot;on&quot;), i18n(&quot;battle_result_toggle_on&quot;))
	setText(findTF(slot0._subToggle, &quot;off&quot;), i18n(&quot;battle_result_toggle_off&quot;))
	setText(findTF(slot0._conditions, &quot;bg17&quot;), i18n(&quot;battle_result_targets&quot;))
end

slot0.setGradeLabel = function(slot0)
	slot1 = {
		&quot;d&quot;,
		&quot;c&quot;,
		&quot;b&quot;,
		&quot;a&quot;,
		&quot;s&quot;
	}
	slot2 = slot0:findTF(&quot;grade/Xyz/bg13&quot;)
	slot3 = slot0:findTF(&quot;grade/Xyz/bg14&quot;)
	slot4, slot5, slot6 = nil
	slot8 = nil
	slot9 = slot0.contextData.score &gt; 0

	setActive(slot0:findTF(&quot;jieuan01/BG/bg_victory&quot;, slot0._bg), slot9)
	setActive(slot0:findTF(&quot;jieuan01/BG/bg_fail&quot;, slot0._bg), not slot9)

	if slot9 then
		slot6 = slot1[slot7 + 1]
		slot4 = &quot;battlescore/battle_score_&quot; .. slot6 .. &quot;/letter_&quot; .. slot6
		slot5 = &quot;battlescore/battle_score_&quot; .. slot6 .. &quot;/label_&quot; .. slot6
	else
		if slot0.contextData.statistics._scoreMark == ys.Battle.BattleConst.DEAD_FLAG then
			slot6 = slot1[2]
			slot8 = &quot;flag_destroy&quot;
		else
			slot6 = slot1[1]
		end

		slot4 = &quot;battlescore/battle_score_&quot; .. slot6 .. &quot;/letter_&quot; .. slot6
		slot5 = &quot;battlescore/battle_score_&quot; .. slot6 .. &quot;/label_&quot; .. (slot8 or slot6)
	end

	LoadImageSpriteAsync(slot4, slot2, false)
	LoadImageSpriteAsync(slot5, slot3, false)

	if (slot0.contextData.system == SYSTEM_SCENARIO or slot10 == SYSTEM_ROUTINE or slot10 == SYSTEM_SUB_ROUTINE or slot10 == SYSTEM_DUEL) and (slot6 == slot1[1] or slot6 == slot1[2]) then
		slot0.failTag = true
	end
end

slot0.displayerCommanders = function(slot0, slot1)
	slot0.commanderExps = slot0.contextData.commanderExps or {}
	slot2 = getProxy(CommanderProxy)

	removeAllChildren(slot0._cmdContainer)

	slot3 = nil
	slot3 = slot1 and (slot0.commanderExps.submarineCMD or {}) or slot0.commanderExps.surfaceCMD or {}

	setActive(slot0._cmdExp, true)

	for slot7, slot8 in ipairs(slot3) do
		slot9 = slot2:getCommanderById(slot8.commander_id)
		slot10 = cloneTplTo(slot0._cmdTpl, slot0._cmdContainer)

		GetImageSpriteFromAtlasAsync(&quot;commandericon/&quot; .. slot9:getPainting(), &quot;&quot;, slot10:Find(&quot;icon/mask/pic&quot;))
		setText(slot10:Find(&quot;exp/name_text&quot;), slot9:getName())
		setText(slot10:Find(&quot;exp/lv_text&quot;), &quot;Lv.&quot; .. slot9.level)
		setText(slot10:Find(&quot;exp/exp_text&quot;), &quot;+&quot; .. slot8.exp)

		slot11 = nil
		slot10:Find(&quot;exp/exp_progress&quot;):GetComponent(typeof(Image)).fillAmount = slot9:isMaxLevel() and 1 or slot8.curExp / slot9:getNextLevelExp()
	end
end

slot0.didEnter = function(slot0)
	slot0:setStageName()
	slot0:customsLang()

	slot0._subShipResultCardList = {}
	slot0._shipResultCardList = {}
	slot1 = rtf(slot0._grade)
	slot0._gradeUpperLeftPos = slot1.localPosition
	slot1.localPosition = Vector3(0, 25, 0)

	pg.UIMgr.GetInstance():BlurPanel(slot0._tf, true, {
		lockGlobalBlur = true,
		groupName = LayerWeightConst.GROUP_COMBAT
	})

	if slot0.contextData.system ~= SYSTEM_BOSS_RUSH and slot0.contextData.system ~= SYSTEM_BOSS_RUSH_EX and slot0.contextData.system ~= SYSTEM_ACT_BOSS and slot0.contextData.system ~= SYSTEM_BOSS_SINGLE and slot0.contextData.system ~= SYSTEM_BOSS_SINGLE_VARIABLE then
		ys.Battle.BattleCameraUtil.GetInstance().ActiveMainCamera(false)
	end

	slot0._grade.transform.localScale = Vector3(1.5, 1.5, 0)
	slot2 = LeanTween.scale(slot0._grade, Vector3(0.88, 0.88, 1), uv0.DURATION_WIN_SCALE)

	slot2:setOnComplete(System.Action(function ()
		SetActive(uv0._levelText, true)
		uv0:rankAnimaFinish()
	end))

	slot2 = slot0._tf
	slot2:GetComponent(typeof(Image)).color = Color.New(0, 0, 0, 0.5)

	SetActive(slot0._atkBG, false)
	onToggle(slot0, slot0._subToggle, function (slot0)
		SetActive(uv0._subExpResult, not slot0)
		SetActive(uv0._expResult, slot0)
		setActive(uv0:findTF(&quot;off&quot;, uv0._subToggle), not slot0)
		uv0:displayerCommanders(not slot0)
	end, SFX_PANEL)

	slot0._stateFlag = uv0.STATE_RANK_ANIMA

	onButton(slot0, slot0._skipBtn, function ()
		uv0:skip()
	end, SFX_CONFIRM)
end

slot0.setStageName = function(slot0)
	if slot0.contextData.system and slot0.contextData.system == SYSTEM_DUEL then
		if slot0.rivalVO then
			setText(slot0._levelText, slot0.rivalVO.name)
		else
			setText(slot0._levelText, &quot;&quot;)
		end
	else
		setText(slot0._levelText, pg.expedition_data_template[slot0.contextData.stageId].name)
	end
end

slot0.rankAnimaFinish = function(slot0)
	SetActive(slot0:findTF(&quot;main/conditions&quot;), true)

	slot3 = pg.expedition_data_template[slot0.contextData.stageId]

	slot4 = function(slot0)
		if type(slot0) == &quot;table&quot; then
			uv1:setCondition(i18n(uv0.ObjectiveList[slot0[1]], slot0[2]), uv0.objectiveCheck(slot0[1], uv1.contextData))
		end
	end

	slot4(slot3.objective_1)
	slot4(slot3.objective_2)
	slot4(slot3.objective_3)
	table.insert(slot0._delayLeanList, LeanTween.delayedCall(1, System.Action(function ()
		uv0._stateFlag = uv1.STATE_REPORTED

		SetActive(uv0:findTF(&quot;jieuan01/tips&quot;, uv0._bg), true)

		if uv0.skipFlag then
			uv0:skip()
		end
	end)).id)

	slot0._stateFlag = uv0.STATE_REPORT
end

slot0.objectiveCheck = function(slot0, slot1)
	if slot0 == 1 or slot0 == 4 or slot0 == 8 then
		return slot1.score &gt; 1
	elseif slot0 == 2 or slot0 == 3 then
		return not slot1.statistics._deadUnit
	elseif slot0 == 6 then
		return slot1.statistics._boss_destruct &lt; 1
	elseif slot0 == 5 then
		return not slot1.statistics._badTime
	elseif slot0 == 7 then
		return true
	end
end

slot0.setCondition = function(slot0, slot1, slot2)
	slot3 = cloneTplTo(slot0._conditionTpl, slot0._conditionContainer)

	setActive(slot3, false)

	slot4 = nil
	slot5 = slot3:Find(&quot;text&quot;):GetComponent(typeof(Text))

	if slot2 == nil then
		slot4 = &quot;resources/condition_check&quot;
		slot5.text = setColorStr(slot1, &quot;#FFFFFFFF&quot;)
	elseif slot2 == true then
		slot4 = &quot;resources/condition_done&quot;
		slot5.text = setColorStr(slot1, &quot;#FFFFFFFF&quot;)
	else
		slot4 = &quot;resources/condition_fail&quot;
		slot5.text = setColorStr(slot1, &quot;#FFFFFF80&quot;)
	end

	slot0:setSpriteTo(slot4, slot3:Find(&quot;checkBox&quot;), true)

	if slot0._conditionContainer.childCount - 1 &gt; 0 then
		table.insert(slot0._delayLeanList, LeanTween.delayedCall(uv0.CONDITIONS_FREQUENCE * slot6, System.Action(function ()
			setActive(uv0, true)
		end)).id)
	else
		setActive(slot3, true)
	end
end

slot0.showRewardInfo = function(slot0)
	slot0._stateFlag = uv0.STATE_REWARD

	if slot0.contextData.system == SYSTEM_BOSS_RUSH or slot0.contextData.system == SYSTEM_BOSS_RUSH_EX then
		slot0:emit(BattleResultMediator.ON_BACK_TO_LEVEL_SCENE)

		return
	end

	SetActive(slot0:findTF(&quot;jieuan01/tips&quot;, slot0._bg), false)
	setParent(slot0._tf, slot0.UIMain)

	slot1 = nil
	slot1 = coroutine.create(function ()
		slot0 = uv0.contextData.drops

		if getProxy(ActivityProxy):getActivityById(ActivityConst.UTAWARERU_ACTIVITY_PT_ID) and not slot2:isEnd() then
			slot3 = slot2:getConfig(&quot;config_client&quot;).pt_id

			if _.detect(slot1:getActivitiesByType(ActivityConst.ACTIVITY_TYPE_PT_RANK), function (slot0)
				return slot0:getConfig(&quot;config_id&quot;) == uv0
			end):getData1() &gt;= 1500 then
				slot4 = slot4 - 1500
				slot0 = _.filter(slot0, function (slot0)
					return slot0.type ~= DROP_TYPE_RESOURCE or slot0.id ~= uv0
				end)

				if _.detect(slot0, function (slot0)
					return slot0.type == DROP_TYPE_RESOURCE and slot0.id == uv0
				end) and slot4 &lt; slot5.count then
					slot5.count = slot5.count - slot4

					table.insert(slot0, slot5)
				end
			end
		end

		slot3 = {}

		for slot7, slot8 in ipairs(uv0.contextData.drops) do
			table.insert(slot3, slot8)
		end

		for slot7, slot8 in ipairs(uv0.contextData.extraDrops) do
			slot8.riraty = true

			table.insert(slot3, slot8)
		end

		slot4 = false

		for slot9, slot10 in ipairs(uv0.contextData.extraBuffList) do
			if pg.benefit_buff_template[slot10].benefit_type == Chapter.OPERATION_BUFF_TYPE_REWARD then
				slot4 = true

				break
			end
		end

		if table.getCount(slot0) &gt; 0 then
			slot6 = uv0.skipFlag
			slot7 = false

			if uv0.contextData.system == SYSTEM_SCENARIO then
				if getProxy(ChapterProxy):getActiveChapter(true) then
					if slot8:isLoop() then
						getProxy(ChapterProxy):AddExtendChapterDataArray(slot8.id, &quot;TotalDrops&quot;, slot3)

						slot7 = getProxy(ChapterProxy):GetChapterAutoFlag(slot8.id) == 1
					end

					slot8:writeDrops(slot3)
				end
			elseif uv0.contextData.system == SYSTEM_ACT_BOSS then
				if getProxy(ContextProxy):getCurrentContext():getContextByMediator(ContinuousOperationMediator) then
					getProxy(ChapterProxy):AddActBossRewards(slot3)
				end
			elseif uv0.contextData.system == SYSTEM_BOSS_SINGLE then
				if getProxy(ContextProxy):getCurrentContext():getContextByMediator(BossSingleContinuousOperationMediator) then
					getProxy(ChapterProxy):AddBossSingleRewards(slot3)
				end
			elseif uv0.contextData.system == SYSTEM_BOSS_SINGLE_VARIABLE then
				-- Nothing
			end

			slot8 = uv0

			slot8:emit(BaseUI.ON_AWARD, {
				items = slot3,
				extraBonus = slot4,
				removeFunc = uv1,
				closeOnCompleted = slot6
			})
			coroutine.yield()

			slot9 = getProxy(BayProxy)
			slot10 = slot9:getNewShip(true)

			for slot14 = math.max(1, #slot10 - #_.filter(slot3, function (slot0)
				return slot0.type == DROP_TYPE_SHIP
			end) + 1), #slot10 do
				slot15 = slot10[slot14]

				if PlayerPrefs.GetInt(DISPLAY_SHIP_GET_EFFECT) == 1 or slot15.virgin or ShipRarity.Purple &lt;= slot15:getRarity() then
					uv0:emit(BattleResultMediator.GET_NEW_SHIP, slot15, uv1, slot7 and not slot15.virgin and 3 or nil)
					coroutine.yield()
				end
			end
		end

		setParent(uv0._tf, uv0.overlay)
		uv0:displayBG()
	end)

	(function ()
		if uv0 and coroutine.status(uv0) == &quot;suspended&quot; then
			slot0, slot1 = coroutine.resume(uv0)

			assert(slot0, slot1)
		end
	end)()
end

slot0.displayBG = function(slot0)
	slot1 = function()
		uv0:displayShips()
		uv0:displayPlayerInfo()
		uv0:displayerCommanders()
		uv0:initMetaBtn()

		uv0._stateFlag = uv1.STATE_DISPLAY

		if uv0.skipFlag then
			uv0:skip()
		end
	end

	LeanTween.moveX(rtf(slot0._conditions), 1300, uv0.DURATION_MOVE)
	LeanTween.scale(slot0._grade, Vector3(0.6, 0.6, 0), uv0.DURATION_MOVE)
	LeanTween.moveLocal(go(rtf(slot0._grade)), slot0._gradeUpperLeftPos, uv0.DURATION_MOVE)
	setActive(slot0:findTF(&quot;jieuan01/Bomb&quot;, slot0._bg), false)
	onDelayTick(function ()
		setLocalScale(uv0._grade, Vector3(0.6, 0.6, 0))
		setAnchoredPosition(uv0._grade, uv0._gradeUpperLeftPos)
		uv1()
	end, uv0.DURATION_MOVE)
end

slot0.displayPlayerInfo = function(slot0)
	slot1 = slot0:calcPlayerProgress()

	SetActive(slot0._leftPanel, true)
	SetActive(slot0._playerExp, true)

	slot2 = slot0._main
	slot2:GetComponent(&quot;Animator&quot;).enabled = true
	slot2 = LeanTween.moveX(rtf(slot0._leftPanel), 0, 0.5)

	table.insert(slot0._delayLeanList, slot2:setOnComplete(System.Action(function ()
		slot0 = LeanTween.value(go(uv0._tf), 0, uv1, 1)

		table.insert(uv0._delayLeanList, slot0:setOnUpdate(System.Action_float(function (slot0)
			setText(uv0._playerBonusExp, &quot;+&quot; .. math.floor(slot0))
		end)).id)
	end)).id)
end

slot0.calcPlayerExp = function(slot0)
	slot1 = slot0.contextData.oldPlayer
	slot2 = slot1.level
	slot3 = slot0.player.level
	slot4 = slot0.player.exp - slot1.exp

	while slot2 &lt; slot3 do
		slot4 = slot4 + pg.user_level[slot2].exp
		slot2 = slot2 + 1
	end

	if slot2 == pg.user_level[#pg.user_level].level then
		slot4 = 0
	end

	return slot4
end

slot0.calcPlayerRank = function(slot0)
	slot1 = slot0.contextData.oldRank
	slot2 = slot1.score

	return slot0.season.score - slot1.score
end

slot0.displayShips = function(slot0)
	slot1 = {}

	for slot6, slot7 in ipairs(slot0.shipVOs) do
		slot1[slot7.id] = slot7
	end

	slot3 = slot0.contextData.statistics

	for slot7, slot8 in ipairs(slot2) do
		if slot3[slot8.id] then
			slot3[slot8.id].vo = slot8
		end
	end

	slot4, slot5 = nil

	if slot3.mvpShipID == -1 then
		slot5 = 0

		for slot9, slot10 in ipairs(slot0.contextData.oldMainShips) do
			slot5 = math.max(slot3[slot10.id].output, slot5)
		end
	else
		slot5 = (not slot3.mvpShipID or slot3.mvpShipID == 0 or slot3[slot3.mvpShipID].output) and 0
	end

	slot0._atkFuncs = {}
	slot7, slot8 = nil

	SetActive(slot0._atkToggle, #slot0.contextData.oldMainShips &gt; 6)

	if #slot6 &gt; 6 then
		onToggle(slot0, slot0._atkToggle, function (slot0)
			SetActive(uv0._atkContainer, slot0)
			SetActive(uv0._atkContainerNext, not slot0)

			if slot0 then
				uv0:skipAtkAnima(uv0._atkContainerNext)
			else
				uv0:skipAtkAnima(uv0._atkContainer)
			end
		end, SFX_PANEL)
	end

	slot9 = {}
	slot10 = {}

	for slot14, slot15 in ipairs(slot6) do
		slot16 = slot1[slot15.id]

		if slot3[slot15.id] then
			slot18 = table.contains(TeamType.SubShipType, ys.Battle.BattleDataFunction.GetPlayerShipTmpDataFromID(slot15.configId).type)
			slot19, slot20 = nil
			slot21 = 0

			if slot14 &gt; 6 then
				slot20 = slot0._atkContainerNext
				slot21 = 7
			else
				slot20 = slot0._atkContainer
				slot21 = 1
			end

			slot19 = cloneTplTo(slot0._atkTpl, slot20)
			slot22 = slot19.localPosition
			slot22.x = slot22.x + (slot14 - slot21) * 74
			slot22.y = slot22.y + (slot14 - slot21) * -124
			slot19.localPosition = slot22
			slot23 = findTF(slot19, &quot;result/stars&quot;)
			slot24 = findTF(slot19, &quot;result/stars/star_tpl&quot;)
			slot25 = slot15:getStar()
			slot26 = slot15:getMaxStar()

			while slot26 &gt; 0 do
				SetActive(cloneTplTo(slot24, slot23):Find(&quot;empty&quot;), slot25 &lt; slot26)
				SetActive(slot27:Find(&quot;star&quot;), slot26 &lt;= slot25)

				slot26 = slot26 - 1
			end

			slot0:findTF(&quot;result/mask/icon&quot;, slot19):GetComponent(typeof(Image)).sprite = LoadSprite(&quot;herohrzicon/&quot; .. slot15:getPainting())

			setImageSprite(slot0:findTF(&quot;result/type&quot;, slot19), GetSpriteFromAtlas(&quot;shiptype&quot;, shipType2print(slot15:getShipType())), true)
			slot0:setAtkAnima(slot19, slot20, slot3[slot15.id].output / slot5, slot5, slot4 and slot15.id == slot4.id, slot3[slot15.id].output, slot3[slot15.id].kill_count)

			slot31 = nil
			slot32 = false

			if slot4 and slot15.id == slot4.id then
				slot32 = true
				slot0.mvpShipVO = slot15
				slot33, slot34, slot35 = nil

				if slot0.contextData.score &gt; 1 then
					slot33, slot35, slot34 = ShipWordHelper.GetWordAndCV(slot0.mvpShipVO.skinId, ShipWordHelper.WORD_TYPE_MVP, nil, , slot0.mvpShipVO:getCVIntimacy())
				else
					slot33, slot35, slot34 = ShipWordHelper.GetWordAndCV(slot0.mvpShipVO.skinId, ShipWordHelper.WORD_TYPE_LOSE)
				end

				if slot35 then
					slot0:stopVoice()

					slot36 = pg.CriMgr.GetInstance()

					slot36:PlaySoundEffect_V3(slot35, function (slot0)
						uv0._currentVoice = slot0
					end)
				end
			end

			if slot15.id == slot3._flagShipID then
				slot0.flagShipVO = slot15
			end

			slot33 = nil

			if slot0.expBuff or slot0.shipBuff and slot0.shipBuff[slot15:getGroupId()] then
				slot33 = slot0.expBuff and slot0.expBuff:getConfig(&quot;name&quot;) or slot34 and i18n(&quot;Word_Ship_Exp_Buff&quot;)
			end

			slot36 = nil

			if not slot18 then
				table.insert(slot0._shipResultCardList, BattleResultShipCard.New(cloneTplTo(slot0._extpl, slot0._expContainer)))

				if slot8 then
					slot8:ConfigCallback(function ()
						uv0:Play()
					end)
				else
					slot36:Play()
				end

				slot8 = slot36
			else
				table.insert(slot0._subShipResultCardList, BattleResultShipCard.New(cloneTplTo(slot0._extpl, slot0._subExpContainer)))

				if not slot7 then
					slot0._subFirstExpCard = slot36
				else
					slot7:ConfigCallback(function ()
						uv0:Play()
					end)
				end

				slot7 = slot36
			end

			slot36:SetShipVO(slot15, slot16, slot32, slot33)
		end
	end

	if slot8 then
		slot8:ConfigCallback(function ()
			uv0._stateFlag = uv1.STATE_DISPLAYED

			if not uv0._subFirstExpCard then
				uv0:skip()
			end
		end)
	end

	if slot7 then
		slot7:ConfigCallback(function ()
			uv0._stateFlag = uv1.STATE_SUB_DISPLAYED

			uv0:skip()
		end)
	end
end

slot0.stopVoice = function(slot0)
	if slot0._currentVoice then
		slot0._currentVoice:PlaybackStop()

		slot0._currentVoice = nil
	end
end

slot0.setAtkAnima = function(slot0, slot1, slot2, slot3, slot4, slot5, slot6, slot7)
	slot12 = slot0:findTF(&quot;result&quot;, slot1):GetComponent(typeof(DftAniEvent))

	setText(slot0:findTF(&quot;result/atk&quot;, slot1), 0)
	setText(slot0:findTF(&quot;result/killCount&quot;, slot1), 0)

	slot0:findTF(&quot;result/dmg_progress/progress_bar&quot;, slot1):GetComponent(typeof(Image)).fillAmount = 0

	if slot5 then
		slot13 = slot0:findTF(&quot;result/mvpBG&quot;, slot1)

		setParent(slot0._mvpFX, slot13)

		slot0._mvpFX.localPosition = Vector3(-368.5, 0, 0)

		setActive(slot13, true)
		setActive(slot0:findTF(&quot;result/bg&quot;, slot1), false)
	end

	slot12:SetEndEvent(function (slot0)
		if uv0 then
			setActive(uv1._mvpFX, true)
		end

		slot1 = LeanTween.value(go(uv2), 0, uv3, uv3)

		slot1:setOnUpdate(System.Action_float(function (slot0)
			uv0:GetComponent(typeof(Image)).fillAmount = slot0
		end))

		if uv5 ~= 0 then
			slot1 = LeanTween.value(go(uv2), 0, uv6, uv3)

			slot1:setOnUpdate(System.Action_float(function (slot0)
				setText(uv0, math.floor(slot0))
			end))

			slot1 = LeanTween.value(go(uv2), 0, uv8, uv3)

			slot1:setOnUpdate(System.Action_float(function (slot0)
				setText(uv0, math.floor(slot0))
			end))
		end
	end)

	if slot2.childCount &gt; 1 then
		slot13 = slot0:findTF(&quot;result&quot;, slot2:GetChild(slot2.childCount - 2))
		slot14 = slot13:GetComponent(typeof(DftAniEvent))

		slot14:SetTriggerEvent(function (slot0)
			setActive(uv0, true)
		end)
	else
		setActive(slot8, true)
	end

	slot13 = function()
		uv0:GetComponent(typeof(Image)).fillAmount = uv1

		setText(uv2, uv3)
		setText(uv4, uv5)

		uv6.localPosition = Vector3(280, 46, 0)
		uv6:GetComponent(typeof(Animator)).enabled = false

		setActive(uv6, true)
		setActive(uv7._mvpFX, true)
	end

	if slot0._atkFuncs[slot2] == nil then
		slot0._atkFuncs[slot2] = {}
	end

	table.insert(slot0._atkFuncs[slot2], slot13)
end

slot0.skipAtkAnima = function(slot0, slot1)
	if slot0._atkFuncs[slot1] then
		for slot5, slot6 in ipairs(slot0._atkFuncs[slot1]) do
			slot6()
		end

		slot0._atkFuncs[slot1] = nil
	end
end

slot0.showPainting = function(slot0)
	slot1, slot2, slot3 = nil

	SetActive(slot0._painting, true)

	if slot0.contextData.score &gt; 1 then
		slot4 = slot0.mvpShipVO or slot0.flagShipVO
		slot0.paintingName = slot4:getPainting()

		setPaintingPrefabAsync(slot0._painting, slot0.paintingName, &quot;jiesuan&quot;, function ()
			if findTF(uv0._painting, &quot;fitter&quot;).childCount &gt; 0 then
				ShipExpressionHelper.SetExpression(findTF(uv0._painting, &quot;fitter&quot;):GetChild(0), uv0.paintingName, &quot;win_mvp&quot;, uv1)
			end
		end)

		slot1, slot3, slot2 = ShipWordHelper.GetWordAndCV(slot4.skinId, ShipWordHelper.WORD_TYPE_MVP, nil, , slot4:getCVIntimacy())

		SetActive(slot0._failPainting, false)
	else
		slot4 = slot0.contextData.oldMainShips
		slot1, slot3, slot2 = ShipWordHelper.GetWordAndCV(slot4[math.random(#slot4)].skinId, ShipWordHelper.WORD_TYPE_LOSE)
	end

	setText(slot0._chat:Find(&quot;Text&quot;), slot2)

	if CHAT_POP_STR_LEN &lt; #slot0._chat:Find(&quot;Text&quot;):GetComponent(typeof(Text)).text then
		slot4.alignment = TextAnchor.MiddleLeft
	else
		slot4.alignment = TextAnchor.MiddleCenter
	end

	SetActive(slot0._chat, true)

	slot0._chat.transform.localScale = Vector3.New(0, 0, 0)

	LeanTween.cancel(go(slot0._painting))

	slot5 = LeanTween.moveX(rtf(slot0._painting), 50, 0.25)

	slot5:setOnComplete(System.Action(function ()
		slot0 = LeanTween.scale(rtf(uv0._chat.gameObject), Vector3.New(1, 1, 1), 0.3)
		slot0 = slot0:setEase(LeanTweenType.easeOutBack)

		slot0:setOnComplete(System.Action(function ()
			uv0._statisticsBtn:GetComponent(&quot;Button&quot;).enabled = true
			uv0._confirmBtn:GetComponent(&quot;Button&quot;).enabled = true
			uv0._atkBG:GetComponent(&quot;Button&quot;).enabled = true
		end))
	end))
end

slot0.hidePainting = function(slot0)
	SetActive(slot0._chat, false)

	slot0._chat.transform.localScale = Vector3.New(0, 0, 0)

	LeanTween.cancel(go(slot0._painting))

	slot1 = LeanTween.scale(rtf(slot0._chat.gameObject), Vector3.New(0, 0, 0), 0.1)

	slot1:setEase(LeanTweenType.easeOutBack)

	slot1 = LeanTween.moveX(rtf(slot0._painting), 720, 0.2)

	slot1:setOnComplete(System.Action(function ()
		SetActive(uv0._painting, false)
	end))
end

slot0.skip = function(slot0)
	for slot4, slot5 in ipairs(slot0._delayLeanList) do
		LeanTween.cancel(slot5)
	end

	if slot0._stateFlag == uv0.STATE_RANK_ANIMA then
		-- Nothing
	elseif slot0._stateFlag == uv0.STATE_REPORT then
		slot1 = slot0._conditionContainer.childCount

		while slot1 &gt; 0 do
			SetActive(slot0._conditionContainer:GetChild(slot1 - 1), true)

			slot1 = slot1 - 1
		end

		SetActive(slot0:findTF(&quot;jieuan01/tips&quot;, slot0._bg), true)

		slot0._stateFlag = uv0.STATE_REPORTED

		slot0:skip()
	elseif slot0._stateFlag == uv0.STATE_REPORTED then
		slot0:showRewardInfo()
	elseif slot0._stateFlag == uv0.STATE_REWARD then
		-- Nothing
	elseif slot0._stateFlag == uv0.STATE_DISPLAY then
		for slot4, slot5 in ipairs(slot0._shipResultCardList) do
			slot5:SkipAnimation()
		end

		slot0._stateFlag = uv0.STATE_DISPLAYED

		setText(slot0._playerBonusExp, &quot;+&quot; .. slot0:calcPlayerProgress())

		if not slot0._subFirstExpCard then
			slot0:playSubExEnter()
		elseif slot0.skipFlag then
			slot0:skip()
		end
	elseif slot0._stateFlag == uv0.STATE_DISPLAYED then
		setText(slot0._playerBonusExp, &quot;+&quot; .. slot0:calcPlayerProgress())
		slot0:playSubExEnter()
	elseif slot0._stateFlag == uv0.STATE_SUB_DISPLAY then
		for slot4, slot5 in ipairs(slot0._subShipResultCardList) do
			slot5:SkipAnimation()
		end

		slot0._stateFlag = uv0.STATE_SUB_DISPLAYED

		if slot0.skipFlag then
			slot0:skip()
		end
	elseif slot0._stateFlag == uv0.STATE_SUB_DISPLAYED then
		slot0:showRightBottomPanel()
	end
end

slot0.playSubExEnter = function(slot0)
	slot0._stateFlag = uv0.STATE_SUB_DISPLAY

	if slot0._subFirstExpCard then
		triggerToggle(slot0._subToggle, false)
		slot0._subFirstExpCard:Play()
	else
		slot0:showRightBottomPanel()
	end

	if slot0.skipFlag then
		slot0:skip()
	end
end

slot0.showRightBottomPanel = function(slot0)
	SetActive(slot0._skipBtn, false)
	SetActive(slot0._rightBottomPanel, true)
	SetActive(slot0._subToggle, slot0._subFirstExpCard ~= nil)
	onButton(slot0, slot0._statisticsBtn, function ()
		if uv0._atkBG.gameObject.activeSelf then
			uv0:closeStatistics()
		else
			uv0:showStatistics()
		end
	end, SFX_PANEL)
	onButton(slot0, slot0._confirmBtn, function ()
		if uv0.failTag == true then
			uv0:emit(BattleResultMediator.PRE_BATTLE_FAIL_EXIT)
			uv0:emit(BattleResultMediator.OPEN_FAIL_TIP_LAYER)
		else
			uv0:emit(BattleResultMediator.ON_BACK_TO_LEVEL_SCENE)
		end
	end, SFX_CONFIRM)
	onButton(slot0, slot0._atkBG, function ()
		uv0:closeStatistics()
	end, SFX_CANCEL)

	slot0._stateFlag = nil
	slot0._subFirstExpCard = nil

	if slot0.skipFlag then
		triggerButton(slot0._confirmBtn)
	end
end

slot0.showStatistics = function(slot0)
	setActive(slot0._leftPanel, false)
	slot0:enabledStatisticsGizmos(false)
	SetActive(slot0._atkBG, true)

	slot1 = slot0._atkBG
	slot1:GetComponent(&quot;Button&quot;).enabled = false
	slot1 = slot0._confirmBtn
	slot1:GetComponent(&quot;Button&quot;).enabled = false
	slot1 = slot0._statisticsBtn
	slot1:GetComponent(&quot;Button&quot;).enabled = false

	slot0:showPainting()

	slot1 = LeanTween.moveX(rtf(slot0._atkPanel), 0, 0.25)

	slot1:setOnComplete(System.Action(function ()
		SetActive(uv0._atkContainer, true)
	end))
end

slot0.closeStatistics = function(slot0)
	setActive(slot0._leftPanel, true)
	slot0:skipAtkAnima(slot0._atkContainerNext)
	slot0:skipAtkAnima(slot0._atkContainer)
	slot0:enabledStatisticsGizmos(true)
	slot0:hidePainting()

	slot1 = slot0._atkBG
	slot1:GetComponent(&quot;Button&quot;).enabled = false

	LeanTween.cancel(slot0._atkPanel.gameObject)

	slot1 = LeanTween.moveX(rtf(slot0._atkPanel), -700, 0.2)

	slot1:setOnComplete(System.Action(function ()
		SetActive(uv0._atkBG, false)
	end))
end

slot0.enabledStatisticsGizmos = function(slot0, slot1)
	setActive(slot0:findTF(&quot;gizmos/xuxian_down&quot;, slot0._main), slot1)
	setActive(slot0:findTF(&quot;gizmos/xuxian_middle&quot;, slot0._main), slot1)
end

slot0.PlayAnimation = function(slot0, slot1, slot2, slot3, slot4, slot5, slot6)
	slot7 = LeanTween.value(slot1.gameObject, slot2, slot3, slot4)
	slot7 = slot7:setDelay(slot5)

	slot7:setOnUpdate(System.Action_float(function (slot0)
		uv0(slot0)
	end))
end

slot0.SetSkipFlag = function(slot0, slot1)
	slot0.skipFlag = slot1
end

slot0.initMetaBtn = function(slot0)
	slot0.metaBtn = slot0:findTF(&quot;MetaBtn&quot;, slot0._main)

	setActive(slot0.metaBtn, getProxy(MetaCharacterProxy):getLastMetaSkillExpInfoList() and #slot1 &gt; 0 or false)
	onButton(slot0, slot0.metaBtn, function ()
		setActive(uv0.metaBtn, false)

		if not uv0.metaExpView then
			uv0.metaExpView = BattleResultMetaExpView.New(uv0._blurConatiner, uv0.event, uv0.contextData)

			uv0.metaExpView:setData(uv1, function ()
				if uv0.metaBtn then
					setActive(uv0.metaBtn, true)
				end

				uv0.metaExpView = nil
			end)
			uv0.metaExpView:Reset()
			uv0.metaExpView:Load()
			uv0.metaExpView:ActionInvoke(&quot;Show&quot;)
			uv0.metaExpView:ActionInvoke(&quot;openPanel&quot;)
		end
	end, SFX_PANEL)
end

slot0.onBackPressed = function(slot0)
	if slot0.metaExpView then
		slot0.metaExpView:closePanel()

		slot0.metaExpView = nil

		return
	end

	if slot0._stateFlag == uv0.STATE_RANK_ANIMA then
		-- Nothing
	elseif slot0._stateFlag == uv0.STATE_REPORT then
		triggerButton(slot0._bg)
	elseif slot0._stateFlag == uv0.STATE_REPORTED then
		triggerButton(slot0._skipBtn)
	elseif slot0._stateFlag == uv0.STATE_DISPLAY then
		triggerButton(slot0._skipBtn)
	else
		triggerButton(slot0._confirmBtn)
	end
end

slot0.willExit = function(slot0)
	for slot4, slot5 in ipairs(slot0._shipResultCardList) do
		slot5:Dispose()
	end

	for slot4, slot5 in ipairs(slot0._subShipResultCardList) do
		slot5:Dispose()
	end

	slot0._atkFuncs = nil

	LeanTween.cancel(go(slot0._tf))

	if slot0._atkBG.gameObject.activeSelf then
		pg.UIMgr.GetInstance():UnblurPanel(slot0._blurConatiner, slot0._tf)
	end

	if slot0.paintingName then
		retPaintingPrefab(slot0._painting, slot0.paintingName)
	end

	if slot0._rightTimer then
		slot0._rightTimer:Stop()
	end

	pg.UIMgr.GetInstance():UnblurPanel(slot0._tf)
	slot0:stopVoice()
	getProxy(MetaCharacterProxy):clearLastMetaSkillExpInfoList()

	if slot0.metaExpView then
		slot0.metaExpView:Destroy()

		slot0.metaExpView = nil
	end

	pg.CameraFixMgr.GetInstance():disconnect(slot0.camEventId)
end

return slot0
</code></pre>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-lua.min.js"></script>
</body>
</html>