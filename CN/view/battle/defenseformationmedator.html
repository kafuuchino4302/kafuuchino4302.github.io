<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>defenseformationmedator.lua</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
</head>
<body>
    <h1>defenseformationmedator.lua</h1>
    <a href="index.html">返回主页</a>
    <pre><code class="language-lua">slot0 = class(&quot;DefenseFormationMedator&quot;, import(&quot;..base.ContextMediator&quot;))
slot0.OPEN_SHIP_INFO = &quot;DefenseFormationMedator:OPEN_SHIP_INFO&quot;
slot0.ON_CHANGE_FLEET = &quot;DefenseFormationMedator:ON_CHANGE_FLEET&quot;
slot0.CHANGE_FLEET_NAME = &quot;DefenseFormationMedator:CHANGE_FLEET_NAME&quot;
slot0.CHANGE_FLEET_SHIP = &quot;DefenseFormationMedator:CHANGE_FLEET_SHIP&quot;
slot0.REMOVE_SHIP = &quot;DefenseFormationMedator:REMOVE_SHIP&quot;
slot0.CHANGE_FLEET_FORMATION = &quot;DefenseFormationMedator:CHANGE_FLEET_FORMATION&quot;
slot0.CHANGE_FLEET_SHIPS_ORDER = &quot;DefenseFormationMedator:CHANGE_FLEET_SHIPS_ORDER&quot;
slot0.COMMIT_FLEET = &quot;DefenseFormationMedator:COMMIT_FLEET&quot;

slot0.register = function(slot0)
	slot1 = getProxy(BayProxy)
	slot0.ships = slot1:getRawData()
	slot2 = slot0.viewComponent

	slot2:setShips(slot0.ships)

	slot2 = getProxy(MilitaryExerciseProxy)
	slot4 = getProxy(FleetProxy)
	slot5 = slot4:getFleetById(1)
	slot6 = slot0.viewComponent

	slot6:SetFleet(slot2:getExerciseFleet())
	slot0:bind(uv0.OPEN_SHIP_INFO, function (slot0, slot1, slot2, slot3)
		uv0.contextData.number = slot2.id
		uv0.contextData.toggle = slot3
		slot4 = {}

		for slot8, slot9 in ipairs(slot2:getShipIds()) do
			table.insert(slot4, uv0.ships[slot9])
		end

		uv0:sendNotification(GAME.GO_SCENE, SCENE.SHIPINFO, {
			shipId = slot1,
			shipVOs = slot4
		})
	end)
	slot0:bind(uv0.COMMIT_FLEET, function (slot0, slot1)
		uv0:save(nil, slot1)
	end)
	slot0:bind(uv0.CHANGE_FLEET_SHIPS_ORDER, function (slot0, slot1)
		uv0:save(slot1)
		uv0:refreshView()
	end)
	slot0:bind(uv0.REMOVE_SHIP, function (slot0, slot1, slot2)
		slot2:removeShip(slot1)
		uv0:save(slot2)
		uv0:refreshView()
	end)
	slot0:bind(uv0.CHANGE_FLEET_SHIP, function (slot0, slot1, slot2)
		slot3 = slot1 and slot1.id or nil
		slot4 = uv0:getSeasonInfo()
		slot5 = slot4:getMainShipIds()
		slot6 = slot4:getVanguardShipIds()

		for slot11 = #pg.ShipFlagMgr.GetInstance():FilterShips({
			isActivityNpc = true,
			inExercise = true
		}), 1, -1 do
			if slot7[slot11] == slot3 then
				table.remove(slot7, slot11)

				break
			end
		end

		slot8, slot9 = uv1.configDockYardFunc(uv1.ships, slot5, slot6, slot3, slot2, function (slot0, slot1)
			uv0:sendNotification(GAME.UPDATE_EXERCISE_FLEET, {
				fleet = slot0,
				callback = slot1
			})

			slot0 = nil
		end)

		uv1:sendNotification(GAME.GO_SCENE, SCENE.DOCKYARD, {
			callbackQuit = true,
			selectedMax = 1,
			quitTeam = slot1 ~= nil,
			teamFilter = slot2,
			ignoredIds = slot7,
			hideTagFlags = ShipStatus.TAG_HIDE_DEFENSE,
			leftTopInfo = i18n(&quot;word_formation&quot;),
			onShip = slot9,
			onSelected = slot8
		})
	end)
end

slot0.refreshView = function(slot0, slot1)
	slot0.viewComponent:UpdateFleetView(slot1)
end

slot0.save = function(slot0, slot1, slot2)
	if slot1 then
		slot0:sendNotification(GAME.UPDATE_EXERCISE_FLEET, {
			fleet = slot1,
			callback = slot2
		})
	elseif slot2 then
		slot2()
	end
end

slot0.configDockYardFunc = function(slot0, slot1, slot2, slot3, slot4, slot5)
	return function (slot0, slot1)
		slot2 = {}

		slot3 = function(slot0)
			if not uv0 then
				for slot4, slot5 in ipairs(_.reverse(slot0)) do
					if not table.contains(uv1, slot5) then
						table.insert(uv1, 1, slot5)
					end
				end
			elseif uv0 and table.getCount(uv1) == 0 then
				for slot4, slot5 in ipairs(slot0) do
					if slot5 ~= uv0 and not table.contains(uv1, slot5) then
						table.insert(uv1, slot5)
					end
				end
			elseif uv0 then
				for slot4, slot5 in ipairs(slot0) do
					if slot5 == uv0 then
						slot0[slot4] = uv1[1]
					end
				end

				uv1 = slot0
			end
		end

		slot4 = function(slot0)
			if uv0 == TeamType.Main then
				uv1.mainShips = slot0 and uv2 or uv3
				uv1.vanguardShips = uv4
			elseif uv0 == TeamType.Vanguard then
				uv1.mainShips = uv3
				uv1.vanguardShips = slot0 and uv2 or uv4
			end

			if uv5 then
				uv5(uv1, uv6)
			end
		end

		if uv1 == TeamType.Main then
			slot3(uv2)
		elseif uv1 == TeamType.Vanguard then
			slot3(uv3)
		end

		slot5 = function()
			pg.MsgboxMgr.GetInstance():ShowMsgBox({
				content = i18n(&quot;defense_formation_tip_npc&quot;),
				onYes = function ()
					uv0(false)
				end,
				onNo = function ()
					uv0(false)
				end
			})
		end

		if #slot0 &gt; 0 then
			slot4(true)
		else
			pg.MsgboxMgr.GetInstance():ShowMsgBox({
				content = i18n(&quot;exercise_clear_fleet_tip&quot;),
				onYes = function ()
					if not getProxy(FleetProxy):getFleetById(1):ExistActNpcShip() then
						uv0(true)
					else
						uv1()
					end
				end,
				onNo = function ()
					uv0(false)
				end
			})
		end
	end, function (slot0, slot1, slot2)
		slot3 = pg.ship_data_template[slot0.configId].group_type

		slot4 = function(slot0)
			for slot4, slot5 in ipairs(slot0) do
				slot6 = pg.ship_data_template[uv0[slot5].configId].group_type

				if (not uv1 or uv1 ~= slot5 or slot6 ~= uv2) and slot6 == uv2 then
					return false
				end
			end

			return true
		end

		if uv2 == TeamType.Main then
			if not slot4(uv3) then
				return false, i18n(&quot;ship_vo_mainFleet_exist_same_ship&quot;)
			end
		elseif uv2 == TeamType.Vanguard and not slot4(uv4) then
			return false, i18n(&quot;ship_vo_vanguardFleet_exist_same_ship&quot;)
		end

		return true
	end
end

slot0.listNotificationInterests = function(slot0)
	return {
		GAME.EXERCISE_FLEET_RESET
	}
end

slot0.handleNotification = function(slot0, slot1)
	slot3 = slot1:getBody()

	if GAME.EXERCISE_FLEET_RESET == slot1:getName() then
		slot0.viewComponent:SetFleet(slot3)
		slot0.viewComponent:UpdateFleetView(true)
	end
end

return slot0
</code></pre>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-lua.min.js"></script>
</body>
</html>