<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>dorm3dshopui.lua</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
</head>
<body>
    <h1>dorm3dshopui.lua</h1>
    <a href="index.html">返回主页</a>
    <pre><code class="language-lua">slot0 = class(&quot;Dorm3dShopUI&quot;, import(&quot;view.base.BaseUI&quot;))
slot1 = pg.dorm3d_set
slot2 = pg.dorm3d_shop_template
slot3 = pg.shop_template
slot4 = pg.dorm3d_rooms
slot5 = pg.dorm3d_gift
slot6 = pg.dorm3d_furniture_template

slot0.getUIName = function(slot0)
	return &quot;Dorm3dShopUI&quot;
end

slot0.init = function(slot0)
	slot0.closeBtn = slot0:findTF(&quot;closeBtn&quot;)
	slot0.res = slot0:findTF(&quot;resourceBg/res&quot;)
	slot0.recommendationTg = slot0:findTF(&quot;left/recommendation&quot;)
	slot0.charaList = UIItemList.New(slot0:findTF(&quot;left/charaScroll/mask/list&quot;), slot0:findTF(&quot;left/charaScroll/mask/list/tpl&quot;))
	slot0.recommendationPage = slot0:findTF(&quot;pages/recommendationPage&quot;)
	slot0.charaPage = slot0:findTF(&quot;pages/charaPage&quot;)
	slot0.mask = slot0:findTF(&quot;mask&quot;)

	setText(slot0:findTF(&quot;title/Text&quot;), i18n(&quot;dorm3d_shop_title&quot;))
	setText(slot0:findTF(&quot;bannerCard/mask/content/item/soldOut&quot;, slot0.recommendationPage), i18n(&quot;dorm3d_shop_sold_out&quot;))
	setText(slot0:findTF(&quot;giftCard/soldOut&quot;, slot0.recommendationPage), i18n(&quot;dorm3d_shop_sold_out&quot;))
	setText(slot0:findTF(&quot;card1/soldOut&quot;, slot0.recommendationPage), i18n(&quot;dorm3d_shop_sold_out&quot;))
	setText(slot0:findTF(&quot;card2/soldOut&quot;, slot0.recommendationPage), i18n(&quot;dorm3d_shop_sold_out&quot;))
	setText(slot0:findTF(&quot;card3/soldOut&quot;, slot0.recommendationPage), i18n(&quot;dorm3d_shop_sold_out&quot;))
	setText(slot0:findTF(&quot;scroll/Viewport/Content/card/soldOut&quot;, slot0.charaPage), i18n(&quot;dorm3d_shop_sold_out&quot;))
	setText(slot0:findTF(&quot;switch/all/Text&quot;, slot0.charaPage), i18n(&quot;dorm3d_shop_all&quot;))
	setText(slot0:findTF(&quot;switch/gift/Text&quot;, slot0.charaPage), i18n(&quot;dorm3d_shop_gift1&quot;))
	setText(slot0:findTF(&quot;switch/furniture/Text&quot;, slot0.charaPage), i18n(&quot;dorm3d_shop_furniture&quot;))
	setText(slot0:findTF(&quot;switch/others/Text&quot;, slot0.charaPage), i18n(&quot;dorm3d_shop_others&quot;))
	setText(slot0:findTF(&quot;switch/all/selected/Text&quot;, slot0.charaPage), i18n(&quot;dorm3d_shop_all&quot;))
	setText(slot0:findTF(&quot;switch/gift/selected/Text&quot;, slot0.charaPage), i18n(&quot;dorm3d_shop_gift1&quot;))
	setText(slot0:findTF(&quot;switch/furniture/selected/Text&quot;, slot0.charaPage), i18n(&quot;dorm3d_shop_furniture&quot;))
	setText(slot0:findTF(&quot;switch/others/selected/Text&quot;, slot0.charaPage), i18n(&quot;dorm3d_shop_others&quot;))
end

slot0.didEnter = function(slot0)
	slot0:InitData()
	onButton(slot0, slot0.closeBtn, function ()
		uv0:closeView()
	end, SFX_PANEL)
	slot0:ShowResUI()
	slot0:SetPageBtns()
	triggerToggle(slot0.recommendationTg, true)
end

slot0.InitData = function(slot0)
	slot0.bannerCount = uv0.drom3d_shop_product_panel_num.key_value_int
	slot0.allCommodityCfgs = {}

	for slot4, slot5 in ipairs(uv1.all) do
		table.insert(slot0.allCommodityCfgs, uv1[slot5])
	end

	table.sort(slot0.allCommodityCfgs, function (slot0, slot1)
		if tonumber(slot0.order) ~= tonumber(slot1.order) then
			return tonumber(slot0.order) &lt; tonumber(slot1.order)
		end

		return slot1.id &lt; slot0.id
	end)

	slot0.roomCfgs = {}

	_.each(uv2.all, function (slot0)
		if uv0[slot0].type == 2 then
			table.insert(uv1.roomCfgs, uv0[slot0])
		end
	end)
	table.sort(slot0.roomCfgs, function (slot0, slot1)
		return slot0.id &lt; slot1.id
	end)

	slot0.selectedId = 0
end

slot0.SetPageBtns = function(slot0)
	SetParent(slot0.recommendationTg, slot0:findTF(&quot;left&quot;), false)
	slot0.charaList:make(function (slot0, slot1, slot2)
		if slot0 == UIItemList.EventUpdate then
			slot3 = uv0.roomCfgs[slot1 + 1]

			GetImageSpriteFromAtlasAsync(string.format(&quot;dorm3dselect/room_icon_%s&quot;, string.lower(slot3.assets_prefix)), &quot;&quot;, slot2:Find(&quot;mask/icon&quot;), false)
			setActive(slot2:Find(&quot;tip&quot;), uv1.ShouldShowSumTip(uv0:GetCommoditiesCfgByChara(slot3.character[1])))
			onToggle(uv0, slot2, function (slot0)
				if slot0 then
					uv0.selectedId = uv1.id

					uv0:SetPageBtns()
					uv0:RefreshPage()
					uv2.UpdateSumTip(uv3)
				end
			end)
		end
	end)
	slot0.charaList:align(#slot0.roomCfgs)

	slot0.showingCommoditiesIndex = {}
	slot1 = {}

	table.insertto(slot1, slot0:GetCommoditiesCfgByPanel(1, slot0.bannerCount))
	table.insertto(slot1, slot0:GetCommoditiesCfgByPanel(2, 1))
	table.insertto(slot1, slot0:GetCommoditiesCfgByPanel(3, 1))
	table.insertto(slot1, slot0:GetCommoditiesCfgByPanel(4, 1))
	table.insertto(slot1, slot0:GetCommoditiesCfgByPanel(5, 1))
	setActive(slot0:findTF(&quot;icon/tip&quot;, slot0.recommendationTg), uv0.ShouldShowSumTip(slot1))
	onToggle(slot0, slot0.recommendationTg, function (slot0)
		if slot0 then
			uv0.selectedId = 0

			uv0:SetPageBtns()
			uv0:RefreshPage()
			uv1.UpdateSumTip(uv2)
		end
	end)
	SetParent(slot0.recommendationTg, slot0:findTF(&quot;left/charaScroll/mask/list&quot;), false)
	slot0.recommendationTg:SetSiblingIndex(0)
end

slot0.GetCommoditiesCfgByPanel = function(slot0, slot1, slot2)
	slot3 = {}
	slot4 = 0

	for slot8, slot9 in ipairs(slot0.allCommodityCfgs) do
		if not table.contains(slot0.showingCommoditiesIndex, slot8) and table.contains(slot9.panel, slot1) then
			if not (slot0:IsCommodityOutOfDate(slot9) or slot0:IsCommoditySoldOut(slot9)) then
				slot4 = slot4 + 1

				table.insert(slot3, slot9)
				table.insert(slot0.showingCommoditiesIndex, slot8)
			end

			if slot4 == slot2 then
				break
			end
		end
	end

	if slot4 &lt; slot2 then
		for slot8, slot9 in ipairs(slot0.allCommodityCfgs) do
			if not table.contains(slot0.showingCommoditiesIndex, slot8) and table.contains(slot9.panel, slot1) then
				if not slot0:IsCommodityOutOfDate(slot9) then
					slot4 = slot4 + 1

					table.insert(slot3, slot9)
					table.insert(slot0.showingCommoditiesIndex, slot8)
				end

				if slot4 == slot2 then
					break
				end
			end
		end
	end

	return slot3
end

slot0.GetCommoditiesCfgByChara = function(slot0, slot1)
	slot2 = {}
	slot3 = {}

	for slot7, slot8 in ipairs(slot0.allCommodityCfgs) do
		if slot8.room_id == slot1 or slot8.room_id == 0 then
			slot10 = slot0:IsCommoditySoldOut(slot8)

			if not slot0:IsCommodityOutOfDate(slot8) then
				if not slot10 then
					table.insert(slot2, slot8)
				else
					table.insert(slot3, slot8)
				end
			end
		end
	end

	if #slot3 &gt; 0 then
		table.insertto(slot2, slot3)
	end

	return slot2
end

slot0.IsCommodityOutOfDate = function(slot0, slot1)
	for slot6, slot7 in ipairs(slot1.shop_id) do
		if not pg.TimeMgr.GetInstance():inTime(uv0[slot7].time) then
			return true
		end
	end

	return false
end

slot0.IsCommoditySoldOut = function(slot0, slot1)
	if slot1.type == 1 then
		if getProxy(ApartmentProxy):GetFurnitureShopCount(slot1.item_id) &gt; 0 then
			return true
		end
	elseif slot1.type == 2 then
		return not Dorm3dGift.New({
			configId = slot1.item_id
		}):CheckBuyLimit()
	elseif slot1.type == 3 then
		return getProxy(ApartmentProxy):getRoom(slot1.item_id) and slot2.unlockCharacter[slot1.room_id]
	end

	return false
end

slot0.ShowResUI = function(slot0)
	slot1 = getProxy(PlayerProxy)
	slot2 = slot0:findTF(&quot;gold/max&quot;, slot0.res)
	slot0.goldMax = slot2:GetComponent(typeof(Text))
	slot2 = slot0:findTF(&quot;gold/Text&quot;, slot0.res)
	slot0.goldValue = slot2:GetComponent(typeof(Text))
	slot2 = slot0:findTF(&quot;oil/max&quot;, slot0.res)
	slot0.oilMax = slot2:GetComponent(typeof(Text))
	slot2 = slot0:findTF(&quot;oil/Text&quot;, slot0.res)
	slot0.oilValue = slot2:GetComponent(typeof(Text))
	slot2 = slot0:findTF(&quot;gem/Text&quot;, slot0.res)
	slot0.gemValue = slot2:GetComponent(typeof(Text))

	PlayerResUI.StaticFlush(slot1:getRawData(), slot0.goldMax, slot0.goldValue, slot0.oilMax, slot0.oilValue, slot0.gemValue)
	onButton(slot0, slot0:findTF(&quot;gold&quot;, slot0.res), function ()
		pg.playerResUI:ClickGold()
	end, SFX_PANEL)
	onButton(slot0, slot0:findTF(&quot;oil&quot;, slot0.res), function ()
		pg.playerResUI:ClickOil()
	end, SFX_PANEL)
	onButton(slot0, slot0:findTF(&quot;gem&quot;, slot0.res), function ()
		pg.playerResUI:ClickGem()
	end, SFX_PANEL)
end

slot0.RefreshPage = function(slot0)
	slot0.showingCommoditiesIndex = {}

	setActive(slot0.recommendationPage, slot0.selectedId == 0)
	setActive(slot0.charaPage, slot0.selectedId ~= 0)

	if slot0.selectedId == 0 then
		slot0:SetBannnerCard()
		slot0:SetGiftCard()
		slot0:SetNormalCard()
	else
		slot0:SetCharaCard()
	end
end

slot0.SetBannnerCard = function(slot0)
	slot1 = slot0:findTF(&quot;bannerCard&quot;, slot0.recommendationPage)
	slot2 = slot0:GetCommoditiesCfgByPanel(1, slot0.bannerCount)

	if not slot0.scrollSnap then
		slot0.scrollSnap = BannerScrollRectDorm3dShop.New(slot0:findTF(&quot;mask/content&quot;, slot1), slot0:findTF(&quot;dots&quot;, slot1))
	end

	for slot6, slot7 in ipairs(slot2) do
		slot8 = slot0.scrollSnap:GetItemChild(slot6) or slot0.scrollSnap:AddChild()
		slot9 = slot0:IsCommoditySoldOut(slot7)
		slot10 = false
		slot11 = false
		slot12 = {}
		slot13 = 0
		slot14 = &quot;&quot;
		slot15 = &quot;&quot;
		slot16 = uv0[slot7.shop_id[1]].group_type == 2 and i18n(&quot;dorm3d_shop_limit1&quot;) or i18n(&quot;dorm3d_shop_limit&quot;)

		if slot7.type == 1 then
			slot10 = not (uv1[slot7.item_id].is_special == 1) and slot17.is_exclusive == 1
			slot14 = Drop.New({
				count = 0,
				type = DROP_TYPE_DORM3D_FURNITURE,
				id = slot17.id
			}):getIcon()
			slot15 = slot16 .. &quot; &quot; .. getProxy(ApartmentProxy):GetFurnitureShopCount(slot7.item_id) .. &quot;/1&quot;
			slot12 = slot17.unlock_tips or {}
			slot13 = slot7.shop_id[1]
		elseif slot7.type == 2 then
			slot17 = uv2[slot7.item_id]
			slot10 = slot7.room_id ~= 0
			slot18 = Dorm3dGift.New({
				configId = slot7.item_id
			})
			slot14 = Drop.New({
				type = DROP_TYPE_DORM3D_GIFT,
				id = slot7.item_id,
				count = getProxy(ApartmentProxy):getGiftCount(slot7.item_id)
			}):getIcon()
			slot20 = 0

			for slot24 = 1, #slot7.shop_id do
				if not uv0[slot7.shop_id[slot24]].limit_args[1] and slot26.group_type == 0 then
					slot20 = 0
				elseif slot27 and (slot27[1] == &quot;dailycount&quot; or slot27[1] == &quot;count&quot;) then
					slot20 = slot27[3]
				elseif slot26.group_type == 2 then
					slot20 = slot26.group_limit
				end
			end

			slot15 = slot16 .. &quot; &quot; .. getProxy(ApartmentProxy):GetGiftShopCount(slot7.item_id) .. &quot;/&quot; .. slot20

			setText(slot0:findTF(&quot;favor/number&quot;, slot8), &quot;+&quot; .. pg.dorm3d_favor_trigger[uv2[slot7.item_id].favor_trigger_id].num)

			slot0:findTF(&quot;favor&quot;, slot8):GetComponent(typeof(CanvasGroup)).alpha = slot9 and 0.5 or 1
			slot12 = slot17.unlock_tips or {}
			slot13 = slot18:GetShopID()
		elseif slot7.type == 3 then
			slot10 = true

			for slot21, slot22 in ipairs(uv3[slot7.item_id].invite_icon) do
				if slot22[1] == slot7.room_id then
					slot14 = slot22[2]
				end
			end

			slot15 = slot16 .. &quot; &quot; .. (slot9 and 1 or 0) .. &quot;/1&quot;
			slot13 = slot7.shop_id[1]
		end

		setActive(slot0:findTF(&quot;bg/normal&quot;, slot8), not slot10 and not slot11)
		setActive(slot0:findTF(&quot;bg/zhuanshu&quot;, slot8), slot10)
		setActive(slot0:findTF(&quot;bg/tedian&quot;, slot8), slot11)
		setActive(slot0:findTF(&quot;normal&quot;, slot8), not slot10 and not slot11)
		setActive(slot0:findTF(&quot;zhuanshu&quot;, slot8), slot10)
		setActive(slot0:findTF(&quot;tedian&quot;, slot8), slot11)
		setActive(slot0:findTF(&quot;favor&quot;, slot8), slot7.type == 2)
		LoadImageSpriteAsync(&quot;dorm3dbanner/&quot; .. slot7.banners[1] .. &quot;_shopCard1&quot;, slot0:findTF(&quot;bannerMask/banner&quot;, slot8), true)
		setText(slot0:findTF(&quot;name&quot;, slot8), slot7.name)
		setActive(slot0:findTF(&quot;timeLimit&quot;, slot8), uv0[slot7.shop_id[1]].time ~= &quot;always&quot;)

		if slot17 ~= &quot;always&quot; then
			setText(slot0:findTF(&quot;timeLimit/Text&quot;, slot8), slot0:GetTimeRemain(pg.TimeMgr.GetInstance():parseTimeFromConfig(slot17[2])))
		end

		slot0:SetBubbles(UIItemList.New(slot0:findTF(&quot;bubbles/content&quot;, slot8), slot0:findTF(&quot;bubbles/content/tpl&quot;, slot8)), slot12)
		setActive(slot0:findTF(&quot;consume&quot;, slot8), not slot9)
		setActive(slot0:findTF(&quot;soldOut&quot;, slot8), slot9)

		slot19 = CommonCommodity.New({
			id = slot13
		}, Goods.TYPE_SHOPSTREET)
		slot20, slot21, slot22 = slot19:GetPrice()
		slot23 = Drop.New({
			type = DROP_TYPE_RESOURCE,
			id = slot19:GetResType(),
			count = slot20
		})

		setText(slot0:findTF(&quot;consume/Text&quot;, slot8), &quot;&lt;icon name=&quot; .. slot19:GetResIcon() .. &quot; w=0.81 h=0.81/&gt;&quot; .. slot20)
		GetImageSpriteFromAtlasAsync(slot14, &quot;&quot;, slot0:findTF(&quot;normal/Dorm3dIconTpl/icon&quot;, slot8))
		GetImageSpriteFromAtlasAsync(slot14, &quot;&quot;, slot0:findTF(&quot;zhuanshu/Dorm3dIconTpl/icon&quot;, slot8))
		GetImageSpriteFromAtlasAsync(slot14, &quot;&quot;, slot0:findTF(&quot;tedian/Dorm3dIconTpl/icon&quot;, slot8))
		setText(slot0:findTF(&quot;normal/countLimit&quot;, slot8), slot15)
		setText(slot0:findTF(&quot;zhuanshu/countLimit&quot;, slot8), slot15)
		setText(slot0:findTF(&quot;tedian/countLimit&quot;, slot8), slot15)

		slot0:findTF(&quot;normal/Dorm3dIconTpl&quot;, slot8):GetComponent(typeof(CanvasGroup)).alpha = slot9 and 0.5 or 1
		slot0:findTF(&quot;zhuanshu/Dorm3dIconTpl&quot;, slot8):GetComponent(typeof(CanvasGroup)).alpha = slot9 and 0.5 or 1
		slot0:findTF(&quot;tedian/Dorm3dIconTpl&quot;, slot8):GetComponent(typeof(CanvasGroup)).alpha = slot9 and 0.5 or 1

		if not slot9 then
			onButton(slot0, slot8, function ()
				uv0:ClickCommodity(uv1)
			end, SFX_PANEL)
		else
			onButton(slot0, slot8, function ()
				pg.TipsMgr.GetInstance():ShowTips(i18n(&quot;word_sell_out&quot;))
			end, SFX_PANEL)
		end

		setActive(slot0:findTF(&quot;new&quot;, slot8), uv4.ShouldShowCommodtyTip(slot7))
	end

	slot0.scrollSnap:SetUp()
end

slot0.SetGiftCard = function(slot0)
	slot1 = slot0:findTF(&quot;giftCard&quot;, slot0.recommendationPage)
	slot2 = slot0:GetCommoditiesCfgByPanel(2, 1)[1]
	slot3 = 0
	slot4 = slot0:IsCommoditySoldOut(slot2)
	slot5 = &quot;&quot;
	slot6 = false
	slot7 = false
	slot8 = uv0[slot2.shop_id[1]].group_type == 2 and i18n(&quot;dorm3d_shop_limit1&quot;) or i18n(&quot;dorm3d_shop_limit&quot;)

	if slot2.type == 1 then
		slot6 = not (uv1[slot2.item_id].is_special == 1) and slot9.is_exclusive == 1

		updateCustomDrop(slot0:findTF(&quot;Dorm3dIconTpl&quot;, slot1), Drop.New({
			count = 0,
			type = DROP_TYPE_DORM3D_FURNITURE,
			id = slot9.id
		}))

		slot3 = slot2.shop_id[1]
		slot5 = slot8 .. &quot; &quot; .. getProxy(ApartmentProxy):GetFurnitureShopCount(slot2.item_id) .. &quot;/1&quot;
	elseif slot2.type == 2 then
		slot9 = uv2[slot2.item_id]
		slot6 = slot2.room_id ~= 0

		setText(slot0:findTF(&quot;favor/number&quot;, slot1), &quot;+&quot; .. pg.dorm3d_favor_trigger[uv2[slot2.item_id].favor_trigger_id].num)
		updateCustomDrop(slot0:findTF(&quot;Dorm3dIconTpl&quot;, slot1), Drop.New({
			type = DROP_TYPE_DORM3D_GIFT,
			id = slot2.item_id,
			count = getProxy(ApartmentProxy):getGiftCount(slot2.item_id)
		}))

		slot3 = Dorm3dGift.New({
			configId = slot2.item_id
		}):GetShopID()
		slot12 = 0

		for slot16 = 1, #slot2.shop_id do
			if not uv0[slot2.shop_id[slot16]].limit_args[1] and slot18.group_type == 0 then
				slot12 = 0
			elseif slot19 and (slot19[1] == &quot;dailycount&quot; or slot19[1] == &quot;count&quot;) then
				slot12 = slot19[3]
			elseif slot18.group_type == 2 then
				slot12 = slot18.group_limit
			end
		end

		slot5 = slot8 .. &quot; &quot; .. getProxy(ApartmentProxy):GetGiftShopCount(slot2.item_id) .. &quot;/&quot; .. slot12
	elseif slot2.type == 3 then
		slot6 = true
		slot10 = &quot;&quot;

		for slot14, slot15 in ipairs(uv3[slot2.item_id].invite_icon) do
			if slot15[1] == slot2.room_id then
				slot10 = slot15[2]
			end
		end

		GetImageSpriteFromAtlasAsync(slot10, &quot;&quot;, slot0:findTF(&quot;Dorm3dIconTpl/icon&quot;, slot1))
		GetImageSpriteFromAtlasAsync(&quot;weaponframes&quot;, &quot;dorm3d_&quot; .. ItemRarity.Rarity2Print(slot2.rarity), slot0:findTF(&quot;Dorm3dIconTpl&quot;, slot1))

		slot5 = slot8 .. &quot; &quot; .. (slot4 and 1 or 0) .. &quot;/1&quot;
		slot3 = slot2.shop_id[1]
	end

	slot0:findTF(&quot;Dorm3dIconTpl&quot;, slot1):GetComponent(typeof(CanvasGroup)).alpha = slot4 and 0.5 or 1
	slot0:findTF(&quot;favor&quot;, slot1):GetComponent(typeof(CanvasGroup)).alpha = slot4 and 0.5 or 1

	setActive(slot0:findTF(&quot;bg/normal&quot;, slot1), not slot6 and not slot7)
	setActive(slot0:findTF(&quot;bg/zhuanshu&quot;, slot1), slot6)
	setActive(slot0:findTF(&quot;bg/tedian&quot;, slot1), slot7)
	setActive(slot0:findTF(&quot;normal&quot;, slot1), not slot6 and not slot7)
	setActive(slot0:findTF(&quot;zhuanshu&quot;, slot1), slot6)
	setActive(slot0:findTF(&quot;tedian&quot;, slot1), slot7)
	setText(slot0:findTF(&quot;normal/countLimit&quot;, slot1), slot5)
	setText(slot0:findTF(&quot;zhuanshu/countLimit&quot;, slot1), slot5)
	setText(slot0:findTF(&quot;tedian/countLimit&quot;, slot1), slot5)
	LoadImageSpriteAsync(&quot;dorm3dbanner/&quot; .. slot2.banners[1] .. &quot;_shopCard2&quot;, slot0:findTF(&quot;mask/item&quot;, slot1), true)
	setText(slot0:findTF(&quot;name&quot;, slot1), slot2.name)
	setActive(slot0:findTF(&quot;favor&quot;, slot1), slot2.type == 2)
	setActive(slot0:findTF(&quot;consume&quot;, slot1), not slot4)
	setActive(slot0:findTF(&quot;soldOut&quot;, slot1), slot4)
	setActive(slot0:findTF(&quot;timeLimit&quot;, slot1), uv0[slot2.shop_id[1]].time ~= &quot;always&quot;)

	if slot9 ~= &quot;always&quot; then
		setText(slot0:findTF(&quot;timeLimit/Text&quot;, slot1), slot0:GetTimeRemain(pg.TimeMgr.GetInstance():parseTimeFromConfig(slot9[2])))
	end

	slot10 = CommonCommodity.New({
		id = slot3
	}, Goods.TYPE_SHOPSTREET)
	slot11, slot12, slot13 = slot10:GetPrice()
	slot14 = Drop.New({
		type = DROP_TYPE_RESOURCE,
		id = slot10:GetResType(),
		count = slot11
	})

	setText(slot0:findTF(&quot;consume/Text&quot;, slot1), &quot;&lt;icon name=&quot; .. slot10:GetResIcon() .. &quot; w=0.81 h=0.81/&gt;&quot; .. slot11)

	if not slot4 then
		onButton(slot0, slot1, function ()
			uv0:ClickCommodity(uv1)
		end, SFX_PANEL)
	else
		onButton(slot0, slot1, function ()
			pg.TipsMgr.GetInstance():ShowTips(i18n(&quot;word_sell_out&quot;))
		end, SFX_PANEL)
	end

	setActive(slot0:findTF(&quot;new&quot;, slot1), uv4.ShouldShowCommodtyTip(slot2))
end

slot0.SetNormalCard = function(slot0)
	for slot4 = 1, 3 do
		slot5 = slot0:findTF(&quot;card&quot; .. slot4, slot0.recommendationPage)
		slot6 = slot0:GetCommoditiesCfgByPanel(slot4 + 2, 1)[1]
		slot7 = false
		slot8 = false
		slot9 = slot0:IsCommoditySoldOut(slot6)
		slot10 = {}
		slot11 = 0
		slot12 = &quot;&quot;
		slot13 = uv0[slot6.shop_id[1]].group_type == 2 and i18n(&quot;dorm3d_shop_limit1&quot;) or i18n(&quot;dorm3d_shop_limit&quot;)

		if slot6.type == 1 then
			slot8 = not (uv1[slot6.item_id].is_special == 1) and slot14.is_exclusive == 1
			slot12 = Drop.New({
				count = 0,
				type = DROP_TYPE_DORM3D_FURNITURE,
				id = slot14.id
			}):getIcon()

			setText(slot0:findTF(&quot;countLimit/Text&quot;, slot5), slot13 .. &quot; &quot; .. getProxy(ApartmentProxy):GetFurnitureShopCount(slot6.item_id) .. &quot;/1&quot;)

			slot10 = slot14.unlock_tips or {}
			slot11 = slot6.shop_id[1]
		elseif slot6.type == 2 then
			slot14 = uv2[slot6.item_id]
			slot8 = slot6.room_id ~= 0
			slot15 = Dorm3dGift.New({
				configId = slot6.item_id
			})
			slot12 = Drop.New({
				type = DROP_TYPE_DORM3D_GIFT,
				id = slot6.item_id,
				count = getProxy(ApartmentProxy):getGiftCount(slot6.item_id)
			}):getIcon()
			slot17 = 0

			for slot21 = 1, #slot6.shop_id do
				if not uv0[slot6.shop_id[slot21]].limit_args[1] and slot23.group_type == 0 then
					slot17 = 0
				elseif slot24 and (slot24[1] == &quot;dailycount&quot; or slot24[1] == &quot;count&quot;) then
					slot17 = slot24[3]
				elseif slot23.group_type == 2 then
					slot17 = slot23.group_limit
				end
			end

			setText(slot0:findTF(&quot;countLimit/Text&quot;, slot5), slot13 .. &quot; &quot; .. getProxy(ApartmentProxy):GetGiftShopCount(slot6.item_id) .. &quot;/&quot; .. slot17)

			slot18 = pg.dorm3d_favor_trigger[uv2[slot6.item_id].favor_trigger_id].num

			setText(slot0:findTF(&quot;normal/favor/number&quot;, slot5), &quot;+&quot; .. slot18)
			setText(slot0:findTF(&quot;zhuanshu/favor/number&quot;, slot5), &quot;+&quot; .. slot18)
			setText(slot0:findTF(&quot;tedian/favor/number&quot;, slot5), &quot;+&quot; .. slot18)

			slot10 = slot14.unlock_tips or {}
			slot11 = slot15:GetShopID()
		elseif slot6.type == 3 then
			slot8 = true

			for slot18, slot19 in ipairs(uv3[slot6.item_id].invite_icon) do
				if slot19[1] == slot6.room_id then
					slot12 = slot19[2]
				end
			end

			setText(slot0:findTF(&quot;countLimit/Text&quot;, slot5), slot13 .. &quot; &quot; .. (slot9 and 1 or 0) .. &quot;/1&quot;)

			slot11 = slot6.shop_id[1]
		end

		setActive(slot0:findTF(&quot;bg/normal&quot;, slot5), not slot8 and not slot7)
		setActive(slot0:findTF(&quot;bg/zhuanshu&quot;, slot5), slot8)
		setActive(slot0:findTF(&quot;bg/tedian&quot;, slot5), slot7)
		setActive(slot0:findTF(&quot;normal&quot;, slot5), not slot8 and not slot7)
		setActive(slot0:findTF(&quot;zhuanshu&quot;, slot5), slot8)
		setActive(slot0:findTF(&quot;tedian&quot;, slot5), slot7)
		setActive(slot0:findTF(&quot;normal/favor&quot;, slot5), slot6.type == 2)
		setActive(slot0:findTF(&quot;zhuanshu/favor&quot;, slot5), slot6.type == 2)
		setActive(slot0:findTF(&quot;tedian/favor&quot;, slot5), slot6.type == 2)
		setText(slot0:findTF(&quot;name&quot;, slot5), slot6.name)
		slot0:SetBubbles(UIItemList.New(slot0:findTF(&quot;bubbles/content&quot;, slot5), slot0:findTF(&quot;bubbles/content/tpl&quot;, slot5)), slot10)
		setActive(slot0:findTF(&quot;consume&quot;, slot5), not slot9)
		setActive(slot0:findTF(&quot;soldOut&quot;, slot5), slot9)

		slot15 = CommonCommodity.New({
			id = slot11
		}, Goods.TYPE_SHOPSTREET)
		slot16, slot17, slot18 = slot15:GetPrice()
		slot19 = Drop.New({
			type = DROP_TYPE_RESOURCE,
			id = slot15:GetResType(),
			count = slot16
		})

		setText(slot0:findTF(&quot;consume/Text&quot;, slot5), &quot;&lt;icon name=&quot; .. slot15:GetResIcon() .. &quot; w=0.81 h=0.81/&gt;&quot; .. slot16)
		GetImageSpriteFromAtlasAsync(slot12, &quot;&quot;, slot0:findTF(&quot;normal/mask/Dorm3dIconTpl/icon&quot;, slot5))
		GetImageSpriteFromAtlasAsync(slot12, &quot;&quot;, slot0:findTF(&quot;zhuanshu/mask/Dorm3dIconTpl/icon&quot;, slot5))
		GetImageSpriteFromAtlasAsync(slot12, &quot;&quot;, slot0:findTF(&quot;tedian/mask/Dorm3dIconTpl/icon&quot;, slot5))

		if not slot9 then
			onButton(slot0, slot5, function ()
				uv0:ClickCommodity(uv1)
			end, SFX_PANEL)
		else
			onButton(slot0, slot5, function ()
				pg.TipsMgr.GetInstance():ShowTips(i18n(&quot;word_sell_out&quot;))
			end, SFX_PANEL)
		end

		setActive(slot0:findTF(&quot;new&quot;, slot5), uv4.ShouldShowCommodtyTip(slot6))
	end
end

slot0.SetCharaCard = function(slot0)
	slot7 = slot0.charaPage
	slot2 = UIItemList.New(slot0:findTF(&quot;scroll/Viewport/Content&quot;, slot0.charaPage), slot0:findTF(&quot;scroll/Viewport/Content/card&quot;, slot7))
	slot3 = {}

	slot2:make(function (slot0, slot1, slot2)
		if slot0 == UIItemList.EventInit then
			slot3 = uv0[slot1 + 1]

			table.insert(uv1, {
				slot3.type,
				slot2
			})

			slot4 = uv2:IsCommoditySoldOut(slot3)
			slot5 = false
			slot6 = false
			slot7 = &quot;&quot;
			slot8 = {}
			slot9 = 0
			slot10 = uv3[slot3.shop_id[1]].group_type == 2 and i18n(&quot;dorm3d_shop_limit1&quot;) or i18n(&quot;dorm3d_shop_limit&quot;)

			if slot3.type == 1 then
				slot5 = not (uv4[slot3.item_id].is_special == 1) and slot11.is_exclusive == 1
				slot7 = Drop.New({
					count = 0,
					type = DROP_TYPE_DORM3D_FURNITURE,
					id = slot11.id
				}):getIcon()

				setText(slot2:Find(&quot;descScroll/Viewport/Content/desc&quot;), slot11.desc)
				setText(slot2:Find(&quot;countLimit&quot;), slot10 .. &quot; &quot; .. getProxy(ApartmentProxy):GetFurnitureShopCount(slot3.item_id) .. &quot;/1&quot;)

				slot8 = slot11.unlock_tips or {}
				slot9 = slot3.shop_id[1]
			elseif slot3.type == 2 then
				slot5 = slot3.room_id ~= 0
				slot12 = Dorm3dGift.New({
					configId = slot3.item_id
				})
				slot7 = Drop.New({
					type = DROP_TYPE_DORM3D_GIFT,
					id = slot3.item_id,
					count = getProxy(ApartmentProxy):getGiftCount(slot3.item_id)
				}):getIcon()

				setText(slot2:Find(&quot;descScroll/Viewport/Content/desc&quot;), uv5[slot3.item_id].display)

				slot14 = 0

				for slot18 = 1, #slot3.shop_id do
					if not uv3[slot3.shop_id[slot18]].limit_args[1] and slot20.group_type == 0 then
						slot14 = 0
					elseif slot21 and (slot21[1] == &quot;dailycount&quot; or slot21[1] == &quot;count&quot;) then
						slot14 = slot21[3]
					elseif slot20.group_type == 2 then
						slot14 = slot20.group_limit
					end
				end

				setText(slot2:Find(&quot;countLimit&quot;), slot10 .. &quot; &quot; .. getProxy(ApartmentProxy):GetGiftShopCount(slot3.item_id) .. &quot;/&quot; .. slot14)
				setText(slot2:Find(&quot;favor/number&quot;), &quot;+&quot; .. pg.dorm3d_favor_trigger[uv5[slot3.item_id].favor_trigger_id].num)

				slot8 = slot11.unlock_tips or {}
				slot9 = slot12:GetShopID()
			elseif slot3.type == 3 then
				slot5 = true

				for slot16, slot17 in ipairs(uv6[slot3.item_id].invite_icon) do
					if slot17[1] == slot3.room_id then
						slot7 = slot17[2]
					end
				end

				setText(slot2:Find(&quot;descScroll/Viewport/Content/desc&quot;), slot11.room_des)
				setText(slot2:Find(&quot;countLimit&quot;), slot10 .. &quot; &quot; .. (slot4 and 1 or 0) .. &quot;/1&quot;)

				slot9 = slot3.shop_id[1]
			end

			setActive(slot2:Find(&quot;bg/normal&quot;), not slot4)
			setActive(slot2:Find(&quot;bg/soldOut&quot;), slot4)
			setActive(slot2:Find(&quot;normal&quot;), not slot5 and not slot6)
			setActive(slot2:Find(&quot;zhuanshu&quot;), slot5)
			setActive(slot2:Find(&quot;tedian&quot;), slot6)
			GetImageSpriteFromAtlasAsync(slot7, &quot;&quot;, slot2:Find(&quot;mask/Dorm3dIconTpl/icon&quot;))
			setActive(slot2:Find(&quot;favor&quot;), slot3.type == 2)
			setText(slot2:Find(&quot;name&quot;), slot3.name)
			uv2:SetBubbles(UIItemList.New(slot2:Find(&quot;bubbles/content&quot;), slot2:Find(&quot;bubbles/content/tpl&quot;)), slot8)

			slot12 = CommonCommodity.New({
				id = slot9
			}, Goods.TYPE_SHOPSTREET)
			slot13, slot14, slot15 = slot12:GetPrice()
			slot16 = Drop.New({
				type = DROP_TYPE_RESOURCE,
				id = slot12:GetResType(),
				count = slot13
			})

			setText(slot2:Find(&quot;consume/Text&quot;), &quot;&lt;icon name=&quot; .. slot12:GetResIcon() .. &quot; w=0.81 h=0.81/&gt;&quot; .. slot13)
			setActive(slot2:Find(&quot;consume&quot;), not slot4)
			setActive(slot2:Find(&quot;soldOut&quot;), slot4)
			setActive(slot2:Find(&quot;timeLimit&quot;), uv3[slot3.shop_id[1]].time ~= &quot;always&quot;)

			if slot17 ~= &quot;always&quot; then
				setText(slot2:Find(&quot;timeLimit/Text&quot;), uv2:GetTimeRemain(pg.TimeMgr.GetInstance():parseTimeFromConfig(slot17[2])))
			end

			if not slot4 then
				onButton(uv2, slot2, function ()
					uv0:ClickCommodity(uv1)
				end, SFX_PANEL)
			else
				onButton(uv2, slot2, function ()
					pg.TipsMgr.GetInstance():ShowTips(i18n(&quot;word_sell_out&quot;))
				end, SFX_PANEL)
			end

			setActive(slot2:Find(&quot;new&quot;), uv7.ShouldShowCommodtyTip(slot3))
		end
	end)
	slot2:align(#slot0:GetCommoditiesCfgByChara(uv0[slot0.selectedId].character[1]))

	slot0.filterIndex = 1

	for slot7 = 1, 4 do
		slot8 = slot0:findTF(&quot;switch&quot;, slot0.charaPage)

		onToggle(slot0, slot8:GetChild(slot7 - 1), function (slot0)
			if slot0 then
				uv0.filterIndex = uv1

				if uv1 == 1 then
					for slot4, slot5 in ipairs(uv2) do
						setActive(slot5[2], true)
					end
				elseif uv1 == 2 then
					for slot4, slot5 in ipairs(uv2) do
						setActive(slot5[2], slot5[1] == 2)
					end
				elseif uv1 == 3 then
					for slot4, slot5 in ipairs(uv2) do
						setActive(slot5[2], slot5[1] == 1)
					end
				else
					for slot4, slot5 in ipairs(uv2) do
						setActive(slot5[2], slot5[1] == 3)
					end
				end

				for slot4 = 1, 4 do
					setActive(uv0:findTF(&quot;selected&quot;, uv0:findTF(&quot;switch&quot;, uv0.charaPage):GetChild(slot4 - 1)), slot4 == uv1)
				end
			end
		end)

		if slot7 == 1 then
			triggerToggle(slot8, true)
		end
	end
end

slot0.ClickCommodity = function(slot0, slot1)
	slot0.showCount = 1

	if slot1.room_id ~= 0 then
		slot2 = 0

		for slot6, slot7 in pairs(uv0) do
			if slot7.type == 2 and slot7.character[1] == slot1.room_id then
				slot2 = slot7.id
			end
		end

		if not getProxy(ApartmentProxy):getRoom(slot2) then
			pg.TipsMgr.GetInstance():ShowTips(i18n(&quot;dorm3d_role_locked&quot;))

			return
		end
	end

	if slot1.type == 1 then
		slot2 = Dorm3dFurniture.New({
			configId = slot1.item_id
		})
		slot3 = CommonCommodity.New({
			id = slot1.shop_id[1]
		}, Goods.TYPE_SHOPSTREET)
		slot4, slot5, slot6 = slot3:GetPrice()

		slot0:emit(Dorm3dShopMediator.SHOW_SHOPPING_CONFIRM_WINDOW, {
			content = {
				icon = &quot;&lt;icon name=&quot; .. slot3:GetResIcon() .. &quot; w=1.1 h=1.1/&gt;&quot;,
				off = slot5,
				cost = Drop.New({
					type = DROP_TYPE_RESOURCE,
					id = slot3:GetResType(),
					count = slot4
				}).count,
				old = slot6,
				name = slot1.name
			},
			tip = i18n(&quot;dorm3d_shop_gift_tip&quot;),
			drop = slot2,
			endTime = slot2:GetEndTime(),
			onYes = function ()
				if not uv0:InShopTime() then
					pg.TipsMgr.GetInstance():ShowTips(i18n(&quot;dorm3d_purchase_outtime&quot;))

					return
				end

				uv1:emit(GAME.SHOPPING, {
					silentTip = true,
					count = 1,
					shopId = uv2.shop_id[1]
				})
			end
		})

		return
	end

	if slot1.type == 2 then
		slot2 = 0

		for slot6 = 1, #slot1.shop_id do
			if not uv1[slot1.shop_id[slot6]].limit_args[1] and slot8.group_type == 0 then
				slot2 = 0
			elseif slot9 and (slot9[1] == &quot;dailycount&quot; or slot9[1] == &quot;count&quot;) then
				slot2 = slot9[3]
			elseif slot8.group_type == 2 then
				slot2 = slot8.group_limit
			end
		end

		if slot2 &gt; 1 then
			slot3 = 0

			if slot0.selectedId ~= 0 then
				slot3 = uv0[slot0.selectedId].character[1]
			end

			slot0:emit(Dorm3dShopMediator.OPEN_DETAIL, slot1, slot3, function (slot0)
				uv0.showCount = slot0
			end)
		else
			slot3 = Dorm3dGift.New({
				configId = slot1.item_id
			})
			slot4 = CommonCommodity.New({
				id = slot3:GetShopID()
			}, Goods.TYPE_SHOPSTREET)
			slot5, slot6, slot7 = slot4:GetPrice()
			slot8 = Drop.New({
				type = DROP_TYPE_RESOURCE,
				id = slot4:GetResType(),
				count = slot5
			})
			slot9 = nil

			_.each(slot3:getConfig(&quot;shop_id&quot;), function (slot0)
				if uv0[slot0].group_type == 2 then
					uv1 = math.max(slot1.group_limit, uv1)
				end
			end)

			if 0 &gt; 0 then
				slot9 = {
					getProxy(ApartmentProxy):GetGiftShopCount(slot3:GetConfigID()),
					slot10
				}
			end

			slot0:emit(Dorm3dShopMediator.SHOW_SHOPPING_CONFIRM_WINDOW, {
				content = {
					icon = &quot;&lt;icon name=&quot; .. slot4:GetResIcon() .. &quot; w=1.1 h=1.1/&gt;&quot;,
					off = slot6,
					cost = slot8.count,
					old = slot7,
					name = slot1.name,
					weekLimit = slot9
				},
				tip = i18n(&quot;dorm3d_shop_gift_tip&quot;),
				drop = slot3,
				groupId = slot1.room_id,
				onYes = function ()
					uv0:emit(GAME.SHOPPING, {
						silentTip = true,
						count = 1,
						shopId = uv1:GetShopID()
					})
				end
			})
		end
	elseif slot1.type == 3 then
		slot2 = nil

		if not getProxy(ApartmentProxy):getRoom(slot1.item_id) then
			pg.TipsMgr.GetInstance():ShowTips(i18n(&quot;dorm3d_role_locked&quot;))

			return
		end

		if not slot3.unlockCharacter[slot1.room_id] then
			slot2 = &quot;lock&quot;
		elseif not getProxy(ApartmentProxy):getApartment(slot1.room_id) then
			slot2 = &quot;room&quot;
		elseif Apartment.New({
			ship_group = slot1.room_id
		}):needDownload() then
			slot2 = &quot;download&quot;
		end

		if slot2 == &quot;lock&quot; then
			slot0:emit(Dorm3dShopMediator.OPEN_ROOM_UNLOCK_WINDOW, slot1.item_id, slot1.room_id)
		elseif slot2 == &quot;room&quot; then
			pg.TipsMgr.GetInstance():ShowTips(i18n(&quot;dorm3d_role_locked&quot;))
		elseif slot2 == &quot;download&quot; then
			pg.TipsMgr.GetInstance():ShowTips(i18n(&quot;dorm3d_guide_beach_tip&quot;))
		end
	end
end

slot0.SetBubbles = function(slot0, slot1, slot2)
	slot1:make(function (slot0, slot1, slot2)
		if slot0 == UIItemList.EventInit then
			slot4 = uv0[slot1 + 1]

			LoadImageSpriteAtlasAsync(&quot;ui/shoptip_atlas&quot;, &quot;icon_&quot; .. slot4, slot2:Find(&quot;icon/icon&quot;), true)
			setText(slot2:Find(&quot;bubble/Text&quot;), i18n(&quot;dorm3d_shop_tag&quot; .. slot4))
			setActive(slot2:Find(&quot;bubble&quot;), false)
			onToggle(uv1, slot2, function (slot0)
				setActive(uv0:Find(&quot;icon/select&quot;), slot0)
				setActive(uv0:Find(&quot;icon/unselect&quot;), not slot0)
				setActive(uv0:Find(&quot;bubble&quot;), slot0)
				setActive(uv1.mask, slot0)
				onButton(uv1, uv1.mask, function ()
					triggerToggle(uv0, false)
				end, SFX_PANEL)
			end)
		end
	end)
	slot1:align(#slot2)
end

slot0.GetTimeRemain = function(slot0, slot1)
	if math.floor(math.max(slot1 - pg.TimeMgr.GetInstance():GetServerTime(), 0) / 86400) &gt; 0 then
		return slot4 .. i18n(&quot;word_date&quot;)
	elseif math.floor(slot3 / 3600) &gt; 0 then
		return slot5 .. i18n(&quot;word_hour&quot;)
	elseif math.floor(slot3 / 60) &gt; 0 then
		return slot6 .. i18n(&quot;word_minute&quot;)
	else
		return slot3 .. i18n(&quot;word_second&quot;)
	end
end

slot0.ShouldShowCommodtyTip = function(slot0)
	if slot0.type == 1 then
		return Dorm3dFurniture.GetViewedFlag(slot0.item_id) == 0
	elseif slot0.type == 2 then
		return Dorm3dGift.GetViewedFlag(slot0.item_id) == 0 or uv0[slot0.shop_id[1]].group ~= 0 and PlayerPrefs.GetInt(getProxy(PlayerProxy):getRawData().id .. &quot;_dorm3dGiftWeekViewed_&quot; .. slot0.item_id, 0) == 0
	end

	return false
end

slot0.ShouldShowSumTip = function(slot0)
	for slot4, slot5 in ipairs(slot0) do
		if uv0.ShouldShowCommodtyTip(slot5) then
			return true
		end
	end

	return false
end

slot0.ShouldShowAllTip = function()
	slot0 = {}

	for slot4, slot5 in ipairs(uv0.all) do
		slot7 = false

		for slot12, slot13 in ipairs(uv0[slot5].shop_id) do
			if not pg.TimeMgr.GetInstance():inTime(uv1[slot13].time) then
				slot7 = true

				break
			end
		end

		if not slot7 then
			table.insert(slot0, slot6)
		end
	end

	return uv2.ShouldShowSumTip(slot0)
end

slot0.UpdateCommodtyTip = function(slot0)
	if slot0.type == 1 then
		Dorm3dFurniture.SetViewedFlag(slot0.item_id)
	elseif slot0.type == 2 then
		Dorm3dGift.SetViewedFlag(slot0.item_id)

		if uv0[slot0.shop_id[1]].group ~= 0 then
			PlayerPrefs.SetInt(getProxy(PlayerProxy):getRawData().id .. &quot;_dorm3dGiftWeekViewed_&quot; .. slot0.item_id, 1)
		end
	end
end

slot0.UpdateSumTip = function(slot0)
	for slot4, slot5 in ipairs(slot0) do
		uv0.UpdateCommodtyTip(slot5)
	end
end

slot0.willExit = function(slot0)
	slot0.scrollSnap:Dispose()

	slot0.scrollSnap = nil
end

slot0.onBackPressed = function(slot0)
	slot0:closeView()
end

return slot0
</code></pre>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-lua.min.js"></script>
</body>
</html>