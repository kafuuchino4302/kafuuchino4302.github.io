<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>dorm3dskinselectlayer.lua</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
</head>
<body>
    <h1>dorm3dskinselectlayer.lua</h1>
    <a href="index.html">返回主页</a>
    <pre><code class="language-lua">slot0 = class(&quot;Dorm3dSkinSelectLayer&quot;, import(&quot;view.base.BaseUI&quot;))

slot0.getUIName = function(slot0)
	return &quot;Dorm3dSkinSelectLayer&quot;
end

slot0.init = function(slot0)
	slot0.btnChange = slot0:findTF(&quot;BG/bottom/btn_change&quot;)
	slot0.btnBuy = slot0:findTF(&quot;BG/bottom/btn_buy&quot;)
	slot0.priceText = slot0:findTF(&quot;BG/bottom/btn_buy/Price&quot;)
	slot0.line = slot0:findTF(&quot;BG/bottom/Line&quot;)
	slot0.desc = slot0:findTF(&quot;BG/bottom/desc&quot;)
	slot0.loader = AutoLoader.New()
end

slot0.SetApartment = function(slot0, slot1)
	slot0.apartment = slot1
end

slot0.didEnter = function(slot0)
	slot2 = slot0._tf

	setText(slot2:Find(&quot;BG/Scroll/Content/Unlock/Title/Text&quot;), i18n(&quot;word_unlock&quot;))

	slot2 = slot0._tf

	setText(slot2:Find(&quot;BG/Scroll/Content/Lock/Title/Text&quot;), i18n(&quot;word_lock&quot;))

	slot3 = slot0._tf

	onButton(slot0, slot3:Find(&quot;btn_back&quot;), function ()
		uv0:closeView()
	end, SFX_CANCEL)

	slot3 = slot0._tf

	onButton(slot0, slot3:Find(&quot;BG/Close&quot;), function ()
		uv0:closeView()
	end, SFX_CANCEL)
	onButton(slot0, slot0.btnChange, function ()
		if uv0.contextData.isPublicRoom then
			pg.TipsMgr.GetInstance():ShowTips(i18n(&quot;dorm3d_skin_unlock&quot;))

			return
		end

		if uv0:IsSameSkin() then
			return
		end

		uv0:emit(Dorm3dSkinSelectMediator.CHANGE_SKIN, uv0.contextData.groupId, uv0.selectedSkinId, uv0.hiddenList)

		if not uv0.contextData.onSwitchSkin then
			uv0.contextData.ladyEnv:PlaySingleAction(pg.dorm3d_resource[uv0.selectedSkinId].wear_anim)
		end

		uv0.sortSkinId = uv0.selectedSkinId

		uv0:FlushSkinList()
	end, SFX_PANEL)

	slot4 = function()
		if uv0.skinDic[uv0.selectedSkinId]:GetType() == 2 then
			if getProxy(ApartmentProxy):getRoom(slot0:GetPublicRoomId()) then
				uv0:emit(Dorm3dSkinSelectMediator.OPEN_ROOM_UNLOCK_WINDOW, slot2, uv0.contextData.groupId)
			else
				uv0:emit(Dorm3dSkinSelectMediator.OPEN_ROOM_UNLOCK_WINDOW, slot2)
			end
		elseif slot1 == 3 then
			slot3 = CommonCommodity.New({
				id = slot0:GetShopId()
			}, Goods.TYPE_SHOPSTREET)
			slot4, slot5, slot6 = slot3:GetPrice()

			uv0:emit(Dorm3dSkinSelectMediator.OPEN_SHOP_WINDOW, {
				content = {
					icon = &quot;&lt;icon name=&quot; .. slot3:GetResIcon() .. &quot; w=1.1 h=1.1/&gt;&quot;,
					off = slot5,
					cost = Drop.New({
						type = DROP_TYPE_RESOURCE,
						id = slot3:GetResType(),
						count = slot4
					}).count,
					old = slot6,
					name = slot0:GetName()
				},
				tip = i18n(&quot;dorm3d_shop_gift_tip&quot;),
				drop = slot0,
				onYes = function ()
					uv0:emit(GAME.SHOPPING, {
						silentTip = true,
						count = 1,
						id = uv1
					})
				end
			})
		end
	end

	slot5 = SFX_PANEL

	onButton(slot0, slot0.btnBuy, slot4, slot5)

	slot0.selectedSkinId = slot0.contextData.ladyEnv.skinId
	slot0.sortSkinId = slot0.selectedSkinId
	slot0.skinDic = {}

	for slot4, slot5 in ipairs(slot0.contextData.ladyEnv.skinIdList) do
		slot0.skinDic[slot5] = Dorm3dSkin.New({
			configId = slot5
		})
	end

	slot0:FlushSkinList()
end

slot0.FlushSkinList = function(slot0)
	_.each(slot0.contextData.ladyEnv.skinIdList, function (slot0)
		if ApartmentProxy.CheckUnlockConfig(uv0.skinDic[slot0]:GetUnlock()) then
			table.insert(uv1, slot0)
		else
			table.insert(uv2, slot0)
		end
	end)

	slot4 = function(slot0, slot1)
		return (slot0 == uv0.sortSkinId and 1 or 0) &gt; (slot1 == uv0.sortSkinId and 1 or 0)
	end

	table.sort({}, slot4)
	table.sort({}, slot4)

	slot5 = function(slot0, slot1)
		UIItemList.StaticAlign(slot0, slot0:GetChild(0), #(slot1 and uv0 or uv1), function (slot0, slot1, slot2)
			if slot0 ~= UIItemList.EventUpdate then
				return
			end

			setActive(slot2:Find(&quot;Selected&quot;), uv0[slot1 + 1] == uv1.selectedSkinId)
			setActive(slot2:Find(&quot;Lock&quot;), not uv2)

			if not uv2 then
				setText(slot2:Find(&quot;Lock/Bar/Text&quot;), uv1.skinDic[slot3]:GetUnlockText())
			end

			uv1.loader:GetSpriteQuiet(string.format(&quot;dorm3dselect/apartment_skin_%d&quot;, slot3), &quot;&quot;, slot2:Find(&quot;Icon&quot;))
			onButton(uv1, slot2, function ()
				uv0:OnclickSkin(uv1, uv2)
			end, SFX_PANEL)
		end)
	end

	slot5(slot0._tf:Find(&quot;BG/Scroll/Content/Unlock/List&quot;), true)
	slot5(slot0._tf:Find(&quot;BG/Scroll/Content/Lock/List&quot;), false)
	slot0:FlushSkinPartOptions()
	slot0:FlushBtns()
end

slot0.OnclickSkin = function(slot0, slot1, slot2)
	slot4 = slot0.contextData.groupId
	slot0.selectedSkinId = slot1

	slot0:FlushBtns()
	slot0:FlushSkinPartOptions()

	if slot1 ~= slot0.contextData.ladyEnv.skinId then
		if slot0.contextData.onSwitchSkin then
			slot0.contextData.onSwitchSkin(slot3, slot4, slot0.selectedSkinId)
		else
			slot3:SwitchCharacterSkin(slot4, slot0.selectedSkinId, function ()
				uv0:HideCharacterPart(uv1.selectedSkinId, uv1.hiddenList)
				uv0:PlaySingleAction(uv1.skinDic[uv1.selectedSkinId]:GetSwitchAnim())
			end)
		end
	end

	slot0:FlushSkinList()
end

slot0.FlushBtns = function(slot0)
	slot2 = ApartmentProxy.CheckUnlockConfig(slot0.skinDic[slot0.selectedSkinId]:GetUnlock())

	setActive(slot0.btnChange, slot2)
	setActive(slot0.btnBuy, not slot2)

	if not slot2 then
		if not slot1:GetShopId() then
			return
		end

		slot4 = CommonCommodity.New({
			id = slot3
		}, Goods.TYPE_SHOPSTREET)

		setText(slot0.priceText, &quot;&lt;icon name=&quot; .. slot4:GetResIcon() .. &quot; w=1.1 h=1.1/&gt; &quot; .. slot4:GetPrice())

		slot6 = slot1:GetUnlock()[1]

		if slot1:GetRemarks() and slot7 ~= &quot;&quot; then
			setActive(slot0.line, false)
			setActive(slot0.desc, true)
			setText(slot0.desc, slot7)
		else
			setActive(slot0.line, true)
			setActive(slot0.desc, false)
		end
	else
		setActive(slot0.desc, false)

		if slot0:IsSameSkin() then
			setText(slot0.btnChange:Find(&quot;text&quot;), i18n(&quot;dorm3d_skin_already&quot;))
		else
			setText(slot0.btnChange:Find(&quot;text&quot;), i18n(&quot;dorm3d_skin_confirm&quot;))
		end
	end
end

slot0.FlushSkinPartOptions = function(slot0)
	slot3 = slot0.apartment
	slot0.hiddenList = Clone(slot3:GetHiddenParts(slot0.selectedSkinId))
	slot3 = slot0._tf
	slot4 = slot0._tf

	UIItemList.StaticAlign(slot3:Find(&quot;BG/parts&quot;), slot4:Find(&quot;BG/parts/tpl&quot;), #pg.dorm3d_resource[slot0.selectedSkinId].hidden_part, function (slot0, slot1, slot2)
		slot3 = uv0[slot1 + 1]

		if slot0 == UIItemList.EventInit then
			slot4 = uv1.loader

			slot4:GetSpriteQuiet(&quot;dorm3dskinpart/&quot; .. slot3[2], &quot;&quot;, slot2:Find(&quot;open&quot;))

			slot4 = uv1.loader

			slot4:GetSpriteQuiet(&quot;dorm3dskinpart/&quot; .. slot3[2] .. &quot;_close&quot;, &quot;&quot;, slot2:Find(&quot;close&quot;))

			slot4 = table.contains(uv1.hiddenList, slot3[1])

			setActive(slot2:Find(&quot;open&quot;), not slot4)
			setActive(slot2:Find(&quot;close&quot;), slot4)
			onButton(uv1, slot2, function ()
				if table.contains(uv0.hiddenList, uv1[1]) then
					table.removebyvalue(uv0.hiddenList, uv1[1])
				else
					table.insert(uv0.hiddenList, uv1[1])
				end

				slot0 = not slot0

				setActive(uv2:Find(&quot;open&quot;), not slot0)
				setActive(uv2:Find(&quot;close&quot;), slot0)
				uv0.contextData.ladyEnv:HideCharacterPart(uv0.selectedSkinId, uv0.hiddenList)
				uv0:FlushBtns()
			end, SFX_PANEL)
		end
	end)
end

slot0.IsSameSkin = function(slot0)
	if slot0.selectedSkinId ~= slot0.apartment:GetCurSkinId() then
		return false
	end

	slot2, slot3, slot4 = table.Diff(slot0.hiddenList, slot0.apartment:GetHiddenParts(slot0.selectedSkinId))

	return #slot3 == 0 and #slot4 == 0
end

slot0.ConfirmCurrentSkin = function(slot0)
	slot0:OnclickSkin(slot0.selectedSkinId, true)
end

slot0.CancelCurrentSkin = function(slot0)
	slot0:OnclickSkin(slot0.contextData.ladyEnv.skinId, true)
end

slot0.willExit = function(slot0)
	slot0.loader:Clear()

	if slot0.contextData.isPublicRoom then
		return
	end

	if slot0.contextData.ladyEnv.skinId ~= slot0.apartment:GetCurSkinId() then
		slot2 = slot0.contextData.ladyEnv

		slot2:SwitchCharacterSkin(slot0.contextData.groupId, slot1, function ()
			uv0.contextData.ladyEnv:HideCharacterPart(uv1, uv0.apartment:GetHiddenParts(uv1))
		end)
	else
		slot0.contextData.ladyEnv:HideCharacterPart(slot1, slot0.apartment:GetHiddenParts(slot1))
	end
end

return slot0
</code></pre>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-lua.min.js"></script>
</body>
</html>