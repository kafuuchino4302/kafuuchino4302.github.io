<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>levelfleetview.lua</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
</head>
<body>
    <h1>levelfleetview.lua</h1>
    <a href="index.html">返回主页</a>
    <pre><code class="language-lua">slot0 = class(&quot;LevelFleetView&quot;, import(&quot;..base.BaseSubView&quot;))
slot1 = {
	vanguard = 1,
	submarine = 3,
	main = 2
}
slot0.TabIndex = {
	Adjustment = 4,
	Commander = 2,
	Formation = 1,
	Duty = 3
}
slot2 = {
	EDIT = 2,
	SELECT = 1
}
slot3 = {
	NORMAL = 1,
	ADDITION_SUPPORT = 2
}

slot0.getUIName = function(slot0)
	return &quot;LevelFleetSelectView&quot;
end

slot0.OnInit = function(slot0)
	slot0:InitUI()
	slot0:bind(LevelUIConst.CONTINUOUS_OPERATION, function (slot0, slot1)
		getProxy(ChapterProxy):InitContinuousTime(SYSTEM_SCENARIO, slot1.battleTimes)
		LoadContextCommand.RemoveLayerByMediator(LevelContinuousOperationWindowMediator)
		PlayerPrefs.SetInt(&quot;chapter_autofight_flag_&quot; .. uv0.chapter.id, 1)
		triggerButton(uv0.btnGo)
	end)
	slot0:bind(LevelMediator2.ON_SPITEM_CHANGED, function (slot0, slot1)
		setActive(uv0.spCheckMark, not slot1)
		triggerButton(uv0.btnSp)
	end)
end

slot0.OnDestroy = function(slot0)
	if slot0:isShowing() then
		slot0:Hide()
	end
end

slot0.Show = function(slot0)
	slot2 = slot0.chapter:GetDailyBonusQuota()

	slot0:initSPOPView()

	if type(slot0.chapter:getConfig(&quot;special_operation_list&quot;)) == &quot;table&quot; and #slot1 &gt; 0 and not slot2 then
		setActive(slot0.btnSp, true)
	else
		setActive(slot0.btnSp, false)
	end

	setActive(slot0._tf, true)

	if not isActive(({
		slot0.formationToggle,
		slot0.commanderToggle,
		slot0.dutyToggle,
		slot0.adjustmentToggle
	})[slot0.contextData.tabIndex or uv0.TabIndex.Formation]) then
		slot4 = slot3[uv0.TabIndex.Formation]
	end

	for slot8, slot9 in ipairs(slot3) do
		if isActive(slot9) then
			triggerToggle(slot9, slot9 == slot4)
		end
	end

	pg.UIMgr.GetInstance():BlurPanel(slot0._tf)
	slot0:TryPlaySupportGuide()
	slot0:CheckGuideElement()
end

slot0.CheckGuideElement = function(slot0)
	if not IsUnityEditor then
		return
	end

	_.each({
		&quot;panel/Fixed/start_button&quot;,
		&quot;panel/ShipList/support/1/support&quot;
	}, function (slot0)
		assert(uv0._tf:Find(slot0), &quot;Missing Guide Need GameObject Path: &quot; .. slot0)
	end)
end

slot0.TryPlaySupportGuide = function(slot0)
	if slot0:getLimitNums(FleetType.Support) == 0 then
		return
	end

	if not pg.NewStoryMgr.GetInstance():IsPlayed(&quot;NG0041&quot;) then
		pg.SystemGuideMgr.GetInstance():PlayByGuideId(&quot;NG0041&quot;)
	end
end

slot0.Hide = function(slot0)
	setActive(slot0.dropDown, false)
	setActive(slot0.btnSp, false)
	setActive(slot0._tf, false)

	slot0.spItemID = nil

	pg.UIMgr.GetInstance():UnblurPanel(slot0._tf, slot0._parentTf)
end

slot0.setOpenCommanderTag = function(slot0, slot1)
	slot0.openedCommanerSystem = slot1
end

slot0.SetDutyTabEnabled = function(slot0, slot1)
	slot0.dutyTabEnabled = slot1
end

slot0.onConfirm = function(slot0)
	slot2 = slot0:getSelectIds()

	if #slot0.chapter:getNpcShipByType(2) &gt; 0 then
		slot4 = {
			[TeamType.Vanguard] = #slot0:getFleetById(slot2[1]):getTeamByName(TeamType.Vanguard),
			[TeamType.Main] = #slot0:getFleetById(slot2[1]):getTeamByName(TeamType.Main)
		}
		slot5 = {
			[TeamType.Vanguard] = 0,
			[TeamType.Main] = 0
		}
		slot6 = nil

		for slot10, slot11 in ipairs(slot3) do
			slot6 = slot11
			slot12 = slot11:getTeamType()
			slot5[slot12] = slot5[slot12] + 1

			if slot4[slot12] + slot5[slot12] &gt; 3 then
				break
			end
		end

		for slot10, slot11 in pairs(slot4) do
			if slot11 + slot5[slot10] &gt; 3 then
				slot0:emit(LevelUIConst.HANDLE_SHOW_MSG_BOX, {
					modal = true,
					hideNo = true,
					content = i18n(&quot;chapter_tip_with_npc&quot;, slot6.name)
				})

				return
			end
		end
	end

	slot4 = &quot;chapter_autofight_flag_&quot; .. slot1.id
	slot5, slot6 = nil

	seriesAsync({
		function (slot0)
			slot1 = PlayerPrefs.GetInt(&quot;autoFight_firstUse_sp&quot;, 0) == 1

			if PlayerPrefs.GetInt(uv0, 1) ~= 1 or slot1 or not uv1:getSPItem() then
				return slot0()
			end

			PlayerPrefs.SetInt(&quot;autoFight_firstUse_sp&quot;, 1)
			PlayerPrefs.Save()

			slot3 = function()
				uv0:clearSPBuff()
			end

			uv1:emit(LevelUIConst.HANDLE_SHOW_MSG_BOX, {
				hideNo = true,
				content = i18n(&quot;autofight_special_operation_tip&quot;),
				onYes = slot3,
				onNo = slot3
			})
		end,
		function (slot0)
			uv0 = uv1:GetActiveSPItemID()
			uv2 = uv1:isLoop() and uv3:GetOrderedDuties() or nil

			uv3:onCancel()
			slot0()
		end,
		function (slot0)
			getProxy(ChapterProxy):SetLastFleetIndex(uv0)

			slot2 = LevelMediator2.ON_TRACKING
			slot3 = packEx(uv2.id, uv2.loopFlag, uv3, uv4, PlayerPrefs.GetInt(uv1, 1) == 1)

			if pg.m02:retrieveMediator(LevelMediator2.__cname) then
				pg.m02:sendNotification(slot2, slot3)

				return
			end

			if getProxy(ContextProxy):getContextByMediator(LevelMediator2) then
				slot5:extendData({
					ToTrackingData = {
						slot2,
						slot3
					}
				})
			end
		end
	})
end

slot0.onCancel = function(slot0)
	slot0:clear()
	slot0:emit(LevelUIConst.HIDE_FLEET_SELECT)
end

slot0.InitUI = function(slot0)
	slot0.tfShipTpl = slot0:findTF(&quot;panel/Fixed/shiptpl&quot;)
	slot0.tfEmptyTpl = slot0:findTF(&quot;panel/Fixed/emptytpl&quot;)
	slot0.tfFleets = {
		[FleetType.Normal] = {
			slot0:findTF(&quot;panel/ShipList/fleet/1&quot;),
			slot0:findTF(&quot;panel/ShipList/fleet/2&quot;)
		},
		[FleetType.Submarine] = {
			slot0:findTF(&quot;panel/ShipList/sub/1&quot;)
		},
		[FleetType.Support] = {
			slot0:findTF(&quot;panel/ShipList/support/1&quot;)
		}
	}
	slot1 = slot0:findTF(&quot;panel/Fixed/RightTabs&quot;)
	slot2 = PLATFORM_CODE == PLATFORM_US and slot0:findTF(&quot;panel/Fixed/RightTabs/hTplBtn&quot;) or slot0:findTF(&quot;panel/Fixed/RightTabs/vTplBtn&quot;)

	for slot7 = 1, #{
		&quot;formation_btn&quot;,
		&quot;commander_btn&quot;,
		&quot;duty_btn&quot;,
		&quot;adjustment_btn&quot;
	} do
		slot8 = Instantiate(slot2)
		slot8.name = slot3[slot7]

		SetParent(tf(slot8), slot1)
		setActive(slot8, false)
	end

	slot0.tfLimit = slot0:findTF(&quot;panel/Fixed/limit_list/limit&quot;)
	slot0.tfLimitTips = slot0:findTF(&quot;panel/Fixed/limit_list/limit_tip&quot;)
	slot0.tfLimitElite = slot0:findTF(&quot;panel/Fixed/limit_list/limit_elite&quot;)
	slot0.tfLimitSubTip = slot0:findTF(&quot;panel/Fixed/limit_list/limit_sub_tip&quot;)
	slot0.tfLimitContainer = slot0:findTF(&quot;panel/Fixed/limit_list/limit_elite/limit_list&quot;)
	slot0.rtCostLimit = slot0._tf:Find(&quot;panel/Fixed/limit_list/cost_limit&quot;)
	slot0.btnBack = slot0:findTF(&quot;panel/Fixed/btnBack&quot;)
	slot0.btnGo = slot0:findTF(&quot;panel/Fixed/start_button&quot;)
	slot0.btnMultiple = slot0:findTF(&quot;panel/Fixed/multiple&quot;)
	slot0.formationToggle = slot0:findTF(&quot;panel/Fixed/RightTabs/formation_btn&quot;)
	slot0.commanderToggle = slot0:findTF(&quot;panel/Fixed/RightTabs/commander_btn&quot;)
	slot0.dutyToggle = slot0:findTF(&quot;panel/Fixed/RightTabs/duty_btn&quot;)
	slot0.adjustmentToggle = slot0:findTF(&quot;panel/Fixed/RightTabs/adjustment_btn&quot;)
	slot0.toggleMask = slot0:findTF(&quot;mask&quot;)
	slot0.toggleList = slot0:findTF(&quot;mask/list&quot;)
	slot0.toggles = {}

	setText(findTF(slot0.tfLimit, &quot;text&quot;), i18n(&quot;level_fleet_ship_desc&quot;))

	slot7 = &quot;level_fleet_sub_desc&quot;

	setText(findTF(slot0.tfLimit, &quot;text_sub&quot;), i18n(slot7))

	for slot7 = 0, slot0.toggleList.childCount - 1 do
		table.insert(slot0.toggles, slot0.toggleList:Find(&quot;item&quot; .. slot7 + 1))
	end

	slot0.btnSp = slot0:findTF(&quot;panel/Fixed/sp&quot;)
	slot0.spMask = slot0:findTF(&quot;mask_sp&quot;)
	slot0.dutyItems = {}

	for slot7 = 1, 2 do
		slot12 = slot7
		slot8 = slot0._tf:Find(string.format(&quot;panel/ShipList/fleet/%d/DutySelect&quot;, slot12))
		slot0.dutyItems[slot7] = {}

		for slot12 = 1, 4 do
			slot13 = slot8:Find(&quot;Item&quot; .. slot12)
			slot0.dutyItems[slot7][slot12] = slot13

			setText(slot13:Find(&quot;Text&quot;), i18n(&quot;autofight_function&quot; .. slot12))
		end
	end

	slot4 = slot0._tf:Find(&quot;panel/ShipList/sub/1/DutySelect&quot;)
	slot0.dutyItems[3] = {}

	for slot8 = 1, 2 do
		slot9 = slot4:Find(&quot;Item&quot; .. slot8)
		slot0.dutyItems[3][slot8] = slot9

		setText(slot9:Find(&quot;Text&quot;), i18n(&quot;autofight_function&quot; .. 6 - slot8))
	end

	setActive(slot0.tfShipTpl, false)
	setActive(slot0.tfEmptyTpl, false)
	setActive(slot0.toggleMask, false)
	setActive(slot0.btnSp, false)
	setActive(slot0.spMask, false)
	setText(slot0:findTF(&quot;panel/Fixed/RightTabs/formation_btn/text&quot;), i18n(&quot;autofight_formation&quot;))
	setText(slot0:findTF(&quot;panel/Fixed/RightTabs/commander_btn/text&quot;), i18n(&quot;autofight_cat&quot;))
	setText(slot0:findTF(&quot;panel/Fixed/RightTabs/duty_btn/text&quot;), i18n(&quot;autofight_function&quot;))

	slot6 = slot0.adjustmentToggle

	setText(slot6:Find(&quot;text&quot;), i18n(&quot;word_adjustFleet&quot;))

	slot5 = slot0._tf
	slot0.dropDown = slot5:Find(&quot;panel/FixedTop/Dropdown&quot;)

	setActive(slot0.dropDown, false)

	slot5 = slot0._tf
	slot0.dropDownSide = slot5:Find(&quot;panel/Fixed/title/DropSide&quot;)
	slot7 = slot0.dropDownSide

	onButton(slot0, slot7:Find(&quot;Click&quot;), function ()
		setActive(uv0.dropDown, not isActive(uv0.dropDown))
	end, SFX_UI_CLICK)
	onButton(slot0, slot0.dropDown, function ()
		setActive(uv0.dropDown, not isActive(uv0.dropDown))
	end, SFX_UI_CLICK)

	slot7 = slot0.dropDownSide

	onButton(slot0, slot7:Find(&quot;Layout/Item3&quot;), function ()
		uv0:emit(LevelUIConst.HANDLE_SHOW_MSG_BOX, {
			type = MSGBOX_TYPE_HELP,
			helps = pg.gametip.fleet_antisub_range_tip.tip
		})
	end, SFX_PANEL)
	assert(OPEN_AIR_DOMINANCE, &quot;Not Prepare for BANNED OPEN_AIR_DOMINANCE&quot;)

	slot5 = slot0.dropDownSide
	slot0.btnASHelp = slot5:Find(&quot;help&quot;)
	slot6 = slot0.dropDownSide

	setText(slot6:Find(&quot;Layout/Item1/Text&quot;), i18n(&quot;word_investigate&quot;))

	slot6 = slot0.dropDownSide

	setText(slot6:Find(&quot;Layout/Item2/Text&quot;), i18n(&quot;word_attr_ac&quot;))

	slot6 = slot0.dropDownSide

	setText(slot6:Find(&quot;Layout/Item3/Text&quot;), i18n(&quot;fleet_antisub_range&quot;))

	slot6 = slot0.dropDown

	setText(slot6:Find(&quot;Investigation/Text&quot;), i18n(&quot;level_scene_title_word_1&quot;))

	slot6 = slot0.dropDown

	setText(slot6:Find(&quot;Airsupport/Text&quot;), i18n(&quot;level_scene_title_word_3&quot;))

	slot5 = slot0._tf
	slot0.supportFleetHelp = slot5:Find(&quot;panel/Fixed/title/Image/Help&quot;)

	slot8 = function()
		uv0:emit(LevelUIConst.HANDLE_SHOW_MSG_BOX, {
			type = MSGBOX_TYPE_HELP,
			helps = pg.gametip.help_supportfleet.tip
		})
	end

	onButton(slot0, slot0.supportFleetHelp, slot8, SFX_PANEL)

	for slot8 = 1, 2 do
		for slot12 = 1, 4 do
			onButton(slot0, slot0.dutyItems[slot8][slot12], function ()
				uv0:SetDuty(uv1, uv2)
			end)
		end
	end

	for slot8 = 1, 2 do
		onButton(slot0, slot0.dutyItems[3][slot8], function ()
			uv0:SetAutoSub(uv1 == 1)
		end)
	end
end

slot0.onCancelSupport = function(slot0, slot1)
	if slot1 then
		slot0:emit(LevelMediator2.ON_UPDATE_CUSTOM_FLEET, slot0.chapter)
	end
end

slot0.set = function(slot0, slot1, slot2, slot3)
	slot0.chapter = slot1
	slot0.mode = uv0.SELECT
	slot0.selects = slot3
	slot0.chapterASValue = slot0.chapter:getConfig(&quot;air_dominance&quot;)
	slot0.suggestionValue = slot0.chapter:getConfig(&quot;best_air_dominance&quot;)

	slot0:SetDutyTabEnabled(slot1:isLoop())

	slot0.supportFleet = slot0.chapter:getSupportFleet()
	slot4 = slot0:getLimitNums(FleetType.Support) &gt; 0

	setActive(slot0.supportFleetHelp, slot4)

	slot0.displayMode = slot4 and uv1.ADDITION_SUPPORT or uv1.NORMAL

	slot0:SwitchDisplayMode()

	slot0.fleets = _(_.values(slot2)):chain():filter(function (slot0)
		return slot0:isRegularFleet()
	end):sort(function (slot0, slot1)
		return slot0.id &lt; slot1.id
	end):value()
	slot0.selectIds = {
		[FleetType.Normal] = {},
		[FleetType.Submarine] = {}
	}
	slot5 = ipairs
	slot6 = slot3 or {}

	for slot8, slot9 in slot5(slot6) do
		if slot0:getFleetById(slot9) then
			slot11 = slot10:getFleetType()

			if #slot0.selectIds[slot11] &lt; slot0:getLimitNums(slot11) then
				table.insert(slot12, slot9)
			end
		end
	end

	slot0.duties = {}

	if PlayerPrefs.GetInt(&quot;lastFleetDuty_&quot; .. (slot0.chapter.id or 0), 0) &gt; 0 then
		slot7 = bit.band(bit.rshift(slot5, 8), 255)

		if bit.band(slot5, 255) &gt; 0 and slot7 &gt; 0 then
			slot0.duties[slot6] = slot7
		end
	end

	setActive(slot0.tfLimitElite, false)
	setActive(slot0.tfLimitSubTip, false)
	setActive(slot0.tfLimitTips, false)
	setActive(slot0.tfLimit, true)

	slot6 = slot0.chapter:isLoop() and slot0.chapter:getConfig(&quot;use_oil_limit&quot;) or {}

	setActive(slot0.rtCostLimit, #slot6 &gt; 0)
	setText(slot0.rtCostLimit:Find(&quot;text&quot;), i18n(&quot;formationScene_use_oil_limit_tip&quot;))

	if #slot6 &gt; 0 then
		setActive(slot0.rtCostLimit:Find(&quot;cost_noraml&quot;), slot6[1] &gt; 0)
		setText(slot0.rtCostLimit:Find(&quot;cost_noraml/Text&quot;), string.format(&quot;%s(%d)&quot;, i18n(&quot;formationScene_use_oil_limit_enemy&quot;), slot6[1]))
		setActive(slot0.rtCostLimit:Find(&quot;cost_boss&quot;), slot6[2] &gt; 0)
		setText(slot0.rtCostLimit:Find(&quot;cost_boss/Text&quot;), string.format(&quot;%s(%d)&quot;, i18n(&quot;formationScene_use_oil_limit_flagship&quot;), slot6[2]))
		setActive(slot0.rtCostLimit:Find(&quot;cost_sub&quot;), slot6[3] &gt; 0)
		setText(slot0.rtCostLimit:Find(&quot;cost_sub/Text&quot;), string.format(&quot;%s(%d)&quot;, i18n(&quot;formationScene_use_oil_limit_submarine&quot;), slot6[3]))
	end

	onButton(slot0, slot0.btnGo, function ()
		slot0 = function()
			uv0:onConfirm()
		end

		if uv0:getSPItem() and slot1 ~= 0 then
			if PlayerPrefs.GetInt(&quot;SPOPItemReminder&quot;) ~= 1 then
				pg.MsgboxMgr.GetInstance():ShowMsgBox({
					type = MSGBOX_TYPE_SINGLE_ITEM,
					drop = {
						count = 1,
						type = DROP_TYPE_ITEM,
						id = slot1
					},
					intro = i18n(&quot;levelScene_select_SP_OP_reminder&quot;, Item.getConfigData(slot1).name, pg.benefit_buff_template[Chapter.GetSPBuffByItem(slot1)].desc),
					onYes = function ()
						PlayerPrefs.SetInt(&quot;SPOPItemReminder&quot;, 1)
						PlayerPrefs.Save()
						uv0()
					end,
					weight = LayerWeightConst.TOP_LAYER
				})
			else
				slot0()
			end
		else
			slot0()
		end
	end, SFX_UI_WEIGHANCHOR_GO)
	setActive(slot0.btnMultiple, AutoBotCommand.autoBotSatisfied() and slot0.chapter:isLoop())
	onButton(slot0, slot0.btnMultiple, function ()
		uv0:emit(LevelUIConst.OPEN_NORMAL_CONTINUOUS_WINDOW, uv0.chapter, uv0:getSelectIds(), uv0:getSPItem(), uv0:GetOrderedDuties())
	end, SFX_PANEL)
	onButton(slot0, slot0.btnASHelp, function ()
		pg.MsgboxMgr.GetInstance():ShowMsgBox({
			type = MSGBOX_TYPE_HELP,
			helps = i18n(&quot;help_battle_ac&quot;)
		})
	end, SFX_UI_CLICK)
	onButton(slot0, slot0.btnBack, function ()
		uv0:onCancel()
		uv0:onCancelSupport(true)
	end, SFX_CANCEL)
	onButton(slot0, slot0._tf:Find(&quot;bg&quot;), function ()
		uv0:onCancel()
		uv0:onCancelSupport(true)
	end, SFX_CANCEL)
	onButton(slot0, slot0.toggleMask, function ()
		uv0:hideToggleMask()
	end, SFX_CANCEL)
	onToggle(slot0, slot0.formationToggle, function (slot0)
		if slot0 then
			uv0.contextData.tabIndex = uv1.TabIndex.Formation

			uv0:updateFleets()
		end
	end, SFX_PANEL)
	onToggle(slot0, slot0.commanderToggle, function (slot0)
		if slot0 then
			uv0.contextData.tabIndex = uv1.TabIndex.Commander

			uv0:updateFleets()
		end
	end, SFX_PANEL)
	onToggle(slot0, slot0.dutyToggle, function (slot0)
		if slot0 then
			uv0.contextData.tabIndex = uv1.TabIndex.Duty

			uv0:updateFleets()
		end
	end, SFX_PANEL)
	setActive(slot0.formationToggle, true)
	setActive(slot0.commanderToggle, slot0.openedCommanerSystem)
	setActive(slot0.dutyToggle, slot0.dutyTabEnabled)
	setActive(slot0.adjustmentToggle, false)
	slot0:clearFleets()
	slot0:updateFleets()
	slot0:updateLimit()
	slot0:updateASValue()
	slot0:UpdateSonarRange()
	slot0:UpdateInvestigation()
end

slot0.getFleetById = function(slot0, slot1)
	return _.detect(slot0.fleets, function (slot0)
		return slot0.id == uv0
	end)
end

slot0.getLimitNums = function(slot0, slot1)
	slot2 = 0

	if slot1 == FleetType.Normal then
		slot2 = slot0.chapter:getConfig(&quot;group_num&quot;)
	elseif slot1 == FleetType.Submarine then
		slot2 = slot0.chapter:getConfig(&quot;submarine_num&quot;)
	elseif slot1 == FleetType.Support then
		slot2 = slot0.chapter:getConfig(&quot;support_group_num&quot;)
	end

	return slot2
end

slot0.getSelectIds = function(slot0)
	slot1 = {}

	for slot5, slot6 in ipairs({
		FleetType.Normal,
		FleetType.Submarine
	}) do
		for slot11, slot12 in ipairs(slot0.selectIds[slot6]) do
			if slot12 &gt; 0 then
				table.insert(slot1, slot12)
			end
		end
	end

	return slot1
end

slot0.updateFleets = function(slot0)
	for slot4, slot5 in pairs(slot0.tfFleets) do
		for slot9 = 1, #slot5 do
			if slot4 ~= FleetType.Support then
				slot0:updateFleet(slot4, slot9)
			else
				slot0:UpdateEliteFleet(slot4, slot9)
			end
		end
	end

	slot0:RefreshDutyBar()
end

slot0.updateLimit = function(slot0)
	slot5 = slot0.tfLimit

	setText(slot5:Find(&quot;number&quot;), string.format(&quot;%d/%d&quot;, #_.filter(slot0.selectIds[FleetType.Normal], function (slot0)
		return slot0 &gt; 0
	end), slot0:getLimitNums(FleetType.Normal)))

	slot6 = slot0.tfLimit

	setText(slot6:Find(&quot;number_sub&quot;), string.format(&quot;%d/%d&quot;, #_.filter(slot0.selectIds[FleetType.Submarine], function (slot0)
		return slot0 &gt; 0
	end), slot0:getLimitNums(FleetType.Submarine)))
end

slot0.selectFleet = function(slot0, slot1, slot2, slot3)
	slot4 = slot0.selectIds[slot1]

	if slot3 &gt; 0 and table.contains(slot4, slot3) then
		return
	end

	if slot1 == FleetType.Normal and slot0:getLimitNums(slot1) &gt; 0 and slot3 == 0 and #_.filter(slot4, function (slot0)
		return slot0 &gt; 0
	end) == 1 then
		pg.TipsMgr.GetInstance():ShowTips(i18n(&quot;level_fleet_lease_one_ship&quot;))

		return
	end

	if slot0:getFleetById(slot3) then
		if not slot5:isUnlock() then
			return
		end

		if slot5:isLegalToFight() ~= true then
			pg.TipsMgr.GetInstance():ShowTips(i18n(&quot;level_fleet_not_enough&quot;))

			return
		end
	end

	slot6 = {
		not slot0:IsListOfFleetEmpty(1) or nil,
		not slot0:IsListOfFleetEmpty(2) or nil
	}
	slot7 = slot4[slot2]
	slot4[slot2] = slot3

	slot0:updateFleet(slot1, slot2)
	slot0:updateLimit()
	slot0:updateASValue()
	slot0:UpdateSonarRange()
	slot0:RefreshDutyBar()

	slot8 = {
		not slot0:IsListOfFleetEmpty(1) or nil,
		not slot0:IsListOfFleetEmpty(2) or nil
	}

	if slot0.dutyTabEnabled and table.getCount(slot6) == 2 and table.getCount(slot8) == 1 then
		pg.TipsMgr.GetInstance():ShowTips(i18n(&quot;autofight_change_tip&quot;))
	end

	slot0:UpdateInvestigation()
end

slot0.updateFleet = function(slot0, slot1, slot2)
	slot3 = slot0.contextData.tabIndex == uv0.TabIndex.Formation
	slot4 = slot0.contextData.tabIndex == uv0.TabIndex.Commander
	slot5 = slot0.contextData.tabIndex == uv0.TabIndex.Duty
	slot6 = slot0.contextData.tabIndex == uv0.TabIndex.Adjustment
	slot9 = slot0:getFleetById(slot0.selectIds[slot1][slot2])
	slot11 = slot0.tfFleets[slot1][slot2]
	slot13 = slot0:findTF(&quot;btn_select&quot;, slot11)
	slot15 = slot0:findTF(&quot;btn_clear&quot;, slot11)
	slot16 = slot0:findTF(&quot;blank&quot;, slot11)
	slot18 = slot0:findTF(&quot;commander&quot;, slot11)
	slot19 = slot11:Find(&quot;adjustment_flag&quot;)

	setActive(slot0:findTF(&quot;btn_recom&quot;, slot11), false)
	setActive(slot0:findTF(&quot;selected&quot;, slot11), false)
	setText(findTF(slot11, &quot;bg/name&quot;), &quot;&quot;)

	slot20 = slot0:findTF(TeamType.Main, slot11)
	slot21 = slot0:findTF(TeamType.Vanguard, slot11)
	slot22 = slot0:findTF(TeamType.Submarine, slot11)

	if not (slot2 &lt;= slot0:getLimitNums(slot1)) then
		setActive(slot15, false)
		setActive(slot13, false)
		setActive(slot18, false)
		setActive(slot19, false)
		setActive(slot16, true)

		if slot1 == FleetType.Submarine then
			setActive(slot22, false)
		else
			setActive(slot20, false)
			setActive(slot21, false)
		end

		return
	end

	setActive(slot15, slot3)
	setActive(slot13, slot3)
	setActive(slot18, slot4 and slot9)
	setActive(slot19, slot6)
	setActive(slot16, slot5 or slot6 or slot4 and not slot9)
	setText(slot12, slot9 and slot9:GetName() or &quot;&quot;)

	if slot1 == FleetType.Submarine then
		setActive(slot22, slot9)
	else
		setActive(slot20, slot9)
		setActive(slot21, slot9)
	end

	if slot9 then
		if slot1 == FleetType.Submarine then
			slot0:updateShips(slot22, slot9.subShips)
		else
			slot0:updateShips(slot20, slot9.mainShips)
			slot0:updateShips(slot21, slot9.vanguardShips)
		end

		slot0:updateCommanders(slot18, slot9)
	end

	onButton(slot0, slot13, function ()
		uv0.toggleList.position = (uv1.position + uv2.position) / 2
		uv0.toggleList.anchoredPosition = uv0.toggleList.anchoredPosition + Vector2(-uv0.toggleList.rect.width / 2, -uv1.rect.height / 2)
		slot0 = uv0

		slot0:showToggleMask(uv3, function (slot0)
			uv0:hideToggleMask()
			uv0:selectFleet(uv1, uv2, slot0)
		end)
	end, SFX_UI_CLICK)
	onButton(slot0, slot15, function ()
		uv0:selectFleet(uv1, uv2, 0)
	end, SFX_UI_CLICK)
end

slot0.updateCommanders = function(slot0, slot1, slot2)
	for slot6 = 1, 2 do
		slot7 = slot2:getCommanderByPos(slot6)
		slot8 = slot1:Find(&quot;pos&quot; .. slot6)

		setActive(slot8:Find(&quot;add&quot;), not slot7)
		setActive(slot8:Find(&quot;info&quot;), slot7)

		if slot7 then
			setImageSprite(slot10:Find(&quot;frame&quot;), GetSpriteFromAtlas(&quot;weaponframes&quot;, &quot;commander_&quot; .. Commander.rarity2Frame(slot7:getRarity())))
			GetImageSpriteFromAtlasAsync(&quot;CommanderHrz/&quot; .. slot7:getPainting(), &quot;&quot;, slot10:Find(&quot;mask/icon&quot;))
		end

		onButton(slot0, slot9, function ()
			uv0:emit(LevelUIConst.OPEN_COMMANDER_PANEL, uv1, uv0.chapter)
		end, SFX_PANEL)
		onButton(slot0, slot10, function ()
			uv0:emit(LevelUIConst.OPEN_COMMANDER_PANEL, uv1, uv0.chapter)
		end, SFX_PANEL)
	end
end

slot0.updateShips = function(slot0, slot1, slot2)
	slot3 = UIItemList.New(slot1, slot0.tfShipTpl)

	slot3:make(function (slot0, slot1, slot2)
		if slot0 == UIItemList.EventUpdate then
			slot4 = getProxy(BayProxy):getShipById(uv0[slot1 + 1])

			updateShip(slot2, slot4)
			setActive(findTF(slot2, &quot;ship_type&quot;), false)

			slot5 = slot2:Find(&quot;icon_bg/energy&quot;)

			if slot4:getEnergeConfig() and slot6.id &lt;= 2 then
				setActive(slot5, true)
				GetImageSpriteFromAtlasAsync(&quot;energy&quot;, slot6.icon, slot5)
			else
				setActive(slot5, false)
			end
		end
	end)
	slot3:align(#slot2)

	for slot7, slot8 in ipairs(slot2) do
		slot10 = GetOrAddComponent(slot1:GetChild(slot7 - 1), &quot;UILongPressTrigger&quot;).onLongPressed

		pg.DelegateInfo.Add(slot0, slot10)
		slot10:RemoveAllListeners()
		slot10:AddListener(function ()
			uv0:emit(LevelMediator2.ON_SHIP_DETAIL, {
				id = uv1,
				chapter = uv0.chapter
			})
		end)
	end
end

slot0.showToggleMask = function(slot0, slot1, slot2)
	setActive(slot0.toggleMask, true)

	slot3 = _.filter(slot0.fleets, function (slot0)
		return slot0:getFleetType() == uv0
	end)

	for slot7, slot8 in ipairs(slot0.toggles) do
		slot9 = slot3[slot7]

		setActive(slot8, slot9)

		if slot9 then
			slot10 = slot8:GetComponent(typeof(Toggle))
			slot12, slot13 = slot9:isUnlock()

			setToggleEnabled(slot8, slot12)
			setActive(slot8:Find(&quot;lock&quot;), not slot12)

			slot14 = table.contains(slot0.selectIds[slot1], slot9.id)

			setActive(slot8:Find(&quot;on&quot;), slot14)
			setActive(slot8:Find(&quot;off&quot;), not slot14)

			if slot12 then
				slot10.isOn = false

				onToggle(slot0, slot8, function (slot0)
					if slot0 then
						setActive(uv0.toggleMask, false)
						uv1(uv2.id)
					end
				end, SFX_UI_TAG)
			else
				onButton(slot0, slot11, function ()
					pg.TipsMgr.GetInstance():ShowTips(uv0)
				end, SFX_UI_CLICK)
			end
		end
	end
end

slot0.hideToggleMask = function(slot0)
	setActive(slot0.toggleMask, false)
end

slot0.clearFleets = function(slot0)
	for slot4, slot5 in pairs(slot0.tfFleets) do
		_.each(slot5, function (slot0)
			uv0:clearFleet(slot0)
		end)
	end
end

slot0.UpdateInvestigation = function(slot0)
	if not slot0.chapter:existAmbush() then
		slot0:UpdateLoopInvestigation()

		return
	end

	slot1 = 0

	for slot5 = 1, 2 do
		slot1 = math.max(slot1, slot0:getFleetById(slot0.selectIds[FleetType.Normal][slot5] or 0) and math.floor(slot7:getInvestSums(true)) or 0)
	end

	slot0:UpdateInvestigationComparision(slot1, slot0.chapter:getConfig(&quot;avoid_require&quot;))
end

slot0.UpdateEliteInvestigation = function(slot0)
	if not slot0.chapter:existAmbush() then
		slot0:UpdateLoopInvestigation()

		return
	end

	slot1 = 0

	for slot5 = 1, 2 do
		slot6 = slot0.eliteFleetList[slot5]
		slot7 = {}

		for slot11, slot12 in pairs(slot0.eliteCommanderList[slot5]) do
			table.insert(slot7, {
				pos = slot11,
				id = slot12
			})
		end

		slot1 = math.max(slot1, TypedFleet.New({
			ship_list = slot6,
			commanders = slot7,
			fleetType = FleetType.Normal
		}) and math.floor(slot8:getInvestSums()) or 0)
	end

	slot0:UpdateInvestigationComparision(slot1, slot0.chapter:getConfig(&quot;avoid_require&quot;))
end

slot0.UpdateLoopInvestigation = function(slot0)
	slot1 = slot0.dropDown:Find(&quot;Investigation&quot;)

	setText(slot1:Find(&quot;Value1&quot;), &quot;-&quot;)
	setText(slot1:Find(&quot;Value2&quot;), &quot;-&quot;)
	triggerToggle(slot0.dropDownSide:Find(&quot;Layout/Item1/Dot&quot;), true)
end

slot0.UpdateInvestigationComparision = function(slot0, slot1, slot2)
	slot3 = slot0.dropDown:Find(&quot;Investigation&quot;)
	slot4 = slot2 &lt;= math.floor(slot1)

	setText(slot3:Find(&quot;Value1&quot;), setColorStr(slot1, slot4 and &quot;#51FF55&quot; or COLOR_WHITE))
	setText(slot3:Find(&quot;Value2&quot;), slot2)
	triggerToggle(slot0.dropDownSide:Find(&quot;Layout/Item1/Dot&quot;), slot4)
end

slot0.updateASValue = function(slot0)
	if slot0.chapterASValue &lt;= 0 then
		slot0:UpdateBannedAS()

		return
	end

	slot1 = 0

	for slot5 = 1, 2 do
		slot1 = slot1 + (slot0:getFleetById(slot0.selectIds[FleetType.Normal][slot5] or 0) and slot7:getFleetAirDominanceValue() or 0)
	end

	for slot5 = 1, 1 do
		slot1 = slot1 + (slot0:getFleetById(slot0.selectIds[FleetType.Submarine][slot5] or 0) and slot7:getFleetAirDominanceValue() or 0)
	end

	slot0:UpdateASComparision(slot1, slot0.suggestionValue)
end

slot0.updateEliteASValue = function(slot0)
	if slot0.chapterASValue &lt;= 0 then
		slot0:UpdateBannedAS()

		return
	end

	slot1 = getProxy(BayProxy)
	slot2 = 0

	for slot6, slot7 in ipairs(slot0.eliteFleetList) do
		slot8 = {}

		for slot12, slot13 in pairs(slot0.eliteCommanderList[slot6]) do
			slot8[slot12] = getProxy(CommanderProxy):RawGetCommanderById(slot13)
		end

		for slot12, slot13 in ipairs(slot7) do
			slot2 = slot2 + calcAirDominanceValue(slot1:RawGetShipById(slot13), slot8)
		end
	end

	slot0:UpdateASComparision(slot2, slot0.suggestionValue)
end

slot0.UpdateBannedAS = function(slot0)
	slot1 = slot0.dropDown:Find(&quot;Airsupport&quot;)

	setText(slot1:Find(&quot;Value1&quot;), &quot;-&quot;)
	setText(slot1:Find(&quot;Value2&quot;), &quot;-&quot;)
	triggerToggle(slot0.dropDownSide:Find(&quot;Layout/Item2/Dot&quot;), true)
end

slot0.UpdateASComparision = function(slot0, slot1, slot2)
	setText(slot0.dropDown:Find(&quot;Airsupport&quot;):Find(&quot;Text&quot;), i18n(&quot;level_scene_title_word_3&quot;))

	slot4 = slot2 &lt; math.floor(slot1)

	setText(slot3:Find(&quot;Value1&quot;), setColorStr(slot1, slot4 and &quot;#51FF55&quot; or COLOR_WHITE))
	setText(slot3:Find(&quot;Value2&quot;), slot2)
	triggerToggle(slot0.dropDownSide:Find(&quot;Layout/Item2/Dot&quot;), slot4)
end

slot0.UpdateSonarRange = function(slot0)
	for slot4 = 1, 2 do
		slot0:UpdateSonarRangeValues(slot4, slot0:getFleetById(slot0.selectIds[FleetType.Normal][slot4] or 0) and math.floor(slot6:GetFleetSonarRange()) or 0)
	end
end

slot0.UpdateEliteSonarRange = function(slot0)
	for slot4 = 1, 2 do
		slot5 = slot0.eliteFleetList[slot4]
		slot6 = {}

		for slot10, slot11 in pairs(slot0.eliteCommanderList[slot4]) do
			table.insert(slot6, {
				pos = slot10,
				id = slot11
			})
		end

		slot0:UpdateSonarRangeValues(slot4, TypedFleet.New({
			ship_list = slot5,
			commanders = slot6,
			fleetType = FleetType.Normal
		}) and math.floor(slot7:GetFleetSonarRange()) or 0)
	end
end

slot0.UpdateSonarRangeValues = function(slot0, slot1, slot2)
	setText(slot0.dropDownSide:Find(&quot;Layout/Item3/Values&quot;):GetChild(slot1 - 1), slot2)
end

slot0.clearFleet = function(slot0, slot1)
	slot3 = slot0:findTF(TeamType.Vanguard, slot1)
	slot4 = slot0:findTF(TeamType.Submarine, slot1)

	if slot0:findTF(TeamType.Main, slot1) then
		removeAllChildren(slot2)
	end

	if slot3 then
		removeAllChildren(slot3)
	end

	if slot4 then
		removeAllChildren(slot4)
	end
end

slot0.clear = function(slot0)
	slot0.contextData.tabIndex = nil
	slot0.duties = nil
end

slot0.onCancelHard = function(slot0, slot1)
	if slot1 then
		slot0:emit(LevelMediator2.ON_UPDATE_CUSTOM_FLEET, slot0.chapter)
	end

	slot0:emit(LevelUIConst.HIDE_FLEET_EDIT)
end

slot0.setHardShipVOs = function(slot0, slot1)
	slot0.shipVOs = slot1
end

slot0.setOnHard = function(slot0, slot1)
	slot0.chapter = slot1
	slot0.mode = uv0.EDIT
	slot0.propetyLimitation = slot0.chapter:getConfig(&quot;property_limitation&quot;)
	slot0.eliteFleetList = slot0.chapter:getEliteFleetList()
	slot0.chapterASValue = slot0.chapter:getConfig(&quot;air_dominance&quot;)
	slot0.suggestionValue = slot0.chapter:getConfig(&quot;best_air_dominance&quot;)
	slot0.eliteCommanderList = slot0.chapter:getEliteFleetCommanders()
	slot0.typeLimitations = slot0.chapter:getConfig(&quot;limitation&quot;)

	slot0:SetDutyTabEnabled(slot1:isLoop())

	slot2 = slot0:getLimitNums(FleetType.Support) &gt; 0

	setActive(slot0.supportFleetHelp, slot2)

	slot0.displayMode = slot2 and uv1.ADDITION_SUPPORT or uv1.NORMAL

	slot0:SwitchDisplayMode()

	slot0.duties = {}

	if PlayerPrefs.GetInt(&quot;lastFleetDuty_&quot; .. (slot0.chapter.id or 0), 0) &gt; 0 then
		slot5 = bit.band(bit.rshift(slot3, 8), 255)

		if bit.band(slot3, 255) &gt; 0 and slot5 &gt; 0 then
			slot0.duties[slot4] = slot5
		end
	end

	onButton(slot0, slot0.btnGo, function ()
		slot0 = &quot;chapter_autofight_flag_&quot; .. uv0.chapter.id
		slot1 = uv0.chapter
		slot2, slot3 = nil

		seriesAsync({
			function (slot0)
				slot1 = PlayerPrefs.GetInt(&quot;autoFight_firstUse_sp&quot;, 0) == 1

				if PlayerPrefs.GetInt(uv0, 1) ~= 1 or not uv1:getSPItem() or slot1 then
					return slot0()
				end

				PlayerPrefs.SetInt(&quot;autoFight_firstUse_sp&quot;, 1)
				PlayerPrefs.Save()

				slot3 = function()
					uv0:clearSPBuff()
				end

				uv1:emit(LevelUIConst.HANDLE_SHOW_MSG_BOX, {
					hideNo = true,
					content = i18n(&quot;autofight_special_operation_tip&quot;),
					onYes = slot3,
					onNo = slot3
				})
			end,
			function (slot0)
				uv0 = uv1.chapter:GetActiveSPItemID()
				uv2 = uv1.chapter:isLoop() and uv1:GetOrderedDuties() or nil

				uv1:clear()
				uv1:onCancelHard()
				slot0()
			end,
			function (slot0)
				slot2 = LevelMediator2.ON_ELITE_TRACKING
				slot3 = packEx(uv1.id, uv1.loopFlag, uv2, uv3, PlayerPrefs.GetInt(uv0, 1) == 1)

				if pg.m02:retrieveMediator(LevelMediator2.__cname) then
					pg.m02:sendNotification(slot2, slot3)

					return
				end

				if getProxy(ContextProxy):getContextByMediator(LevelMediator2) then
					slot5:extendData({
						ToTrackingData = {
							slot2,
							slot3
						}
					})
				end
			end
		})
	end, SFX_UI_WEIGHANCHOR_GO)
	setActive(slot0.btnMultiple, AutoBotCommand.autoBotSatisfied() and slot0.chapter:isLoop())
	onButton(slot0, slot0.btnMultiple, function ()
		uv0:emit(LevelUIConst.OPEN_ELITE_CONTINUOUS_WINDOW, uv0.chapter, uv0:getSPItem(), uv0:GetOrderedDuties())
	end, SFX_PANEL)
	onButton(slot0, slot0.btnASHelp, function ()
		pg.MsgboxMgr.GetInstance():ShowMsgBox({
			type = MSGBOX_TYPE_HELP,
			helps = i18n(&quot;help_battle_ac&quot;)
		})
	end, SFX_UI_CLICK)
	onButton(slot0, slot0.btnBack, function ()
		uv0:clear()
		uv0:onCancelHard(true)
	end, SFX_CANCEL)
	onButton(slot0, slot0._tf:Find(&quot;bg&quot;), function ()
		uv0:clear()
		uv0:onCancelHard(true)
	end, SFX_CANCEL)
	onToggle(slot0, slot0.commanderToggle, function (slot0)
		if slot0 then
			uv0.contextData.tabIndex = uv1.TabIndex.Commander

			uv0:flush()
		end
	end, SFX_PANEL)
	onToggle(slot0, slot0.formationToggle, function (slot0)
		if slot0 then
			uv0.contextData.tabIndex = uv1.TabIndex.Formation

			uv0:flush()
		end
	end, SFX_PANEL)
	onToggle(slot0, slot0.dutyToggle, function (slot0)
		if slot0 then
			uv0.contextData.tabIndex = uv1.TabIndex.Duty

			uv0:flush()
		end
	end, SFX_UI_TAG)
	onToggle(slot0, slot0.adjustmentToggle, function (slot0)
		if slot0 then
			uv0.contextData.tabIndex = uv1.TabIndex.Adjustment

			uv0:flush()
		end
	end, SFX_PANEL)
	setActive(slot0.formationToggle, true)
	setActive(slot0.commanderToggle, slot0.openedCommanerSystem)
	setActive(slot0.dutyToggle, slot0.dutyTabEnabled)
	setActive(slot0.adjustmentToggle, true)
	slot0:flush()
end

slot0.flush = function(slot0)
	slot0:updateEliteLimit()
	slot0:updateEliteASValue()

	slot0.lastFleetValidStatus = slot0.lastFleetValidStatus or {}
	slot1 = {
		not slot0:IsListOfFleetEmpty(1) or nil,
		not slot0:IsListOfFleetEmpty(2) or nil
	}

	if slot0.dutyTabEnabled and table.getCount(slot0.lastFleetValidStatus) == 2 and table.getCount(slot1) == 1 then
		pg.TipsMgr.GetInstance():ShowTips(i18n(&quot;autofight_change_tip&quot;))
	end

	slot0.lastFleetValidStatus = slot1

	slot0:updateEliteFleets()
	slot0:UpdateEliteSonarRange()
	slot0:UpdateEliteInvestigation()
end

slot0.updateEliteLimit = function(slot0)
	setActive(slot0.toggleMask, false)
	setActive(slot0.tfLimit, false)
	setActive(slot0.tfLimitTips, #slot0.propetyLimitation == 0)
	setActive(slot0.tfLimitElite, #slot0.propetyLimitation &gt; 0)
	setActive(slot0.tfLimitSubTip, #slot0.propetyLimitation &gt; 0)

	if #slot0.propetyLimitation &gt; 0 then
		slot1, slot2 = slot0.chapter:IsPropertyLimitationSatisfy()
		slot3 = UIItemList.New(slot0.tfLimitContainer, slot0.tfLimitContainer:GetChild(0))

		slot3:make(function (slot0, slot1, slot2)
			slot1 = slot1 + 1

			if slot0 == UIItemList.EventUpdate then
				slot4, slot5, slot6, slot7 = unpack(uv0.propetyLimitation[slot1])

				if uv1[slot1] == 1 then
					uv0:findTF(&quot;Text&quot;, slot2):GetComponent(typeof(Text)).color = Color.New(1, 0.9607843137254902, 0.5019607843137255)
				else
					uv0:findTF(&quot;Text&quot;, slot2):GetComponent(typeof(Text)).color = Color.New(0.9568627450980393, 0.30196078431372547, 0.30196078431372547)
				end

				setActive(slot2, true)
				setText(uv0:findTF(&quot;Text&quot;, slot2), AttributeType.EliteCondition2Name(slot4, slot7) .. AttributeType.eliteConditionCompareTip(slot5) .. slot6 .. &quot;（&quot; .. uv2[slot4] .. &quot;）&quot;)
			end
		end)
		slot3:align(#slot0.propetyLimitation)
		setActive(slot0.tfLimitSubTip, slot0.chapter:getConfig(&quot;submarine_num&quot;) &gt; 0)
	end

	slot1 = slot0.chapter:isLoop() and slot0.chapter:getConfig(&quot;use_oil_limit&quot;) or {}

	setActive(slot0.rtCostLimit, #slot1 &gt; 0)
	setText(slot0.rtCostLimit:Find(&quot;text&quot;), i18n(&quot;formationScene_use_oil_limit_tip&quot;))

	if #slot1 &gt; 0 then
		setActive(slot0.rtCostLimit:Find(&quot;cost_noraml&quot;), slot1[1] &gt; 0)
		setText(slot0.rtCostLimit:Find(&quot;cost_noraml/Text&quot;), string.format(&quot;%s(%d)&quot;, i18n(&quot;formationScene_use_oil_limit_enemy&quot;), slot1[1]))
		setActive(slot0.rtCostLimit:Find(&quot;cost_boss&quot;), slot1[2] &gt; 0)
		setText(slot0.rtCostLimit:Find(&quot;cost_boss/Text&quot;), string.format(&quot;%s(%d)&quot;, i18n(&quot;formationScene_use_oil_limit_flagship&quot;), slot1[2]))
		setActive(slot0.rtCostLimit:Find(&quot;cost_sub&quot;), slot1[3] &gt; 0)
		setText(slot0.rtCostLimit:Find(&quot;cost_sub/Text&quot;), string.format(&quot;%s(%d)&quot;, i18n(&quot;formationScene_use_oil_limit_submarine&quot;), slot1[3]))
	end
end

slot0.initAddButton = function(slot0, slot1, slot2, slot3, slot4)
	slot6 = {}
	slot7 = {}

	for slot11, slot12 in ipairs(slot0.eliteFleetList[slot4]) do
		slot6[slot0.shipVOs[slot12]] = true

		if slot2 == slot0.shipVOs[slot12]:getTeamType() then
			table.insert(slot7, slot12)
		end
	end

	slot8 = findTF(slot1, slot2)

	removeAllChildren(slot8)

	slot9 = 0
	slot10 = false
	slot11 = 0
	slot3 = uv0.sortTeamLimitation(slot3)
	slot8:GetComponent(&quot;ContentSizeFitter&quot;).enabled = true
	slot8:GetComponent(&quot;HorizontalLayoutGroup&quot;).enabled = true
	slot0.isDraging = false

	for slot17 = 1, 3 do
		slot18, slot19, slot20 = nil

		if slot7[slot17] and slot0.shipVOs[slot7[slot17]] or nil then
			for slot25, slot26 in ipairs(slot3) do
				if ShipType.ContainInLimitBundle(slot26, slot21:getShipType()) then
					slot19 = slot21
					slot20 = slot26

					table.remove(slot3, slot25)

					slot10 = slot10 or slot26 ~= 0

					break
				end
			end
		else
			slot20 = slot3[1]

			table.remove(slot3, 1)
		end

		if slot20 == 0 then
			slot11 = slot11 + 1
		end

		setActive(slot19 and cloneTplTo(slot0.tfShipTpl, slot8) or cloneTplTo(slot0.tfEmptyTpl, slot8), true)

		if slot19 then
			updateShip(slot22, slot19)
			setActive(slot0:findTF(&quot;event_block&quot;, slot22), slot19:getFlag(&quot;inEvent&quot;))

			slot6[slot19] = true
		else
			slot9 = slot9 + 1
		end

		setActive(slot0:findTF(&quot;ship_type&quot;, slot22), slot20 and slot20 ~= 0)

		if slot20 and slot20 ~= 0 then
			if type(slot20) == &quot;number&quot; then
				setImageSprite(slot0:findTF(&quot;ship_type&quot;, slot22), GetSpriteFromAtlas(&quot;shiptype&quot;, ShipType.Type2CNLabel(slot20)), true)
			elseif type(slot20) == &quot;string&quot; then
				setImageSprite(slot0:findTF(&quot;ship_type&quot;, slot22), GetSpriteFromAtlas(&quot;shiptype&quot;, ShipType.BundleType2CNLabel(slot20)), true)
			end
		end

		table.sort(_.map(slot5, function (slot0)
			return uv0.shipVOs[slot0]
		end), function (slot0, slot1)
			return uv0[slot0:getTeamType()] &lt; uv0[slot1:getTeamType()] or uv0[slot0:getTeamType()] == uv0[slot1:getTeamType()] and table.indexof(uv1, slot0.id) &lt; table.indexof(uv1, slot1.id)
		end)
		GetOrAddComponent(slot22, typeof(UILongPressTrigger)).onLongPressed:RemoveAllListeners()

		if slot19 and slot0.contextData.tabIndex ~= uv0.TabIndex.Adjustment then
			slot25 = slot24.onLongPressed

			slot25:AddListener(function ()
				uv0:onCancelHard(true)
				uv0:emit(LevelMediator2.ON_FLEET_SHIPINFO, {
					shipId = uv1.id,
					shipVOs = uv2,
					chapter = uv0.chapter
				})
			end)
		end

		slot25 = GetOrAddComponent(slot22, &quot;EventTriggerListener&quot;)

		slot25:RemovePointClickFunc()
		slot25:AddPointClickFunc(function (slot0, slot1)
			if slot0 ~= uv0.gameObject then
				return
			end

			if uv1.isDraging then
				return
			end

			uv1:onCancelHard()
			uv1:emit(LevelMediator2.ON_ELITE_OEPN_DECK, {
				shipType = uv2,
				fleet = uv3,
				chapter = uv1.chapter,
				shipVO = uv4,
				fleetIndex = uv5,
				teamType = uv6
			})
		end)
		slot25:RemoveBeginDragFunc()
		slot25:RemoveDragFunc()
		slot25:RemoveDragEndFunc()

		if slot19 and slot0.contextData.tabIndex == uv0.TabIndex.Adjustment then
			slot26 = slot22.rect.width * 0.5
			slot27 = {}
			slot28 = {}

			slot25:AddBeginDragFunc(function (slot0, slot1)
				if slot0 ~= uv0.gameObject then
					return
				end

				if uv1.isDraging then
					return
				end

				uv1.isDraging = true
				uv2.enabled = false
				uv3.enabled = false

				for slot5 = 1, 3 do
					if uv0 == uv4:GetChild(slot5 - 1) then
						uv1.dragIndex = slot5
					end

					uv5[slot5] = slot6.anchoredPosition
					uv6[slot5] = slot6
				end
			end)
			slot25:AddDragFunc(function (slot0, slot1)
				if slot0 ~= uv0.gameObject then
					return
				end

				if not uv1.isDraging then
					return
				end

				slot2 = uv0.localPosition
				slot2.x = uv1:change2ScrPos(uv0.parent, slot1.position).x
				slot2.x = math.clamp(slot2.x, uv2[1].x, uv2[3].x)
				uv0.localPosition = slot2
				slot3 = 1

				for slot7 = 1, 3 do
					if uv0 ~= uv3[slot7] and uv0.localPosition.x &gt; uv3[slot7].localPosition.x + (slot3 &lt; uv1.dragIndex and 1.1 or -1.1) * uv4 then
						slot3 = slot3 + 1
					end
				end

				if uv1.dragIndex ~= slot3 then
					slot4 = slot3 &lt; uv1.dragIndex and -1 or 1

					while uv1.dragIndex ~= slot3 do
						slot5 = uv1.dragIndex
						slot6 = uv1.dragIndex + slot4
						uv5[slot6] = uv5[slot5]
						uv5[slot5] = uv5[slot6]
						uv3[slot6] = uv3[slot5]
						uv3[slot5] = uv3[slot6]
						uv1.dragIndex = uv1.dragIndex + slot4
					end

					for slot8 = 1, 3 do
						if uv0 ~= uv3[slot8] then
							uv3[slot8].anchoredPosition = uv2[slot8]
						end
					end
				end
			end)
			slot25:AddDragEndFunc(function (slot0, slot1)
				if slot0 ~= uv0.gameObject then
					return
				end

				if not uv1.isDraging then
					return
				end

				uv1.isDraging = false

				for slot5 = 1, 3 do
					if not uv2[slot5] then
						for slot9 = slot5 + 1, 3 do
							if uv2[slot9] then
								uv2[slot9] = uv2[slot5]
								uv2[slot5] = uv2[slot9]
								uv3[slot9] = uv3[slot5]
								uv3[slot5] = uv3[slot9]
							end
						end
					end

					if uv2[slot5] then
						table.removebyvalue(uv4, uv2[slot5])
						table.insert(uv4, uv2[slot5])
					else
						break
					end
				end

				for slot5 = 1, 3 do
					uv3[slot5]:SetSiblingIndex(slot5 - 1)
				end

				uv5.enabled = true
				uv6.enabled = true
				uv1.dragIndex = nil

				uv1:emit(LevelMediator2.ON_ELITE_ADJUSTMENT, uv1.chapter)
			end)
		end
	end

	if (slot10 == true or slot11 == 3) and slot9 ~= 3 then
		return true
	else
		return false
	end
end

slot0.change2ScrPos = function(slot0, slot1, slot2)
	return LuaHelper.ScreenToLocal(slot1, slot2, pg.UIMgr.GetInstance().overlayCameraComp)
end

slot0.updateEliteFleets = function(slot0)
	for slot4, slot5 in pairs(slot0.tfFleets) do
		for slot9 = 1, #slot5 do
			slot0:UpdateEliteFleet(slot4, slot9)
		end
	end

	slot0:RefreshDutyBar()
end

slot0.UpdateEliteFleet = function(slot0, slot1, slot2)
	slot3 = slot0.contextData.tabIndex == uv0.TabIndex.Formation
	slot4 = slot0.contextData.tabIndex == uv0.TabIndex.Commander
	slot5 = slot0.contextData.tabIndex == uv0.TabIndex.Duty
	slot6 = slot0.contextData.tabIndex == uv0.TabIndex.Adjustment
	slot8 = slot0.tfFleets[slot1][slot2]
	slot9 = findTF(slot8, &quot;bg/name&quot;)
	slot11 = slot0:findTF(&quot;btn_recom&quot;, slot8)
	slot12 = slot0:findTF(&quot;btn_clear&quot;, slot8)
	slot13 = slot0:findTF(&quot;blank&quot;, slot8)
	slot14 = slot0:findTF(&quot;selected&quot;, slot8)
	slot15 = slot0:findTF(&quot;commander&quot;, slot8)
	slot16 = slot8:Find(&quot;adjustment_flag&quot;)

	setActive(slot0:findTF(&quot;btn_select&quot;, slot8), false)

	slot17 = slot0:findTF(TeamType.Main, slot8)
	slot18 = slot0:findTF(TeamType.Vanguard, slot8)
	slot19 = slot0:findTF(TeamType.Submarine, slot8)
	slot20 = slot0:findTF(TeamType.Support, slot8)

	if not (slot2 &lt;= slot0:getLimitNums(slot1)) then
		setActive(slot12, false)
		setActive(slot11, false)
		setActive(slot15, false)
		setActive(slot16, false)
		setActive(slot13, true)
		setActive(slot14, false)
		setText(slot9, &quot;&quot;)

		if slot1 == FleetType.Normal then
			setActive(slot17, false)
			setActive(slot18, false)
		elseif slot1 == FleetType.Submarine then
			setActive(slot19, false)
		elseif slot1 == FleetType.Support then
			setActive(slot20, false)
		end

		return
	end

	slot21 = slot1 == FleetType.Support

	setActive(slot12, slot3)
	setActive(slot11, slot3)
	setActive(slot15, slot4 and not slot21)
	setActive(slot16, slot6)
	setActive(slot13, slot5 or slot6 or slot4 and slot21)

	slot22 = slot2

	if slot1 == FleetType.Normal then
		setText(slot9, Fleet.DEFAULT_NAME[slot2])
		setActive(slot17, true)
		setActive(slot18, true)
	elseif slot1 == FleetType.Submarine then
		slot22 = 3

		setText(slot9, Fleet.DEFAULT_NAME[Fleet.SUBMARINE_FLEET_ID + slot2 - 1])
		setActive(slot19, true)
	elseif slot1 == FleetType.Support then
		slot22 = 4

		setText(slot9, &quot;&quot;)
		setActive(slot20, true)
	end

	slot23 = 6

	if slot1 == FleetType.Normal then
		slot24 = slot0.typeLimitations[slot2]

		setActive(slot14, slot0:initAddButton(slot8, TeamType.Main, slot24[1], slot22) and slot0:initAddButton(slot8, TeamType.Vanguard, slot24[2], slot22))
	elseif slot1 == FleetType.Submarine then
		slot23 = 3

		setActive(slot14, slot0:initAddButton(slot8, TeamType.Submarine, {
			0,
			0,
			0
		}, slot22))
	elseif slot1 == FleetType.Support then
		slot23 = 3

		setActive(slot14, slot0.mode == uv1.EDIT and slot0:initSupportAddButton(slot8, TeamType.Support, {
			&quot;hang&quot;,
			&quot;hang&quot;,
			&quot;hang&quot;
		}))
	end

	if not slot21 then
		slot0:initCommander(slot22, slot15, slot0.chapter)
	end

	onButton(slot0, slot12, function ()
		if #(not uv0 and uv1.eliteFleetList[uv2] or uv1.supportFleet) == 0 then
			return
		end

		pg.MsgboxMgr.GetInstance():ShowMsgBox({
			content = i18n(&quot;battle_preCombatLayer_clear_confirm&quot;),
			onYes = function ()
				if not uv0 then
					uv1:emit(LevelMediator2.ON_ELITE_CLEAR, {
						index = uv2,
						chapterVO = uv1.chapter
					})
				else
					uv1:emit(LevelMediator2.ON_SUPPORT_CLEAR, {
						index = uv2,
						chapterVO = uv1.chapter
					})
				end
			end
		})
	end)
	onButton(slot0, slot11, function ()
		if #(not uv0 and uv1.eliteFleetList[uv2] or uv1.supportFleet) == uv3 then
			return
		end

		seriesAsync({
			function (slot0)
				if uv0 == 0 then
					return slot0()
				end

				pg.MsgboxMgr.GetInstance():ShowMsgBox({
					content = i18n(&quot;battle_preCombatLayer_auto_confirm&quot;),
					onYes = slot0
				})
			end,
			function ()
				if not uv0 then
					uv1:emit(LevelMediator2.ON_ELITE_RECOMMEND, {
						index = uv2,
						chapterVO = uv1.chapter
					})
				else
					uv1:emit(LevelMediator2.ON_SUPPORT_RECOMMEND, {
						index = uv2,
						chapterVO = uv1.chapter
					})
				end
			end
		})
	end)
end

slot0.initCommander = function(slot0, slot1, slot2, slot3)
	slot5 = slot3:getEliteFleetCommanders()[slot1]

	for slot9 = 1, 2 do
		slot11 = nil

		if slot5[slot9] then
			slot11 = getProxy(CommanderProxy):getCommanderById(slot10)
		end

		slot12 = slot2:Find(&quot;pos&quot; .. slot9)

		setActive(slot12:Find(&quot;add&quot;), not slot11)
		setActive(slot12:Find(&quot;info&quot;), slot11)

		if slot11 then
			setImageSprite(slot14:Find(&quot;frame&quot;), GetSpriteFromAtlas(&quot;weaponframes&quot;, &quot;commander_&quot; .. Commander.rarity2Frame(slot11:getRarity())))
			GetImageSpriteFromAtlasAsync(&quot;CommanderHrz/&quot; .. slot11:getPainting(), &quot;&quot;, slot14:Find(&quot;mask/icon&quot;))
		end

		slot15 = slot3:wrapEliteFleet(slot1)

		onButton(slot0, slot13, function ()
			uv0:emit(LevelUIConst.OPEN_COMMANDER_PANEL, uv1, uv2, uv3)
		end, SFX_PANEL)
		onButton(slot0, slot14, function ()
			uv0:emit(LevelUIConst.OPEN_COMMANDER_PANEL, uv1, uv2, uv3)
		end, SFX_PANEL)
	end
end

slot0.initSupportAddButton = function(slot0, slot1, slot2, slot3)
	slot4 = {}
	slot5 = {}

	for slot9, slot10 in ipairs(slot0.supportFleet) do
		slot4[slot0.shipVOs[slot10]] = true

		table.insert(slot5, slot10)
	end

	removeAllChildren(findTF(slot1, slot2))

	slot7 = 0
	slot8 = false
	slot9 = 0
	slot3 = uv0.sortTeamLimitation(slot3)

	for slot13 = 1, 3 do
		slot14, slot15 = nil

		if slot5[slot13] and slot0.shipVOs[slot5[slot13]] or nil then
			for slot20, slot21 in ipairs(slot3) do
				if ShipType.ContainInLimitBundle(slot21, slot16:getShipType()) then
					slot14 = slot16
					slot15 = slot21

					table.remove(slot3, slot20)

					slot8 = slot8 or slot21 ~= 0

					break
				end
			end
		else
			slot15 = slot3[1]

			table.remove(slot3, 1)
		end

		if slot15 == 0 then
			slot9 = slot9 + 1
		end

		setActive(slot14 and cloneTplTo(slot0.tfShipTpl, slot6) or cloneTplTo(slot0.tfEmptyTpl, slot6), true)

		if slot14 then
			updateShip(slot17, slot14)
			setActive(slot0:findTF(&quot;event_block&quot;, slot17), slot14:getFlag(&quot;inEvent&quot;))

			slot4[slot14] = true
		else
			slot7 = slot7 + 1
		end

		setActive(slot0:findTF(&quot;ship_type&quot;, slot17), slot15 and slot15 ~= 0)

		if slot15 and slot15 ~= 0 then
			if type(slot15) == &quot;number&quot; then
				setImageSprite(slot0:findTF(&quot;ship_type&quot;, slot17), GetSpriteFromAtlas(&quot;shiptype&quot;, ShipType.Type2CNLabel(slot15)), true)
			elseif type(slot15) == &quot;string&quot; then
				setImageSprite(slot0:findTF(&quot;ship_type&quot;, slot17), GetSpriteFromAtlas(&quot;shiptype&quot;, ShipType.BundleType2CNLabel(slot15)), true)
			end
		end

		slot18 = _.map(slot0.supportFleet, function (slot0)
			return uv0.shipVOs[slot0]
		end)

		GetOrAddComponent(slot17, typeof(UILongPressTrigger)).onLongPressed:RemoveAllListeners()

		if slot14 and slot0.contextData.tabIndex ~= uv0.TabIndex.Adjustment then
			slot20 = slot19.onLongPressed

			slot20:AddListener(function ()
				uv0:onCancelSupport(true)
				uv0:emit(LevelMediator2.ON_SUPPORT_SHIPINFO, {
					shipId = uv1.id,
					shipVOs = uv2,
					chapter = uv0.chapter
				})
			end)
		end

		slot20 = GetOrAddComponent(slot17, &quot;EventTriggerListener&quot;)

		slot20:RemovePointClickFunc()
		slot20:AddPointClickFunc(function (slot0, slot1)
			if slot0 ~= uv0.gameObject then
				return
			end

			if uv1.isDraging then
				return
			end

			uv1:onCancelSupport()
			uv1:emit(LevelMediator2.ON_SUPPORT_OPEN_DECK, {
				shipType = uv2,
				fleet = uv3,
				chapter = uv1.chapter,
				shipVO = uv4
			})
		end)
		slot20:RemoveBeginDragFunc()
		slot20:RemoveDragFunc()
		slot20:RemoveDragEndFunc()
	end

	if (slot8 == true or slot9 == 3) and slot7 ~= 3 then
		return true
	else
		return false
	end
end

slot0.updateSpecialOperationTickets = function(slot0, slot1)
	slot0.spOPTicketItems = slot1 or {}
end

slot0.getLegalSPBuffList = function(slot0)
	slot1 = slot0.chapter

	return _.map(slot1:GetSpItems(), function (slot0)
		return Chapter.GetSPBuffByItem(slot0:GetConfigID())
	end)
end

slot0.initSPOPView = function(slot0)
	slot0.spPanel = slot0.btnSp:Find(&quot;sp_panel&quot;)
	slot0.spItem = slot0.btnSp:Find(&quot;item&quot;)
	slot0.spDesc = slot0.btnSp:Find(&quot;desc&quot;)
	slot0.spCheckBox = slot0.btnSp:Find(&quot;checkbox&quot;)
	slot0.spCheckMark = slot0.spCheckBox:Find(&quot;mark&quot;)
	slot0.spTpl = slot0.spPanel:Find(&quot;sp_tpl&quot;)
	slot0.spContainer = slot0.spPanel:Find(&quot;sp_container&quot;)
	slot0.spItemEmptyBlock = slot0.btnSp:Find(&quot;empty_block&quot;)

	setText(slot0.spItemEmptyBlock, i18n(&quot;levelScene_select_noitem&quot;))
	removeAllChildren(slot0.spContainer)

	slot2 = slot0.chapter:GetActiveSPItemID()

	slot0:setSPBtnFormByBuffCount()

	if #slot0:getLegalSPBuffList() == 0 then
		slot0:clearSPBuff()
	elseif #slot1 == 1 then
		slot4 = pg.benefit_buff_template[slot1[1]]

		slot0:setTicketInfo(slot0.btnSp, slot4.benefit_condition)
		setText(slot0.spDesc, slot4.desc)
		onButton(slot0, slot0.btnSp:Find(&quot;item&quot;), function ()
			uv0:emit(BaseUI.ON_ITEM, tonumber(uv1.benefit_condition))
		end)
		onButton(slot0, slot0.btnSp, function ()
			slot0 = Chapter.GetSPOperationItemCacheKey(uv0.chapter.id)

			if uv0.spCheckMark.gameObject.activeSelf then
				PlayerPrefs.SetInt(slot0, 0)
				uv0:clearSPBuff()
			else
				uv0.spItemID = tonumber(uv1.benefit_condition)

				PlayerPrefs.SetInt(slot0, uv0.spItemID)
				pg.TipsMgr.GetInstance():ShowTips(i18n(&quot;levelScene_select_sp&quot;))
				setActive(uv0.spCheckMark, true)
			end
		end)
		setActive(slot0.spCheckMark, slot2 == 0)
		triggerButton(slot0.btnSp)
	elseif #slot1 &gt; 1 then
		slot6 = &quot;levelScene_select_SP_OP&quot;

		setText(slot0.spDesc, i18n(slot6))

		for slot6, slot7 in ipairs(slot1) do
			slot8 = cloneTplTo(slot0.spTpl, slot0.spContainer)

			setText(slot8:Find(&quot;desc&quot;), slot7.desc)
			slot0:setTicketInfo(slot8, slot7.benefit_condition)
			setActive(slot8:Find(&quot;block&quot;), false)
			onButton(slot0, slot8, function ()
				uv0:setSPBuffSelected(uv1.id)
				setActive(uv0.spPanel, false)
			end)
		end

		onButton(slot0, slot0.btnSp, function ()
			if uv0.spPanel.gameObject.activeSelf then
				uv0:clearSPBuff()
				PlayerPrefs.SetInt(Chapter.GetSPOperationItemCacheKey(uv0.chapter.id), 0)
				setActive(uv0.spPanel, false)
			else
				setActive(uv0.spPanel, true)
				setActive(uv0.btnSp:Find(&quot;item&quot;), false)
				setText(uv0.spDesc, i18n(&quot;levelScene_unselect_SP_OP&quot;))
			end
		end)

		if slot2 ~= 0 then
			slot3 = nil

			for slot7, slot8 in ipairs(slot1) do
				if slot8.id == Chapter.GetSPBuffByItem(slot2) then
					slot3 = true

					break
				end
			end

			if slot3 then
				slot0:setSPBuffSelected(Chapter.GetSPBuffByItem(slot2))
			else
				slot0:clearSPBuff()
			end
		else
			slot0:clearSPBuff()
		end
	end

	setActive(slot0.spPanel, false)
end

slot0.setSPBuffSelected = function(slot0, slot1)
	slot2 = pg.benefit_buff_template[slot1]
	slot0.spItemID = tonumber(slot2.benefit_condition)

	slot0:setTicketInfo(slot0.btnSp, slot0.spItemID)
	setText(slot0.spDesc, slot2.desc)
	PlayerPrefs.SetInt(Chapter.GetSPOperationItemCacheKey(slot0.chapter.id), slot0.spItemID)
end

slot0.clearSPBuff = function(slot0)
	slot0.spItemID = nil

	slot0:setSPBtnFormByBuffCount()

	if #slot0:getLegalSPBuffList() == 0 then
		setActive(slot0.btnSp:Find(&quot;item&quot;), false)
	elseif #slot1 == 1 then
		setActive(slot0.btnSp:Find(&quot;item&quot;), true)
		setActive(slot0.spCheckMark, false)
	elseif #slot1 &gt; 1 then
		setActive(slot0.btnSp:Find(&quot;item&quot;), false)
		setText(slot0.spDesc, i18n(&quot;levelScene_select_SP_OP&quot;))
	end
end

slot0.setSPBtnFormByBuffCount = function(slot0)
	if #slot0:getLegalSPBuffList() == 0 then
		setActive(slot0.spItemEmptyBlock, true)
		setActive(slot0.spDesc, false)
		setActive(slot0.spCheckBox, false)
		setActive(slot0.btnSp:Find(&quot;add&quot;), false)
	elseif #slot1 == 1 then
		setActive(slot0.spItemEmptyBlock, false)
		setActive(slot0.spDesc, true)
		setActive(slot0.spCheckBox, true)
		setActive(slot0.btnSp:Find(&quot;add&quot;), false)
	elseif #slot1 &gt; 1 then
		setActive(slot0.spItemEmptyBlock, false)
		setActive(slot0.spDesc, true)
		setActive(slot0.spCheckBox, false)
		setActive(slot0.btnSp:Find(&quot;add&quot;), true)
	end
end

slot0.setTicketInfo = function(slot0, slot1, slot2)
	slot3 = nil
	slot2 = tonumber(slot2)

	for slot7, slot8 in ipairs(slot0.spOPTicketItems) do
		if slot2 == slot8.configId then
			slot3 = slot8

			break
		end
	end

	if slot3 then
		setText(slot1:Find(&quot;item/count&quot;), slot3.count)
		GetImageSpriteFromAtlasAsync(slot3:getConfig(&quot;icon&quot;), &quot;&quot;, slot1:Find(&quot;item/icon&quot;))
	else
		setText(slot1:Find(&quot;item/count&quot;), 0)
		GetImageSpriteFromAtlasAsync(Drop.New({
			type = DROP_TYPE_ITEM,
			id = slot2
		}):getIcon(), &quot;&quot;, slot1:Find(&quot;item/icon&quot;))
	end

	setActive(slot1:Find(&quot;item&quot;), true)
end

slot0.getSPItem = function(slot0)
	return slot0.spItemID
end

slot0.SetDuty = function(slot0, slot1, slot2)
	if not slot2 or not slot0.duties then
		return
	end

	if slot0.duties[slot1] == slot2 then
		return
	end

	slot0.duties[slot1] = slot2
	slot0.duties[3 - slot1] = nil

	slot0:RefreshDutyBar()
end

slot0.UpdateDuties = function(slot0)
	if not slot0.dutyTabEnabled then
		return
	end

	slot1 = 0
	slot2 = 0

	for slot6 = 1, 2 do
		if not slot0:IsListOfFleetEmpty(slot6) then
			slot1 = slot1 + 1
			slot2 = slot6
		end
	end

	if slot1 == 0 then
		table.clear(slot0.duties)
	elseif slot1 == 1 then
		slot0.duties[slot2] = ChapterFleet.DUTY_KILLALL
		slot0.duties[3 - slot2] = nil
	elseif slot1 == 2 then
		if slot0.duties[1] then
			slot0.duties[2] = slot0.duties[1] &lt; 3 and 3 - slot3 or 7 - slot3
		elseif slot0.duties[2] then
			slot0.duties[1] = slot0.duties[2] &lt; 3 and 3 - slot3 or 7 - slot3
		else
			slot0.duties[1] = ChapterFleet.DUTY_CLEANPATH
			slot0.duties[2] = ChapterFleet.DUTY_KILLBOSS
		end
	end

	if slot2 ~= 0 then
		slot3 = &quot;lastFleetDuty_&quot; .. (slot0.chapter.id or 0)
		slot4 = 0
		slot5 = 8

		for slot9, slot10 in ipairs({
			slot2,
			slot0.duties[slot2]
		}) do
			slot4 = slot4 + bit.lshift(slot10, slot5 * (slot9 - 1))
		end

		PlayerPrefs.SetInt(slot3, slot4)
		PlayerPrefs.Save()
	end
end

slot0.RefreshDutyBar = function(slot0)
	slot0:UpdateDuties()
	slot0:UpdateDutyBar()
end

slot0.UpdateDutyBar = function(slot0)
	slot1 = slot0.contextData.tabIndex == uv0.TabIndex.Duty

	for slot5 = 1, 2 do
		setActive(slot0._tf:Find(string.format(&quot;panel/ShipList/fleet/%d/DutySelect&quot;, slot5)), slot1 and slot0.duties[slot5] ~= nil)
	end

	setActive(slot0._tf:Find(&quot;panel/ShipList/sub/1/DutySelect&quot;), slot1 and not slot0:IsListOfFleetEmpty(3))

	if not slot1 then
		return
	end

	for slot6, slot7 in pairs(slot0.duties) do
		for slot11 = 1, 4 do
			setActive(slot0.dutyItems[slot6][slot11]:Find(&quot;Checkmark&quot;), slot11 == slot7)
		end
	end

	slot3 = ys.Battle.BattleState.IsAutoSubActive()

	for slot7 = 1, 2 do
		setActive(slot0.dutyItems[3][slot7]:Find(&quot;Checkmark&quot;), slot7 == 1 == slot3)
	end
end

slot0.GetOrderedDuties = function(slot0)
	if not slot0.duties then
		return
	end

	slot0:UpdateDuties()

	slot1 = {}
	slot2 = 1

	for slot6 = 1, 2 do
		if slot0.duties[slot6] then
			slot1[slot2] = slot0.duties[slot6]
			slot2 = slot2 + 1
		end
	end

	return slot1
end

slot0.SetAutoSub = function(slot0, slot1)
	if tobool(slot1) == ys.Battle.BattleState.IsAutoSubActive() then
		return
	end

	if not AutoBotCommand.autoBotSatisfied() then
		return
	end

	pg.m02:sendNotification(GAME.AUTO_SUB, {
		isActiveSub = not slot1
	})
	slot0:UpdateDutyBar()
end

slot0.GetValidFleets = function(slot0, slot1)
	if slot0.mode == uv0.SELECT then
		slot2 = {}
		slot3 = slot1 and {
			slot1
		} or {
			FleetType.Normal,
			FleetType.Submarine
		}

		for slot7, slot8 in ipairs(slot3) do
			for slot13, slot14 in ipairs(slot0.selectIds[slot8]) do
				if slot14 &gt; 0 then
					table.insert(slot2, slot0.fleets[slot14])
				end
			end
		end

		return slot2
	elseif slot0.mode == uv0.EDIT then
		slot2 = {}
		slot3, slot4 = nil

		if slot1 == FleetType.Normal then
			slot3 = 1
			slot4 = 2
		elseif slot1 == FleetType.Submarine then
			slot3 = 3
			slot4 = 3
		elseif not slot1 then
			slot3 = 1
			slot4 = 3
		end

		for slot8 = slot3, slot4 do
			if #slot0.eliteFleetList[slot8] &gt; 0 then
				slot10 = {}

				for slot14, slot15 in pairs(slot0.eliteCommanderList[slot8]) do
					table.insert(slot10, {
						pos = slot14,
						id = slot15
					})
				end

				table.insert(slot2, TypedFleet.New({
					ship_list = slot9,
					commanders = slot10,
					fleetType = FleetType.Normal
				}))
			end
		end

		return slot2
	end
end

slot0.IsListOfFleetEmpty = function(slot0, slot1)
	if slot1 &gt; 0 and slot1 &lt; 3 and slot0:getLimitNums(FleetType.Normal) &lt; slot1 then
		return true
	elseif slot1 == 3 and slot0:getLimitNums(FleetType.Submarine) &lt; slot1 - 2 then
		return true
	end

	if slot0.mode == uv0.SELECT then
		slot2 = nil

		if slot1 &gt; 0 and slot1 &lt; 3 then
			slot2 = slot0.selectIds[FleetType.Normal][slot1] or 0
		elseif slot1 == 3 then
			slot2 = slot0.selectIds[FleetType.Submarine][slot1 - 2] or 0
		end

		return slot2 == 0
	elseif slot0.mode == uv0.EDIT then
		return #slot0.eliteFleetList[slot1] == 0
	end
end

slot0.GetListFleets = function(slot0)
	slot1 = {}
	slot2 = slot0:getLimitNums(FleetType.Normal)
	slot3 = slot0:getLimitNums(FleetType.Submarine)

	if slot0.mode == uv0.SELECT then
		slot4 = slot0.selectIds[FleetType.Normal]

		for slot8 = 1, slot2 do
			slot9 = slot4[slot8] or 0
			slot1[slot8] = slot9 &gt; 0 and slot0.fleets[slot9] or nil
		end

		slot4 = slot0.selectIds[FleetType.Submarine]

		for slot8 = 1, slot3 do
			slot9 = slot4[slot8] or 0
			slot1[slot8 + slot2] = slot9 &gt; 0 and slot0.fleets[slot9] or nil
		end
	elseif slot0.mode == uv0.EDIT then
		slot4 = {}

		for slot8 = 1, slot2 do
			table.insert(slot4, slot8)
		end

		for slot8 = 1, slot3 do
			table.insert(slot4, slot8 + 2)
		end

		for slot8 = 1, #slot4 do
			slot10 = nil

			if #slot0.eliteFleetList[slot4[slot8]] &gt; 0 then
				slot12 = slot9 &gt; 2 and FleetType.Submarine or FleetType.Normal
				slot13 = {}

				for slot17, slot18 in pairs(slot0.eliteCommanderList[slot9]) do
					table.insert(slot13, {
						pos = slot17,
						id = slot18
					})
				end

				slot10 = TypedFleet.New({
					ship_list = slot11,
					commanders = slot13,
					fleetType = slot12
				})
			end

			slot1[slot8] = slot10
		end
	end

	return slot1
end

slot0.IsSelectMode = function(slot0)
	return slot0.mode == uv0.SELECT
end

slot0.SwitchDisplayMode = function(slot0)
	slot1 = slot0.displayMode == uv0.ADDITION_SUPPORT

	setActive(slot0:findTF(&quot;panel/ShipList/Line&quot;), not slot1)
	setActive(slot0:findTF(&quot;panel/ShipList/support&quot;), slot1)

	slot3 = slot0:findTF(&quot;panel/ShipList&quot;):GetComponent(typeof(VerticalLayoutGroup)).padding
	slot3.top = slot1 and 9 or 20
	slot3.bottom = slot1 and 14 or 25
	slot2.padding = slot3
	slot2.spacing = slot1 and 13 or 20
end

slot0.sortTeamLimitation = function(slot0)
	slot0 = Clone(slot0)

	table.sort(slot0, function (slot0, slot1)
		if type(slot0) == type(slot1) then
			return slot3 &lt; slot2
		elseif slot1 == 0 or slot3 == &quot;string&quot; and slot0 ~= 0 then
			return true
		else
			return false
		end
	end)

	return slot0
end

return slot0
</code></pre>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-lua.min.js"></script>
</body>
</html>