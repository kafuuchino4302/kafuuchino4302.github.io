<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>formationui.lua</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
</head>
<body>
    <h1>formationui.lua</h1>
    <a href="index.html">返回主页</a>
    <pre><code class="language-lua">slot0 = class(&quot;FormationUI&quot;, import(&quot;..base.BaseUI&quot;))
slot0.RADIUS = 60
slot0.LONGPRESS_Y = 30
slot0.INTERVAL = math.pi / 2 / 6
slot0.MAX_FLEET_NUM = 6
slot0.MAX_SHIPP_NUM = 5
slot0.TOGGLE_DETAIL = &quot;_detailToggle&quot;
slot0.TOGGLE_FORMATION = &quot;_formationToggle&quot;
slot0.BUFF_TYEP = {
	blue = &quot;blue&quot;,
	pink = &quot;pink&quot;,
	cyan = &quot;cyan&quot;
}
slot0.TeamNum = {
	&quot;FIRST&quot;,
	&quot;SECOND&quot;,
	&quot;THIRD&quot;,
	&quot;FOURTH&quot;,
	&quot;FIFTH&quot;,
	&quot;SIXTH&quot;
}

slot0.getUIName = function(slot0)
	return &quot;FormationUI&quot;
end

slot0.setPlayer = function(slot0, slot1)
	slot0.player = slot1
end

slot0.setCommanderPrefabFleet = function(slot0, slot1)
	slot0.commanderPrefabFleets = slot1
end

slot0.init = function(slot0)
	slot0.eventTriggers = {}
	slot0._blurLayer = slot0:findTF(&quot;blur_panel&quot;)
	slot0.backBtn = slot0:findTF(&quot;top/back_btn&quot;, slot0._blurLayer)
	slot0._bgFleet = slot0:findTF(&quot;bg_fleet&quot;)
	slot0._bgSub = slot0:findTF(&quot;bg_sub&quot;)
	slot0._bottomPanel = slot0:findTF(&quot;bottom&quot;, slot0._blurLayer)
	slot0._detailToggle = slot0:findTF(&quot;toggle_list/detail_toggle&quot;, slot0._bottomPanel)
	slot0._formationToggle = slot0:findTF(&quot;toggle_list/formation_toggle&quot;, slot0._bottomPanel)
	slot0._nextPage = slot0:findTF(&quot;nextPage&quot;)
	slot0._prevPage = slot0:findTF(&quot;prevPage&quot;)
	slot0._starTpl = slot0:findTF(&quot;star_tpl&quot;)
	slot0._heroInfoTpl = slot0:findTF(&quot;heroInfo&quot;)
	slot4 = slot0._blurLayer
	slot0.topPanel = slot0:findTF(&quot;top&quot;, slot4)
	slot0._gridTFs = {
		[TeamType.Vanguard] = {},
		[TeamType.Main] = {},
		[TeamType.Submarine] = {}
	}
	slot0._gridFrame = slot0:findTF(&quot;GridFrame&quot;)

	for slot4 = 1, 3 do
		slot0._gridTFs[TeamType.Main][slot4] = slot0._gridFrame:Find(&quot;main_&quot; .. slot4)
		slot0._gridTFs[TeamType.Vanguard][slot4] = slot0._gridFrame:Find(&quot;vanguard_&quot; .. slot4)
		slot0._gridTFs[TeamType.Submarine][slot4] = slot0._gridFrame:Find(&quot;submarine_&quot; .. slot4)
	end

	slot0._heroContainer = slot0:findTF(&quot;HeroContainer&quot;)
	slot0._formationLogic = BaseFormation.New(slot0._tf, slot0._heroContainer, slot0._heroInfoTpl, slot0._gridTFs)
	slot0._fleetInfo = slot0:findTF(&quot;fleet_info&quot;, slot0._blurLayer)
	slot0._fleetNumText = slot0:findTF(&quot;fleet_number&quot;, slot0._fleetInfo)
	slot0._fleetNameText = slot0:findTF(&quot;fleet_name/Text&quot;, slot0._fleetInfo)
	slot0._fleetNameEditBtn = slot0:findTF(&quot;edit_btn&quot;, slot0._fleetInfo)
	slot0._renamePanel = slot0:findTF(&quot;changeName_panel&quot;)
	slot0._renameConfirmBtn = slot0._renamePanel:Find(&quot;frame/queren&quot;)
	slot0._renameCancelBtn = slot0._renamePanel:Find(&quot;frame/cancel&quot;)

	setLocalPosition(slot0._renamePanel, {
		z = -45
	})

	slot0._propertyFrame = slot0:findTF(&quot;property_frame&quot;, slot0._blurLayer)
	slot0._cannonPower = slot0:findTF(&quot;cannon/Text&quot;, slot0._propertyFrame)
	slot0._torpedoPower = slot0:findTF(&quot;torpedo/Text&quot;, slot0._propertyFrame)
	slot0._AAPower = slot0:findTF(&quot;antiaircraft/Text&quot;, slot0._propertyFrame)
	slot0._airPower = slot0:findTF(&quot;air/Text&quot;, slot0._propertyFrame)
	slot0._airDominance = slot0:findTF(&quot;ac/Text&quot;, slot0._propertyFrame)
	slot0._cost = slot0:findTF(&quot;cost/Text&quot;, slot0._propertyFrame)
	slot0._mainGS = slot0:findTF(&quot;gear_score/main&quot;)
	slot0._vanguardGS = slot0:findTF(&quot;gear_score/vanguard&quot;)
	slot0._subGS = slot0:findTF(&quot;gear_score/submarine&quot;)
	slot0._arrUpVan = slot0._vanguardGS:Find(&quot;up&quot;)
	slot0._arrDownVan = slot0._vanguardGS:Find(&quot;down&quot;)
	slot0._arrUpMain = slot0._mainGS:Find(&quot;up&quot;)
	slot0._arrDownMain = slot0._mainGS:Find(&quot;down&quot;)
	slot0._arrUpSub = slot0._subGS:Find(&quot;up&quot;)
	slot0._arrDownSub = slot0._subGS:Find(&quot;down&quot;)
	slot0._attrFrame = slot0:findTF(&quot;blur_panel/attr_frame&quot;)
	slot0._cardTpl = slot0._tf:GetComponent(typeof(ItemList)).prefabItem[0]
	slot0._cards = {
		[TeamType.Main] = {},
		[TeamType.Vanguard] = {},
		[TeamType.Submarine] = {}
	}

	setActive(slot0._attrFrame, false)
	setActive(slot0._cardTpl, false)

	slot0.btnRegular = slot0:findTF(&quot;fleet_select/regular&quot;, slot0._bottomPanel)
	slot0._regularEnFllet = slot0:findTF(&quot;fleet/enFleet&quot;, slot0.btnRegular)
	slot0._regularNum = slot0:findTF(&quot;fleet/num&quot;, slot0.btnRegular)
	slot0._regualrCnFleet = slot0:findTF(&quot;fleet/CnFleet&quot;, slot0.btnRegular)
	slot0.btnSub = slot0:findTF(&quot;fleet_select/sub&quot;, slot0._bottomPanel)
	slot0._subEnFllet = slot0:findTF(&quot;fleet/enFleet&quot;, slot0.btnSub)
	slot0._subNum = slot0:findTF(&quot;fleet/num&quot;, slot0.btnSub)
	slot0._subCnFleet = slot0:findTF(&quot;fleet/CnFleet&quot;, slot0.btnSub)
	slot0.fleetToggleMask = slot0:findTF(&quot;blur_panel/list_mask&quot;)
	slot4 = slot0.fleetToggleMask
	slot0.fleetToggleList = slot0:findTF(&quot;list&quot;, slot4)
	slot0.fleetToggles = {}

	for slot4 = 1, uv0.MAX_FLEET_NUM do
		slot0.fleetToggles[slot4] = slot0:findTF(&quot;item&quot; .. slot4, slot0.fleetToggleList)
	end

	slot0._vanGSTxt = slot0._vanguardGS:Find(&quot;Text&quot;):GetComponent(&quot;Text&quot;)
	slot0._mainGSTxt = slot0._mainGS:Find(&quot;Text&quot;):GetComponent(&quot;Text&quot;)
	slot0._subGSTxt = slot0._subGS:Find(&quot;Text&quot;):GetComponent(&quot;Text&quot;)
	slot0.prevMainGS = slot0.contextData.mainGS
	slot0.prevVanGS = slot0.contextData.vanGS
	slot0.prevSubGS = slot0.contextData.subGS
	slot0.mainGSInited = slot0.contextData.mainGS and true or false
	slot0.VanGSInited = slot0.contextData.vanGS and true or false
	slot0.SubGSInited = slot0.contextData.subGS and true or false
	slot0._vanGSTxt.text = slot0.prevVanGS or 0
	slot0._mainGSTxt.text = slot0.prevMainGS or 0
	slot0._subGSTxt.text = slot0.prevSubGS or 0
	slot0.commanderFormationPanel = CommanderFormationPage.New(slot0._tf, slot0.event, slot0.contextData)
	slot0.index = {
		[FleetType.Normal] = 1,
		[FleetType.Submarine] = 1
	}

	setText(findTF(slot0._tf, &quot;gear_score/main/line/Image/text1&quot;), i18n(&quot;pre_combat_main&quot;))
	setText(findTF(slot0._tf, &quot;gear_score/vanguard/line/Image/text1&quot;), i18n(&quot;pre_combat_vanguard&quot;))
	setText(findTF(slot0._tf, &quot;gear_score/submarine/line/Image/text1&quot;), i18n(&quot;pre_combat_submarine&quot;))
end

slot0.setShips = function(slot0, slot1)
	slot0.shipVOs = slot1

	slot0._formationLogic:SetShipVOs(slot0.shipVOs)
end

slot0.SetFleets = function(slot0, slot1)
	slot0._fleetVOs = _(slot1):chain():values():filter(function (slot0)
		return slot0:isRegularFleet()
	end):sort(function (slot0, slot1)
		return slot0.id &lt; slot1.id
	end):value()

	if slot0._currentFleetVO then
		slot0._currentFleetVO = slot0:getFleetById(slot0._currentFleetVO.id)

		slot0._formationLogic:SetFleetVO(slot0._currentFleetVO)
	end
end

slot0.getFleetById = function(slot0, slot1)
	return _.detect(slot0._fleetVOs, function (slot0)
		return slot0.id == uv0
	end)
end

slot0.UpdateFleetView = function(slot0, slot1)
	slot0:displayFleetInfo()
	slot0:updateFleetBg()
	slot0._formationLogic:UpdateGridVisibility()
	slot0._formationLogic:ResetGrid(TeamType.Vanguard)
	slot0._formationLogic:ResetGrid(TeamType.Main)
	slot0._formationLogic:ResetGrid(TeamType.Submarine)
	slot0:resetFormationComponent()
	slot0:updateAttrFrame()
	slot0:updateFleetButton()

	if slot1 then
		slot0._formationLogic:LoadAllCharacter()
	else
		slot0._formationLogic:SetAllCharacterPos()
	end
end

slot0.updateFleetBg = function(slot0)
	setActive(slot0._bgFleet, slot0._currentFleetVO:getFleetType() == FleetType.Normal)
	setActive(slot0._bgSub, slot1 == FleetType.Submarine)
end

slot0.updateFleetButton = function(slot0)
	slot1 = nil
	slot2 = slot0._currentFleetVO:getFleetType()
	slot0.index[slot2] = slot0._currentFleetVO:getIndex()
	slot1 = slot0.index[FleetType.Normal]

	setText(slot0._regularEnFllet, uv0.TeamNum[slot1] .. &quot; FLEET&quot;)
	setText(slot0._regualrCnFleet, Fleet.DEFAULT_NAME[slot1])
	setText(slot0._regularNum, slot1)

	slot1 = slot0.index[FleetType.Submarine]

	setText(slot0._subEnFllet, uv0.TeamNum[slot1] .. &quot; FLEET&quot;)
	setText(slot0._subCnFleet, Fleet.DEFAULT_NAME[slot1])
	setText(slot0._subNum, slot1)
	setActive(slot0.btnRegular:Find(&quot;on&quot;), slot2 == FleetType.Normal)
	setActive(slot0.btnRegular:Find(&quot;off&quot;), slot2 ~= FleetType.Normal)
	setActive(slot0.btnSub:Find(&quot;on&quot;), slot2 == FleetType.Submarine)
	setActive(slot0.btnSub:Find(&quot;off&quot;), slot2 ~= FleetType.Submarine)
end

slot0.SetFleetNameLabel = function(slot0)
	setText(slot0._fleetNameText, slot0.defaultFleetName(slot0._currentFleetVO))
end

slot0.ForceDropChar = function(slot0)
	slot0._formationLogic:ForceDropChar()

	if slot0._currentDragDelegate then
		slot0._forceDropCharacter = true

		LuaHelper.triggerEndDrag(slot0._currentDragDelegate)
	end
end

slot0.quickExitFunc = function(slot0)
	slot0:ForceDropChar()
	slot0:emit(FormationMediator.COMMIT_FLEET, function ()
		GetOrAddComponent(uv0._tf, typeof(CanvasGroup)).interactable = false

		uv0:emit(uv1.ON_HOME)
	end)
end

slot0.didEnter = function(slot0)
	slot0.isOpenCommander = pg.SystemOpenMgr.GetInstance():isOpenSystem(slot0.player.level, &quot;CommanderCatMediator&quot;) and not LOCK_COMMANDER
	slot1 = getProxy(ActivityProxy):getBuffShipList()

	slot0._formationLogic:AddHeroInfoModify(function (slot0, slot1)
		slot2 = slot1:getConfigTable()
		slot3 = pg.ship_data_template[slot1.configId]
		slot4 = findTF(slot0, &quot;info&quot;)
		slot5 = findTF(slot4, &quot;stars&quot;)
		slot6 = findTF(slot4, &quot;energy&quot;)

		for slot11 = 1, slot1:getStar() do
			cloneTplTo(uv0._starTpl, slot5)
		end

		if not GetSpriteFromAtlas(&quot;shiptype&quot;, shipType2print(slot1:getShipType())) then
			warning(&quot;找不到船形, shipConfigId: &quot; .. slot1.configId)
		end

		setImageSprite(findTF(slot4, &quot;type&quot;), slot8, true)
		setText(findTF(slot4, &quot;frame/lv_contain/lv&quot;), slot1.level)

		if slot1.energy &lt;= Ship.ENERGY_MID then
			setImageSprite(slot6, GetSpriteFromAtlas(&quot;energy&quot;, slot1:getEnergyPrint()))
			setActive(slot6, true)
		end

		setActive(slot4:Find(&quot;expbuff&quot;), uv1[slot1:getGroupId()] ~= nil)

		if slot9 then
			slot13 = tostring(slot9 / 100)

			if slot9 % 100 &gt; 0 then
				slot13 = slot13 .. &quot;.&quot; .. tostring(slot12)
			end

			setText(slot10:Find(&quot;text&quot;), string.format(&quot;EXP +%s%%&quot;, slot13))
		end
	end)
	slot0._formationLogic:AddLongPress(function (slot0, slot1, slot2)
		uv0:emit(FormationMediator.OPEN_SHIP_INFO, slot1.id, uv0._currentFleetVO, uv1.TOGGLE_FORMATION)
		pg.CriMgr.GetInstance():PlaySoundEffect_V3(SFX_PANEL)
	end)
	slot0._formationLogic:AddClick(function (slot0, slot1)
		uv0:emit(FormationMediator.CHANGE_FLEET_SHIP, slot0, uv0._currentFleetVO, uv1.TOGGLE_FORMATION, slot1)
		pg.CriMgr.GetInstance():PlaySoundEffect_V3(SFX_PANEL)
	end)
	slot0._formationLogic:AddBeginDrag(function (slot0)
		SetActive(findTF(slot0, &quot;info&quot;), false)
	end)
	slot0._formationLogic:AddEndDrag(function (slot0)
		SetActive(findTF(slot0, &quot;info&quot;), true)
	end)
	slot0._formationLogic:AddShiftOnly(function (slot0)
		uv0:emit(FormationMediator.CHANGE_FLEET_SHIPS_ORDER, slot0)
	end)
	slot0._formationLogic:AddRemoveShip(function (slot0, slot1)
		uv0:emit(FormationMediator.REMOVE_SHIP, slot0, slot1)
	end)
	slot0._formationLogic:AddCheckRemove(function (slot0, slot1, slot2, slot3, slot4)
		if not slot3:canRemove(slot2) then
			slot5, slot6 = slot3:getShipPos(slot2)

			pg.TipsMgr.GetInstance():ShowTips(i18n(&quot;ship_formationUI_removeError_onlyShip&quot;, slot2:getConfigTable().name, slot3.name, Fleet.C_TEAM_NAME[slot6]))
			slot0()
		else
			pg.MsgboxMgr.GetInstance():ShowMsgBox({
				hideNo = false,
				zIndex = -30,
				content = i18n(&quot;ship_formationUI_quest_remove&quot;, slot2:getName()),
				onYes = slot1,
				onNo = slot0
			})
		end
	end)
	slot0._formationLogic:AddGridTipClick(function (slot0, slot1)
		uv0:emit(FormationMediator.CHANGE_FLEET_SHIP, nil, slot1, uv1.TOGGLE_FORMATION, slot0)
	end)
	onButton(slot0, slot0.backBtn, function ()
		uv0:ForceDropChar()

		if uv0._attrFrame.gameObject.activeSelf then
			triggerToggle(uv0._formationToggle, true)
		else
			uv0:emit(FormationMediator.COMMIT_FLEET, function ()
				GetOrAddComponent(uv0._tf, typeof(CanvasGroup)).interactable = false

				uv0:emit(uv1.ON_BACK)
			end)
		end
	end, SOUND_BACK)
	setActive(slot0:findTF(&quot;stamp&quot;), BATTLE_DEBUG or getProxy(TaskProxy):mingshiTouchFlagEnabled())

	if LOCK_CLICK_MINGSHI then
		setActive(slot0:findTF(&quot;stamp&quot;), false)
	end

	onButton(slot0, slot0:findTF(&quot;stamp&quot;), function ()
		if BATTLE_DEBUG then
			print(uv0._currentFleetVO:genRobotDataString())
		end

		getProxy(TaskProxy):dealMingshiTouchFlag(6)
	end, SFX_CONFIRM)
	onButton(slot0, slot0._fleetNameEditBtn, function ()
		uv0:DisplayRenamePanel(true)
	end, SFX_PANEL)
	onButton(slot0, slot0._renameConfirmBtn, function ()
		uv0:emit(FormationMediator.CHANGE_FLEET_NAME, uv0._currentFleetVO.id, getInputText(findTF(uv0._renamePanel, &quot;frame/name_field&quot;)))
	end, SFX_CONFIRM)
	onButton(slot0, slot0._renameCancelBtn, function ()
		uv0:DisplayRenamePanel(false)
	end, SFX_CANCEL)
	onToggle(slot0, slot0._detailToggle, function (slot0)
		uv0:ForceDropChar()

		if slot0 then
			uv0:displayAttrFrame()
		end
	end, SFX_PANEL)
	onToggle(slot0, slot0._formationToggle, function (slot0)
		uv0:ForceDropChar()

		if slot0 then
			uv0:hideAttrFrame()
		end
	end, SFX_PANEL)
	onButton(slot0, slot0._attrFrame, function ()
		triggerToggle(uv0._formationToggle, true)
	end, SFX_PANEL)
	onButton(slot0, slot0.fleetToggleMask, function ()
		setActive(uv0.fleetToggleMask, false)
		uv0:tweenTabArrow(true)
	end, SFX_CANCEL)
	onButton(slot0, slot0.btnRegular, function ()
		uv0:updateToggleList(_.filter(uv0._fleetVOs, function (slot0)
			return slot0:getFleetType() == FleetType.Normal
		end))
		triggerToggle(uv0.fleetToggles[uv0.index[FleetType.Normal]], true)

		if uv0._currentFleetVO:getFleetType() == FleetType.Normal then
			setActive(uv0.fleetToggleMask, true)
			uv0:tweenTabArrow(false)
			setAnchoredPosition(uv0.fleetToggleList, Vector3.New(209, 129))
		end
	end, SFX_PANEL)
	onButton(slot0, slot0.btnSub, function ()
		uv0:updateToggleList(_.filter(uv0._fleetVOs, function (slot0)
			return slot0:getFleetType() == FleetType.Submarine
		end))
		triggerToggle(uv0.fleetToggles[uv0.index[FleetType.Submarine]], true)

		if uv0._currentFleetVO:getFleetType() == FleetType.Submarine then
			setActive(uv0.fleetToggleMask, true)
			uv0:tweenTabArrow(false)
			setAnchoredPosition(uv0.fleetToggleList, Vector3.New(755, 129))
		end
	end, SFX_PANEL)
	onButton(slot0, slot0._prevPage, function ()
		uv0:ForceDropChar()
		uv0:emit(FormationMediator.ON_CHANGE_FLEET, uv0:selectFleetByStep(-1))
	end, SFX_PANEL)
	onButton(slot0, slot0._nextPage, function ()
		uv0:ForceDropChar()
		uv0:emit(FormationMediator.ON_CHANGE_FLEET, uv0:selectFleetByStep(1))
	end, SFX_PANEL)
	slot0:SetCurrentFleetID(defaultValue(slot0.contextData.number, 1))

	if slot0.isOpenCommander then
		slot0.commanderFormationPanel:ActionInvoke(&quot;Show&quot;)
	end

	slot0:UpdateFleetView(true)
	triggerToggle(slot0[slot0.contextData.toggle or uv0.TOGGLE_FORMATION], true)
	slot0:tweenTabArrow(true)
	onButton(slot0, slot0._vanguardGS:Find(&quot;SonarTip&quot;), function ()
		pg.MsgboxMgr.GetInstance():ShowMsgBox({
			type = MSGBOX_TYPE_HELP,
			helps = pg.gametip.fleet_antisub_range_tip.tip
		})
	end, SFX_PANEL)
end

slot0.SetCurrentFleetID = function(slot0, slot1)
	slot0._currentFleetVO = slot0:getFleetById(slot1)

	slot0._formationLogic:SetFleetVO(slot0._currentFleetVO)
	slot0:updateCommanderFormation()
end

slot0.updateCommanderFormation = function(slot0)
	if slot0.isOpenCommander then
		slot0.commanderFormationPanel:Load()
		slot0.commanderFormationPanel:ActionInvoke(&quot;Update&quot;, slot0._currentFleetVO, slot0.commanderPrefabFleets)
	end
end

slot0.selectFleetByStep = function(slot0, slot1)
	slot2 = table.indexof(slot0._fleetVOs, slot0._currentFleetVO)

	while true do
		if slot2 + slot1 &lt; 1 or slot2 &gt; #slot0._fleetVOs then
			break
		end

		if slot0._fleetVOs[slot2]:isUnlock() then
			return slot3.id
		end
	end
end

slot0.updateToggleList = function(slot0, slot1)
	slot0.fleetToggleList:GetComponent(typeof(ToggleGroup)).allowSwitchOff = true
	slot3 = slot0._currentFleetVO.id

	for slot7 = 1, #slot0.fleetToggles do
		slot9 = slot1[slot7]

		setActive(slot0.fleetToggles[slot7], slot9)

		if slot9 then
			slot10 = slot8:GetComponent(typeof(Toggle))
			slot12, slot13 = slot9:isUnlock()

			setToggleEnabled(slot8, slot12)
			setActive(slot8:Find(&quot;lock&quot;), not slot12)
			setActive(slot8:Find(&quot;on&quot;), slot12 and slot3 == slot9.id)
			setActive(slot8:Find(&quot;off&quot;), slot12 and slot3 ~= slot9.id)

			if slot12 then
				slot10.isOn = slot9.id == slot3

				onToggle(slot0, slot8, function (slot0)
					if slot0 then
						setActive(uv0.fleetToggleMask, false)
						uv0:tweenTabArrow(true)

						if uv1.id ~= uv2 then
							uv0:ForceDropChar()
							uv0:emit(FormationMediator.ON_CHANGE_FLEET, uv1.id)
						end
					end
				end, SFX_UI_TAG)
			else
				onButton(slot0, slot11, function ()
					pg.TipsMgr.GetInstance():ShowTips(uv0)
				end, SFX_UI_CLICK)
			end
		end
	end

	slot2.allowSwitchOff = false
end

slot0.resetFormationComponent = function(slot0)
	SetActive(slot0._gridTFs.main[1]:Find(&quot;flag&quot;), #slot0._currentFleetVO:getTeamByName(TeamType.Main) ~= 0)
	SetActive(slot0._gridTFs.submarine[1]:Find(&quot;flag&quot;), #slot0._currentFleetVO:getTeamByName(TeamType.Submarine) ~= 0)
end

slot0.sortCardSiblingIndex = function(slot0)
	_.each({
		TeamType.Main,
		TeamType.Vanguard,
		TeamType.Submarine
	}, function (slot0)
		if #uv0._cards[slot0] &gt; 0 then
			for slot5 = 1, #slot1 do
				slot1[slot5].tr:SetSiblingIndex(slot5 - 1)
			end
		end
	end)
end

slot0.displayFleetInfo = function(slot0)
	SetActive(slot0._prevPage, slot0:selectFleetByStep(-1))
	SetActive(slot0._nextPage, slot0:selectFleetByStep(1))
	setActive(slot0:findTF(&quot;gear_score&quot;), true)
	setActive(slot0._vanguardGS, false)
	setActive(slot0._mainGS, false)
	setActive(slot0._subGS, false)

	slot1 = slot0._currentFleetVO:GetPropertiesSum()
	slot2 = math.floor(slot0._currentFleetVO:GetGearScoreSum(TeamType.Vanguard))
	slot3 = math.floor(slot0._currentFleetVO:GetGearScoreSum(TeamType.Main))
	slot4 = math.floor(slot0._currentFleetVO:GetGearScoreSum(TeamType.Submarine))

	slot0.tweenNumText(slot0._cannonPower, slot1.cannon)
	slot0.tweenNumText(slot0._torpedoPower, slot1.torpedo)
	slot0.tweenNumText(slot0._AAPower, slot1.antiAir)
	slot0.tweenNumText(slot0._airPower, slot1.air)
	slot0.tweenNumText(slot0._cost, slot0._currentFleetVO:GetCostSum().oil)

	if OPEN_AIR_DOMINANCE then
		setActive(slot0._airDominance.parent, true)
		slot0.tweenNumText(slot0._airDominance, slot0._currentFleetVO:getFleetAirDominanceValue())
	else
		setActive(slot0._airDominance.parent, false)
	end

	if slot0._currentFleetVO:getFleetType() == FleetType.Normal then
		setActive(slot0._vanguardGS, true)
		setActive(slot0._mainGS, true)
		setActive(slot0._arrUpVan, false)
		setActive(slot0._arrDownVan, false)
		setActive(slot0._arrUpMain, false)
		setActive(slot0._arrDownMain, false)

		slot0.prevVanGS = tonumber(slot0._vanGSTxt.text)

		slot0.tweenNumText(slot0._vanguardGS:Find(&quot;Text&quot;), slot2)

		if slot0.VanGSInited then
			setActive(slot0._arrUpVan, slot0.prevVanGS &lt; slot2)
			setActive(slot0._arrDownVan, slot2 &lt; slot0.prevVanGS)
		end

		slot0.prevMainGS = tonumber(slot0._mainGSTxt.text)

		slot0.tweenNumText(slot0._mainGS:Find(&quot;Text&quot;), slot3)

		if slot0.mainGSInited then
			setActive(slot0._arrUpMain, slot0.prevMainGS &lt; slot3)
			setActive(slot0._arrDownMain, slot3 &lt; slot0.prevMainGS)
		end

		slot0.contextData.mainGS = slot3
		slot0.contextData.vanGS = slot2
		slot0.mainGSInited = true
		slot0.VanGSInited = true

		setActive(slot0._vanguardGS:Find(&quot;SonarActive&quot;), slot0._currentFleetVO:GetFleetSonarRange() &gt; 0)
		setActive(slot0._vanguardGS:Find(&quot;SonarInactive&quot;), slot7 &lt;= 0)

		slot8 = function()
			pg.MsgboxMgr.GetInstance():ShowMsgBox({
				type = MSGBOX_TYPE_HELP,
				helps = pg.gametip.fleet_antisub_range_tip.tip
			})
		end

		if slot7 &gt; 0 then
			setText(slot0._vanguardGS:Find(&quot;SonarActive/Text&quot;), math.floor(slot7))
			onButton(slot0, slot0._vanguardGS:Find(&quot;SonarActive&quot;), slot8, SFX_PANEL)
		else
			onButton(slot0, slot0._vanguardGS:Find(&quot;SonarInactive&quot;), slot8, SFX_PANEL)
		end
	elseif slot6 == FleetType.Submarine then
		setActive(slot0._arrUpSub, false)
		setActive(slot0._arrDownSub, false)
		setActive(slot0._subGS, true)

		slot0.prevSubGS = tonumber(slot0._subGSTxt.text)

		slot0.tweenNumText(slot0._subGS:Find(&quot;Text&quot;), slot4)

		if slot0.SubGSInited then
			setActive(slot0._arrUpSub, slot0.prevSubGS &lt; slot4)
			setActive(slot0._arrDownSub, slot4 &lt; slot0.prevSubGS)
		end

		slot0.contextData.subGS = slot4
		slot0.SubGSInited = true
	end

	slot0:SetFleetNameLabel()
	setText(slot0._fleetNumText, slot0._currentFleetVO:getIndex())
end

slot0.DisplayRenamePanel = function(slot0, slot1)
	SetActive(slot0._renamePanel, slot1)

	if slot1 then
		pg.UIMgr.GetInstance():BlurPanel(slot0._renamePanel, false)
		setInputText(findTF(slot0._renamePanel, &quot;frame/name_field&quot;), getText(slot0._fleetNameText))
	else
		pg.UIMgr.GetInstance():UnblurPanel(slot0._renamePanel, slot0._tf)
	end
end

slot0.hideAttrFrame = function(slot0)
	SetActive(slot0._attrFrame, false)
	pg.UIMgr.GetInstance():UnblurPanel(slot0._blurLayer, slot0._tf)
end

slot0.displayAttrFrame = function(slot0)
	pg.UIMgr.GetInstance():BlurPanel(slot0._blurLayer, false)
	SetActive(slot0._attrFrame, true)
	slot0:initAttrFrame()
end

slot0.initAttrFrame = function(slot0)
	slot2 = false

	for slot6, slot7 in pairs({
		[TeamType.Main] = slot0._currentFleetVO.mainShips,
		[TeamType.Vanguard] = slot0._currentFleetVO.vanguardShips,
		[TeamType.Submarine] = slot0._currentFleetVO.subShips
	}) do
		if #slot0._cards[slot6] == 0 then
			slot9 = slot0:findTF(slot6 .. &quot;/list&quot;, slot0._attrFrame)

			for slot13 = 1, 3 do
				table.insert(slot8, FormationDetailCard.New(cloneTplTo(slot0._cardTpl, slot9).gameObject))
			end

			slot2 = true
		end
	end

	if slot2 then
		slot0:updateAttrFrame()
	end
end

slot0.updateAttrFrame = function(slot0)
	slot2 = slot0._currentFleetVO:getFleetType()

	for slot6, slot7 in pairs({
		[TeamType.Main] = slot0._currentFleetVO.mainShips,
		[TeamType.Vanguard] = slot0._currentFleetVO.vanguardShips,
		[TeamType.Submarine] = slot0._currentFleetVO.subShips
	}) do
		if #slot0._cards[slot6] &gt; 0 then
			slot9 = slot2 == FleetType.Submarine and slot6 == TeamType.Vanguard

			for slot13 = 1, 3 do
				if slot13 &lt;= #slot7 then
					slot14 = slot0.shipVOs[slot7[slot13]]

					slot8[slot13]:update(slot14, slot9)
					slot8[slot13]:updateProps(slot0:getCardAttrProps(slot14))
				else
					slot8[slot13]:update(nil, slot9)
				end

				slot0:detachOnCardButton(slot8[slot13])

				if not slot9 then
					slot0:attachOnCardButton(slot8[slot13], slot6)
				end
			end
		end
	end

	setActive(slot0:findTF(TeamType.Main, slot0._attrFrame), slot2 == FleetType.Normal)
	setActive(slot0:findTF(TeamType.Submarine, slot0._attrFrame), slot2 == FleetType.Submarine)
	setActive(slot0:findTF(TeamType.Vanguard .. &quot;/vanguard&quot;, slot0._attrFrame), slot2 ~= FleetType.Submarine)
	slot0:updateUltimateTitle()
end

slot0.updateUltimateTitle = function(slot0)
	slot2 = slot0._currentFleetVO.mainShips

	if #slot0._cards[TeamType.Main] &gt; 0 then
		for slot6 = 1, #slot1 do
			go(slot1[slot6].shipState):SetActive(slot6 == 1)
		end
	end
end

slot0.getCardAttrProps = function(slot0, slot1)
	return {
		{
			i18n(&quot;word_attr_durability&quot;),
			tostring(math.floor(slot1:getProperties().durability))
		},
		{
			i18n(&quot;word_attr_luck&quot;),
			&quot;&quot; .. tostring(math.floor(slot1:getBattleTotalExpend()))
		},
		{
			i18n(&quot;word_synthesize_power&quot;),
			&quot;&lt;color=#ffff00&gt;&quot; .. slot1:getShipCombatPower() .. &quot;&lt;/color&gt;&quot;
		}
	}
end

slot0.detachOnCardButton = function(slot0, slot1)
	slot2 = GetOrAddComponent(slot1.go, &quot;EventTriggerListener&quot;)

	slot2:RemovePointClickFunc()
	slot2:RemoveBeginDragFunc()
	slot2:RemoveDragFunc()
	slot2:RemoveDragEndFunc()
end

slot0.attachOnCardButton = function(slot0, slot1, slot2)
	slot3 = GetOrAddComponent(slot1.go, &quot;EventTriggerListener&quot;)
	slot0.eventTriggers[slot3] = true

	slot3:AddPointClickFunc(function (slot0, slot1)
		if not uv0.carddrag and slot0 == uv1.go then
			if uv1.shipVO then
				uv0:emit(FormationMediator.OPEN_SHIP_INFO, uv1.shipVO.id, uv0._currentFleetVO, uv2.TOGGLE_DETAIL)
			else
				uv0:emit(FormationMediator.CHANGE_FLEET_SHIP, uv1.shipVO, uv0._currentFleetVO, uv2.TOGGLE_DETAIL, uv3)
			end

			pg.CriMgr.GetInstance():PlaySoundEffect_V3(SFX_PANEL)
		end
	end)

	if slot1.shipVO then
		slot4 = slot0._cards[slot2]
		slot5 = slot1.tr.parent
		slot5 = slot5:GetComponent(&quot;ContentSizeFitter&quot;)
		slot6 = slot1.tr.parent
		slot6 = slot6:GetComponent(&quot;HorizontalLayoutGroup&quot;)
		slot7 = slot1.tr.rect.width * 0.5
		slot8 = {}

		slot3:AddBeginDragFunc(function ()
			if uv0.carddrag then
				return
			end

			uv0._currentDragDelegate = uv1
			uv0.carddrag = uv2
			uv3.enabled = false
			uv4.enabled = false

			uv2.tr:SetSiblingIndex(#uv5)

			for slot3 = 1, #uv5 do
				if uv5[slot3] == uv2 then
					uv0._shiftIndex = slot3
				end

				uv6[slot3] = uv5[slot3].tr.anchoredPosition
			end

			LeanTween.scale(uv2.paintingTr, Vector3(1.1, 1.1, 0), 0.3)
		end)
		slot3:AddDragFunc(function (slot0, slot1)
			if uv0.carddrag ~= uv1 then
				return
			end

			slot2 = uv1.tr.localPosition
			slot2.x = uv0:change2ScrPos(uv1.tr.parent, slot1.position).x
			uv1.tr.localPosition = slot2
			slot3 = 1

			for slot7 = 1, #uv2 do
				if uv2[slot7] ~= uv1 and uv2[slot7].shipVO and uv1.tr.localPosition.x &gt; uv2[slot7].tr.localPosition.x + (slot3 &lt; uv0._shiftIndex and 1.1 or -1.1) * uv3 then
					slot3 = slot3 + 1
				end
			end

			if uv0._shiftIndex ~= slot3 then
				uv0._formationLogic:Shift(uv0._shiftIndex, slot3, uv4)

				slot7 = slot3

				uv0:shiftCard(uv0._shiftIndex, slot7, uv4)

				for slot7 = 1, #uv2 do
					if uv2[slot7] and uv2[slot7] ~= uv1 then
						uv2[slot7].tr.anchoredPosition = uv5[slot7]
					end
				end
			end
		end)
		slot3:AddDragEndFunc(function (slot0, slot1)
			if uv0.carddrag ~= uv1 then
				return
			end

			resetCard = function()
				for slot3 = 1, #uv0 do
					uv0[slot3].tr.anchoredPosition = uv1[slot3]
				end

				uv2.enabled = true
				uv3.enabled = true
				uv4._shiftIndex = nil

				uv4:updateUltimateTitle()
				uv4._formationLogic:SortSiblingIndex()
				uv4:sortCardSiblingIndex()
				uv4:emit(FormationMediator.CHANGE_FLEET_SHIPS_ORDER, uv4._currentFleetVO)

				uv5.enabled = true
				uv4.carddrag = nil
			end

			uv0._forceDropCharacter = nil
			uv0._currentDragDelegate = nil
			uv6.enabled = false

			if uv0._forceDropCharacter then
				resetCard()

				uv1.paintingTr.localScale = Vector3(1, 1, 0)
			else
				slot4 = LeanTween.value(uv1.go, uv1.tr.anchoredPosition.x, uv3[uv0._shiftIndex].x, math.min(math.abs(uv1.tr.anchoredPosition.x - uv3[uv0._shiftIndex].x) / 200, 1) * 0.3)
				slot4 = slot4:setEase(LeanTweenType.easeOutCubic)
				slot4 = slot4:setOnUpdate(System.Action_float(function (slot0)
					slot1 = uv0.tr.anchoredPosition
					slot1.x = slot0
					uv0.tr.anchoredPosition = slot1
				end))

				slot4:setOnComplete(System.Action(function ()
					resetCard()
					LeanTween.scale(uv0.paintingTr, Vector3(1, 1, 0), 0.3)
				end))
			end
		end)
	end
end

slot0.shiftCard = function(slot0, slot1, slot2, slot3)
	if #slot0._cards[slot3] &gt; 0 then
		slot4[slot2] = slot4[slot1]
		slot4[slot1] = slot4[slot2]
	end

	slot0._shiftIndex = slot2
end

slot0.change2ScrPos = function(slot0, slot1, slot2)
	return LuaHelper.ScreenToLocal(slot1, slot2, pg.UIMgr.GetInstance().overlayCameraComp)
end

slot0.tweenNumText = function(slot0, slot1, slot2, slot3, slot4)
	LeanTween.value(go(slot0), slot4 or 0, math.floor(slot1), slot2 or 0.7):setOnUpdate(System.Action_float(function (slot0)
		setText(uv0, math.floor(slot0))
	end)):setOnComplete(System.Action(function ()
		if uv0 then
			uv0()
		end
	end))
end

slot0.defaultFleetName = function(slot0)
	if slot0.name == &quot;&quot; or slot0.name == nil then
		return Fleet.DEFAULT_NAME[slot0.id]
	else
		return slot0.name
	end
end

slot0.GetFleetCount = function(slot0)
	slot1 = 0

	for slot5, slot6 in pairs(slot0._fleetVOs) do
		slot1 = slot1 + 1
	end

	return slot1
end

slot0.tweenTabArrow = function(slot0, slot1)
	setActive(slot0.btnRegular:Find(&quot;arr&quot;), slot1)
	setActive(slot0.btnSub:Find(&quot;arr&quot;), slot1)

	if slot1 then
		LeanTween.moveLocalY(go(slot2), slot2.localPosition.y + 8, 0.8):setEase(LeanTweenType.easeInOutSine):setLoopPingPong(-1)
		LeanTween.moveLocalY(go(slot3), slot3.localPosition.y + 8, 0.8):setEase(LeanTweenType.easeInOutSine):setLoopPingPong(-1)
	else
		LeanTween.cancel(go(slot2))
		LeanTween.cancel(go(slot3))

		slot4 = slot2.localPosition
		slot4.y = 80
		slot2.localPosition = slot4
		slot5 = slot3.localPosition
		slot5.y = 80
		slot3.localPosition = slot5
	end
end

slot0.recyclePainting = function(slot0)
	for slot4, slot5 in pairs(slot0._cards) do
		for slot9, slot10 in ipairs(slot5) do
			slot10:clear()
		end
	end
end

slot0.onBackPressed = function(slot0)
	pg.CriMgr.GetInstance():PlaySoundEffect_V3(SFX_CANCEL)

	if isActive(slot0._renamePanel) then
		slot0:DisplayRenamePanel(false)
	else
		triggerButton(slot0.backBtn)
	end
end

slot0.willExit = function(slot0)
	slot0.commanderFormationPanel:Destroy()

	if slot0._attrFrame.gameObject.activeSelf then
		pg.UIMgr.GetInstance():UnblurPanel(slot0._blurLayer, slot0._tf)
	end

	slot0._formationLogic:Destroy()
	slot0:recyclePainting()
	slot0:DisplayRenamePanel(false)
	slot0:tweenTabArrow(false)

	if slot0.tweens then
		cancelTweens(slot0.tweens)
	end

	if slot0.eventTriggers then
		for slot4, slot5 in pairs(slot0.eventTriggers) do
			ClearEventTrigger(slot4)
		end

		slot0.eventTriggers = nil
	end
end

return slot0
</code></pre>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-lua.min.js"></script>
</body>
</html>