<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>guildmissionbosspage.lua</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
</head>
<body>
    <h1>guildmissionbosspage.lua</h1>
    <a href="index.html">返回主页</a>
    <pre><code class="language-lua">slot0 = class(&quot;GuildMissionBossPage&quot;, import(&quot;....base.BaseSubView&quot;))

slot0.getUIName = function(slot0)
	return &quot;GuildMissionBossPage&quot;
end

slot0.OnLoaded = function(slot0)
	slot0.hp = slot0:findTF(&quot;hp/bar&quot;)
	slot0.hpProgress = slot0:findTF(&quot;hp/bar/Text&quot;):GetComponent(typeof(Text))
	slot0.hpL = slot0.hp.rect.width
	slot0.titleTxt = slot0:findTF(&quot;title&quot;):GetComponent(typeof(Text))
	slot0.assaultBtn = slot0:findTF(&quot;btn_a_formation&quot;)
	slot0.battleBtn = slot0:findTF(&quot;btn_go&quot;)
	slot0.reportBtn = slot0:findTF(&quot;btn_report&quot;)
	slot0.reportTip = slot0:findTF(&quot;btn_report/tip&quot;)
	slot0.reportTipTxt = slot0:findTF(&quot;btn_report/tip/Text&quot;):GetComponent(typeof(Text))
	slot0.cntTxt = slot0:findTF(&quot;btn_go/cnt/Text&quot;):GetComponent(typeof(Text))
	slot0.rankList = UIItemList.New(slot0:findTF(&quot;rank/content&quot;), slot0:findTF(&quot;rank/content/tpl&quot;))
	slot0.paintingTF = slot0:findTF(&quot;painting&quot;)
	slot0.prefabTF = slot0:findTF(&quot;prefab&quot;)
	slot0.viewAllBtn = slot0:findTF(&quot;rank/view_all&quot;)
	slot0.allRankPage = GuildBossRankPage.New(slot0._parentTf, slot0.event)

	setActive(slot0.viewAllBtn, PLATFORM_CODE ~= PLATFORM_JP)

	slot0.eventTimerTxt = slot0:findTF(&quot;timer/Text&quot;):GetComponent(typeof(Text))

	setText(slot0:findTF(&quot;timer/label&quot;), i18n(&quot;guild_time_remaining_tip&quot;))

	slot0.timeView = GuildEventTimerView.New()
end

slot0.OnInit = function(slot0)
	onButton(slot0, slot0.assaultBtn, function ()
		uv0:emit(GuildEventLayer.OPEN_BOSS_ASSULT)
	end, SFX_PANEL)
	onButton(slot0, slot0.battleBtn, function ()
		if not uv0:ExistActiveEvent() then
			pg.TipsMgr.GetInstance():ShowTips(i18n(&quot;guild_battle_is_end&quot;))

			return
		end

		if uv0.bossMission:IsReachDailyCnt() then
			pg.TipsMgr.GetInstance():ShowTips(i18n(&quot;guild_boss_cnt_no_enough&quot;))

			return
		end

		if uv0.bossMission:IsDeath() then
			pg.TipsMgr.GetInstance():ShowTips(i18n(&quot;guild_battle_is_end&quot;))

			return
		end

		uv0:emit(GuildEventLayer.ON_OPEN_BOSS_FORMATION, uv0.bossMission)
	end, SFX_PANEL)
	onButton(slot0, slot0.reportBtn, function ()
		uv0:emit(GuildEventMediator.ON_OPEN_REPORT)
	end, SFX_PANEL)
end

slot0.UpdateMission = function(slot0, slot1)
	slot0.bossMission = slot1
end

slot0.OnReportUpdated = function(slot0)
	setActive(slot0.reportTip, #_.select(_.values(getProxy(GuildProxy):GetReports()), function (slot0)
		return slot0:CanSubmit()
	end) &gt; 0)

	if #slot2 &gt; 0 then
		slot0.reportTipTxt.text = #slot2
	end
end

slot0.Show = function(slot0, slot1)
	slot0:UpdateMission(slot1)
	slot0:InitRanks()
	slot0:UpdateView()
	slot0:UpdatePainting()

	if slot0.contextData.editBossFleet then
		triggerButton(slot0.battleBtn)
	end

	setActive(slot0.battleBtn:Find(&quot;selected&quot;), slot1:IsReachDailyCnt())
	slot0:OnReportUpdated()

	slot0.titleTxt.text = slot1:getConfig(&quot;name&quot;)

	slot0:CheckFleetShipState()
	slot0.timeView:Flush(slot0.eventTimerTxt, getProxy(GuildProxy):getRawData():GetActiveEvent())
end

slot0.CheckFleetShipState = function(slot0)
	slot1 = slot0.bossMission
	slot3 = {}

	for slot7, slot8 in ipairs({
		slot1:GetMainFleet(),
		slot1:GetSubFleet()
	}) do
		if slot8:ExistInvailShips() or slot8:ExistInvalidCommanders() then
			table.insert(slot3, slot8)
		end
	end

	if #slot3 &gt; 0 then
		slot8 = &quot;guild_boss_formation_exist_invaild_ship&quot;
		slot7 = i18n(slot8)

		pg.MsgboxMgr:GetInstance():ShowMsgBox({
			hideNo = true,
			content = slot7
		})

		slot0.contextData.editBossFleet = {}

		for slot7, slot8 in ipairs(slot3) do
			slot0.contextData.editBossFleet[slot8.id] = slot8
		end

		slot0:emit(GuildEventMediator.ON_CLEAR_BOSS_FLEET_INVAILD_SHIP)
	end
end

slot0.UpdateView = function(slot0)
	if getProxy(GuildProxy):ShouldRefreshBoss() then
		slot0:emit(GuildEventMediator.ON_GET_BOSS_INFO)
	else
		slot0:UpdateBossInfo()
		slot0:AddBossTimer()
		uv0.super.Show(slot0)
	end
end

slot0.UpdatePainting = function(slot0)
	if slot0.bossMission:GetPainting() and slot2 ~= &quot;&quot; then
		setGuildPaintingPrefab(slot0.paintingTF, slot2, &quot;chuanwu&quot;, nil)
	else
		slot4 = slot1:GetEmenyId()

		LoadSpriteAsync(&quot;guildboss/&quot; .. slot4, function (slot0)
			if uv0:CheckState(BaseSubView.STATES.DESTROY) then
				return
			end

			if slot0 then
				slot1 = GetOrAddComponent(uv0.prefabTF:Find(&quot;frame/model&quot;), &quot;Image&quot;)
				slot1.sprite = slot0

				slot1:SetNativeSize()
			end
		end)

		slot5 = slot0:findTF(&quot;name/Image&quot;, slot0.prefabTF):GetComponent(typeof(Image))
		slot5.sprite = GetSpriteFromAtlas(&quot;guildboss/name_&quot; .. slot4, &quot;&quot;)

		slot5:SetNativeSize()
	end

	setActive(slot0.paintingTF, slot3)
	setActive(slot0.prefabTF, not slot3)
end

slot0.UpdateBossInfo = function(slot0)
	slot1 = slot0.bossMission
	slot4 = slot1:GetHp() / math.max(slot1:GetTotalHp(), 1)
	slot6 = tf(slot0.hp)
	slot6.sizeDelta = Vector2(slot0.hpL * slot4, slot6.sizeDelta.y)
	slot4 = slot4 * 100
	slot0.hpProgress.text = math.max(slot4 - slot4 % 0.1, 1) .. &quot;%&quot;
	slot0.cntTxt.text = &quot;&lt;color=&quot; .. (slot1:GetCanUsageCnt() &gt; 0 and COLOR_GREEN or COLOR_RED) .. &quot;&gt;&quot; .. slot7 .. &quot;&lt;/color&gt;/&quot; .. GuildConst.MISSION_BOSS_MAX_CNT()
end

slot0.InitRanks = function(slot0)
	if getProxy(GuildProxy):ShouldRefreshBossRank() then
		slot0:emit(GuildEventMediator.ON_REFRESH_BOSS_RANK)
	else
		slot0:UpdateRank()
		slot0:AddRankTimer()
	end
end

slot0.UpdateRank = function(slot0)
	slot1 = getProxy(GuildProxy)
	slot1 = slot1:GetBossRank()

	table.sort(slot1, function (slot0, slot1)
		return slot1.damage &lt; slot0.damage
	end)

	slot2 = slot0.rankList

	slot2:make(function (slot0, slot1, slot2)
		if slot0 == UIItemList.EventUpdate then
			slot3 = uv0[slot1 + 1]

			setText(slot2:Find(&quot;no&quot;), slot1 + 1)
			setText(slot2:Find(&quot;name&quot;), slot3.name)
			setText(slot2:Find(&quot;Text&quot;), slot3.damage)
		end
	end)

	slot2 = slot0.rankList

	slot2:align(math.min(3, #slot1))
	onButton(slot0, slot0.viewAllBtn, function ()
		uv0.allRankPage:ExecuteAction(&quot;Show&quot;, uv1)
	end, SFX_PANEL)
end

slot0.ExistActiveEvent = function(slot0)
	return getProxy(GuildProxy):getRawData():GetActiveEvent() and not slot1:IsExpired()
end

slot0.AddRankTimer = function(slot0)
	if not slot0:ExistActiveEvent() then
		return
	end

	if slot0.rankTimer then
		slot0.rankTimer:Stop()

		slot0.rankTimer = nil
	end

	slot1 = slot0.bossMission
	slot0.rankTimer = Timer.New(function ()
		uv0:emit(GuildEventMediator.ON_REFRESH_BOSS_RANK)
	end, GuildConst.FORCE_REFRESH_MISSION_BOSS_RANK_TIME, 1)

	slot0.rankTimer:Start()
end

slot0.AddBossTimer = function(slot0)
	if not slot0:ExistActiveEvent() then
		return
	end

	if slot0.bossTimer then
		slot0.bossTimer:Stop()

		slot0.bossTimer = nil
	end

	slot0.bossTimer = Timer.New(function ()
		uv0:emit(GuildEventMediator.ON_GET_BOSS_INFO)
	end, GuildConst.FORCE_REFRESH_BOSS_TIME, 1)

	slot0.bossTimer:Start()
end

slot0.OnDestroy = function(slot0)
	if slot0.rankTimer then
		slot0.rankTimer:Stop()

		slot0.rankTimer = nil
	end

	if slot0.bossTimer then
		slot0.bossTimer:Stop()

		slot0.bossTimer = nil
	end

	slot0.allRankPage:Destroy()
	slot0.timeView:Dispose()
end

return slot0
</code></pre>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-lua.min.js"></script>
</body>
</html>