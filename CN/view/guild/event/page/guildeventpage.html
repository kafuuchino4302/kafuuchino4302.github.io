<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>guildeventpage.lua</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
</head>
<body>
    <h1>guildeventpage.lua</h1>
    <a href="index.html">返回主页</a>
    <pre><code class="language-lua">slot0 = class(&quot;GuildEventPage&quot;, import(&quot;....base.BaseSubView&quot;))

slot0.getUIName = function(slot0)
	return &quot;GuildEventPage&quot;
end

slot0.OnLoaded = function(slot0)
	slot0.eventList = UIItemList.New(slot0:findTF(&quot;eventlist/content&quot;), slot0:findTF(&quot;eventlist/content/tpl&quot;))
	slot0.reportBtn = slot0:findTF(&quot;report_btn&quot;)
	slot0.reportTip = slot0.reportBtn:Find(&quot;tip&quot;)
	slot0.reportTipTxt = slot0.reportBtn:Find(&quot;tip/Text&quot;):GetComponent(typeof(Text))
	slot0.formationBtn = slot0:findTF(&quot;formation_btn&quot;)
	slot0.missionList = slot0:findTF(&quot;missionlist&quot;)
	slot0.pathContains = slot0:findTF(&quot;missionlist/path&quot;)
	slot0.tpl = slot0:getTpl(&quot;tpl&quot;, slot0.pathContains)
	slot0.line = slot0:findTF(&quot;resource/line&quot;)
	slot0.lineHead = slot0:findTF(&quot;resource/head&quot;)
	slot0.adapter = slot0:findTF(&quot;resource/adapter&quot;)
	slot0.bg = slot0:findTF(&quot;bg&quot;):GetComponent(typeof(Image))
	slot0.titleTF = slot0:findTF(&quot;title&quot;)
	slot0.nameTxt = slot0:findTF(&quot;title/Text&quot;):GetComponent(typeof(Text))
	slot0.descPanel = slot0:findTF(&quot;missionlist/path/desc_panel&quot;)
	slot0.descPanelTag = slot0.descPanel:Find(&quot;Image&quot;):GetComponent(typeof(Image))

	setText(slot0:findTF(&quot;title/timer/label&quot;), i18n(&quot;guild_time_remaining_tip&quot;))

	slot0.endEventTimerTxt = slot0:findTF(&quot;title/timer/Text&quot;):GetComponent(typeof(Text))
	slot0.timeView = GuildEventTimerView.New()
end

slot0.OnInit = function(slot0)
	onButton(slot0, slot0.reportBtn, function ()
		uv0:emit(GuildEventMediator.ON_OPEN_REPORT)
	end, SFX_PANEL)
	onButton(slot0, slot0.formationBtn, function ()
		uv0:emit(GuildEventLayer.ON_OPEN_FORMATION)
	end, SFX_PANEL)
end

slot0.OnReportUpdated = function(slot0)
	slot0.reports = getProxy(GuildProxy):GetReports()

	slot0:UpdateReportBtn()
end

slot0.Show = function(slot0, slot1, slot2, slot3)
	uv0.super.Show(slot0)
	slot0:UpdateData(slot1, slot2, slot3)
	slot0:SwitchPage()
	slot0:OnReportUpdated()
	slot0._tf:SetAsFirstSibling()
end

slot0.UpdateData = function(slot0, slot1, slot2, slot3)
	slot0.guildVO = slot1
	slot0.player = slot2
	slot0.events = slot3
	slot0.activeEvent = _.detect(slot0.events, function (slot0)
		return slot0:IsActive()
	end)
end

slot0.SwitchPage = function(slot0)
	if slot0.contextData.editFleet then
		triggerButton(slot0.formationBtn)
	end

	if not slot0.activeEvent or slot1 and not slot1:IsParticipant() then
		slot0:InitEvents()
	else
		slot0:BuildTree(slot1)
		slot0:InitView()
		slot0:GenTree()
		slot0:InitTree()
		slot0:EnterActiveNode()
		slot0:CheckBossNode()
		slot0:RefreshLatelyNode()
		slot0:AddRefreshTime()
		slot0.timeView:Flush(slot0.endEventTimerTxt, slot1)
	end

	setActive(slot0.eventList.container, slot2)
	setActive(slot0.missionList, not slot2)
	setActive(slot0.titleTF, not slot2)
end

slot0.UpdateReportBtn = function(slot0)
	slot3 = #_.select(_.values(slot0.reports), function (slot0)
		return slot0:CanSubmit()
	end) &gt; 0 and not slot0.guildVO:getMemberById(slot0.player.id):IsRecruit()

	setActive(slot0.reportTip, slot3)

	if slot3 then
		slot0.reportTipTxt.text = #slot1
	end
end

slot0.InitEvents = function(slot0)
	slot0.bg.sprite = GetSpriteFromAtlas(&quot;commonbg/guild_event_bg&quot;, &quot;&quot;)
	slot0.displays = {}
	slot1 = {}

	for slot5, slot6 in ipairs(slot0.events) do
		table.insert(slot0.displays, slot6)
	end

	table.insert(slot0.displays, false)
	slot0.eventList:make(function (slot0, slot1, slot2)
		if slot0 == UIItemList.EventUpdate then
			slot3 = uv0.events[slot1 + 1]

			uv0:UpdateEvent(slot2, slot3)

			if slot3 then
				uv1[slot3.id] = slot2
			end
		end
	end)
	slot0.eventList:align(#slot0.displays)

	if slot0.activeEvent and not slot0.contextData.editFleet then
		triggerButton(slot1[slot0.activeEvent.id])
	end
end

slot1 = {
	&quot;easy&quot;,
	&quot;normal&quot;,
	&quot;hard&quot;
}

slot0.UpdateEvent = function(slot0, slot1, slot2)
	slot3 = slot0.activeEvent
	slot1:GetComponent(typeof(Image)).sprite = GetSpriteFromAtlas(&quot;guildevent/&quot; .. (slot2 and slot2.id or 0), &quot;&quot;)
	slot5 = slot1:Find(&quot;tag&quot;)

	if slot2 then
		slot8 = slot5:GetComponent(typeof(Image))
		slot8.sprite = GetSpriteFromAtlas(&quot;ui/GuildEventUI_atlas&quot;, &quot;tag_&quot; .. uv0[slot2:getConfig(&quot;difficulty&quot;)])

		slot8:SetNativeSize()
	end

	setActive(slot5, slot2)

	slot6 = slot3 and slot2 and slot3.id == slot2.id

	setActive(slot1:Find(&quot;state&quot;), slot6)
	setActive(slot1:Find(&quot;consume&quot;), slot2 and not slot6)
	setActive(slot1:Find(&quot;timer&quot;), slot6)

	if slot6 then
		slot0.timeView:Flush(slot1:Find(&quot;timer/Text&quot;):GetComponent(typeof(Text)), slot3)
	end

	setText(slot1:Find(&quot;timer/label&quot;), slot6 and i18n(&quot;guild_time_remaining_tip&quot;) or &quot;&quot;)

	if not slot2 then
		removeOnButton(slot1)

		return
	end

	setText(slot1:Find(&quot;consume/label&quot;), i18n(&quot;guild_word_consume_for_battle&quot;))
	setText(slot1:Find(&quot;consume/Text&quot;), slot2:GetConsume())

	if not slot2:IsUnlock(slot0.guildVO.level) then
		slot1:Find(&quot;mask&quot;):GetComponent(typeof(Image)).sprite = GetSpriteFromAtlas(&quot;guildevent/&quot; .. &quot;0_0&quot;, &quot;&quot;)
	end

	setActive(slot1:Find(&quot;mask&quot;), not slot7)
	onButton(slot0, slot1, function ()
		if not uv0 then
			return
		end

		if not uv0:IsUnlock(uv1.guildVO.level) then
			pg.TipsMgr:GetInstance():ShowTips(i18n(&quot;guild_level_no_enough&quot;))

			return
		end

		if uv2 and uv2.id ~= uv0.id then
			pg.TipsMgr:GetInstance():ShowTips(i18n(&quot;guild_open_event_info_when_exist_active&quot;, uv2:getConfig(&quot;name&quot;)))

			return
		end

		uv1:emit(GuildEventLayer.OPEN_EVENT_INFO, uv0)
	end, SFX_PANEL)
end

slot0.OnRefreshNode = function(slot0, slot1, slot2)
	if not slot0.nodes then
		return
	end

	slot0:BuildTree(slot1)

	for slot6, slot7 in ipairs(slot0.nodes) do
		if slot7.data.id == slot2.id or slot7.data:IsBoss() and slot2:IsBoss() then
			slot7:UpdateData(slot2)
		end
	end

	if not slot2:IsBoss() then
		slot0:CheckBossNode()
	end
end

slot0.EnterActiveNode = function(slot0)
	if slot0.contextData.mission then
		slot0:emit(GuildEventLayer.ON_OPEN_MISSION, slot0.contextData.mission)
	end
end

slot0.CheckBossNode = function(slot0)
	if slot0.nodes[#slot0.nodes]:ParentIsFinishByServer() and not slot1:IsActive() then
		slot0:emit(GuildEventMediator.ON_GET_BOSS_INFO)
	elseif slot1:ParentIFinish() and not slot1:IsActive() then
		slot0:emit(GuildEventMediator.REFRESH_MISSION, slot1:GetParentId())
	end
end

slot0.InitView = function(slot0)
	slot0.bg.sprite = GetSpriteFromAtlas(&quot;GuildMission/&quot; .. slot0.gevent:GetTheme(), &quot;&quot;)
	slot0.nameTxt.text = slot0.gevent:GetName()
end

slot0.BuildTree = function(slot0, slot1)
	slot0.gevent = slot1
	slot0.missions = {}
	slot0.bossPosition = slot0.gevent:GetBossMission():GetPosition()
	slot0.lastPosition = -1

	for slot7, slot8 in pairs(slot0.gevent:GetMissions()) do
		slot0.missions[slot7] = slot8

		if _.any(slot8, function (slot0)
			return slot0:IsMain() and slot0:IsFinish()
		end) then
			slot0.lastPosition = slot7
		end
	end

	slot0.lastPosition = slot0.lastPosition + 1
	slot0.missions[slot0.bossPosition] = {
		slot3
	}
end

slot0.RefreshLatelyNode = function(slot0)
	if slot0.lastPosition &lt;= 0 or slot0.lastPosition == slot0.bossPosition then
		return
	end

	slot3 = {}
	slot4 = slot0.gevent:GetMissions()[slot0.lastPosition] or {}

	for slot8, slot9 in ipairs(slot4) do
		if not slot9:IsBoss() then
			table.insert(slot3, function (slot0)
				uv0:emit(GuildEventMediator.REFRESH_MISSION, uv1.id, slot0)
			end)
		end
	end

	seriesAsync(slot3, function ()
		if uv0 ~= uv1.lastPosition then
			uv1:RefreshLatelyNode()
		end
	end)
end

slot0.AddRefreshTime = function(slot0)
	if slot0.timer then
		slot0.timer:Stop()

		slot0.timer = nil
	end

	slot0.timer = Timer.New(function ()
		uv0:RefreshLatelyNode()
		uv0:AddRefreshTime()
	end, GuildConst.FORCE_REFRESH_MISSION_TREE_TIME, 1)

	slot0.timer:Start()
end

slot0.GenTree = function(slot0)
	slot0.nodes = {}

	for slot4, slot5 in pairs(slot0.missions) do
		table.sort(slot5, function (slot0, slot1)
			return slot1:GetSubType() &lt; slot0:GetSubType()
		end)

		for slot9, slot10 in ipairs(slot5) do
			table.insert(slot0.nodes, slot0:CreateNode(cloneTplTo(slot0.tpl, slot0.pathContains, slot4 .. &quot;-&quot; .. slot9), slot4, slot10))
		end
	end
end

slot0.CreateNode = function(slot0, slot1, slot2, slot3)
	slot4 = GuildViewMissionNode.New({
		go = slot1.gameObject,
		slot = slot2,
		data = slot3,
		parent = slot0.last
	})

	if slot0.last then
		slot0.last:AddChild(slot4)
	end

	if slot4:IsMain() then
		slot0.last = slot4
	end

	onButton(slot0, slot1, function ()
		if uv0.prevSelected == uv1 then
			return
		end

		if not uv1:IsUnLock() then
			pg.TipsMgr.GetInstance():ShowTips(i18n(&quot;guild_event_is_lock&quot;))

			return
		end

		if uv1:IsFinish() then
			pg.TipsMgr.GetInstance():ShowTips(i18n(&quot;guild_event_is_finish&quot;))

			return
		end

		if uv0.prevSelected then
			uv0:HideDesc(uv0.prevSelected)
		end

		uv0:ShowDesc(uv1)

		uv0.prevSelected = uv1
	end, SFX_PANEL)

	return slot4
end

slot0.InitTree = function(slot0)
	slot1 = {
		0,
		0
	}
	slot2 = nil

	for slot6, slot7 in ipairs(slot0.nodes) do
		slot7:Init()

		slot8 = slot7._tf.anchoredPosition
		slot10 = math.abs(slot8.y)

		if slot1[1] &lt; math.abs(slot8.x) then
			slot1[1] = slot9 + slot7._tf.sizeDelta.x
		end

		if slot1[2] &lt; slot10 then
			slot1[2] = slot10 + slot7._tf.sizeDelta.y / 2
		end

		if slot7:IsMain() and slot7:IsUnLock() then
			slot2 = slot7
		end
	end

	for slot6, slot7 in ipairs(slot0.nodes) do
		slot0:CreateLinkLine(slot7)
		slot7:UpdateLineStyle()
	end

	slot0:SetScrollRect(slot1)

	if slot2 then
		setAnchoredPosition(slot0.pathContains, {
			x = math.max(-slot2._tf.localPosition.x, -slot0.pathContains.rect.width * 0.5)
		})
	end
end

slot0.CreateLinkLine = function(slot0, slot1)
	slot2 = function(slot0, slot1)
		slot2 = Instantiate(slot0)
		slot2.name = slot1

		return slot2
	end

	if slot1:HasChild() then
		slot1:AddLine(slot2(slot0.adapter, &quot;adapter&quot;), GuildViewMissionNode.LINE_RIGHT, slot1)
	end

	if slot1:HasParent() then
		slot1:AddLine(slot2(slot0.adapter, &quot;adapter&quot;), GuildViewMissionNode.LINE_LEFT, slot1)
	end

	for slot7, slot8 in ipairs(slot1:GetChilds()) do
		if slot8:GetOffset() &gt; 0 then
			slot1:AddLine(slot2(slot0.line, &quot;line&quot;), GuildViewMissionNode.TOP_LINK, slot8)
			slot1:AddLine(slot2(slot0.line, &quot;line&quot;), GuildViewMissionNode.TOP_HRZ_LINK, slot8)
		elseif slot9 &lt; 0 then
			slot1:AddLine(slot2(slot0.line, &quot;line&quot;), GuildViewMissionNode.BOTTOM_LINK, slot8)
			slot1:AddLine(slot2(slot0.line, &quot;line&quot;), GuildViewMissionNode.BOTTOM_HRZ_LINK, slot8)
		elseif slot9 == 0 then
			slot1:AddLine(slot2(slot0.line, &quot;line&quot;), GuildViewMissionNode.CENTER_LINK, slot8)
		end
	end
end

slot0.SetScrollRect = function(slot0, slot1)
	slot0.pathContains.sizeDelta = Vector2(slot1[1] + 100, slot1[2] * 2 + 100)
end

slot0.ShowDesc = function(slot0, slot1)
	slot1:Selected(true)
	setActive(slot0.descPanel, true)

	if slot1._tf.localPosition.y + 50 + slot1._tf.rect.height &gt; slot0.pathContains.rect.height / 2 then
		slot0.chcheSizeDelta = slot0.pathContains.sizeDelta
		slot0.pathContains.sizeDelta = Vector2(slot0.chcheSizeDelta.x, slot0.chcheSizeDelta.y + slot4 + (slot3 - slot4) * 2)

		scrollTo(slot0.missionList, false, 1)
	end

	slot0.descPanel.localPosition = Vector3(slot2.x, slot2.y + 50, 0)

	if not slot1.data:IsBoss() then
		slot0.descPanel:GetComponent(typeof(Image)).sprite = GetSpriteFromAtlas(&quot;GuildMission/&quot; .. slot1.data:GetIcon(), &quot;&quot;)
	else
		slot0.descPanel:GetComponent(typeof(Image)).sprite = GetSpriteFromAtlas(&quot;GuildMission/boss_&quot; .. slot1.data:GetIcon(), &quot;&quot;)
	end

	slot5 = slot1.data
	slot0.descPanelTag.sprite = GetSpriteFromAtlas(&quot;ui/GuildMissionUI_atlas&quot;, &quot;tag&quot; .. slot5:GetTag())

	slot6 = function(slot0)
		if not slot0:IsUnLock() then
			pg.TipsMgr.GetInstance():ShowTips(i18n(&quot;guild_event_is_lock&quot;))

			return false
		end

		if slot0:IsFinish() then
			pg.TipsMgr.GetInstance():ShowTips(i18n(&quot;guild_event_is_finish&quot;))

			return false
		end

		return true
	end

	onButton(slot0, slot0.descPanel, function ()
		if uv0.data:IsBoss() then
			if not uv1(uv0) then
				return
			end

			uv2:emit(GuildEventLayer.ON_OPEN_BOSS, uv0.data)
		else
			slot0 = uv2

			slot0:emit(GuildEventMediator.REFRESH_MISSION, uv0.data.id, function ()
				if not uv0(uv1) then
					return
				end

				uv2.contextData.mission = uv1.data

				uv2:emit(GuildEventLayer.ON_OPEN_MISSION, uv1.data)
			end)
		end
	end, SFX_PANEL)
end

slot0.HideDesc = function(slot0, slot1)
	slot1:Selected(false)

	if slot0.chcheSizeDelta then
		slot0.pathContains.sizeDelta = slot0.chcheSizeDelta
	end

	setActive(slot0.descPanel, false)
end

slot0.OnDestroy = function(slot0)
	if slot0.timer then
		slot0.timer:Stop()

		slot0.timer = nil
	end

	slot0.timeView:Dispose()
end

return slot0
</code></pre>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-lua.min.js"></script>
</body>
</html>