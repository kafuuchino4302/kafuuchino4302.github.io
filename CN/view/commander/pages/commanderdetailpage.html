<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>commanderdetailpage.lua</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
</head>
<body>
    <h1>commanderdetailpage.lua</h1>
    <a href="index.html">返回主页</a>
    <pre><code class="language-lua">slot0 = class(&quot;CommanderDetailPage&quot;, import(&quot;...base.BaseSubView&quot;))

slot0.getUIName = function(slot0)
	return &quot;CommanderDetailUI&quot;
end

slot0.Ctor = function(slot0, slot1, slot2, slot3)
	uv0.super.Ctor(slot0, slot1, slot2, slot3)
	slot0:Load()
end

slot0.RegisterEvent = function(slot0)
	slot0:bind(CommanderCatScene.EVENT_CLOSE_DESC, function (slot0)
		triggerToggle(uv0.skillBtn, false)
		triggerToggle(uv0.additionBtn, false)
		triggerToggle(uv0.otherBtn, false)
	end)
	slot0:bind(CommanderCatScene.EVENT_FOLD, function (slot0, slot1)
		triggerToggle(uv0.skillBtn, false)
		triggerToggle(uv0.additionBtn, false)
		triggerToggle(uv0.otherBtn, false)

		if slot1 then
			LeanTween.moveY(rtf(uv0.commanderInfo), -400, 0.5)
		else
			LeanTween.moveY(rtf(uv0.commanderInfo), 71, 0.5)
		end
	end)
	slot0:bind(CommanderCatScene.EVENT_PREVIEW, function (slot0, slot1)
		uv0:UpdatePreView(slot1)
	end)
	slot0:bind(CommanderCatScene.EVENT_PREVIEW_REVERSE, function (slot0, slot1, slot2)
		uv0:UpdateReversePreView(slot1, slot2)
	end)
	slot0:bind(CommanderCatScene.EVENT_PREVIEW_PLAY, function (slot0, slot1, slot2)
		triggerToggle(uv0.skillBtn, true)
		triggerToggle(uv0.otherBtn, not (not slot1 or #slot1 &lt;= 0 or slot2))
		triggerToggle(uv0.additionBtn, false)
		setToggleEnabled(uv0.additionBtn, false)
		uv0:UpdatePreViewWithOther(slot1)
	end)
	slot0:bind(CommanderCatScene.EVENT_PREVIEW_ADDITION, function (slot0, slot1)
		triggerToggle(uv0.skillBtn, true)
		triggerToggle(uv0.additionBtn, true)
		uv0:UpdatePreviewAddition(slot1)
	end)
	slot0:bind(CommanderCatDockPage.ON_SORT, function (slot0, slot1)
		uv0:OnSort(slot1)
	end)
end

slot0.OnLoaded = function(slot0)
	slot0.statement = slot0:findTF(&quot;detail/statement&quot;)
	slot0.statement.localScale = Vector3(1, 0, 1)
	slot0.talentSkill = slot0:findTF(&quot;detail/talent_skill&quot;)
	slot1 = slot0:findTF(&quot;talent/content&quot;, slot0.talentSkill)
	slot0.talentList = UIItemList.New(slot1, slot1:GetChild(0))
	slot0.abilityAdditionTF = slot0:findTF(&quot;atttrs/content&quot;, slot0.statement)
	slot0.talentAdditionTF = slot0:findTF(&quot;talents/scroll/content&quot;, slot0.statement)
	slot0.talentAdditionList = UIItemList.New(slot0.talentAdditionTF, slot0.talentAdditionTF:GetChild(0))
	slot0.skillIcon = slot0:findTF(&quot;skill/icon/Image&quot;, slot0.talentSkill)
	slot0.lockTF = slot0:findTF(&quot;info/lock&quot;)
	slot0.commanderInfo = slot0:findTF(&quot;info&quot;)
	slot0.expPanel = slot0:findTF(&quot;exp&quot;, slot0.commanderInfo)
	slot0.commanderLevelTxt = slot0:findTF(&quot;exp/level&quot;, slot0.commanderInfo):GetComponent(typeof(Text))
	slot0.commanderExpImg = slot0:findTF(&quot;exp/Image&quot;, slot0.commanderInfo):GetComponent(typeof(Image))
	slot0.commanderNameTxt = slot0:findTF(&quot;name_bg/mask/Text&quot;, slot0.commanderInfo):GetComponent(&quot;ScrollText&quot;)
	slot0.modifyNameBtn = slot0:findTF(&quot;name_bg/modify&quot;, slot0.commanderInfo)

	setActive(slot0.modifyNameBtn, pg.gameset.commander_rename_open.key_value == 1)

	slot0.line = slot0:findTF(&quot;line&quot;, slot0.commanderInfo)
	slot0.fleetnums = slot0:findTF(&quot;line/numbers&quot;, slot0.commanderInfo)
	slot0.fleetTF = slot0:findTF(&quot;line/fleet&quot;, slot0.commanderInfo)
	slot0.subTF = slot0:findTF(&quot;line/sub_fleet&quot;, slot0.commanderInfo)
	slot0.leisureTF = slot0:findTF(&quot;line/leisure&quot;, slot0.commanderInfo)
	slot0.labelInBattleTF = slot0:findTF(&quot;line/inbattle&quot;, slot0.commanderInfo)
	slot0.rarityImg = slot0:findTF(&quot;rarity&quot;, slot0.commanderInfo):GetComponent(typeof(Image))
	slot0.abilityTF = slot0:findTF(&quot;ablitys&quot;, slot0.commanderInfo)
	slot0.skillBtn = slot0:findTF(&quot;skill_btn&quot;, slot0.commanderInfo)
	slot0.additionBtn = slot0:findTF(&quot;addition_btn&quot;, slot0.commanderInfo)
	slot0.otherBtn = slot0:findTF(&quot;other_btn&quot;, slot0.commanderInfo)
	slot0.otherCommanderNameTxt = slot0:findTF(&quot;detail/other/name/Text&quot;):GetComponent(typeof(Text))
	slot0.otherCommanderSkillImg = slot0:findTF(&quot;detail/other/skill/Image&quot;)
	slot0.otherCommanderTalentList = UIItemList.New(slot0:findTF(&quot;detail/other/talent&quot;), slot0:findTF(&quot;detail/other/talent/tpl&quot;))
	slot0.otherCommanderDescTxt = slot0:findTF(&quot;detail/other/desc/mask/Text&quot;):GetComponent(typeof(ScrollText))
	slot0.blurPanel = slot0._parentTf.parent
	slot0.blurPanelParent = slot0.blurPanel.parent
	slot0.renamePanel = CommanderRenamePage.New(pg.UIMgr.GetInstance().OverlayMain, slot0.event)

	setText(slot0:findTF(&quot;detail/statement/atttrs/title/Text&quot;), i18n(&quot;commander_subtile_ablity&quot;))
	setText(slot0:findTF(&quot;detail/statement/talents/title/Text&quot;), i18n(&quot;commander_subtile_talent&quot;))
end

slot0.OnInit = function(slot0)
	slot0:RegisterEvent()

	slot0.isOnAddition = false
	slot0.isOnSkill = false

	onToggle(slot0, slot0.skillBtn, function (slot0)
		uv0.isOnSkill = slot0

		uv0:Blur()

		if slot0 then
			uv0:emit(CommanderCatScene.EVENT_OPEN_DESC)
		end
	end, SFX_PANEL)
	onToggle(slot0, slot0.additionBtn, function (slot0)
		uv0.isOnAddition = slot0
		uv0.statement.localScale = slot0 and Vector3(1, 1, 1) or Vector3(1, 0, 1)

		uv0:Blur()

		if slot0 then
			uv0:emit(CommanderCatScene.EVENT_OPEN_DESC)
		end
	end, SFX_PANEL)
	onToggle(slot0, slot0.otherBtn, function (slot0)
		uv0.isOnOther = slot0

		uv0:Blur()

		if slot0 then
			uv0:emit(CommanderCatScene.EVENT_OPEN_DESC)
		end
	end, SFX_PANEL)
	onButton(slot0, slot0.modifyNameBtn, function ()
		if not uv0.commanderVO:canModifyName() then
			uv0.contextData.msgBox:ExecuteAction(&quot;Show&quot;, {
				content = i18n(&quot;commander_rename_coldtime_tip&quot;, slot0:getRenameTimeDesc())
			})
		else
			uv0.renamePanel:ExecuteAction(&quot;Show&quot;, slot0)
		end
	end, SFX_PANEL)
end

slot0.Update = function(slot0, slot1, slot2)
	slot0.commanderVO = slot1

	slot0:UpdateInfo()
	slot0:UpdateTalents()
	slot0:UpdateSkills()
	slot0:UpdateAbilityAddition()
	slot0:UpdateTalentAddition()
	slot0:UpdateAbilitys()
	slot0:UpdateLockState()
	slot0:UpdateLevel()
	slot0:UpdateStyle(slot2)
	slot0._tf:SetAsFirstSibling()
	slot0:Show()
end

slot0.UpdateLockState = function(slot0)
	setActive(slot0.lockTF:Find(&quot;image&quot;), slot0.commanderVO:getLock() == 0)
	onButton(slot0, slot0.lockTF, function ()
		uv1:emit(CommanderCatMediator.LOCK, uv1.commanderVO.id, 1 - uv0)
	end, SFX_PANEL)
end

slot0.UpdateStyle = function(slot0, slot1)
	if slot1 then
		triggerToggle(slot0.skillBtn, true)
		triggerToggle(slot0.additionBtn, true)
		setActive(slot0.lockTF, false)
	end

	setButtonEnabled(slot0.modifyNameBtn, not slot1)
end

slot0.UpdateInfo = function(slot0)
	if slot0.rarityPrint ~= Commander.rarity2Print(slot0.commanderVO:getRarity()) then
		LoadImageSpriteAsync(&quot;CommanderRarity/&quot; .. slot2, slot0.rarityImg, true)

		slot0.rarityPrint = slot2
	end

	eachChild(slot0.fleetnums, function (slot0)
		setActive(slot0, go(slot0).name == tostring(uv0.fleetId or &quot;&quot;))
	end)

	slot3 = slot1.fleetId and not slot1.inBattle and slot1.sub
	slot0.line.sizeDelta = Vector2(slot3 and 260 or 200, slot0.line.sizeDelta.y)

	setActive(slot0.subTF, slot3)
	setActive(slot0.fleetTF, slot1.fleetId and not slot1.inBattle and not slot1.sub)
	setActive(slot0.leisureTF, not slot1.inFleet and not slot1.inBattle)
	setActive(slot0.labelInBattleTF, slot1.inBattle)
	slot0.commanderNameTxt:SetText(slot0.commanderVO:getName(defaultValue(slot0.forceDefaultName, false)))
end

slot0.OnSort = function(slot0, slot1)
	slot3 = not slot1
	slot0.forceDefaultName = slot3

	slot0.commanderNameTxt:SetText(slot0.commanderVO:getName(slot3))
end

slot0.UpdatePreView = function(slot0, slot1)
	slot0:UpdateAbilitys(slot1)
	slot0:UpdatePreviewAddition(slot1)
	slot0:UpdateLevel(slot1)
end

slot0.UpdateReversePreView = function(slot0, slot1, slot2)
	slot0:_UpdateAbilitys(slot2, slot1)
	slot0:_UpdateAbilityAddition(slot2, slot1)
	slot0:_UpdateTalentAddition(slot2)
	slot0:UpdateLevel(slot2)
end

slot0.UpdatePreViewWithOther = function(slot0, slot1)
	if not slot1 or #slot1 &lt;= 0 then
		return
	end

	slot2 = Clone(slot0.commanderVO)

	slot2:addExp(CommanderCatUtil.GetSkillExpAndCommanderExp(slot2, slot1))
	slot0:UpdateOtherCommander(getProxy(CommanderProxy):getCommanderById(slot1[#slot1]))
	slot0:UpdateLevel(slot2)
	slot0:UpdateAbilitys(slot2)
end

slot0.UpdatePreviewAddition = function(slot0, slot1)
	slot0:UpdateAbilityAddition(slot1)
	slot0:UpdateTalentAddition()
end

slot0.UpdateOtherCommander = function(slot0, slot1)
	slot0.otherCommanderNameTxt.text = slot1:getName()
	slot4 = slot1:GetDisplayTalents()

	GetImageSpriteFromAtlasAsync(&quot;commanderskillicon/&quot; .. slot1:getSkills()[1]:getConfig(&quot;icon&quot;), &quot;&quot;, slot0.otherCommanderSkillImg)
	slot0.otherCommanderTalentList:make(function (slot0, slot1, slot2)
		if slot0 == UIItemList.EventUpdate then
			setText(slot2:Find(&quot;Text&quot;), &quot;&quot;)

			if uv0[slot1 + 1] then
				uv1:UpdateTalent(uv2, slot3, slot2)
				onToggle(uv1, slot2, function (slot0)
					if slot0 then
						uv0.otherCommanderDescTxt:SetText(uv1:getConfig(&quot;desc&quot;))
					end
				end, SFX_PANEL)

				if slot1 == 0 then
					triggerToggle(slot2, true)
				end
			end

			setActive(slot2:Find(&quot;empty&quot;), slot3 == nil)

			slot2:GetComponent(typeof(Image)).enabled = slot3 ~= nil

			setActive(slot2:Find(&quot;lock&quot;), slot3 and not uv2:IsLearnedTalent(slot3.id))
		end
	end)
	slot0.otherCommanderTalentList:align(5)
end

slot0.UpdateLevel = function(slot0, slot1)
	slot2 = slot1 or slot0.commanderVO
	slot0.commanderLevelTxt.text = setColorStr(&quot;LV.&quot; .. slot2.level, slot1 and slot0.commanderVO.level &lt; slot1.level and COLOR_GREEN or COLOR_WHITE)

	if slot2:isMaxLevel() then
		slot0.commanderExpImg.fillAmount = 1
	else
		slot0.commanderExpImg.fillAmount = slot2.exp / slot2:getNextLevelExp()
	end
end

slot0.UpdateAbilitys = function(slot0, slot1)
	slot0:_UpdateAbilitys(slot0.commanderVO, slot1)
end

slot0._UpdateAbilitys = function(slot0, slot1, slot2)
	slot3 = slot1:getAbilitys()
	slot4 = nil

	if slot2 then
		slot4 = slot2:getAbilitys()
	end

	for slot8, slot9 in pairs(slot3) do
		slot10 = slot0.abilityTF:Find(slot8)
		slot11 = nil

		if slot4 and slot4[slot8].value - slot9.value &lt;= 0 then
			slot11 = nil
		end

		setText(slot10:Find(&quot;add/base&quot;), slot9.value)
		setText(slot10:Find(&quot;add&quot;), slot11 and setColorStr(&quot;+&quot; .. slot11, COLOR_GREEN) or &quot; &quot;)
	end
end

slot0.UpdateAbilityAddition = function(slot0, slot1)
	slot0:_UpdateAbilityAddition(slot0.commanderVO, slot1)
end

slot0._UpdateAbilityAddition = function(slot0, slot1, slot2)
	slot3 = slot1:getAbilitysAddition()
	slot4 = nil

	if slot2 then
		slot4 = slot2:getAbilitysAddition()
	end

	slot5 = 0

	for slot9, slot10 in pairs(slot3) do
		if slot10 &gt; 0 then
			slot11 = slot0.abilityAdditionTF:GetChild(slot5)

			GetImageSpriteFromAtlasAsync(&quot;attricon&quot;, slot9, slot11:Find(&quot;bg/icon&quot;), false)
			setText(slot11:Find(&quot;bg/name&quot;), AttributeType.Type2Name(slot9))

			slot12 = string.format(&quot;%0.3f&quot;, slot10)

			setText(slot11:Find(&quot;bg/value&quot;), &quot;+&quot; .. math.floor(slot10 * 1000) / 1000 .. &quot;%&quot;)

			slot13 = slot4 and slot4[slot9] or slot10

			setActive(slot11:Find(&quot;up&quot;), slot13 &lt; slot10)
			setActive(slot11:Find(&quot;down&quot;), slot10 &lt; slot13)

			slot5 = slot5 + 1
		end
	end
end

slot0.UpdateTalents = function(slot0)
	slot0.talentList:make(function (slot0, slot1, slot2)
		if slot0 == UIItemList.EventUpdate then
			uv1:UpdateTalent(uv2, uv0[slot1 + 1], slot2)
		end
	end)
	slot0.talentList:align(#slot0.commanderVO:GetDisplayTalents())
end

slot0.UpdateTalent = function(slot0, slot1, slot2, slot3)
	setText(slot3:Find(&quot;Text&quot;), slot2:getConfig(&quot;name&quot;))
	GetImageSpriteFromAtlasAsync(&quot;CommanderTalentIcon/&quot; .. slot2:getConfig(&quot;icon&quot;), &quot;&quot;, slot3)

	if slot3:GetComponent(typeof(Button)) then
		onButton(slot0, slot3, function ()
			uv0.contextData.treePanel:ExecuteAction(&quot;Show&quot;, uv1)
		end, SFX_PANEL)
	end

	setActive(slot3:Find(&quot;lock&quot;), not slot1:IsLearnedTalent(slot2.id))
end

slot0.UpdateTalentAddition = function(slot0)
	slot0:_UpdateTalentAddition(slot0.commanderVO)
end

slot0._UpdateTalentAddition = function(slot0, slot1)
	slot2 = nil

	slot0.talentAdditionList:make(function (slot0, slot1, slot2)
		if slot0 == UIItemList.EventUpdate then
			slot3 = uv0[slot1 + 1]

			setScrollText(findTF(slot2, &quot;bg/name_mask/name&quot;), slot3.name)
			setText(slot2:Find(&quot;bg/value&quot;), (slot3.value &gt; 0 and &quot;+&quot; or &quot;&quot;) .. slot3.value .. (slot3.type == CommanderConst.TALENT_ADDITION_RATIO and &quot;%&quot; or &quot;&quot;))
			setActive(slot2:Find(&quot;up&quot;), false)
			setActive(slot2:Find(&quot;down&quot;), false)

			slot2:Find(&quot;bg&quot;):GetComponent(typeof(Image)).enabled = slot1 % 2 ~= 0
		end
	end)
	slot0.talentAdditionList:align(#_.values(slot1:getTalentsDesc()))
end

slot0.UpdateSkills = function(slot0)
	slot1 = slot0.commanderVO
	slot3 = slot1:getSkills()[1]

	GetImageSpriteFromAtlasAsync(&quot;commanderskillicon/&quot; .. slot3:getConfig(&quot;icon&quot;), &quot;&quot;, slot0.skillIcon)
	onButton(slot0, slot0.skillIcon, function ()
		uv0:emit(CommanderCatMediator.SKILL_INFO, uv1)
	end, SFX_PANEL)
end

slot0.CanBack = function(slot0)
	if slot0.renamePanel and slot0.renamePanel:GetLoaded() and slot0.renamePanel:isShowing() then
		slot0.renamePanel:Hide()

		return false
	end

	return true
end

slot0.OnDestroy = function(slot0)
	if slot0.isBlur then
		pg.UIMgr.GetInstance():UnblurPanel(slot0.blurPanel, slot0.blurPanelParent)
	end

	if slot0.renamePanel then
		slot0.renamePanel:Destroy()

		slot0.renamePanel = nil
	end
end

slot0.Blur = function(slot0)
	if slot0.isOnAddition or slot0.isOnSkill or slot0.isOnOther then
		slot0.isBlur = true

		pg.UIMgr.GetInstance():BlurPanel(slot0.blurPanel)
	else
		slot0.isBlur = false

		pg.UIMgr.GetInstance():UnblurPanel(slot0.blurPanel, slot0.blurPanelParent)
	end
end

return slot0
</code></pre>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-lua.min.js"></script>
</body>
</html>