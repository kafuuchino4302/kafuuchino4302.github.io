<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>newshopsscene.lua</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
</head>
<body>
    <h1>newshopsscene.lua</h1>
    <a href="index.html">返回主页</a>
    <pre><code class="language-lua">slot0 = class(&quot;NewShopsScene&quot;, import(&quot;..base.BaseUI&quot;))
slot0.CATEGORY_ACTIVITY = 1
slot0.CATEGORY_MONTH = 2
slot0.CATEGORY_SUPPLY = 3
slot0.TYPE_ACTIVITY = 1
slot0.TYPE_SHOP_STREET = 2
slot0.TYPE_MILITARY_SHOP = 3
slot0.TYPE_QUOTA = 4
slot0.TYPE_SHAM_SHOP = 5
slot0.TYPE_FRAGMENT = 6
slot0.TYPE_GUILD = 7
slot0.TYPE_MEDAL = 8
slot0.TYPE_META = 9
slot0.TYPE_MINI_GAME = 10
slot0.CATEGORY2NAME = {
	[slot0.CATEGORY_ACTIVITY] = &quot;activity&quot;,
	[slot0.CATEGORY_MONTH] = &quot;month&quot;,
	[slot0.CATEGORY_SUPPLY] = &quot;supply&quot;
}
slot0.TYPE2NAME = {
	[slot0.TYPE_ACTIVITY] = i18n(&quot;activity_shop_title&quot;),
	[slot0.TYPE_SHOP_STREET] = i18n(&quot;street_shop_title&quot;),
	[slot0.TYPE_MILITARY_SHOP] = i18n(&quot;military_shop_title&quot;),
	[slot0.TYPE_QUOTA] = i18n(&quot;quota_shop_title1&quot;),
	[slot0.TYPE_SHAM_SHOP] = i18n(&quot;sham_shop_title&quot;),
	[slot0.TYPE_FRAGMENT] = i18n(&quot;fragment_shop_title&quot;),
	[slot0.TYPE_GUILD] = i18n(&quot;guild_shop_title&quot;),
	[slot0.TYPE_MEDAL] = i18n(&quot;medal_shop_title&quot;),
	[slot0.TYPE_META] = i18n(&quot;meta_shop_title&quot;),
	[slot0.TYPE_MINI_GAME] = i18n(&quot;mini_game_shop_title&quot;)
}
slot1 = {
	[slot0.CATEGORY_ACTIVITY] = {
		slot0.TYPE_ACTIVITY
	},
	[slot0.CATEGORY_MONTH] = {
		slot0.TYPE_QUOTA,
		slot0.TYPE_SHAM_SHOP,
		slot0.TYPE_MEDAL,
		slot0.TYPE_FRAGMENT
	},
	[slot0.CATEGORY_SUPPLY] = {
		slot0.TYPE_SHOP_STREET,
		slot0.TYPE_MILITARY_SHOP,
		slot0.TYPE_GUILD,
		slot0.TYPE_META,
		slot0.TYPE_MINI_GAME
	}
}
slot2 = {
	&quot;activity&quot;,
	&quot;shopstreet&quot;,
	&quot;supplies&quot;,
	&quot;quota&quot;,
	&quot;sham&quot;,
	&quot;fragment&quot;,
	&quot;guild&quot;,
	&quot;medal&quot;,
	&quot;meta&quot;,
	&quot;minigame&quot;
}

slot0.getUIName = function(slot0)
	return &quot;NewShopsUI&quot;
end

slot0.SetPlayer = function(slot0, slot1)
	slot0.player = slot1

	if slot0.page then
		slot0.page:SetPlayer(slot1)
	end
end

slot0.SetShops = function(slot0, slot1)
	slot0.shops = slot1

	slot0:SortActivityShops()
end

slot0.SortActivityShops = function(slot0)
	for slot4, slot5 in pairs(slot0.shops) do
		if slot4 == uv0.TYPE_ACTIVITY then
			table.sort(slot5, function (slot0, slot1)
				return slot1:getStartTime() &lt; slot0:getStartTime()
			end)
		end
	end
end

slot0.SetShop = function(slot0, slot1, slot2)
	if not slot0.shops then
		return
	end

	if slot0.shops[slot1] then
		for slot7, slot8 in ipairs(slot3) do
			if slot8:IsSameKind(slot2) then
				slot0.shops[slot1][slot7] = slot2

				break
			end
		end
	end
end

slot0.OnUpdateItems = function(slot0, slot1)
	slot0.items = slot1

	if slot0.page then
		slot0.page:SetItems(slot1)
	end
end

slot0.OnUpdateShop = function(slot0, slot1, slot2)
	slot0:SetShop(slot1, slot2)

	if slot0.page == slot0.pages[slot1] then
		slot0.page:ExecuteAction(&quot;UpdateShop&quot;, slot2)
	end
end

slot0.OnUpdateCommodity = function(slot0, slot1, slot2, slot3)
	slot0:SetShop(slot1, slot2)

	if slot0.page == slot0.pages[slot1] then
		slot0.page:ExecuteAction(&quot;UpdateCommodity&quot;, slot2, slot3)
	end
end

slot0.init = function(slot0)
	slot0.backBtn = slot0:findTF(&quot;blur_panel/adapt/top/back_button&quot;)
	slot0.frame = slot0:findTF(&quot;blur_panel&quot;)
	slot0.pageContainer = slot0:findTF(&quot;frame/bg/pages&quot;)
	slot0.stamp = slot0:findTF(&quot;stamp&quot;)
	slot0.switchBtn = slot0:findTF(&quot;blur_panel/adapt/switch_btn&quot;)
	slot0.skinBtn = slot0:findTF(&quot;blur_panel/adapt/skin_btn&quot;)

	setActive(slot0.skinBtn, not (LOCK_SKIN_SHOP_ENTER and getProxy(PlayerProxy):getData().level &lt; LOCK_SKIN_SHOP_ENTER_LEVEL))

	slot2 = slot0:findTF(&quot;frame/bg/pages/scrollrect&quot;):GetComponent(&quot;LScrollRect&quot;)
	slot3 = slot0:findTF(&quot;frame/bg/pages/scrollRectSpecial&quot;)

	setActive(go(slot2), true)
	setActive(slot3, false)

	slot0.pages = {
		[uv0.TYPE_ACTIVITY] = ActivityShopPage.New(slot0.pageContainer, slot0.event, slot0.contextData, slot2, slot3),
		[uv0.TYPE_SHOP_STREET] = StreetShopPage.New(slot0.pageContainer, slot0.event, slot0.contextData, slot2),
		[uv0.TYPE_MILITARY_SHOP] = MilitaryShopPage.New(slot0.pageContainer, slot0.event, slot0.contextData, slot2),
		[uv0.TYPE_GUILD] = GuildShopPage.New(slot0.pageContainer, slot0.event, slot0.contextData, slot2),
		[uv0.TYPE_SHAM_SHOP] = ShamShopPage.New(slot0.pageContainer, slot0.event, slot0.contextData, slot2),
		[uv0.TYPE_FRAGMENT] = FragmentShopPage.New(slot0.pageContainer, slot0.event, slot0.contextData, slot2),
		[uv0.TYPE_META] = MetaShopPage.New(slot0.pageContainer, slot0.event, slot0.contextData, slot2),
		[uv0.TYPE_MEDAL] = MedalShopPage.New(slot0.pageContainer, slot0.event, slot0.contextData, slot2),
		[uv0.TYPE_QUOTA] = QuotaShopPage.New(slot0.pageContainer, slot0.event, slot0.contextData, slot2),
		[uv0.TYPE_MINI_GAME] = MiniGameShopPage.New(slot0.pageContainer, slot0.event, slot0.contextData, slot2)
	}
	slot0.contextData.singleWindow = ShopSingleWindow.New(slot0._tf, slot0.event)
	slot0.contextData.multiWindow = ShopMultiWindow.New(slot0._tf, slot0.event)
	slot0.contextData.singleWindowForESkin = EquipmentSkinInfoUIForShopWindow.New(slot0._tf, slot0.event)
	slot0.contextData.paintingView = ShopPaintingView.New(slot0:findTF(&quot;paint/paint&quot;), slot0:findTF(&quot;frame/chat&quot;))

	slot0.contextData.paintingView:setSecretaryPos(slot0:findTF(&quot;paint/secretaryPos&quot;))

	slot0.contextData.bgView = ShopBgView.New(slot0:findTF(&quot;bg&quot;))
	slot0.recorder = {
		[uv0.CATEGORY_ACTIVITY] = false,
		[uv0.CATEGORY_MONTH] = false,
		[uv0.CATEGORY_SUPPLY] = false
	}
	slot0.frameTr = slot0:findTF(&quot;frame&quot;)
	slot0.categoryUIList = UIItemList.New(slot0:findTF(&quot;frame/bg/types&quot;), slot0:findTF(&quot;frame/bg/types/tpl&quot;))
	slot0.shopUIList = UIItemList.New(slot0:findTF(&quot;frame/bg/shops&quot;), slot0:findTF(&quot;frame/bg/shops/tpl&quot;))
end

slot0.didEnter = function(slot0)
	onButton(slot0, slot0.backBtn, function ()
		uv0:closeView()
	end, SFX_CANCEL)
	setActive(slot0.stamp, getProxy(TaskProxy):mingshiTouchFlagEnabled())

	if LOCK_CLICK_MINGSHI then
		setActive(slot0.stamp, false)
	end

	onButton(slot0, slot0.stamp, function ()
		getProxy(TaskProxy):dealMingshiTouchFlag(4)
	end, SFX_CONFIRM)
	onButton(slot0, slot0.switchBtn, function ()
		slot0 = ChargeScene.TYPE_DIAMOND

		if uv0.contextData ~= nil and uv0.contextData.chargePage ~= nil then
			slot0 = uv0.contextData.chargePage
		end

		uv0:emit(NewShopsMediator.GO_MALL, slot0)
	end, SFX_CANCEL)
	onButton(slot0, slot0.skinBtn, function ()
		uv0:emit(NewShopsMediator.ON_SKIN_SHOP)
	end, SFX_PANEL)
	slot0:InitEntrances()
	slot0:BlurView()

	slot0.bulinTip = AprilFoolBulinSubView.ShowAprilFoolBulin(slot0, slot0.pageContainer, Vector2.New(-35, -90))
end

slot0.InitEntrances = function(slot0)
	slot0:InitCategory()
	slot0:ActiveDefaultCategory()

	slot0.shopType = nil
	slot0.shopIndex = nil
end

slot0.InitCategory = function(slot0)
	slot0.categoryTrs = {}
	slot1 = {
		uv0.CATEGORY_MONTH,
		uv0.CATEGORY_SUPPLY
	}

	if #(slot0.shops[uv0.TYPE_ACTIVITY] or {}) &gt; 0 then
		table.insert(slot1, uv0.CATEGORY_ACTIVITY)
	end

	slot0.categoryUIList:make(function (slot0, slot1, slot2)
		if slot0 == UIItemList.EventUpdate then
			slot3 = uv0[slot1 + 1]

			uv1:UpdateCategory(slot2, slot3, false)

			uv1.categoryTrs[slot3] = slot2
		end
	end)
	slot0.categoryUIList:align(#slot1)
end

slot3 = function(slot0, slot1)
	slot2 = uv0.CATEGORY2NAME[slot1]
	slot4 = slot0:Find(&quot;label&quot;)
	slot5 = slot0:Find(&quot;selected/selected&quot;)
	slot6 = slot0:Find(&quot;lock&quot;):GetComponent(typeof(Image))
	slot6.sprite = GetSpriteFromAtlas(&quot;ui/ShopsUI_atlas&quot;, slot2 .. &quot;_lock&quot;)

	slot6:SetNativeSize()

	slot7 = slot4:GetComponent(typeof(Image))
	slot7.sprite = GetSpriteFromAtlas(&quot;ui/ShopsUI_atlas&quot;, slot2)

	slot7:SetNativeSize()

	slot8 = slot4:Find(&quot;en&quot;):GetComponent(typeof(Image))
	slot8.sprite = GetSpriteFromAtlas(&quot;ui/ShopsUI_atlas&quot;, slot2 .. &quot;_label&quot;)

	slot8:SetNativeSize()

	slot9 = slot5:GetComponent(typeof(Image))
	slot9.sprite = GetSpriteFromAtlas(&quot;ui/ShopsUI_atlas&quot;, slot2 .. &quot;_selected&quot;)

	slot9:SetNativeSize()

	slot10 = slot5.parent:Find(&quot;en&quot;):GetComponent(typeof(Image))
	slot10.sprite = GetSpriteFromAtlas(&quot;ui/ShopsUI_atlas&quot;, slot2 .. &quot;_label_selected&quot;)

	slot10:SetNativeSize()
end

slot0.UpdateCategory = function(slot0, slot1, slot2, slot3)
	setActive(slot1:Find(&quot;lock&quot;), slot3)
	setActive(slot1:Find(&quot;label&quot;), not slot3)
	setActive(slot1:Find(&quot;selected&quot;), false)
	uv0(slot1, slot2)
	onToggle(slot0, slot1, function (slot0)
		if slot0 then
			uv0:InitShops(uv1)

			uv0.category = uv1

			uv0:ActiveDefaultShop()
		end

		setActive(uv2:Find(&quot;label&quot;), not uv3 and not slot0)
		setActive(uv2:Find(&quot;selected&quot;), not uv3 and slot0)
	end, SFX_PANEL)
	setToggleEnabled(slot1, not slot3)
end

slot0.InitShops = function(slot0, slot1)
	if slot0.category and slot0.category == slot1 then
		return
	end

	slot3 = {}
	slot0.displayShops = {}
	slot0.prevBtn = nil

	for slot7, slot8 in pairs(uv0[slot1]) do
		slot9 = ipairs
		slot10 = slot0.shops[slot8] or {}

		for slot12, slot13 in slot9(slot10) do
			table.insert(slot3, {
				type = slot8,
				index = slot12
			})
		end
	end

	slot0.shopUIList:make(function (slot0, slot1, slot2)
		if slot0 == UIItemList.EventUpdate then
			slot3 = uv0[slot1 + 1]
			slot4 = uv1.pages[slot3.type]:CanOpen(slot3, uv1.player)

			setActive(slot2:Find(&quot;unsel/lock&quot;), not slot4)

			GetOrAddComponent(slot2:Find(&quot;unsel/label&quot;), &quot;CanvasGroup&quot;).alpha = slot4 and 1 or 0.4

			uv1:UpdateShop(slot2, slot3)

			if not uv1.displayShops[slot3.type] then
				uv1.displayShops[slot3.type] = {}
			end

			uv1.displayShops[slot3.type][slot3.index] = slot2
		end
	end)
	slot0.shopUIList:align(#slot3)
end

slot4 = function(slot0, slot1)
	slot2 = uv0.TYPE2NAME[slot1.type]

	setText(slot0:Find(&quot;selected/Text&quot;), slot2)
	setText(slot0:Find(&quot;unsel/label&quot;), slot2)
end

slot5 = function(slot0, slot1, slot2)
	onButton(slot0, slot1, function ()
		if uv0.prevBtn == uv1 then
			return
		end

		if uv2() then
			if uv0.prevBtn then
				setActive(uv0.prevBtn:Find(&quot;unsel&quot;), true)
				setActive(uv0.prevBtn:Find(&quot;selected&quot;), false)
			end

			setActive(uv3, false)
			setActive(uv4, true)

			uv0.prevBtn = uv1
		end
	end, SFX_PANEL)
	setActive(slot1:Find(&quot;unsel&quot;), true)
	setActive(slot1:Find(&quot;selected&quot;), false)
end

slot0.UpdateShop = function(slot0, slot1, slot2)
	uv0(slot1, slot2)

	slot3 = slot1:Find(&quot;selected&quot;)
	slot4 = slot1:Find(&quot;unsel&quot;)

	uv1(slot0, slot1, function ()
		slot2, slot3 = uv0.pages[uv1.type]:CanOpen(uv0.shops[uv1.type][uv1.index], uv0.player)

		if slot2 then
			if uv0.page and not uv0.page:GetLoaded() then
				return
			end

			if uv0.page then
				uv0.page:Hide()
			end

			uv0.contextData.bgView:Init(slot1:GetBg(slot0))
			slot1:ExecuteAction(&quot;SetUp&quot;, slot0, uv0.player, uv0.items)

			uv0.page = slot1
			uv0.contextData.activeShop = uv1.type
			uv0.recorder[uv0.category] = uv1

			return true
		else
			pg.TipsMgr.GetInstance():ShowTips(slot3)
		end

		return false
	end)
end

slot0.ActiveDefaultCategory = function(slot0)
	if type(slot0.contextData.warp or slot0.contextData.activeShop or uv0.TYPE_ACTIVITY) == &quot;string&quot; then
		slot1 = defaultValue(table.indexof(uv1, slot1), uv0.TYPE_ACTIVITY)
	end

	slot2 = slot0.contextData.index or 1

	if slot1 == uv0.TYPE_ACTIVITY and slot0.contextData.actId then
		slot3 = ipairs
		slot4 = slot0.shops[slot1] or {}

		for slot6, slot7 in slot3(slot4) do
			if slot7.activityId == slot0.contextData.actId then
				slot2 = slot6

				break
			end
		end
	elseif slot1 == uv0.TYPE_ACTIVITY and (not slot0.shops[uv0.TYPE_ACTIVITY] or #(slot0.shops[uv0.TYPE_ACTIVITY] or {}) &lt;= 0) then
		slot1 = uv0.TYPE_SHOP_STREET
		slot2 = 1
	elseif slot1 == uv0.TYPE_ACTIVITY and slot0.shops[uv0.TYPE_ACTIVITY] and #(slot0.shops[uv0.TYPE_ACTIVITY] or {}) &gt; 0 and not slot0.contextData.actId then
		slot4 = slot0.shops[slot1][1].activityId
		slot5 = ipairs
		slot6 = slot0.shops[slot1] or {}

		for slot8, slot9 in slot5(slot6) do
			if slot4 &lt; slot9.activityId then
				slot3 = slot8
			end
		end
	end

	slot3 = nil

	for slot7, slot8 in pairs(uv2) do
		if table.contains(slot8, slot1) then
			slot3 = slot7

			break
		end
	end

	assert(slot3 and slot0.categoryTrs[slot3])

	slot0.shopType = slot1
	slot0.shopIndex = slot2

	triggerToggle(slot0.categoryTrs[slot3], true)
end

slot0.ActiveDefaultShop = function(slot0)
	slot1, slot2 = nil

	if slot0.recorder[slot0.category] then
		slot3 = slot0.recorder[slot0.category]
		slot2 = slot3.index
		slot1 = slot3.type
	else
		slot2 = slot0.shopIndex or 1
		slot1 = slot0.shopType
	end

	slot3 = function()
		slot0 = nil

		for slot4, slot5 in pairs(uv0.displayShops) do
			for slot9, slot10 in pairs(slot5) do
				if uv0.pages[slot4]:CanOpen(nil, uv0.player) then
					slot0 = slot0 or slot10
				end
			end
		end

		if slot0 then
			triggerButton(slot0)
		end
	end

	if not slot1 then
		slot3()

		return
	end

	slot4, slot5 = slot0.pages[slot1]:CanOpen(nil, slot0.player)

	if slot4 and slot0.displayShops[slot1] and slot0.displayShops[slot1][slot2] then
		triggerButton(slot0.displayShops[slot1][slot2])
	else
		if not slot4 then
			pg.TipsMgr.GetInstance():ShowTips(slot5)
		end

		slot3()
	end
end

slot0.onBackPressed = function(slot0)
	if slot0.contextData.singleWindow:GetLoaded() and slot0.contextData.singleWindow:isShowing() then
		slot0.contextData.singleWindow:Close()

		return
	end

	if slot0.contextData.multiWindow:GetLoaded() and slot0.contextData.multiWindow:isShowing() then
		slot0.contextData.multiWindow:Close()

		return
	end

	if slot0.contextData.singleWindowForESkin:GetLoaded() and slot0.contextData.singleWindowForESkin:isShowing() then
		slot0.contextData.singleWindowForESkin:Hide()

		return
	end

	uv0.super.onBackPressed(slot0)
end

slot0.BlurView = function(slot0)
	slot1 = slot0.frameTr:Find(&quot;bg/blur&quot;)

	pg.UIMgr.GetInstance():OverlayPanelPB(slot0.frameTr, {
		pbList = {
			slot0.frameTr:Find(&quot;bg&quot;),
			slot1
		}
	})
	slot1:SetAsFirstSibling()
end

slot0.UnBlurView = function(slot0)
	pg.UIMgr.GetInstance():UnOverlayPanel(slot0.frameTr, slot0._tf)
end

slot0.willExit = function(slot0)
	if slot0.bulinTip then
		slot0.bulinTip:Destroy()

		slot0.bulinTip = nil
	end

	for slot4, slot5 in pairs(slot0.pages) do
		slot5:Destroy()
	end

	slot0:UnBlurView()
	slot0.contextData.singleWindow:Destroy()
	slot0.contextData.multiWindow:Destroy()
	slot0.contextData.singleWindowForESkin:Destroy()
	slot0.contextData.paintingView:Dispose()
	slot0.contextData.bgView:Dispose()

	slot0.contextData.singleWindow = nil
	slot0.contextData.multiWindow = nil
	slot0.contextData.singleWindowForESkin = nil
	slot0.contextData.paintingView = nil
	slot0.contextData.bgView = nil
	slot0.pages = nil
	slot0.bulinTip = nil
end

return slot0
</code></pre>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-lua.min.js"></script>
</body>
</html>