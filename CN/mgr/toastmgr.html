<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>toastmgr.lua</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
</head>
<body>
    <h1>toastmgr.lua</h1>
    <a href="index.html">返回主页</a>
    <pre><code class="language-lua">pg = pg or {}
pg.ToastMgr = singletonClass(&quot;ToastMgr&quot;)
slot0 = pg.ToastMgr
slot1 = require(&quot;Mgr/Pool/PoolPlural&quot;)
slot0.TYPE_ATTIRE = &quot;Attire&quot;
slot0.TYPE_TECPOINT = &quot;Tecpoint&quot;
slot0.TYPE_TROPHY = &quot;Trophy&quot;
slot0.TYPE_META = &quot;Meta&quot;
slot0.TYPE_CRUSING = &quot;Crusing&quot;
slot0.TYPE_VOTE = &quot;Vote&quot;
slot0.TYPE_EMOJI = &quot;Emoji&quot;
slot0.TYPE_COVER = &quot;Cover&quot;
slot0.TYPE_COMBAT_UI = &quot;CombatUI&quot;
slot0.ToastInfo = {
	[slot0.TYPE_ATTIRE] = {
		Attire = &quot;attire_tpl&quot;
	},
	[slot0.TYPE_TECPOINT] = {
		Buff = &quot;buff_tpl&quot;,
		Point = &quot;point_tpl&quot;
	},
	[slot0.TYPE_TROPHY] = {
		Trophy = &quot;trophy_tpl&quot;
	},
	[slot0.TYPE_META] = {
		MetaLevel = &quot;meta_level_tpl&quot;,
		MetaExp = &quot;meta_exp_tpl&quot;
	},
	[slot0.TYPE_CRUSING] = {
		Crusing = &quot;crusing_pt_tpl&quot;
	},
	[slot0.TYPE_VOTE] = {
		Vote = &quot;vote_tpl&quot;
	},
	[slot0.TYPE_EMOJI] = {
		Emoji = &quot;emoji_tpl&quot;
	},
	[slot0.TYPE_COVER] = {
		Cover = &quot;cover_tpl&quot;
	},
	[slot0.TYPE_COMBAT_UI] = {
		CombatUI = &quot;combatui_tpl&quot;
	}
}

slot0.Init = function(slot0, slot1)
	LoadAndInstantiateAsync(&quot;ui&quot;, &quot;ToastUI&quot;, function (slot0)
		uv0._go = slot0

		uv0._go:SetActive(false)

		uv0._tf = uv0._go.transform
		uv0.container = uv0._tf:Find(&quot;container&quot;)

		uv0._go.transform:SetParent(pg.UIMgr.GetInstance().OverlayToast, false)

		uv0.pools = {}
		slot1 = {}

		for slot5, slot6 in pairs(uv1.ToastInfo) do
			for slot10, slot11 in pairs(slot6) do
				slot1[slot10 .. &quot;Tpl&quot;] = slot11
			end
		end

		for slot5, slot6 in pairs(slot1) do
			slot7 = uv0._tf:Find(&quot;resources/&quot; .. slot6)

			if slot6 == &quot;meta_exp_tpl&quot; then
				setText(slot7:Find(&quot;ExpFull/Tip&quot;), i18n(&quot;meta_toast_fullexp&quot;))
				setText(slot7:Find(&quot;ExpAdd/Tip&quot;), i18n(&quot;meta_toast_tactics&quot;))
			end

			setActive(slot7, false)

			uv0.pools[slot5] = uv2.New(slot7.gameObject, 5)
		end

		uv0:ResetUIDandHistory()

		if uv3 then
			uv3()
		end
	end, true, true)
end

slot0.ResetUIDandHistory = function(slot0)
	slot0.completedJob = 0
	slot0.actionJob = 0
	slot0.buffer = {}
end

slot0.ShowToast = function(slot0, slot1, slot2)
	slot3 = #slot0.buffer

	table.insert(slot0.buffer, {
		state = 0,
		type = slot1,
		info = slot2
	})
	setActive(slot0._tf, true)

	if #slot0.buffer == 1 or slot0.buffer[slot3].state &gt;= 2 then
		slot0:Toast()
	end
end

slot0.Toast = function(slot0)
	if slot0.actionJob &gt;= #slot0.buffer then
		return
	end

	if slot0.buffer[slot0.actionJob] and slot0.buffer[slot0.actionJob].state &lt; 2 then
		return
	elseif slot0.buffer[slot0.actionJob] and slot0.buffer[slot0.actionJob].type ~= slot0.buffer[slot0.actionJob + 1].type and slot0.buffer[slot0.actionJob].state &lt; 3 then
		return
	end

	slot0.actionJob = slot0.actionJob + 1
	slot1 = slot0.buffer[slot0.actionJob]
	slot2 = slot0.actionJob
	slot1.state = 1

	slot0[&quot;Update&quot; .. slot1.type](slot0, slot1, function ()
		uv0.state = 2

		uv1:Toast()
	end, function ()
		uv0.state = 3

		if uv1.buffer[uv2 + 1] and uv1.buffer[uv2 + 1].state &lt; 1 then
			uv1:Toast()
		end

		uv1.completedJob = uv1.completedJob + 1

		if uv1.completedJob &gt;= #uv1.buffer then
			uv1:ResetUIDandHistory()
			setActive(uv1._tf, false)

			for slot3, slot4 in pairs(uv1.pools) do
				slot4:ClearItems(false)
			end
		end
	end)
end

slot0.GetAndSet = function(slot0, slot1, slot2)
	slot3 = slot0.pools[slot1 .. &quot;Tpl&quot;]:Dequeue()

	setActive(slot3, true)
	setParent(slot3, slot2)
	slot3.transform:SetAsLastSibling()

	return slot3
end

slot0.UpdateAttire = function(slot0, slot1, slot2, slot3)
	slot4 = slot0:GetAndSet(slot1.type, slot0.container)
	slot5 = slot4:GetComponent(typeof(DftAniEvent))

	slot5:SetTriggerEvent(function (slot0)
		if uv0 then
			uv0()
		end

		uv1:SetTriggerEvent(nil)
	end)
	slot5:SetEndEvent(function (slot0)
		setActive(uv0, false)
		uv1.pools[uv2.type .. &quot;Tpl&quot;]:Enqueue(uv0)
		uv3:SetEndEvent(nil)

		if uv4 then
			uv4()
		end
	end)
	slot4:GetComponent(typeof(Animation)):Play(&quot;attire&quot;)

	slot6 = slot1.info

	assert(isa(slot6, AttireFrame))
	setActive(slot4.transform:Find(&quot;bg/icon_frame&quot;), slot6:getType() == AttireConst.TYPE_ICON_FRAME)
	setActive(slot4.transform:Find(&quot;bg/chat_frame&quot;), slot7 == AttireConst.TYPE_CHAT_FRAME)
	setText(slot4.transform:Find(&quot;bg/Text&quot;), HXSet.hxLan(slot6:getConfig(&quot;name&quot;)))
end

slot0.UpdateCombatUI = function(slot0, slot1, slot2, slot3)
	slot4 = slot0:GetAndSet(slot1.type, slot0.container)
	slot5 = pg.item_data_battleui[slot1.info.id]

	LoadImageSpriteAsync(&quot;Props/&quot; .. slot5.display_icon, slot4.transform:Find(&quot;content/icon&quot;), true)
	setText(slot4.transform:Find(&quot;content/name&quot;), slot5.name)
	setText(slot4.transform:Find(&quot;content/label&quot;), i18n(&quot;battle_ui_unlock&quot;))

	slot6 = slot4.transform:Find(&quot;content&quot;)
	slot6.anchoredPosition = Vector2(-550, 0)

	LeanTween.moveX(rtf(slot6), 0, 0.5)
	LeanTween.moveX(rtf(slot6), -550, 0.5):setDelay(5):setOnComplete(System.Action(function ()
		setActive(uv0, false)
		uv1.pools[uv2.type .. &quot;Tpl&quot;]:Enqueue(uv0)

		if uv3 then
			uv3()
		end
	end))

	if slot2 then
		slot2()
	end
end

slot0.UpdateEmoji = function(slot0, slot1, slot2, slot3)
	slot4 = slot0:GetAndSet(slot1.type, slot0.container)
	slot5 = slot4:GetComponent(typeof(DftAniEvent))

	slot5:SetTriggerEvent(function (slot0)
		if uv0 then
			uv0()
		end

		uv1:SetTriggerEvent(nil)
	end)
	slot5:SetEndEvent(function (slot0)
		setActive(uv0, false)
		uv1.pools[uv2.type .. &quot;Tpl&quot;]:Enqueue(uv0)
		uv3:SetEndEvent(nil)

		if uv4 then
			uv4()
		end
	end)
	slot4:GetComponent(typeof(Animation)):Play(&quot;attire&quot;)
	setText(slot4.transform:Find(&quot;bg/label&quot;), i18n(&quot;word_emoji_unlock&quot;))
	setText(slot4.transform:Find(&quot;bg/Text&quot;), i18n(&quot;word_get_emoji&quot;, slot1.info.item_name))
end

slot0.FADE_TIME = 0.4
slot0.FADE_OUT_TIME = 1
slot0.SHOW_TIME = 1.5
slot0.DELAY_TIME = 0.3

slot0.UpdateTecpoint = function(slot0, slot1, slot2, slot3)
	slot4 = slot1.info
	slot7 = slot4.attr
	slot8 = slot4.value
	slot9 = slot0:GetAndSet(&quot;Point&quot;, slot0.container)
	GetComponent(slot9.transform, &quot;CanvasGroup&quot;).alpha = 0

	setText(findTF(slot9, &quot;PointText&quot;), &quot;+&quot; .. slot4.point)

	slot10 = {}

	if slot4.typeList then
		for slot14 = 1, #slot6 do
			slot15 = slot0:GetAndSet(&quot;Buff&quot;, slot0.container)
			GetComponent(slot15.transform, &quot;CanvasGroup&quot;).alpha = 0

			setImageSprite(slot15.transform:Find(&quot;TypeImg&quot;).transform, GetSpriteFromAtlas(&quot;ShipType&quot;, &quot;buffitem_tec_&quot; .. slot6[slot14]))
			setText(slot15.transform:Find(&quot;AttrText&quot;).transform, AttributeType.Type2Name(pg.attribute_info_by_type[slot7].name))
			setText(slot15.transform:Find(&quot;ValueText&quot;).transform, &quot;+&quot; .. slot8)

			slot10[slot14] = go(slot15)
		end
	end

	slot11 = function()
		if uv0 then
			uv0()
		end

		if uv1 then
			uv1()
		end
	end

	slot13 = GetComponent(slot9, &quot;CanvasGroup&quot;)

	slot15 = function()
		LeanTween.moveX(rtf(uv0), 0, uv1.FADE_OUT_TIME)
		LeanTween.value(uv0, 1, 0, uv1.FADE_OUT_TIME):setOnUpdate(System.Action_float(uv2)):setOnComplete(System.Action(function ()
			setActive(uv0, false)
			uv1.pools.PointTpl:Enqueue(uv0)

			if not uv2 then
				uv3()
			end
		end))
	end

	slot20 = uv0.FADE_TIME

	LeanTween.value(go(slot9), 0, 1, slot20):setOnUpdate(System.Action_float(function (slot0)
		uv0.alpha = slot0
	end)):setOnComplete(System.Action(function ()
		LeanTween.delayedCall(uv0, uv1.SHOW_TIME, System.Action(uv2))
	end))

	slot16 = function(slot0, slot1, slot2)
		slot3 = GetComponent(slot0.transform, &quot;CanvasGroup&quot;)

		slot5 = function()
			LeanTween.moveX(rtf(uv0), 0, uv1.FADE_OUT_TIME)
			LeanTween.value(uv0, 1, 0, uv1.FADE_OUT_TIME):setOnUpdate(System.Action_float(uv2)):setOnComplete(System.Action(function ()
				setActive(uv0, false)
				uv1.pools.BuffTpl:Enqueue(uv0)

				if uv2 then
					uv3()
				end
			end))
		end

		LeanTween.value(slot0, 0, 1, uv0.FADE_TIME):setOnUpdate(System.Action_float(function (slot0)
			uv0.alpha = slot0
		end)):setOnComplete(System.Action(function ()
			LeanTween.delayedCall(uv0, uv1.SHOW_TIME + (uv1.FADE_OUT_TIME - uv1.DELAY_TIME) * uv2, System.Action(uv3))
		end))
	end

	for slot20, slot21 in ipairs(slot10) do
		LeanTween.delayedCall(slot12, slot20 * uv0.DELAY_TIME, System.Action(function ()
			uv0(uv1, uv2, uv2 == #uv3)
		end))
	end
end

slot0.UpdateTrophy = function(slot0, slot1, slot2, slot3)
	slot4 = pg.CriMgr.GetInstance()

	slot4:PlaySoundEffect_V3(slot1.info.sound or SFX_UI_TIP)

	slot4 = slot0:GetAndSet(slot1.type, slot0.container)
	slot5 = pg.medal_template[slot1.info.id]

	LoadImageSpriteAsync(&quot;medal/s_&quot; .. slot5.icon, slot4.transform:Find(&quot;content/icon&quot;), true)
	setText(slot4.transform:Find(&quot;content/name&quot;), slot5.name)
	setText(slot4.transform:Find(&quot;content/label&quot;), i18n(&quot;trophy_achieved&quot;))

	slot6 = slot4.transform:Find(&quot;content&quot;)
	slot6.anchoredPosition = Vector2(-550, 0)

	LeanTween.moveX(rtf(slot6), 0, 0.5)
	LeanTween.moveX(rtf(slot6), -550, 0.5):setDelay(5):setOnComplete(System.Action(function ()
		setActive(uv0, false)
		uv1.pools[uv2.type .. &quot;Tpl&quot;]:Enqueue(uv0)

		if uv3 then
			uv3()
		end
	end))

	if slot2 then
		slot2()
	end
end

slot0.UpdateMeta = function(slot0, slot1, slot2, slot3)
	slot4 = slot1.info
	slot7 = slot0:GetAndSet(&quot;MetaExp&quot;, slot0.container)
	slot8 = slot0:GetAndSet(&quot;MetaLevel&quot;, slot0.container)
	slot10, slot11 = MetaCharacterConst.GetMetaCharacterToastPath(MetaCharacterConst.GetMetaShipGroupIDByConfigID(slot4.metaShipVO.configId))

	setImageSprite(slot7.transform:Find(&quot;ShipImg&quot;), LoadSprite(slot10, slot11))

	slot15 = slot4.addDayExp

	setSlider(slot7.transform:Find(&quot;Progress&quot;), 0, slot13, slot14)

	slot17 = slot4.curSkillID
	slot20 = slot4.oldSkillLevel &lt; slot4.newSkillLevel
	slot21 = slot7.transform:Find(&quot;ExpFull&quot;)
	slot22 = slot7.transform:Find(&quot;ExpAdd&quot;)

	if pg.gameset.meta_skill_exp_max.key_value &lt;= slot4.newDayExp then
		setActive(slot21, true)
		setActive(slot22, false)
	else
		setText(slot7.transform:Find(&quot;ExpAdd/Value&quot;), string.format(&quot;+%d&quot;, slot15))
		setActive(slot21, false)
		setActive(slot22, slot20)
	end

	if slot20 then
		setImageSprite(slot8.transform:Find(&quot;Skill/Icon&quot;), LoadSprite(&quot;skillicon/&quot; .. getSkillConfig(slot17).icon))

		slot25 = slot8.transform:Find(&quot;LevelUp&quot;)
		slot26 = slot8.transform:Find(&quot;LevelMax&quot;)

		if pg.skill_data_template[slot17].max_level &lt;= slot19 then
			setActive(slot25, false)
			setActive(slot26, true)
		else
			setText(slot8.transform:Find(&quot;LevelUp/Value&quot;), string.format(&quot;+%d&quot;, slot19 - slot18))
			setActive(slot25, true)
			setActive(slot26, false)
		end
	end

	slot23 = function()
		if uv0 then
			uv0()
		end

		if uv1 then
			uv1()
		end
	end

	GetComponent(slot7, &quot;CanvasGroup&quot;).alpha = 0
	GetComponent(slot8, &quot;CanvasGroup&quot;).alpha = 0

	if slot16 or slot20 then
		slot28 = function()
			LeanTween.moveX(rtf(uv0.transform), 0, uv1.FADE_OUT_TIME)
			LeanTween.value(uv0, 1, 0, uv1.FADE_OUT_TIME):setOnUpdate(System.Action_float(uv2)):setOnComplete(System.Action(function ()
				uv0.pools.MetaExpTpl:Enqueue(uv1)

				if not uv2 then
					uv0.pools.MetaLevelTpl:Enqueue(uv3)
					uv4()
				end
			end))
		end

		LeanTween.value(slot7, 0, 1, uv0.FADE_TIME):setOnUpdate(System.Action_float(function (slot0)
			uv0.alpha = slot0
		end)):setOnComplete(System.Action(function ()
			LeanTween.delayedCall(uv0, uv1.SHOW_TIME, System.Action(uv2))
		end))
	end

	if slot20 then
		slot27 = function(slot0)
			uv0.alpha = slot0
		end

		slot28 = function()
			LeanTween.moveX(rtf(uv0.transform), 0, uv1.FADE_OUT_TIME)
			LeanTween.value(uv0, 1, 0, uv1.FADE_OUT_TIME):setOnUpdate(System.Action_float(uv2)):setOnComplete(System.Action(function ()
				uv0.pools.MetaLevelTpl:Enqueue(uv1)
				uv2()
			end))
		end

		slot29 = function()
			LeanTween.delayedCall(uv0, uv1.SHOW_TIME, System.Action(uv2))
		end

		LeanTween.delayedCall(slot8, uv0.DELAY_TIME, System.Action(function ()
			LeanTween.value(uv0, 0, 1, uv1.FADE_TIME):setOnUpdate(System.Action_float(uv2)):setOnComplete(System.Action(uv3))
		end))
	end
end

slot0.UpdateCrusing = function(slot0, slot1, slot2, slot3)
	slot4 = slot1.info
	slot7 = pg.CriMgr.GetInstance()

	slot7:PlaySoundEffect_V3(slot1.info.sound or SFX_UI_TIP)

	slot7 = tf(slot0:GetAndSet(slot1.type, slot0.container))
	slot8 = Drop.New({
		type = DROP_TYPE_VITEM,
		id = slot4.ptId
	})

	LoadImageSpriteAtlasAsync(slot8:getIcon(), &quot;&quot;, slot7:Find(&quot;PointIcon&quot;), true)
	setText(slot7:Find(&quot;info/name&quot;), slot8:getName())
	setText(slot7:Find(&quot;info/pt&quot;), &quot;+&quot; .. slot4.ptCount)
	setAnchoredPosition(slot7, {
		x = slot7.rect.width
	})
	LeanTween.alphaCanvas(GetComponent(slot7, typeof(CanvasGroup)), 1, 0.5):setFrom(0):setOnComplete(System.Action(function ()
		LeanTween.alphaCanvas(uv0, 0, 0.5):setDelay(5):setOnComplete(System.Action(function ()
			setActive(uv0, false)
			uv1.pools[uv2.type .. &quot;Tpl&quot;]:Enqueue(go(uv0))

			if uv3 then
				uv3()
			end
		end))

		if uv5 then
			uv5()
		end
	end))
end

slot0.UpdateVote = function(slot0, slot1, slot2, slot3)
	slot4 = slot1.info
	slot7 = Drop.New({
		type = DROP_TYPE_ITEM,
		id = slot4.ptId
	})
	slot8 = tf(slot0:GetAndSet(slot1.type, slot0.container))

	LoadImageSpriteAtlasAsync(slot7:getIcon(), &quot;&quot;, slot8:Find(&quot;PointIcon&quot;), true)
	setText(slot8:Find(&quot;info/name&quot;), slot7:getName())
	setText(slot8:Find(&quot;info/pt&quot;), &quot;+&quot; .. slot4.ptCount)
	setAnchoredPosition(slot8, {
		x = slot8.rect.width
	})
	LeanTween.alphaCanvas(GetComponent(slot8, typeof(CanvasGroup)), 1, 0.5):setFrom(0):setOnComplete(System.Action(function ()
		LeanTween.alphaCanvas(uv0, 0, 0.5):setDelay(5):setOnComplete(System.Action(function ()
			setActive(uv0, false)
			uv1.pools[uv2.type .. &quot;Tpl&quot;]:Enqueue(go(uv0))

			if uv3 then
				uv3()
			end
		end))

		if uv5 then
			uv5()
		end
	end))
end

slot0.UpdateCover = function(slot0, slot1, slot2, slot3)
	slot4 = slot0:GetAndSet(slot1.type, slot0.container)
	slot5 = slot4:GetComponent(typeof(DftAniEvent))

	slot5:SetTriggerEvent(function (slot0)
		if uv0 then
			uv0()
		end

		uv1:SetTriggerEvent(nil)
	end)
	slot5:SetEndEvent(function (slot0)
		setActive(uv0, false)
		uv1.pools[uv2.type .. &quot;Tpl&quot;]:Enqueue(uv0)
		uv3:SetEndEvent(nil)

		if uv4 then
			uv4()
		end
	end)
	slot4:GetComponent(typeof(Animation)):Play(&quot;attire&quot;)
	setText(slot4.transform:Find(&quot;bg/Text&quot;), HXSet.hxLan(slot1.info:getConfig(&quot;get_tips&quot;)))
end

slot0.Dispose = function(slot0)
	setActive(slot0._tf, false)
	slot0:ResetUIDandHistory()

	for slot4, slot5 in pairs(slot0.pools) do
		slot5:Clear(false)
	end
end
</code></pre>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-lua.min.js"></script>
</body>
</html>