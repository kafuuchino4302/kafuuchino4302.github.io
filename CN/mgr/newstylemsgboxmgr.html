<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>newstylemsgboxmgr.lua</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
</head>
<body>
    <h1>newstylemsgboxmgr.lua</h1>
    <a href="index.html">返回主页</a>
    <pre><code class="language-lua">pg = pg or {}
slot1 = singletonClass(&quot;NewStyleMsgboxMgr&quot;)
pg.NewStyleMsgboxMgr = slot1
slot1.TYPE_MSGBOX = 1
slot1.TYPE_DROP = 2
slot1.TYPE_DROP_CLIENT = 3
slot1.TYPE_COMMON_MSGBOX = 4
slot1.TYPE_COMMON_HELP = 5
slot1.TYPE_COMMON_DROP = 6
slot1.TYPE_COMMON_ITEMS = 7
slot1.TYPE_SHIP_PREVIEW = 8
slot1.TYPE_COMMON_SHOPPING = 9
slot1.UI_NAME_DIC = {
	[slot1.TYPE_MSGBOX] = &quot;DormStyleMsgboxUI&quot;,
	[slot1.TYPE_DROP] = &quot;DormStyleDropMsgboxUI&quot;,
	[slot1.TYPE_DROP_CLIENT] = &quot;DormStyleDropMsgboxUI&quot;,
	[slot1.TYPE_COMMON_MSGBOX] = &quot;NewStyleMsgboxUI&quot;,
	[slot1.TYPE_COMMON_HELP] = &quot;NewStyleHelpMsgboxUI&quot;,
	[slot1.TYPE_COMMON_DROP] = &quot;NewStyleDropMsgboxUI&quot;,
	[slot1.TYPE_COMMON_ITEMS] = &quot;NewStyleItemsMsgboxUI&quot;,
	[slot1.TYPE_SHIP_PREVIEW] = &quot;ShipPreviewUI&quot;,
	[slot1.TYPE_COMMON_SHOPPING] = &quot;NewStyleShoppingMsgboxUI&quot;
}
slot1.BUTTON_TYPE = {
	blue = &quot;btn_confirm&quot;,
	shopping = &quot;btn_shopping&quot;,
	gray = &quot;btn_cancel&quot;,
	confirm = &quot;btn_confirm&quot;,
	cancel = &quot;btn_cancel&quot;
}
slot1.RES_LIST = {
	diamond = {
		&quot;ui/commonui_atlas&quot;,
		&quot;res_diamond&quot;
	},
	gold = {
		&quot;ui/commonui_atlas&quot;,
		&quot;res_gold&quot;
	},
	res_oil = {
		&quot;ui/commonui_atlas&quot;,
		&quot;res_oil&quot;
	},
	guildicon = {
		&quot;ui/share/msgbox_atlas&quot;,
		&quot;res_guildicon&quot;
	},
	world_money = {
		&quot;ui/share/world_common_atlas&quot;,
		&quot;res_Whuobi&quot;
	},
	port_money = {
		&quot;ui/share/world_common_atlas&quot;,
		&quot;res_Wzhaungbeibi&quot;
	},
	world_boss = {
		&quot;props/100000&quot;,
		&quot;&quot;
	}
}
slot1.COLOR_MAP = {
	[&quot;#[Ff][Ff][Dd][Ee]38&quot;] = &quot;#ffa944&quot;,
	[&quot;#92[Ff][Cc]63&quot;] = &quot;#238c40&quot;,
	[&quot;#6[Dd][Dd]329&quot;] = &quot;#238c40&quot;
}

slot1.Init = function(slot0, slot1)
	print(&quot;initializing new style msgbox manager...&quot;)

	slot0.showList = {}
	slot0.rtDic = {}
	slot0.richTextSprites = {}
	slot2 = {}

	for slot6, slot7 in pairs(uv0.RES_LIST) do
		table.insert(slot2, function (slot0)
			LoadSpriteAtlasAsync(uv0[1], uv0[2], function (slot0)
				uv0.richTextSprites[uv1] = slot0

				uv2()
			end)
		end)
	end

	seriesAsync(slot2, function ()
		existCall(uv0)
	end)
end

slot1.Show = function(slot0, ...)
	table.insert(slot0.showList, packEx(...))

	if #slot0.showList == 1 then
		slot0:DoShow(unpackEx(slot0.showList[1]))
	end
end

slot1.DeepShow = function(slot0, ...)
	if #slot0.showList == 0 then
		slot0:Show(...)
	else
		table.insert(slot0.showList, 1, packEx(...))
		slot0:Hide(true)
	end
end

slot1.DoShow = function(slot0, slot1, slot2)
	slot3 = {}

	if not slot0.rtDic[slot1] then
		table.insert(slot3, function (slot0)
			uv0.UIMgr.GetInstance():LoadingOn()
			PoolMgr.GetInstance():GetUI(uv1.UI_NAME_DIC[uv2], true, function (slot0)
				setParent(slot0, uv0.UIMgr.GetInstance().OverlayMain, false)

				uv1.rtDic[uv2] = slot0.transform

				uv0.UIMgr.GetInstance():LoadingOff()
				uv3()
			end)
		end)
	end

	seriesAsync(slot3, function ()
		uv0._tf = uv0.rtDic[uv1]

		if uv1 == uv2.TYPE_SHIP_PREVIEW then
			uv3.DelegateInfo.New(uv0)
		else
			uv0:CommonSetting(uv4)
		end

		uv0:DisplaySetting(uv1, uv4)
		uv3.UIMgr.GetInstance():BlurPanel(uv0._tf, false, uv4.blurParams or {
			weight = LayerWeightConst.SECOND_LAYER
		})
		setActive(uv0._tf, true)
	end)
end

slot1.Hide = function(slot0, slot1)
	if slot0.previewer then
		slot0.previewer:Destroy()

		slot0.previewer = nil

		return
	end

	if not slot0._tf then
		return
	end

	setActive(slot0._tf, false)
	slot0:Clear()
	uv0.UIMgr.GetInstance():UnblurPanel(slot0._tf, uv0.UIMgr.GetInstance().OverlayMain)

	slot0._tf = nil

	if not slot1 then
		table.remove(slot0.showList, 1)
	end

	if #slot0.showList &gt; 0 then
		slot0:DoShow(unpackEx(slot0.showList[1]))
	end
end

slot1.CommonSetting = function(slot0, slot1)
	uv0.DelegateInfo.New(slot0)
	setText(slot0._tf:Find(&quot;window/top/title&quot;), slot1.title or i18n(&quot;words_information&quot;))

	slot0.hideCall = function()
		uv0.hideCall = nil

		existCall(uv1.onClose)
	end

	onButton(slot0, slot0._tf:Find(&quot;bg&quot;), function ()
		existCall(uv0.hideCall)
		uv0:Hide()
	end, SFX_CANCEL)
	onButton(slot0, slot0._tf:Find(&quot;window/top/btn_close&quot;), function ()
		existCall(uv0.hideCall)
		uv0:Hide()
	end, SFX_CANCEL)

	slot0.confirmCall = function()
		uv0.confirmCall = nil

		existCall(uv1.onConfirm)
	end

	slot2 = slot1.btnList or {
		{
			type = uv1.BUTTON_TYPE.cancel,
			name = i18n(&quot;msgbox_text_cancel&quot;),
			func = function ()
				existCall(uv0.hideCall)
			end,
			sound = SFX_CANCEL
		},
		{
			type = uv1.BUTTON_TYPE.confirm,
			name = i18n(&quot;msgbox_text_confirm&quot;),
			func = function ()
				existCall(uv0.confirmCall)
			end,
			sound = SFX_CONFIRM
		}
	}

	eachChild(slot0._tf:Find(&quot;window/bottom/button_container&quot;), function (slot0)
		setActive(slot0, false)
	end)

	for slot7, slot8 in ipairs(slot2) do
		if slot3:Find(slot8.type):GetSiblingIndex() &lt; slot3.childCount - slot7 + 1 then
			slot9:SetAsLastSibling()
			setActive(slot9, true)
		else
			slot9 = cloneTplTo(slot9, slot3, slot9.name)
		end

		setText(slot9:Find(&quot;Text&quot;), slot8.name)
		onButton(slot0, slot9, function ()
			existCall(uv0.func)
			uv1:Hide()
		end, slot8.sound or SFX_CONFIRM)
	end
end

slot1.Clear = function(slot0)
	uv0.DelegateInfo.Dispose(slot0)

	slot0.hideCall = nil
	slot0.confirmCall = nil
end

slot1.DisplaySetting = function(slot0, slot1, slot2)
	switch(slot1, {
		[uv0.TYPE_MSGBOX] = function (slot0)
			setText(uv0._tf:Find(&quot;window/middle/content&quot;), slot0.contentText)
		end,
		[uv0.TYPE_DROP] = function (slot0)
			slot1 = slot0.drop
			slot2 = uv0._tf:Find(&quot;window/middle&quot;)

			updateCustomDrop(slot2:Find(&quot;Dorm3dIconTpl&quot;), slot0.drop, {
				style = slot0.style
			})
			setText(slot2:Find(&quot;info/name&quot;), slot1:getName())
			setText(slot2:Find(&quot;info/scroll/desc&quot;), cancelColorRich(slot1.desc))

			slot3, slot4 = slot1:getOwnedCount()

			setActive(slot2:Find(&quot;info/count&quot;), slot4)

			if slot4 then
				setText(slot2:Find(&quot;info/count&quot;), i18n(&quot;dorm3d_item_num&quot;) .. string.format(&quot;&lt;color=#39bfff&gt;%d&lt;/color&gt;&quot;, slot3))
			end
		end,
		[uv0.TYPE_DROP_CLIENT] = function (slot0)
			slot1 = uv0._tf:Find(&quot;window/middle&quot;)

			Dorm3dIconHelper.UpdateDorm3dIcon(slot1:Find(&quot;Dorm3dIconTpl&quot;), slot0.data)
			setActive(slot1:Find(&quot;info/count&quot;), false)
			setActive(slot1:Find(&quot;Dorm3dIconTpl/count&quot;), false)

			slot2 = Dorm3dIconHelper.Data2Config(slot0.data)

			setText(slot1:Find(&quot;info/name&quot;), slot2.name)
			setText(slot1:Find(&quot;info/scroll/desc&quot;), slot2.desc)
		end,
		[uv0.TYPE_COMMON_MSGBOX] = function (slot0)
			slot1 = uv0._tf:Find(&quot;window/middle/content&quot;)

			uv0:InitRichText(slot1)
			setTextInNewStyleBox(slot1, slot0.contentText)
		end,
		[uv0.TYPE_COMMON_HELP] = function (slot0)
			setActive(uv0._tf:Find(&quot;window/bottom&quot;), false)

			slot1 = uv0._tf:Find(&quot;window/middle/content&quot;)
			slot2 = UIItemList.New(slot1, slot1:Find(&quot;tpl&quot;))

			slot2:make(function (slot0, slot1, slot2)
				slot1 = slot1 + 1

				if slot0 == UIItemList.EventUpdate then
					slot3 = uv0.helps[slot1]

					setActive(slot2:Find(&quot;line&quot;), slot3.line)
					setTextInNewStyleBox(slot2:Find(&quot;Text&quot;), HXSet.hxLan(slot3.info and SwitchSpecialChar(slot3.info, true) or &quot;&quot;))
				end
			end)
			slot2:align(#slot0.helps)
		end,
		[uv0.TYPE_COMMON_DROP] = function (slot0)
			slot1 = slot0.drop
			slot2 = uv0._tf:Find(&quot;window/middle&quot;)

			updateDrop(slot2:Find(&quot;left/IconTpl&quot;), slot1)
			setText(slot2:Find(&quot;info/name_container/name/Text&quot;), slot1:getConfig(&quot;name&quot;))

			slot3 = slot2:Find(&quot;info/desc/Text&quot;)

			uv0:InitRichText(slot3)
			slot1:MsgboxIntroSet(slot0, slot3)
			setTextInNewStyleBox(slot3, slot3:GetComponent(typeof(Text)).text)
			UpdateOwnDisplay(slot2:Find(&quot;left/own&quot;), slot1)
			setText(slot2:Find(&quot;left/detail/Text&quot;), i18n(&quot;technology_detail&quot;))
			RegisterNewStyleDetailButton(uv0, slot2:Find(&quot;left/detail&quot;), slot1)

			slot4 = slot1.type == DROP_TYPE_SHIP

			setActive(slot2:Find(&quot;info/name_container/shiptype&quot;), slot4)
			setActive(slot2:Find(&quot;extra_info/ship&quot;), slot4)

			if slot4 then
				GetImageSpriteFromAtlasAsync(&quot;shiptype&quot;, shipType2print(slot1:getConfig(&quot;type&quot;)), slot5)

				slot7 = tobool(getProxy(CollectionProxy):getShipGroup(uv1.ship_data_template[slot1.id].group_type))

				setActive(slot6:Find(&quot;unlock&quot;), slot7)
				setText(slot6:Find(&quot;unlock/Text&quot;), i18n(&quot;tag_ship_unlocked&quot;))
				setActive(slot6:Find(&quot;lock&quot;), not slot7)
				setText(slot6:Find(&quot;lock/Text&quot;), i18n(&quot;tag_ship_locked&quot;))
			end

			slot7 = slot1.type == DROP_TYPE_EQUIPMENT_SKIN

			setActive(slot2:Find(&quot;extra_info/equip_skin&quot;), slot7)
			setActive(slot2:Find(&quot;left/placeholder&quot;), slot7)

			if slot7 then
				setTextInNewStyleBox(slot2:Find(&quot;info/desc/Text&quot;), slot1:getConfig(&quot;desc&quot;))
				setScrollText(slot8:Find(&quot;tag/mask/Text&quot;), i18n(&quot;word_fit&quot;) .. &quot;:&quot; .. table.concat(underscore.map(uv1.equip_skin_template[slot1.id].equip_type, function (slot0)
					return EquipType.Type2Name2(slot0)
				end), &quot;,&quot;))
				onButton(uv0, slot8:Find(&quot;play&quot;), function ()
					uv1:DeepShow(uv2.NewStyleMsgboxMgr.TYPE_SHIP_PREVIEW, {
						blurParams = {
							weight = LayerWeightConst.TOP_LAYER
						},
						shipVO = Ship.New({
							id = uv0.ship_config_id,
							configId = uv0.ship_config_id,
							skin_id = uv0.ship_skin_id
						}),
						weaponIds = uv0.ship_skin_id == 0 and Clone(uv0.weapon_ids) or {},
						equipSkinId = uv0.ship_skin_id == 0 and uv3.id or 0
					})
				end, SFX_PANEL)
			end

			slot9 = slot1.type == DROP_TYPE_COMBAT_UI_STYLE

			setActive(slot2:Find(&quot;extra_info/combat_skin&quot;), slot9)
			setActive(slot2:Find(&quot;left/placeholder&quot;), slot9)

			if slot9 then
				slot12 = UIItemList.New(slot2:Find(&quot;extra_info/combat_skin/elementList&quot;), slot2:Find(&quot;extra_info/combat_skin/elementList/main&quot;))

				slot12:make(function (slot0, slot1, slot2)
					if slot0 == UIItemList.EventUpdate then
						GetImageSpriteFromAtlasAsync(&quot;ui/combatskinrare&quot;, CombatSkinConst.TYPE_ICON_NAME[uv0[slot1 + 1]], slot2:Find(&quot;icon&quot;), true)
						setScrollText(slot2:Find(&quot;TextMask/Text&quot;), i18n(&quot;battleui_display&quot; .. uv0[slot1 + 1]))
					end
				end)
				slot12:align(#uv1.item_data_battleui[slot1.id].rare_display)
				onButton(uv0, slot10:Find(&quot;play&quot;), function ()
					uv0.previewer = CombatPreviewLayer.New(uv1.UIMgr.GetInstance().OverlayMain)

					uv0.previewer:ExecuteAction(&quot;Show&quot;, uv2.id, function ()
						uv0.previewer:Destroy()

						uv0.previewer = nil
					end)
				end, SFX_PANEL)
			end
		end,
		[uv0.TYPE_COMMON_ITEMS] = function (slot0)
			slot1 = uv0._tf:Find(&quot;window/middle&quot;)

			setActive(slot1:Find(&quot;info/Text&quot;), slot0.content)
			setTextInNewStyleBox(slot1:Find(&quot;info/Text&quot;), slot0.content or &quot;&quot;)

			slot3 = slot0.itemFunc
			slot4 = slot1:Find(&quot;scrollview/content&quot;)

			UIItemList.StaticAlign(slot4, slot4:Find(&quot;item&quot;), #slot0.items, function (slot0, slot1, slot2)
				slot1 = slot1 + 1

				if slot0 == UIItemList.EventUpdate then
					slot3 = uv0[slot1]

					updateDrop(slot2:Find(&quot;IconTpl&quot;), slot3, {
						anonymous = slot3.anonymous,
						hideName = slot3.hideName
					})

					slot4 = slot2:Find(&quot;IconTpl/name&quot;)

					setText(slot4, shortenString(getText(slot4), 6))
					setActive(slot2:Find(&quot;own&quot;), uv1.showOwn)

					if uv1.showOwn then
						setText(slot2:Find(&quot;own/Text&quot;), i18n(&quot;equip_skin_detail_count&quot;) .. slot3:getOwnedCount())
					end

					onButton(uv2, slot2, function ()
						if uv0.anonymous then
							return
						elseif uv1 then
							uv1(uv0)
						end
					end, SFX_UI_CLICK)
				end
			end)
		end,
		[uv0.TYPE_SHIP_PREVIEW] = function (slot0)
			slot1 = uv0._tf:Find(&quot;left_panel&quot;)
			slot2 = slot1:Find(&quot;sea&quot;):GetComponent(&quot;RawImage&quot;)

			setActive(slot2, false)

			slot3 = GameObject.Find(&quot;BarrageCamera&quot;):GetComponent(&quot;Camera&quot;)
			slot3.enabled = true
			slot3.targetTexture = slot2.texture
			slot4 = uv0._tf:Find(&quot;resources/heal&quot;)
			slot4.transform.localPosition = Vector3(-360, 50, 40)

			setActive(slot4, false)
			slot4:GetComponent(&quot;DftAniEvent&quot;):SetEndEvent(function ()
				setActive(uv0, false)
				setText(uv0:Find(&quot;text&quot;), &quot;&quot;)
			end)

			slot6 = slot1:Find(&quot;bg/loading&quot;)
			slot7 = nil

			onButton(uv0, slot6, function ()
				if not uv0 then
					uv0 = WeaponPreviewer.New(uv1)

					uv0:configUI(uv2)
					uv0:setDisplayWeapon(uv3.weaponIds, uv3.equipSkinId, true)
					uv0:load(40000, uv3.shipVO, uv3.weaponIds, function ()
						setActive(uv0, false)
					end)
				end
			end)
			setActive(slot6, true)
			onButton(uv0, uv0._tf, function ()
				setActive(uv0, false)

				if uv1 then
					uv1:clear()

					uv1 = nil
				end

				uv2:Hide()
			end, SFX_PANEL)
		end,
		[uv0.TYPE_COMMON_SHOPPING] = function (slot0)
			slot1 = uv0._tf:Find(&quot;window/middle&quot;)
			slot2 = slot0.drop

			updateDrop(slot1:Find(&quot;IconTpl&quot;), slot2)
			setText(slot1:Find(&quot;info/name/Text&quot;), slot2:getConfig(&quot;name&quot;))
			setText(slot1:Find(&quot;IconTpl/own&quot;), i18n(&quot;equip_skin_detail_count&quot;) .. slot2:getOwnedCount())
			uv0:InitRichText(slot1:Find(&quot;info/desc/Text&quot;))

			slot4 = uv0._tf:Find(&quot;window/bottom/button_container/btn_shopping/price/Text&quot;)
			slot5 = uv0._tf:Find(&quot;window/bottom/count&quot;)
			slot6 = PageUtil.New(slot5:Find(&quot;reduce&quot;), slot5:Find(&quot;increase&quot;), slot5:Find(&quot;max&quot;), slot5:Find(&quot;Text&quot;))
			slot7 = slot0.price
			slot8 = slot0.numUpdate

			slot6:setNumUpdate(function (slot0)
				if uv0 ~= nil then
					uv0(uv1, slot0)
				end

				setText(uv2, &quot;x&quot; .. slot0 * uv3)
			end)
			slot6:setAddNum(slot0.addNum or 1)
			slot6:setMaxNum(slot0.maxNum or -1)
			slot6:setDefaultNum(slot0.defaultNum or 1)
		end
	}, nil, slot2)
end

slot1.InitRichText = function(slot0, slot1)
	slot2 = slot1:GetComponent(&quot;RichText&quot;)

	for slot6, slot7 in pairs(slot0.richTextSprites) do
		slot2:AddSprite(slot6, slot7)
	end
end

slot1.emit = function(slot0, slot1, ...)
	if not slot0.analogyMediator then
		slot0.analogyMediator = {
			addSubLayers = function (slot0, slot1)
				uv0.m02:sendNotification(GAME.LOAD_LAYERS, {
					parentContext = getProxy(ContextProxy):getCurrentContext(),
					context = slot1
				})
			end,
			sendNotification = function (slot0, ...)
				uv0.m02:sendNotification(...)
			end,
			viewComponent = slot0
		}
	end

	return ContextMediator.CommonBindDic[slot1](slot0.analogyMediator, slot1, ...)
end

slot1.closeView = function(slot0)
	slot0:hide()
end

return slot1
</code></pre>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-lua.min.js"></script>
</body>
</html>