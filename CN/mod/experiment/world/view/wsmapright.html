<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>wsmapright.lua</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
</head>
<body>
    <h1>wsmapright.lua</h1>
    <a href="index.html">返回主页</a>
    <pre><code class="language-lua">slot0 = class(&quot;WSMapRight&quot;, import(&quot;...BaseEntity&quot;))
slot0.Fields = {
	map = &quot;table&quot;,
	btnPort = &quot;userdata&quot;,
	btnInventory = &quot;userdata&quot;,
	btnHelp = &quot;userdata&quot;,
	rtTipWord = &quot;userdata&quot;,
	btnDetail = &quot;userdata&quot;,
	tipEventPri = &quot;number&quot;,
	btnScan = &quot;userdata&quot;,
	toggleSkipPrecombat = &quot;userdata&quot;,
	world = &quot;table&quot;,
	btnInformation = &quot;userdata&quot;,
	toggleAutoFight = &quot;userdata&quot;,
	toggleAutoSwitch = &quot;userdata&quot;,
	entrance = &quot;table&quot;,
	btnTransport = &quot;userdata&quot;,
	gid = &quot;number&quot;,
	fleet = &quot;table&quot;,
	btnDefeat = &quot;userdata&quot;,
	btnExit = &quot;userdata&quot;,
	transform = &quot;userdata&quot;,
	wsCompass = &quot;table&quot;,
	btnOrder = &quot;userdata&quot;,
	taskProxy = &quot;table&quot;,
	rtCompassPanel = &quot;userdata&quot;,
	wsTimer = &quot;table&quot;,
	wsPool = &quot;table&quot;
}
slot0.Listeners = {
	onUpdateFleetBuff = &quot;OnUpdateFleetBuff&quot;,
	onClearLog = &quot;OnClearLog&quot;,
	onAppendLog = &quot;OnAppendLog&quot;,
	onUpdateFleetLocation = &quot;OnUpdateFleetLocation&quot;,
	onUpdateFleetDefeat = &quot;OnUpdateFleetDefeat&quot;,
	onUpdateInfoBtnTip = &quot;OnUpdateInfoBtnTip&quot;,
	onUpdateSelectedFleet = &quot;OnUpdateSelectedFleet&quot;
}

slot0.Setup = function(slot0)
	pg.DelegateInfo.New(slot0)
	slot0:Init()
end

slot0.Dispose = function(slot0)
	slot0.wsCompass:Dispose()
	slot0:RemoveFleetListener(slot0.fleet)
	slot0:RemoveMapListener()

	if slot0.taskProxy then
		slot0.taskProxy:RemoveListener(WorldTaskProxy.EventUpdateTask, slot0.onUpdateInfoBtnTip)

		slot0.taskProxy = nil
	end

	pg.DelegateInfo.Dispose(slot0)
	slot0:Clear()
end

slot0.Init = function(slot0)
	slot1 = slot0.transform
	slot0.rtCompassPanel = slot1:Find(&quot;compass_panel&quot;)
	slot0.btnOrder = slot0.rtCompassPanel:Find(&quot;btn_order&quot;)
	slot0.btnScan = slot0.rtCompassPanel:Find(&quot;btn_scan&quot;)
	slot0.btnDefeat = slot0.rtCompassPanel:Find(&quot;btn_defeat&quot;)
	slot0.btnDetail = slot0.rtCompassPanel:Find(&quot;btn_detail&quot;)
	slot0.toggleSkipPrecombat = slot1:Find(&quot;btn_list/lock_fleet&quot;)

	onToggle(slot0, slot0.toggleSkipPrecombat, function (slot0)
		PlayerPrefs.SetInt(&quot;world_skip_precombat&quot;, slot0 and 1 or 0)
	end, SFX_PANEL)

	slot0.toggleAutoFight = slot1:Find(&quot;btn_list/auto_fight&quot;)
	slot0.toggleAutoSwitch = slot1:Find(&quot;btn_list/auto_switch&quot;)
	slot0.btnInventory = slot1:Find(&quot;btn_list/dock/inventory_button&quot;)
	slot0.btnInformation = slot1:Find(&quot;btn_list/dock/information_button&quot;)
	slot0.btnTransport = slot1:Find(&quot;btn_list/dock/transport_button&quot;)
	slot0.btnHelp = slot1:Find(&quot;btn_list/dock/help_button&quot;)
	slot0.btnPort = slot1:Find(&quot;btn_list/dock/port_button&quot;)

	setActive(slot0.btnPort, false)

	slot0.btnExit = slot1:Find(&quot;btn_list/dock/exit_button&quot;)

	setActive(slot0.btnExit, false)

	slot0.wsCompass = WSCompass.New()
	slot0.wsCompass.tf = slot0.rtCompassPanel:Find(&quot;ring/compass&quot;)
	slot0.wsCompass.pool = slot0.wsPool

	slot0.wsCompass:Setup()

	slot0.rtTipWord = slot1:Find(&quot;tip_word&quot;)
	slot0.taskProxy = nowWorld():GetTaskProxy()

	slot0.taskProxy:AddListener(WorldTaskProxy.EventUpdateTask, slot0.onUpdateInfoBtnTip)
end

slot0.Update = function(slot0, slot1, slot2)
	if slot0.entrance ~= slot1 or slot0.map ~= slot2 or slot0.gid ~= slot2.gid then
		slot0:RemoveMapListener()

		slot0.entrance = slot1
		slot0.map = slot2
		slot0.gid = slot2.gid

		slot0:AddMapListener()
		slot0:OnUpdateSelectedFleet()
		slot0:UpdateCompass()
		slot0:UpdateBtns()
		slot0:OnUpdateEventTips()
	end
end

slot0.AddMapListener = function(slot0)
	if slot0.map then
		slot0.map:AddListener(WorldMap.EventUpdateFIndex, slot0.onUpdateSelectedFleet)
	end
end

slot0.RemoveMapListener = function(slot0)
	if slot0.map then
		slot0.map:RemoveListener(WorldMap.EventUpdateFIndex, slot0.onUpdateSelectedFleet)
	end
end

slot0.AddFleetListener = function(slot0, slot1)
	if slot1 then
		slot1:AddListener(WorldMapFleet.EventUpdateLocation, slot0.onUpdateFleetLocation)
		slot1:AddListener(WorldMapFleet.EventUpdateBuff, slot0.onUpdateFleetBuff)
		slot1:AddListener(WorldMapFleet.EventUpdateDefeat, slot0.onUpdateFleetDefeat)
	end
end

slot0.RemoveFleetListener = function(slot0, slot1)
	if slot1 then
		slot1:RemoveListener(WorldMapFleet.EventUpdateLocation, slot0.onUpdateFleetLocation)
		slot1:RemoveListener(WorldMapFleet.EventUpdateBuff, slot0.onUpdateFleetBuff)
		slot1:RemoveListener(WorldMapFleet.EventUpdateDefeat, slot0.onUpdateFleetDefeat)
	end
end

slot0.OnUpdateSelectedFleet = function(slot0, slot1)
	slot2 = slot0.map:GetFleet()

	if not slot1 or slot0.fleet ~= slot2 then
		slot0:RemoveFleetListener(slot0.fleet)

		slot0.fleet = slot2

		slot0:AddFleetListener(slot0.fleet)
		slot0:UpdateCompassRotation(slot2)
		slot0:OnUpdateFleetLocation()
		slot0:OnUpdateFleetBuff()
		slot0:OnUpdateFleetDefeat()
	end
end

slot0.OnUpdateFleetLocation = function(slot0)
	if not slot0.map.active then
		return
	end

	slot0:UpdateCompassMarks()
end

slot0.OnUpdateFleetBuff = function(slot0)
	setActive(slot0.wsCompass.tf, #slot0.fleet:GetBuffsByTrap(WorldBuff.TrapCompassInterference) == 0)
end

slot0.OnUpdateFleetDefeat = function(slot0)
	setText(slot0.btnDefeat:Find(&quot;Text&quot;), math.min(slot0.fleet:getDefeatCount(), 99))
end

slot0.UpdateCompass = function(slot0)
	slot0:UpdateCompassMarks()
	slot0:UpdateCompassRotation(slot0.map:GetFleet())
end

slot0.UpdateCompossView = function(slot0, slot1, slot2)
	slot0.wsCompass:UpdateByViewer(slot0.map, slot1, slot2)
end

slot0.UpdateCompassRotation = function(slot0, slot1)
	slot0.wsCompass:UpdateCompassRotation(slot1)
end

slot0.UpdateCompassMarks = function(slot0)
	slot0.wsCompass:ClearMarks()
	slot0.wsCompass:Update(slot0.entrance, slot0.map)
end

slot0.OnUpdateEventTips = function(slot0)
	slot1, slot2 = slot0.map:GetEventTipWord()

	if slot0.tipEventPri ~= slot2 then
		setActive(slot0.rtTipWord, false)

		slot0.tipEventPri = slot2
	end

	setActive(slot0.rtTipWord, slot2 &gt; 0)

	if slot2 &gt; 0 then
		setText(slot0.rtTipWord:Find(&quot;Text&quot;), slot1)
	end
end

slot0.UpdateBtns = function(slot0)
	setActive(slot0.btnPort, slot0.map:GetPort() and not slot1:IsTempPort())
	setActive(slot0.btnExit, slot0.map:canExit())
end

slot0.OnUpdateInfoBtnTip = function(slot0)
	slot2 = slot0.taskProxy
	slot3 = slot0.btnInformation

	setActive(slot3:Find(&quot;tip&quot;), _.any(slot2:getTaskVOs(), function (slot0)
		return slot0:getState() == WorldTask.STATE_FINISHED
	end))
end

slot0.OnUpdateHelpBtnTip = function(slot0, slot1)
	setActive(slot0.btnHelp:Find(&quot;imge/tip&quot;), WorldConst.IsWorldHelpNew(nowWorld():GetProgress(), slot1))
end

return slot0
</code></pre>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-lua.min.js"></script>
</body>
</html>