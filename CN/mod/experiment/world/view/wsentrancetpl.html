<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>wsentrancetpl.lua</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
</head>
<body>
    <h1>wsentrancetpl.lua</h1>
    <a href="index.html">返回主页</a>
    <pre><code class="language-lua">slot0 = class(&quot;WSEntranceTpl&quot;, import(&quot;...BaseEntity&quot;))
slot0.Fields = {
	markSigns = &quot;table&quot;,
	markTFs = &quot;table&quot;,
	world = &quot;table&quot;,
	transform = &quot;userdata&quot;,
	portCamp = &quot;number&quot;,
	entrance = &quot;table&quot;,
	tfMap = &quot;userdata&quot;,
	tfArea = &quot;userdata&quot;
}
slot0.Listeners = {
	onUpdateDisplayMarks = &quot;OnUpdateDisplayMarks&quot;
}
slot0.DisplayOrder = {
	&quot;step&quot;,
	&quot;task_main&quot;,
	&quot;task_collecktion&quot;,
	&quot;task&quot;,
	&quot;sairen&quot;,
	&quot;treasure_sairen&quot;,
	&quot;treasure&quot;,
	&quot;task_following_main&quot;,
	&quot;task_following_boss&quot;,
	&quot;task_following&quot;
}
slot0.prefabName = {
	task_main = &quot;DSJ_BX05_3D&quot;,
	task = &quot;DSJ_BX03_3D&quot;,
	port_gray_2 = &quot;mark_port_gray_2&quot;,
	port_mark = &quot;mark_port_tip&quot;,
	task_following_boss = &quot;DSJ_BX07_3D&quot;,
	buff_a = &quot;buff_a&quot;,
	buff_h = &quot;buff_h&quot;,
	buff_a2 = &quot;buff_a2&quot;,
	buff_h2 = &quot;buff_h2&quot;,
	port_mark_new = &quot;mark_port_tip_new&quot;,
	treasure_sairen = &quot;DSJ_BX06_3D&quot;,
	port_2 = &quot;mark_port_2&quot;,
	buff_d2 = &quot;buff_d2&quot;,
	currency = &quot;currency&quot;,
	port_gray_1 = &quot;mark_port_gray_1&quot;,
	port_1 = &quot;mark_port_1&quot;,
	mate = &quot;mate&quot;,
	buff_d = &quot;buff_d&quot;,
	task_collecktion = &quot;DSJ_BX08_3D&quot;,
	task_following = &quot;DSJ_BX03_3D&quot;,
	treasure = &quot;DSJ_BX01_3D&quot;,
	sairen = &quot;guangzhu&quot;,
	core = &quot;core&quot;,
	task_following_main = &quot;DSJ_BX05_3D&quot;,
	step = &quot;DSJ_BX05_3D&quot;
}
slot0.offsetField = {
	task_main = &quot;offset_pos&quot;,
	task_following_main = &quot;offset_pos&quot;,
	task_following_boss = &quot;offset_pos&quot;,
	task_following = &quot;offset_pos&quot;,
	task_collecktion = &quot;offset_pos&quot;,
	task = &quot;offset_pos&quot;,
	treasure = &quot;offset_pos&quot;,
	treasure_sairen = &quot;offset_pos&quot;,
	step = &quot;offset_pos&quot;
}

slot0.Build = function(slot0)
	slot0.transform = tf(GameObject.New())
end

slot0.Setup = function(slot0)
	pg.DelegateInfo.New(slot0)
	slot0:Init()
end

slot0.Dispose = function(slot0)
	pg.DelegateInfo.Dispose(slot0)
	slot0:RemoveEntranceListener()

	slot1 = PoolMgr.GetInstance()

	for slot5, slot6 in pairs(slot0.markTFs) do
		slot6.localPosition = Vector3.zero

		slot1:ReturnPrefab(&quot;world/mark/&quot; .. uv0.prefabName[slot5], uv0.prefabName[slot5], go(slot6), true)
	end

	Destroy(slot0.transform)
	slot0:Clear()
end

slot0.Init = function(slot0)
	slot0.markTFs = {}
end

slot0.UpdateEntrance = function(slot0, slot1, slot2)
	if slot2 or slot0.entrance ~= slot1 then
		slot0:RemoveEntranceListener()
		_.each(slot0.markTFs, function (slot0)
			setActive(slot0, false)
		end)

		slot0.entrance = slot1
		slot0.portCamp = slot0.entrance:HasPort() and pg.world_port_data[slot0.entrance.config.port_map_icon].port_camp or nil

		slot0:AddEntranceListener()
		slot0:InitMarksValue()

		slot0.transform.name = slot0.portCamp and &quot;port_&quot; .. slot1.id or slot1:GetColormaskUniqueID()

		slot0:DoUpdateMark(slot0:GetShowMark(), true)
	end
end

slot0.InitMarksValue = function(slot0)
	slot0.markSigns = {}

	for slot5, slot6 in pairs(slot0.entrance:GetDisplayMarks()) do
		slot0.markSigns[slot5] = slot6 &gt; 0
	end
end

slot0.AddEntranceListener = function(slot0)
	if slot0.entrance then
		slot0.entrance:AddListener(WorldEntrance.EventUpdateDisplayMarks, slot0.onUpdateDisplayMarks)
	end
end

slot0.RemoveEntranceListener = function(slot0)
	if slot0.entrance then
		slot0.entrance:RemoveListener(WorldEntrance.EventUpdateDisplayMarks, slot0.onUpdateDisplayMarks)
	end
end

slot0.LoadPrefab = function(slot0, slot1, slot2)
	slot3 = PoolMgr.GetInstance()

	slot3:GetPrefab(&quot;world/mark/&quot; .. uv0.prefabName[slot1], uv0.prefabName[slot1], true, function (slot0)
		if uv0.markTFs and not uv0.markTFs[uv1] then
			uv0.markTFs[uv1] = tf(slot0)

			SetParent(uv0.markTFs[uv1], uv0.transform, false)

			uv0.markTFs[uv1].localPosition = uv0:GetPrefabOffset(uv1)

			if uv2 then
				SetParent(uv0.markTFs[uv1], uv2, true)
			end

			setActive(uv0.markTFs[uv1], true)
		else
			uv3:ReturnPrefab(&quot;world/mark/&quot; .. uv4.prefabName[uv1], uv4.prefabName[uv1], slot0, true)
		end
	end)
end

slot0.GetPrefabOffset = function(slot0, slot1)
	slot2 = uv0.offsetField[slot1] and slot0.entrance.config[uv0.offsetField[slot1]] or {
		0,
		0
	}

	return Vector3(slot2[1] / PIXEL_PER_UNIT, 0, slot2[2] / PIXEL_PER_UNIT)
end

slot0.UpdateMark = function(slot0, slot1, slot2)
	slot0:DoUpdateMark(slot0:GetShowMark(), false)

	slot0.markSigns[slot1] = slot2

	slot0:DoUpdateMark(slot0:GetShowMark(), true)
end

slot0.OnUpdateDisplayMarks = function(slot0, slot1, slot2, slot3, slot4)
	slot0:UpdateMark(slot3, slot4)
end

slot0.DoUpdateMark = function(slot0, slot1, slot2, slot3)
	if slot1 then
		if slot0.markTFs[slot1] then
			setActive(slot0.markTFs[slot1], slot2)
		elseif slot2 then
			slot0:LoadPrefab(slot1, slot3)
		end
	end
end

slot0.GetShowMark = function(slot0)
	for slot4, slot5 in ipairs(uv0.DisplayOrder) do
		if slot0.markSigns[slot5] then
			return slot5
		end
	end
end

slot0.UpdatePort = function(slot0, slot1, slot2, slot3)
	slot0:DoUpdateMark(&quot;port_&quot; .. slot0.portCamp, slot1)
	slot0:DoUpdateMark(&quot;port_gray_&quot; .. slot0.portCamp, not slot1)
	slot0:DoUpdateMark(&quot;port_mark&quot;, slot2)
	slot0:DoUpdateMark(&quot;port_mark_new&quot;, slot3)
end

slot0.UpdatePressingAward = function(slot0)
	if nowWorld():GetPressingAward(slot0.entrance.id) then
		slot0:DoUpdateMark(pg.world_event_complete[slot1.id].map_icon, slot1.flag, slot0.tfMap)
	end
end

return slot0
</code></pre>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-lua.min.js"></script>
</body>
</html>