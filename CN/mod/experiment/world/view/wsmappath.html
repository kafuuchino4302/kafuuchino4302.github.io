<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>wsmappath.lua</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
</head>
<body>
    <h1>wsmappath.lua</h1>
    <a href="index.html">返回主页</a>
    <pre><code class="language-lua">slot0 = class(&quot;WSMapPath&quot;, import(&quot;...BaseEntity&quot;))
slot0.Fields = {
	path = &quot;table&quot;,
	startPos = &quot;table&quot;,
	upOffset = &quot;number&quot;,
	theme = &quot;table&quot;,
	moveAction = &quot;string&quot;,
	wsObject = &quot;table&quot;,
	twId = &quot;number&quot;,
	paused = &quot;boolean&quot;,
	dirType = &quot;number&quot;,
	step = &quot;number&quot;
}
slot0.EventStartTrip = &quot;WSMapPath.EventStartTrip&quot;
slot0.EventArrivedStep = &quot;WSMapPath.EventArrivedStep&quot;
slot0.EventArrived = &quot;WSMapPath.EventArrived&quot;

slot0.Setup = function(slot0, slot1)
	slot0.theme = slot1
end

slot0.Dispose = function(slot0)
	if slot0.twId then
		LeanTween.cancel(slot0.twId)
	end

	slot0:Clear()
end

slot0.UpdateObject = function(slot0, slot1)
	assert(slot1.GetModelAngles and slot1.UpdateModelAngles and slot1.UpdateModelAction)

	slot0.wsObject = slot1
end

slot0.UpdateAction = function(slot0, slot1)
	slot0.moveAction = slot1
end

slot0.UpdateDirType = function(slot0, slot1)
	slot0.dirType = slot1
end

slot0.StartMove = function(slot0, slot1, slot2, slot3)
	slot0.startPos = slot1
	slot0.path = slot2
	slot0.upOffset = slot3 or 0
	slot0.step = 0
	slot0.wsObject.isMoving = true

	slot0.wsObject:UpdateModelAction(slot0.moveAction)
	slot0:DispatchEvent(uv0.EventStartTrip)
	slot0:MoveStep()
end

slot0.MoveStep = function(slot0)
	slot2 = slot0.path
	slot3 = slot0.step &gt; 0 and slot2[slot0.step] or slot0.startPos
	slot4 = slot2[slot0.step + 1]
	slot5 = slot2[#slot2]
	slot6 = slot0.wsObject:GetModelAngles()

	if slot0.dirType == WorldConst.DirType4 then
		if slot4.column &lt; slot3.column then
			slot6.z = 180
		elseif slot3.column &lt; slot4.column then
			slot6.z = 0
		elseif slot4.row &lt; slot3.row then
			slot6.z = 90
		elseif slot3.row &lt; slot4.row then
			slot6.z = 270
		end

		slot1:UpdateModelAngles(slot6)
	elseif slot0.dirType == WorldConst.DirType2 then
		if slot4.column &lt; slot3.column or slot4.column == slot3.column and slot5.column &lt; slot3.column then
			slot6.y = 180
		elseif slot4.column ~= slot3.column or slot5.column ~= slot3.column then
			slot6.y = 0
		end

		slot1:UpdateModelAngles(slot6)
	end

	slot7 = slot0.theme:GetLinePosition(slot3.row, slot3.column)
	slot8 = slot0.theme:GetLinePosition(slot4.row, slot4.column)

	assert(slot4.duration, &quot;without move duration&quot;)

	slot0.twId = LeanTween.value(slot1.transform.gameObject, 0, 1, slot4.duration):setOnUpdate(System.Action_float(function (slot0)
		slot2, slot3 = uv2:CalcUpOffset(uv2.step, slot0)
		uv3.transform.localPosition = Vector3.Lerp(uv0, uv1, slot0) + slot2

		if uv3.rtShadow then
			uv3.rtShadow.localPosition = Vector3(0, -slot3, 0)
		end
	end)):setOnComplete(System.Action(function ()
		uv0.step = uv0.step + 1

		if uv0.step &gt;= #uv1 then
			uv0.twId = nil

			uv2:UpdateModelAction(WorldConst.ActionIdle)

			uv2.isMoving = false

			uv0:DispatchEvent(uv3.EventArrived)
		else
			uv0:DispatchEvent(uv3.EventArrivedStep, uv4)
			onDelayTick(function ()
				uv0:MoveStep()
			end, 0.015)
		end
	end)).uniqueId

	slot0:FlushPaused()
end

slot0.UpdatePaused = function(slot0, slot1)
	if slot0.paused ~= slot1 then
		slot0.paused = slot1

		slot0:FlushPaused()
	end
end

slot0.FlushPaused = function(slot0)
	if slot0.paused then
		LeanTween.pause(slot0.twId)
		slot0.wsObject:UpdateModelAction(WorldConst.ActionIdle)
	else
		LeanTween.resume(slot0.twId)
		slot0.wsObject:UpdateModelAction(slot0.moveAction)
	end
end

slot0.CalcUpOffset = function(slot0, slot1, slot2)
	slot4 = math.clamp(math.sin((slot1 + slot2) / #slot0.path * math.pi), 0, 1) * slot0.upOffset

	return Vector3(0, slot0.theme.cosAngle * slot4, -slot0.theme.sinAngle * slot4), slot4
end

slot0.IsMoving = function(slot0)
	return slot0.twId ~= nil
end

return slot0
</code></pre>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-lua.min.js"></script>
</body>
</html>