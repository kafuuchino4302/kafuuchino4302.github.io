<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>wsmaptop.lua</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
</head>
<body>
    <h1>wsmaptop.lua</h1>
    <a href="index.html">返回主页</a>
    <pre><code class="language-lua">slot0 = class(&quot;WSMapTop&quot;, import(&quot;...BaseEntity&quot;))
slot0.Fields = {
	map = &quot;table&quot;,
	btnBack = &quot;userdata&quot;,
	rtGlobalBuffs = &quot;userdata&quot;,
	gid = &quot;number&quot;,
	rtResource = &quot;userdata&quot;,
	rtTime = &quot;userdata&quot;,
	cmdSkills = &quot;table&quot;,
	rtFleetBuffs = &quot;userdata&quot;,
	rtCmdSkills = &quot;userdata&quot;,
	rtMapName = &quot;userdata&quot;,
	entrance = &quot;table&quot;,
	rtPoisonRate = &quot;userdata&quot;,
	fleet = &quot;table&quot;,
	cmdSkillFunc = &quot;function&quot;,
	fleetBuffItemList = &quot;table&quot;,
	world = &quot;table&quot;,
	transform = &quot;userdata&quot;,
	globalBuffItemList = &quot;table&quot;,
	cmdSkillItemList = &quot;table&quot;,
	globalBuffs = &quot;table&quot;,
	poisonFunc = &quot;function&quot;,
	fleetBuffs = &quot;table&quot;,
	rtMoveLimit = &quot;userdata&quot;
}
slot0.Listeners = {
	onUpdateFleetBuff = &quot;OnUpdateFleetBuff&quot;,
	onUpdateGlobalBuff = &quot;OnUpdateGlobalBuff&quot;,
	onUpdateCmdSkill = &quot;OnUpdateCmdSkill&quot;,
	onUpdateSelectedFleet = &quot;OnUpdateSelectedFleet&quot;
}

slot0.Setup = function(slot0)
	slot1 = nowWorld()

	slot1:AddListener(World.EventUpdateGlobalBuff, slot0.onUpdateGlobalBuff)
	slot1:GetAtlas():AddListener(WorldAtlas.EventUpdateActiveMap, slot0.onUpdateFleetBuff)
	pg.DelegateInfo.New(slot0)
	slot0:Init()
end

slot0.Dispose = function(slot0)
	slot1 = nowWorld()

	slot1:RemoveListener(World.EventUpdateGlobalBuff, slot0.onUpdateGlobalBuff)
	slot1:GetAtlas():RemoveListener(WorldAtlas.EventUpdateActiveMap, slot0.onUpdateFleetBuff)
	slot0:RemoveFleetListener(slot0.fleet)
	slot0:RemoveMapListener()
	pg.DelegateInfo.Dispose(slot0)
	slot0:Clear()
end

slot1 = function(slot0, slot1)
	if slot1.config.icon and #slot1.config.icon &gt; 0 then
		GetImageSpriteFromAtlasAsync(&quot;world/buff/&quot; .. slot1.config.icon, &quot;&quot;, slot0:Find(&quot;icon&quot;))
	else
		clearImageSprite(slot0:Find(&quot;icon&quot;))
	end

	setText(slot0:Find(&quot;floor&quot;), slot1:GetFloor())
	setActive(slot0:Find(&quot;floor&quot;), slot1.config.buff_maxfloor &gt; 1)

	slot2 = slot1:GetLost()

	setText(slot0:Find(&quot;lost&quot;), slot2)
	setActive(slot0:Find(&quot;lost&quot;), slot2)
	onButton(self, slot0, function ()
		pg.MsgboxMgr.GetInstance():ShowMsgBox({
			yesText = &quot;text_confirm&quot;,
			hideNo = true,
			content = &quot;&quot;,
			type = MSGBOX_TYPE_SINGLE_ITEM,
			drop = Drop.New({
				isWorldBuff = true,
				type = DROP_TYPE_STRATEGY,
				id = uv0.id
			})
		})
	end, SFX_PANEL)
end

slot0.Init = function(slot0)
	slot1 = slot0.transform
	slot0.btnBack = slot1:Find(&quot;back_button&quot;)
	slot0.rtMapName = slot1:Find(&quot;title/name&quot;)
	slot0.rtTime = slot1:Find(&quot;title/time&quot;)
	slot0.rtResource = slot1:Find(&quot;resources&quot;)
	slot0.rtGlobalBuffs = slot1:Find(&quot;features/status_field/global_buffs&quot;)
	slot0.rtMoveLimit = slot1:Find(&quot;features/status_field/move_limit&quot;)
	slot0.rtPoisonRate = slot1:Find(&quot;features/status_field/poison_rate&quot;)
	slot0.rtFleetBuffs = slot1:Find(&quot;features/fleet_field/fleet_buffs&quot;)
	slot0.rtCmdSkills = slot1:Find(&quot;features/fleet_field/cmd_skills&quot;)

	setText(slot0.rtMapName, &quot;&quot;)
	setText(slot0.rtTime, &quot;&quot;)

	slot4 = slot0.rtGlobalBuffs
	slot0.globalBuffItemList = UIItemList.New(slot0.rtGlobalBuffs, slot4:GetChild(0))
	slot2 = slot0.globalBuffItemList

	slot2:make(function (slot0, slot1, slot2)
		if slot0 == UIItemList.EventUpdate then
			uv0(slot2, uv1.globalBuffs[slot1 + 1])
		end
	end)

	slot4 = slot0.rtFleetBuffs
	slot0.fleetBuffItemList = UIItemList.New(slot0.rtFleetBuffs, slot4:GetChild(0))
	slot2 = slot0.fleetBuffItemList

	slot2:make(function (slot0, slot1, slot2)
		if slot0 == UIItemList.EventUpdate then
			uv0(slot2, uv1.fleetBuffs[slot1 + 1])
		end
	end)

	slot4 = slot0.rtCmdSkills
	slot0.cmdSkillItemList = UIItemList.New(slot0.rtCmdSkills, slot4:GetChild(0))
	slot2 = slot0.cmdSkillItemList

	slot2:make(function (slot0, slot1, slot2)
		if slot0 == UIItemList.EventUpdate then
			slot3 = uv0.cmdSkills[slot1 + 1]

			GetImageSpriteFromAtlasAsync(&quot;commanderskillicon/&quot; .. slot3:getConfig(&quot;icon&quot;), &quot;&quot;, slot2:Find(&quot;icon&quot;))
			setText(slot2:Find(&quot;floor&quot;), &quot;Lv.&quot; .. slot3:getConfig(&quot;lv&quot;))
			setActive(slot2:Find(&quot;floor&quot;), true)
			setActive(slot2:Find(&quot;lost&quot;), false)
			onButton(uv0, slot2, function ()
				uv0.cmdSkillFunc(uv1)
			end, SFX_PANEL)
		end
	end)
end

slot0.Update = function(slot0, slot1, slot2)
	if slot0.entrance ~= slot1 or slot0.map ~= slot2 or slot0.gid ~= slot2.gid then
		slot0:RemoveMapListener()

		slot0.entrance = slot1
		slot0.map = slot2
		slot0.gid = slot2.gid

		slot0:AddMapListener()
		slot0:OnUpdateMap()
		slot0:OnUpdateSelectedFleet()
		slot0:OnUpdateGlobalBuff()
		slot0:OnUpdatePoison()
		slot0:OnUpdateMoveLimit()
	end
end

slot0.AddMapListener = function(slot0)
	if slot0.map then
		slot0.map:AddListener(WorldMap.EventUpdateFIndex, slot0.onUpdateSelectedFleet)
	end
end

slot0.RemoveMapListener = function(slot0)
	if slot0.map then
		slot0.map:RemoveListener(WorldMap.EventUpdateFIndex, slot0.onUpdateSelectedFleet)
	end
end

slot0.AddFleetListener = function(slot0, slot1)
	if slot1 then
		slot1:AddListener(WorldMapFleet.EventUpdateBuff, slot0.onUpdateFleetBuff)
		slot1:AddListener(WorldMapFleet.EventUpdateDamageLevel, slot0.onUpdateFleetBuff)
		slot1:AddListener(WorldMapFleet.EventUpdateCatSalvage, slot0.onUpdateCmdSkill)
	end
end

slot0.RemoveFleetListener = function(slot0, slot1)
	if slot1 then
		slot1:RemoveListener(WorldMapFleet.EventUpdateBuff, slot0.onUpdateFleetBuff)
		slot1:RemoveListener(WorldMapFleet.EventUpdateDamageLevel, slot0.onUpdateFleetBuff)
		slot1:RemoveListener(WorldMapFleet.EventUpdateCatSalvage, slot0.onUpdateCmdSkill)
	end
end

slot0.OnUpdateMap = function(slot0)
	setText(slot0.rtMapName, slot0.map:GetName(slot0.entrance))
end

slot0.OnUpdateSelectedFleet = function(slot0)
	if slot0.fleet ~= slot0.map:GetFleet() then
		slot0:RemoveFleetListener(slot0.fleet)

		slot0.fleet = slot1

		slot0:AddFleetListener(slot0.fleet)
		slot0:OnUpdateFleetBuff()
		slot0:OnUpdateCmdSkill()
	end
end

slot0.OnUpdateGlobalBuff = function(slot0)
	slot0.globalBuffs = nowWorld():GetWorldMapBuffs()

	slot0.globalBuffItemList:align(#slot0.globalBuffs)
end

slot0.OnUpdateMoveLimit = function(slot0)
	slot1 = not slot0.map:IsUnlockFleetMode()

	setActive(slot0.rtMoveLimit, slot1)

	if slot1 then
		slot2 = WorldBuff.New()

		slot2:Setup({
			floor = 0,
			id = WorldConst.MoveLimitBuffId
		})
		uv0(slot0.rtMoveLimit, slot2)
	end
end

slot0.OnUpdatePoison = function(slot0)
	slot1, slot2 = slot0.map:GetEventPoisonRate()

	setActive(slot0.rtPoisonRate, slot2 &gt; 0)

	if slot2 &gt; 0 then
		slot3 = calcFloor(slot1 / slot2 * 100)
		slot4 = Clone(pg.gameset.world_sairen_infection.description)

		table.insert(slot4, 1, 0)
		table.insert(slot4, 999)

		slot6 = slot0.rtPoisonRate

		eachChild(slot6:Find(&quot;bg/ring&quot;), function (slot0)
			if uv1[slot0:GetSiblingIndex() + 1] &lt;= uv0 and uv0 &lt; uv1[slot1 + 1] then
				setActive(slot0, true)

				slot0:GetComponent(typeof(Image)).fillAmount = uv0 / 100
			else
				setActive(slot0, false)
			end

			setText(uv2.rtPoisonRate:Find(&quot;bg/Text&quot;), uv0 .. &quot;%&quot;)
		end)
		onButton(slot0, slot0.rtPoisonRate, function ()
			uv0.poisonFunc(uv1)
		end, SFX_PANEL)
	end
end

slot0.OnUpdateFleetBuff = function(slot0)
	slot0.fleetBuffs = slot0.fleet:GetBuffList()

	if slot0.fleet:GetDamageBuff() then
		table.insert(slot0.fleetBuffs, 1, slot1)
	end

	slot0.fleetBuffItemList:align(#slot0.fleetBuffs)
	setActive(slot0.rtFleetBuffs, #slot0.fleetBuffs &gt; 0)
end

slot0.OnUpdateCmdSkill = function(slot0)
	if slot0.fleet:IsCatSalvage() then
		slot0.cmdSkills = {}
	else
		slot3 = slot0.fleet
		slot0.cmdSkills = _.map(_.values(slot3:getCommanders()), function (slot0)
			return slot0:getSkills()[1]
		end)
	end

	slot0.cmdSkillItemList:align(#slot0.cmdSkills)
	setActive(slot0.rtCmdSkills, #slot0.cmdSkills &gt; 0)
end

return slot0
</code></pre>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-lua.min.js"></script>
</body>
</html>