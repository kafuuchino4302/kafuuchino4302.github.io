<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>svorderpanel.lua</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
</head>
<body>
    <h1>svorderpanel.lua</h1>
    <a href="index.html">返回主页</a>
    <pre><code class="language-lua">slot0 = class(&quot;SVOrderPanel&quot;, import(&quot;view.base.BaseSubView&quot;))

slot0.getUIName = function(slot0)
	return &quot;SVOrderPanel&quot;
end

slot0.getBGM = function(slot0)
	return &quot;echo-loop&quot;
end

slot0.OnLoaded = function(slot0)
end

slot0.OnInit = function(slot0)
	slot1 = slot0._tf
	slot2 = slot1:Find(&quot;adapt/order_list&quot;)
	slot0.btnRedeploy = slot2:Find(&quot;redeploy&quot;)
	slot0.btnExpansion = slot2:Find(&quot;expansion&quot;)
	slot0.btnMaintenance = slot2:Find(&quot;maintenance&quot;)
	slot0.btnFOV = slot2:Find(&quot;fov&quot;)
	slot0.btnSubmarine = slot2:Find(&quot;submarine&quot;)
	slot0.btnHelp = slot1:Find(&quot;adapt/help&quot;)

	onButton(slot0, slot0.btnHelp, function ()
		pg.MsgboxMgr.GetInstance():ShowMsgBox({
			type = MSGBOX_TYPE_HELP,
			helps = i18n(&quot;world_instruction_help_1&quot;)
		})
	end, SFX_PANEL)

	slot0.btnBack = slot1:Find(&quot;adapt/back&quot;)

	onButton(slot0, slot0.btnBack, function ()
		uv0:Hide()
	end, SFX_CANCEL)

	slot0.rtRing = slot1:Find(&quot;bg/ring&quot;)
	slot0.wsCompass = WSCompass.New()
	slot0.wsCompass.tf = slot1:Find(&quot;bg/ring/compass&quot;)
	slot0.wsCompass.pool = slot0.contextData.wsPool
	slot3 = slot0.wsCompass

	slot3:Setup(true)

	slot0.rtMsgbox = slot1:Find(&quot;Msgbox&quot;)
	slot4 = slot0.rtMsgbox

	setText(slot4:Find(&quot;window/top/bg/infomation/title&quot;), i18n(&quot;title_info&quot;))
	setActive(slot0.rtMsgbox, false)

	slot5 = slot0.rtMsgbox

	onButton(slot0, slot5:Find(&quot;bg&quot;), function ()
		uv0:HideMsgbox()
	end, SFX_CANCEL)

	slot5 = slot0.rtMsgbox

	onButton(slot0, slot5:Find(&quot;window/top/btnBack&quot;), function ()
		uv0:HideMsgbox()
	end, SFX_CANCEL)

	slot3 = slot0.rtMsgbox
	slot0.rtMsgStamina = slot3:Find(&quot;window/top/bg/stamina&quot;)
	slot4 = slot0.rtMsgStamina

	setText(slot4:Find(&quot;name&quot;), i18n(&quot;world_ap&quot;))

	slot3 = slot0.rtMsgbox
	slot0.rtMsgBase = slot3:Find(&quot;window/msg_panel/base&quot;)
	slot3 = slot0.rtMsgbox
	slot0.rtMsgExtra = slot3:Find(&quot;window/msg_panel/extra&quot;)
	slot3 = slot0.rtMsgbox
	slot0.rtMsgBtns = slot3:Find(&quot;window/button_container&quot;)
	slot4 = slot0.rtMsgBtns

	setText(slot4:Find(&quot;btn_setting/pic&quot;), i18n(&quot;msgbox_text_save&quot;))

	slot4 = slot0.rtMsgBtns

	setText(slot4:Find(&quot;btn_confirm/pic&quot;), i18n(&quot;text_confirm&quot;))

	slot4 = slot0.rtMsgBtns

	setText(slot4:Find(&quot;btn_cancel/pic&quot;), i18n(&quot;text_cancel&quot;))

	slot5 = slot0.rtMsgBtns

	onButton(slot0, slot5:Find(&quot;btn_cancel&quot;), function ()
		uv0:HideMsgbox()
	end, SFX_CANCEL)
end

slot0.OnDestroy = function(slot0)
	slot0:ClearBtnTimers()
	slot0.wsCompass:Dispose()
end

slot0.Show = function(slot0)
	pg.UIMgr.GetInstance():BlurPanel(slot0._tf, false)
	uv0.super.Show(slot0)
end

slot0.Hide = function(slot0)
	if isActive(slot0.rtMsgbox) then
		slot0:HideMsgbox()
	end

	pg.UIMgr.GetInstance():UnblurPanel(slot0._tf, slot0._parentTf)
	slot0:ClearComppass()
	slot0:ClearBtnTimers()
	uv0.super.Hide(slot0)
end

slot0.Setup = function(slot0, slot1, slot2, slot3)
	slot0:Update(slot1, slot2)
	slot0.wsCompass:SetAnchorEulerAngles(slot3)
end

slot0.Update = function(slot0, slot1, slot2)
	if slot0.entrance ~= slot1 or slot0.map ~= slot2 or slot0.gid ~= slot2.gid then
		slot0.entrance = slot1
		slot0.map = slot2
		slot0.gid = slot2.gid
	end

	slot0:UpdateCompassMarks()
	slot0:UpdateOrderBtn()
end

slot0.SetButton = function(slot0, slot1, slot2)
	slot3 = slot1:Find(&quot;type_lock&quot;)

	setActive(slot3, not nowWorld():IsSystemOpen(slot2.system))
	setActive(slot1:Find(&quot;type_unable&quot;), not isActive(slot3) and (slot2.isLock or slot2.timeStamp and pg.TimeMgr.GetInstance():GetServerTime() &lt; slot2.timeStamp))
	setActive(slot1:Find(&quot;type_enable&quot;), not isActive(slot3) and not isActive(slot4))

	if isActive(slot3) then
		onButton(slot0, slot3, function ()
			pg.TipsMgr.GetInstance():ShowTips(i18n(&quot;world_instruction_all_1&quot;))
		end, SFX_CONFIRM)
	end

	if isActive(slot4) then
		setActive(slot4:Find(&quot;cost&quot;), slot2.isLock)
		setActive(slot4:Find(&quot;time&quot;), not slot2.isLock)

		if slot2.isLock then
			setText(slot4:Find(&quot;cost/Text&quot;), slot2.cost)
			onButton(slot0, slot4, slot2.lockFunc, SFX_CONFIRM)
		else
			slot0.timers[slot4] = Timer.New(function ()
				if uv0.timeStamp - pg.TimeMgr.GetInstance():GetServerTime() &lt; 0 then
					uv1:UpdateOrderBtn()
				else
					setText(uv2:Find(&quot;time/Text&quot;), string.format(&quot;%d:%02d:%02d&quot;, math.floor(slot0 / 3600), math.floor(slot0 % 3600 / 60), slot0 % 60))
				end
			end, 1, -1)

			slot0.timers[slot4].func()
			slot0.timers[slot4]:Start()
			onButton(slot0, slot4, slot2.timeFunc, SFX_CONFIRM)
		end
	end

	if isActive(slot5) then
		setText(slot5:Find(&quot;cost/Text&quot;), slot2.cost)
		onButton(slot0, slot5, slot2.enableFunc, SFX_CONFIRM)
	end
end

slot0.UpdateOrderBtn = function(slot0)
	slot0:ClearBtnTimers()

	slot0.timers = {}
	slot1 = nowWorld()
	slot2 = slot0.map:GetConfig(&quot;instruction_available&quot;)
	slot3 = checkExist(slot0.map, {
		&quot;GetPort&quot;
	})
	slot4 = slot1:GetRealm()
	slot5 = slot1:IsSystemOpen(WorldConst.SystemOrderRedeploy) and slot4 == checkExist(slot3, {
		&quot;GetRealm&quot;
	}) and checkExist(slot3, {
		&quot;IsOpen&quot;,
		{
			slot4,
			slot1:GetProgress()
		}
	}) and slot1:BuildFormationIds()
	slot6 = {
		system = WorldConst.SystemOrderRedeploy,
		isLock = not slot5,
		lockFunc = function ()
			pg.TipsMgr.GetInstance():ShowTips(i18n(&quot;world_instruction_redeploy_1&quot;))
		end,
		cost = slot1:CalcOrderCost(WorldConst.OpReqRedeploy),
		enableFunc = function (slot0, slot1)
			uv0:Hide()
			uv0:emit(WorldScene.SceneOp, &quot;OpRedeploy&quot;)
		end
	}

	slot0:SetButton(slot0.btnRedeploy, slot6)
	slot0:SetButton(slot0.btnExpansion, slot6)
	setActive(slot0.btnRedeploy, slot5 ~= WorldConst.FleetExpansion)
	setActive(slot0.btnExpansion, slot5 == WorldConst.FleetExpansion)
	slot0:SetButton(slot0.btnSubmarine, {
		system = WorldConst.SystemOrderSubmarine,
		isLock = slot2[1] == 0 or not slot1:CanCallSubmarineSupport() or slot1:IsSubmarineSupporting() and slot1:GetSubAidFlag(),
		lockFunc = function ()
			if uv0[1] == 0 then
				pg.TipsMgr.GetInstance():ShowTips(i18n(&quot;world_instruction_submarine_1&quot;))
			elseif not uv1:CanCallSubmarineSupport() then
				pg.TipsMgr.GetInstance():ShowTips(i18n(&quot;world_instruction_submarine_4&quot;))
			else
				pg.TipsMgr.GetInstance():ShowTips(i18n(&quot;world_instruction_submarine_3&quot;))
			end
		end,
		cost = slot1:CalcOrderCost(WorldConst.OpReqSub),
		enableFunc = function ()
			uv0:ShowMsgbox(WorldConst.OpReqSub)
		end
	})
	slot0:SetButton(slot0.btnFOV, {
		system = WorldConst.SystemOrderFOV,
		isLock = slot2[2] == 0 or slot0.map.visionFlag,
		lockFunc = function ()
			if uv0[2] == 0 then
				pg.TipsMgr.GetInstance():ShowTips(i18n(&quot;world_instruction_submarine_1&quot;))
			else
				pg.TipsMgr.GetInstance():ShowTips(i18n(&quot;world_instruction_detect_2&quot;))
			end
		end,
		cost = slot1:CalcOrderCost(WorldConst.OpReqVision),
		enableFunc = function ()
			uv0:ShowMsgbox(WorldConst.OpReqVision)
		end
	})

	slot7 = pg.TimeMgr.GetInstance()

	slot0:SetButton(slot0.btnMaintenance, {
		system = WorldConst.SystemOrderMaintenance,
		isLock = slot2[3] == 0,
		lockFunc = function ()
			pg.TipsMgr.GetInstance():ShowTips(i18n(&quot;world_instruction_submarine_1&quot;))
		end,
		timeStamp = slot1:GetReqCDTime(WorldConst.OpReqMaintenance) + pg.gameset.world_instruction_maintenance.description[2],
		timeFunc = function (slot0)
			pg.TipsMgr.GetInstance():ShowTips(i18n(&quot;world_instruction_supply_2&quot;, uv0:DescCDTime(uv1 - pg.TimeMgr.GetInstance():GetServerTime())))
		end,
		cost = slot1:CalcOrderCost(WorldConst.OpReqMaintenance),
		enableFunc = function ()
			uv0:ShowMsgbox(WorldConst.OpReqMaintenance)
		end
	})
end

slot0.ClearBtnTimers = function(slot0)
	if slot0.timers then
		for slot4, slot5 in pairs(slot0.timers) do
			slot5:Stop()
		end
	end

	slot0.timers = nil
end

slot0.UpdateCompassMarks = function(slot0)
	slot0.wsCompass:ClearMarks()
	slot0.wsCompass:Update(slot0.entrance, slot0.map)
end

slot0.ClearComppass = function(slot0)
	slot0.wsCompass.map = nil

	slot0.wsCompass:RemoveCellsListener()
end

slot0.ShowMsgbox = function(slot0, slot1)
	slot2 = nowWorld()

	setText(slot0.rtMsgStamina:Find(&quot;Text&quot;), slot2.staminaMgr:GetTotalStamina())

	slot4 = slot2:CalcOrderCost(slot1)
	slot5 = &quot;&quot;
	slot6 = &quot;&quot;
	slot7 = nil

	if slot1 == WorldConst.OpReqMaintenance then
		slot5 = i18n(&quot;world_instruction_morale_1&quot;, setColorStr(slot4, COLOR_GREEN), setColorStr(slot3, slot4 &lt;= slot3 and COLOR_GREEN or COLOR_RED))
		slot6 = i18n(&quot;world_instruction_morale_4&quot;)

		slot7 = function()
			uv0:emit(WorldScene.SceneOp, &quot;OpReqMaintenance&quot;, uv0.map:GetFleet().id)
		end
	elseif slot1 == WorldConst.OpReqSub then
		slot5 = i18n(slot2:IsSubmarineSupporting() and &quot;world_instruction_submarine_7&quot; or &quot;world_instruction_submarine_2&quot;, setColorStr(slot4, COLOR_GREEN), setColorStr(slot3, slot4 &lt;= slot3 and COLOR_GREEN or COLOR_RED))
		slot6 = i18n(&quot;world_instruction_submarine_8&quot;)

		slot7 = function()
			uv0:emit(WorldScene.SceneOp, &quot;OpReqSub&quot;)
		end
	elseif slot1 == WorldConst.OpReqVision then
		slot5 = i18n(&quot;world_instruction_detect_1&quot;, setColorStr(slot4, COLOR_GREEN), setColorStr(slot3, slot4 &lt;= slot3 and COLOR_GREEN or COLOR_RED))
		slot6 = i18n(&quot;world_instruction_submarine_8&quot;)

		slot7 = function()
			uv0:emit(WorldScene.SceneOp, &quot;OpReqVision&quot;)
		end
	else
		assert(false, &quot;req error&quot;)
	end

	setText(slot0.rtMsgBase:Find(&quot;content&quot;), slot5)
	setText(slot0.rtMsgBase:Find(&quot;other&quot;), slot6)
	onButton(slot0, slot0.rtMsgBtns:Find(&quot;btn_confirm&quot;), function ()
		uv0:Hide()

		if uv1.staminaMgr:GetTotalStamina() &lt; uv2 then
			uv1.staminaMgr:Show()
		else
			uv3()
		end
	end, SFX_CONFIRM)
	setActive(slot0.rtMsgExtra, slot1 == WorldConst.OpReqSub)

	if slot1 == WorldConst.OpReqSub then
		setText(slot0.rtMsgExtra:Find(&quot;content/text_1&quot;), i18n(&quot;world_instruction_submarine_9&quot;))

		slot8 = slot0.rtMsgExtra:Find(&quot;content/toggle_area/toggle&quot;)

		triggerToggle(slot8, PlayerPrefs.GetInt(&quot;world_sub_auto_call&quot;, 0) == 1)
		onToggle(slot0, slot8, function (slot0)
			uv0 = slot0

			uv1:DisplayAutoSetting(true)
		end, SFX_PANEL)

		slot12 = slot0.rtMsgExtra:Find(&quot;content/counter&quot;)

		setText(slot12:Find(&quot;number/Text&quot;), math.clamp(PlayerPrefs.GetInt(&quot;world_sub_call_line&quot;, 0), 0, pg.gameset.world_instruction_submarine.description[1]))
		pressPersistTrigger(slot12:Find(&quot;minus&quot;), 0.5, function (slot0)
			if uv0 == 0 then
				slot0()

				return
			end

			uv0 = math.clamp(uv0 - 1, 0, uv1)

			setText(uv2:Find(&quot;number/Text&quot;), uv0)
			uv3:DisplayAutoSetting(true)
		end, nil, true, true, 0.1, SFX_PANEL)
		pressPersistTrigger(slot12:Find(&quot;plus&quot;), 0.5, function (slot0)
			if uv0 == uv1 then
				slot0()

				return
			end

			uv0 = math.clamp(uv0 + 1, 0, uv1)

			setText(uv2:Find(&quot;number/Text&quot;), uv0)
			uv3:DisplayAutoSetting(true)
		end, nil, true, true, 0.1, SFX_PANEL)
		onButton(slot0, slot0.rtMsgBtns:Find(&quot;btn_setting&quot;), function ()
			isSetting = false

			PlayerPrefs.SetInt(&quot;world_sub_auto_call&quot;, uv0 and 1 or 0)
			PlayerPrefs.SetInt(&quot;world_sub_call_line&quot;, uv1)
			uv2:DisplayAutoSetting(false)
			pg.TipsMgr.GetInstance():ShowTips(i18n(&quot;world_instruction_submarine_11&quot;))
		end, SFX_PANEL)
	end

	slot0:DisplayAutoSetting(false)
	setActive(slot0.rtMsgbox, true)
	pg.UIMgr.GetInstance():BlurPanel(slot0.rtMsgbox)
end

slot0.HideMsgbox = function(slot0)
	setActive(slot0.rtMsgbox, false)
	pg.UIMgr.GetInstance():UnblurPanel(slot0.rtMsgbox, slot0._tf)
end

slot0.DisplayAutoSetting = function(slot0, slot1)
	setActive(slot0.rtMsgBtns:Find(&quot;btn_confirm&quot;), not slot1)
	setActive(slot0.rtMsgBtns:Find(&quot;btn_setting&quot;), slot1)
end

return slot0
</code></pre>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-lua.min.js"></script>
</body>
</html>