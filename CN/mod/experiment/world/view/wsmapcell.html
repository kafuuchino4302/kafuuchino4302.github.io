<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>wsmapcell.lua</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
</head>
<body>
    <h1>wsmapcell.lua</h1>
    <a href="index.html">返回主页</a>
    <pre><code class="language-lua">slot0 = class(&quot;WSMapCell&quot;, import(&quot;...BaseEntity&quot;))
slot0.Fields = {
	cell = &quot;table&quot;,
	map = &quot;table&quot;,
	rtFog = &quot;userdata&quot;,
	transform = &quot;userdata&quot;,
	wsMapResource = &quot;table&quot;,
	rtAttachments = &quot;userdata&quot;,
	maskTimer = &quot;table&quot;,
	maskUid = &quot;number&quot;,
	wsTimer = &quot;table&quot;,
	fogTimer = &quot;table&quot;,
	fogUid = &quot;number&quot;,
	rtMask = &quot;userdata&quot;
}
slot0.Listeners = {
	onUpdate = &quot;Update&quot;,
	onUpdateFogImage = &quot;UpdateFogImage&quot;
}

slot0.GetResName = function()
	return &quot;world_cell&quot;
end

slot0.GetName = function(slot0, slot1)
	return &quot;cell_&quot; .. slot0 .. &quot;_&quot; .. slot1
end

slot0.Setup = function(slot0, slot1, slot2)
	assert(slot0.cell == nil)

	slot0.map = slot1
	slot0.cell = slot2

	slot0.cell:AddListener(WorldMapCell.EventUpdateInFov, slot0.onUpdate)
	slot0.cell:AddListener(WorldMapCell.EventUpdateDiscovered, slot0.onUpdate)
	slot0.cell:AddListener(WorldMapCell.EventUpdateFog, slot0.onUpdate)
	slot0.cell:AddListener(WorldMapCell.EventUpdateFogImage, slot0.onUpdateFogImage)
	slot0:Init()
end

slot0.Dispose = function(slot0)
	if slot0.fogTimer then
		slot0.wsTimer:RemoveInMapTimer(slot0.fogTimer)

		slot0.fogTimer = nil
	end

	if slot0.fogUid then
		slot0.wsTimer:RemoveInMapTween(slot0.fogUid)

		slot0.fogUid = nil
	end

	if slot0.maskTimer then
		slot0.wsTimer:RemoveInMapTimer(slot0.maskTimer)

		slot0.maskTimer = nil
	end

	if slot0.maskUid then
		slot0.wsTimer:RemoveInMapTween(slot0.maskUid)

		slot0.maskUid = nil
	end

	clearImageSprite(slot0.rtFog:Find(&quot;dark_fog&quot;))
	clearImageSprite(slot0.rtFog:Find(&quot;sairen_fog&quot;))
	setCanvasGroupAlpha(slot0.rtFog, 1)
	slot0.cell:RemoveListener(WorldMapCell.EventUpdateInFov, slot0.onUpdate)
	slot0.cell:RemoveListener(WorldMapCell.EventUpdateDiscovered, slot0.onUpdate)
	slot0.cell:RemoveListener(WorldMapCell.EventUpdateFog, slot0.onUpdate)
	slot0.cell:RemoveListener(WorldMapCell.EventUpdateFogImage, slot0.onUpdateFogImage)
	slot0:Clear()
end

slot1 = function(slot0, slot1, slot2, slot3)
	slot0.anchoredPosition = slot1.anchoredPosition + Vector2((slot2.column % 3 - 1) * -slot3.x, (slot2.row % 3 - 1) * slot3.y)
	slot0.localScale = slot1.localScale

	setImageSprite(slot0, getImageSprite(slot1), true)
end

slot0.Init = function(slot0)
	slot1 = slot0.map.theme
	slot2 = slot0.cell
	slot3 = slot0.transform
	slot3.name = uv0.GetName(slot2.row, slot2.column)
	slot3.anchoredPosition = slot1:GetLinePosition(slot2.row, slot2.column)
	slot3.sizeDelta = slot1.cellSize
	slot0.rtAttachments = slot3:Find(&quot;attachments&quot;)
	slot0.rtAttachments.localEulerAngles = Vector3(-slot1.angle, 0, 0)
	slot0.rtMask = slot3:Find(&quot;mask&quot;)
	slot0.rtMask.sizeDelta = slot1.cellSize + Vector2(WorldConst.LineCross * 2, WorldConst.LineCross * 2)
	slot0.rtFog = slot3:Find(&quot;fog&quot;)
	slot4 = slot0.map.theme
	slot5 = slot4.cellSize + slot4.cellSpace

	uv1(slot0.rtFog:Find(&quot;dark_fog&quot;), slot0.wsMapResource.rtDarkFog:Find(WorldConst.Pos2FogRes(slot2.row, slot2.column)), slot2, slot5)
	uv1(slot0.rtFog:Find(&quot;sairen_fog&quot;), slot0.wsMapResource.rtSairenFog:Find(WorldConst.Pos2FogRes(slot2.row, slot2.column)), slot2, slot5)
	slot0:Update()
	slot0:UpdateFogImage()
end

slot0.Update = function(slot0, slot1)
	slot2 = slot0.cell
	slot4 = 0
	slot5 = 0
	slot6 = 0

	if slot0.map.centerCellFOV then
		slot5 = math.sqrt((slot3.row - slot2.row) * (slot3.row - slot2.row) + (slot3.column - slot2.column) * (slot3.column - slot2.column)) * 0.1
		slot6 = 0.2
	end

	if slot1 == nil or slot1 == WorldMapCell.EventUpdateInFov or slot1 == WorldMapCell.EventUpdateFog then
		setActive(slot0.rtAttachments, slot2:GetInFOV() and not slot2:InFog())
	end

	if slot1 == nil or slot1 == WorldMapCell.EventUpdateFog then
		if slot0.fogTimer then
			slot0.wsTimer:RemoveInMapTimer(slot0.fogTimer)

			slot0.fogTimer = nil
		end

		if slot0.fogUid then
			slot0.wsTimer:RemoveInMapTween(slot0.fogUid)

			slot0.fogUid = nil
		end

		if slot2:InFog() then
			if slot1 and slot5 &gt; 0 then
				setCanvasGroupAlpha(slot0.rtFog, 0)

				slot0.fogTimer = slot0.wsTimer:AddInMapTimer(function ()
					uv0.fogUid = LeanTween.alphaCanvas(GetComponent(uv0.rtFog, typeof(CanvasGroup)), 1, uv1).uniqueId

					uv0.wsTimer:AddInMapTween(uv0.fogUid)
				end, slot5)

				slot0.fogTimer:Start()
			else
				setCanvasGroupAlpha(slot0.rtFog, 1)
			end
		elseif slot1 and slot5 &gt; 0 then
			slot0.fogTimer = slot0.wsTimer:AddInMapTimer(function ()
				uv0.fogUid = LeanTween.alphaCanvas(GetComponent(uv0.rtFog, typeof(CanvasGroup)), 0, uv1).uniqueId

				uv0.wsTimer:AddInMapTween(uv0.fogUid)
			end, slot5)

			slot0.fogTimer:Start()
		else
			setCanvasGroupAlpha(slot0.rtFog, 0)
		end
	end

	if slot1 == nil or slot1 == WorldMapCell.EventUpdateInFov or slot1 == WorldMapCell.EventUpdateDiscovered then
		if slot0.maskTimer then
			slot0.wsTimer:RemoveInMapTimer(slot0.maskTimer)

			slot0.maskTimer = nil
		end

		if slot0.maskUid then
			slot0.wsTimer:RemoveInMapTween(slot0.maskUid)

			slot0.maskUid = nil
		end

		if slot2:GetInFOV() then
			if slot1 and slot5 &gt; 0 then
				slot0.maskTimer = slot0.wsTimer:AddInMapTimer(function ()
					uv0.maskUid = LeanTween.alpha(uv0.rtMask, 0, uv1).uniqueId

					uv0.wsTimer:AddInMapTween(uv0.maskUid)
				end, slot5)

				slot0.maskTimer:Start()
			else
				setImageAlpha(slot0.rtMask, 0)
			end
		else
			slot7 = slot2.discovered and 0.3 or 0.8

			if slot1 and slot5 &gt; 0 then
				slot0.maskTimer = slot0.wsTimer:AddInMapTimer(function ()
					uv0.maskUid = LeanTween.alpha(uv0.rtMask, uv1, uv2).uniqueId

					uv0.wsTimer:AddInMapTween(uv0.maskUid)
				end, slot5)

				slot0.maskTimer:Start()
			else
				setImageAlpha(slot0.rtMask, slot7)
			end
		end
	end
end

slot0.UpdateFogImage = function(slot0)
	setImageAlpha(slot0.rtFog:Find(&quot;dark_fog&quot;), slot0.cell:LookSairenFog() and 0 or 1)
	setImageAlpha(slot0.rtFog:Find(&quot;sairen_fog&quot;), slot2 and 1 or 0)
end

slot0.GetWorldPos = function(slot0)
	return slot0.transform.parent:TransformPoint(Vector3.New(slot0.transform.localPosition.x, slot0.transform.localPosition.y, 0))
end

return slot0
</code></pre>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-lua.min.js"></script>
</body>
</html>