<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>islandshipselectpage.lua</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
</head>
<body>
    <h1>islandshipselectpage.lua</h1>
    <a href="index.html">返回主页</a>
    <pre><code class="language-lua">slot0 = class(&quot;IslandShipSelectPage&quot;, import(&quot;...base.IslandBasePage&quot;))

slot0.getUIName = function(slot0)
	return &quot;IslandShipSelectUI&quot;
end

slot0.OnLoaded = function(slot0)
	slot0.backBtn = slot0:findTF(&quot;top/back&quot;)
	slot0.title = slot0:findTF(&quot;top/title/Text&quot;)

	setText(slot0.title, i18n(&quot;island_select_ship&quot;))

	slot0.frameTF = slot0:findTF(&quot;frame&quot;)
	slot0.shipRectCom = slot0:findTF(&quot;ships&quot;, slot0.frameTF):GetComponent(&quot;LScrollRect&quot;)

	setText(slot0.frameTF:Find(&quot;selected/Text&quot;), i18n(&quot;island_select_ship_label_1&quot;))

	slot0.selectedTextCom = slot0.frameTF:Find(&quot;selected/num&quot;):GetComponent(&quot;Text&quot;)
	slot0.benefitsTF = slot0._tf:Find(&quot;benefits&quot;)
	slot0.benefitTipBtn = slot0.benefitsTF:Find(&quot;tip/help&quot;)

	setText(slot0.benefitsTF:Find(&quot;tip/Text&quot;), i18n(&quot;island_select_ship_overview&quot;))

	slot0.mainAttrBar = slot0.benefitsTF:Find(&quot;main/slider/bar&quot;)

	setText(slot0.benefitsTF:Find(&quot;main/Text&quot;), IslandShipAttr.ATTRS_CH[1])

	slot0.subAttrUIList = UIItemList.New(slot0.benefitsTF:Find(&quot;subs&quot;), slot0.benefitsTF:Find(&quot;subs/tpl&quot;))
	slot0.infoEmptyTF = slot0:findTF(&quot;info/empty&quot;)

	setText(slot0.infoEmptyTF:Find(&quot;Image/Text&quot;), i18n(&quot;island_select_ship&quot;))

	slot0.infoEmptyTitleTF = slot0.infoEmptyTF:Find(&quot;name&quot;)
	slot0.infoPanel = slot0:findTF(&quot;info/content&quot;)
	slot0.nameTF = slot0:findTF(&quot;name&quot;, slot0.infoPanel)
	slot0.levelTF = slot0:findTF(&quot;name/level&quot;, slot0.infoPanel)
	slot0.attrUIList = UIItemList.New(slot0:findTF(&quot;attrs&quot;, slot0.infoPanel), slot0:findTF(&quot;attrs/tpl&quot;, slot0.infoPanel))
	slot0.skillTF = slot0:findTF(&quot;skill&quot;, slot0.infoPanel)
	slot0.energyTFInfo = slot0:findTF(&quot;selectShipEnergyInfo&quot;, slot0.infoPanel)
	slot0.energyTF = slot0:findTF(&quot;energy&quot;, slot0.energyTFInfo)
	slot0.statusTF = slot0:findTF(&quot;status&quot;, slot0.infoPanel)
	slot0.sureBtn = slot0:findTF(&quot;sure&quot;)
	slot0.indexBtn = slot0._tf:Find(&quot;frame/filter_panel/IndexIco&quot;)
	slot0.orderBtn = slot0._tf:Find(&quot;frame/filter_panel/index&quot;)
	slot0.orderIco = slot0._tf:Find(&quot;frame/filter_panel/index/content/icon/icon&quot;)
	slot0.orderTxt = slot0._tf:Find(&quot;frame/filter_panel/index/content/Text&quot;):GetComponent(typeof(Text))
	slot0.shipIconTF = slot0.energyTFInfo:Find(&quot;icon_mask/icon&quot;)
	slot0.energyTimeTextTf = slot0.energyTFInfo:Find(&quot;time_Text&quot;)
	slot0.recoveryTimeTips = slot0:findTF(&quot;selectShipEnergyInfo/recoveryTimeTips&quot;, slot0.infoPanel)
	slot0.skill = slot0.infoPanel:Find(&quot;skill&quot;)
	slot0.skillEmp = slot0.infoPanel:Find(&quot;skillEmp&quot;)
	slot0.skillEmpDes = slot0.skillEmp:Find(&quot;Text&quot;)
	slot0.skillInuse = slot0.skill:Find(&quot;skill_tab_bg/iconBright&quot;)
	slot0.skillUnuse = slot0.skill:Find(&quot;skill_tab_bg/iconDark&quot;)
	slot0.skillName = slot0.skill:Find(&quot;name&quot;):GetComponent(typeof(Text))
	slot0.skillDes = slot0.skill:Find(&quot;desc/Text&quot;):GetComponent(typeof(Text))
	slot0.shipContent = slot0.frameTF:Find(&quot;ships&quot;)
	slot0.shipEmpty = slot0.frameTF:Find(&quot;empShip&quot;)
	slot0.animationPlayer = slot0._tf:GetComponent(typeof(Animation))
	slot0.dftAniEvent = slot0._tf:GetComponent(typeof(DftAniEvent))
end

slot0.OnInit = function(slot0)
	onButton(slot0, slot0.backBtn, function ()
		uv0.dftAniEvent:SetEndEvent(nil)
		uv0.dftAniEvent:SetEndEvent(function ()
			uv0:Hide()

			if uv0.cancelFunc then
				uv0.cancelFunc()
			end
		end)
		uv0.animationPlayer:Play(&quot;anim_IslandShipSelectUI_Out&quot;)
	end, SFX_PANEL)
	onButton(slot0, slot0.sureBtn, function ()
		uv0:Hide()

		if uv0.confirmFunc then
			uv0.confirmFunc(uv0.selectedIds)
		end
	end, SFX_PANEL)
	onToggle(slot0, slot0.indexBtn, function (slot0)
		if slot0 then
			uv0:emit(IslandMediator.OPEN_SHIP_INDEX, {
				OnFilter = function (slot0)
					uv0:OnFilter(slot0)
				end,
				defaultIndex = uv0.sortData
			})
		end
	end, SFX_PANEL)
	onButton(slot0, slot0.orderBtn, function ()
		uv0.selectAsc = not uv0.selectAsc

		uv0:UpdateSortBtn()
		uv0:FlushShips()
	end, SFX_PANEL)
	onButton(slot0, slot0.benefitTipBtn, function ()
		uv0:ShowMsgBox({
			hideNo = true,
			type = IslandMsgBox.TYPE_COMMON,
			content = i18n(&quot;island_manage_help_tip&quot;)
		})
	end, SFX_PANEL)

	slot1 = slot0.subAttrUIList

	slot1:make(function (slot0, slot1, slot2)
		if slot0 == UIItemList.EventInit then
			slot3 = IslandShipAttr.ATTRS[slot1 + 1]
			slot2.name = slot3

			setText(slot2:Find(&quot;Text&quot;), IslandShipAttr.ToChinese(slot3))
		elseif slot0 == UIItemList.EventUpdate then
			setFillAmount(slot2:Find(&quot;slider/bar&quot;), uv0:GetShipsAttrProgress(IslandShipAttr.ATTRS[slot1 + 1]))
		end
	end)

	slot0.shipRectCom.onInitItem = function(slot0)
		uv0:OnInitShip(slot0)
	end

	slot0.shipRectCom.onUpdateItem = function(slot0, slot1)
		uv0:OnUpdateShip(slot0, slot1)
	end

	slot0.cards = {}
	slot0.selectAsc = true
	slot0.sortData = {
		sortIndex = IslandShipIndexLayer.SortLevel,
		campIndex = ShipIndexConst.CampAll,
		rarityIndex = ShipIndexConst.RarityAll,
		extraIndex = IslandShipIndexLayer.ExtraALL
	}

	slot0:UpdateSortBtn()

	slot0.timeMgr = pg.TimeMgr.GetInstance()
end

slot0.OnFilter = function(slot0, slot1)
	slot0.sortData = slot1

	slot0:UpdateSortBtn()
	slot0:FlushShips()
end

slot0.UpdateSortBtn = function(slot0)
	slot0.orderIco.localScale = slot0.selectAsc and Vector3(1, -1, 1) or Vector3(1, 1, 1)
	slot1, slot2 = IslandShipIndexLayer.getSortFuncAndName(slot0.sortData.sortIndex, slot0.selectAsc)
	slot0.orderTxt.text = i18n(slot2)
end

slot0.UpdateAttrs = function(slot0, slot1)
	slot0.attrUIList:make(function (slot0, slot1, slot2)
		if slot0 == UIItemList.EventUpdate then
			uv0:UpdateAttr(slot2, uv1, slot1 + 1, uv2)
		end
	end)
	slot0.attrUIList:align(#IslandShipAttr.ATTRS)
end

slot0.UpdateAttr = function(slot0, slot1, slot2, slot3, slot4)
	slot5 = slot2[slot3]

	setText(slot1:Find(&quot;name&quot;), IslandShipAttr.ToChinese(slot5))
	setText(slot1:Find(&quot;value&quot;), slot4:GetAttr(slot5))

	slot8 = IslandShipAttr.Grade2Img(slot4:GetAttrGrade(slot5))
	slot1:Find(&quot;grade&quot;):GetComponent(typeof(Image)).sprite = GetSpriteFromAtlas(&quot;ui/IslandShipUI_atlas&quot;, slot8[1])
	slot1:Find(&quot;grade_bg&quot;):GetComponent(typeof(Image)).sprite = GetSpriteFromAtlas(&quot;ui/IslandShipUI_atlas&quot;, slot8[2])
end

slot0.OnShow = function(slot0, slot1, slot2, slot3, slot4, slot5, slot6)
	pg.UIMgr.GetInstance():BlurPanel(slot0._tf)

	slot0.selectNum = slot1
	slot0.selectedIds = slot2
	slot0.attrType = slot3
	slot0.confirmFunc = slot4
	slot0.cancelFunc = slot5
	slot0.characterAgency = getProxy(IslandProxy):GetIsland():GetCharacterAgency()
	slot0.place_Id = slot6 and slot6.place_Id
	slot0.showBenefits = slot6 and slot6.showBenefits

	setText(slot0.infoEmptyTitleTF, slot6 and slot6.emptyInfoTitle and slot6.emptyInfoTitle or &quot;&quot;)
	slot0:FlushShips(#slot0.selectedIds == 0 and slot0.selectNum == 1)
end

slot0.OnInitShip = function(slot0, slot1)
	slot0.cards[slot1] = IslandSelectShipCard.New(slot1)
end

slot0.OnUpdateShip = function(slot0, slot1, slot2)
	if not slot0.cards[slot2] then
		slot0:OnInitItem(slot2)

		slot3 = slot0.cards[slot2]
	end

	slot4 = slot0.showShips[slot1 + 1]
	slot5 = slot0.characterAgency:GetShipById(slot4)

	onButton(slot0, slot3.go, function ()
		if uv0:GetState() ~= IslandShip.STATE_NORMAL then
			return
		end

		if uv1.showId == uv2.id then
			uv1.showId = nil
		else
			uv1.showId = uv2.id
		end

		if table.contains(uv1.selectedIds, uv2.id) then
			table.removebyvalue(uv1.selectedIds, uv2.id)
		elseif uv1.selectNum == 1 then
			uv1.selectedIds = {
				uv2.id
			}
		else
			if uv1.selectNum &lt;= #uv1.selectedIds then
				return
			end

			table.insert(uv1.selectedIds, uv2.id)
		end

		for slot3, slot4 in pairs(uv1.cards) do
			slot4:UpdateSelected(uv1.selectedIds)
		end

		uv1:FlushInfo()
	end, SFX_PANEL)
	slot3:Update(slot4, slot0.attrType, slot0.place_Id, slot0.selectedIds)
end

slot0.FlushShips = function(slot0, slot1)
	slot0.showShips = slot0:GetShips()

	if #slot0.showShips ~= 0 and slot1 and slot0:GetFristSelectableShipId() then
		slot0.showId = slot2

		table.insert(slot0.selectedIds, slot2)
	end

	slot0.showId = slot0.selectedIds[1]

	setActive(slot0.shipContent, #slot0.showShips ~= 0)
	setActive(slot0.shipEmpty, #slot0.showShips == 0)
	slot0.shipRectCom:SetTotalCount(#slot0.showShips)
	slot0:FlushInfo()
end

slot0.GetFristSelectableShipId = function(slot0)
	for slot4, slot5 in ipairs(slot0.showShips) do
		if slot0.characterAgency:GetShipById(slot5):GetState() == IslandShip.STATE_NORMAL then
			return slot5
		end
	end

	return nil
end

slot0.UpdateTimer = function(slot0, slot1)
	setText(slot0.energyTimeTextTf, slot0.timeMgr:DescCDTime(slot1 - slot0.timeMgr:GetServerTime()))
end

slot0.StopTimer = function(slot0)
	if slot0.energyTimer ~= nil then
		slot0.energyTimer:Stop()

		slot0.energyTimer = nil
	end
end

slot0.FlushInfo = function(slot0)
	slot0.selectedTextCom.text = #slot0.selectedIds .. &quot;/&quot; .. slot0.selectNum

	slot0:FlushBenefits()
	setActive(slot0.sureBtn, slot0.showId)
	setActive(slot0.infoPanel, slot0.showId)
	setActive(slot0.infoEmptyTF, not slot0.showId)

	if not slot0.showId then
		return
	end

	slot1 = getProxy(IslandProxy):GetIsland():GetCharacterAgency():GetShipById(slot0.showId)

	setText(slot0.nameTF, slot1:GetName())
	setText(slot0.levelTF, string.format(&quot;-Lv.%d&quot;, slot1:GetLevel()))
	slot0:UpdateAttrs(slot1)
	GetImageSpriteFromAtlasAsync(&quot;ShipYardIcon/&quot; .. IslandShip.StaticGetPrefab(slot1.id), &quot;&quot;, slot0.shipIconTF)

	slot3 = slot1:GetCurrentEnergy()
	slot4 = slot1:GetMaxEnergy()

	setText(slot0:findTF(&quot;text&quot;, slot0.energyTF), slot3 .. &quot;/&quot; .. slot4)
	setSlider(slot0:findTF(&quot;energy_bar&quot;, slot0.energyTF), 0, 1, slot3 / slot4)

	if slot3 ~= slot4 then
		setActive(slot0.recoveryTimeTips, true)
		setActive(slot0.energyTimeTextTf, true)
		slot0:StopTimer()
		slot0:UpdateTimer(slot1:GetEnergyMaxTime())

		slot0.energyTimer = Timer.New(function ()
			uv0:UpdateTimer(uv1)
		end, 1, -1)

		slot0.energyTimer:Start()
	else
		slot0:StopTimer()
		setActive(slot0.recoveryTimeTips, false)
		setActive(slot0.energyTimeTextTf, false)
	end

	slot5 = slot1:GetSkill()
	slot6 = slot5:IsUnlock()

	setActive(slot0.skill, slot6)
	setActive(slot0.skillEmp, not slot6)
	setText(slot0.skillEmpDes, i18n(&quot;island_need_star&quot;, slot1:GetSkillUnlockLevel()))

	slot7 = slot5:IsEffectiveInPlace(slot0.place_Id)

	setActive(slot0.skillInuse, slot7)
	setActive(slot0.skillUnuse, not slot7)

	slot0.skillName.text = string.format(&quot;%s - %s&quot;, slot5:GetName(), &quot;[Lv.&quot; .. slot5:GetLevel() .. &quot;]&quot;)
	slot0.skillDes.text = slot5:GetEffectDesc()
end

slot0.FlushBenefits = function(slot0)
	setActive(slot0.benefitsTF, slot0.showBenefits)

	if slot0.showBenefits then
		setFillAmount(slot0.mainAttrBar, slot0:GetShipsAttrProgress(IslandShipAttr.ATTRS[1]))
		slot0.subAttrUIList:align(#IslandShipAttr.ATTRS)
	end
end

slot0.GetShipsAttrProgress = function(slot0, slot1)
	slot3 = pg.island_chara_att.all[#pg.island_chara_att.all] * slot0.selectNum
	slot4 = 0

	for slot8, slot9 in ipairs(slot0.selectedIds) do
		slot4 = slot4 + slot2 - slot0.characterAgency:GetShipById(slot9):GetAttrGrade(slot1) + 1
	end

	return slot4 / slot3
end

slot0.ToVShip = function(slot0, slot1)
	if not slot0.vship then
		slot0.vship = {
			getNation = function ()
				return uv0.vship.config.nationality
			end,
			getShipType = function ()
				return uv0.vship.config.type
			end,
			getTeamType = function ()
				return TeamType.GetTeamFromShipType(uv0.vship.config.type)
			end,
			getRarity = function ()
				return uv0.vship.config.rarity
			end
		}
	end

	slot0.vship.config = slot1

	return slot0.vship
end

slot1 = function(slot0, slot1)
	if not slot1 or slot1 == &quot;&quot; then
		return true
	end

	return string.find(string.lower(IslandShip.StaticGetName(slot0)), string.lower(string.gsub(slot1, &quot;%.&quot;, &quot;%%.&quot;)))
end

slot2 = function(slot0, slot1, slot2)
	slot6 = slot0.characterAgency:GetShipById(slot1)

	if ShipIndexConst.filterByCamp(slot0:ToVShip(ShipGroup.getDefaultShipConfig(slot1)), slot2.campIndex) and ShipIndexConst.filterByRarity(slot5, slot2.rarityIndex) and IslandShipIndexLayer.filterByExtra(slot6, slot2.extraIndex) then
		return true
	end

	return false
end

slot0.GetShips = function(slot0)
	slot1 = {}

	for slot6, slot7 in ipairs(slot0.characterAgency:GetShipsContainNpc()) do
		if uv0(slot7.id, slot0.searchKey) and uv1(slot0, slot7.id, slot0.sortData) then
			table.insert(slot1, slot7.id)
		end
	end

	table.sort(slot1, CompareFuncs(IslandShipIndexLayer.getSortFuncAndName(slot0.sortData.sortIndex, slot0.selectAsc)))

	return slot1
end

slot0.OnDestroy = function(slot0)
	slot0:StopTimer()
	slot0.dftAniEvent:SetEndEvent(nil)
end

slot0.OnHide = function(slot0)
	pg.UIMgr.GetInstance():UnblurPanel(slot0._tf)
end

return slot0
</code></pre>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-lua.min.js"></script>
</body>
</html>