<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>battleenvironmentbehaviour.lua</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
</head>
<body>
    <h1>battleenvironmentbehaviour.lua</h1>
    <a href="index.html">返回主页</a>
    <pre><code class="language-lua">ys = ys or {}
slot0 = ys
slot1 = slot0.Battle.BattleConst
slot2 = slot0.Battle.BattleConfig
slot3 = class(&quot;BattleEnvironmentBehaviour&quot;)
slot0.Battle.BattleEnvironmentBehaviour = slot3
slot3.__name = &quot;BattleEnvironmentBehaviour&quot;
slot3.STATE_DELAY = &quot;STATE_DELAY&quot;
slot3.STATE_READY = &quot;STATE_READY&quot;
slot3.STATE_OVERHEAT = &quot;STATE_OVERHEAT&quot;
slot3.STATE_EXPIRE = &quot;STATE_EXPIRE&quot;

slot3.Ctor = function(slot0, slot1, slot2)
	slot0._cldUnitList = {}
end

slot3.SetUnitRef = function(slot0, slot1)
	assert(slot1, &quot;Shounld Bind A Unit&quot;)

	slot0._unit = slot1
end

slot3.SetTemplate = function(slot0, slot1)
	slot0._tmpData = slot1

	if slot0._tmpData.delay then
		slot0._delayStartTime = pg.TimeMgr.GetInstance():GetCombatTime()
		slot0._state = uv0.STATE_DELAY
	else
		slot0._state = uv0.STATE_READY
	end

	if slot0._tmpData.life_time then
		slot0._liftStartTime = pg.TimeMgr.GetInstance():GetCombatTime()
	end

	slot0._diveFilter = slot0._tmpData.diveFilter or {}
end

slot3.UpdateCollideUnitList = function(slot0, slot1)
	if #slot0._diveFilter ~= 0 then
		slot2 = #slot1

		while slot2 &gt; 0 do
			slot3 = slot1[slot2]:GetCurrentOxyState()

			for slot7, slot8 in ipairs(slot0._diveFilter) do
				if slot3 == slot8 then
					table.remove(slot1, slot2)

					break
				end
			end

			slot2 = slot2 - 1
		end
	end

	slot0._cldUnitList = slot1
end

slot3.OnUpdate = function(slot0)
	slot0:updateDelay()
	slot0:updateReload()
	slot0:updateLifeTime()

	if slot0._state == uv0.STATE_READY then
		slot0:doBehaviour()
	end
end

slot3.Dispose = function(slot0)
	slot0._cldUnitList = nil
	slot0._tmpData = nil
	slot0._CDstartTime = nil
end

slot3.OnCollide = function(slot0, slot1)
end

slot3.GetCurrentState = function(slot0)
	return slot0._state
end

slot3.updateDelay = function(slot0)
	if slot0._delayStartTime and slot0._tmpData.delay + slot0._delayStartTime &lt;= pg.TimeMgr.GetInstance():GetCombatTime() then
		slot0._delayStartTime = nil

		slot0:handleCoolDown()
	end
end

slot3.updateReload = function(slot0)
	if slot0._CDstartTime then
		if slot0:getReloadFinishTimeStamp() &lt;= pg.TimeMgr.GetInstance():GetCombatTime() then
			slot0:handleCoolDown()
		else
			return
		end
	end
end

slot3.updateLifeTime = function(slot0)
	if slot0._liftStartTime and slot0._liftStartTime + slot0._tmpData.life_time &lt;= pg.TimeMgr.GetInstance():GetCombatTime() then
		slot0._state = uv0.STATE_EXPIRE

		slot0:doExpire()
	end
end

slot3.getReloadFinishTimeStamp = function(slot0)
	return slot0._tmpData.reload_time + slot0._CDstartTime
end

slot3.handleCoolDown = function(slot0)
	slot0._state = uv0.STATE_READY
	slot0._CDstartTime = nil
end

slot3.doBehaviour = function(slot0)
	if slot0._tmpData.reload_time then
		slot0._CDstartTime = pg.TimeMgr.GetInstance():GetCombatTime()
		slot0._state = uv0.STATE_OVERHEAT
	end
end

slot3.doExpire = function(slot0)
	slot0._state = uv0.STATE_EXPIRE
end

slot3.BehaviourClassEnum = {
	[slot1.EnviroumentBehaviour.PLAY_FX] = &quot;BattleEnvironmentBehaviourPlayFX&quot;,
	[slot1.EnviroumentBehaviour.DAMAGE] = &quot;BattleEnvironmentBehaviourDamage&quot;,
	[slot1.EnviroumentBehaviour.BUFF] = &quot;BattleEnvironmentBehaviourBuff&quot;,
	[slot1.EnviroumentBehaviour.MOVEMENT] = &quot;BattleEnvironmentBehaviourMovement&quot;,
	[slot1.EnviroumentBehaviour.FORCE] = &quot;BattleEnvironmentBehaviourForce&quot;,
	[slot1.EnviroumentBehaviour.SPAWN] = &quot;BattleEnvironmentBehaviourSpawn&quot;,
	[slot1.EnviroumentBehaviour.PLAY_SFX] = &quot;BattleEnvironmentBehaviourPlaySFX&quot;,
	[slot1.EnviroumentBehaviour.SHAKE_SCREEN] = &quot;BattleEnvironmentBehaviourShakeScreen&quot;
}

slot3.CreateBehaviour = function(slot0)
	return uv0.Battle[uv1.BehaviourClassEnum[slot0.type]].New()
end
</code></pre>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-lua.min.js"></script>
</body>
</html>