<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>battleunitaimbiascomponent.lua</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
</head>
<body>
    <h1>battleunitaimbiascomponent.lua</h1>
    <a href="index.html">返回主页</a>
    <pre><code class="language-lua">ys = ys or {}
slot0 = ys
slot1 = slot0.Battle.BattleUnitEvent
slot2 = slot0.Battle.BattleConst
slot3 = slot0.Battle.BattleConfig
slot4 = slot0.Battle.BattleAttr
slot5 = slot0.Battle.BattleFormulas
slot0.Battle.BattleUnitAimBiasComponent = class(&quot;BattleUnitAimBiasComponent&quot;)
slot0.Battle.BattleUnitAimBiasComponent.__name = &quot;BattleUnitAimBiasComponent&quot;
slot6 = slot0.Battle.BattleUnitAimBiasComponent
slot6.NORMAL = 1
slot6.DIVING = 2
slot6.STATE_SUMMON_SICKNESS = &quot;STATE_SUMMON_SICKNESS&quot;
slot6.STATE_ACTIVITING = &quot;STATE_ACTIVITING&quot;
slot6.STATE_SKILL_EXPOSE = &quot;STATE_SKILL_EXPOSE&quot;
slot6.STATE_TOTAL_EXPOSE = &quot;STATE_TOTAL_EXPOSE&quot;
slot6.STATE_EXPIRE = &quot;STATE_EXPIRE&quot;

slot6.Ctor = function(slot0)
end

slot6.Dispose = function(slot0)
	slot0:clear()
end

slot6.init = function(slot0)
	slot0._crewList = {}
	slot0._maxBiasRange = 0
	slot0._minBiasRange = 0
	slot0._currentBiasRange = 0
	slot0._biasAttr = 0
	slot0._decaySpeed = 0
	slot0._ratioSpeed = 0
	slot0._combinedSpeed = 0
	slot0._pos = Vector3.zero
end

slot6.ConfigRangeFormula = function(slot0, slot1, slot2)
	slot0._rangeFormulaFunc = slot1
	slot0._decayFormulaFunc = slot2

	slot0:init()
end

slot6.ConfigMinRange = function(slot0, slot1)
	slot0._minBiasRange = slot1
end

slot6.Active = function(slot0, slot1)
	slot0._state = slot1
	slot0._currentBiasRange = slot0._maxBiasRange
	slot0._activeTimeStamp = pg.TimeMgr.GetInstance():GetCombatTime()
	slot0._lastUpdateTimeStamp = slot0._activeTimeStamp
end

slot6.GetHost = function(slot0)
	return slot0._host
end

slot6.Update = function(slot0, slot1)
	slot0._pos = slot0._host:GetPosition()
	slot3 = uv0.GetCurrent(slot0._host, &quot;aimBiasDecaySpeedRatio&quot;) * slot0._maxBiasRange
	slot0._ratioSpeed = slot3
	slot0._combinedSpeed = slot0._decaySpeed + uv0.GetCurrent(slot0._host, &quot;aimBiasDecaySpeed&quot;) + slot3

	if slot0._state == uv1.STATE_SUMMON_SICKNESS then
		if uv2.AIM_BIAS_ENEMY_INIT_TIME &lt; slot1 - slot0._activeTimeStamp then
			slot0:ChangeState(uv1.STATE_ACTIVITING)
		end
	elseif slot0._state == uv1.STATE_SKILL_EXPOSE then
		slot0._biasAttr = 0
	else
		slot0._currentBiasRange = Mathf.Clamp(slot0._currentBiasRange - slot0._combinedSpeed * (slot1 - slot0._lastUpdateTimeStamp), slot0._minBiasRange, slot0._maxBiasRange)
		slot0._biasAttr = slot0._currentBiasRange

		if slot0._currentBiasRange &lt;= slot0._minBiasRange then
			slot0:ChangeState(uv1.STATE_TOTAL_EXPOSE)
		else
			slot0:ChangeState(uv1.STATE_ACTIVITING)
		end
	end

	slot0._lastUpdateTimeStamp = slot1

	slot0:biasEffect()
end

slot6.GetCurrentRate = function(slot0)
	return (slot0._currentBiasRange - slot0._minBiasRange) / slot0._progressLength
end

slot6.GetDecayRatioSpeed = function(slot0)
	return slot0._ratioSpeed
end

slot6.GetCurrentState = function(slot0)
	return slot0._state
end

slot6.IsFaint = function(slot0)
	return slot0._state == uv0.STATE_TOTAL_EXPOSE or slot0._state == uv0.STATE_SKILL_EXPOSE
end

slot6.GetPosition = function(slot0)
	return slot0._pos
end

slot6.GetCrewCount = function(slot0)
	return #slot0._crewList
end

slot6.GetRange = function(slot0)
	slot1 = nil

	return (slot0._state ~= uv0.STATE_SKILL_EXPOSE or slot0._minBiasRange) and slot0._currentBiasRange
end

slot6.GetDecayFactorType = function(slot0)
	if slot0._host:GetCurrentOxyState() == uv0.OXY_STATE.DIVE then
		return uv1.DIVING
	else
		return uv1.NORMAL
	end
end

slot6.IsHostile = function(slot0)
	return slot0._hostile
end

slot6.SetDecayFactor = function(slot0, slot1, slot2)
	if slot1 == 0 then
		slot0._decaySpeed = 0

		return
	end

	if slot0._cacheFactor == slot1 and slot0._cacheType == slot0:GetDecayFactorType() then
		return
	end

	if slot0:GetDecayFactorType() == uv0.DIVING then
		slot0._decaySpeed = uv1.CalculateBiasDecayDiving(slot1)
	else
		slot0._decaySpeed = slot0._decayFormulaFunc(slot1)
	end

	slot0._decaySpeed = slot0._decaySpeed + slot2
end

slot6.AppendCrew = function(slot0, slot1)
	if table.contains(slot0._crewList, slot1) then
		return
	end

	table.insert(slot0._crewList, slot1)
	slot0:switchHost()
	slot0:flush()
	slot1:AttachAimBias(slot0)

	slot0._currentBiasRange = slot0._maxBiasRange
end

slot6.RemoveCrew = function(slot0, slot1)
	slot2 = nil

	for slot6, slot7 in ipairs(slot0._crewList) do
		if slot7 == slot1 then
			table.remove(slot0._crewList, slot6)

			break
		end
	end

	if #slot0._crewList == 0 then
		slot0:clear()
	else
		slot0:switchHost()
		slot0:flush()
	end
end

slot6.UpdateSkillLock = function(slot0)
	if uv0.IsLockAimBias(slot0._host) then
		slot0:ChangeState(uv1.STATE_SKILL_EXPOSE)
	elseif slot0._currentBiasRange &lt;= slot0._minBiasRange then
		slot0:ChangeState(uv1.STATE_TOTAL_EXPOSE)
	else
		slot0:ChangeState(uv1.STATE_ACTIVITING)
	end

	slot0._host:DispatchEvent(uv2.Event.New(uv3.UPDATE_AIMBIAS_LOCK))
end

slot6.SmokeExitPause = function(slot0)
	slot1 = pg.TimeMgr.GetInstance():GetCombatTime()
	slot0._pauseStartTimeStamp = slot1

	uv0.SetCurrent(slot0._host, &quot;lockAimBias&quot;, 1)
	slot0:UpdateSkillLock()
	slot0:Update(slot1)

	slot0._smokeRestoreTimer = pg.TimeMgr.GetInstance():AddBattleTimer(&quot;smokeRestoreTimer&quot;, 0, uv1.AIM_BIAS_SMOKE_RESTORE_DURATION, function ()
		uv0:removeRestoreTimer()
		uv0._host:DetachAimBias()
	end, true)
end

slot6.SomkeExitResume = function(slot0)
	slot0:removeRestoreTimer()

	slot0._lastUpdateTimeStamp = slot0._lastUpdateTimeStamp + pg.TimeMgr.GetInstance():GetCombatTime() - slot0._pauseStartTimeStamp

	slot0:UpdateSkillLock()
end

slot6.SmokeRecover = function(slot0)
	slot0._currentBiasRange = math.min(slot0._maxBiasRange, slot0._currentBiasRange + slot0._maxBiasRange * uv0.AIM_BIAS_SMOKE_RECOVERY_RATE)
end

slot6.ChangeState = function(slot0, slot1)
	slot0._state = slot1
end

slot6.SetHostile = function(slot0)
	slot0._hostile = true
end

slot6.switchHost = function(slot0)
	slot0._host = slot0._crewList[1]

	slot0._host:HostAimBias()
end

slot6.flush = function(slot0)
	slot0._maxBiasRange = math.max(slot0._rangeFormulaFunc(slot0._crewList), slot0._minBiasRange)
	slot1 = slot0._host:GetTemplate().cld_box
	slot0._progressLength = slot0._maxBiasRange - slot0._minBiasRange
end

slot6.biasEffect = function(slot0)
	for slot4, slot5 in ipairs(slot0._crewList) do
		uv0.SetCurrent(slot5, &quot;aimBias&quot;, slot0._biasAttr)
	end
end

slot6.removeRestoreTimer = function(slot0)
	uv0.SetCurrent(slot0._host, &quot;lockAimBias&quot;, 0)
	pg.TimeMgr.GetInstance():RemoveBattleTimer(slot0._smokeRestoreTimer)

	slot0._smokeRestoreTimer = nil
end

slot6.clear = function(slot0)
	if slot0._smokeRestoreTimer then
		slot0:removeRestoreTimer()
	end

	slot0._crewList = {}
	slot0._pos = nil
	slot0._state = uv0.STATE_EXPIRE
end
</code></pre>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-lua.min.js"></script>
</body>
</html>