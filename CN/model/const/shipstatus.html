<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>shipstatus.lua</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
</head>
<body>
    <h1>shipstatus.lua</h1>
    <a href="index.html">返回主页</a>
    <pre><code class="language-lua">slot0 = class(&quot;ShipStatus&quot;)
slot0.flagList = {
	&quot;inChapter&quot;,
	&quot;inFleet&quot;,
	&quot;inElite&quot;,
	&quot;inActivity&quot;,
	&quot;inPvP&quot;,
	&quot;inExercise&quot;,
	&quot;inEvent&quot;,
	&quot;inClass&quot;,
	&quot;inTactics&quot;,
	&quot;inBackyard&quot;,
	&quot;inAdmiral&quot;,
	&quot;inWorld&quot;,
	&quot;isActivityNpc&quot;,
	&quot;inGuildEvent&quot;,
	&quot;inGuildBossEvent&quot;,
	&quot;inChallenge&quot;,
	&quot;inSupport&quot;
}

slot0.checkShipFlag = function(slot0, slot1, slot2)
	if type(defaultValue(slot1[slot2], uv0.TAG_HIDE_BASE[slot2])) == &quot;boolean&quot; then
		return not slot3 and slot0:getFlag(slot2)
	elseif type(slot3) == &quot;number&quot; then
		return slot0:getFlag(slot2, slot3)
	else
		assert(false, &quot;type error&quot;)
	end
end

slot0.ShipStatusToTag = function(slot0, slot1)
	if uv0.checkShipFlag(slot0, slot1, &quot;inChapter&quot;) then
		return {
			&quot;shipstatus&quot;,
			&quot;red&quot;,
			i18n(&quot;word_status_inFight&quot;)
		}
	elseif uv0.checkShipFlag(slot0, slot1, &quot;inFleet&quot;) then
		slot3 = getProxy(FleetProxy):GetRegularFleetByShip(slot0)

		assert(slot3)

		slot4 = slot3.id

		if slot3:isRegularFleet() then
			return {
				&quot;ui/dockyardui_atlas&quot;,
				&quot;biandui0&quot; .. math.fmod(slot4, 10),
				&quot;&quot;
			}
		else
			return {
				&quot;shipstatus&quot;,
				&quot;red&quot;,
				Fleet.DEFAULT_NAME_FOR_DOCKYARD[slot4]
			}
		end
	elseif uv0.checkShipFlag(slot0, slot1, &quot;inElite&quot;) then
		return {
			&quot;shipstatus&quot;,
			&quot;red&quot;,
			i18n(&quot;word_status_inHardFormation&quot;)
		}
	elseif uv0.checkShipFlag(slot0, slot1, &quot;inSupport&quot;) then
		return {
			&quot;shipstatus&quot;,
			&quot;red&quot;,
			i18n(&quot;word_status_inSupportFleet&quot;)
		}
	elseif uv0.checkShipFlag(slot0, slot1, &quot;inActivity&quot;) then
		return {
			&quot;shipstatus&quot;,
			&quot;red&quot;,
			i18n(&quot;word_status_activity&quot;)
		}
	elseif uv0.checkShipFlag(slot0, slot1, &quot;inChallenge&quot;) then
		return {
			&quot;shipstatus&quot;,
			&quot;red&quot;,
			i18n(&quot;word_status_challenge&quot;)
		}
	elseif uv0.checkShipFlag(slot0, slot1, &quot;inPvP&quot;) then
		return {
			&quot;shipstatus&quot;,
			&quot;red&quot;,
			i18n(&quot;word_status_inPVP&quot;)
		}
	elseif uv0.checkShipFlag(slot0, slot1, &quot;inEvent&quot;) then
		return {
			&quot;shipstatus&quot;,
			&quot;green&quot;,
			i18n(&quot;word_status_inEvent&quot;)
		}
	elseif uv0.checkShipFlag(slot0, slot1, &quot;inBackyard&quot;) then
		if slot0.state == Ship.STATE_REST then
			return {
				&quot;shipstatus&quot;,
				&quot;purple&quot;,
				i18n(&quot;word_status_rest&quot;)
			}
		elseif slot0.state == Ship.STATE_TRAIN then
			return {
				&quot;shipstatus&quot;,
				&quot;purple&quot;,
				i18n(&quot;word_status_train&quot;)
			}
		end
	elseif uv0.checkShipFlag(slot0, slot1, &quot;inClass&quot;) then
		return {
			&quot;shipstatus&quot;,
			&quot;blue&quot;,
			i18n(&quot;word_status_inClass&quot;)
		}
	elseif uv0.checkShipFlag(slot0, slot1, &quot;inTactics&quot;) then
		return {
			&quot;shipstatus&quot;,
			&quot;blue&quot;,
			i18n(&quot;word_status_inTactics&quot;)
		}
	elseif uv0.checkShipFlag(slot0, slot1, &quot;inAdmiral&quot;) then
		return {
			&quot;shipstatus&quot;,
			&quot;light_green&quot;,
			i18n(&quot;common_flag_ship&quot;)
		}
	elseif uv0.checkShipFlag(slot0, slot1, &quot;inWorld&quot;) then
		return {
			&quot;shipstatus&quot;,
			&quot;red&quot;,
			i18n(&quot;word_status_world&quot;)
		}
	elseif getProxy(SettingsProxy):IsRandomFlagShip(slot0:GetShipPhantomMark()) then
		return {
			&quot;shipstatus&quot;,
			&quot;light_yellow&quot;,
			i18n(&quot;random_flag_ship&quot;)
		}
	end
end

slot0.FILTER_SHIPS_FLAGS_1 = {
	inExercise = false,
	inChapter = true,
	inSupport = true,
	inFleet = false,
	inPvP = false,
	inActivity = true,
	inTactics = false,
	inElite = false,
	inGuildEvent = true,
	inEvent = true,
	inBackyard = false,
	inClass = true,
	isActivityNpc = true,
	inChallenge = true,
	inWorld = true,
	inAdmiral = true
}
slot0.FILTER_SHIPS_FLAGS_2 = {
	inElite = true,
	inChallenge = true,
	inPvP = true,
	inSupport = true,
	inClass = true,
	inActivity = true,
	inGuildEvent = true,
	isActivityNpc = true,
	inWorld = true,
	inAdmiral = true,
	inExercise = true,
	inChapter = true,
	inFleet = true,
	inGuildBossEvent = true,
	inTactics = true,
	inBackyard = true,
	inEvent = true
}
slot0.FILTER_SHIPS_FLAGS_3 = {
	inExercise = false,
	inChapter = true,
	inSupport = true,
	inFleet = false,
	inPvP = false,
	inActivity = true,
	inTactics = false,
	inElite = false,
	inGuildEvent = true,
	inEvent = true,
	inBackyard = false,
	inClass = true,
	isActivityNpc = true,
	inChallenge = true,
	inWorld = true,
	inAdmiral = false
}
slot0.FILTER_SHIPS_FLAGS_4 = {
	inElite = true,
	inChallenge = true,
	inGuildBossEvent = true,
	inSupport = true,
	inClass = true,
	inActivity = true,
	inGuildEvent = true,
	isActivityNpc = true,
	inWorld = true,
	inAdmiral = true,
	inExercise = true,
	inChapter = true,
	inFleet = true,
	inPvP = true,
	inTactics = true,
	inBackyard = true,
	inEvent = true
}
slot0.TAG_HIDE_ALL = {
	inExercise = true,
	inChallenge = true,
	inChapter = true,
	inFleet = true,
	inPvP = true,
	inActivity = true,
	inTactics = true,
	inElite = true,
	inClass = true,
	inEvent = true,
	inBackyard = true,
	isActivityNpc = true,
	inWorld = true,
	inAdmiral = true
}
slot0.TAG_HIDE_BASE = {
	inExercise = true,
	inChallenge = false,
	inChapter = false,
	inSupport = false,
	inPvP = false,
	inActivity = false,
	inTactics = false,
	inElite = true,
	inClass = false,
	inEvent = false,
	inFleet = false,
	inBackyard = false,
	isActivityNpc = false,
	inWorld = false,
	inAdmiral = false
}
slot0.TAG_HIDE_ACTIVITY_BOSS = {
	inChapter = true,
	inChallenge = true,
	inClass = true,
	inFleet = true,
	inPvP = true,
	inAdmiral = true,
	inTactics = true,
	inBackyard = true
}
slot0.TAG_HIDE_BACKYARD = {
	inExercise = false,
	inChallenge = true,
	inChapter = true,
	inEvent = true,
	inPvP = true,
	inActivity = true,
	inTactics = true
}
slot0.TAG_HIDE_PVP = {
	inExercise = false,
	inChapter = true,
	inChallenge = true,
	inFleet = true,
	inClass = true,
	inActivity = true,
	inTactics = true,
	inBackyard = true,
	inPvP = true
}
slot0.TAG_HIDE_DEFENSE = {
	inExercise = false,
	inChapter = true,
	inChallenge = true,
	inFleet = true,
	inClass = true,
	inActivity = true,
	inTactics = true,
	inBackyard = true,
	inPvP = true,
	inEvent = true
}
slot0.TAG_HIDE_LEVEL = {
	inAdmiral = true,
	inChallenge = true,
	inFleet = true,
	inClass = true,
	inActivity = true,
	inTactics = true,
	inBackyard = true
}
slot0.TAG_HIDE_SUPPORT = {
	inAdmiral = true,
	inChallenge = true,
	inClass = true,
	inActivity = true,
	inTactics = true,
	inBackyard = true
}
slot0.TAG_HIDE_NORMAL = {
	inExercise = false,
	inChallenge = true,
	inClass = true,
	inPvP = true,
	inActivity = true,
	inTactics = true,
	inBackyard = true
}
slot0.TAG_HIDE_CHALLENGE = {
	inClass = true,
	inChapter = true,
	inFleet = true,
	inPvP = true,
	inActivity = true,
	inTactics = true,
	inBackyard = true,
	inEvent = false,
	inAdmiral = true
}
slot0.TAG_HIDE_EVENT = {
	inExercise = false,
	inChallenge = true,
	inClass = true,
	inActivity = true,
	inTactics = true,
	inBackyard = true
}
slot0.TAG_HIDE_TACTICES = {
	inExercise = false,
	inChapter = true,
	inChallenge = true,
	inFleet = true,
	inClass = true,
	inActivity = true,
	inTactics = true,
	inBackyard = true,
	inPvP = true,
	inEvent = true
}
slot0.TAG_HIDE_ADMIRAL = {
	inExercise = false,
	inChapter = true,
	inChallenge = true,
	inFleet = true,
	inClass = true,
	inActivity = true,
	inTactics = true,
	inBackyard = true,
	inPvP = true,
	inEvent = true
}
slot0.TAG_HIDE_FORMATION = {
	inExercise = false,
	inChallenge = true,
	inClass = true,
	inPvP = true,
	inActivity = true,
	inTactics = true,
	inBackyard = true
}
slot0.TAG_HIDE_WORLD = {
	inChallenge = true,
	inActivity = true,
	inFleet = true
}
slot0.TAG_HIDE_DESTROY = {
	inElite = false
}
slot0.TAG_BLOCK_EVENT = {
	inEvent = true
}
slot0.TAG_BLOCK_PVP = {
	inEvent = true
}
slot0.TAG_BLOCK_BACKYARD = {
	inClass = true
}
slot0.STATE_CHANGE_OK = -1
slot0.STATE_CHANGE_FAIL = 0
slot0.STATE_CHANGE_CHECK = 1
slot0.STATE_CHANGE_TIP = 2
slot1 = {
	inFleet = {
		inSupport = 1,
		inEvent = 0
	},
	inSupport = {
		inFleet = 0,
		inEvent = 0
	},
	inElite = {
		inElite = 0,
		inEvent = 0
	},
	inActivity = {
		isActivityNpc = 0,
		inEvent = 0
	},
	inChallenge = {
		isActivityNpc = 0,
		inEvent = 0
	},
	inEvent = {
		inChapter = 0,
		inEvent = 0,
		inFleet = 1,
		inSupport = 0,
		isActivityNpc = 0,
		inPvP = 1
	},
	inClass = {
		isActivityNpc = 0,
		inClass = 0,
		inBackyard = 1
	},
	inTactics = {
		inTactics = 0
	},
	inBackyard = {
		inClass = 0,
		isActivityNpc = 0
	},
	inWorld = {
		isActivityNpc = 0
	},
	onPropose = {
		inEvent = 0,
		inChapter = 0
	},
	onModify = {
		inChapter = 0
	},
	onDestroy = {
		inExercise = 1,
		inChallenge = 0,
		inFleet = 1,
		inSupport = 0,
		inClass = 0,
		inActivity = 0,
		inTactics = 1,
		inBackyard = 1,
		inGuildEvent = 0,
		inEvent = 0,
		inChapter = 0,
		inPvP = 1,
		isActivityNpc = 0,
		inGuildBossEvent = 1,
		inWorld = 0,
		inAdmiral = 0
	},
	onTeamChange = {
		inExercise = 1,
		inChallenge = 0,
		inChapter = 0,
		inFleet = 1,
		inPvP = 1,
		inActivity = 0,
		inWorld = 1,
		inGuildBossEvent = 1
	}
}
slot2 = {
	inChapter = {
		tips_block = &quot;word_shipState_fight&quot;
	},
	inFleet = {
		tips_block = &quot;word_shipState_fight&quot;
	},
	inElite = {
		tips_block = &quot;word_shipState_fight&quot;
	},
	inActivity = {
		tips_block = &quot;shipmodechange_reject_inactivity&quot;
	},
	inChallenge = {
		tips_block = &quot;shipmodechange_reject_inchallenge&quot;
	},
	inPvP = {
		tips_block = &quot;word_shipState_fight&quot;
	},
	inExercise = {
		tips_block = &quot;word_shipState_fight&quot;
	},
	inEvent = {
		tips_block = &quot;word_shipState_event&quot;
	},
	inClass = {
		tips_block = &quot;word_shipState_study&quot;
	},
	inTactics = {
		tips_block = &quot;word_shipState_tactics&quot;
	},
	inBackyard = {
		tips_block = &quot;word_shipState_rest&quot;
	},
	inAdmiral = {
		tips_block = &quot;playerinfo_ship_is_already_flagship&quot;
	},
	inGuildEvent = {
		tips_block = &quot;word_shipState_guild_event&quot;
	},
	inGuildBossEvent = {
		tips_block = &quot;word_shipState_guild_event&quot;
	},
	isActivityNpc = {
		tips_block = &quot;word_shipState_npc&quot;
	},
	inWorld = {
		tips_block = &quot;word_shipState_world&quot;
	},
	inSupport = {
		tips_block = &quot;word_shipState_support&quot;
	}
}

slot0.ShipStatusCheck = function(slot0, slot1, slot2, slot3)
	slot4, slot5 = uv0.ShipStatusConflict(slot0, slot1, slot3)

	if slot4 == uv0.STATE_CHANGE_FAIL then
		return false, i18n(slot5)
	elseif slot4 == uv0.STATE_CHANGE_CHECK then
		if slot2 then
			return uv0.ChangeStatusCheckBox(slot5, slot1, slot2)
		else
			return false
		end
	elseif slot4 == uv0.STATE_CHANGE_TIP then
		return uv0.ChangeStatusTipBox(slot5, slot1)
	elseif slot4 == uv0.STATE_CHANGE_OK then
		return true
	else
		assert(false, &quot;unknow error&quot;)
	end
end

slot0.ShipStatusConflict = function(slot0, slot1, slot2)
	slot3 = uv0[slot0]
	slot2 = slot2 or {}

	for slot7, slot8 in ipairs(uv1.flagList) do
		if slot3[slot8] == uv1.STATE_CHANGE_FAIL and slot1:getFlag(slot8, slot2[slot8]) then
			return uv1.STATE_CHANGE_FAIL, uv2[slot8].tips_block
		end
	end

	for slot7, slot8 in ipairs(uv1.flagList) do
		if slot3[slot8] == uv1.STATE_CHANGE_CHECK and slot1:getFlag(slot8, slot2[slot8]) then
			return uv1.STATE_CHANGE_CHECK, slot8
		end
	end

	for slot7, slot8 in ipairs(uv1.flagList) do
		if slot3[slot8] == uv1.STATE_CHANGE_TIP and slot1:getFlag(slot8, slot2[slot8]) then
			return uv1.STATE_CHANGE_TIP, slot8
		end
	end

	return uv1.STATE_CHANGE_OK
end

slot0.ChangeStatusCheckBox = function(slot0, slot1, slot2)
	if slot0 == &quot;inBackyard&quot; then
		pg.MsgboxMgr.GetInstance():ShowMsgBox({
			content = i18n(&quot;ship_vo_moveout_backyard&quot;),
			onYes = function ()
				pg.m02:sendNotification(GAME.EXIT_SHIP, {
					callback = uv0,
					shipId = uv1.id
				})
			end
		})

		return false, nil
	elseif slot0 == &quot;inFleet&quot; then
		pg.MsgboxMgr.GetInstance():ShowMsgBox({
			content = i18n(&quot;shipchange_alert_infleet&quot;),
			onYes = function ()
				if getProxy(FleetProxy):GetRegularFleetByShip(uv0):canRemove(uv0) then
					slot0:removeShip(uv0)
					pg.m02:sendNotification(GAME.UPDATE_FLEET, {
						callback = uv1,
						fleet = slot0
					})
				else
					pg.TipsMgr.GetInstance():ShowTips(i18n(&quot;shipmodechange_reject_1stfleet_only&quot;))
				end
			end
		})

		return false, nil
	elseif slot0 == &quot;inPvP&quot; then
		pg.MsgboxMgr.GetInstance():ShowMsgBox({
			content = i18n(&quot;shipchange_alert_inpvp&quot;),
			onYes = function ()
				if getProxy(FleetProxy):getFleetById(FleetProxy.PVP_FLEET_ID):canRemove(uv0) then
					slot0:removeShip(uv0)
					pg.m02:sendNotification(GAME.UPDATE_FLEET, {
						callback = uv1,
						fleet = slot0
					})
				elseif uv0:getTeamType() == TeamType.Vanguard then
					pg.TipsMgr.GetInstance():ShowTips(i18n(&quot;ship_vo_vanguardFleet_must_hasShip&quot;))
				elseif slot1 == TeamType.Main then
					pg.TipsMgr.GetInstance():ShowTips(i18n(&quot;ship_vo_mainFleet_must_hasShip&quot;))
				end
			end
		})

		return false, nil
	elseif slot0 == &quot;inExercise&quot; then
		if getProxy(MilitaryExerciseProxy):getExerciseFleet():canRemove(slot1) then
			pg.MsgboxMgr.GetInstance():ShowMsgBox({
				content = i18n(&quot;shipchange_alert_inexercise&quot;),
				onYes = function ()
					uv0:removeShip(uv1)
					pg.m02:sendNotification(GAME.UPDATE_EXERCISE_FLEET, {
						fleet = uv0,
						callback = uv2
					})
				end
			})
		else
			pg.MsgboxMgr.GetInstance():ShowMsgBox({
				content = i18n(&quot;exercise_clear_fleet_tip&quot;),
				onYes = function ()
					uv0:removeShip(uv1)
					pg.m02:sendNotification(GAME.UPDATE_EXERCISE_FLEET, {
						fleet = uv0,
						callback = uv2
					})
				end
			})
		end

		return false, nil
	elseif slot0 == &quot;inTactics&quot; then
		pg.MsgboxMgr.GetInstance():ShowMsgBox({
			content = i18n(&quot;tactics_lesson_cancel&quot;),
			onYes = function ()
				pg.m02:sendNotification(GAME.CANCEL_LEARN_TACTICS, {
					callback = uv1,
					shipId = getProxy(NavalAcademyProxy):getStudentIdByShipId(uv0.id),
					type = Student.CANCEL_TYPE_MANUAL
				})
			end
		})

		return false, nil
	elseif slot0 == &quot;inGuildBossEvent&quot; then
		pg.MsgboxMgr.GetInstance():ShowMsgBox({
			content = i18n(&quot;word_shipState_guild_boss&quot;),
			onYes = function ()
				if not getProxy(GuildProxy):getRawData() then
					return
				end

				if not slot0:GetActiveEvent() then
					return
				end

				if not slot1:GetBossMission() or not slot2:IsActive() then
					return
				end

				if not slot2:GetFleetUserId(getProxy(PlayerProxy):getRawData().id, uv0.id) then
					return
				end

				slot5 = Clone(slot4)

				slot5:RemoveUserShip(slot3, uv0.id)
				pg.m02:sendNotification(GAME.GUILD_UPDATE_BOSS_FORMATION, {
					force = true,
					editFleet = {
						[slot5.id] = slot5
					},
					callback = uv1
				})
			end
		})

		return false, nil
	elseif slot0 == &quot;inWorld&quot; then
		if nowWorld().type == World.TypeBase then
			WorldConst.ReqWorldCheck(slot2)

			return false, nil
		elseif #slot3:GetFleet(slot3:GetShip(slot1.id).fleetId)[slot1:getTeamType()] &gt; 1 then
			return true
		else
			pg.TipsMgr.GetInstance():ShowTips(i18n(&quot;shipmodechange_reject_worldfleet_only&quot;))

			return false, nil
		end
	end

	return true
end

slot0.ChangeStatusTipBox = function(slot0, slot1)
	if slot0 == &quot;inElite&quot; then
		pg.MsgboxMgr.GetInstance():ShowMsgBox({
			hideNo = true,
			content = i18n(&quot;ship_vo_moveout_hardFormation&quot;)
		})
	end

	return true
end

slot0.canDestroyShip = function(slot0, slot1)
	if slot0:isBluePrintShip() then
		return false, i18n(&quot;blueprint_destory_tip&quot;)
	elseif slot0:GetLockState() == Ship.LOCK_STATE_LOCK then
		return false, i18n(&quot;ship_vo_locked&quot;)
	elseif slot0:isMetaShip() then
		return false, i18n(&quot;meta_destroy_tip&quot;)
	end

	return uv0.ShipStatusCheck(&quot;onDestroy&quot;, slot0, slot1)
end

return slot0
</code></pre>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-lua.min.js"></script>
</body>
</html>