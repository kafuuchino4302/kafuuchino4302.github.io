<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>newservershopshoppingcommand.lua</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
</head>
<body>
    <h1>newservershopshoppingcommand.lua</h1>
    <a href="index.html">返回主页</a>
    <pre><code class="language-lua">slot0 = class(&quot;NewServerShopShoppingCommand&quot;, pm.SimpleCommand)

slot0.execute = function(slot0, slot1)
	slot2 = slot1:getBody()
	slot3 = slot2.id
	slot4 = slot2.selectedList
	slot5 = slot2.count or 1

	if not getProxy(ActivityProxy):getActivityByType(slot2.actType or ActivityConst.ACTIVITY_TYPE_NEWSERVER_SHOP) or slot7:isEnd() then
		return
	end

	if not getProxy(ShopsProxy):GetNewServerShop(slot6) then
		return
	end

	assert(slot8:GetCommodityById(slot3):GetConsume().type == 1, &quot;暂不支持资源以为的类型&quot;)

	if getProxy(PlayerProxy):getData():getResource(slot13.id) &lt; slot13.count * (#slot4 ~= 1 and #slot4 or slot5) then
		pg.TipsMgr.GetInstance():ShowTips(i18n(&quot;common_no_resource&quot;))

		return
	end

	if not slot12:CanPurchaseMulTimes(slot9) then
		pg.TipsMgr.GetInstance():ShowTips(i18n(&quot;guild_shop_cnt_no_enough&quot;))

		return
	end

	slot16 = {}

	for slot20, slot21 in ipairs(slot4) do
		if not slot16[slot21] then
			slot16[slot21] = {
				itemid = slot21,
				count = slot5
			}
		else
			slot16[slot21].count = slot16[slot21].count + 1
		end
	end

	slot17 = {}

	for slot21, slot22 in pairs(slot16) do
		table.insert(slot17, {
			itemid = slot22.itemid,
			count = slot22.count
		})
	end

	slot19 = slot12:getConfig(&quot;goods&quot;)[1]
	slot20 = slot12:getConfig(&quot;num&quot;)

	if slot12:getConfig(&quot;type&quot;) == 1 then
		if slot19 == 1 and slot11:GoldMax(slot20 * slot9) then
			pg.TipsMgr.GetInstance():ShowTips(i18n(&quot;gold_max_tip_title&quot;) .. i18n(&quot;resource_max_tip_shop&quot;))

			return
		end

		if slot19 == 2 and slot11:OilMax(slot20 * slot9) then
			pg.TipsMgr.GetInstance():ShowTips(i18n(&quot;oil_max_tip_title&quot;) .. i18n(&quot;resource_max_tip_shop&quot;))

			return
		end
	end

	slot21 = Item.getConfigData(slot19)

	if DROP_TYPE_ITEM == slot18 and slot21.type == Item.EXP_BOOK_TYPE and slot21.max_num &lt; getProxy(BagProxy):getItemCountById(slot19) + slot20 * slot9 then
		pg.TipsMgr.GetInstance():ShowTips(i18n(&quot;expbook_max_tip_title&quot;) .. i18n(&quot;resource_max_tip_shop&quot;))

		return
	end

	slot22 = pg.ConnectionMgr.GetInstance()

	slot22:Send(26043, {
		act_id = slot7.id,
		goodsid = slot3,
		selected = slot17
	}, 26044, function (slot0)
		if slot0.result == 0 then
			slot1 = PlayerConst.addTranDrop(slot0.drop_list)

			uv0:ReduceCnt(uv1)

			if uv0:LimitPurchaseSubGoods() then
				for slot5, slot6 in ipairs(uv2) do
					uv0:UpdateBoughtRecord(slot6)
				end
			end

			slot2 = getProxy(PlayerProxy):getData()

			slot2:consume({
				[id2res(uv0:getConfig(&quot;resource_type&quot;))] = uv3 * uv1
			})
			uv4:updatePlayer(slot2)
			uv5:sendNotification(GAME.NEW_SERVER_SHOP_SHOPPING_DONE, {
				awards = slot1
			})
		else
			pg.TipsMgr.GetInstance():ShowTips(ERROR_MESSAGE[slot0.result] .. slot0.result)
		end
	end)
end

return slot0
</code></pre>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-lua.min.js"></script>
</body>
</html>