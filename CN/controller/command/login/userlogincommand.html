<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>userlogincommand.lua</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
</head>
<body>
    <h1>userlogincommand.lua</h1>
    <a href="index.html">返回主页</a>
    <pre><code class="language-lua">slot0 = class(&quot;UserLoginCommand&quot;, pm.SimpleCommand)

slot0.execute = function(slot0, slot1)
	assert(isa(slot1:getBody(), User), &quot;should be an instance of User&quot;)
	originalPrint(&quot;connect to gateway - &quot; .. NetConst.GATEWAY_HOST .. &quot;:&quot; .. NetConst.GATEWAY_PORT)

	if pg.SdkMgr.GetInstance():GetChannelUID() == &quot;&quot; then
		slot3 = PLATFORM_LOCAL
	end

	if not slot2.arg4 then
		slot2.arg4 = &quot;0&quot;
	end

	originalPrint(&quot;login type -- : &quot;, slot2.type, &quot;, arg3 -- : &quot;, slot2.arg4 == &quot;0&quot; and slot2.arg3 or slot2.arg4, &quot;, sessionid -- : &quot; .. slot2.arg4)
	pg.ConnectionMgr.GetInstance():SetProxyHost(NetConst.PROXY_GATEWAY_HOST, NetConst.PROXY_GATEWAY_PORT)
	pg.ConnectionMgr.GetInstance():Connect(NetConst.GATEWAY_HOST, NetConst.GATEWAY_PORT, function ()
		pg.ConnectionMgr.GetInstance():Send(10020, {
			login_type = uv0.type,
			arg1 = uv0.arg1,
			arg2 = uv0.arg2,
			arg3 = uv1,
			arg4 = uv2,
			check_key = HashUtil.CalcMD5(uv0.arg1 .. AABBUDUD),
			device = PLATFORM
		}, 10021, function (slot0)
			originalPrint(&quot;disconnect from gateway...&quot;)
			pg.ConnectionMgr.GetInstance():Disconnect()

			if slot0.result == 0 then
				uv0.id = slot0.account_id
				uv0.uid = slot0.account_id
				uv0.token = slot0.server_ticket
				uv0.limitServerIds = slot0.limit_server_ids
				slot1 = getProxy(UserProxy)

				slot1:setLastLogin(uv0)
				slot1:SetLoginedFlag(true)

				slot2 = {}
				slot3 = {
					&quot;*all gate info :&quot;
				}

				for slot7, slot8 in ipairs(slot0.serverlist) do
					slot9 = Server.New({
						id = slot8.ids[1],
						host = slot8.ip,
						port = slot8.port,
						proxy_host = slot8.proxy_ip,
						proxy_port = slot8.proxy_port,
						status = slot8.state,
						name = slot8.name,
						tag_state = slot8.tag_state,
						sort = slot8.sort
					})
					slot3[#slot3 + 1] = slot8.proxy_ip .. &quot;:&quot; .. slot8.proxy_port
					slot3[#slot3 + 1] = slot8.ip .. &quot;:&quot; .. slot8.port

					slot9:display()
					table.insert(slot2, slot9)
				end

				originalPrint(table.concat(slot3, &quot;\n&quot;))
				getProxy(ServerProxy):setServers(slot2, uv0.uid)

				if slot0.limit_server_ids and #slot0.limit_server_ids &gt; 0 then
					slot4.firstServer = nil
				end

				getProxy(GatewayNoticeProxy):setGatewayNotices(slot0.notice_list)
				uv1.facade:sendNotification(GAME.USER_LOGIN_SUCCESS, uv0)
				pg.PushNotificationMgr.GetInstance():cancelAll()
				originalPrint(&quot;user logined............&quot;, #slot2)
				pg.SdkMgr.GetInstance():SdkGateWayLogined()
			else
				pg.SdkMgr.GetInstance():SdkLoginGetaWayFailed()
				originalPrint(&quot;user login failed ............&quot;)

				if slot0.result == 13 then
					pg.TipsMgr.GetInstance():ShowTips(i18n(&quot;login_gate_not_ready&quot;))
				elseif slot0.result == 15 then
					pg.TipsMgr.GetInstance():ShowTips(i18n(&quot;login_game_rigister_full&quot;))
				elseif slot0.result == 18 then
					pg.TipsMgr.GetInstance():ShowTips(i18n(&quot;system_database_busy&quot;))
				elseif slot0.result == 6 then
					pg.TipsMgr.GetInstance():ShowTips(i18n(&quot;login_game_login_full&quot;))
				else
					uv1.facade:sendNotification(GAME.USER_LOGIN_FAILED, slot0.result)
				end
			end
		end, false)
	end)
end

return slot0
</code></pre>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-lua.min.js"></script>
</body>
</html>